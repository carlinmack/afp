<div id="More_Matrix">
<div class="head">
<h1>Theory More_Matrix</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> More_Matrix
  <span class="keyword2"><span class="keyword">imports</span></span> <span class="quoted">"<a href="../../jordan_normal_form/theories/#Matrix">Jordan_Normal_Form.Matrix</a>"</span>
    <span class="quoted">"<a href="../../jordan_normal_form/theories/#DL_Rank">Jordan_Normal_Form.DL_Rank</a>"</span>
    <span class="quoted">"<a href="../../jordan_normal_form/theories/#VS_Connect">Jordan_Normal_Form.VS_Connect</a>"</span>
    <span class="quoted">"<a href="../../jordan_normal_form/theories/#Gauss_Jordan_Elimination">Jordan_Normal_Form.Gauss_Jordan_Elimination</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">"Kronecker Product"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">kronecker_product</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> ring mat <span class="main">⇒</span> <span class="tfree">'a</span> mat <span class="main">⇒</span> <span class="tfree">'a</span> mat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">kronecker_product</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">=</span>
  <span class="main">(</span><span class="keyword1">let</span> <span class="bound">ra</span> <span class="main">=</span> dim_row <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">;</span> <span class="bound">ca</span> <span class="main">=</span> dim_col <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">;</span>
       <span class="bound">rb</span> <span class="main">=</span> dim_row <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">;</span> <span class="bound">cb</span> <span class="main">=</span> dim_col <span class="free"><span class="bound"><span class="entity">B</span></span></span>
  <span class="keyword1">in</span>
    mat <span class="main">(</span><span class="bound">ra</span><span class="main">*</span><span class="bound">rb</span><span class="main">)</span> <span class="main">(</span><span class="bound">ca</span><span class="main">*</span><span class="bound">cb</span><span class="main">)</span>
    <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">i</span><span class="main">,</span><span class="bound">j</span><span class="main">)</span><span class="main">.</span>
      <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">$$</span> <span class="main">(</span><span class="bound">i</span> <span class="keyword1">div</span> <span class="bound">rb</span><span class="main">,</span> <span class="bound">j</span> <span class="keyword1">div</span> <span class="bound">cb</span><span class="main">)</span> <span class="main">*</span>
      <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">$$</span> <span class="main">(</span><span class="bound">i</span> <span class="keyword1">mod</span> <span class="bound">rb</span><span class="main">,</span> <span class="bound">j</span> <span class="keyword1">mod</span> <span class="bound">cb</span><span class="main">)</span>
  <span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="More_Matrix-arith"><span class="command">lemma</span></span> arith<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">&lt;</span> <span class="free">a</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">&lt;</span> <span class="free">b</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span><span class="main">*</span><span class="free">d</span><span class="main">+</span><span class="free">c</span> <span class="main">&lt;</span> <span class="free">a</span><span class="main">*</span><span class="main">(</span><span class="free">b</span><span class="main">::</span>nat<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span><span class="main">*</span><span class="free">d</span><span class="main">+</span><span class="free">c</span> <span class="main">&lt;</span> <span class="free">b</span><span class="main">*</span><span class="main">(</span><span class="free">d</span><span class="main">+</span><span class="main">1</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> One_nat_def Suc_leI add.right_neutral add_Suc_right assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> less_le_trans mult.commute mult_le_cancel2<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="More_Matrix-dim_kronecker"><span class="command">lemma</span></span> dim_kronecker<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"dim_row <span class="main">(</span>kronecker_product <span class="free">A</span> <span class="free">B</span><span class="main">)</span> <span class="main">=</span> dim_row <span class="free">A</span> <span class="main">*</span> dim_row <span class="free">B</span>"</span></span>
  <span class="quoted"><span class="quoted">"dim_col <span class="main">(</span>kronecker_product <span class="free">A</span> <span class="free">B</span><span class="main">)</span> <span class="main">=</span> dim_col <span class="free">A</span> <span class="main">*</span> dim_col <span class="free">B</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> kronecker_product_def Let_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="More_Matrix-kronecker_inverse_index"><span class="command">lemma</span></span> kronecker_inverse_index<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">&lt;</span> dim_row <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">&lt;</span> dim_col <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">&lt;</span> dim_row <span class="free">B</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">&lt;</span> dim_col <span class="free">B</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"kronecker_product <span class="free">A</span> <span class="free">B</span> <span class="main">$$</span> <span class="main">(</span>dim_row <span class="free">B</span><span class="main">*</span><span class="free">r</span><span class="main">+</span><span class="free">v</span><span class="main">,</span> dim_col <span class="free">B</span><span class="main">*</span><span class="free">s</span><span class="main">+</span><span class="free">w</span><span class="main">)</span> <span class="main">=</span> <span class="free">A</span> <span class="main">$$</span> <span class="main">(</span><span class="free">r</span><span class="main">,</span><span class="free">s</span><span class="main">)</span> <span class="main">*</span> <span class="free">B</span> <span class="main">$$</span> <span class="main">(</span><span class="free">v</span><span class="main">,</span><span class="free">w</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> arith<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"dim_row <span class="free">B</span><span class="main">*</span><span class="free">r</span><span class="main">+</span><span class="free">v</span> <span class="main">&lt;</span> dim_row <span class="free">A</span> <span class="main">*</span> dim_row <span class="free">B</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> arith<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"dim_col <span class="free">B</span> <span class="main">*</span> <span class="free">s</span> <span class="main">+</span> <span class="free">w</span> <span class="main">&lt;</span> dim_col <span class="free">A</span> <span class="main">*</span> dim_col <span class="free">B</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> kronecker_product_def Let_def
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="More_Matrix-kronecker_distr_left"><span class="command">lemma</span></span> kronecker_distr_left<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"dim_row <span class="free">B</span> <span class="main">=</span> dim_row <span class="free">C</span>"</span></span> <span class="quoted"><span class="quoted">"dim_col <span class="free">B</span> <span class="main">=</span> dim_col <span class="free">C</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"kronecker_product <span class="free">A</span> <span class="main">(</span><span class="free">B</span><span class="main">+</span><span class="free">C</span><span class="main">)</span> <span class="main">=</span> kronecker_product <span class="free">A</span> <span class="free">B</span> <span class="main">+</span> kronecker_product <span class="free">A</span> <span class="free">C</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> kronecker_product_def Let_def
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mat_eq_iff<span class="main">)</span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> distrib_left index_add_mat<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> mod_less_divisor mult_eq_0_iff neq0_conv not_less_zero<span class="main">)</span>

<span class="keyword1" id="More_Matrix-kronecker_distr_right"><span class="command">lemma</span></span> kronecker_distr_right<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"dim_row <span class="free">B</span> <span class="main">=</span> dim_row <span class="free">C</span>"</span></span> <span class="quoted"><span class="quoted">"dim_col <span class="free">B</span> <span class="main">=</span> dim_col <span class="free">C</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"kronecker_product <span class="main">(</span><span class="free">B</span><span class="main">+</span><span class="free">C</span><span class="main">)</span> <span class="free">A</span> <span class="main">=</span> kronecker_product <span class="free">B</span> <span class="free">A</span> <span class="main">+</span> kronecker_product <span class="free">C</span> <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> kronecker_product_def Let_def
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mat_eq_iff less_mult_imp_div_less distrib_right<span class="main">)</span>

<span class="keyword1" id="More_Matrix-index_mat_mod"><span class="command">lemma</span></span> index_mat_mod<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">nr</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">&amp;</span> <span class="free">nc</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">⟹</span> mat <span class="free">nr</span> <span class="free">nc</span> <span class="free">f</span> <span class="main">$$</span> <span class="main">(</span><span class="free">i</span> <span class="keyword1">mod</span> <span class="free">nr</span><span class="main">,</span><span class="free">j</span> <span class="keyword1">mod</span> <span class="free">nc</span><span class="main">)</span> <span class="main">=</span> <span class="free">f</span> <span class="main">(</span><span class="free">i</span> <span class="keyword1">mod</span> <span class="free">nr</span><span class="main">,</span><span class="free">j</span> <span class="keyword1">mod</span> <span class="free">nc</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="More_Matrix-kronecker_assoc"><span class="command">lemma</span></span> kronecker_assoc<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"kronecker_product <span class="free">A</span> <span class="main">(</span>kronecker_product <span class="free">B</span> <span class="free">C</span><span class="main">)</span> <span class="main">=</span> kronecker_product <span class="main">(</span>kronecker_product <span class="free">A</span> <span class="free">B</span><span class="main">)</span> <span class="free">C</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> kronecker_product_def Let_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"dim_row <span class="free">B</span> <span class="main">*</span> dim_row <span class="free">C</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">&amp;</span> dim_col <span class="free">B</span> <span class="main">*</span> dim_col <span class="free">C</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mat_eq_iff less_mult_imp_div_less<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> div_mult2_eq div_mult_mod_eq kronecker_inverse_index less_mult_imp_div_less linordered_semiring_strict_class.mult_pos_pos mod_less_divisor mod_mult2_eq mult.assoc mult.commute<span class="main">)</span>

<span class="keyword1" id="More_Matrix-sum_sum_mod_div"><span class="command">lemma</span></span> sum_sum_mod_div<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">ia</span> <span class="main">=</span> <span class="main">0</span><span class="main">::</span>nat<span class="main">..&lt;</span><span class="free">x</span><span class="main">.</span> <span class="main">∑</span><span class="bound">ja</span> <span class="main">=</span> <span class="main">0</span><span class="main">..&lt;</span><span class="free">y</span><span class="main">.</span> <span class="free">f</span> <span class="bound">ia</span> <span class="bound">ja</span><span class="main">)</span> <span class="main">=</span>
   <span class="main">(</span><span class="main">∑</span><span class="bound">ia</span> <span class="main">=</span> <span class="main">0</span><span class="main">..&lt;</span><span class="free">x</span><span class="main">*</span><span class="free">y</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span><span class="bound">ia</span> <span class="keyword1">div</span> <span class="free">y</span><span class="main">)</span> <span class="main">(</span><span class="bound">ia</span> <span class="keyword1">mod</span> <span class="free">y</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"inj_on <span class="main">(</span><span class="main">λ</span><span class="bound">ia</span><span class="main">.</span> <span class="main">(</span><span class="bound">ia</span> <span class="keyword1">div</span> <span class="free">y</span><span class="main">,</span> <span class="bound">ia</span> <span class="keyword1">mod</span> <span class="free">y</span><span class="main">)</span><span class="main">)</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">x</span> <span class="main">*</span> <span class="free">y</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> <span class="main"><span class="main">(</span></span>verit<span class="main"><span class="main">,</span></span> best<span class="main"><span class="main">)</span></span> Pair_inject div_mod_decomp inj_onI<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> 21<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">x</span><span class="main">}</span> <span class="main">×</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">y</span><span class="main">}</span> <span class="main">⊆</span> <span class="main">(</span><span class="main">λ</span><span class="bound">ia</span><span class="main">.</span> <span class="main">(</span><span class="bound">ia</span> <span class="keyword1">div</span> <span class="free">y</span><span class="main">,</span> <span class="bound">ia</span> <span class="keyword1">mod</span> <span class="free">y</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">x</span> <span class="main">*</span> <span class="free">y</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">clarsimp</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span> <span class="skolem">b</span>
    <span class="keyword3"><span class="command">assume</span></span> *<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">&lt;</span> <span class="free">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">&lt;</span> <span class="free">y</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">*</span> <span class="free">y</span> <span class="main">+</span>  <span class="skolem">b</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">x</span><span class="main">*</span><span class="free">y</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> arith * atLeastLessThan_iff le0 mult.commute<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">a</span><span class="main">,</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">∈</span> <span class="main">(</span><span class="main">λ</span><span class="bound">ia</span><span class="main">.</span> <span class="main">(</span><span class="bound">ia</span> <span class="keyword1">div</span> <span class="free">y</span><span class="main">,</span> <span class="bound">ia</span> <span class="keyword1">mod</span> <span class="free">y</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">x</span> <span class="main">*</span> <span class="free">y</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> <span class="quoted">"*"</span><span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> Euclidean_Division.div_eq_0_iff add_cancel_right_right div_mult_self3 gr_implies_not0 image_iff mod_less mod_mult_self3<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">have</span></span> 22<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">ia</span><span class="main">.</span> <span class="main">(</span><span class="bound">ia</span> <span class="keyword1">div</span> <span class="free">y</span><span class="main">,</span> <span class="bound">ia</span> <span class="keyword1">mod</span> <span class="free">y</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">x</span> <span class="main">*</span> <span class="free">y</span><span class="main">}</span> <span class="main">⊆</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">x</span><span class="main">}</span> <span class="main">×</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">y</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> less_mult_imp_div_less <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> mod_less_divisor mult.commute neq0_conv not_less_zero<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">x</span><span class="main">}</span> <span class="main">×</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">y</span><span class="main">}</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">ia</span><span class="main">.</span> <span class="main">(</span><span class="bound">ia</span> <span class="keyword1">div</span> <span class="free">y</span><span class="main">,</span> <span class="bound">ia</span> <span class="keyword1">mod</span> <span class="free">y</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">x</span> <span class="main">*</span> <span class="free">y</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> 21 22 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">ia</span> <span class="main">=</span> <span class="main">0</span><span class="main">::</span>nat<span class="main">..&lt;</span><span class="free">x</span><span class="main">.</span> <span class="main">∑</span><span class="bound">ja</span> <span class="main">=</span> <span class="main">0</span><span class="main">..&lt;</span><span class="free">y</span><span class="main">.</span> <span class="free">f</span> <span class="bound">ia</span> <span class="bound">ja</span><span class="main">)</span> <span class="main">=</span>
        <span class="main">(</span><span class="main">∑</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">∈</span><span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">x</span><span class="main">}</span> <span class="main">×</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">y</span><span class="main">}</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sum.cartesian_product<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> *
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> sum.reindex_cong<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">λ</span></span><span class="bound"><span class="bound">ia</span></span><span class="main"><span class="main">.</span></span> <span class="main"><span class="main">(</span></span><span class="bound"><span class="bound">ia</span></span> <span class="keyword1"><span class="keyword1">div</span></span> <span class="free"><span class="free">y</span></span><span class="main"><span class="main">,</span></span> <span class="bound"><span class="bound">ia</span></span> <span class="keyword1"><span class="keyword1">mod</span></span> <span class="free"><span class="free">y</span></span><span class="main"><span class="main">)</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> 1 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(* Kronecker product distributes over matrix multiplication *)</span>
<span class="keyword1" id="More_Matrix-kronecker_of_mult"><span class="command">lemma</span></span> kronecker_of_mult<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"dim_col <span class="main">(</span><span class="free">A</span> <span class="main">::</span> <span class="tfree">'a</span> <span class="main">::</span> comm_ring mat<span class="main">)</span> <span class="main">=</span> dim_row <span class="free">C</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"dim_col <span class="free">B</span> <span class="main">=</span> dim_row <span class="free">D</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"kronecker_product <span class="free">A</span> <span class="free">B</span> <span class="main">*</span> kronecker_product <span class="free">C</span> <span class="free">D</span> <span class="main">=</span> kronecker_product <span class="main">(</span><span class="free">A</span> <span class="main">*</span> <span class="free">C</span><span class="main">)</span> <span class="main">(</span><span class="free">B</span> <span class="main">*</span> <span class="free">D</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> kronecker_product_def Let_def mat_eq_iff
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">clarsimp</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="skolem">j</span>
  <span class="keyword3"><span class="command">assume</span></span> ij<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> dim_row <span class="free">A</span> <span class="main">*</span> dim_row <span class="free">B</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> dim_col <span class="free">C</span> <span class="main">*</span> dim_col <span class="free">D</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">A</span> <span class="main">*</span> <span class="free">C</span><span class="main">)</span> <span class="main">$$</span> <span class="main">(</span><span class="skolem">i</span> <span class="keyword1">div</span> dim_row <span class="free">B</span><span class="main">,</span> <span class="skolem">j</span> <span class="keyword1">div</span> dim_col <span class="free">D</span><span class="main">)</span> <span class="main">=</span>
    row <span class="free">A</span> <span class="main">(</span><span class="skolem">i</span> <span class="keyword1">div</span> dim_row <span class="free">B</span><span class="main">)</span> <span class="main">∙</span> col <span class="free">C</span> <span class="main">(</span><span class="skolem">j</span> <span class="keyword1">div</span> dim_col <span class="free">D</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ij less_mult_imp_div_less <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> index_mult_mat<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">B</span> <span class="main">*</span> <span class="free">D</span><span class="main">)</span> <span class="main">$$</span> <span class="main">(</span><span class="skolem">i</span> <span class="keyword1">mod</span> dim_row <span class="free">B</span><span class="main">,</span> <span class="skolem">j</span> <span class="keyword1">mod</span> dim_col <span class="free">D</span><span class="main">)</span> <span class="main">=</span>
    row <span class="free">B</span> <span class="main">(</span><span class="skolem">i</span> <span class="keyword1">mod</span> dim_row <span class="free">B</span><span class="main">)</span> <span class="main">∙</span> col <span class="free">D</span> <span class="main">(</span><span class="skolem">j</span> <span class="keyword1">mod</span> dim_col <span class="free">D</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ij <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> index_mult_mat<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> gr_implies_not0 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">using</span></span> gr_implies_not0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">&lt;</span> dim_row <span class="free">C</span> <span class="main">*</span> dim_row <span class="free">D</span> <span class="main">⟹</span>
         <span class="free">A</span> <span class="main">$$</span> <span class="main">(</span><span class="skolem">i</span> <span class="keyword1">div</span> dim_row <span class="free">B</span><span class="main">,</span> <span class="bound">x</span> <span class="keyword1">div</span> dim_row <span class="free">D</span><span class="main">)</span> <span class="main">*</span>
         <span class="free">B</span> <span class="main">$$</span> <span class="main">(</span><span class="skolem">i</span> <span class="keyword1">mod</span> dim_row <span class="free">B</span><span class="main">,</span> <span class="bound">x</span> <span class="keyword1">mod</span> dim_row <span class="free">D</span><span class="main">)</span> <span class="main">*</span>
         <span class="main">(</span><span class="free">C</span> <span class="main">$$</span> <span class="main">(</span><span class="bound">x</span> <span class="keyword1">div</span> dim_row <span class="free">D</span><span class="main">,</span> <span class="skolem">j</span> <span class="keyword1">div</span> dim_col <span class="free">D</span><span class="main">)</span> <span class="main">*</span>
          <span class="free">D</span> <span class="main">$$</span> <span class="main">(</span><span class="bound">x</span> <span class="keyword1">mod</span> dim_row <span class="free">D</span><span class="main">,</span> <span class="skolem">j</span> <span class="keyword1">mod</span> dim_col <span class="free">D</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
         row <span class="free">A</span> <span class="main">(</span><span class="skolem">i</span> <span class="keyword1">div</span> dim_row <span class="free">B</span><span class="main">)</span> <span class="main">$</span> <span class="main">(</span><span class="bound">x</span> <span class="keyword1">div</span> dim_row <span class="free">D</span><span class="main">)</span> <span class="main">*</span>
         col <span class="free">C</span> <span class="main">(</span><span class="skolem">j</span> <span class="keyword1">div</span> dim_col <span class="free">D</span><span class="main">)</span> <span class="main">$</span> <span class="main">(</span><span class="bound">x</span> <span class="keyword1">div</span> dim_row <span class="free">D</span><span class="main">)</span> <span class="main">*</span>
         <span class="main">(</span>row <span class="free">B</span> <span class="main">(</span><span class="skolem">i</span> <span class="keyword1">mod</span> dim_row <span class="free">B</span><span class="main">)</span> <span class="main">$</span> <span class="main">(</span><span class="bound">x</span> <span class="keyword1">mod</span> dim_row <span class="free">D</span><span class="main">)</span> <span class="main">*</span>
          col <span class="free">D</span> <span class="main">(</span><span class="skolem">j</span> <span class="keyword1">mod</span> dim_col <span class="free">D</span><span class="main">)</span> <span class="main">$</span> <span class="main">(</span><span class="bound">x</span> <span class="keyword1">mod</span> dim_row <span class="free">D</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
    <span class="keyword3"><span class="command">assume</span></span> *<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">&lt;</span> dim_row <span class="free">C</span> <span class="main">*</span> dim_row <span class="free">D</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"row <span class="free">A</span> <span class="main">(</span><span class="skolem">i</span> <span class="keyword1">div</span> dim_row <span class="free">B</span><span class="main">)</span> <span class="main">$</span> <span class="main">(</span><span class="skolem">x</span> <span class="keyword1">div</span> dim_row <span class="free">D</span><span class="main">)</span> <span class="main">=</span> <span class="free">A</span> <span class="main">$$</span> <span class="main">(</span><span class="skolem">i</span> <span class="keyword1">div</span> dim_row <span class="free">B</span><span class="main">,</span> <span class="skolem">x</span> <span class="keyword1">div</span> dim_row <span class="free">D</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> * assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> less_mult_imp_div_less row_def<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"row <span class="free">B</span> <span class="main">(</span><span class="skolem">i</span> <span class="keyword1">mod</span> dim_row <span class="free">B</span><span class="main">)</span> <span class="main">$</span> <span class="main">(</span><span class="skolem">x</span> <span class="keyword1">mod</span> dim_row <span class="free">D</span><span class="main">)</span> <span class="main">=</span> <span class="free">B</span> <span class="main">$$</span> <span class="main">(</span><span class="skolem">i</span> <span class="keyword1">mod</span> dim_row <span class="free">B</span><span class="main">,</span> <span class="skolem">x</span> <span class="keyword1">mod</span> dim_row <span class="free">D</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted">"*"</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> ij<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> index_row<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> mod_less_divisor nat_0_less_mult_iff neq0_conv not_less_zero<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"col <span class="free">C</span> <span class="main">(</span><span class="skolem">j</span> <span class="keyword1">div</span> dim_col <span class="free">D</span><span class="main">)</span> <span class="main">$</span> <span class="main">(</span><span class="skolem">x</span> <span class="keyword1">div</span> dim_row <span class="free">D</span><span class="main">)</span> <span class="main">=</span> <span class="free">C</span> <span class="main">$$</span> <span class="main">(</span><span class="skolem">x</span> <span class="keyword1">div</span> dim_row <span class="free">D</span><span class="main">,</span> <span class="skolem">j</span> <span class="keyword1">div</span> dim_col <span class="free">D</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted">"*"</span> ij<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> less_mult_imp_div_less<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> 4<span class="main">:</span> <span class="quoted"><span class="quoted">"col <span class="free">D</span> <span class="main">(</span><span class="skolem">j</span> <span class="keyword1">mod</span> dim_col <span class="free">D</span><span class="main">)</span> <span class="main">$</span> <span class="main">(</span><span class="skolem">x</span> <span class="keyword1">mod</span> dim_row <span class="free">D</span><span class="main">)</span> <span class="main">=</span> <span class="free">D</span> <span class="main">$$</span> <span class="main">(</span><span class="skolem">x</span> <span class="keyword1">mod</span> dim_row <span class="free">D</span><span class="main">,</span> <span class="skolem">j</span> <span class="keyword1">mod</span> dim_col <span class="free">D</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted">"*"</span> Euclidean_Division.div_eq_0_iff gr_implies_not0 ij<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> index_col mod_div_trivial mult_not_zero<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">$$</span> <span class="main">(</span><span class="skolem">i</span> <span class="keyword1">div</span> dim_row <span class="free">B</span><span class="main">,</span> <span class="skolem">x</span> <span class="keyword1">div</span> dim_row <span class="free">D</span><span class="main">)</span> <span class="main">*</span>
         <span class="free">B</span> <span class="main">$$</span> <span class="main">(</span><span class="skolem">i</span> <span class="keyword1">mod</span> dim_row <span class="free">B</span><span class="main">,</span> <span class="skolem">x</span> <span class="keyword1">mod</span> dim_row <span class="free">D</span><span class="main">)</span> <span class="main">*</span>
         <span class="main">(</span><span class="free">C</span> <span class="main">$$</span> <span class="main">(</span><span class="skolem">x</span> <span class="keyword1">div</span> dim_row <span class="free">D</span><span class="main">,</span> <span class="skolem">j</span> <span class="keyword1">div</span> dim_col <span class="free">D</span><span class="main">)</span> <span class="main">*</span>
          <span class="free">D</span> <span class="main">$$</span> <span class="main">(</span><span class="skolem">x</span> <span class="keyword1">mod</span> dim_row <span class="free">D</span><span class="main">,</span> <span class="skolem">j</span> <span class="keyword1">mod</span> dim_col <span class="free">D</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
         row <span class="free">A</span> <span class="main">(</span><span class="skolem">i</span> <span class="keyword1">div</span> dim_row <span class="free">B</span><span class="main">)</span> <span class="main">$</span> <span class="main">(</span><span class="skolem">x</span> <span class="keyword1">div</span> dim_row <span class="free">D</span><span class="main">)</span> <span class="main">*</span>
         col <span class="free">C</span> <span class="main">(</span><span class="skolem">j</span> <span class="keyword1">div</span> dim_col <span class="free">D</span><span class="main">)</span> <span class="main">$</span> <span class="main">(</span><span class="skolem">x</span> <span class="keyword1">div</span> dim_row <span class="free">D</span><span class="main">)</span> <span class="main">*</span>
         <span class="main">(</span>row <span class="free">B</span> <span class="main">(</span><span class="skolem">i</span> <span class="keyword1">mod</span> dim_row <span class="free">B</span><span class="main">)</span> <span class="main">$</span> <span class="main">(</span><span class="skolem">x</span> <span class="keyword1">mod</span> dim_row <span class="free">D</span><span class="main">)</span> <span class="main">*</span>
          col <span class="free">D</span> <span class="main">(</span><span class="skolem">j</span> <span class="keyword1">mod</span> dim_col <span class="free">D</span><span class="main">)</span> <span class="main">$</span> <span class="main">(</span><span class="skolem">x</span> <span class="keyword1">mod</span> dim_row <span class="free">D</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> 1 2 3 4
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mult.assoc mult.left_commute<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">A</span> <span class="main">*</span> <span class="free">C</span><span class="main">)</span> <span class="main">$$</span> <span class="main">(</span><span class="skolem">i</span> <span class="keyword1">div</span> dim_row <span class="free">B</span><span class="main">,</span> <span class="skolem">j</span> <span class="keyword1">div</span> dim_col <span class="free">D</span><span class="main">)</span> <span class="main">*</span>
        <span class="main">(</span><span class="free">B</span> <span class="main">*</span> <span class="free">D</span><span class="main">)</span> <span class="main">$$</span> <span class="main">(</span><span class="skolem">i</span> <span class="keyword1">mod</span> dim_row <span class="free">B</span><span class="main">,</span> <span class="skolem">j</span> <span class="keyword1">mod</span> dim_col <span class="free">D</span><span class="main">)</span> <span class="main">=</span>
    <span class="main">(</span><span class="main">∑</span><span class="bound">ia</span> <span class="main">=</span> <span class="main">0</span><span class="main">..&lt;</span>dim_row <span class="free">C</span> <span class="main">*</span> dim_row <span class="free">D</span><span class="main">.</span>
               <span class="free">A</span> <span class="main">$$</span> <span class="main">(</span><span class="skolem">i</span> <span class="keyword1">div</span> dim_row <span class="free">B</span><span class="main">,</span> <span class="bound">ia</span> <span class="keyword1">div</span> dim_row <span class="free">D</span><span class="main">)</span> <span class="main">*</span>
               <span class="free">B</span> <span class="main">$$</span> <span class="main">(</span><span class="skolem">i</span> <span class="keyword1">mod</span> dim_row <span class="free">B</span><span class="main">,</span> <span class="bound">ia</span> <span class="keyword1">mod</span> dim_row <span class="free">D</span><span class="main">)</span> <span class="main">*</span>
               <span class="main">(</span><span class="free">C</span> <span class="main">$$</span> <span class="main">(</span><span class="bound">ia</span> <span class="keyword1">div</span> dim_row <span class="free">D</span><span class="main">,</span> <span class="skolem">j</span> <span class="keyword1">div</span> dim_col <span class="free">D</span><span class="main">)</span> <span class="main">*</span>
                <span class="free">D</span> <span class="main">$$</span> <span class="main">(</span><span class="bound">ia</span> <span class="keyword1">mod</span> dim_row <span class="free">D</span><span class="main">,</span> <span class="skolem">j</span> <span class="keyword1">mod</span> dim_col <span class="free">D</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> 1 2 scalar_prod_def sum_product sum_sum_mod_div
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sum_product sum_sum_mod_div <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> sum.cong<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> 3 <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"vec <span class="main">(</span>dim_col <span class="free">A</span> <span class="main">*</span> dim_col <span class="free">B</span><span class="main">)</span>
          <span class="main">(</span><span class="main">λ</span><span class="bound">j</span><span class="main">.</span> <span class="free">A</span> <span class="main">$$</span> <span class="main">(</span><span class="skolem">i</span> <span class="keyword1">div</span> dim_row <span class="free">B</span><span class="main">,</span> <span class="bound">j</span> <span class="keyword1">div</span> dim_col <span class="free">B</span><span class="main">)</span> <span class="main">*</span>
               <span class="free">B</span> <span class="main">$$</span> <span class="main">(</span><span class="skolem">i</span> <span class="keyword1">mod</span> dim_row <span class="free">B</span><span class="main">,</span> <span class="bound">j</span> <span class="keyword1">mod</span> dim_col <span class="free">B</span><span class="main">)</span><span class="main">)</span> <span class="main">∙</span>
       vec <span class="main">(</span>dim_row <span class="free">C</span> <span class="main">*</span> dim_row <span class="free">D</span><span class="main">)</span>
          <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="free">C</span> <span class="main">$$</span> <span class="main">(</span><span class="bound">i</span> <span class="keyword1">div</span> dim_row <span class="free">D</span><span class="main">,</span> <span class="skolem">j</span> <span class="keyword1">div</span> dim_col <span class="free">D</span><span class="main">)</span> <span class="main">*</span>
               <span class="free">D</span> <span class="main">$$</span> <span class="main">(</span><span class="bound">i</span> <span class="keyword1">mod</span> dim_row <span class="free">D</span><span class="main">,</span> <span class="skolem">j</span> <span class="keyword1">mod</span> dim_col <span class="free">D</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
        <span class="main">(</span><span class="free">A</span> <span class="main">*</span> <span class="free">C</span><span class="main">)</span> <span class="main">$$</span> <span class="main">(</span><span class="skolem">i</span> <span class="keyword1">div</span> dim_row <span class="free">B</span><span class="main">,</span> <span class="skolem">j</span> <span class="keyword1">div</span> dim_col <span class="free">D</span><span class="main">)</span> <span class="main">*</span>
        <span class="main">(</span><span class="free">B</span> <span class="main">*</span> <span class="free">D</span><span class="main">)</span> <span class="main">$$</span> <span class="main">(</span><span class="skolem">i</span> <span class="keyword1">mod</span> dim_row <span class="free">B</span><span class="main">,</span> <span class="skolem">j</span> <span class="keyword1">mod</span> dim_col <span class="free">D</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> * scalar_prod_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms sum_product sum_sum_mod_div <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> sum.cong<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="More_Matrix-inverts_mat_length"><span class="command">lemma</span></span> inverts_mat_length<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"square_mat <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"inverts_mat <span class="free">A</span> <span class="free">B</span>"</span></span> <span class="quoted"><span class="quoted">"inverts_mat <span class="free">B</span> <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"dim_row <span class="free">B</span> <span class="main">=</span> dim_row <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"dim_col <span class="free">B</span> <span class="main">=</span> dim_col <span class="free">A</span>"</span></span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> index_mult_mat<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> index_one_mat<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> inverts_mat_def square_mat.simps<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> index_mult_mat<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> index_one_mat<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> inverts_mat_def square_mat.simps<span class="main">)</span>

<span class="keyword1" id="More_Matrix-less_mult_imp_mod_less"><span class="command">lemma</span></span> less_mult_imp_mod_less<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="keyword1">mod</span> <span class="free">i</span> <span class="main">&lt;</span> <span class="free">i</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">&lt;</span> <span class="free">n</span> <span class="main">*</span> <span class="free">i</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">m</span> <span class="free">n</span> <span class="free">i</span> <span class="main">::</span> <span class="quoted">nat</span>
  <span class="keyword1"><span class="command">using</span></span> gr_implies_not_zero that <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1" id="More_Matrix-kronecker_one"><span class="command">lemma</span></span> kronecker_one<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"kronecker_product <span class="main">(</span><span class="main">(</span><span class="keyword1">1<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">x</span><span class="main">)</span><span class="main">::</span><span class="tfree">'a</span> <span class="main">::</span> ring_1 mat<span class="main">)</span> <span class="main">(</span><span class="keyword1">1<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">y</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">1<span class="hidden">⇩</span><sub>m</sub></span> <span class="main">(</span><span class="free">x</span><span class="main">*</span><span class="free">y</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> kronecker_product_def Let_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span>  <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>mat_eq_iff less_mult_imp_div_less less_mult_imp_mod_less<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> div_mult_mod_eq<span class="main">)</span>

<span class="keyword1" id="More_Matrix-kronecker_invertible"><span class="command">lemma</span></span> kronecker_invertible<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"invertible_mat <span class="main">(</span><span class="free">A</span> <span class="main">::</span> <span class="tfree">'a</span> <span class="main">::</span> comm_ring_1 mat<span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"invertible_mat <span class="free">B</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"invertible_mat <span class="main">(</span>kronecker_product <span class="free">A</span> <span class="free">B</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Ai</span></span> <span class="keyword2"><span class="keyword">where</span></span> Ai<span class="main">:</span> <span class="quoted"><span class="quoted">"inverts_mat <span class="free">A</span> <span class="skolem">Ai</span>"</span></span> <span class="quoted"><span class="quoted">"inverts_mat <span class="skolem">Ai</span> <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms invertible_mat_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Bi</span></span> <span class="keyword2"><span class="keyword">where</span></span> Bi<span class="main">:</span> <span class="quoted"><span class="quoted">"inverts_mat <span class="free">B</span> <span class="skolem">Bi</span>"</span></span> <span class="quoted"><span class="quoted">"inverts_mat <span class="skolem">Bi</span> <span class="free">B</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms invertible_mat_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"square_mat <span class="main">(</span>kronecker_product <span class="free">A</span> <span class="free">B</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> dim_col_mat<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> dim_row_mat<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> invertible_mat_def kronecker_product_def square_mat.simps<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"inverts_mat <span class="main">(</span>kronecker_product <span class="free">A</span> <span class="free">B</span><span class="main">)</span> <span class="main">(</span>kronecker_product <span class="skolem">Ai</span> <span class="skolem">Bi</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Ai Bi <span class="keyword1"><span class="command">unfolding</span></span> inverts_mat_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> dim_kronecker<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> index_mult_mat<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> index_one_mat<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> kronecker_of_mult kronecker_one<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"inverts_mat <span class="main">(</span>kronecker_product <span class="skolem">Ai</span> <span class="skolem">Bi</span><span class="main">)</span> <span class="main">(</span>kronecker_product <span class="free">A</span> <span class="free">B</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Ai Bi <span class="keyword1"><span class="command">unfolding</span></span> inverts_mat_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> dim_kronecker<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> index_mult_mat<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> index_one_mat<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> kronecker_of_mult kronecker_one<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> invertible_mat_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">"More DL Rank"</span></span>

<span class="comment1">(* conjugate matrices *)</span>
<span class="keyword1"><span class="command">instantiation</span></span> mat <span class="main">::</span> <span class="main">(</span><span class="quoted">conjugate</span><span class="main">)</span> <span class="quoted">conjugate</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity"><span class="class_parameter">conjugate_mat</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> conjugate mat <span class="main">⇒</span> <span class="tfree">'a</span> mat"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"conjugate <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">=</span> mat <span class="main">(</span>dim_row <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span> <span class="main">(</span>dim_col <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">i</span><span class="main">,</span><span class="bound">j</span><span class="main">)</span><span class="main">.</span> conjugate <span class="main">(</span><span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">$$</span> <span class="main">(</span><span class="bound">i</span><span class="main">,</span><span class="bound">j</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="More_Matrix-dim_row_conjugate"><span class="command">lemma</span></span> dim_row_conjugate<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"dim_row <span class="main">(</span>conjugate <span class="free">m</span><span class="main">)</span> <span class="main">=</span> dim_row <span class="free">m</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> conjugate_mat_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="More_Matrix-dim_col_conjugate"><span class="command">lemma</span></span> dim_col_conjugate<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"dim_col <span class="main">(</span>conjugate <span class="free">m</span><span class="main">)</span> <span class="main">=</span> dim_col <span class="free">m</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> conjugate_mat_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="More_Matrix-carrier_vec_conjugate"><span class="command">lemma</span></span> carrier_vec_conjugate<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">∈</span> carrier_mat <span class="free">nr</span> <span class="free">nc</span> <span class="main">⟹</span> conjugate <span class="free">m</span> <span class="main">∈</span> carrier_mat <span class="free">nr</span> <span class="free">nc</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="More_Matrix-mat_index_conjugate"><span class="command">lemma</span></span> mat_index_conjugate<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> dim_row <span class="free">m</span> <span class="main">⟹</span> <span class="free">j</span> <span class="main">&lt;</span> dim_col <span class="free">m</span> <span class="main">⟹</span> conjugate <span class="free">m</span>  <span class="main">$$</span> <span class="main">(</span><span class="free">i</span><span class="main">,</span><span class="free">j</span><span class="main">)</span> <span class="main">=</span> conjugate <span class="main">(</span><span class="free">m</span> <span class="main">$$</span> <span class="main">(</span><span class="free">i</span><span class="main">,</span><span class="free">j</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> conjugate_mat_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="More_Matrix-row_conjugate"><span class="command">lemma</span></span> row_conjugate<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> dim_row <span class="free">m</span> <span class="main">⟹</span> row <span class="main">(</span>conjugate <span class="free">m</span><span class="main">)</span> <span class="free">i</span> <span class="main">=</span> conjugate <span class="main">(</span>row <span class="free">m</span> <span class="free">i</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="More_Matrix-col_conjugate"><span class="command">lemma</span></span> col_conjugate<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> dim_col <span class="free">m</span> <span class="main">⟹</span> col <span class="main">(</span>conjugate <span class="free">m</span><span class="main">)</span> <span class="free">i</span> <span class="main">=</span> conjugate <span class="main">(</span>col <span class="free">m</span> <span class="free">i</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="More_Matrix-rows_conjugate"><span class="command">lemma</span></span> rows_conjugate<span class="main">:</span> <span class="quoted"><span class="quoted">"rows <span class="main">(</span>conjugate <span class="free">m</span><span class="main">)</span> <span class="main">=</span> map conjugate <span class="main">(</span>rows <span class="free">m</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> list_eq_iff_nth_eq<span class="main">)</span>

<span class="keyword1" id="More_Matrix-cols_conjugate"><span class="command">lemma</span></span> cols_conjugate<span class="main">:</span> <span class="quoted"><span class="quoted">"cols <span class="main">(</span>conjugate <span class="free">m</span><span class="main">)</span> <span class="main">=</span> map conjugate <span class="main">(</span>cols <span class="free">m</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> list_eq_iff_nth_eq<span class="main">)</span>

<span class="keyword1"><span class="command">instance</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span> <span class="skolem">b</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> mat"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"conjugate <span class="main">(</span>conjugate <span class="skolem">a</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">a</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> mat_eq_iff <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?a</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"conjugate <span class="skolem">a</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?b</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"conjugate <span class="skolem">b</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"conjugate <span class="skolem">a</span> <span class="main">=</span> conjugate <span class="skolem">b</span> <span class="main">⟷</span> <span class="skolem">a</span> <span class="main">=</span> <span class="skolem">b</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> dim_col_conjugate dim_row_conjugate mat_index_conjugate conjugate_cancel_iff mat_eq_iff<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">conjugate_transpose</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>conjugate mat  <span class="main">⇒</span> <span class="tfree">'a</span> mat"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">conjugate_transpose</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">≡</span> conjugate <span class="main">(</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="keyword1"><span class="hidden">⇧</span><sup>T</sup></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">notation</span></span> conjugate_transpose <span class="main">(</span><span class="quoted">"<span class="keyword3">(</span>_<span class="keyword1"><span class="hidden">⇧</span><sup>H</sup></span><span class="keyword3">)</span>"</span> <span class="main">[</span>1000<span class="main">]</span><span class="main">)</span>

<span class="keyword1" id="More_Matrix-transpose_conjugate"><span class="command">lemma</span></span> transpose_conjugate<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>conjugate <span class="free">A</span><span class="main">)</span><span class="keyword1"><span class="hidden">⇧</span><sup>T</sup></span> <span class="main">=</span> <span class="free">A</span><span class="keyword1"><span class="hidden">⇧</span><sup>H</sup></span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> conjugate_mat_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="More_Matrix-vec_module_col_helper"><span class="command">lemma</span></span> vec_module_col_helper<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span><span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">::</span> field<span class="main">)</span> mat"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">0<span class="hidden">⇩</span><sub>v</sub></span> <span class="main">(</span>dim_row <span class="free">A</span><span class="main">)</span> <span class="main">∈</span> LinearCombinations.module.span class_ring <span class="main">⦇</span>carrier <span class="main">=</span> carrier_vec <span class="main">(</span>dim_row <span class="free">A</span><span class="main">)</span><span class="main">,</span> mult <span class="main">=</span> undefined<span class="main">,</span> one <span class="main">=</span> undefined<span class="main">,</span> zero <span class="main">=</span> <span class="keyword1">0<span class="hidden">⇩</span><sub>v</sub></span> <span class="main">(</span>dim_row <span class="free">A</span><span class="main">)</span><span class="main">,</span> add <span class="main">=</span> <span class="main">(+)</span><span class="main">,</span> smult <span class="main">=</span> <span class="keyword1">(⋅<span class="hidden">⇩</span><sub>v</sub>)</span><span class="main">⦈</span> <span class="main">(</span>set <span class="main">(</span>cols <span class="free">A</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">v</span><span class="main">.</span> <span class="main">(</span><span class="main">0</span><span class="main">::</span><span class="tfree">'a</span><span class="main">)</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="bound">v</span> <span class="main">+</span> <span class="bound">v</span> <span class="main">=</span> <span class="bound">v</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">0<span class="hidden">⇩</span><sub>v</sub></span> <span class="main">(</span>dim_row <span class="free">A</span><span class="main">)</span> <span class="main">∈</span> LinearCombinations.module.span class_ring <span class="main">⦇</span>carrier <span class="main">=</span> carrier_vec <span class="main">(</span>dim_row <span class="free">A</span><span class="main">)</span><span class="main">,</span> mult <span class="main">=</span> undefined<span class="main">,</span> one <span class="main">=</span> undefined<span class="main">,</span> zero <span class="main">=</span> <span class="keyword1">0<span class="hidden">⇩</span><sub>v</sub></span> <span class="main">(</span>dim_row <span class="free">A</span><span class="main">)</span><span class="main">,</span> add <span class="main">=</span> <span class="main">(+)</span><span class="main">,</span> smult <span class="main">=</span> <span class="keyword1">(⋅<span class="hidden">⇩</span><sub>v</sub>)</span><span class="main">⦈</span> <span class="main">(</span>set <span class="main">(</span>cols <span class="free">A</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> cols_dim module_vec_def right_zero_vec smult_carrier_vec vec_space.prod_in_span zero_carrier_vec<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="More_Matrix-vec_module_col_helper2"><span class="command">lemma</span></span> vec_module_col_helper2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span><span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">::</span> field<span class="main">)</span> mat"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">a</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> LinearCombinations.module.span class_ring
                <span class="main">⦇</span>carrier <span class="main">=</span> carrier_vec <span class="main">(</span>dim_row <span class="free">A</span><span class="main">)</span><span class="main">,</span> mult <span class="main">=</span> undefined<span class="main">,</span> one <span class="main">=</span> undefined<span class="main">,</span>
                   zero <span class="main">=</span> <span class="keyword1">0<span class="hidden">⇩</span><sub>v</sub></span> <span class="main">(</span>dim_row <span class="free">A</span><span class="main">)</span><span class="main">,</span> add <span class="main">=</span> <span class="main">(+)</span><span class="main">,</span> smult <span class="main">=</span> <span class="keyword1">(⋅<span class="hidden">⇩</span><sub>v</sub>)</span><span class="main">⦈</span>
                <span class="main">(</span>set <span class="main">(</span>cols <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span>
           <span class="main">(</span><span class="main">⋀</span><span class="bound">a</span> <span class="bound">b</span> <span class="bound">v</span><span class="main">.</span> <span class="main">(</span><span class="bound">a</span> <span class="main">+</span> <span class="bound">b</span><span class="main">)</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="bound">v</span> <span class="main">=</span> <span class="bound">a</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="bound">v</span> <span class="main">+</span> <span class="bound">b</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="bound">v</span><span class="main">)</span> <span class="main">⟹</span>
           <span class="bound">a</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="bound">x</span>
           <span class="main">∈</span> LinearCombinations.module.span class_ring
               <span class="main">⦇</span>carrier <span class="main">=</span> carrier_vec <span class="main">(</span>dim_row <span class="free">A</span><span class="main">)</span><span class="main">,</span> mult <span class="main">=</span> undefined<span class="main">,</span> one <span class="main">=</span> undefined<span class="main">,</span>
                  zero <span class="main">=</span> <span class="keyword1">0<span class="hidden">⇩</span><sub>v</sub></span> <span class="main">(</span>dim_row <span class="free">A</span><span class="main">)</span><span class="main">,</span> add <span class="main">=</span> <span class="main">(+)</span><span class="main">,</span> smult <span class="main">=</span> <span class="keyword1">(⋅<span class="hidden">⇩</span><sub>v</sub>)</span><span class="main">⦈</span>
               <span class="main">(</span>set <span class="main">(</span>cols <span class="free">A</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span> <span class="main">::</span> <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">x</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> vec"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> LinearCombinations.module.span class_ring <span class="main">⦇</span>carrier <span class="main">=</span> carrier_vec <span class="main">(</span>dim_row <span class="free">A</span><span class="main">)</span><span class="main">,</span> mult <span class="main">=</span> undefined<span class="main">,</span> one <span class="main">=</span> undefined<span class="main">,</span> zero <span class="main">=</span> <span class="keyword1">0<span class="hidden">⇩</span><sub>v</sub></span> <span class="main">(</span>dim_row <span class="free">A</span><span class="main">)</span><span class="main">,</span> add <span class="main">=</span> <span class="main">(+)</span><span class="main">,</span> smult <span class="main">=</span> <span class="keyword1">(⋅<span class="hidden">⇩</span><sub>v</sub>)</span><span class="main">⦈</span> <span class="main">(</span>set <span class="main">(</span>cols <span class="free">A</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="skolem">x</span> <span class="main">∈</span> LinearCombinations.module.span class_ring <span class="main">⦇</span>carrier <span class="main">=</span> carrier_vec <span class="main">(</span>dim_row <span class="free">A</span><span class="main">)</span><span class="main">,</span> mult <span class="main">=</span> undefined<span class="main">,</span> one <span class="main">=</span> undefined<span class="main">,</span> zero <span class="main">=</span> <span class="keyword1">0<span class="hidden">⇩</span><sub>v</sub></span> <span class="main">(</span>dim_row <span class="free">A</span><span class="main">)</span><span class="main">,</span> add <span class="main">=</span> <span class="main">(+)</span><span class="main">,</span> smult <span class="main">=</span> <span class="keyword1">(⋅<span class="hidden">⇩</span><sub>v</sub>)</span><span class="main">⦈</span> <span class="main">(</span>set <span class="main">(</span>cols <span class="free">A</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> cols_dim idom_vec.smult_in_span module_vec_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="More_Matrix-vec_module_col"><span class="command">lemma</span></span> vec_module_col<span class="main">:</span> <span class="quoted"><span class="quoted">"module <span class="main">(</span>class_ring <span class="main">::</span> <span class="tfree">'a</span> <span class="main">::</span> field ring<span class="main">)</span>
  <span class="main">(</span>module_vec <span class="keyword1">TYPE</span><span class="main">(</span><span class="tfree">'a</span><span class="main">)</span> 
    <span class="main">(</span>dim_row <span class="free">A</span><span class="main">)</span>
      <span class="main">⦇</span>carrier <span class="main">:=</span>
         LinearCombinations.module.span
          class_ring <span class="main">(</span>module_vec <span class="keyword1">TYPE</span><span class="main">(</span><span class="tfree">'a</span><span class="main">)</span> <span class="main">(</span>dim_row <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>set <span class="main">(</span>cols <span class="free">A</span><span class="main">)</span><span class="main">)</span><span class="main">⦈</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">interpret</span></span> abelian_group <span class="quoted"><span class="quoted">"module_vec <span class="keyword1">TYPE</span><span class="main">(</span><span class="tfree">'a</span><span class="main">)</span> <span class="main">(</span>dim_row <span class="free">A</span><span class="main">)</span>
      <span class="main">⦇</span>carrier <span class="main">:=</span>
         LinearCombinations.module.span
          class_ring <span class="main">(</span>module_vec <span class="keyword1">TYPE</span><span class="main">(</span><span class="tfree">'a</span><span class="main">)</span> <span class="main">(</span>dim_row <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>set <span class="main">(</span>cols <span class="free">A</span><span class="main">)</span><span class="main">)</span><span class="main">⦈</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>module_vec_def<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> cols_dim module_vec_def partial_object.select_convs<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> ring.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> vec_vs vectorspace.span_add1<span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> assoc_add_vec cols_dim module_vec_def vec_space.cV vec_vs vectorspace.span_closed<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> vec_module_col_helper<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">A</span></span><span class="main">]</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>    
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> cols_dim left_zero_vec module_vec_def partial_object.select_convs<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> vec_vs vectorspace.span_closed<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> cols_dim module_vec_def partial_object.select_convs<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> right_zero_vec vec_vs vectorspace.span_closed<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> cols_dim comm_add_vec module_vec_def vec_space.cV vec_vs vectorspace.span_closed<span class="main">)</span>
    <span class="keyword1"><span class="command">unfolding</span></span> Units_def <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> cols_dim module_vec_def partial_object.select_convs<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> uminus_l_inv_vec uminus_r_inv_vec vec_space.vec_neg vec_vs vectorspace.span_closed vectorspace.span_neg<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main">)</span>
    <span class="keyword1"><span class="command">unfolding</span></span> <span class="dynamic"><span class="dynamic">class_ring_simps</span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">unfolding</span></span> module_vec_simps <span class="keyword1"><span class="command">using</span></span> add_smult_distrib_vec <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>module_vec_def<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> vec_module_col_helper2
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">using</span></span> cols_dim module_vec_def partial_object.select_convs<span class="main">(</span>1<span class="main">)</span> smult_add_distrib_vec vec_vs vectorspace.span_closed
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> <span class="main"><span class="main">(</span></span>z3<span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(* The columns of a matrix form a vectorspace *)</span>
<span class="keyword1" id="More_Matrix-vec_vs_col"><span class="command">lemma</span></span> vec_vs_col<span class="main">:</span> <span class="quoted"><span class="quoted">"vectorspace <span class="main">(</span>class_ring <span class="main">::</span> <span class="tfree">'a</span> <span class="main">::</span> field ring<span class="main">)</span>
  <span class="main">(</span>module_vec <span class="keyword1">TYPE</span><span class="main">(</span><span class="tfree">'a</span><span class="main">)</span> <span class="main">(</span>dim_row <span class="free">A</span><span class="main">)</span>
      <span class="main">⦇</span>carrier <span class="main">:=</span>
         LinearCombinations.module.span
          class_ring
          <span class="main">(</span>module_vec <span class="keyword1">TYPE</span><span class="main">(</span><span class="tfree">'a</span><span class="main">)</span>
            <span class="main">(</span>dim_row <span class="free">A</span><span class="main">)</span><span class="main">)</span>
          <span class="main">(</span>set <span class="main">(</span>cols <span class="free">A</span><span class="main">)</span><span class="main">)</span><span class="main">⦈</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> vectorspace_def
  <span class="keyword1"><span class="command">using</span></span> vec_module_col class_field 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> class_field_def<span class="main">)</span>

<span class="keyword1" id="More_Matrix-cols_mat_mul_map"><span class="command">lemma</span></span> cols_mat_mul_map<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"cols <span class="main">(</span><span class="free">A</span> <span class="main">*</span> <span class="free">B</span><span class="main">)</span> <span class="main">=</span> map <span class="main">(</span><span class="keyword1">(*<span class="hidden">⇩</span><sub>v</sub>)</span> <span class="free">A</span><span class="main">)</span> <span class="main">(</span>cols <span class="free">B</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> list_eq_iff_nth_eq
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="More_Matrix-cols_mat_mul"><span class="command">lemma</span></span> cols_mat_mul<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>cols <span class="main">(</span><span class="free">A</span> <span class="main">*</span> <span class="free">B</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">(*<span class="hidden">⇩</span><sub>v</sub>)</span> <span class="free">A</span> <span class="main">`</span> set <span class="main">(</span>cols <span class="free">B</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cols_mat_mul_map<span class="main">)</span>

<span class="keyword1" id="More_Matrix-set_obtain_sublist"><span class="command">lemma</span></span> set_obtain_sublist<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">⊆</span> set <span class="free">ls</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">ss</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"distinct <span class="free">ss</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">=</span> set <span class="free">ss</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms finite_distinct_list infinite_super <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="More_Matrix-mul_mat_of_cols"><span class="command">lemma</span></span> mul_mat_of_cols<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">∈</span> carrier_mat <span class="free">nr</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">j</span><span class="main">.</span> <span class="bound">j</span> <span class="main">&lt;</span> length <span class="free">cs</span> <span class="main">⟹</span> <span class="free">cs</span> <span class="main">!</span> <span class="bound">j</span> <span class="main">∈</span> carrier_vec <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">*</span> <span class="main">(</span>mat_of_cols <span class="free">n</span> <span class="free">cs</span><span class="main">)</span> <span class="main">=</span> mat_of_cols <span class="free">nr</span> <span class="main">(</span>map <span class="main">(</span><span class="keyword1">(*<span class="hidden">⇩</span><sub>v</sub>)</span> <span class="free">A</span><span class="main">)</span> <span class="free">cs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> mat_eq_iff
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> mat_of_cols_index<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="More_Matrix-helper"><span class="command">lemma</span></span> helper<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">x</span> <span class="free">y</span> <span class="free">z</span> <span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> <span class="main">{</span>conjugatable_ring<span class="main">,</span> comm_ring<span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">*</span> <span class="main">(</span><span class="free">y</span> <span class="main">*</span> <span class="free">z</span><span class="main">)</span> <span class="main">=</span> <span class="free">y</span> <span class="main">*</span> <span class="free">x</span> <span class="main">*</span> <span class="free">z</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mult.assoc mult.left_commute<span class="main">)</span>

<span class="keyword1" id="More_Matrix-cscalar_prod_conjugate_transpose"><span class="command">lemma</span></span> cscalar_prod_conjugate_transpose<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">x</span> <span class="free">y</span> <span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> <span class="main">{</span>conjugatable_ring<span class="main">,</span> comm_ring<span class="main">}</span> vec"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">∈</span> carrier_mat <span class="free">nr</span> <span class="free">nc</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> carrier_vec <span class="free">nr</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∈</span> carrier_vec <span class="free">nc</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="keyword1">∙c</span> <span class="main">(</span><span class="free">A</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">y</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">A</span><span class="keyword1"><span class="hidden">⇧</span><sup>H</sup></span> <span class="keyword1">*<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">x</span><span class="main">)</span> <span class="keyword1">∙c</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> mult_mat_vec_def scalar_prod_def
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sum_distrib_left sum_distrib_right sum_conjugate conjugate_dist_mul<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> sum.swap<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> helper mult.assoc mult.left_commute sum.cong<span class="main">)</span>

<span class="keyword1" id="More_Matrix-mat_mul_conjugate_transpose_vec_eq_0"><span class="command">lemma</span></span> mat_mul_conjugate_transpose_vec_eq_0<span class="main">:</span>                        
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">v</span> <span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> <span class="main">{</span>conjugatable_ordered_ring<span class="main">,</span>semiring_no_zero_divisors<span class="main">,</span>comm_ring<span class="main">}</span> vec"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">∈</span> carrier_mat <span class="free">nr</span> <span class="free">nc</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">∈</span> carrier_vec <span class="free">nr</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>v</sub></span> <span class="main">(</span><span class="free">A</span><span class="keyword1"><span class="hidden">⇧</span><sup>H</sup></span> <span class="keyword1">*<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">v</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">0<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">nr</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span><span class="keyword1"><span class="hidden">⇧</span><sup>H</sup></span> <span class="keyword1">*<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">v</span> <span class="main">=</span> <span class="keyword1">0<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">nc</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">A</span><span class="keyword1"><span class="hidden">⇧</span><sup>H</sup></span> <span class="keyword1">*<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">v</span><span class="main">)</span> <span class="keyword1">∙c</span> <span class="main">(</span><span class="free">A</span><span class="keyword1"><span class="hidden">⇧</span><sup>H</sup></span> <span class="keyword1">*<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">v</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">A</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>v</sub></span> <span class="main">(</span><span class="free">A</span><span class="keyword1"><span class="hidden">⇧</span><sup>H</sup></span> <span class="keyword1">*<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">v</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">∙c</span> <span class="free">v</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> Matrix.carrier_vec_conjugate assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> carrier_matD<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> conjugate_zero_vec cscalar_prod_conjugate_transpose dim_row_conjugate index_transpose_mat<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> mult_mat_vec_def scalar_prod_left_zero scalar_prod_right_zero vec_carrier<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="comment1">(* this step requires real entries *)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">A</span><span class="keyword1"><span class="hidden">⇧</span><sup>H</sup></span> <span class="keyword1">*<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">v</span><span class="main">)</span> <span class="keyword1">∙c</span> <span class="main">(</span><span class="free">A</span><span class="keyword1"><span class="hidden">⇧</span><sup>H</sup></span> <span class="keyword1">*<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">v</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> conjugate_square_eq_0_vec<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> carrier_dim_vec <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="More_Matrix-row_mat_of_cols"><span class="command">lemma</span></span> row_mat_of_cols<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> <span class="free">nr</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"row <span class="main">(</span>mat_of_cols <span class="free">nr</span> <span class="free">ls</span><span class="main">)</span> <span class="free">i</span> <span class="main">=</span> vec <span class="main">(</span>length <span class="free">ls</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">j</span><span class="main">.</span> <span class="main">(</span><span class="free">ls</span> <span class="main">!</span> <span class="bound">j</span><span class="main">)</span> <span class="main">$</span><span class="free">i</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> assms dim_vec eq_vecI index_row<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> index_row<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> index_vec mat_of_cols_carrier<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> mat_of_cols_carrier<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> mat_of_cols_index<span class="main">)</span>

<span class="keyword1" id="More_Matrix-mat_of_cols_cons_mat_vec"><span class="command">lemma</span></span> mat_of_cols_cons_mat_vec<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">v</span> <span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>comm_ring vec"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">∈</span> carrier_vec <span class="main">(</span>length <span class="free">ls</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"dim_vec <span class="free">a</span> <span class="main">=</span> <span class="free">nr</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"mat_of_cols <span class="free">nr</span> <span class="main">(</span><span class="free">a</span> <span class="main">#</span> <span class="free">ls</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>v</sub></span> <span class="main">(</span>vCons <span class="free">m</span> <span class="free">v</span><span class="main">)</span> <span class="main">=</span>
   <span class="free">m</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">a</span> <span class="main">+</span> mat_of_cols <span class="free">nr</span> <span class="free">ls</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">v</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> mult_mat_vec_def vec_eq_iff
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span>
    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> row_mat_of_cols vec_Suc o_def mult.commute<span class="main">)</span>

<span class="keyword1" id="More_Matrix-smult_vec_zero"><span class="command">lemma</span></span> smult_vec_zero<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">v</span> <span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>ring vec"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">v</span> <span class="main">=</span> <span class="keyword1">0<span class="hidden">⇩</span><sub>v</sub></span> <span class="main">(</span>dim_vec <span class="free">v</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> smult_vec_def vec_eq_iff
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="More_Matrix-helper2"><span class="command">lemma</span></span> helper2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span> <span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>comm_ring mat"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">v</span> <span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span> vec"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">∈</span> carrier_vec <span class="main">(</span>length <span class="free">ss</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> set <span class="free">ls</span> <span class="main">⟹</span> dim_vec <span class="bound">x</span> <span class="main">=</span> <span class="free">nr</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"mat_of_cols <span class="free">nr</span> <span class="free">ss</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">v</span> <span class="main">=</span>
   mat_of_cols <span class="free">nr</span> <span class="main">(</span><span class="free">ls</span> <span class="main">@</span> <span class="free">ss</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>v</sub></span> <span class="main">(</span><span class="keyword1">0<span class="hidden">⇩</span><sub>v</sub></span> <span class="main">(</span>length <span class="free">ls</span><span class="main">)</span> <span class="keyword1">@<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">v</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">ls</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">ls</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>zero_vec_Suc<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> mat_of_cols_cons_mat_vec<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>assms smult_vec_zero<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="More_Matrix-mat_of_cols_mult_mat_vec_permute_list"><span class="command">lemma</span></span> mat_of_cols_mult_mat_vec_permute_list<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">v</span> <span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>comm_ring list"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="keyword1">permutes</span> <span class="main">{..&lt;</span>length <span class="free">ss</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"length <span class="free">ss</span> <span class="main">=</span> length <span class="free">v</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"mat_of_cols <span class="free">nr</span> <span class="main">(</span>permute_list <span class="free">f</span> <span class="free">ss</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>v</sub></span> vec_of_list <span class="main">(</span>permute_list <span class="free">f</span> <span class="free">v</span><span class="main">)</span> <span class="main">=</span>
     mat_of_cols <span class="free">nr</span> <span class="free">ss</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>v</sub></span> vec_of_list <span class="free">v</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> mat_of_cols_def mult_mat_vec_def vec_eq_iff scalar_prod_def
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">clarsimp</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> <span class="free">nr</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> sum.permute<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">ia</span><span class="main">&lt;</span>length <span class="free">ss</span><span class="main">.</span> <span class="free">ss</span> <span class="main">!</span> <span class="free">f</span> <span class="bound">ia</span> <span class="main">$</span> <span class="skolem">i</span> <span class="main">*</span> <span class="free">v</span> <span class="main">!</span> <span class="free">f</span> <span class="bound">ia</span><span class="main">)</span> <span class="main">=</span>
  sum <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">ia</span><span class="main">.</span> <span class="free">ss</span> <span class="main">!</span> <span class="free">f</span> <span class="bound">ia</span> <span class="main">$</span> <span class="skolem">i</span> <span class="main">*</span> <span class="free">v</span> <span class="main">!</span> <span class="free">f</span> <span class="bound">ia</span><span class="main">)</span> <span class="main">∘</span> <span class="free">f</span><span class="main">)</span> <span class="main">{..&lt;</span>length <span class="free">ss</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">ia</span> <span class="main">=</span> <span class="main">0</span><span class="main">..&lt;</span>length <span class="free">v</span><span class="main">.</span> <span class="free">ss</span> <span class="main">!</span> <span class="free">f</span> <span class="bound">ia</span> <span class="main">$</span> <span class="skolem">i</span> <span class="main">*</span> <span class="free">v</span> <span class="main">!</span> <span class="free">f</span> <span class="bound">ia</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> calculation lessThan_atLeast0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">ia</span> <span class="main">=</span> <span class="main">0</span><span class="main">..&lt;</span>length <span class="free">v</span><span class="main">.</span>
             <span class="free">ss</span> <span class="main">!</span> <span class="free">f</span> <span class="bound">ia</span> <span class="main">$</span> <span class="skolem">i</span> <span class="main">*</span> <span class="free">v</span> <span class="main">!</span> <span class="free">f</span> <span class="bound">ia</span><span class="main">)</span> <span class="main">=</span>
         <span class="main">(</span><span class="main">∑</span><span class="bound">ia</span> <span class="main">=</span> <span class="main">0</span><span class="main">..&lt;</span>length <span class="free">v</span><span class="main">.</span>
             <span class="free">ss</span> <span class="main">!</span> <span class="bound">ia</span> <span class="main">$</span> <span class="skolem">i</span> <span class="main">*</span> <span class="free">v</span> <span class="main">!</span> <span class="bound">ia</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> <span class="quoted"><span class="quoted">‹<span class="main">⋀</span><span class="bound">g</span><span class="main">.</span> sum <span class="bound">g</span> <span class="main">{..&lt;</span>length <span class="free">ss</span><span class="main">}</span> <span class="main">=</span> sum <span class="main">(</span><span class="bound">g</span> <span class="main">∘</span> <span class="free">f</span><span class="main">)</span> <span class="main">{..&lt;</span>length <span class="free">ss</span><span class="main">}</span>›</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> comp_apply lessThan_atLeast0 sum.cong<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">ia</span> <span class="main">=</span> <span class="main">0</span><span class="main">..&lt;</span>length <span class="free">v</span><span class="main">.</span>
         vec <span class="main">(</span>length <span class="free">ss</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">j</span><span class="main">.</span> permute_list <span class="free">f</span> <span class="free">ss</span> <span class="main">!</span> <span class="bound">j</span> <span class="main">$</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">$</span> <span class="bound">ia</span> <span class="main">*</span>
         vec_of_list <span class="main">(</span>permute_list <span class="free">f</span> <span class="free">v</span><span class="main">)</span> <span class="main">$</span> <span class="bound">ia</span><span class="main">)</span> <span class="main">=</span>
         <span class="main">(</span><span class="main">∑</span><span class="bound">ia</span> <span class="main">=</span> <span class="main">0</span><span class="main">..&lt;</span>length <span class="free">v</span><span class="main">.</span> vec <span class="main">(</span>length <span class="free">ss</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">j</span><span class="main">.</span> <span class="free">ss</span> <span class="main">!</span> <span class="bound">j</span> <span class="main">$</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">$</span> <span class="bound">ia</span> <span class="main">*</span> vec_of_list <span class="free">v</span> <span class="main">$</span> <span class="bound">ia</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms * <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> permute_list_nth vec_of_list_index<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(* permute everything in a subset of the indices to the back *)</span>
<span class="keyword1" id="More_Matrix-subindex_permutation"><span class="command">lemma</span></span> subindex_permutation<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"distinct <span class="free">ss</span>"</span></span> <span class="quoted"><span class="quoted">"set <span class="free">ss</span> <span class="main">⊆</span> <span class="main">{..&lt;</span>length <span class="free">ls</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">f</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="keyword1">permutes</span> <span class="main">{..&lt;</span>length <span class="free">ls</span><span class="main">}</span>"</span></span>
    <span class="quoted"><span class="quoted">"permute_list <span class="free">f</span> <span class="free">ls</span> <span class="main">=</span> map <span class="main">(</span><span class="main">(!)</span> <span class="free">ls</span><span class="main">)</span> <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∉</span> set <span class="free">ss</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="free">ls</span><span class="main">]</span><span class="main">)</span> <span class="main">@</span> map <span class="main">(</span><span class="main">(!)</span> <span class="free">ls</span><span class="main">)</span> <span class="free">ss</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="free">ls</span><span class="main">]</span> <span class="main">=</span> set <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∉</span> set <span class="free">ss</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="free">ls</span><span class="main">]</span> <span class="main">@</span> <span class="free">ss</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> multiset_eq_iff <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mset <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="free">ls</span><span class="main">]</span> <span class="main">=</span> mset <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∉</span> set <span class="free">ss</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="free">ls</span><span class="main">]</span> <span class="main">@</span> <span class="free">ss</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> set_eq_iff_mset_eq_distinct<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>  
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mset <span class="free">ls</span> <span class="main">=</span> mset <span class="main">(</span>map <span class="main">(</span><span class="main">(!)</span> <span class="free">ls</span><span class="main">)</span>
           <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∉</span> set <span class="free">ss</span><span class="main">)</span>
             <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="free">ls</span><span class="main">]</span><span class="main">)</span> <span class="main">@</span> map <span class="main">(</span><span class="main">(!)</span> <span class="free">ls</span><span class="main">)</span> <span class="free">ss</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> length_map map_append map_nth mset_eq_permutation mset_permute_list permute_list_map<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> mset_eq_permutation that<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="More_Matrix-subindex_permutation2"><span class="command">lemma</span></span> subindex_permutation2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"distinct <span class="free">ss</span>"</span></span> <span class="quoted"><span class="quoted">"set <span class="free">ss</span> <span class="main">⊆</span> <span class="main">{..&lt;</span>length <span class="free">ls</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">f</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="keyword1">permutes</span> <span class="main">{..&lt;</span>length <span class="free">ls</span><span class="main">}</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">ls</span> <span class="main">=</span> permute_list <span class="free">f</span> <span class="main">(</span>map <span class="main">(</span><span class="main">(!)</span> <span class="free">ls</span><span class="main">)</span> <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∉</span> set <span class="free">ss</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="free">ls</span><span class="main">]</span><span class="main">)</span> <span class="main">@</span> map <span class="main">(</span><span class="main">(!)</span> <span class="free">ls</span><span class="main">)</span> <span class="free">ss</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> subindex_permutation
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> length_permute_list mset_eq_permutation mset_permute_list<span class="main">)</span>

<span class="keyword1" id="More_Matrix-distinct_list_subset_nths"><span class="command">lemma</span></span> distinct_list_subset_nths<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"distinct <span class="free">ss</span>"</span></span> <span class="quoted"><span class="quoted">"set <span class="free">ss</span> <span class="main">⊆</span> set <span class="free">ls</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">ids</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"distinct <span class="free">ids</span>"</span></span> <span class="quoted"><span class="quoted">"set <span class="free">ids</span> <span class="main">⊆</span> <span class="main">{..&lt;</span>length <span class="free">ls</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">ss</span> <span class="main">=</span> map <span class="main">(</span><span class="main">(!)</span> <span class="free">ls</span><span class="main">)</span> <span class="free">ids</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?ids</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"map <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="main">@</span><span class="bound">j</span><span class="main">.</span> <span class="bound">j</span> <span class="main">&lt;</span> length <span class="free">ls</span> <span class="main">∧</span> <span class="free">ls</span><span class="main">!</span><span class="bound">j</span> <span class="main">=</span> <span class="bound">i</span> <span class="main">)</span> <span class="free">ss</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="var">?ids</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> distinct_map
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inj_on_def<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> in_mono in_set_conv_nth tfl_some<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="var">?ids</span> <span class="main">⊆</span> <span class="main">{..&lt;</span>length <span class="free">ls</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> in_mono in_set_conv_nth tfl_some<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ss</span> <span class="main">=</span> map <span class="main">(</span><span class="main">(!)</span> <span class="free">ls</span><span class="main">)</span> <span class="var">?ids</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> list_eq_iff_nth_eq<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> imageI in_set_conv_nth subset_iff tfl_some<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">ids</span><span class="main">.</span> distinct <span class="bound">ids</span> <span class="main">⟹</span>
            set <span class="bound">ids</span> <span class="main">⊆</span> <span class="main">{..&lt;</span>length <span class="free">ls</span><span class="main">}</span> <span class="main">⟹</span>
            <span class="free">ss</span> <span class="main">=</span> map <span class="main">(</span><span class="main">(!)</span> <span class="free">ls</span><span class="main">)</span> <span class="bound">ids</span> <span class="main">⟹</span> <span class="free">thesis</span><span class="main">)</span> <span class="main">⟹</span>
    <span class="free">thesis</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1 2 3 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="More_Matrix-helper3"><span class="command">lemma</span></span> helper3<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span> <span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>comm_ring mat"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">∈</span> carrier_mat <span class="free">nr</span> <span class="free">nc</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ss<span class="main">:</span><span class="quoted"><span class="quoted">"distinct <span class="free">ss</span>"</span></span> <span class="quoted"><span class="quoted">"set <span class="free">ss</span> <span class="main">⊆</span> set <span class="main">(</span>cols <span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">∈</span> carrier_vec <span class="main">(</span>length <span class="free">ss</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">c</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"mat_of_cols <span class="free">nr</span> <span class="free">ss</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">v</span> <span class="main">=</span> <span class="free">A</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">c</span>"</span></span> <span class="quoted"><span class="quoted">"dim_vec <span class="free">c</span> <span class="main">=</span> <span class="free">nc</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> distinct_list_subset_nths<span class="main">[</span><span class="operator">OF</span> ss<span class="main">]</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ids</span></span> <span class="keyword2"><span class="keyword">where</span></span> ids<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="skolem">ids</span>"</span></span> <span class="quoted"><span class="quoted">"set <span class="skolem">ids</span> <span class="main">⊆</span> <span class="main">{..&lt;</span>length <span class="main">(</span>cols <span class="free">A</span><span class="main">)</span><span class="main">}</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> ss<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ss</span> <span class="main">=</span> map <span class="main">(</span><span class="main">(!)</span> <span class="main">(</span>cols <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="skolem">ids</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?ls</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">" map <span class="main">(</span><span class="main">(!)</span> <span class="main">(</span>cols <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∉</span> set <span class="skolem">ids</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="main">(</span>cols <span class="free">A</span><span class="main">)</span><span class="main">]</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> subindex_permutation2<span class="main">[</span><span class="operator">OF</span> ids<span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">f</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    f<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="keyword1">permutes</span> <span class="main">{..&lt;</span>length <span class="main">(</span>cols <span class="free">A</span><span class="main">)</span><span class="main">}</span>"</span></span>
    <span class="quoted"><span class="quoted">"cols <span class="free">A</span> <span class="main">=</span> permute_list <span class="skolem">f</span> <span class="main">(</span><span class="var">?ls</span> <span class="main">@</span> <span class="free">ss</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ss <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> set <span class="var">?ls</span> <span class="main">⟹</span> dim_vec <span class="bound">x</span> <span class="main">=</span> <span class="free">nr</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> A <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?cs1</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>list_of_vec <span class="main">(</span><span class="keyword1">0<span class="hidden">⇩</span><sub>v</sub></span> <span class="main">(</span>length <span class="var">?ls</span><span class="main">)</span> <span class="keyword1">@<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">v</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> helper2<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> <span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mat_of_cols <span class="free">nr</span> <span class="free">ss</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">v</span> <span class="main">=</span> mat_of_cols <span class="free">nr</span> <span class="main">(</span><span class="var">?ls</span> <span class="main">@</span> <span class="free">ss</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>v</sub></span> vec_of_list <span class="main">(</span><span class="var">?cs1</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> *
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> vec_list<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> mat_of_cols <span class="free">nr</span> <span class="main">(</span>permute_list <span class="skolem">f</span> <span class="main">(</span><span class="var">?ls</span> <span class="main">@</span> <span class="free">ss</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>v</sub></span> vec_of_list <span class="main">(</span>permute_list <span class="skolem">f</span> <span class="var">?cs1</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> mat_of_cols_mult_mat_vec_permute_list<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> cols_length f<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> f<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> length_append length_map length_permute_list<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span>  <span class="free">A</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>v</sub></span> vec_of_list <span class="main">(</span>permute_list <span class="skolem">f</span> <span class="var">?cs1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> f<span class="main">(</span>2<span class="main">)</span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">c</span><span class="main">.</span> mat_of_cols <span class="free">nr</span> <span class="free">ss</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">v</span> <span class="main">=</span> <span class="free">A</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>v</sub></span> <span class="bound">c</span> <span class="main">⟹</span> dim_vec <span class="bound">c</span> <span class="main">=</span> <span class="free">nc</span> <span class="main">⟹</span> <span class="free">thesis</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">thesis</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> A assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> carrier_matD<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> carrier_vecD cols_length dim_vec_of_list f<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> index_append_vec<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> index_zero_vec<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> length_append length_list_of_vec length_permute_list<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="More_Matrix-mat_mul_conjugate_transpose_sub_vec_eq_0"><span class="command">lemma</span></span> mat_mul_conjugate_transpose_sub_vec_eq_0<span class="main">:</span>                        
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span> <span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> <span class="main">{</span>conjugatable_ordered_ring<span class="main">,</span>semiring_no_zero_divisors<span class="main">,</span>comm_ring<span class="main">}</span> mat"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">∈</span> carrier_mat <span class="free">nr</span> <span class="free">nc</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"distinct <span class="free">ss</span>"</span></span> <span class="quoted"><span class="quoted">"set <span class="free">ss</span> <span class="main">⊆</span> set <span class="main">(</span>cols <span class="main">(</span><span class="free">A</span><span class="keyword1"><span class="hidden">⇧</span><sup>H</sup></span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">∈</span> carrier_vec <span class="main">(</span>length <span class="free">ss</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>v</sub></span> <span class="main">(</span>mat_of_cols <span class="free">nc</span> <span class="free">ss</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">v</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">0<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">nr</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>mat_of_cols <span class="free">nc</span> <span class="free">ss</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">v</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">0<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">nc</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span><span class="keyword1"><span class="hidden">⇧</span><sup>H</sup></span> <span class="main">∈</span> carrier_mat <span class="free">nc</span> <span class="free">nr</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span>  helper3<span class="main">[</span><span class="operator">OF</span> this assms<span class="main"><span class="main">(</span></span>2-4<span class="main"><span class="main">)</span></span><span class="main">]</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">c</span></span> <span class="keyword2"><span class="keyword">where</span></span> c<span class="main">:</span> <span class="quoted"><span class="quoted">"mat_of_cols <span class="free">nc</span> <span class="free">ss</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">v</span> <span class="main">=</span> <span class="free">A</span><span class="keyword1"><span class="hidden">⇧</span><sup>H</sup></span> <span class="keyword1">*<span class="hidden">⇩</span><sub>v</sub></span> <span class="skolem">c</span>"</span></span> <span class="quoted"><span class="quoted">"dim_vec <span class="skolem">c</span> <span class="main">=</span> <span class="free">nr</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">∈</span> carrier_vec <span class="free">nr</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> c carrier_vec_dim_vec <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>v</sub></span> <span class="main">(</span><span class="free">A</span><span class="keyword1"><span class="hidden">⇧</span><sup>H</sup></span> <span class="keyword1">*<span class="hidden">⇩</span><sub>v</sub></span> <span class="skolem">c</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">0<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">nr</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> c assms<span class="main">(</span>5<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> mat_mul_conjugate_transpose_vec_eq_0<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> 1 2<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span><span class="keyword1"><span class="hidden">⇧</span><sup>H</sup></span> <span class="keyword1">*<span class="hidden">⇩</span><sub>v</sub></span> <span class="skolem">c</span> <span class="main">=</span> <span class="keyword1">0<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">nc</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> c<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="More_Matrix-Units_invertible"><span class="command">lemma</span></span> Units_invertible<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span><span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>semiring_1 mat"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">∈</span> Units <span class="main">(</span>ring_mat <span class="keyword1">TYPE</span><span class="main">(</span><span class="tfree">'a</span><span class="main">)</span> <span class="free">n</span> <span class="free">b</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"invertible_mat <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> Units_def invertible_mat_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ring_mat_def<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> inverts_mat_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="More_Matrix-invertible_Units"><span class="command">lemma</span></span> invertible_Units<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span><span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>semiring_1 mat"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"invertible_mat <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">∈</span> Units <span class="main">(</span>ring_mat <span class="keyword1">TYPE</span><span class="main">(</span><span class="tfree">'a</span><span class="main">)</span> <span class="main">(</span>dim_row <span class="free">A</span><span class="main">)</span> <span class="free">b</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> Units_def invertible_mat_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ring_mat_def<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms carrier_mat_triv invertible_mat_def inverts_mat_def inverts_mat_length<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> inverts_mat_length<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1" id="More_Matrix-invertible_det"><span class="command">lemma</span></span> invertible_det<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span><span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>field mat"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">∈</span> carrier_mat <span class="free">n</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"invertible_mat <span class="free">A</span> <span class="main">⟷</span> det <span class="free">A</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">using</span></span> invertible_Units unit_imp_det_non_zero <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> Units_invertible det_non_zero_imp_unit<span class="main">)</span>

<span class="keyword1"><span class="command">context</span></span> vec_space <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="More_Matrix-find_indices_distinct"><span class="command">lemma</span></span> find_indices_distinct<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"distinct <span class="free">ss</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> length <span class="free">ss</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"find_indices <span class="main">(</span><span class="free">ss</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span> <span class="free">ss</span> <span class="main">=</span> <span class="main">[</span><span class="free">i</span><span class="main">]</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>find_indices <span class="main">(</span><span class="free">ss</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span> <span class="free">ss</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="free">i</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> nth_eq_iff_index_eq<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> distinct.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> distinct_find_indices empty_iff empty_set insert_iff list.exhaust list.simps<span class="main"><span class="main">(</span></span>15<span class="main"><span class="main">)</span></span><span class="main">)</span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="More_Matrix-lin_indpt_lin_comb_list"><span class="command">lemma</span></span> lin_indpt_lin_comb_list<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"distinct <span class="free">ss</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"lin_indpt <span class="main">(</span>set <span class="free">ss</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"set <span class="free">ss</span> <span class="main">⊆</span> carrier_vec <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"lincomb_list <span class="free">f</span> <span class="free">ss</span> <span class="main">=</span> <span class="keyword1">0<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> length <span class="free">ss</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="free">i</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> lincomb_list_as_lincomb<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"lincomb_list <span class="free">f</span> <span class="free">ss</span> <span class="main">=</span> lincomb <span class="main">(</span>mk_coeff <span class="free">ss</span> <span class="free">f</span><span class="main">)</span> <span class="main">(</span>set <span class="free">ss</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> lincomb  <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> sum <span class="free">f</span> <span class="main">(</span>set <span class="main">(</span>find_indices <span class="bound">v</span> <span class="free">ss</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>set <span class="free">ss</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> mk_coeff_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> R.sumlist_map_as_finsum<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> distinct_find_indices<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"lincomb_list <span class="free">f</span> <span class="free">ss</span> <span class="main">=</span> lincomb  <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> sum <span class="free">f</span> <span class="main">(</span>set <span class="main">(</span>find_indices <span class="bound">v</span> <span class="free">ss</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>set <span class="free">ss</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span><span class="quoted"><span class="quoted">"lincomb <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> sum <span class="free">f</span> <span class="main">(</span>set <span class="main">(</span>find_indices <span class="bound">v</span> <span class="free">ss</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>set <span class="free">ss</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">0<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>set <span class="free">ss</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> not_lindepD<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> this _ _ *<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> sum <span class="free">f</span> <span class="main">(</span>set <span class="main">(</span>find_indices <span class="bound">v</span> <span class="free">ss</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">ss</span> <span class="main">→</span> <span class="main">{</span><span class="main">0</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> funcset_mem<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sum <span class="free">f</span> <span class="main">(</span>set <span class="main">(</span>find_indices <span class="main">(</span>nth <span class="free">ss</span> <span class="free">i</span><span class="main">)</span> <span class="free">ss</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>5<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> find_indices_distinct<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(* Note: in this locale dim_row A = n, e.g.:
lemma foo:
  assumes "dim_row A = n"
  shows "rank A = vec_space.rank (dim_row A) A"
  by (simp add: assms) *)</span>

<span class="keyword1" id="More_Matrix-span_mat_mul_subset"><span class="command">lemma</span></span> span_mat_mul_subset<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">∈</span> carrier_mat <span class="free">n</span> <span class="free">d</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">B</span> <span class="main">∈</span> carrier_mat <span class="free">d</span> <span class="free">nc</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"span <span class="main">(</span>set <span class="main">(</span>cols <span class="main">(</span><span class="free">A</span> <span class="main">*</span> <span class="free">B</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> span <span class="main">(</span>set <span class="main">(</span>cols <span class="free">A</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">v</span><span class="main">.</span> <span class="main">∃</span><span class="bound">ca</span><span class="main">.</span> lincomb_list <span class="bound">v</span> <span class="main">(</span>cols <span class="main">(</span><span class="free">A</span> <span class="main">*</span> <span class="free">B</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
              lincomb_list <span class="bound">ca</span>  <span class="main">(</span>cols <span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">v</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"lincomb_list <span class="skolem">v</span> <span class="main">(</span>cols <span class="main">(</span><span class="free">A</span> <span class="main">*</span> <span class="free">B</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">A</span> <span class="main">*</span> <span class="free">B</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>v</sub></span> vec <span class="free">nc</span> <span class="skolem">v</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> lincomb_list_as_mat_mult<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> carrier_dim_vec carrier_matD<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> cols_dim index_mult_mat<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> subset_code<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> carrier_matD<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> carrier_matD<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> cols_length index_mult_mat<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> index_mult_mat<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> mat_of_cols_cols<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="free">A</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>v</sub></span> <span class="main">(</span><span class="free">B</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>v</sub></span> vec <span class="free">nc</span> <span class="skolem">v</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> lincomb_list <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="main">(</span><span class="free">B</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>v</sub></span> vec <span class="free">nc</span> <span class="skolem">v</span><span class="main">)</span> <span class="main">$</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span>cols <span class="free">A</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> lincomb_list_as_mat_mult<span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> carrier_dim_vec cols_dim <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> carrier_matD<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> carrier_matD<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> cols_length dim_mult_mat_vec dim_vec eq_vecI index_vec mat_of_cols_cols<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"lincomb_list <span class="skolem">v</span> <span class="main">(</span>cols <span class="main">(</span><span class="free">A</span> <span class="main">*</span> <span class="free">B</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
              lincomb_list <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="main">(</span><span class="free">B</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>v</sub></span> vec <span class="free">nc</span> <span class="skolem">v</span><span class="main">)</span> <span class="main">$</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span>cols <span class="free">A</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">ca</span><span class="main">.</span> lincomb_list <span class="skolem">v</span> <span class="main">(</span>cols <span class="main">(</span><span class="free">A</span> <span class="main">*</span> <span class="free">B</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> lincomb_list <span class="bound">ca</span> <span class="main">(</span>cols <span class="free">A</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> span_list_as_span<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> carrier_matD<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> cols_dim index_mult_mat<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> span_list_as_span<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> cols_dim <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>span_list_def *<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="More_Matrix-rank_mat_mul_right"><span class="command">lemma</span></span> rank_mat_mul_right<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">∈</span> carrier_mat <span class="free">n</span> <span class="free">d</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">B</span> <span class="main">∈</span> carrier_mat <span class="free">d</span> <span class="free">nc</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"rank <span class="main">(</span><span class="free">A</span> <span class="main">*</span> <span class="free">B</span><span class="main">)</span> <span class="main">≤</span> rank <span class="free">A</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"subspace class_ring <span class="main">(</span>local.span <span class="main">(</span>set <span class="main">(</span>cols <span class="main">(</span><span class="free">A</span><span class="main">*</span><span class="free">B</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
        <span class="main">(</span>vs <span class="main">(</span>local.span <span class="main">(</span>set <span class="main">(</span>cols <span class="free">A</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> subspace_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> carrier_matD<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> cols_dim index_mult_mat<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> nested_submodules span_is_submodule vec_space.span_mat_mul_subset vec_vs_col<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> vectorspace.subspace_dim<span class="main">[</span><span class="operator">OF</span> _ this<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"vectorspace.dim class_ring
   <span class="main">(</span>vs <span class="main">(</span>local.span <span class="main">(</span>set <span class="main">(</span>cols <span class="free">A</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
    <span class="main">⦇</span>carrier <span class="main">:=</span> local.span <span class="main">(</span>set <span class="main">(</span>cols <span class="main">(</span><span class="free">A</span> <span class="main">*</span> <span class="free">B</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">⦈</span><span class="main">)</span> <span class="main">≤</span>
  vectorspace.dim class_ring
      <span class="main">(</span>vs <span class="main">(</span>local.span <span class="main">(</span>set <span class="main">(</span>cols <span class="free">A</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> carrier_matD<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> fin_dim_span_cols index_mult_mat<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> mat_of_cols_carrier<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> mat_of_cols_cols vec_vs_col<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> rank_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="More_Matrix-sumlist_drop"><span class="command">lemma</span></span> sumlist_drop<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">v</span><span class="main">.</span> <span class="bound">v</span> <span class="main">∈</span> set <span class="free">ls</span> <span class="main">⟹</span> dim_vec <span class="bound">v</span> <span class="main">=</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sumlist <span class="free">ls</span> <span class="main">=</span> sumlist <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> <span class="bound">v</span> <span class="main">≠</span> <span class="keyword1">0<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">n</span><span class="main">)</span> <span class="free">ls</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">ls</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">ls</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> dim_sumlist <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="More_Matrix-lincomb_list_alt"><span class="command">lemma</span></span> lincomb_list_alt<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"lincomb_list <span class="free">c</span> <span class="free">s</span> <span class="main">=</span>
    sumlist <span class="main">(</span>map2 <span class="main">(</span><span class="main">λ</span><span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> <span class="bound">i</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">s</span> <span class="main">!</span> <span class="bound">j</span><span class="main">)</span> <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="free">c</span> <span class="bound">i</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="free">s</span><span class="main">]</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="free">s</span><span class="main">]</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> lincomb_list_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> length_map map2_map_map map_nth nth_equalityI nth_map<span class="main">)</span>

<span class="keyword1" id="More_Matrix-lincomb_list_alt2"><span class="command">lemma</span></span> lincomb_list_alt2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">v</span><span class="main">.</span> <span class="bound">v</span> <span class="main">∈</span> set <span class="free">s</span> <span class="main">⟹</span> dim_vec <span class="bound">v</span> <span class="main">=</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∈</span> set <span class="free">ls</span> <span class="main">⟹</span> <span class="bound">i</span> <span class="main">&lt;</span> length <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"
    sumlist <span class="main">(</span>map2 <span class="main">(</span><span class="main">λ</span><span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> <span class="bound">i</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">s</span> <span class="main">!</span> <span class="bound">j</span><span class="main">)</span> <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="free">c</span> <span class="bound">i</span><span class="main">)</span> <span class="free">ls</span><span class="main">)</span> <span class="free">ls</span><span class="main">)</span> <span class="main">=</span>
    sumlist <span class="main">(</span>map2 <span class="main">(</span><span class="main">λ</span><span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> <span class="bound">i</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">s</span> <span class="main">!</span> <span class="bound">j</span><span class="main">)</span> <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="free">c</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="free">c</span> <span class="bound">i</span> <span class="main">≠</span> <span class="main">0</span><span class="main">)</span> <span class="free">ls</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="free">c</span> <span class="bound">i</span> <span class="main">≠</span> <span class="main">0</span><span class="main">)</span> <span class="free">ls</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">ls</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">s</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> smult_l_null<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> carrier_vecI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> left_zero_vec<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> sumlist_carrier<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> carrier_dim_vec mem_Collect_eq nth_mem set_filter set_zip_rightD<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> 

<span class="keyword1" id="More_Matrix-two_set"><span class="command">lemma</span></span> two_set<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"distinct <span class="free">ls</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"set <span class="free">ls</span> <span class="main">=</span> set <span class="main">[</span><span class="free">a</span><span class="main">,</span><span class="free">b</span><span class="main">]</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">≠</span> <span class="free">b</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">ls</span> <span class="main">=</span> <span class="main">[</span><span class="free">a</span><span class="main">,</span><span class="free">b</span><span class="main">]</span> <span class="main">∨</span> <span class="free">ls</span> <span class="main">=</span> <span class="main">[</span><span class="free">b</span><span class="main">,</span><span class="free">a</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">ls</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">xs</span>
  <span class="keyword3"><span class="command">assume</span></span> ls<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="free">ls</span> <span class="main">=</span> <span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span>"</span></span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="skolem"><span class="skolem">ys</span></span> <span class="keyword2"><span class="keyword">where</span></span> xs<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">=</span> <span class="skolem">y</span> <span class="main">#</span> <span class="skolem">ys</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> <span class="quoted"><span class="quoted">‹<span class="free">ls</span> <span class="main">=</span> <span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span>›</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> list.set_cases list.set_intros<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> list.set_intros<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> set_ConsD<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="free">a</span> <span class="main">∨</span> <span class="skolem">x</span> <span class="main">=</span> <span class="free">b</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">ls</span> <span class="main">=</span> <span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span>›</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">=</span> <span class="free">a</span> <span class="main">∨</span> <span class="skolem">y</span> <span class="main">=</span> <span class="free">b</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">ls</span> <span class="main">=</span> <span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">xs</span> <span class="main">=</span> <span class="skolem">y</span> <span class="main">#</span> <span class="skolem">ys</span>›</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">ys</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> <span class="quoted"><span class="quoted">‹<span class="free">ls</span> <span class="main">=</span> <span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">xs</span> <span class="main">=</span> <span class="skolem">y</span> <span class="main">#</span> <span class="skolem">ys</span>›</span></span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> distinct.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> distinct_length_2_or_more in_set_member member_rec<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> neq_Nil_conv set_ConsD<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">ls</span> <span class="main">=</span> <span class="main">[</span><span class="free">a</span><span class="main">,</span> <span class="free">b</span><span class="main">]</span> <span class="main">∨</span> <span class="free">ls</span> <span class="main">=</span> <span class="main">[</span><span class="free">b</span><span class="main">,</span> <span class="free">a</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ls xs 1 2 3 assms
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="More_Matrix-filter_disj_inds"><span class="command">lemma</span></span> filter_disj_inds<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> length <span class="free">ls</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">&lt;</span> length <span class="free">ls</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≠</span> <span class="free">j</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"filter <span class="main">(</span><span class="main">λ</span><span class="bound">ia</span><span class="main">.</span> <span class="bound">ia</span> <span class="main">≠</span> <span class="free">j</span> <span class="main">⟶</span> <span class="bound">ia</span> <span class="main">=</span> <span class="free">i</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="free">ls</span><span class="main">]</span> <span class="main">=</span> <span class="main">[</span><span class="free">i</span><span class="main">,</span> <span class="free">j</span><span class="main">]</span> <span class="main">∨</span>
  filter <span class="main">(</span><span class="main">λ</span><span class="bound">ia</span><span class="main">.</span> <span class="bound">ia</span> <span class="main">≠</span> <span class="free">j</span> <span class="main">⟶</span> <span class="bound">ia</span> <span class="main">=</span> <span class="free">i</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="free">ls</span><span class="main">]</span> <span class="main">=</span> <span class="main">[</span><span class="free">j</span><span class="main">,</span><span class="free">i</span><span class="main">]</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="bound">ia</span><span class="main">.</span> <span class="bound">ia</span> <span class="main">=</span> <span class="free">i</span> <span class="main">∨</span> <span class="bound">ia</span> <span class="main">=</span> <span class="free">j</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="free">ls</span><span class="main">]</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> distinct_filter distinct_upt <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span><span class="quoted"><span class="quoted">"set <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="bound">ia</span><span class="main">.</span> <span class="bound">ia</span> <span class="main">=</span> <span class="free">i</span> <span class="main">∨</span> <span class="bound">ia</span> <span class="main">=</span> <span class="free">j</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="free">ls</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="free">i</span><span class="main">,</span> <span class="free">j</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> two_set<span class="main">[</span><span class="operator">OF</span> 1<span class="main">]</span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span> empty_set filter_cong list.simps<span class="main">(</span>15<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> <span class="quoted">"2"</span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> empty_set filter_cong list.simps<span class="main"><span class="main">(</span></span>15<span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="More_Matrix-lincomb_list_indpt_distinct"><span class="command">lemma</span></span> lincomb_list_indpt_distinct<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">v</span><span class="main">.</span> <span class="bound">v</span> <span class="main">∈</span> set <span class="free">ls</span> <span class="main">⟹</span> dim_vec <span class="bound">v</span> <span class="main">=</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">c</span><span class="main">.</span> lincomb_list <span class="bound">c</span> <span class="free">ls</span> <span class="main">=</span> <span class="keyword1">0<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">n</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">∀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="main">(</span>length <span class="free">ls</span><span class="main">)</span> <span class="main">⟶</span> <span class="bound">c</span> <span class="bound">i</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"distinct <span class="free">ls</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> distinct_conv_nth
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">clarsimp</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="skolem">j</span>
  <span class="keyword3"><span class="command">assume</span></span> ij<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="free">ls</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> length <span class="free">ls</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">≠</span> <span class="skolem">j</span>"</span></span> 
  <span class="keyword3"><span class="command">assume</span></span> lsij<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ls</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">=</span> <span class="free">ls</span> <span class="main">!</span> <span class="skolem">j</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"lincomb_list <span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">k</span> <span class="main">=</span> <span class="skolem">i</span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="bound">k</span> <span class="main">=</span> <span class="skolem">j</span> <span class="keyword1">then</span> <span class="main">-</span><span class="main">1</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span> <span class="free">ls</span> <span class="main">=</span>
     <span class="main">(</span><span class="free">ls</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">-</span> <span class="main">(</span><span class="free">ls</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> lincomb_list_alt
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> lincomb_list_alt2<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">using</span></span>  filter_disj_inds<span class="main">[</span><span class="operator">OF</span> ij<span class="main">]</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">using</span></span> ij<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> ij<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command">using</span></span> ij<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> ij<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span>  <span class="main">=</span> <span class="keyword1">0<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> lsij
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> minus_cancel_vec<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">j</span> <span class="main">&lt;</span> length <span class="free">ls</span>›</span></span> assms<span class="main">(</span>1<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> carrier_vec_dim_vec nth_mem <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"lincomb_list <span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">k</span> <span class="main">=</span> <span class="skolem">i</span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="bound">k</span> <span class="main">=</span> <span class="skolem">j</span> <span class="keyword1">then</span> <span class="main">-</span><span class="main">1</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span> <span class="free">ls</span> <span class="main">=</span> <span class="keyword1">0<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="free">ls</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">locale</span></span> conjugatable_vec_space <span class="main">=</span> vec_space <span class="quoted"><span class="free">f_ty</span></span> <span class="quoted"><span class="free">n</span></span> <span class="keyword2"><span class="keyword">for</span></span>
  <span class="free">f_ty</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>conjugatable_ordered_field itself"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="free">n</span>
<span class="keyword2"><span class="keyword">begin</span></span>                                                           

<span class="keyword1" id="More_Matrix-transpose_rank_mul_conjugate_transpose"><span class="command">lemma</span></span> transpose_rank_mul_conjugate_transpose<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> mat"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">∈</span> carrier_mat <span class="free">n</span> <span class="free">nc</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"vec_space.rank <span class="free">nc</span> <span class="free">A</span><span class="keyword1"><span class="hidden">⇧</span><sup>H</sup></span> <span class="main">≤</span> rank <span class="main">(</span><span class="free">A</span> <span class="main">*</span> <span class="free">A</span><span class="keyword1"><span class="hidden">⇧</span><sup>H</sup></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A</span><span class="keyword1"><span class="hidden">⇧</span><sup>H</sup></span> <span class="main">∈</span> carrier_mat <span class="free">nc</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">*</span> <span class="free">A</span><span class="keyword1"><span class="hidden">⇧</span><sup>H</sup></span> <span class="main">∈</span> carrier_mat <span class="free">n</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="comment1">(* S is a maximal linearly independent set of rows A (or cols A<span class="hidden">⇧</span><sup>T</sup>) *)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?P</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">T</span><span class="main">.</span> <span class="bound">T</span> <span class="main">⊆</span> set <span class="main">(</span>cols <span class="free">A</span><span class="keyword1"><span class="hidden">⇧</span><sup>H</sup></span><span class="main">)</span> <span class="main">∧</span> module.lin_indpt class_ring <span class="main">(</span>module_vec <span class="keyword1">TYPE</span><span class="main">(</span><span class="tfree">'a</span><span class="main">)</span> <span class="free">nc</span><span class="main">)</span> <span class="bound">T</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">A</span><span class="main">.</span> <span class="var">?P</span> <span class="bound">A</span> <span class="main">⟹</span> finite <span class="bound">A</span> <span class="main">∧</span> card <span class="bound">A</span> <span class="main">≤</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">clarsimp</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">S</span>
    <span class="keyword3"><span class="command">assume</span></span> S<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">S</span> <span class="main">⊆</span> set <span class="main">(</span>cols <span class="free">A</span><span class="keyword1"><span class="hidden">⇧</span><sup>H</sup></span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="skolem">S</span> <span class="main">≤</span> card <span class="main">(</span>set <span class="main">(</span>cols <span class="free">A</span><span class="keyword1"><span class="hidden">⇧</span><sup>H</sup></span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> S
      <span class="keyword1"><span class="command">using</span></span> card_mono <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">≤</span> length <span class="main">(</span>cols <span class="free">A</span><span class="keyword1"><span class="hidden">⇧</span><sup>H</sup></span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> card_length <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">≤</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"finite <span class="skolem">S</span> <span class="main">∧</span> card <span class="skolem">S</span> <span class="main">≤</span> <span class="free">n</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> List.finite_set S dual_order.trans finite_subset<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">have</span></span> **<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> module.lin_dep_def<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> vec_module<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> maximal_exists<span class="main">[</span><span class="operator">OF</span> *<span class="main">]</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">S</span></span> <span class="keyword2"><span class="keyword">where</span></span> S<span class="main">:</span> <span class="quoted"><span class="quoted">"maximal <span class="skolem">S</span> <span class="var">?P</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> **
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span><span class="main">)</span> 
      <span class="comment1">(* Some properties of S *)</span>
  <span class="keyword1"><span class="command">from</span></span> vec_space.rank_card_indpt<span class="main">[</span><span class="operator">OF</span> 1 S<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> rankeq<span class="main">:</span> <span class="quoted"><span class="quoted">"vec_space.rank <span class="free">nc</span> <span class="free">A</span><span class="keyword1"><span class="hidden">⇧</span><sup>H</sup></span> <span class="main">=</span> card <span class="skolem">S</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>

  <span class="keyword1"><span class="command">have</span></span> s_hyp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">S</span> <span class="main">⊆</span> set <span class="main">(</span>cols <span class="free">A</span><span class="keyword1"><span class="hidden">⇧</span><sup>H</sup></span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> S <span class="keyword1"><span class="command">unfolding</span></span> maximal_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> modhyp<span class="main">:</span> <span class="quoted"><span class="quoted">"module.lin_indpt class_ring <span class="main">(</span>module_vec <span class="keyword1">TYPE</span><span class="main">(</span><span class="tfree">'a</span><span class="main">)</span> <span class="free">nc</span><span class="main">)</span> <span class="skolem">S</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> S <span class="keyword1"><span class="command">unfolding</span></span> maximal_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="comment1">(* switch to a list representation *)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ss</span></span> <span class="keyword2"><span class="keyword">where</span></span> ss<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="skolem">ss</span> <span class="main">=</span> <span class="skolem">S</span>"</span></span> <span class="quoted"><span class="quoted">"distinct <span class="skolem">ss</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">)</span></span> S maximal_def set_obtain_sublist<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> ss2<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>map <span class="main">(</span><span class="keyword1">(*<span class="hidden">⇩</span><sub>v</sub>)</span> <span class="free">A</span><span class="main">)</span> <span class="skolem">ss</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">(*<span class="hidden">⇩</span><sub>v</sub>)</span> <span class="free">A</span> <span class="main">`</span> <span class="skolem">S</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ss<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> rw_hyp<span class="main">:</span> <span class="quoted"><span class="quoted">"cols <span class="main">(</span>mat_of_cols <span class="free">n</span> <span class="main">(</span>map <span class="main">(</span><span class="keyword1">(*<span class="hidden">⇩</span><sub>v</sub>)</span> <span class="free">A</span><span class="main">)</span> <span class="skolem">ss</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> cols  <span class="main">(</span><span class="free">A</span> <span class="main">*</span> mat_of_cols <span class="free">nc</span> <span class="skolem">ss</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">unfolding</span></span> cols_def <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> mat_vec_as_mat_mat_mult<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">A</span></span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="free">nc</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> <span class="quoted">"1"</span> assms carrier_matD<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> cols_dim mul_mat_of_cols nth_mem s_hyp ss<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> subset_code<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> rw<span class="main">:</span> <span class="quoted"><span class="quoted">"mat_of_cols <span class="free">n</span> <span class="main">(</span>map <span class="main">(</span><span class="keyword1">(*<span class="hidden">⇩</span><sub>v</sub>)</span> <span class="free">A</span><span class="main">)</span> <span class="skolem">ss</span><span class="main">)</span> <span class="main">=</span> <span class="free">A</span> <span class="main">*</span> mat_of_cols <span class="free">nc</span> <span class="skolem">ss</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms carrier_matD<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> index_mult_mat<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> mat_of_cols_carrier<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> mat_of_cols_cols<span class="main">)</span> 
  <span class="keyword1"><span class="command">have</span></span> indpt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">c</span><span class="main">.</span> lincomb_list <span class="bound">c</span> <span class="main">(</span>map <span class="main">(</span><span class="keyword1">(*<span class="hidden">⇩</span><sub>v</sub>)</span> <span class="free">A</span><span class="main">)</span> <span class="skolem">ss</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">0<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">n</span> <span class="main">⟹</span>
      <span class="main">∀</span><span class="bound">i</span><span class="main">.</span> <span class="main">(</span><span class="bound">i</span> <span class="main">&lt;</span> <span class="main">(</span>length <span class="skolem">ss</span><span class="main">)</span> <span class="main">⟶</span> <span class="bound">c</span> <span class="bound">i</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">clarsimp</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">c</span> <span class="skolem">i</span>
    <span class="keyword3"><span class="command">assume</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"lincomb_list <span class="skolem">c</span> <span class="main">(</span>map <span class="main">(</span><span class="keyword1">(*<span class="hidden">⇩</span><sub>v</sub>)</span> <span class="free">A</span><span class="main">)</span> <span class="skolem">ss</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">0<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">n</span>"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="skolem">ss</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">w</span><span class="main">∈</span>set <span class="main">(</span>map <span class="main">(</span><span class="keyword1">(*<span class="hidden">⇩</span><sub>v</sub>)</span> <span class="free">A</span><span class="main">)</span> <span class="skolem">ss</span><span class="main">)</span><span class="main">.</span> dim_vec <span class="bound">w</span> <span class="main">=</span> <span class="free">n</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> lincomb_list_as_mat_mult<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">*</span> mat_of_cols <span class="free">nc</span> <span class="skolem">ss</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>v</sub></span>  vec <span class="main">(</span>length <span class="skolem">ss</span><span class="main">)</span> <span class="skolem">c</span> <span class="main">=</span> <span class="keyword1">0<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">n</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> * rw <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> hq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>v</sub></span> <span class="main">(</span>mat_of_cols <span class="free">nc</span> <span class="skolem">ss</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>v</sub></span> vec <span class="main">(</span>length <span class="skolem">ss</span><span class="main">)</span> <span class="skolem">c</span><span class="main">)</span> <span class="main">=</span>  <span class="keyword1">0<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">n</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms assoc_mult_mat_vec mat_of_cols_carrier<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> vec_carrier<span class="main">)</span>

    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> eq1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>mat_of_cols <span class="free">nc</span> <span class="skolem">ss</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>v</sub></span> vec <span class="main">(</span>length <span class="skolem">ss</span><span class="main">)</span> <span class="skolem">c</span><span class="main">)</span> <span class="main">=</span>  <span class="keyword1">0<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">nc</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> mat_mul_conjugate_transpose_sub_vec_eq_0<span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> assms ss s_hyp <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="comment1">(* Rewrite the inner vector back to a lincomb_list *)</span>
    <span class="keyword1"><span class="command">have</span></span> dim_hyp2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">w</span><span class="main">∈</span>set <span class="skolem">ss</span><span class="main">.</span> dim_vec <span class="bound">w</span> <span class="main">=</span> <span class="free">nc</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> ss<span class="main">(</span>1<span class="main">)</span> s_hyp
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted">"1"</span> carrier_matD<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> carrier_vecD cols_dim subsetD<span class="main">)</span> 
    <span class="keyword1"><span class="command">from</span></span> vec_module.lincomb_list_as_mat_mult<span class="main">[</span><span class="operator">OF</span> this<span class="main">,</span> <span class="operator">symmetric</span><span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mat_of_cols <span class="free">nc</span> <span class="skolem">ss</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>v</sub></span> vec <span class="main">(</span>length <span class="skolem">ss</span><span class="main">)</span> <span class="skolem">c</span> <span class="main">=</span> module.lincomb_list <span class="main">(</span>module_vec <span class="keyword1">TYPE</span><span class="main">(</span><span class="tfree">'a</span><span class="main">)</span> <span class="free">nc</span><span class="main">)</span> <span class="skolem">c</span> <span class="skolem">ss</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"module.lincomb_list <span class="main">(</span>module_vec <span class="keyword1">TYPE</span><span class="main">(</span><span class="tfree">'a</span><span class="main">)</span> <span class="free">nc</span><span class="main">)</span> <span class="skolem">c</span> <span class="skolem">ss</span> <span class="main">=</span> <span class="keyword1">0<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">nc</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> eq1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> vec_space.lin_indpt_lin_comb_list<span class="main">[</span><span class="operator">OF</span> ss<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> _ _ this i<span class="main">]</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="skolem">i</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> modhyp ss s_hyp
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"1"</span> cols_dim <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">have</span></span> distinct<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>map <span class="main">(</span><span class="keyword1">(*<span class="hidden">⇩</span><sub>v</sub>)</span> <span class="free">A</span><span class="main">)</span> <span class="skolem">ss</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> assms carrier_matD<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> dim_mult_mat_vec imageE indpt length_map lincomb_list_indpt_distinct ss2<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"card <span class="skolem">S</span> <span class="main">=</span> card <span class="main">(</span><span class="keyword1">(*<span class="hidden">⇩</span><sub>v</sub>)</span> <span class="free">A</span> <span class="main">`</span> <span class="skolem">S</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> ss distinct_card image_set length_map<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> 4<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">(*<span class="hidden">⇩</span><sub>v</sub>)</span> <span class="free">A</span> <span class="main">`</span> <span class="skolem">S</span> <span class="main">⊆</span> set <span class="main">(</span>cols <span class="main">(</span><span class="free">A</span> <span class="main">*</span> <span class="free">A</span><span class="keyword1"><span class="hidden">⇧</span><sup>H</sup></span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> cols_mat_mul <span class="quoted"><span class="quoted">‹<span class="skolem">S</span> <span class="main">⊆</span> set <span class="main">(</span>cols <span class="free">A</span><span class="keyword1"><span class="hidden">⇧</span><sup>H</sup></span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> 5<span class="main">:</span> <span class="quoted"><span class="quoted">"lin_indpt <span class="main">(</span><span class="keyword1">(*<span class="hidden">⇩</span><sub>v</sub>)</span> <span class="free">A</span> <span class="main">`</span> <span class="skolem">S</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">clarsimp</span>
    <span class="keyword3"><span class="command">assume</span></span> ld<span class="main">:</span><span class="quoted"><span class="quoted">"lin_dep <span class="main">(</span><span class="keyword1">(*<span class="hidden">⇩</span><sub>v</sub>)</span> <span class="free">A</span> <span class="main">`</span> <span class="skolem">S</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="keyword1">(*<span class="hidden">⇩</span><sub>v</sub>)</span> <span class="free">A</span> <span class="main">`</span> <span class="skolem">S</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> List.finite_set ss2<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> **<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">(*<span class="hidden">⇩</span><sub>v</sub>)</span> <span class="free">A</span> <span class="main">`</span> <span class="skolem">S</span> <span class="main">⊆</span> carrier_vec <span class="free">n</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"2"</span> <span class="quoted">"4"</span> cols_dim <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">from</span></span> finite_lin_dep<span class="main">[</span><span class="operator">OF</span> * ld **<span class="main">]</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="keyword2"><span class="keyword">where</span></span>
      a<span class="main">:</span> <span class="quoted"><span class="quoted">"lincomb <span class="skolem">a</span> <span class="main">(</span><span class="keyword1">(*<span class="hidden">⇩</span><sub>v</sub>)</span> <span class="free">A</span> <span class="main">`</span> <span class="skolem">S</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">0<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">n</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      v<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∈</span> <span class="keyword1">(*<span class="hidden">⇩</span><sub>v</sub>)</span> <span class="free">A</span> <span class="main">`</span> <span class="skolem">S</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="skolem">v</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> i<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">=</span> map <span class="main">(</span><span class="keyword1">(*<span class="hidden">⇩</span><sub>v</sub>)</span> <span class="free">A</span><span class="main">)</span> <span class="skolem">ss</span> <span class="main">!</span> <span class="skolem">i</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="skolem">ss</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> v <span class="keyword1"><span class="command">unfolding</span></span> ss2<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
      <span class="keyword1"><span class="command">using</span></span> find_first_le nth_find_first <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">from</span></span> ss2<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>map <span class="main">(</span><span class="keyword1">(*<span class="hidden">⇩</span><sub>v</sub>)</span> <span class="free">A</span><span class="main">)</span> <span class="skolem">ss</span><span class="main">)</span><span class="main">⊆</span> carrier_vec <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ** ss2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> lincomb_as_lincomb_list_distinct<span class="main">[</span><span class="operator">OF</span> this distinct<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span>
      <span class="quoted"><span class="quoted">"lincomb_list
     <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="skolem">a</span> <span class="main">(</span>map <span class="main">(</span><span class="keyword1">(*<span class="hidden">⇩</span><sub>v</sub>)</span> <span class="free">A</span><span class="main">)</span> <span class="skolem">ss</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>  <span class="main">(</span>map <span class="main">(</span><span class="keyword1">(*<span class="hidden">⇩</span><sub>v</sub>)</span> <span class="free">A</span><span class="main">)</span> <span class="skolem">ss</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">0<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">n</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> a ss2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> indpt<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> v i <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">from</span></span> rank_ge_card_indpt<span class="main">[</span><span class="operator">OF</span> 2 4 5<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span><span class="keyword1">(*<span class="hidden">⇩</span><sub>v</sub>)</span> <span class="free">A</span> <span class="main">`</span> <span class="skolem">S</span><span class="main">)</span> <span class="main">≤</span> rank <span class="main">(</span><span class="free">A</span> <span class="main">*</span> <span class="free">A</span><span class="keyword1"><span class="hidden">⇧</span><sup>H</sup></span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> rankeq 3 <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="More_Matrix-conjugate_transpose_rank_le"><span class="command">lemma</span></span> conjugate_transpose_rank_le<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">∈</span> carrier_mat <span class="free">n</span> <span class="free">nc</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"vec_space.rank <span class="free">nc</span> <span class="main">(</span><span class="free">A</span><span class="keyword1"><span class="hidden">⇧</span><sup>H</sup></span><span class="main">)</span> <span class="main">≤</span> rank <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms carrier_matD<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> carrier_mat_triv dim_row_conjugate dual_order.trans index_transpose_mat<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> rank_mat_mul_right transpose_rank_mul_conjugate_transpose<span class="main">)</span>

<span class="keyword1" id="More_Matrix-conjugate_finsum"><span class="command">lemma</span></span> conjugate_finsum<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> f<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">:</span> <span class="free">U</span> <span class="main">→</span> carrier_vec <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"conjugate <span class="main">(</span>finsum V <span class="free">f</span> <span class="free">U</span><span class="main">)</span> <span class="main">=</span> finsum V <span class="main">(</span>conjugate <span class="main">∘</span> <span class="free">f</span><span class="main">)</span> <span class="free">U</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> f
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">U</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> infinite_finite_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>infinite <span class="skolem">A</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> empty
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>insert <span class="skolem">u</span> <span class="skolem">U</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> f<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">:</span> <span class="skolem">U</span> <span class="main">→</span> carrier_vec <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="skolem">u</span> <span class="main">:</span> carrier_vec <span class="free">n</span>"</span></span>  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> cf<span class="main">:</span> <span class="quoted"><span class="quoted">"conjugate <span class="main">∘</span> <span class="free">f</span> <span class="main">:</span> <span class="skolem">U</span> <span class="main">→</span> carrier_vec <span class="free">n</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span>conjugate <span class="main">∘</span> <span class="free">f</span><span class="main">)</span> <span class="skolem">u</span> <span class="main">:</span> carrier_vec <span class="free">n</span>"</span></span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Pi_iff<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> f<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> finsum_insert<span class="main">[</span><span class="operator">OF</span> insert<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> insert<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> f<span class="main">]</span>
    <span class="keyword1"><span class="command">unfolding</span></span> finsum_insert<span class="main">[</span><span class="operator">OF</span> insert<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> insert<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> cf <span class="main">]</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> conjugate_add_vec<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">n</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> f<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">using</span></span> M.finsum_closed f<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> comp_def f<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> insert.hyps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="More_Matrix-rank_conjugate_le"><span class="command">lemma</span></span> rank_conjugate_le<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> A<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">∈</span> carrier_mat <span class="free">n</span> <span class="free">d</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"rank <span class="main">(</span>conjugate <span class="main">(</span><span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> rank <span class="free">A</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="comment1">(* S is a maximal linearly independent set of (conjugate A) *)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?P</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">T</span><span class="main">.</span> <span class="bound">T</span> <span class="main">⊆</span> set <span class="main">(</span>cols <span class="main">(</span>conjugate <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> lin_indpt <span class="bound">T</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">A</span><span class="main">.</span> <span class="var">?P</span> <span class="bound">A</span> <span class="main">⟹</span> finite <span class="bound">A</span> <span class="main">∧</span> card <span class="bound">A</span> <span class="main">≤</span> <span class="free">d</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> List.finite_set assms card_length card_mono carrier_matD<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> cols_length dim_col_conjugate dual_order.trans rev_finite_subset<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> **<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> finite_lin_indpt2<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> maximal_exists<span class="main">[</span><span class="operator">OF</span> *<span class="main">]</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">S</span></span> <span class="keyword2"><span class="keyword">where</span></span> S<span class="main">:</span> <span class="quoted"><span class="quoted">"maximal <span class="skolem">S</span> <span class="var">?P</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> **
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> s_hyp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">S</span> <span class="main">⊆</span> set <span class="main">(</span>cols <span class="main">(</span>conjugate <span class="free">A</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"lin_indpt <span class="skolem">S</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> S <span class="keyword1"><span class="command">unfolding</span></span> maximal_def
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> S maximal_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> rank_card_indpt<span class="main">[</span><span class="operator">OF</span> _ S<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">d</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> rankeq<span class="main">:</span> <span class="quoted"><span class="quoted">"rank <span class="main">(</span>conjugate <span class="free">A</span><span class="main">)</span> <span class="main">=</span> card <span class="skolem">S</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
  <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span><span class="quoted"><span class="quoted">"conjugate <span class="main">`</span> <span class="skolem">S</span> <span class="main">⊆</span> set <span class="main">(</span>cols <span class="free">A</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> S <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> cols_conjugate conjugate_id image_eqI in_mono list.set_map s_hyp<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"lin_indpt <span class="main">(</span>conjugate <span class="main">`</span> <span class="skolem">S</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lin_dep_def<span class="main">)</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">T</span> <span class="skolem">c</span> <span class="skolem">v</span>
    <span class="keyword3"><span class="command">assume</span></span> T<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">T</span> <span class="main">⊆</span> conjugate <span class="main">`</span> <span class="skolem">S</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="skolem">T</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      lc<span class="main">:</span><span class="quoted"><span class="quoted">"lincomb <span class="skolem">c</span> <span class="skolem">T</span> <span class="main">=</span> <span class="keyword1">0<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">n</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∈</span> <span class="skolem">T</span>"</span></span>  <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="skolem">v</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?T</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"conjugate <span class="main">`</span> <span class="skolem">T</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?c</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"conjugate <span class="main">∘</span> <span class="skolem">c</span> <span class="main">∘</span> conjugate"</span></span>
    <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="var">?T</span>"</span></span>  <span class="keyword1"><span class="command">using</span></span> T <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?T</span> <span class="main">⊆</span> <span class="skolem">S</span>"</span></span>  <span class="keyword1"><span class="command">using</span></span> T <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?c</span> <span class="main">∈</span> <span class="var">?T</span> <span class="main">→</span> UNIV"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"lincomb <span class="var">?c</span> <span class="var">?T</span> <span class="main">=</span> <span class="main">(</span><span class="main">⨁</span><span class="hidden">⇘</span><sub>V</sub><span class="hidden">⇙</span><span class="bound">x</span><span class="main">∈</span><span class="skolem">T</span><span class="main">.</span> conjugate <span class="main">(</span><span class="skolem">c</span> <span class="bound">x</span><span class="main">)</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> conjugate <span class="bound">x</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> lincomb_def
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> finsum_reindex<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted">"2"</span> carrier_vec_conjugate assms carrier_matD<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> cols_dim image_eqI s_hyp<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> subsetD<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> conjugate_cancel_iff inj_onI<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="main">⨁</span><span class="hidden">⇘</span><sub>V</sub><span class="hidden">⇙</span><span class="bound">x</span><span class="main">∈</span><span class="skolem">T</span><span class="main">.</span> conjugate <span class="main">(</span><span class="skolem">c</span> <span class="bound">x</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> "</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> conjugate_smult_vec<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> conjugate <span class="main">(</span><span class="main">⨁</span><span class="hidden">⇘</span><sub>V</sub><span class="hidden">⇙</span><span class="bound">x</span><span class="main">∈</span><span class="skolem">T</span><span class="main">.</span> <span class="main">(</span><span class="skolem">c</span> <span class="bound">x</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> conjugate_finsum<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">λ</span></span><span class="bound"><span class="bound">x</span></span><span class="main"><span class="main">.</span></span><span class="main"><span class="main">(</span></span><span class="skolem"><span class="skolem">c</span></span> <span class="bound"><span class="bound">x</span></span> <span class="keyword1"><span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span></span> <span class="bound"><span class="bound">x</span></span><span class="main"><span class="main">)</span></span>"</span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">T</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>o_def<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> Matrix.carrier_vec_conjugate Pi_I' T<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms carrier_matD<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> cols_dim dim_row_conjugate imageE s_hyp<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> smult_carrier_vec subset_eq<span class="main">)</span> 
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> conjugate <span class="main">(</span>lincomb <span class="skolem">c</span> <span class="skolem">T</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> lincomb_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"lincomb <span class="var">?c</span> <span class="var">?T</span> <span class="main">=</span> conjugate <span class="main">(</span>lincomb <span class="skolem">c</span> <span class="skolem">T</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> 4<span class="main">:</span><span class="quoted"><span class="quoted">"lincomb <span class="var">?c</span> <span class="var">?T</span> <span class="main">=</span> <span class="keyword1">0<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> lc <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> not_lindepD<span class="main">[</span><span class="operator">OF</span> s_hyp<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> 1 2 3 4<span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"conjugate <span class="main">∘</span> <span class="skolem">c</span> <span class="main">∘</span> conjugate <span class="main">∈</span> conjugate <span class="main">`</span> <span class="skolem">T</span> <span class="main">→</span> <span class="main">{</span><span class="main">0</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="skolem">v</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Pi_iff <span class="quoted"><span class="quoted">‹<span class="skolem">v</span> <span class="main">∈</span> <span class="skolem">T</span>›</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">c</span> <span class="skolem">v</span> <span class="main">≠</span> <span class="main">0</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">from</span></span> rank_ge_card_indpt<span class="main">[</span><span class="operator">OF</span> A 1 2<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span><span class="quoted"><span class="quoted">"card <span class="main">(</span>conjugate <span class="main">`</span> <span class="skolem">S</span><span class="main">)</span> <span class="main">≤</span> rank <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">have</span></span> 4<span class="main">:</span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>conjugate <span class="main">`</span> <span class="skolem">S</span><span class="main">)</span> <span class="main">=</span> card <span class="skolem">S</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> card_image<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> conjugate_cancel_iff inj_onI<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> rankeq 3 4 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="More_Matrix-rank_conjugate"><span class="command">lemma</span></span> rank_conjugate<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">∈</span> carrier_mat <span class="free">n</span> <span class="free">d</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"rank <span class="main">(</span>conjugate <span class="free">A</span><span class="main">)</span> <span class="main">=</span> rank <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span>  rank_conjugate_le
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> carrier_vec_conjugate assms conjugate_id dual_order.antisym<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* exit the context *)</span>

<span class="keyword1" id="More_Matrix-conjugate_transpose_rank"><span class="command">lemma</span></span> conjugate_transpose_rank<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span><span class="main">{</span>conjugatable_ordered_field<span class="main">}</span> mat"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"vec_space.rank <span class="main">(</span>dim_row <span class="free">A</span><span class="main">)</span> <span class="free">A</span> <span class="main">=</span> vec_space.rank <span class="main">(</span>dim_col <span class="free">A</span><span class="main">)</span> <span class="main">(</span><span class="free">A</span><span class="keyword1"><span class="hidden">⇧</span><sup>H</sup></span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span>  conjugatable_vec_space.conjugate_transpose_rank_le
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> Matrix.transpose_transpose carrier_matI conjugate_id dim_col_conjugate dual_order.antisym index_transpose_mat<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> transpose_conjugate<span class="main">)</span>

<span class="keyword1" id="More_Matrix-transpose_rank"><span class="command">lemma</span></span> transpose_rank<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span><span class="main">{</span>conjugatable_ordered_field<span class="main">}</span> mat"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"vec_space.rank <span class="main">(</span>dim_row <span class="free">A</span><span class="main">)</span> <span class="free">A</span> <span class="main">=</span> vec_space.rank <span class="main">(</span>dim_col <span class="free">A</span><span class="main">)</span> <span class="main">(</span><span class="free">A</span><span class="keyword1"><span class="hidden">⇧</span><sup>T</sup></span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> carrier_mat_triv conjugatable_vec_space.rank_conjugate conjugate_transpose_rank index_transpose_mat<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1" id="More_Matrix-rank_mat_mul_left"><span class="command">lemma</span></span> rank_mat_mul_left<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span><span class="main">{</span>conjugatable_ordered_field<span class="main">}</span> mat"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">∈</span> carrier_mat <span class="free">n</span> <span class="free">d</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">B</span> <span class="main">∈</span> carrier_mat <span class="free">d</span> <span class="free">nc</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"vec_space.rank <span class="free">n</span> <span class="main">(</span><span class="free">A</span> <span class="main">*</span> <span class="free">B</span><span class="main">)</span> <span class="main">≤</span> vec_space.rank <span class="free">d</span> <span class="free">B</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> Matrix.transpose_transpose assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> carrier_matD<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> carrier_matD<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> carrier_mat_triv conjugatable_vec_space.rank_conjugate conjugate_transpose_rank index_mult_mat<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> index_transpose_mat<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> transpose_mult vec_space.rank_mat_mul_right<span class="main">)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">"Results on Invertibility"</span></span>

<span class="comment1">(* Extract specific columns of a matrix  *)</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">take_cols</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> mat <span class="main">⇒</span> nat list <span class="main">⇒</span> <span class="tfree">'a</span> mat"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">take_cols</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">inds</span></span></span> <span class="main">=</span> mat_of_cols <span class="main">(</span>dim_row <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span> <span class="main">(</span>map <span class="main">(</span><span class="main">(!)</span> <span class="main">(</span>cols <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>filter <span class="main">(</span><span class="main">(&gt;)</span> <span class="main">(</span>dim_col <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">inds</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">take_cols_var</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> mat <span class="main">⇒</span> nat list <span class="main">⇒</span> <span class="tfree">'a</span> mat"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">take_cols_var</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">inds</span></span></span> <span class="main">=</span> mat_of_cols <span class="main">(</span>dim_row <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span> <span class="main">(</span>map <span class="main">(</span><span class="main">(!)</span> <span class="main">(</span>cols <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">inds</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">take_rows</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> mat <span class="main">⇒</span> nat list <span class="main">⇒</span> <span class="tfree">'a</span> mat"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">take_rows</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">inds</span></span></span> <span class="main">=</span> mat_of_rows <span class="main">(</span>dim_col <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span> <span class="main">(</span>map <span class="main">(</span><span class="main">(!)</span> <span class="main">(</span>rows <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>filter <span class="main">(</span><span class="main">(&gt;)</span> <span class="main">(</span>dim_row <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">inds</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="More_Matrix-cong1"><span class="command">lemma</span></span> cong1<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> <span class="free">y</span> <span class="main">⟹</span>  mat_of_cols <span class="free">n</span> <span class="free">x</span> <span class="main">=</span> mat_of_cols <span class="free">n</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="More_Matrix-nth_filter"><span class="command">lemma</span></span> nth_filter<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">&lt;</span> length <span class="main">(</span>filter <span class="free">P</span> <span class="free">ls</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span>  <span class="main">(</span><span class="main">(</span>filter <span class="free">P</span> <span class="free">ls</span><span class="main">)</span> <span class="main">!</span> <span class="free">j</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms list_ball_nth<span class="main">)</span>

<span class="keyword1" id="More_Matrix-take_cols_mat_mul"><span class="command">lemma</span></span> take_cols_mat_mul<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">∈</span> carrier_mat <span class="free">nr</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">B</span> <span class="main">∈</span> carrier_mat <span class="free">n</span> <span class="free">nc</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">*</span> take_cols <span class="free">B</span> <span class="free">inds</span> <span class="main">=</span> take_cols <span class="main">(</span><span class="free">A</span> <span class="main">*</span> <span class="free">B</span><span class="main">)</span> <span class="free">inds</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">j</span><span class="main">.</span> <span class="bound">j</span> <span class="main">&lt;</span> length <span class="main">(</span>map <span class="main">(</span><span class="main">(!)</span> <span class="main">(</span>cols <span class="free">B</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>filter <span class="main">(</span><span class="main">(&gt;)</span> <span class="free">nc</span><span class="main">)</span> <span class="free">inds</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span>
      <span class="main">(</span>map <span class="main">(</span><span class="main">(!)</span> <span class="main">(</span>cols <span class="free">B</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>filter <span class="main">(</span><span class="main">(&gt;)</span> <span class="free">nc</span><span class="main">)</span> <span class="free">inds</span><span class="main">)</span><span class="main">)</span> <span class="main">!</span> <span class="bound">j</span> <span class="main">∈</span> carrier_vec <span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> cols_nth<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> nth_filter <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> mul_mat_of_cols<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> this<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">*</span>  take_cols <span class="free">B</span> <span class="free">inds</span> <span class="main">=</span> mat_of_cols <span class="free">nr</span> <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">A</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>v</sub></span> cols <span class="free">B</span> <span class="main">!</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span>filter <span class="main">(</span><span class="main">(&gt;)</span> <span class="main">(</span>dim_col <span class="free">B</span><span class="main">)</span><span class="main">)</span> <span class="free">inds</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> take_cols_def <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> o_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> take_cols <span class="main">(</span><span class="free">A</span> <span class="main">*</span> <span class="free">B</span><span class="main">)</span> <span class="free">inds</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> take_cols_def <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> cong1<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mult_mat_vec_def<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="More_Matrix-take_cols_carrier_mat"><span class="command">lemma</span></span> take_cols_carrier_mat<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">∈</span> carrier_mat <span class="free">nr</span> <span class="free">nc</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">n</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"take_cols <span class="free">A</span> <span class="free">inds</span> <span class="main">∈</span> carrier_mat <span class="free">nr</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> take_cols_def
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1" id="More_Matrix-take_cols_carrier_mat_strict"><span class="command">lemma</span></span> take_cols_carrier_mat_strict<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">∈</span> carrier_mat <span class="free">nr</span> <span class="free">nc</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∈</span> set <span class="free">inds</span> <span class="main">⟹</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="free">nc</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"take_cols <span class="free">A</span> <span class="free">inds</span> <span class="main">∈</span> carrier_mat <span class="free">nr</span> <span class="main">(</span>length <span class="free">inds</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> take_cols_def
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="More_Matrix-gauss_jordan_take_cols"><span class="command">lemma</span></span> gauss_jordan_take_cols<span class="main">:</span>  
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"gauss_jordan <span class="free">A</span> <span class="main">(</span>take_cols <span class="free">A</span> <span class="free">inds</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">C</span><span class="main">,</span><span class="free">D</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">D</span> <span class="main">=</span> take_cols <span class="free">C</span> <span class="free">inds</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">nr</span></span> <span class="skolem"><span class="skolem">nc</span></span> <span class="keyword2"><span class="keyword">where</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A</span>  <span class="main">∈</span> carrier_mat <span class="skolem">nr</span> <span class="skolem">nc</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> take_cols_carrier_mat<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword">where</span></span> B<span class="main">:</span> <span class="quoted"><span class="quoted">"take_cols <span class="free">A</span> <span class="free">inds</span> <span class="main">∈</span> carrier_mat <span class="skolem">nr</span> <span class="skolem">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> gauss_jordan_transform<span class="main">[</span><span class="operator">OF</span> A B assms<span class="main">,</span> <span class="operator">of</span> <span class="quoted">undefined</span><span class="main">]</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">P</span></span> <span class="keyword2"><span class="keyword">where</span></span> PP<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">P</span><span class="main">∈</span>Units <span class="main">(</span>ring_mat <span class="keyword1">TYPE</span><span class="main">(</span><span class="tfree">'a</span><span class="main">)</span> <span class="skolem">nr</span> undefined<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    CD<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">C</span> <span class="main">=</span> <span class="skolem">P</span> <span class="main">*</span> <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">D</span> <span class="main">=</span> <span class="skolem">P</span> <span class="main">*</span> take_cols <span class="free">A</span> <span class="free">inds</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> P<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main">∈</span> carrier_mat <span class="skolem">nr</span> <span class="skolem">nr</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> Units_def PP mem_Collect_eq partial_object.select_convs<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> ring_mat_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> take_cols_mat_mul<span class="main">[</span><span class="operator">OF</span> P A<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main">*</span> take_cols <span class="free">A</span> <span class="free">inds</span> <span class="main">=</span> take_cols <span class="main">(</span><span class="skolem">P</span> <span class="main">*</span> <span class="free">A</span><span class="main">)</span> <span class="free">inds</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> CD <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>  
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="More_Matrix-dim_col_take_cols"><span class="command">lemma</span></span> dim_col_take_cols<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">j</span><span class="main">.</span> <span class="bound">j</span> <span class="main">∈</span> set <span class="free">inds</span> <span class="main">⟹</span> <span class="bound">j</span> <span class="main">&lt;</span> dim_col <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"dim_col <span class="main">(</span>take_cols <span class="free">A</span> <span class="free">inds</span><span class="main">)</span> <span class="main">=</span> length <span class="free">inds</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> take_cols_def
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="More_Matrix-dim_col_take_rows"><span class="command">lemma</span></span> dim_col_take_rows<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"dim_col <span class="main">(</span>take_rows <span class="free">A</span> <span class="free">inds</span><span class="main">)</span> <span class="main">=</span> dim_col <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> take_rows_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="More_Matrix-cols_take_cols_subset"><span class="command">lemma</span></span> cols_take_cols_subset<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>cols <span class="main">(</span>take_cols <span class="free">A</span> <span class="free">inds</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> set <span class="main">(</span>cols <span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> take_cols_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> cols_mat_of_cols<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">using</span></span> in_set_conv_nth <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1" id="More_Matrix-dim_row_take_cols"><span class="command">lemma</span></span> dim_row_take_cols<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"dim_row <span class="main">(</span>take_cols <span class="free">A</span> <span class="free">ls</span><span class="main">)</span> <span class="main">=</span> dim_row <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> take_cols_def<span class="main">)</span>

<span class="keyword1" id="More_Matrix-dim_row_append_rows"><span class="command">lemma</span></span> dim_row_append_rows<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"dim_row <span class="main">(</span><span class="free">A</span> <span class="keyword1">@<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">B</span><span class="main">)</span> <span class="main">=</span> dim_row <span class="free">A</span> <span class="main">+</span> dim_row <span class="free">B</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> append_rows_def<span class="main">)</span>

<span class="keyword1" id="More_Matrix-rows_inj"><span class="command">lemma</span></span> rows_inj<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"dim_col <span class="free">A</span> <span class="main">=</span> dim_col <span class="free">B</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"rows <span class="free">A</span> <span class="main">=</span> rows <span class="free">B</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">=</span> <span class="free">B</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> mat_eq_iff
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> length_rows<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> mat_of_rows_rows<span class="main">)</span>

<span class="keyword1" id="More_Matrix-append_rows_index"><span class="command">lemma</span></span> append_rows_index<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"dim_col <span class="free">A</span> <span class="main">=</span> dim_col <span class="free">B</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> dim_row <span class="free">A</span> <span class="main">+</span> dim_row <span class="free">B</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">&lt;</span> dim_col <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">A</span> <span class="keyword1">@<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">B</span><span class="main">)</span> <span class="main">$$</span> <span class="main">(</span><span class="free">i</span><span class="main">,</span><span class="free">j</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">i</span> <span class="main">&lt;</span> dim_row <span class="free">A</span> <span class="keyword1">then</span> <span class="free">A</span> <span class="main">$$</span> <span class="main">(</span><span class="free">i</span><span class="main">,</span><span class="free">j</span><span class="main">)</span> <span class="keyword1">else</span> <span class="free">B</span> <span class="main">$$</span> <span class="main">(</span><span class="free">i</span><span class="main">-</span>dim_row <span class="free">A</span><span class="main">,</span><span class="free">j</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> append_rows_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> index_mat_four_block<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="More_Matrix-row_append_rows"><span class="command">lemma</span></span> row_append_rows<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"dim_col <span class="free">A</span> <span class="main">=</span> dim_col <span class="free">B</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> dim_row <span class="free">A</span> <span class="main">+</span> dim_row <span class="free">B</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"row <span class="main">(</span><span class="free">A</span> <span class="keyword1">@<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">B</span><span class="main">)</span> <span class="free">i</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">i</span> <span class="main">&lt;</span> dim_row <span class="free">A</span> <span class="keyword1">then</span> row <span class="free">A</span> <span class="free">i</span> <span class="keyword1">else</span> row <span class="free">B</span> <span class="main">(</span><span class="free">i</span><span class="main">-</span>dim_row <span class="free">A</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> vec_eq_iff
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> append_rows_def<span class="main">)</span>

<span class="keyword1" id="More_Matrix-append_rows_mat_mul"><span class="command">lemma</span></span> append_rows_mat_mul<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"dim_col <span class="free">A</span> <span class="main">=</span> dim_col <span class="free">B</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">A</span> <span class="keyword1">@<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">B</span><span class="main">)</span> <span class="main">*</span> <span class="free">C</span> <span class="main">=</span> <span class="free">A</span> <span class="main">*</span> <span class="free">C</span> <span class="keyword1">@<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">B</span> <span class="main">*</span> <span class="free">C</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> mat_eq_iff
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> append_rows_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> index_mult_mat<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> append_rows_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span>  append_rows_index<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> append_rows_def<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> add.right_neutral append_rows_def assms index_mat_four_block<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> index_mult_mat<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> index_mult_mat<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> index_zero_mat<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> row_append_rows trans_less_add1<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> add_cancel_right_right add_diff_inverse_nat append_rows_def assms index_mat_four_block<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> index_mult_mat<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> index_mult_mat<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> index_zero_mat<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> nat_add_left_cancel_less row_append_rows<span class="main">)</span>

<span class="keyword1" id="More_Matrix-cardlt"><span class="command">lemma</span></span> cardlt<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"card  <span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="main">(</span><span class="free">n</span><span class="main">::</span>nat<span class="main">)</span><span class="main">}</span> <span class="main">≤</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="More_Matrix-row_echelon_form_zero_rows"><span class="command">lemma</span></span> row_echelon_form_zero_rows<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> row_ech<span class="main">:</span> <span class="quoted"><span class="quoted">"row_echelon_form <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> dim_asm<span class="main">:</span> <span class="quoted"><span class="quoted">"dim_col <span class="free">A</span> <span class="main">≥</span> dim_row <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"take_rows <span class="free">A</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="main">(</span>pivot_positions <span class="free">A</span><span class="main">)</span><span class="main">]</span> <span class="keyword1">@<span class="hidden">⇩</span><sub>r</sub></span>  <span class="keyword1">0<span class="hidden">⇩</span><sub>m</sub></span> <span class="main">(</span>dim_row <span class="free">A</span> <span class="main">-</span> length <span class="main">(</span>pivot_positions <span class="free">A</span><span class="main">)</span><span class="main">)</span>  <span class="main">(</span>dim_col <span class="free">A</span><span class="main">)</span> <span class="main">=</span> <span class="free">A</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> ex_pivot_fun<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">f</span><span class="main">.</span> pivot_fun <span class="free">A</span> <span class="bound">f</span> <span class="main">(</span>dim_col <span class="free">A</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> row_ech <span class="keyword1"><span class="command">unfolding</span></span> row_echelon_form_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> len_help<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>pivot_positions <span class="free">A</span><span class="main">)</span> <span class="main">=</span> card <span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> dim_row <span class="free">A</span> <span class="main">∧</span> row <span class="free">A</span> <span class="bound">i</span> <span class="main">≠</span> <span class="keyword1">0<span class="hidden">⇩</span><sub>v</sub></span> <span class="main">(</span>dim_col <span class="free">A</span><span class="main">)</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ex_pivot_fun pivot_positions<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> A <span class="main"><span class="main"><span class="main"><span class="main"><span class="main">=</span></span></span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="free"><span class="free"><span class="free"><span class="free">A</span></span></span></span>"</span></span></span></span></span><span class="main">,</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> nr <span class="main"><span class="main"><span class="main"><span class="main"><span class="main">=</span></span></span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"dim_row <span class="free"><span class="free"><span class="free"><span class="free">A</span></span></span></span>"</span></span></span></span></span><span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> nc <span class="main"><span class="main"><span class="main"><span class="main"><span class="main">=</span></span></span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"dim_col <span class="free"><span class="free"><span class="free"><span class="free">A</span></span></span></span>"</span></span></span></span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> len_help2<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>pivot_positions <span class="free">A</span><span class="main">)</span> <span class="main">≤</span> dim_row <span class="free">A</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> card_mono cardlt finite_Collect_less_nat le_trans mem_Collect_eq subsetI<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> fileq<span class="main">:</span> <span class="quoted"><span class="quoted">"filter <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">&lt;</span> dim_row <span class="free">A</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span> length <span class="main">(</span>pivot_positions <span class="free">A</span><span class="main">)</span><span class="main">]</span> <span class="main">=</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="main">(</span>pivot_positions <span class="free">A</span><span class="main">)</span><span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> filter_True<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> len_help2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">n</span><span class="main">.</span> card <span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="bound">n</span>  <span class="main">∧</span> row <span class="free">A</span> <span class="bound">i</span> <span class="main">≠</span> <span class="keyword1">0<span class="hidden">⇩</span><sub>v</sub></span> <span class="main">(</span>dim_col <span class="free">A</span><span class="main">)</span><span class="main">}</span> <span class="main">≤</span> <span class="bound">n</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">clarsimp</span> 
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">n</span>
    <span class="keyword1"><span class="command">have</span></span> h<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="skolem">n</span> <span class="main">∧</span> row <span class="free">A</span> <span class="bound">i</span> <span class="main">≠</span> <span class="keyword1">0<span class="hidden">⇩</span><sub>v</sub></span> <span class="main">(</span>dim_col <span class="free">A</span><span class="main">)</span><span class="main">}</span> <span class="main">⟶</span> <span class="bound">x</span><span class="main">∈</span><span class="main">{..&lt;</span><span class="skolem">n</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> h1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="skolem">n</span>  <span class="main">∧</span> row <span class="free">A</span> <span class="bound">i</span> <span class="main">≠</span> <span class="keyword1">0<span class="hidden">⇩</span><sub>v</sub></span> <span class="main">(</span>dim_col <span class="free">A</span><span class="main">)</span><span class="main">}</span> <span class="main">⊆</span> <span class="main">{..&lt;</span><span class="skolem">n</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> h2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>card <span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="skolem">n</span>  <span class="main">∧</span> row <span class="free">A</span> <span class="bound">i</span> <span class="main">≠</span> <span class="keyword1">0<span class="hidden">⇩</span><sub>v</sub></span> <span class="main">(</span>dim_col <span class="free">A</span><span class="main">)</span><span class="main">}</span><span class="main">::</span>nat<span class="main">)</span> <span class="main">≤</span> <span class="main">(</span>card <span class="main">{..&lt;</span><span class="skolem">n</span><span class="main">}</span><span class="main">::</span>nat<span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> card_mono <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>card <span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="skolem">n</span> <span class="main">∧</span> row <span class="free">A</span> <span class="bound">i</span> <span class="main">≠</span> <span class="keyword1">0<span class="hidden">⇩</span><sub>v</sub></span> <span class="main">(</span>dim_col <span class="free">A</span><span class="main">)</span><span class="main">}</span><span class="main">::</span>nat<span class="main">)</span> <span class="main">≤</span> <span class="main">(</span><span class="skolem">n</span><span class="main">::</span>nat<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> h2 card_lessThan<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">n</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> pivot_len<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>pivot_positions <span class="free">A</span><span class="main">)</span> <span class="main">≤</span> dim_row <span class="free">A</span> "</span></span>  <span class="keyword1"><span class="command">using</span></span> len_help
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> alt_char<span class="main">:</span> <span class="quoted"><span class="quoted">"mat_of_rows <span class="main">(</span>dim_col <span class="free">A</span><span class="main">)</span>
         <span class="main">(</span>map <span class="main">(</span><span class="main">(!)</span> <span class="main">(</span>rows <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">&lt;</span> dim_col <span class="free">A</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="main">(</span>pivot_positions <span class="free">A</span><span class="main">)</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
      mat_of_rows <span class="main">(</span>dim_col <span class="free">A</span><span class="main">)</span> <span class="main">(</span>map <span class="main">(</span><span class="main">(!)</span> <span class="main">(</span>rows <span class="free">A</span><span class="main">)</span><span class="main">)</span>  <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="main">(</span>pivot_positions <span class="free">A</span><span class="main">)</span><span class="main">]</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> pivot_len dim_asm
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> h1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> dim_row <span class="free">A</span> <span class="main">⟹</span>
           <span class="bound">j</span> <span class="main">&lt;</span> dim_col <span class="free">A</span> <span class="main">⟹</span>
           <span class="bound">i</span> <span class="main">&lt;</span> dim_row <span class="main">(</span>take_rows <span class="free">A</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="main">(</span>pivot_positions <span class="free">A</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="main">⟹</span>
           take_rows <span class="free">A</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="main">(</span>pivot_positions <span class="free">A</span><span class="main">)</span><span class="main">]</span> <span class="main">$$</span> <span class="main">(</span><span class="bound">i</span><span class="main">,</span> <span class="bound">j</span><span class="main">)</span> <span class="main">=</span> <span class="free">A</span> <span class="main">$$</span> <span class="main">(</span><span class="bound">i</span><span class="main">,</span> <span class="bound">j</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> 
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">j</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> dim_row <span class="free">A</span>"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> j_lt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> dim_col <span class="free">A</span>"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> i_lt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> dim_row <span class="main">(</span>take_rows <span class="free">A</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="main">(</span>pivot_positions <span class="free">A</span><span class="main">)</span><span class="main">]</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">have</span></span> lt<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>pivot_positions <span class="free">A</span><span class="main">)</span> <span class="main">≤</span> dim_row <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> pivot_len <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> h1<span class="main">:</span> <span class="quoted"><span class="quoted">"take_rows <span class="free">A</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="main">(</span>pivot_positions <span class="free">A</span><span class="main">)</span><span class="main">]</span> <span class="main">$$</span> <span class="main">(</span><span class="skolem">i</span><span class="main">,</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>row <span class="main">(</span>take_rows <span class="free">A</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="main">(</span>pivot_positions <span class="free">A</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="skolem">i</span><span class="main">)</span><span class="main">$</span><span class="skolem">j</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> i_lt j_lt<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> h2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>row <span class="main">(</span>take_rows <span class="free">A</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="main">(</span>pivot_positions <span class="free">A</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="skolem">i</span><span class="main">)</span><span class="main">$</span><span class="skolem">j</span> <span class="main">=</span> <span class="main">(</span>row <span class="free">A</span> <span class="skolem">i</span><span class="main">)</span><span class="main">$</span><span class="skolem">j</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> lt alt_char i_lt <span class="keyword1"><span class="command">unfolding</span></span> take_rows_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"take_rows <span class="free">A</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="main">(</span>pivot_positions <span class="free">A</span><span class="main">)</span><span class="main">]</span> <span class="main">$$</span> <span class="main">(</span><span class="skolem">i</span><span class="main">,</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">=</span> <span class="free">A</span> <span class="main">$$</span> <span class="main">(</span><span class="skolem">i</span><span class="main">,</span> <span class="skolem">j</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> h1 h2
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">&lt;</span> dim_row <span class="free">A</span>›</span></span> j_lt<span class="main">)</span> 
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?nc</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"dim_col <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?nr</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"dim_row <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> h2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> dim_row <span class="free">A</span> <span class="main">⟹</span>
           <span class="bound">j</span> <span class="main">&lt;</span> dim_col <span class="free">A</span> <span class="main">⟹</span>
           <span class="main">¬</span> <span class="bound">i</span> <span class="main">&lt;</span> dim_row <span class="main">(</span>take_rows <span class="free">A</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="main">(</span>pivot_positions <span class="free">A</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="main">⟹</span>
           <span class="keyword1">0<span class="hidden">⇩</span><sub>m</sub></span> <span class="main">(</span>dim_row <span class="free">A</span> <span class="main">-</span> length <span class="main">(</span>pivot_positions <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>dim_col <span class="free">A</span><span class="main">)</span> <span class="main">$$</span>
           <span class="main">(</span><span class="bound">i</span> <span class="main">-</span> dim_row <span class="main">(</span>take_rows <span class="free">A</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="main">(</span>pivot_positions <span class="free">A</span><span class="main">)</span><span class="main">]</span><span class="main">)</span><span class="main">,</span> <span class="bound">j</span><span class="main">)</span> <span class="main">=</span>
           <span class="free">A</span> <span class="main">$$</span> <span class="main">(</span><span class="bound">i</span><span class="main">,</span> <span class="bound">j</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">j</span>
    <span class="keyword3"><span class="command">assume</span></span> lt_i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> dim_row <span class="free">A</span>"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> lt_j<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> dim_col <span class="free">A</span>"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> not_lt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="skolem">i</span> <span class="main">&lt;</span> dim_row <span class="main">(</span>take_rows <span class="free">A</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="main">(</span>pivot_positions <span class="free">A</span><span class="main">)</span><span class="main">]</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?ip</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span><span class="main">+</span><span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> h0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">f</span><span class="main">.</span> pivot_fun <span class="free">A</span> <span class="bound">f</span> <span class="main">(</span>dim_col <span class="free">A</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">f</span> <span class="skolem">i</span> <span class="main">=</span> <span class="var">?nc</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>  
      <span class="keyword1"><span class="command">have</span></span> half1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">f</span><span class="main">.</span> pivot_fun <span class="free">A</span> <span class="bound">f</span> <span class="main">(</span>dim_col <span class="free">A</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> row_echelon_form_def
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">have</span></span> half2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">f</span><span class="main">.</span> pivot_fun <span class="free">A</span> <span class="bound">f</span> <span class="main">(</span>dim_col <span class="free">A</span><span class="main">)</span> <span class="main">⟶</span> <span class="bound">f</span> <span class="skolem">i</span> <span class="main">=</span> <span class="var">?nc</span> "</span></span> 
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">clarsimp</span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">f</span>
        <span class="keyword3"><span class="command">assume</span></span> is_piv<span class="main">:</span> <span class="quoted"><span class="quoted">"pivot_fun <span class="free">A</span> <span class="skolem">f</span> <span class="main">(</span>dim_col <span class="free">A</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">have</span></span> len_pp<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>pivot_positions <span class="free">A</span><span class="main">)</span> <span class="main">=</span> card <span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="var">?nr</span> <span class="main">∧</span> row <span class="free">A</span> <span class="bound">i</span> <span class="main">≠</span> <span class="keyword1">0<span class="hidden">⇩</span><sub>v</sub></span> <span class="var">?nc</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> is_piv pivot_positions<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">A</span></span></span></span></span></span></span></span> <span class="var"><span class="quoted"><span class="var"><span class="quoted"><span class="var"><span class="quoted"><span class="var"><span class="quoted"><span class="var">?nr</span></span></span></span></span></span></span></span></span> <span class="var"><span class="quoted"><span class="var"><span class="quoted"><span class="var"><span class="quoted"><span class="var"><span class="quoted"><span class="var">?nc</span></span></span></span></span></span></span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">f</span></span></span></span></span></span></span></span><span class="main">]</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">have</span></span>  <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">.</span> <span class="main">(</span><span class="bound">i</span> <span class="main">&lt;</span> <span class="var">?nr</span> <span class="main">∧</span> row <span class="free">A</span> <span class="bound">i</span> <span class="main">≠</span> <span class="keyword1">0<span class="hidden">⇩</span><sub>v</sub></span> <span class="var">?nc</span><span class="main">)</span> <span class="main">⟷</span>  <span class="main">(</span><span class="bound">i</span> <span class="main">&lt;</span> <span class="var">?nr</span> <span class="main">∧</span> <span class="skolem">f</span> <span class="bound">i</span> <span class="main">≠</span> <span class="var">?nc</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> is_piv pivot_fun_zero_row_iff<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">A</span></span> <span class="quoted"><span class="skolem">f</span></span> <span class="var"><span class="quoted"><span class="var">?nc</span></span></span> <span class="var"><span class="quoted"><span class="var">?nr</span></span></span><span class="main">]</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> len_pp_var<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>pivot_positions <span class="free">A</span><span class="main">)</span> <span class="main">=</span> card <span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="var">?nr</span> <span class="main">∧</span> <span class="skolem">f</span> <span class="bound">i</span> <span class="main">≠</span> <span class="var">?nc</span><span class="main">}</span>"</span></span> 
          <span class="keyword1"><span class="command">using</span></span> len_pp  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
        <span class="keyword1"><span class="command">have</span></span> allj_hyp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">j</span></span> <span class="main">&lt;</span> <span class="var">?nr</span><span class="main">.</span> <span class="skolem">f</span> <span class="bound">j</span> <span class="main">=</span> <span class="var">?nc</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">(</span>Suc <span class="bound">j</span><span class="main">)</span> <span class="main">&lt;</span> <span class="var">?nr</span> <span class="main">⟶</span> <span class="skolem">f</span> <span class="main">(</span>Suc <span class="bound">j</span><span class="main">)</span> <span class="main">=</span> <span class="var">?nc</span><span class="main">)</span>"</span></span> 
          <span class="keyword1"><span class="command">using</span></span> is_piv <span class="keyword1"><span class="command">unfolding</span></span> pivot_fun_def 
          <span class="keyword1"><span class="command">using</span></span> lt_i
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> le_antisym le_less<span class="main">)</span> 
        <span class="keyword1"><span class="command">have</span></span> if_then_bad<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="skolem">i</span> <span class="main">≠</span> <span class="var">?nc</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∀</span><span class="bound">j</span><span class="main">.</span> <span class="bound">j</span> <span class="main">≤</span> <span class="skolem">i</span> <span class="main">⟶</span> <span class="skolem">f</span> <span class="bound">j</span> <span class="main">≠</span> <span class="var">?nc</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="operator">clarsimp</span> 
          <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">j</span>
          <span class="keyword3"><span class="command">assume</span></span> not_i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="skolem">i</span> <span class="main">≠</span> <span class="var">?nc</span>"</span></span>
          <span class="keyword3"><span class="command">assume</span></span> j_leq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">≤</span> <span class="skolem">i</span>"</span></span>
          <span class="keyword3"><span class="command">assume</span></span> bad_asm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="skolem">j</span> <span class="main">=</span> <span class="var">?nc</span>"</span></span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">k</span><span class="main">.</span> <span class="bound">k</span> <span class="main">≥</span> <span class="skolem">j</span> <span class="main">⟹</span>  <span class="bound">k</span> <span class="main">&lt;</span> <span class="var">?nr</span> <span class="main">⟹</span> <span class="skolem">f</span> <span class="bound">k</span> <span class="main">=</span> <span class="var">?nc</span>"</span></span>
          <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
            <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">k</span> <span class="main">::</span> <span class="quoted">nat</span>
            <span class="keyword3"><span class="command">assume</span></span> a1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">≤</span> <span class="skolem">k</span>"</span></span>
            <span class="keyword3"><span class="command">assume</span></span> a2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">&lt;</span> dim_row <span class="free">A</span>"</span></span>
            <span class="keyword1"><span class="command">have</span></span> f3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">n</span><span class="main">.</span> <span class="main">¬</span> <span class="bound">n</span> <span class="main">&lt;</span> dim_row <span class="free">A</span> <span class="main">∨</span> <span class="skolem">f</span> <span class="bound">n</span> <span class="main">≠</span> <span class="skolem">f</span> <span class="skolem">j</span> <span class="main">∨</span> <span class="main">¬</span> Suc <span class="bound">n</span> <span class="main">&lt;</span> dim_row <span class="free">A</span> <span class="main">∨</span> <span class="skolem">f</span> <span class="main">(</span>Suc <span class="bound">n</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">f</span> <span class="skolem">j</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> allj_hyp bad_asm <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
            <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">nn</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat <span class="main">⇒</span> <span class="main">(</span>nat <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
              f4<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">n</span> <span class="bound">na</span> <span class="bound">p</span> <span class="bound">nb</span> <span class="bound">nc</span><span class="main">.</span> <span class="main">(</span><span class="main">¬</span> <span class="bound">n</span> <span class="main">≤</span> <span class="bound">na</span> <span class="main">∨</span> Suc <span class="bound">n</span> <span class="main">≤</span> Suc <span class="bound">na</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">¬</span> <span class="bound">p</span> <span class="bound">nb</span> <span class="main">∨</span> <span class="main">¬</span> <span class="bound">nc</span> <span class="main">≤</span> <span class="bound">nb</span> <span class="main">∨</span> <span class="main">¬</span> <span class="bound">p</span> <span class="main">(</span><span class="skolem">nn</span> <span class="bound">nc</span> <span class="bound">nb</span> <span class="bound">p</span><span class="main">)</span> <span class="main">∨</span> <span class="bound">p</span> <span class="bound">nc</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">¬</span> <span class="bound">p</span> <span class="bound">nb</span> <span class="main">∨</span> <span class="main">¬</span> <span class="bound">nc</span> <span class="main">≤</span> <span class="bound">nb</span> <span class="main">∨</span> <span class="bound">p</span> <span class="bound">nc</span> <span class="main">∨</span> <span class="bound">p</span> <span class="main">(</span>Suc <span class="main">(</span><span class="skolem">nn</span> <span class="bound">nc</span> <span class="bound">nb</span> <span class="bound">p</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> inc_induct order_refl <span class="keyword1"><span class="command">by</span></span> <span class="operator">moura</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> f5<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">p</span><span class="main">.</span> <span class="main">¬</span> <span class="bound">p</span> <span class="skolem">k</span> <span class="main">∨</span> <span class="bound">p</span> <span class="skolem">j</span> <span class="main">∨</span> <span class="bound">p</span> <span class="main">(</span>Suc <span class="main">(</span><span class="skolem">nn</span> <span class="skolem">j</span> <span class="skolem">k</span> <span class="bound">p</span><span class="main">)</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> a1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
            <span class="keyword1"><span class="command">have</span></span> f6<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">p</span><span class="main">.</span> <span class="main">¬</span> <span class="bound">p</span> <span class="skolem">k</span> <span class="main">∨</span> <span class="main">¬</span> <span class="bound">p</span> <span class="main">(</span><span class="skolem">nn</span> <span class="skolem">j</span> <span class="skolem">k</span> <span class="bound">p</span><span class="main">)</span> <span class="main">∨</span> <span class="bound">p</span> <span class="skolem">j</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> f4 a1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">meson</span>
            <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">nn</span> <span class="skolem">j</span> <span class="skolem">k</span> <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">&lt;</span> dim_row <span class="free">A</span> <span class="main">∧</span> <span class="skolem">f</span> <span class="bound">n</span> <span class="main">≠</span> dim_col <span class="free">A</span><span class="main">)</span> <span class="main">&lt;</span> dim_row <span class="free">A</span> <span class="main">∧</span> <span class="skolem">f</span> <span class="main">(</span><span class="skolem">nn</span> <span class="skolem">j</span> <span class="skolem">k</span> <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">&lt;</span> dim_row <span class="free">A</span> <span class="main">∧</span> <span class="skolem">f</span> <span class="bound">n</span> <span class="main">≠</span> dim_col <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">≠</span> dim_col <span class="free">A</span>"</span></span>
              <span class="keyword1"><span class="command">moreover</span></span>
              <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">nn</span> <span class="skolem">j</span> <span class="skolem">k</span> <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">&lt;</span> dim_row <span class="free">A</span> <span class="main">∧</span> <span class="skolem">f</span> <span class="bound">n</span> <span class="main">≠</span> dim_col <span class="free">A</span><span class="main">)</span> <span class="main">&lt;</span> dim_row <span class="free">A</span> <span class="main">∧</span> <span class="skolem">f</span> <span class="main">(</span><span class="skolem">nn</span> <span class="skolem">j</span> <span class="skolem">k</span> <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">&lt;</span> dim_row <span class="free">A</span> <span class="main">∧</span> <span class="skolem">f</span> <span class="bound">n</span> <span class="main">≠</span> dim_col <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">≠</span> dim_col <span class="free">A</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">¬</span> <span class="skolem">j</span> <span class="main">&lt;</span> dim_row <span class="free">A</span> <span class="main">∨</span> <span class="skolem">f</span> <span class="skolem">j</span> <span class="main">=</span> dim_col <span class="free">A</span><span class="main">)</span>"</span></span>
                <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="skolem">k</span> <span class="main">&lt;</span> dim_row <span class="free">A</span> <span class="main">∨</span> <span class="skolem">f</span> <span class="skolem">k</span> <span class="main">=</span> dim_col <span class="free">A</span>"</span></span>
                  <span class="keyword1"><span class="command">using</span></span> f6
                  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span><span class="main">)</span> <span class="keyword1"><span class="command">}</span></span>
              <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">¬</span> <span class="skolem">j</span> <span class="main">&lt;</span> dim_row <span class="free">A</span> <span class="main">∨</span> <span class="skolem">f</span> <span class="skolem">j</span> <span class="main">=</span> dim_col <span class="free">A</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">¬</span> Suc <span class="main">(</span><span class="skolem">nn</span> <span class="skolem">j</span> <span class="skolem">k</span> <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">&lt;</span> dim_row <span class="free">A</span> <span class="main">∧</span> <span class="skolem">f</span> <span class="bound">n</span> <span class="main">≠</span> dim_col <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">&lt;</span> dim_row <span class="free">A</span> <span class="main">∨</span> <span class="skolem">f</span> <span class="main">(</span>Suc <span class="main">(</span><span class="skolem">nn</span> <span class="skolem">j</span> <span class="skolem">k</span> <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">&lt;</span> dim_row <span class="free">A</span> <span class="main">∧</span> <span class="skolem">f</span> <span class="bound">n</span> <span class="main">≠</span> dim_col <span class="free">A</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> dim_col <span class="free">A</span><span class="main">)</span> <span class="main">∨</span> <span class="main">¬</span> <span class="skolem">k</span> <span class="main">&lt;</span> dim_row <span class="free">A</span> <span class="main">∨</span> <span class="skolem">f</span> <span class="skolem">k</span> <span class="main">=</span> dim_col <span class="free">A</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> bad_asm
                <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> <span class="keyword1"><span class="command">}</span></span>
            <span class="keyword1"><span class="command">moreover</span></span>
            <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">¬</span> <span class="skolem">j</span> <span class="main">&lt;</span> dim_row <span class="free">A</span> <span class="main">∨</span> <span class="skolem">f</span> <span class="skolem">j</span> <span class="main">=</span> dim_col <span class="free">A</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">¬</span> Suc <span class="main">(</span><span class="skolem">nn</span> <span class="skolem">j</span> <span class="skolem">k</span> <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">&lt;</span> dim_row <span class="free">A</span> <span class="main">∧</span> <span class="skolem">f</span> <span class="bound">n</span> <span class="main">≠</span> dim_col <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">&lt;</span> dim_row <span class="free">A</span> <span class="main">∨</span> <span class="skolem">f</span> <span class="main">(</span>Suc <span class="main">(</span><span class="skolem">nn</span> <span class="skolem">j</span> <span class="skolem">k</span> <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">&lt;</span> dim_row <span class="free">A</span> <span class="main">∧</span> <span class="skolem">f</span> <span class="bound">n</span> <span class="main">≠</span> dim_col <span class="free">A</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> dim_col <span class="free">A</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="skolem">k</span> <span class="main">&lt;</span> dim_row <span class="free">A</span> <span class="main">∨</span> <span class="skolem">f</span> <span class="skolem">k</span> <span class="main">=</span> dim_col <span class="free">A</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> f5
              <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
                <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span>Suc <span class="main">(</span><span class="skolem">nn</span> <span class="skolem">j</span> <span class="skolem">k</span> <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">&lt;</span> dim_row <span class="free">A</span> <span class="main">∧</span> <span class="skolem">f</span> <span class="bound">n</span> <span class="main">≠</span> dim_col <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">&lt;</span> dim_row <span class="free">A</span> <span class="main">∧</span> <span class="skolem">f</span> <span class="main">(</span>Suc <span class="main">(</span><span class="skolem">nn</span> <span class="skolem">j</span> <span class="skolem">k</span> <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">&lt;</span> dim_row <span class="free">A</span> <span class="main">∧</span> <span class="skolem">f</span> <span class="bound">n</span> <span class="main">≠</span> dim_col <span class="free">A</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">≠</span> dim_col <span class="free">A</span><span class="main">)</span> <span class="main">∧</span> <span class="main">¬</span> <span class="main">(</span><span class="skolem">j</span> <span class="main">&lt;</span> dim_row <span class="free">A</span> <span class="main">∧</span> <span class="skolem">f</span> <span class="skolem">j</span> <span class="main">≠</span> dim_col <span class="free">A</span><span class="main">)</span>"</span></span>
                  <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main">¬</span> <span class="skolem">j</span> <span class="main">&lt;</span> dim_row <span class="free">A</span> <span class="main">∨</span> <span class="skolem">f</span> <span class="skolem">j</span> <span class="main">=</span> dim_col <span class="free">A</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">¬</span> Suc <span class="main">(</span><span class="skolem">nn</span> <span class="skolem">j</span> <span class="skolem">k</span> <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">&lt;</span> dim_row <span class="free">A</span> <span class="main">∧</span> <span class="skolem">f</span> <span class="bound">n</span> <span class="main">≠</span> dim_col <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">&lt;</span> dim_row <span class="free">A</span> <span class="main">∨</span> <span class="skolem">f</span> <span class="main">(</span>Suc <span class="main">(</span><span class="skolem">nn</span> <span class="skolem">j</span> <span class="skolem">k</span> <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">&lt;</span> dim_row <span class="free">A</span> <span class="main">∧</span> <span class="skolem">f</span> <span class="bound">n</span> <span class="main">≠</span> dim_col <span class="free">A</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> dim_col <span class="free">A</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
                <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="skolem">k</span> <span class="main">&lt;</span> dim_row <span class="free">A</span> <span class="main">∧</span> <span class="skolem">f</span> <span class="skolem">k</span> <span class="main">≠</span> dim_col <span class="free">A</span><span class="main">)</span>"</span></span>
                  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> a2 bad_asm f5 le_less<span class="main">)</span>
                <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
                  <span class="keyword1"><span class="command">by</span></span> <span class="operator">meson</span>
              <span class="keyword1"><span class="command">qed</span></span> <span class="keyword1"><span class="command">}</span></span>
            <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="skolem">k</span> <span class="main">=</span> dim_col <span class="free">A</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> f3 a2 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>lifting<span class="main"><span class="main">)</span></span> Suc_lessD bad_asm<span class="main">)</span>
          <span class="keyword1"><span class="command">qed</span></span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"False"</span></span> <span class="keyword1"><span class="command">using</span></span> lt_i not_i
            <span class="keyword1"><span class="command">using</span></span> j_leq <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="skolem">i</span> <span class="main">≠</span> <span class="var">?nc</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="var">?ip</span><span class="main">}</span> <span class="main">⊆</span> <span class="main">{</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">&lt;</span> <span class="var">?nr</span> <span class="main">∧</span> <span class="skolem">f</span> <span class="bound">y</span> <span class="main">≠</span> dim_col <span class="free">A</span><span class="main">}</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
          <span class="keyword1"><span class="command">have</span></span> h1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="skolem">i</span> <span class="main">≠</span> dim_col <span class="free">A</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">j</span></span><span class="main">≤</span><span class="skolem">i</span><span class="main">.</span> <span class="bound">j</span> <span class="main">&lt;</span> <span class="var">?nr</span> <span class="main">∧</span> <span class="skolem">f</span> <span class="bound">j</span> <span class="main">≠</span> dim_col <span class="free">A</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> if_then_bad lt_i <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> gteq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="skolem">i</span> <span class="main">≠</span> <span class="var">?nc</span> <span class="main">⟶</span> <span class="main">(</span>card <span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="var">?nr</span> <span class="main">∧</span> <span class="skolem">f</span> <span class="bound">i</span> <span class="main">≠</span> dim_col <span class="free">A</span><span class="main">}</span> <span class="main">≥</span> <span class="main">(</span><span class="skolem">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> card_lessThan<span class="main">[</span><span class="operator">of</span> <span class="var"><span class="quoted"><span class="var">?ip</span></span></span><span class="main">]</span> card_mono<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> B <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="var">?nr</span> <span class="main">∧</span> <span class="skolem">f</span> <span class="bound">i</span> <span class="main">≠</span> dim_col <span class="free">A</span><span class="main">}</span> "</span></span><span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> A <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="var">?ip</span><span class="main">}</span>"</span></span><span class="main">]</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> clear<span class="main">:</span> <span class="quoted"><span class="quoted">"dim_row <span class="main">(</span>take_rows <span class="free">A</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="main">(</span>pivot_positions <span class="free">A</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> length <span class="main">(</span>pivot_positions <span class="free">A</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> take_rows_def <span class="keyword1"><span class="command">using</span></span> dim_asm fileq <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">+</span> <span class="main">1</span> <span class="main">&gt;</span> length <span class="main">(</span>pivot_positions <span class="free">A</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> not_lt clear <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="skolem">i</span> <span class="main">=</span> <span class="var">?nc</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> gteq len_pp_var <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> half1 half2
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> h1a<span class="main">:</span> <span class="quoted"><span class="quoted">"row <span class="free">A</span> <span class="skolem">i</span> <span class="main">=</span>  <span class="keyword1">0<span class="hidden">⇩</span><sub>v</sub></span> <span class="main">(</span>dim_col <span class="free">A</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> pivot_fun_zero_row_iff<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">A</span></span> <span class="main">_</span> <span class="var"><span class="quoted"><span class="var">?nc</span></span></span> <span class="var"><span class="quoted"><span class="var">?nr</span></span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">using</span></span> lt_i <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> h1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">$$</span> <span class="main">(</span><span class="skolem">i</span><span class="main">,</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> index_row<span class="main">(</span>1<span class="main">)</span> lt_i lt_j <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span> 
    <span class="keyword1"><span class="command">have</span></span> h2a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">-</span> dim_row <span class="main">(</span>take_rows <span class="free">A</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="main">(</span>pivot_positions <span class="free">A</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="main">&lt;</span> dim_row <span class="free">A</span> <span class="main">-</span> length <span class="main">(</span>pivot_positions <span class="free">A</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> pivot_len lt_i not_lt
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> take_rows_def<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> h2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">0<span class="hidden">⇩</span><sub>m</sub></span> <span class="main">(</span>dim_row <span class="free">A</span> <span class="main">-</span> length <span class="main">(</span>pivot_positions <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>dim_col <span class="free">A</span><span class="main">)</span> <span class="main">$$</span>
           <span class="main">(</span><span class="skolem">i</span> <span class="main">-</span> dim_row <span class="main">(</span>take_rows <span class="free">A</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="main">(</span>pivot_positions <span class="free">A</span><span class="main">)</span><span class="main">]</span><span class="main">)</span><span class="main">,</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span> "</span></span> 
      <span class="keyword1"><span class="command">unfolding</span></span> zero_mat_def <span class="keyword1"><span class="command">using</span></span> pivot_len lt_i lt_j
      <span class="keyword1"><span class="command">using</span></span> index_mat<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">0<span class="hidden">⇩</span><sub>m</sub></span> <span class="main">(</span>dim_row <span class="free">A</span> <span class="main">-</span> length <span class="main">(</span>pivot_positions <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>dim_col <span class="free">A</span><span class="main">)</span> <span class="main">$$</span>
           <span class="main">(</span><span class="skolem">i</span> <span class="main">-</span> dim_row <span class="main">(</span>take_rows <span class="free">A</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="main">(</span>pivot_positions <span class="free">A</span><span class="main">)</span><span class="main">]</span><span class="main">)</span><span class="main">,</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">=</span>
           <span class="free">A</span> <span class="main">$$</span> <span class="main">(</span><span class="skolem">i</span><span class="main">,</span> <span class="skolem">j</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> h1 h2
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> 
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">have</span></span> h3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>dim_row <span class="main">(</span>take_rows <span class="free">A</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="main">(</span>pivot_positions <span class="free">A</span><span class="main">)</span><span class="main">]</span><span class="main">)</span><span class="main">::</span>nat<span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="main">(</span>dim_row <span class="free">A</span><span class="main">::</span>nat<span class="main">)</span> <span class="main">-</span> <span class="main">(</span>length <span class="main">(</span>pivot_positions <span class="free">A</span><span class="main">)</span><span class="main">::</span>nat<span class="main">)</span><span class="main">)</span> <span class="main">=</span>
    dim_row <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
    <span class="keyword1"><span class="command">have</span></span> h0<span class="main">:</span> <span class="quoted"><span class="quoted">"dim_row <span class="main">(</span>take_rows <span class="free">A</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="main">(</span>pivot_positions <span class="free">A</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>length <span class="main">(</span>pivot_positions <span class="free">A</span><span class="main">)</span><span class="main">::</span>nat<span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> take_rows_def fileq<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> add_diff_inverse_nat  pivot_len
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">have</span></span> h4<span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="main">⋀</span><span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> dim_row <span class="free">A</span> <span class="main">⟹</span>
           <span class="bound">j</span> <span class="main">&lt;</span> dim_col <span class="free">A</span> <span class="main">⟹</span>
           <span class="bound">i</span> <span class="main">&lt;</span> dim_row <span class="main">(</span>take_rows <span class="free">A</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="main">(</span>pivot_positions <span class="free">A</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="main">+</span>
               <span class="main">(</span>dim_row <span class="free">A</span> <span class="main">-</span> length <span class="main">(</span>pivot_positions <span class="free">A</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> pivot_len
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> h3<span class="main">)</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> mat_eq_iff<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> h1 h2 h3 h4 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> append_rows_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="More_Matrix-length_pivot_positions_dim_row"><span class="command">lemma</span></span> length_pivot_positions_dim_row<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"row_echelon_form <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>pivot_positions <span class="free">A</span><span class="main">)</span> <span class="main">≤</span> dim_row <span class="free">A</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">∈</span> carrier_mat <span class="main">(</span>dim_row <span class="free">A</span><span class="main">)</span> <span class="main">(</span>dim_col <span class="free">A</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">f</span></span> <span class="keyword2"><span class="keyword">where</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"pivot_fun <span class="free">A</span> <span class="skolem">f</span> <span class="main">(</span>dim_col <span class="free">A</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms row_echelon_form_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> pivot_positions<span class="main">(</span>4<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> 1 2<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span>
    <span class="quoted"><span class="quoted">"length <span class="main">(</span>pivot_positions <span class="free">A</span><span class="main">)</span> <span class="main">=</span> card <span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> dim_row <span class="free">A</span> <span class="main">∧</span> row <span class="free">A</span> <span class="bound">i</span> <span class="main">≠</span> <span class="keyword1">0<span class="hidden">⇩</span><sub>v</sub></span> <span class="main">(</span>dim_col <span class="free">A</span><span class="main">)</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">≤</span> card <span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> dim_row <span class="free">A</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> card_mono<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="More_Matrix-rref_pivot_positions"><span class="command">lemma</span></span> rref_pivot_positions<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"row_echelon_form <span class="free">R</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> R<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="main">∈</span> carrier_mat <span class="free">nr</span> <span class="free">nc</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> <span class="main">(</span><span class="bound">i</span><span class="main">,</span><span class="bound">j</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>pivot_positions <span class="free">R</span><span class="main">)</span> <span class="main">⟹</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="free">nr</span> <span class="main">∧</span> <span class="bound">j</span> <span class="main">&lt;</span> <span class="free">nc</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">f</span></span> <span class="keyword2"><span class="keyword">where</span></span> f<span class="main">:</span> <span class="quoted"><span class="quoted">"pivot_fun <span class="free">R</span> <span class="skolem">f</span> <span class="free">nc</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>2<span class="main">)</span> row_echelon_form_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="free">nr</span> <span class="main">⟹</span> <span class="skolem">f</span> <span class="bound">i</span> <span class="main">≤</span> <span class="free">nc</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> f
    <span class="keyword1"><span class="command">using</span></span> R pivot_funD<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> pivot_positions<span class="main">[</span><span class="operator">OF</span> R f<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>pivot_positions <span class="free">R</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="main">(</span><span class="bound">i</span><span class="main">,</span> <span class="skolem">f</span> <span class="bound">i</span><span class="main">)</span> <span class="main">|</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="free">nr</span> <span class="main">∧</span> <span class="skolem">f</span> <span class="bound">i</span> <span class="main">≠</span> <span class="free">nc</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> **<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>pivot_positions <span class="free">R</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="main">(</span><span class="bound">i</span><span class="main">,</span> <span class="skolem">f</span> <span class="bound">i</span><span class="main">)</span> <span class="main">|</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="free">nr</span> <span class="main">∧</span> <span class="skolem">f</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="free">nc</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> *
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="skolem">j</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">i</span><span class="main">,</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>pivot_positions <span class="free">R</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> <span class="free">nr</span> <span class="main">∧</span> <span class="skolem">j</span> <span class="main">&lt;</span> <span class="free">nc</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> **
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="More_Matrix-pivot_fun_monoton"><span class="command">lemma</span></span> pivot_fun_monoton<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> pf<span class="main">:</span> <span class="quoted"><span class="quoted">"pivot_fun <span class="free">A</span> <span class="free">f</span> <span class="main">(</span>dim_col <span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> dr<span class="main">:</span> <span class="quoted"><span class="quoted">"dim_row <span class="free">A</span> <span class="main">=</span> <span class="free">nr</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="free">nr</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">⋀</span> <span class="bound">k</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="bound">k</span> <span class="main">&lt;</span> <span class="free">nr</span> <span class="main">∧</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="bound">k</span><span class="main">)</span> <span class="main">⟶</span> <span class="free">f</span> <span class="bound">i</span> <span class="main">≤</span> <span class="free">f</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> <span class="free">nr</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span> <span class="bound">k</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="bound">k</span> <span class="main">&lt;</span> <span class="free">nr</span> <span class="main">∧</span> <span class="skolem">i</span> <span class="main">&lt;</span> <span class="bound">k</span><span class="main">)</span> <span class="main">⟶</span> <span class="free">f</span> <span class="skolem">i</span> <span class="main">≤</span> <span class="free">f</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">k</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="skolem">k</span> <span class="main">&lt;</span> <span class="free">nr</span> <span class="main">∧</span> <span class="skolem">i</span> <span class="main">&lt;</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">⟶</span> <span class="free">f</span> <span class="skolem">i</span> <span class="main">≤</span> <span class="free">f</span> <span class="skolem">k</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">k</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> 0
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> dr le_less_trans less_Suc_eq less_imp_le_nat pf pivot_funD<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> pivot_funD<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="More_Matrix-pivot_positions_contains"><span class="command">lemma</span></span> pivot_positions_contains<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> row_ech<span class="main">:</span> <span class="quoted"><span class="quoted">"row_echelon_form <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> dim_h<span class="main">:</span> <span class="quoted"><span class="quoted">"dim_col <span class="free">A</span> <span class="main">≥</span> dim_row <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"pivot_fun <span class="free">A</span> <span class="free">f</span> <span class="main">(</span>dim_col <span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> <span class="main">(</span>length <span class="main">(</span>pivot_positions <span class="free">A</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">i</span><span class="main">,</span> <span class="free">f</span> <span class="bound">i</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>pivot_positions <span class="free">A</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?nr</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"dim_row <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?nc</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"dim_col <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?pp</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"pivot_positions <span class="free">A</span>"</span></span>          
  <span class="keyword1"><span class="command">have</span></span> i_nr<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> <span class="main">(</span>length <span class="var">?pp</span><span class="main">)</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="var">?nr</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> rref_pivot_positions assms
    <span class="keyword1"><span class="command">using</span></span> length_pivot_positions_dim_row less_le_trans <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
  <span class="keyword1"><span class="command">have</span></span> i_nc<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> <span class="main">(</span>length <span class="var">?pp</span><span class="main">)</span><span class="main">.</span> <span class="free">f</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="var">?nc</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">clarsimp</span> 
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span>
    <span class="keyword3"><span class="command">assume</span></span> i_lt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="var">?pp</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> fis_nc<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="skolem">i</span> <span class="main">=</span> <span class="var">?nc</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">∀</span> <span class="bound"><span class="bound">k</span></span> <span class="main">&gt;</span> <span class="skolem">i</span><span class="main">.</span> <span class="bound">k</span> <span class="main">&lt;</span> <span class="var">?nr</span> <span class="main">⟶</span> <span class="free">f</span> <span class="bound">k</span> <span class="main">=</span> <span class="var">?nc</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword3"><span class="command">assume</span></span> is_nc<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="skolem">i</span> <span class="main">=</span> <span class="var">?nc</span>"</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span> <span class="bound"><span class="bound">k</span></span> <span class="main">&gt;</span> <span class="skolem">i</span><span class="main">.</span> <span class="bound">k</span> <span class="main">&lt;</span> <span class="var">?nr</span> <span class="main">⟶</span> <span class="free">f</span> <span class="bound">k</span> <span class="main">=</span> <span class="var">?nc</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">clarsimp</span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">k</span>
        <span class="keyword3"><span class="command">assume</span></span> k_gt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">&gt;</span> <span class="skolem">i</span>"</span></span>
        <span class="keyword3"><span class="command">assume</span></span> k_lt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">&lt;</span> <span class="var">?nr</span>"</span></span>
        <span class="keyword1"><span class="command">have</span></span> fk_lt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="skolem">k</span> <span class="main">≤</span> <span class="var">?nc</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> pivot_funD<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">A</span></span> <span class="var"><span class="quoted"><span class="var">?nr</span></span></span> <span class="quoted"><span class="free">f</span></span> <span class="var"><span class="quoted"><span class="var">?nc</span></span></span> <span class="quoted"><span class="skolem">k</span></span><span class="main">]</span> k_lt <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹pivot_fun <span class="free">A</span> <span class="free">f</span> <span class="main">(</span>dim_col <span class="free">A</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="skolem">k</span> <span class="main">=</span> <span class="var">?nc</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> fk_lt is_nc k_gt k_lt assms pivot_fun_monoton<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">A</span></span> <span class="quoted"><span class="free">f</span></span> <span class="var"><span class="quoted"><span class="var">?nr</span></span></span> <span class="quoted"><span class="skolem">i</span></span> <span class="quoted"><span class="skolem">k</span></span><span class="main">]</span>
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹pivot_fun <span class="free">A</span> <span class="free">f</span> <span class="main">(</span>dim_col <span class="free">A</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">have</span></span> ncimp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="skolem">i</span> <span class="main">=</span> <span class="var">?nc</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">∀</span> <span class="bound"><span class="bound">k</span></span> <span class="main">≥</span><span class="skolem">i</span><span class="main">.</span> <span class="bound">k</span> <span class="main">∉</span> <span class="main">{</span> <span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="var">?nr</span> <span class="main">∧</span> row <span class="free">A</span> <span class="bound">i</span> <span class="main">≠</span> <span class="keyword1">0<span class="hidden">⇩</span><sub>v</sub></span> <span class="var">?nc</span><span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword3"><span class="command">assume</span></span> nchyp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="skolem">i</span> <span class="main">=</span> <span class="var">?nc</span>"</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span> <span class="bound"><span class="bound">k</span></span> <span class="main">≥</span><span class="skolem">i</span><span class="main">.</span> <span class="bound">k</span> <span class="main">∉</span> <span class="main">{</span> <span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="var">?nr</span> <span class="main">∧</span> row <span class="free">A</span> <span class="bound">i</span> <span class="main">≠</span> <span class="keyword1">0<span class="hidden">⇩</span><sub>v</sub></span> <span class="var">?nc</span><span class="main">}</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">clarsimp</span> 
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">k</span>
        <span class="keyword3"><span class="command">assume</span></span> i_lt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">≤</span> <span class="skolem">k</span>"</span></span> 
        <span class="keyword3"><span class="command">assume</span></span> k_lt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">&lt;</span> dim_row <span class="free">A</span>"</span></span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"row <span class="free">A</span> <span class="skolem">k</span> <span class="main">=</span> <span class="keyword1">0<span class="hidden">⇩</span><sub>v</sub></span> <span class="main">(</span>dim_col <span class="free">A</span><span class="main">)</span> "</span></span>
          <span class="keyword1"><span class="command">using</span></span> i_lt k_lt fis_nc
          <span class="keyword1"><span class="command">using</span></span> pivot_fun_zero_row_iff<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">A</span></span> <span class="quoted"><span class="free">f</span></span> <span class="var"><span class="quoted"><span class="var">?nc</span></span></span> <span class="var"><span class="quoted"><span class="var">?nr</span></span></span><span class="main">]</span>
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹pivot_fun <span class="free">A</span> <span class="free">f</span> <span class="main">(</span>dim_col <span class="free">A</span><span class="main">)</span>›</span></span> le_neq_implies_less nchyp <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="skolem">i</span> <span class="main">=</span> <span class="var">?nc</span> <span class="main">⟹</span> card <span class="main">{</span> <span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="var">?nr</span> <span class="main">∧</span> row <span class="free">A</span> <span class="bound">i</span> <span class="main">≠</span> <span class="keyword1">0<span class="hidden">⇩</span><sub>v</sub></span> <span class="var">?nc</span><span class="main">}</span> <span class="main">≤</span> <span class="skolem">i</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
      <span class="keyword3"><span class="command">assume</span></span> nchyp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="skolem">i</span> <span class="main">=</span> <span class="var">?nc</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> h<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span> <span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="var">?nr</span> <span class="main">∧</span> row <span class="free">A</span> <span class="bound">i</span> <span class="main">≠</span> <span class="keyword1">0<span class="hidden">⇩</span><sub>v</sub></span> <span class="var">?nc</span><span class="main">}</span> <span class="main">⊆</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="skolem">i</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> atLeast0LessThan le_less_linear nchyp ncimp <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">" card <span class="main">{</span> <span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="var">?nr</span> <span class="main">∧</span> row <span class="free">A</span> <span class="bound">i</span> <span class="main">≠</span> <span class="keyword1">0<span class="hidden">⇩</span><sub>v</sub></span> <span class="var">?nc</span><span class="main">}</span> <span class="main">≤</span> <span class="skolem">i</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> card_lessThan
        <span class="keyword1"><span class="command">using</span></span> subset_eq_atLeast0_lessThan_card <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="skolem">i</span> <span class="main">&lt;</span> <span class="var">?nc</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> i_lt pivot_positions<span class="main">(</span>4<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">A</span></span> <span class="var"><span class="quoted"><span class="var">?nr</span></span></span> <span class="var"><span class="quoted"><span class="var">?nc</span></span></span> <span class="quoted"><span class="free">f</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹pivot_fun <span class="free">A</span> <span class="free">f</span> <span class="main">(</span>dim_col <span class="free">A</span><span class="main">)</span>›</span></span> i_nr le_neq_implies_less not_less pivot_funD<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span> 
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> pivot_positions<span class="main">(</span>1<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> <span class="quoted"><span class="quoted">‹pivot_fun <span class="free">A</span> <span class="free">f</span> <span class="main">(</span>dim_col <span class="free">A</span><span class="main">)</span>›</span></span> carrier_matI i_nr less_not_refl mem_Collect_eq<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="More_Matrix-pivot_positions_form_helper_1"><span class="command">lemma</span></span> pivot_positions_form_helper_1<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">a</span><span class="main">,</span> <span class="free">b</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>pivot_positions_main_gen <span class="free">z</span> <span class="free">A</span> <span class="free">nr</span> <span class="free">nc</span> <span class="free">i</span> <span class="free">j</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">i</span> <span class="main">≤</span> <span class="free">a</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>  <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">j</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> pivot_positions_main_gen.induct<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">nr</span></span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">nc</span></span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">A</span></span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">z</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">i</span> <span class="skolem">j</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span>  pivot_positions_main_gen.simps<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">z</span></span> <span class="quoted"><span class="free">A</span></span> <span class="quoted"><span class="free">nr</span></span> <span class="quoted"><span class="free">nc</span></span> <span class="quoted"><span class="skolem">i</span></span> <span class="quoted"><span class="skolem">j</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> Suc_leD le_refl old.prod.inject set_ConsD<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="More_Matrix-pivot_positions_form_helper_2"><span class="command">lemma</span></span> pivot_positions_form_helper_2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"strict_sorted <span class="main">(</span>map fst <span class="main">(</span>pivot_positions_main_gen <span class="free">z</span> <span class="free">A</span> <span class="free">nr</span> <span class="free">nc</span> <span class="free">i</span> <span class="free">j</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>  <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">j</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> pivot_positions_main_gen.induct<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">nr</span></span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">nc</span></span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">A</span></span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">z</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">i</span> <span class="skolem">j</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span>  pivot_positions_main_gen.simps<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">z</span></span> <span class="quoted"><span class="free">A</span></span> <span class="quoted"><span class="free">nr</span></span> <span class="quoted"><span class="free">nc</span></span> <span class="quoted"><span class="skolem">i</span></span> <span class="quoted"><span class="skolem">j</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> pivot_positions_form_helper_1
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pivot_positions_form_helper_1 Suc_le_lessD<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="More_Matrix-sorted_pivot_positions"><span class="command">lemma</span></span> sorted_pivot_positions<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"strict_sorted <span class="main">(</span>map fst <span class="main">(</span>pivot_positions <span class="free">A</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> pivot_positions_form_helper_2
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pivot_positions_form_helper_2 pivot_positions_gen_def<span class="main">)</span> 

<span class="keyword1" id="More_Matrix-pivot_positions_form"><span class="command">lemma</span></span> pivot_positions_form<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> row_ech<span class="main">:</span> <span class="quoted"><span class="quoted">"row_echelon_form <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> dim_h<span class="main">:</span> <span class="quoted"><span class="quoted">"dim_col <span class="free">A</span> <span class="main">≥</span> dim_row <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> <span class="main">(</span>length <span class="main">(</span>pivot_positions <span class="free">A</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> fst <span class="main">(</span><span class="main">(</span>pivot_positions <span class="free">A</span><span class="main">)</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">=</span> <span class="bound">i</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">clarsimp</span> 
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?nr</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"dim_row <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?nc</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"dim_col <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?pp</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"pivot_positions <span class="free">A</span> <span class="main">::</span> <span class="main">(</span>nat <span class="main">×</span> nat<span class="main">)</span> list"</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span>
  <span class="keyword3"><span class="command">assume</span></span> i_lt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="main">(</span>pivot_positions <span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">f</span><span class="main">.</span> pivot_fun <span class="free">A</span> <span class="bound">f</span> <span class="var">?nc</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> row_ech <span class="keyword1"><span class="command">unfolding</span></span> row_echelon_form_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">f</span></span> <span class="keyword2"><span class="keyword">where</span></span> pf<span class="main">:</span><span class="quoted"><span class="quoted">"pivot_fun <span class="free">A</span> <span class="skolem">f</span> <span class="var">?nc</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>                  
  <span class="keyword1"><span class="command">have</span></span> all_f_in<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> <span class="main">(</span>length <span class="var">?pp</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">i</span><span class="main">,</span> <span class="skolem">f</span> <span class="bound">i</span><span class="main">)</span> <span class="main">∈</span> set <span class="var">?pp</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> pivot_positions_contains pf
      assms 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>   
  <span class="keyword1"><span class="command">have</span></span> sorted_hyp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="main">(</span><span class="bound">p</span><span class="main">::</span>nat<span class="main">)</span> <span class="main">(</span><span class="bound">q</span><span class="main">::</span>nat<span class="main">)</span><span class="main">.</span> <span class="bound">p</span> <span class="main">&lt;</span> <span class="main">(</span>length <span class="var">?pp</span><span class="main">)</span> <span class="main">⟹</span> <span class="bound">q</span> <span class="main">&lt;</span> <span class="main">(</span>length <span class="var">?pp</span><span class="main">)</span> <span class="main">⟹</span> <span class="bound">p</span> <span class="main">&lt;</span> <span class="bound">q</span> <span class="main">⟹</span> <span class="main">(</span>fst <span class="main">(</span><span class="var">?pp</span> <span class="main">!</span> <span class="bound">p</span><span class="main">)</span> <span class="main">&lt;</span> fst <span class="main">(</span><span class="var">?pp</span> <span class="main">!</span> <span class="bound">q</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">p</span><span class="main">::</span><span class="quoted">nat</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">q</span><span class="main">::</span><span class="quoted">nat</span>
    <span class="keyword3"><span class="command">assume</span></span> p_lt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">&lt;</span> <span class="skolem">q</span>"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> p_welldef<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">&lt;</span> <span class="main">(</span>length <span class="var">?pp</span><span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> q_welldef<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">&lt;</span> <span class="main">(</span>length <span class="var">?pp</span><span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span><span class="var">?pp</span> <span class="main">!</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">&lt;</span> fst <span class="main">(</span><span class="var">?pp</span> <span class="main">!</span> <span class="skolem">q</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> sorted_pivot_positions p_lt p_welldef q_welldef <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> find_first_unique length_map nat_less_le nth_map p_welldef sorted_nth_mono sorted_pivot_positions strict_sorted_iff<span class="main">)</span>     
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">have</span></span> h<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> <span class="main">(</span>length <span class="var">?pp</span><span class="main">)</span> <span class="main">⟶</span> fst <span class="main">(</span>pivot_positions <span class="free">A</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">i</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">i</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> 0
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">j</span><span class="main">.</span> fst <span class="main">(</span>pivot_positions <span class="free">A</span> <span class="main">!</span> <span class="bound">j</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> all_f_in fst_conv i_lt in_set_conv_nth length_greater_0_conv list.size<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> not_less0<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> jth<span class="main">:</span><span class="quoted"><span class="quoted">" fst <span class="main">(</span>pivot_positions <span class="free">A</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>      
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">⟶</span> <span class="main">(</span>fst <span class="main">(</span>pivot_positions <span class="free">A</span> <span class="main">!</span> <span class="main">0</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">⟶</span> <span class="skolem">j</span> <span class="main">≤</span> <span class="main">0</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> sorted_hyp <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> all_f_in fst_conv i_lt in_set_conv_nth length_greater_0_conv list.size<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> neq0_conv not_less0<span class="main">)</span>  
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> jth neq0_conv <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> ind_h<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="main">(</span>pivot_positions <span class="free">A</span><span class="main">)</span> <span class="main">⟶</span> fst <span class="main">(</span>pivot_positions <span class="free">A</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">i</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Suc.hyps <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
    <span class="keyword1"><span class="command">have</span></span> thesis_h<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span> <span class="main">&lt;</span> length <span class="main">(</span>pivot_positions <span class="free">A</span><span class="main">)</span> <span class="main">⟹</span> fst <span class="main">(</span>pivot_positions <span class="free">A</span> <span class="main">!</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
      <span class="keyword3"><span class="command">assume</span></span> suc_i_lt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span> <span class="main">&lt;</span> length <span class="main">(</span>pivot_positions <span class="free">A</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> fst_i_is<span class="main">:</span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>pivot_positions <span class="free">A</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> suc_i_lt ind_h
        <span class="keyword1"><span class="command">using</span></span> Suc_lessD <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">j</span></span> <span class="main">&lt;</span> <span class="main">(</span>length <span class="var">?pp</span><span class="main">)</span><span class="main">.</span> fst <span class="main">(</span>pivot_positions <span class="free">A</span> <span class="main">!</span> <span class="bound">j</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> suc_i_lt all_f_in fst_conv  in_set_conv_nth<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> jth<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> <span class="main">(</span>length <span class="var">?pp</span><span class="main">)</span> <span class="main">∧</span> fst <span class="main">(</span>pivot_positions <span class="free">A</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&gt;</span> <span class="skolem">i</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> sorted_hyp <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Suc_lessD <span class="quoted"><span class="quoted">‹fst <span class="main">(</span>pivot_positions <span class="free">A</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">i</span>›</span></span> jth less_not_refl linorder_neqE_nat n_not_Suc_n suc_i_lt<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&gt;</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span> <span class="main">⟹</span> False"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword3"><span class="command">assume</span></span> j_gt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&gt;</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> h1<span class="main">:</span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>pivot_positions <span class="free">A</span> <span class="main">!</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="main">&gt;</span> <span class="skolem">i</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> fst_i_is sorted_pivot_positions
          <span class="keyword1"><span class="command">using</span></span> sorted_hyp suc_i_lt <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>pivot_positions <span class="free">A</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">&gt;</span> fst <span class="main">(</span>pivot_positions <span class="free">A</span> <span class="main">!</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> jth j_gt sorted_hyp <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span> 
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> h2<span class="main">:</span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>pivot_positions <span class="free">A</span> <span class="main">!</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="main">&lt;</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span>"</span></span> 
          <span class="keyword1"><span class="command">using</span></span> jth
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>   
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"False"</span></span> <span class="keyword1"><span class="command">using</span></span> h1 h2
          <span class="keyword1"><span class="command">using</span></span> not_less_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>pivot_positions <span class="free">A</span> <span class="main">!</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> Suc_lessI <span class="quoted"><span class="quoted">‹Suc <span class="skolem">i</span> <span class="main">&lt;</span> <span class="skolem">j</span> <span class="main">⟹</span> False›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">&lt;</span> <span class="skolem">j</span>›</span></span> jth <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>pivot_positions <span class="free">A</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">i</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> i_lt <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="More_Matrix-take_cols_pivot_eq"><span class="command">lemma</span></span> take_cols_pivot_eq<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> row_ech<span class="main">:</span> <span class="quoted"><span class="quoted">"row_echelon_form <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> dim_h<span class="main">:</span> <span class="quoted"><span class="quoted">"dim_col <span class="free">A</span> <span class="main">≥</span> dim_row <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"take_cols <span class="free">A</span> <span class="main">(</span>map snd <span class="main">(</span>pivot_positions <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
    <span class="keyword1">1<span class="hidden">⇩</span><sub>m</sub></span> <span class="main">(</span>length <span class="main">(</span>pivot_positions <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">@<span class="hidden">⇩</span><sub>r</sub></span>
    <span class="keyword1">0<span class="hidden">⇩</span><sub>m</sub></span> <span class="main">(</span>dim_row <span class="free">A</span> <span class="main">-</span> length <span class="main">(</span>pivot_positions <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>length <span class="main">(</span>pivot_positions <span class="free">A</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?nr</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"dim_row <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?nc</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"dim_col <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> h1<span class="main">:</span> <span class="quoted"><span class="quoted">" dim_col
     <span class="main">(</span><span class="keyword1">1<span class="hidden">⇩</span><sub>m</sub></span> <span class="main">(</span>length <span class="main">(</span>pivot_positions <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">@<span class="hidden">⇩</span><sub>r</sub></span>
      <span class="keyword1">0<span class="hidden">⇩</span><sub>m</sub></span> <span class="main">(</span>dim_row <span class="free">A</span> <span class="main">-</span> length <span class="main">(</span>pivot_positions <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>length <span class="main">(</span>pivot_positions <span class="free">A</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>length <span class="main">(</span>pivot_positions <span class="free">A</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> append_rows_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> len_pivot<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>pivot_positions <span class="free">A</span><span class="main">)</span> <span class="main">=</span> card <span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="var">?nr</span> <span class="main">∧</span> row <span class="free">A</span> <span class="bound">i</span> <span class="main">≠</span> <span class="keyword1">0<span class="hidden">⇩</span><sub>v</sub></span> <span class="var">?nc</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> row_ech pivot_positions<span class="main">(</span>4<span class="main">)</span> row_echelon_form_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> pp_leq_nc<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">f</span><span class="main">.</span> pivot_fun <span class="free">A</span> <span class="bound">f</span> <span class="var">?nc</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> <span class="var">?nr</span><span class="main">.</span> <span class="bound">f</span> <span class="bound">i</span> <span class="main">≤</span> <span class="var">?nc</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> pivot_fun_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">meson</span> 
  <span class="keyword1"><span class="command">have</span></span> pivot_set<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">f</span><span class="main">.</span> pivot_fun <span class="free">A</span> <span class="bound">f</span> <span class="var">?nc</span> <span class="main">∧</span> set <span class="main">(</span>pivot_positions <span class="free">A</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="main">(</span><span class="bound">i</span><span class="main">,</span> <span class="bound">f</span> <span class="bound">i</span><span class="main">)</span> <span class="main">|</span> <span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="var">?nr</span> <span class="main">∧</span> <span class="bound">f</span> <span class="bound">i</span> <span class="main">≠</span> <span class="var">?nc</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> row_ech row_echelon_form_def pivot_positions<span class="main">(</span>1<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> <span class="main"><span class="main">(</span></span>verit<span class="main"><span class="main">)</span></span> Collect_cong carrier_matI<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> pivot_set_alt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">f</span><span class="main">.</span> pivot_fun <span class="free">A</span> <span class="bound">f</span> <span class="var">?nc</span> <span class="main">∧</span> set <span class="main">(</span>pivot_positions <span class="free">A</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="main">(</span><span class="bound">i</span><span class="main">,</span> <span class="bound">f</span> <span class="bound">i</span><span class="main">)</span> <span class="main">|</span> <span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="var">?nr</span> <span class="main">∧</span> row <span class="free">A</span> <span class="bound">i</span> <span class="main">≠</span> <span class="keyword1">0<span class="hidden">⇩</span><sub>v</sub></span> <span class="var">?nc</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> pivot_positions pivot_fun_zero_row_iff Collect_cong carrier_mat_triv
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> <span class="main"><span class="main">(</span></span>verit<span class="main"><span class="main">,</span></span> best<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">f</span><span class="main">.</span> pivot_fun <span class="free">A</span> <span class="bound">f</span> <span class="var">?nc</span> <span class="main">∧</span> set <span class="main">(</span>pivot_positions <span class="free">A</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="main">(</span><span class="bound">i</span><span class="main">,</span> <span class="bound">f</span> <span class="bound">i</span><span class="main">)</span> <span class="main">|</span> <span class="bound">i</span><span class="main">.</span> <span class="bound">f</span> <span class="bound">i</span> <span class="main">≤</span> <span class="var">?nc</span> <span class="main">∧</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="var">?nr</span> <span class="main">∧</span> <span class="bound">f</span> <span class="bound">i</span> <span class="main">≠</span> <span class="var">?nc</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> pivot_set pp_leq_nc <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> pivot_set_var<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">f</span><span class="main">.</span> pivot_fun <span class="free">A</span> <span class="bound">f</span> <span class="var">?nc</span> <span class="main">∧</span> set <span class="main">(</span>pivot_positions <span class="free">A</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="main">(</span><span class="bound">i</span><span class="main">,</span> <span class="bound">f</span> <span class="bound">i</span><span class="main">)</span> <span class="main">|</span> <span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="var">?nr</span> <span class="main">∧</span> <span class="bound">f</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="var">?nc</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>map snd <span class="main">(</span>pivot_positions <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> card <span class="main">(</span>set <span class="main">(</span>map snd <span class="main">(</span>pivot_positions <span class="free">A</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> row_ech row_echelon_form_def pivot_positions<span class="main">(</span>3<span class="main">)</span> distinct_card<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> xs <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"map snd <span class="main">(</span>pivot_positions <span class="free">A</span><span class="main">)</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> carrier_mat_triv<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>map snd <span class="main">(</span>pivot_positions <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> card <span class="main">(</span>set <span class="main">(</span>pivot_positions <span class="free">A</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> card_distinct distinct_card distinct_map length_map<span class="main">)</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>map snd <span class="main">(</span>pivot_positions <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> card <span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="var">?nr</span> <span class="main">∧</span> row <span class="free">A</span> <span class="bound">i</span> <span class="main">≠</span> <span class="keyword1">0<span class="hidden">⇩</span><sub>v</sub></span> <span class="var">?nc</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> pivot_set_alt
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> len_pivot<span class="main">)</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> length_asm<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>map snd <span class="main">(</span>pivot_positions <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> length <span class="main">(</span>pivot_positions <span class="free">A</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> len_pivot <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">a</span><span class="main">.</span> List.member <span class="main">(</span>map snd <span class="main">(</span>pivot_positions <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="bound">a</span> <span class="main">⟶</span> <span class="bound">a</span> <span class="main">&lt;</span> dim_col <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">clarsimp</span> 
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span>
    <span class="keyword3"><span class="command">assume</span></span> a_in<span class="main">:</span> <span class="quoted"><span class="quoted">"List.member <span class="main">(</span>map snd <span class="main">(</span>pivot_positions <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="skolem">a</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">v</span> <span class="main">∈</span> set <span class="main">(</span>pivot_positions <span class="free">A</span><span class="main">)</span><span class="main">.</span> <span class="skolem">a</span> <span class="main">=</span> snd <span class="bound">v</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> a_in in_set_member<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> xs <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>pivot_positions <span class="free">A</span><span class="main">)</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> in_set_impl_in_set_zip2 in_set_member length_map snd_conv zip_map_fst_snd<span class="main">)</span> 
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">&lt;</span> dim_col <span class="free">A</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> pivot_set_var in_set_member <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> h2b<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">&lt;</span> dim_col <span class="free">A</span><span class="main">)</span> <span class="main">(</span>map snd <span class="main">(</span>pivot_positions <span class="free">A</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>  <span class="main">(</span>map snd <span class="main">(</span>pivot_positions <span class="free">A</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> filter_True in_set_member<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> h2a<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>map <span class="main">(</span><span class="main">(!)</span> <span class="main">(</span>cols <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">&lt;</span> dim_col <span class="free">A</span><span class="main">)</span> <span class="main">(</span>map snd <span class="main">(</span>pivot_positions <span class="free">A</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> length <span class="main">(</span>pivot_positions <span class="free">A</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> length_asm
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> h2b<span class="main">)</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> h2<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>pivot_positions <span class="free">A</span><span class="main">)</span> <span class="main">≤</span> dim_row <span class="free">A</span> <span class="main">⟹</span>
    dim_col <span class="main">(</span>take_cols <span class="free">A</span> <span class="main">(</span>map snd <span class="main">(</span>pivot_positions <span class="free">A</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>length <span class="main">(</span>pivot_positions <span class="free">A</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">unfolding</span></span> take_cols_def <span class="keyword1"><span class="command">using</span></span> mat_of_cols_carrier <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> h_len<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>pivot_positions <span class="free">A</span><span class="main">)</span> <span class="main">≤</span> dim_row <span class="free">A</span> <span class="main">⟹</span>
    dim_col <span class="main">(</span>take_cols <span class="free">A</span> <span class="main">(</span>map snd <span class="main">(</span>pivot_positions <span class="free">A</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
    dim_col
     <span class="main">(</span><span class="keyword1">1<span class="hidden">⇩</span><sub>m</sub></span> <span class="main">(</span>length <span class="main">(</span>pivot_positions <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">@<span class="hidden">⇩</span><sub>r</sub></span>
      <span class="keyword1">0<span class="hidden">⇩</span><sub>m</sub></span> <span class="main">(</span>dim_row <span class="free">A</span> <span class="main">-</span> length <span class="main">(</span>pivot_positions <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>length <span class="main">(</span>pivot_positions <span class="free">A</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> h1 h2
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> h1 assms length_pivot_positions_dim_row<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> h2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> length <span class="main">(</span>pivot_positions <span class="free">A</span><span class="main">)</span> <span class="main">≤</span> dim_row <span class="free">A</span> <span class="main">⟹</span>
           <span class="bound">i</span> <span class="main">&lt;</span> dim_row <span class="free">A</span> <span class="main">⟹</span>
           <span class="bound">j</span> <span class="main">&lt;</span> dim_col
                <span class="main">(</span><span class="keyword1">1<span class="hidden">⇩</span><sub>m</sub></span> <span class="main">(</span>length <span class="main">(</span>pivot_positions <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">@<span class="hidden">⇩</span><sub>r</sub></span>
                 <span class="keyword1">0<span class="hidden">⇩</span><sub>m</sub></span> <span class="main">(</span>dim_row <span class="free">A</span> <span class="main">-</span> length <span class="main">(</span>pivot_positions <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>length <span class="main">(</span>pivot_positions <span class="free">A</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span>
           take_cols <span class="free">A</span> <span class="main">(</span>map snd <span class="main">(</span>pivot_positions <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">$$</span> <span class="main">(</span><span class="bound">i</span><span class="main">,</span> <span class="bound">j</span><span class="main">)</span> <span class="main">=</span>
           <span class="main">(</span><span class="keyword1">1<span class="hidden">⇩</span><sub>m</sub></span> <span class="main">(</span>length <span class="main">(</span>pivot_positions <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">@<span class="hidden">⇩</span><sub>r</sub></span>
            <span class="keyword1">0<span class="hidden">⇩</span><sub>m</sub></span> <span class="main">(</span>dim_row <span class="free">A</span> <span class="main">-</span> length <span class="main">(</span>pivot_positions <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>length <span class="main">(</span>pivot_positions <span class="free">A</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">$$</span>
           <span class="main">(</span><span class="bound">i</span><span class="main">,</span> <span class="bound">j</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> 
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">j</span> 
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?pp</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>pivot_positions <span class="free">A</span><span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> len_lt<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>pivot_positions <span class="free">A</span><span class="main">)</span> <span class="main">≤</span> dim_row <span class="free">A</span>"</span></span> 
    <span class="keyword3"><span class="command">assume</span></span> i_lt<span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="skolem">i</span> <span class="main">&lt;</span> dim_row <span class="free">A</span>"</span></span> 
    <span class="keyword3"><span class="command">assume</span></span> j_lt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> dim_col
                <span class="main">(</span><span class="keyword1">1<span class="hidden">⇩</span><sub>m</sub></span> <span class="main">(</span>length <span class="main">(</span>pivot_positions <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">@<span class="hidden">⇩</span><sub>r</sub></span>
                 <span class="keyword1">0<span class="hidden">⇩</span><sub>m</sub></span> <span class="main">(</span>dim_row <span class="free">A</span> <span class="main">-</span> length <span class="main">(</span>pivot_positions <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>length <span class="main">(</span>pivot_positions <span class="free">A</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?w</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span>map snd <span class="main">(</span>pivot_positions <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> breaking_it_down<span class="main">:</span> <span class="quoted"><span class="quoted">"mat_of_cols <span class="main">(</span>dim_row <span class="free">A</span><span class="main">)</span>
     <span class="main">(</span>map <span class="main">(</span><span class="main">(!)</span> <span class="main">(</span>cols <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>map snd <span class="main">(</span>pivot_positions <span class="free">A</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">$$</span> <span class="main">(</span><span class="skolem">i</span><span class="main">,</span> <span class="skolem">j</span><span class="main">)</span>  
     <span class="main">=</span>  <span class="main">(</span><span class="main">(</span>cols <span class="free">A</span><span class="main">)</span> <span class="main">!</span> <span class="var">?w</span><span class="main">)</span> <span class="main">$</span> <span class="skolem">i</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> comp_apply h1 i_lt j_lt length_map mat_of_cols_index nth_map<span class="main">)</span> 
    <span class="keyword1"><span class="command">have</span></span> h1a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> <span class="main">(</span>length <span class="var">?pp</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">(</span>mat_of_cols <span class="main">(</span>dim_row <span class="free">A</span><span class="main">)</span> <span class="main">(</span>map <span class="main">(</span><span class="main">(!)</span> <span class="main">(</span>cols <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>map snd <span class="main">(</span>pivot_positions <span class="free">A</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">$$</span> <span class="main">(</span><span class="skolem">i</span><span class="main">,</span> <span class="skolem">j</span><span class="main">)</span> 
        <span class="main">=</span> <span class="main">(</span><span class="keyword1">1<span class="hidden">⇩</span><sub>m</sub></span> <span class="main">(</span>length <span class="main">(</span>pivot_positions <span class="free">A</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">$$</span> <span class="main">(</span><span class="skolem">i</span><span class="main">,</span> <span class="skolem">j</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
      <span class="comment1">(* need to, using row_ech, rely heavily on pivot_fun_def, that num_cols ≥ num_rows, and row_echelon form*)</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> <span class="main">(</span>length <span class="var">?pp</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">f</span><span class="main">.</span> pivot_fun <span class="free">A</span> <span class="bound">f</span> <span class="var">?nc</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> row_ech <span class="keyword1"><span class="command">unfolding</span></span> row_echelon_form_def
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">f</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"pivot_fun <span class="free">A</span> <span class="skolem">f</span> <span class="var">?nc</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">have</span></span> j_nc<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> <span class="main">(</span>length <span class="var">?pp</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> j_lt
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> h1<span class="main">)</span> 
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> j_lt_nr<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> <span class="var">?nr</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> dim_h
        <span class="keyword1"><span class="command">using</span></span> len_lt <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span> 
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> is_this_true<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>pivot_positions <span class="free">A</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">j</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">j</span><span class="main">,</span> <span class="skolem">f</span> <span class="skolem">j</span><span class="main">)</span>"</span></span> 
        <span class="keyword1"><span class="command">using</span></span> pivot_positions_form pivot_positions<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">A</span></span> <span class="var"><span class="quoted"><span class="var">?nr</span></span></span> <span class="var"><span class="quoted"><span class="var">?nc</span></span></span> <span class="quoted"><span class="skolem">f</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"pivot_positions <span class="free">A</span> <span class="main">!</span> <span class="skolem">j</span> <span class="main">∈</span> set <span class="main">(</span>pivot_positions <span class="free">A</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> j_nc nth_mem <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">n</span><span class="main">.</span> pivot_positions <span class="free">A</span> <span class="main">!</span> <span class="skolem">j</span> <span class="main">=</span> <span class="main">(</span><span class="bound">n</span><span class="main">,</span> <span class="skolem">f</span> <span class="bound">n</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">n</span> <span class="main">&lt;</span> dim_row <span class="free">A</span> <span class="main">∧</span> <span class="skolem">f</span> <span class="bound">n</span> <span class="main">≠</span> dim_col <span class="free">A</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">⟦</span><span class="free">A</span> <span class="main">∈</span> carrier_mat <span class="main">(</span>dim_row <span class="free">A</span><span class="main">)</span> <span class="main">(</span>dim_col <span class="free">A</span><span class="main">)</span><span class="main">;</span> pivot_fun <span class="free">A</span> <span class="skolem">f</span> <span class="main">(</span>dim_col <span class="free">A</span><span class="main">)</span><span class="main">⟧</span> <span class="main">⟹</span> set <span class="main">(</span>pivot_positions <span class="free">A</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="main">(</span><span class="bound">i</span><span class="main">,</span> <span class="skolem">f</span> <span class="bound">i</span><span class="main">)</span> <span class="main">|</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> dim_row <span class="free">A</span> <span class="main">∧</span> <span class="skolem">f</span> <span class="bound">i</span> <span class="main">≠</span> dim_col <span class="free">A</span><span class="main">}</span>›</span></span> <span class="quoted"><span class="quoted">‹pivot_fun <span class="free">A</span> <span class="skolem">f</span> <span class="main">(</span>dim_col <span class="free">A</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> <span class="quoted"><span class="quoted">‹<span class="main">⋀</span><span class="bound">A</span><span class="main">.</span> <span class="main">⟦</span>row_echelon_form <span class="bound">A</span><span class="main">;</span> dim_row <span class="bound">A</span> <span class="main">≤</span> dim_col <span class="bound">A</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="main">∀</span><span class="bound"><span class="bound">i</span></span><span class="main">&lt;</span>length <span class="main">(</span>pivot_positions <span class="bound">A</span><span class="main">)</span><span class="main">.</span> fst <span class="main">(</span>pivot_positions <span class="bound">A</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">=</span> <span class="bound">i</span>›</span></span> dim_h fst_conv j_nc row_ech<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> w_is<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?w</span> <span class="main">=</span> <span class="skolem">f</span> <span class="skolem">j</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> h1 j_lt nth_map snd_conv<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> h0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">=</span> <span class="skolem">j</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">(</span>cols <span class="free">A</span><span class="main">)</span> <span class="main">!</span> <span class="var">?w</span><span class="main">)</span> <span class="main">$</span> <span class="skolem">i</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> w_is pivot_funD<span class="main">(</span>4<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">A</span></span> <span class="var"><span class="quoted"><span class="var">?nr</span></span></span> <span class="quoted"><span class="skolem">f</span></span> <span class="var"><span class="quoted"><span class="var">?nc</span></span></span> <span class="quoted"><span class="skolem">i</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span><span class="bound">a</span><span class="main">.</span> List.member <span class="main">(</span>map snd <span class="main">(</span>pivot_positions <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="bound">a</span> <span class="main">⟶</span> <span class="bound">a</span> <span class="main">&lt;</span> dim_col <span class="free">A</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="main">(</span>pivot_positions <span class="free">A</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹pivot_fun <span class="free">A</span> <span class="skolem">f</span> <span class="main">(</span>dim_col <span class="free">A</span><span class="main">)</span>›</span></span> cols_length i_lt in_set_member length_asm mat_of_cols_cols mat_of_cols_index nth_mem<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> h1<span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">≠</span> <span class="skolem">j</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">(</span>cols <span class="free">A</span><span class="main">)</span> <span class="main">!</span> <span class="var">?w</span><span class="main">)</span> <span class="main">$</span> <span class="skolem">i</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> w_is pivot_funD<span class="main">(</span>5<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span><span class="bound">a</span><span class="main">.</span> List.member <span class="main">(</span>map snd <span class="main">(</span>pivot_positions <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="bound">a</span> <span class="main">⟶</span> <span class="bound">a</span> <span class="main">&lt;</span> dim_col <span class="free">A</span>›</span></span> <span class="quoted"><span class="quoted">‹pivot_fun <span class="free">A</span> <span class="skolem">f</span> <span class="main">(</span>dim_col <span class="free">A</span><span class="main">)</span>›</span></span> cols_length h1 i_lt in_set_member j_lt len_lt length_asm less_le_trans mat_of_cols_cols mat_of_cols_index nth_mem<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>mat_of_cols <span class="main">(</span>dim_row <span class="free">A</span><span class="main">)</span> <span class="main">(</span>map <span class="main">(</span><span class="main">(!)</span> <span class="main">(</span>cols <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>map snd <span class="main">(</span>pivot_positions <span class="free">A</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">$$</span> <span class="main">(</span><span class="skolem">i</span><span class="main">,</span> <span class="skolem">j</span><span class="main">)</span> 
        <span class="main">=</span> <span class="main">(</span><span class="keyword1">1<span class="hidden">⇩</span><sub>m</sub></span> <span class="main">(</span>length <span class="main">(</span>pivot_positions <span class="free">A</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">$$</span> <span class="main">(</span><span class="skolem">i</span><span class="main">,</span> <span class="skolem">j</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> h0 h1 breaking_it_down
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="main">(</span>pivot_positions <span class="free">A</span><span class="main">)</span>›</span></span> h2 h_len index_one_mat<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> j_lt len_lt<span class="main">)</span> 
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">have</span></span> h1b<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">≥</span> <span class="main">(</span>length <span class="var">?pp</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">(</span>mat_of_cols <span class="main">(</span>dim_row <span class="free">A</span><span class="main">)</span> <span class="main">(</span>map <span class="main">(</span><span class="main">(!)</span> <span class="main">(</span>cols <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>map snd <span class="main">(</span>pivot_positions <span class="free">A</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">$$</span> <span class="main">(</span><span class="skolem">i</span><span class="main">,</span> <span class="skolem">j</span><span class="main">)</span>  <span class="main">=</span> <span class="main">0</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
      <span class="keyword3"><span class="command">assume</span></span> i_gt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">≥</span> <span class="main">(</span>length <span class="var">?pp</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> h0a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span>cols <span class="free">A</span><span class="main">)</span> <span class="main">!</span> <span class="main">(</span><span class="main">(</span>map snd <span class="main">(</span>pivot_positions <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">)</span><span class="main">)</span> <span class="main">$</span> <span class="skolem">i</span> <span class="main">=</span> <span class="main">(</span>row <span class="free">A</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">$</span> <span class="var">?w</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span><span class="bound">a</span><span class="main">.</span> List.member <span class="main">(</span>map snd <span class="main">(</span>pivot_positions <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="bound">a</span> <span class="main">⟶</span> <span class="bound">a</span> <span class="main">&lt;</span> dim_col <span class="free">A</span>›</span></span> cols_length h1 i_lt in_set_member index_row<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> j_lt length_asm mat_of_cols_cols mat_of_cols_index nth_mem<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> h0b<span class="main">:</span> 
        <span class="quoted"><span class="quoted">"take_rows <span class="free">A</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="main">(</span>pivot_positions <span class="free">A</span><span class="main">)</span><span class="main">]</span> <span class="keyword1">@<span class="hidden">⇩</span><sub>r</sub></span> <span class="keyword1">0<span class="hidden">⇩</span><sub>m</sub></span> <span class="main">(</span>dim_row <span class="free">A</span> <span class="main">-</span> length <span class="main">(</span>pivot_positions <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>dim_col <span class="free">A</span><span class="main">)</span> <span class="main">=</span> <span class="free">A</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> assms row_echelon_form_zero_rows<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">A</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> h0c<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>row <span class="free">A</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">0<span class="hidden">⇩</span><sub>v</sub></span> <span class="main">(</span>dim_col <span class="free">A</span><span class="main">)</span>"</span></span>  <span class="keyword1"><span class="command">using</span></span> i_gt
        <span class="keyword1"><span class="command">using</span></span> add_diff_cancel_right' add_less_cancel_left diff_is_0_eq' dim_col_take_rows dim_row_append_rows i_lt index_zero_mat<span class="main">(</span>2<span class="main">)</span> index_zero_mat<span class="main">(</span>3<span class="main">)</span> le_add_diff_inverse len_lt less_not_refl3 row_append_rows row_zero zero_less_diff
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> add_diff_cancel_right' add_less_cancel_left diff_is_0_eq' dim_col_take_rows dim_row_append_rows i_lt index_zero_mat<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> index_zero_mat<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> le_add_diff_inverse len_lt less_not_refl3 row_append_rows row_zero zero_less_diff<span class="main">)</span> 
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> h0a breaking_it_down <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span><span class="bound">a</span><span class="main">.</span> List.member <span class="main">(</span>map snd <span class="main">(</span>pivot_positions <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="bound">a</span> <span class="main">⟶</span> <span class="bound">a</span> <span class="main">&lt;</span> dim_col <span class="free">A</span>›</span></span> h1 in_set_member index_zero_vec<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> j_lt length_asm nth_mem<span class="main">)</span> 
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">have</span></span> h1<span class="main">:</span> <span class="quoted"><span class="quoted">" mat_of_cols <span class="main">(</span>dim_row <span class="free">A</span><span class="main">)</span>
     <span class="main">(</span>map <span class="main">(</span><span class="main">(!)</span> <span class="main">(</span>cols <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>map snd <span class="main">(</span>pivot_positions <span class="free">A</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">$$</span> <span class="main">(</span><span class="skolem">i</span><span class="main">,</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">=</span>
           <span class="main">(</span><span class="keyword1">1<span class="hidden">⇩</span><sub>m</sub></span> <span class="main">(</span>length <span class="main">(</span>pivot_positions <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">@<span class="hidden">⇩</span><sub>r</sub></span>
            <span class="keyword1">0<span class="hidden">⇩</span><sub>m</sub></span> <span class="main">(</span>dim_row <span class="free">A</span> <span class="main">-</span> length <span class="main">(</span>pivot_positions <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>length <span class="main">(</span>pivot_positions <span class="free">A</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">$$</span>
           <span class="main">(</span><span class="skolem">i</span><span class="main">,</span> <span class="skolem">j</span><span class="main">)</span> "</span></span> <span class="keyword1"><span class="command">using</span></span> h1a h1b
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> add_diff_inverse_nat add_less_cancel_left append_rows_index h1 i_lt index_one_mat<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> index_one_mat<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> index_zero_mat<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> index_zero_mat<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> index_zero_mat<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> j_lt len_lt not_less<span class="main">)</span>  
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"take_cols <span class="free">A</span> <span class="main">(</span>map snd <span class="main">(</span>pivot_positions <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">$$</span> <span class="main">(</span><span class="skolem">i</span><span class="main">,</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">=</span>
           <span class="main">(</span><span class="keyword1">1<span class="hidden">⇩</span><sub>m</sub></span> <span class="main">(</span>length <span class="main">(</span>pivot_positions <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">@<span class="hidden">⇩</span><sub>r</sub></span>
            <span class="keyword1">0<span class="hidden">⇩</span><sub>m</sub></span> <span class="main">(</span>dim_row <span class="free">A</span> <span class="main">-</span> length <span class="main">(</span>pivot_positions <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>length <span class="main">(</span>pivot_positions <span class="free">A</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">$$</span>
           <span class="main">(</span><span class="skolem">i</span><span class="main">,</span> <span class="skolem">j</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">unfolding</span></span> take_cols_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> h2b<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> mat_eq_iff
    <span class="keyword1"><span class="command">using</span></span> length_pivot_positions_dim_row<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> h_len h2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="More_Matrix-rref_right_mul"><span class="command">lemma</span></span> rref_right_mul<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"row_echelon_form <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"dim_col <span class="free">A</span> <span class="main">≥</span> dim_row <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"take_cols <span class="free">A</span> <span class="main">(</span>map snd <span class="main">(</span>pivot_positions <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> take_rows <span class="free">A</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="main">(</span>pivot_positions <span class="free">A</span><span class="main">)</span><span class="main">]</span> <span class="main">=</span> <span class="free">A</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> take_cols_pivot_eq<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span>
    1<span class="main">:</span> <span class="quoted"><span class="quoted">"take_cols <span class="free">A</span> <span class="main">(</span>map snd <span class="main">(</span>pivot_positions <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
    <span class="keyword1">1<span class="hidden">⇩</span><sub>m</sub></span> <span class="main">(</span>length <span class="main">(</span>pivot_positions <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">@<span class="hidden">⇩</span><sub>r</sub></span>
    <span class="keyword1">0<span class="hidden">⇩</span><sub>m</sub></span> <span class="main">(</span>dim_row <span class="free">A</span> <span class="main">-</span> length <span class="main">(</span>pivot_positions <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>length <span class="main">(</span>pivot_positions <span class="free">A</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"take_cols <span class="free">A</span> <span class="main">(</span>map snd <span class="main">(</span>pivot_positions <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> take_rows <span class="free">A</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="main">(</span>pivot_positions <span class="free">A</span><span class="main">)</span><span class="main">]</span> <span class="main">=</span>
    take_rows <span class="free">A</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="main">(</span>pivot_positions <span class="free">A</span><span class="main">)</span><span class="main">]</span>  <span class="keyword1">@<span class="hidden">⇩</span><sub>r</sub></span> <span class="keyword1">0<span class="hidden">⇩</span><sub>m</sub></span> <span class="main">(</span>dim_row <span class="free">A</span> <span class="main">-</span> length <span class="main">(</span>pivot_positions <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>dim_col <span class="free">A</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> 1
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> append_rows_mat_mul<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> add_diff_cancel_right' assms diff_diff_cancel dim_col_take_rows dim_row_append_rows index_zero_mat<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> left_mult_one_mat' left_mult_zero_mat' length_pivot_positions_dim_row row_echelon_form_zero_rows<span class="main">)</span>   
  <span class="keyword1"><span class="command">from</span></span> row_echelon_form_zero_rows<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted">"2"</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">context</span></span> conjugatable_vec_space <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="More_Matrix-lin_indpt_id"><span class="command">lemma</span></span> lin_indpt_id<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"lin_indpt <span class="main">(</span>set <span class="main">(</span>cols <span class="main">(</span><span class="keyword1">1<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">n</span><span class="main">)</span><span class="main">::</span><span class="tfree">'a</span> vec list<span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>cols <span class="main">(</span><span class="keyword1">1<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">n</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> set <span class="main">(</span>rows <span class="main">(</span><span class="keyword1">1<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">n</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> cols_transpose transpose_one<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"det <span class="main">(</span><span class="keyword1">1<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">n</span><span class="main">)</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> det_one <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> det_not_0_imp_lin_indpt_rows<span class="main">[</span><span class="operator">OF</span> _ this<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"lin_indpt <span class="main">(</span>set <span class="main">(</span>rows <span class="main">(</span><span class="keyword1">1<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> one_carrier_mat <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> *<span class="main">)</span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="More_Matrix-lin_indpt_take_cols_id"><span class="command">lemma</span></span> lin_indpt_take_cols_id<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"lin_indpt <span class="main">(</span>set <span class="main">(</span>cols <span class="main">(</span>take_cols <span class="main">(</span><span class="keyword1">1<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">n</span><span class="main">)</span> <span class="free">inds</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
  <span class="keyword1"><span class="command">have</span></span> subset_h<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>cols <span class="main">(</span>take_cols <span class="main">(</span><span class="keyword1">1<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">n</span><span class="main">)</span> <span class="free">inds</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> set <span class="main">(</span>cols <span class="main">(</span><span class="keyword1">1<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">n</span><span class="main">)</span><span class="main">::</span><span class="tfree">'a</span> vec list<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> cols_take_cols_subset <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> lin_indpt_id subset_li_is_li <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="More_Matrix-cols_id_unit_vecs"><span class="command">lemma</span></span> cols_id_unit_vecs<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"cols <span class="main">(</span><span class="keyword1">1<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">d</span><span class="main">)</span> <span class="main">=</span> unit_vecs <span class="free">d</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> unit_vecs_def list_eq_iff_nth_eq
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="More_Matrix-distinct_cols_id"><span class="command">lemma</span></span> distinct_cols_id<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>cols <span class="main">(</span><span class="keyword1">1<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">d</span><span class="main">)</span><span class="main">::</span><span class="tfree">'a</span> vec list<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> conjugatable_vec_space.cols_id_unit_vecs vec_space.unit_vecs_distinct<span class="main">)</span>

<span class="keyword1" id="More_Matrix-distinct_map_nth"><span class="command">lemma</span></span> distinct_map_nth<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"distinct <span class="free">ls</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"distinct <span class="free">inds</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">j</span><span class="main">.</span> <span class="bound">j</span> <span class="main">∈</span> set <span class="free">inds</span> <span class="main">⟹</span> <span class="bound">j</span> <span class="main">&lt;</span> length <span class="free">ls</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>map <span class="main">(</span><span class="main">(!)</span> <span class="free">ls</span><span class="main">)</span> <span class="free">inds</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> distinct_map inj_on_nth<span class="main">)</span>

<span class="keyword1" id="More_Matrix-distinct_take_cols_id"><span class="command">lemma</span></span> distinct_take_cols_id<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"distinct <span class="free">inds</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>cols <span class="main">(</span>take_cols <span class="main">(</span><span class="keyword1">1<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">n</span><span class="main">)</span> <span class="free">inds</span><span class="main">)</span> <span class="main">::</span> <span class="tfree">'a</span> vec list<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> take_cols_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> cols_mat_of_cols<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span>  distinct_map_nth <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> distinct_cols_id<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> assms distinct_filter <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="More_Matrix-rank_take_cols"><span class="command">lemma</span></span> rank_take_cols<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"distinct <span class="free">inds</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"rank <span class="main">(</span>take_cols <span class="main">(</span><span class="keyword1">1<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">n</span><span class="main">)</span> <span class="free">inds</span><span class="main">)</span> <span class="main">=</span> length <span class="main">(</span>filter <span class="main">(</span><span class="main">(&gt;)</span> <span class="free">n</span><span class="main">)</span> <span class="free">inds</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> lin_indpt_full_rank<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted">"length <span class="main"><span class="main">(</span></span>filter <span class="main"><span class="main">(</span></span><span class="main"><span class="main">(&gt;)</span></span> <span class="free"><span class="free">n</span></span><span class="main"><span class="main">)</span></span> <span class="free"><span class="free">inds</span></span><span class="main"><span class="main">)</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lin_indpt_take_cols_id<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> index_one_mat<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> index_one_mat<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> length_map mat_of_cols_carrier<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> take_cols_def<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms distinct_take_cols_id<span class="main">)</span>

<span class="keyword1" id="More_Matrix-rank_mul_left_invertible_mat"><span class="command">lemma</span></span> rank_mul_left_invertible_mat<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span> mat"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"invertible_mat <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">∈</span> carrier_mat <span class="free">n</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">B</span> <span class="main">∈</span> carrier_mat <span class="free">n</span> <span class="free">nc</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"rank <span class="main">(</span><span class="free">A</span> <span class="main">*</span> <span class="free">B</span><span class="main">)</span> <span class="main">=</span> rank <span class="free">B</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">C</span></span> <span class="keyword2"><span class="keyword">where</span></span> C<span class="main">:</span> <span class="quoted"><span class="quoted">"inverts_mat <span class="free">A</span> <span class="skolem">C</span>"</span></span> <span class="quoted"><span class="quoted">"inverts_mat <span class="skolem">C</span> <span class="free">A</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms invertible_mat_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
  <span class="keyword1"><span class="command">from</span></span> C <span class="keyword1"><span class="command">have</span></span> ceq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">C</span> <span class="main">*</span> <span class="free">A</span> <span class="main">=</span> <span class="keyword1">1<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> carrier_matD<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> index_mult_mat<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> index_one_mat<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> inverts_mat_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="free">B</span> <span class="main">=</span> <span class="skolem">C</span><span class="main">*</span><span class="free">A</span><span class="main">*</span><span class="free">B</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> rank_mat_mul_left<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>2-3<span class="main"><span class="main">)</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> **<span class="main">:</span> <span class="quoted"><span class="quoted">"rank <span class="main">(</span><span class="free">A</span><span class="main">*</span><span class="free">B</span><span class="main">)</span> <span class="main">≤</span> rank <span class="free">B</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">C</span> <span class="main">∈</span> carrier_mat <span class="free">n</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> C ceq
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> carrier_matD<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> carrier_matI index_mult_mat<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> index_one_mat<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> inverts_mat_def<span class="main">)</span> 
  <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">*</span> <span class="free">B</span> <span class="main">∈</span> carrier_mat <span class="free">n</span> <span class="free">nc</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>  
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"rank <span class="free">B</span> <span class="main">=</span> rank <span class="main">(</span><span class="skolem">C</span><span class="main">*</span> <span class="free">A</span> <span class="main">*</span> <span class="free">B</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> * <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">≤</span> rank <span class="main">(</span><span class="free">A</span><span class="main">*</span><span class="free">B</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> rank_mat_mul_left<span class="main">[</span><span class="operator">OF</span> 1 2<span class="main">]</span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"1"</span> assms<span class="main">(</span>2<span class="main">)</span> assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> ** <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="More_Matrix-invertible_take_cols_rank"><span class="command">lemma</span></span> invertible_take_cols_rank<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span> mat"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"invertible_mat <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">∈</span> carrier_mat <span class="free">n</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"distinct <span class="free">inds</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"rank <span class="main">(</span>take_cols <span class="free">A</span> <span class="free">inds</span><span class="main">)</span> <span class="main">=</span> length <span class="main">(</span>filter <span class="main">(</span><span class="main">(&gt;)</span> <span class="free">n</span><span class="main">)</span> <span class="free">inds</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">" <span class="free">A</span> <span class="main">=</span> <span class="free">A</span> <span class="main">*</span> <span class="keyword1">1<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"take_cols <span class="free">A</span> <span class="free">inds</span> <span class="main">=</span> <span class="free">A</span> <span class="main">*</span> take_cols <span class="main">(</span><span class="keyword1">1<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">n</span><span class="main">)</span> <span class="free">inds</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> one_carrier_mat take_cols_mat_mul<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"rank <span class="main">(</span>take_cols <span class="free">A</span> <span class="free">inds</span><span class="main">)</span> <span class="main">=</span> rank <span class="main">(</span>take_cols <span class="main">(</span><span class="keyword1">1<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">n</span><span class="main">)</span> <span class="free">inds</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> conjugatable_vec_space.rank_mul_left_invertible_mat one_carrier_mat take_cols_carrier_mat<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> conjugatable_vec_space.rank_take_cols<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="More_Matrix-rank_take_cols_leq"><span class="command">lemma</span></span> rank_take_cols_leq<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> R<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="main">∈</span> carrier_mat <span class="free">n</span> <span class="free">nc</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"rank <span class="main">(</span>take_cols <span class="free">R</span> <span class="free">ls</span><span class="main">)</span> <span class="main">≤</span> rank <span class="free">R</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> take_cols_mat_mul<span class="main">[</span><span class="operator">OF</span> R<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"take_cols <span class="free">R</span> <span class="free">ls</span> <span class="main">=</span>  <span class="free">R</span> <span class="main">*</span> take_cols <span class="main">(</span><span class="keyword1">1<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">nc</span><span class="main">)</span> <span class="free">ls</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms one_carrier_mat right_mult_one_mat<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms one_carrier_mat take_cols_carrier_mat vec_space.rank_mat_mul_right<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="More_Matrix-rank_take_cols_geq"><span class="command">lemma</span></span> rank_take_cols_geq<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> R<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="main">∈</span> carrier_mat <span class="free">n</span> <span class="free">nc</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> t<span class="main">:</span><span class="quoted"><span class="quoted">"take_cols <span class="free">R</span> <span class="free">ls</span> <span class="main">∈</span> carrier_mat <span class="free">n</span> <span class="free">r</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> B<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="free">B</span> <span class="main">∈</span> carrier_mat <span class="free">r</span> <span class="free">nc</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="main">=</span> <span class="main">(</span>take_cols <span class="free">R</span> <span class="free">ls</span><span class="main">)</span> <span class="main">*</span> <span class="free">B</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"rank <span class="main">(</span>take_cols <span class="free">R</span> <span class="free">ls</span><span class="main">)</span> <span class="main">≥</span> rank <span class="free">R</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> B assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> t vec_space.rank_mat_mul_right<span class="main">)</span>

<span class="keyword1" id="More_Matrix-rref_drop_pivots"><span class="command">lemma</span></span> rref_drop_pivots<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> row_ech<span class="main">:</span> <span class="quoted"><span class="quoted">"row_echelon_form <span class="free">R</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> dims<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="main">∈</span> carrier_mat <span class="free">n</span> <span class="free">nc</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> order<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">nc</span> <span class="main">≥</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"rank <span class="main">(</span>take_cols <span class="free">R</span> <span class="main">(</span>map snd <span class="main">(</span>pivot_positions <span class="free">R</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> rank <span class="free">R</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?B</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"take_rows <span class="free">R</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="main">(</span>pivot_positions <span class="free">R</span><span class="main">)</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> equa<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="main">=</span> take_cols <span class="free">R</span> <span class="main">(</span>map snd <span class="main">(</span>pivot_positions <span class="free">R</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="var">?B</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms rref_right_mul
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> carrier_matD<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> carrier_matD<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> ex_r<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">r</span><span class="main">.</span> take_cols <span class="free">R</span> <span class="main">(</span>map snd <span class="main">(</span>pivot_positions <span class="free">R</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> carrier_mat <span class="free">n</span> <span class="bound">r</span> <span class="main">∧</span> <span class="var">?B</span> <span class="main">∈</span> carrier_mat <span class="bound">r</span> <span class="free">nc</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
    <span class="keyword1"><span class="command">have</span></span> h1<span class="main">:</span>
      <span class="quoted"><span class="quoted">"take_cols <span class="free">R</span> <span class="main">(</span>map snd <span class="main">(</span>pivot_positions <span class="free">R</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> carrier_mat <span class="free">n</span> <span class="main">(</span>length <span class="main">(</span>pivot_positions <span class="free">R</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> in_set_impl_in_set_zip2 length_map rref_pivot_positions take_cols_carrier_mat_strict zip_map_fst_snd<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">f</span><span class="main">.</span> pivot_fun <span class="free">R</span> <span class="bound">f</span> <span class="free">nc</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> row_ech <span class="keyword1"><span class="command">unfolding</span></span> row_echelon_form_def <span class="keyword1"><span class="command">using</span></span> dims
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>pivot_positions <span class="free">R</span><span class="main">)</span> <span class="main">=</span> card <span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="free">n</span> <span class="main">∧</span> row <span class="free">R</span> <span class="bound">i</span> <span class="main">≠</span> <span class="keyword1">0<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">nc</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> pivot_positions<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">R</span></span></span></span></span></span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">n</span></span></span></span></span></span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">nc</span></span></span></span></span></span></span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">using</span></span> dims <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">nc</span> <span class="main">≥</span> length <span class="main">(</span>pivot_positions <span class="free">R</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> order
      <span class="keyword1"><span class="command">using</span></span> carrier_matD<span class="main">(</span>1<span class="main">)</span> dims dual_order.trans length_pivot_positions_dim_row row_ech <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"dim_col <span class="free">R</span> <span class="main">≥</span> length <span class="main">(</span>pivot_positions <span class="free">R</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> dims <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> h2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?B</span> <span class="main">∈</span> carrier_mat <span class="main">(</span>length <span class="main">(</span>pivot_positions <span class="free">R</span><span class="main">)</span><span class="main">)</span> <span class="free">nc</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> take_rows_def
      <span class="keyword1"><span class="command">using</span></span> dims 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> atLeastLessThan_iff carrier_matD<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> filter_True le_eq_less_or_eq length_map length_pivot_positions_dim_row less_trans map_nth mat_of_cols_carrier<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> row_ech set_upt transpose_carrier_mat transpose_mat_of_rows<span class="main">)</span> 
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> h1 h2
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
    <span class="comment1">(* prove the other two dimensionality assumptions *)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"rank <span class="free">R</span>  <span class="main">≤</span> rank <span class="main">(</span>take_cols <span class="free">R</span> <span class="main">(</span>map snd <span class="main">(</span>pivot_positions <span class="free">R</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> dims ex_r rank_take_cols_geq<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> R <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="free">R</span>"</span></span><span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> B <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="var">?B</span>"</span></span><span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> ls <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>map snd <span class="main">(</span>pivot_positions <span class="free">R</span><span class="main">)</span><span class="main">)</span>"</span></span><span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> nc <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="free">nc</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">using</span></span> equa <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> conjugatable_vec_space.rank_take_cols_leq le_antisym <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="More_Matrix-gjs_and_take_cols_var"><span class="command">lemma</span></span> gjs_and_take_cols_var<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span> mat"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> A<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">∈</span> carrier_mat <span class="free">n</span> <span class="free">nc</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> order<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">nc</span> <span class="main">≥</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>take_cols <span class="free">A</span> <span class="main">(</span>map snd <span class="main">(</span>pivot_positions <span class="main">(</span>gauss_jordan_single <span class="free">A</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
  <span class="main">(</span>take_cols_var <span class="free">A</span> <span class="main">(</span>map snd <span class="main">(</span>pivot_positions <span class="main">(</span>gauss_jordan_single <span class="free">A</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?gjs</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>gauss_jordan_single <span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">.</span> List.member <span class="main">(</span>map snd <span class="main">(</span>pivot_positions <span class="main">(</span>gauss_jordan_single <span class="free">A</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="bound">x</span> <span class="main">⟶</span> <span class="bound">x</span> <span class="main">≤</span> dim_col <span class="free">A</span>"</span></span>  
    <span class="keyword1"><span class="command">using</span></span> rref_pivot_positions gauss_jordan_single<span class="main">(</span>3<span class="main">)</span> carrier_matD<span class="main">(</span>2<span class="main">)</span> gauss_jordan_single<span class="main">(</span>2<span class="main">)</span> in_set_impl_in_set_zip2 in_set_member length_map less_irrefl less_trans not_le_imp_less zip_map_fst_snd
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> A carrier_matD<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> gauss_jordan_single<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> in_set_impl_in_set_zip2 in_set_member length_map less_irrefl less_trans not_le_imp_less zip_map_fst_snd<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">&lt;</span> dim_col <span class="free">A</span><span class="main">)</span> <span class="main">(</span>map snd <span class="main">(</span>pivot_positions <span class="main">(</span>gauss_jordan_single <span class="free">A</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
    <span class="main">(</span>map snd <span class="main">(</span>pivot_positions <span class="main">(</span>gauss_jordan_single <span class="free">A</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> A carrier_matD<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> filter_True gauss_jordan_single<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> gauss_jordan_single<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> in_set_impl_in_set_zip2 length_map rref_pivot_positions zip_map_fst_snd<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> take_cols_def take_cols_var_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="More_Matrix-gauss_jordan_single_rank"><span class="command">lemma</span></span> gauss_jordan_single_rank<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span> mat"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> A<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">∈</span> carrier_mat <span class="free">n</span> <span class="free">nc</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> order<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">nc</span> <span class="main">≥</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"rank <span class="main">(</span>take_cols <span class="free">A</span> <span class="main">(</span>map snd <span class="main">(</span>pivot_positions <span class="main">(</span>gauss_jordan_single <span class="free">A</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> rank <span class="free">A</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?R</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"gauss_jordan_single <span class="free">A</span>"</span></span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">P</span></span> <span class="keyword2"><span class="keyword">where</span></span> P<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">P</span><span class="main">∈</span>Units <span class="main">(</span>ring_mat <span class="keyword1">TYPE</span><span class="main">(</span><span class="tfree">'a</span><span class="main">)</span> <span class="free">n</span> undefined<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?R</span> <span class="main">=</span> <span class="skolem">P</span> <span class="main">*</span> <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> gauss_jordan_transform<span class="main">[</span><span class="operator">OF</span> A<span class="main">]</span>
    <span class="keyword1"><span class="command">using</span></span> A assms det_mult det_non_zero_imp_unit det_one gauss_jordan_single<span class="main">(</span>4<span class="main">)</span> mult_not_zero one_neq_zero
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> A assms det_mult det_non_zero_imp_unit det_one gauss_jordan_single<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> mult_not_zero one_neq_zero<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> pcarrier<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main">∈</span> carrier_mat <span class="free">n</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> P <span class="keyword1"><span class="command">unfolding</span></span> Units_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ring_mat_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"invertible_mat <span class="skolem">P</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> P <span class="keyword1"><span class="command">unfolding</span></span> invertible_mat_def Units_def inverts_mat_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ring_mat_simps<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> index_mult_mat<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> index_one_mat<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> ring_mat_simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> ring_mat_simps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Pi</span></span> <span class="keyword2"><span class="keyword">where</span></span> Pi<span class="main">:</span> <span class="quoted"><span class="quoted">"invertible_mat <span class="skolem">Pi</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Pi</span> <span class="main">*</span> <span class="skolem">P</span> <span class="main">=</span> <span class="keyword1">1<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">assume</span></span> a1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">Pi</span><span class="main">.</span> <span class="main">⟦</span>invertible_mat <span class="bound">Pi</span><span class="main">;</span> <span class="bound">Pi</span> <span class="main">*</span> <span class="skolem">P</span> <span class="main">=</span> <span class="keyword1">1<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">n</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="skolem">thesis</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"dim_row <span class="skolem">P</span> <span class="main">=</span> <span class="free">n</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> A assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> carrier_matD<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> gauss_jordan_single<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> i index_mult_mat<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> a1 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> <span class="quoted"><span class="quoted">‹invertible_mat <span class="skolem">P</span>›</span></span> index_mult_mat<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> index_one_mat<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> invertible_mat_def inverts_mat_def square_mat.simps<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> pi_carrier<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">Pi</span> <span class="main">∈</span> carrier_mat <span class="free">n</span> <span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> carrier_mat_triv index_mult_mat<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> index_one_mat<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> invertible_mat_def square_mat.simps<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> R1<span class="main">:</span><span class="quoted"><span class="quoted">"row_echelon_form <span class="var">?R</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> gauss_jordan_single<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> R2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?R</span> <span class="main">∈</span> carrier_mat <span class="free">n</span> <span class="free">nc</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> A assms<span class="main">(</span>2<span class="main">)</span> gauss_jordan_single<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> Rcm<span class="main">:</span> <span class="quoted"><span class="quoted">"take_cols <span class="var">?R</span> <span class="main">(</span>map snd <span class="main">(</span>pivot_positions <span class="var">?R</span><span class="main">)</span><span class="main">)</span>
    <span class="main">∈</span> carrier_mat <span class="free">n</span> <span class="main">(</span>length <span class="main">(</span>map snd <span class="main">(</span>pivot_positions <span class="var">?R</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> take_cols_carrier_mat_strict<span class="main"><span class="main">[</span></span><span class="operator">OF</span> R2<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> rref_pivot_positions<span class="main">[</span><span class="operator">OF</span> R1 R2<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Pi</span> <span class="main">*</span> <span class="var">?R</span> <span class="main">=</span> <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> i Pi
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> A <span class="quoted"><span class="quoted">‹invertible_mat <span class="skolem">P</span>›</span></span> assoc_mult_mat carrier_mat_triv index_mult_mat<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> index_mult_mat<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> index_one_mat<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> invertible_mat_def left_mult_one_mat square_mat.simps<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"rank <span class="main">(</span>take_cols <span class="free">A</span> <span class="main">(</span>map snd <span class="main">(</span>pivot_positions <span class="var">?R</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> rank <span class="main">(</span>take_cols <span class="main">(</span><span class="skolem">Pi</span> <span class="main">*</span> <span class="var">?R</span><span class="main">)</span> <span class="main">(</span>map snd <span class="main">(</span>pivot_positions <span class="var">?R</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> rank <span class="main">(</span> <span class="skolem">Pi</span> <span class="main">*</span> take_cols <span class="var">?R</span> <span class="main">(</span>map snd <span class="main">(</span>pivot_positions <span class="var">?R</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> A gauss_jordan_single<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> pi_carrier take_cols_mat_mul<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> rank <span class="main">(</span>take_cols <span class="var">?R</span> <span class="main">(</span>map snd <span class="main">(</span>pivot_positions <span class="var">?R</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> rank_mul_left_invertible_mat<span class="main"><span class="main">[</span></span><span class="operator">OF</span> Pi<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> pi_carrier Rcm<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> rank <span class="var">?R</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> conjugatable_vec_space.rref_drop_pivots gauss_jordan_single<span class="main">(</span>3<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> R1 R2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>                                                            
    <span class="keyword1"><span class="command">using</span></span> A <span class="quoted"><span class="quoted">‹<span class="skolem">P</span> <span class="main">∈</span> carrier_mat <span class="free">n</span> <span class="free">n</span>›</span></span> <span class="quoted"><span class="quoted">‹invertible_mat <span class="skolem">P</span>›</span></span> conjugatable_vec_space.rank_mul_left_invertible_mat i
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="More_Matrix-lin_indpt_subset_cols"><span class="command">lemma</span></span> lin_indpt_subset_cols<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span><span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> mat"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">B</span><span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> vec set"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">∈</span> carrier_mat <span class="free">n</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> inv<span class="main">:</span> <span class="quoted"><span class="quoted">"invertible_mat <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">B</span> <span class="main">⊆</span> set <span class="main">(</span>cols <span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"lin_indpt <span class="free">B</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"det <span class="free">A</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> inv invertible_det <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"lin_indpt <span class="main">(</span>set <span class="main">(</span>rows <span class="free">A</span><span class="keyword1"><span class="hidden">⇧</span><sup>T</sup></span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> idom_vec.lin_dep_cols_imp_det_0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> subset_li_is_li assms<span class="main">(</span>3<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="More_Matrix-rank_invertible_subset_cols"><span class="command">lemma</span></span> rank_invertible_subset_cols<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span><span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> mat"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">B</span><span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> vec list"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> inv<span class="main">:</span> <span class="quoted"><span class="quoted">"invertible_mat <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> A_square<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">∈</span> carrier_mat <span class="free">n</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> set_sub<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span><span class="free">B</span><span class="main">)</span> <span class="main">⊆</span> set <span class="main">(</span>cols <span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> dist_B<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="free">B</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"rank <span class="main">(</span>mat_of_cols <span class="free">n</span> <span class="free">B</span><span class="main">)</span> <span class="main">=</span> length <span class="free">B</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?B_mat</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>mat_of_cols <span class="free">n</span> <span class="free">B</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> h1<span class="main">:</span> <span class="quoted"><span class="quoted">"lin_indpt <span class="main">(</span>set<span class="main">(</span><span class="free">B</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> assms lin_indpt_subset_cols<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">A</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="free">B</span> <span class="main">⊆</span> carrier_vec <span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> set_sub A_square cols_dim<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">A</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> cols_B<span class="main">:</span> <span class="quoted"><span class="quoted">"cols <span class="main">(</span>mat_of_cols <span class="free">n</span> <span class="free">B</span><span class="main">)</span> <span class="main">=</span> <span class="free">B</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> cols_mat_of_cols <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"maximal <span class="main">(</span>set <span class="free">B</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">T</span><span class="main">.</span> <span class="bound">T</span> <span class="main">⊆</span> set <span class="main">(</span><span class="free">B</span><span class="main">)</span> <span class="main">∧</span> lin_indpt <span class="bound">T</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> h1
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> maximal_def subset_antisym<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> h2<span class="main">:</span> <span class="quoted"><span class="quoted">"maximal <span class="main">(</span>set <span class="free">B</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">T</span><span class="main">.</span> <span class="bound">T</span> <span class="main">⊆</span> set <span class="main">(</span>cols <span class="main">(</span>mat_of_cols <span class="free">n</span> <span class="free">B</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> lin_indpt <span class="bound">T</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> cols_B <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> h3<span class="main">:</span> <span class="quoted"><span class="quoted">"rank <span class="main">(</span>mat_of_cols <span class="free">n</span> <span class="free">B</span><span class="main">)</span> <span class="main">=</span> card <span class="main">(</span>set <span class="free">B</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> h1 h2 rank_card_indpt<span class="main">[</span><span class="operator">of</span> <span class="var"><span class="quoted"><span class="var">?B_mat</span></span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">using</span></span> mat_of_cols_carrier<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms distinct_card <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="BKR_Algorithm">
<div class="head">
<h1>Theory BKR_Algorithm</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> BKR_Algorithm
  <span class="keyword2"><span class="keyword">imports</span></span>
    <span class="quoted">"<a href="#More_Matrix">More_Matrix</a>"</span>
    <span class="quoted">"<a href="../../sturm_tarski/theories/#Sturm_Tarski">Sturm_Tarski.Sturm_Tarski</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">"Setup"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">retrieve_polys</span><span class="main">::</span> <span class="quoted"><span class="quoted">"real poly list <span class="main">⇒</span> nat list <span class="main">⇒</span> real poly list"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">retrieve_polys</span> <span class="free"><span class="bound"><span class="entity">qss</span></span></span> <span class="free"><span class="bound"><span class="entity">index_list</span></span></span> <span class="main">=</span> <span class="main">(</span>map <span class="main">(</span>nth <span class="free"><span class="bound"><span class="entity">qss</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">index_list</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">construct_NofI</span><span class="main">::</span> <span class="quoted"><span class="quoted">"real poly <span class="main">⇒</span> real poly list <span class="main">⇒</span> rat"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">construct_NofI</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="main">=</span>  rat_of_int <span class="main">(</span>changes_R_smods <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">(</span><span class="main">(</span>pderiv <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span><span class="main">*</span><span class="main">(</span>prod_list <span class="free"><span class="bound"><span class="entity">I</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">construct_rhs_vector</span><span class="main">::</span> <span class="quoted"><span class="quoted">"real poly <span class="main">⇒</span> real poly list <span class="main">⇒</span> nat list list <span class="main">⇒</span> rat vec"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">construct_rhs_vector</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">qs</span></span></span> <span class="free"><span class="bound"><span class="entity">Is</span></span></span> <span class="main">=</span> vec_of_list <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span> <span class="bound">I</span><span class="main">.</span><span class="main">(</span>construct_NofI <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">(</span>retrieve_polys <span class="free"><span class="bound"><span class="entity">qs</span></span></span> <span class="bound">I</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">Is</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">"Base Case"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">base_case_info</span><span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>rat mat <span class="main">×</span> <span class="main">(</span>nat list list <span class="main">×</span> rat list list<span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">base_case_info</span> <span class="main">=</span>
    <span class="main">(</span><span class="main">(</span>mat_of_rows_list <span class="numeral">2</span> <span class="main">[</span><span class="main">[</span><span class="main">1</span><span class="main">,</span><span class="main">1</span><span class="main">]</span><span class="main">,</span> <span class="main">[</span><span class="main">1</span><span class="main">,</span><span class="main">-</span><span class="main">1</span><span class="main">]</span><span class="main">]</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="main">[</span><span class="main">[]</span><span class="main">,</span><span class="main">[</span><span class="main">0</span><span class="main">]</span><span class="main">]</span><span class="main">,</span> <span class="main">[</span><span class="main">[</span><span class="main">1</span><span class="main">]</span><span class="main">,</span><span class="main">[</span><span class="main">-</span><span class="main">1</span><span class="main">]</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="comment1">(* When p, q are coprime, this will actually be an int vec, which is why taking the floor is okay *)</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">base_case_solve_for_lhs</span><span class="main">::</span> <span class="quoted"><span class="quoted">"real poly <span class="main">⇒</span> real poly <span class="main">⇒</span> rat vec"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">base_case_solve_for_lhs</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">=</span> <span class="main">(</span>mult_mat_vec <span class="main">(</span>mat_of_rows_list <span class="numeral">2</span> <span class="main">[</span><span class="main">[</span><span class="main">1</span><span class="main">/</span><span class="numeral">2</span><span class="main">,</span> <span class="main">1</span><span class="main">/</span><span class="numeral">2</span><span class="main">]</span><span class="main">,</span> <span class="main">[</span><span class="main">1</span><span class="main">/</span><span class="numeral">2</span><span class="main">,</span> <span class="main">-</span><span class="main">1</span><span class="main">/</span><span class="numeral">2</span><span class="main">]</span><span class="main">]</span><span class="main">)</span>  <span class="main">(</span>construct_rhs_vector <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">]</span> <span class="main">[</span><span class="main">[]</span><span class="main">,</span> <span class="main">[</span><span class="main">0</span><span class="main">]</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">thm</span></span> <span class="quoted">"gauss_jordan_compute_inverse"</span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">matr_option</span><span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">::</span><span class="main">{</span>one<span class="main">,</span> zero<span class="main">}</span> mat option <span class="main">⇒</span> <span class="tfree">'a</span> mat"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">matr_option</span> <span class="free"><span class="bound"><span class="entity">dimen</span></span></span> None <span class="main">=</span> <span class="keyword1">1<span class="hidden">⇩</span><sub>m</sub></span> <span class="free"><span class="bound"><span class="entity">dimen</span></span></span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">matr_option</span> <span class="free"><span class="bound"><span class="entity">dimen</span></span></span> <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span>"</span></span> 

<span class="comment1">(* For smooth code export, we want to use a computable notion of matrix equality *)</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">mat_equal</span><span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span> field mat <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">::</span> field mat <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">mat_equal</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">=</span> <span class="main">(</span>dim_row <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">=</span> dim_row <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">∧</span> dim_col <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">=</span> dim_col <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">∧</span> <span class="main">(</span>mat_to_list <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>mat_to_list <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">mat_inverse_var</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> field mat <span class="main">⇒</span> <span class="tfree">'a</span> mat option"</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">mat_inverse_var</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> dim_row <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">=</span> dim_col <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="keyword1">then</span>
    <span class="keyword1">let</span> <span class="bound">one</span> <span class="main">=</span> <span class="keyword1">1<span class="hidden">⇩</span><sub>m</sub></span> <span class="main">(</span>dim_row <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span> <span class="keyword1">in</span>
    <span class="main">(</span><span class="keyword1">case</span> gauss_jordan <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="bound">one</span> <span class="keyword1">of</span>
      <span class="main">(</span><span class="bound">B</span><span class="main">,</span> <span class="bound">C</span><span class="main">)</span> <span class="main">⇒</span> <span class="keyword1">if</span> <span class="main">(</span>mat_equal <span class="bound">B</span> <span class="bound">one</span><span class="main">)</span> <span class="keyword1">then</span> Some <span class="bound">C</span> <span class="keyword1">else</span> None<span class="main">)</span> <span class="keyword1">else</span> None<span class="main">)</span>"</span></span>

<span class="comment1">(* Now solve for LHS in general. 
  Because mat_inverse returns an option type, we pattern match on this. 
  Notice that when we call this function in the algorithm, the matrix we pass will always be invertible,
  given how the construction works. *)</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">solve_for_lhs</span><span class="main">::</span> <span class="quoted"><span class="quoted">"real poly <span class="main">⇒</span> real poly list <span class="main">⇒</span> nat list list <span class="main">⇒</span> rat mat <span class="main">⇒</span> rat vec"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">solve_for_lhs</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">qs</span></span></span> <span class="free"><span class="bound"><span class="entity">subsets</span></span></span> <span class="free"><span class="bound"><span class="entity">matr</span></span></span> <span class="main">=</span>
     mult_mat_vec <span class="main">(</span>matr_option <span class="main">(</span>dim_row <span class="free"><span class="bound"><span class="entity">matr</span></span></span><span class="main">)</span> <span class="main">(</span>mat_inverse_var <span class="free"><span class="bound"><span class="entity">matr</span></span></span><span class="main">)</span><span class="main">)</span>  <span class="main">(</span>construct_rhs_vector <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">qs</span></span></span> <span class="free"><span class="bound"><span class="entity">subsets</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">"Smashing"</span></span> 

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">subsets_smash</span><span class="main">::</span><span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat list list <span class="main">⇒</span> nat list list <span class="main">⇒</span> nat list list"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">subsets_smash</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">s1</span></span></span> <span class="free"><span class="bound"><span class="entity">s2</span></span></span> <span class="main">=</span> concat <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">l1</span><span class="main">.</span> map <span class="main">(</span><span class="main">λ</span> <span class="bound">l2</span><span class="main">.</span> <span class="bound">l1</span> <span class="main">@</span> <span class="main">(</span>map <span class="main">(</span><span class="main">(+)</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="bound">l2</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">s2</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">s1</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">signs_smash</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list list <span class="main">⇒</span>  <span class="tfree">'a</span> list list <span class="main">⇒</span> <span class="tfree">'a</span> list list"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">signs_smash</span> <span class="free"><span class="bound"><span class="entity">s1</span></span></span> <span class="free"><span class="bound"><span class="entity">s2</span></span></span> <span class="main">=</span> concat <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">l1</span><span class="main">.</span> map <span class="main">(</span><span class="main">λ</span> <span class="bound">l2</span><span class="main">.</span> <span class="bound">l1</span> <span class="main">@</span> <span class="bound">l2</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">s2</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">s1</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">smash_systems</span><span class="main">::</span> <span class="quoted"><span class="quoted">"real poly <span class="main">⇒</span> real poly list <span class="main">⇒</span> real poly list <span class="main">⇒</span> nat list list <span class="main">⇒</span> nat list list <span class="main">⇒</span>
  rat list list <span class="main">⇒</span> rat list list <span class="main">⇒</span> rat mat <span class="main">⇒</span> rat mat <span class="main">⇒</span> 
  real poly list <span class="main">×</span> <span class="main">(</span>rat mat <span class="main">×</span> <span class="main">(</span>nat list list <span class="main">×</span> rat list list<span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">smash_systems</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">qs1</span></span></span> <span class="free"><span class="bound"><span class="entity">qs2</span></span></span> <span class="free"><span class="bound"><span class="entity">subsets1</span></span></span> <span class="free"><span class="bound"><span class="entity">subsets2</span></span></span> <span class="free"><span class="bound"><span class="entity">signs1</span></span></span> <span class="free"><span class="bound"><span class="entity">signs2</span></span></span> <span class="free"><span class="bound"><span class="entity">mat1</span></span></span> <span class="free"><span class="bound"><span class="entity">mat2</span></span></span> <span class="main">=</span>
    <span class="main">(</span><span class="free"><span class="bound"><span class="entity">qs1</span></span></span><span class="main">@</span><span class="free"><span class="bound"><span class="entity">qs2</span></span></span><span class="main">,</span> <span class="main">(</span>kronecker_product <span class="free"><span class="bound"><span class="entity">mat1</span></span></span> <span class="free"><span class="bound"><span class="entity">mat2</span></span></span><span class="main">,</span> <span class="main">(</span>subsets_smash <span class="main">(</span>length <span class="free"><span class="bound"><span class="entity">qs1</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">subsets1</span></span></span> <span class="free"><span class="bound"><span class="entity">subsets2</span></span></span><span class="main">,</span> signs_smash <span class="free"><span class="bound"><span class="entity">signs1</span></span></span> <span class="free"><span class="bound"><span class="entity">signs2</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">combine_systems</span><span class="main">::</span> <span class="quoted"><span class="quoted">"real poly <span class="main">⇒</span> <span class="main">(</span>real poly list <span class="main">×</span> <span class="main">(</span>rat mat <span class="main">×</span> <span class="main">(</span>nat list list <span class="main">×</span> rat list list<span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span>real poly list <span class="main">×</span> <span class="main">(</span>rat mat <span class="main">×</span> <span class="main">(</span>nat list list <span class="main">×</span> rat list list<span class="main">)</span><span class="main">)</span><span class="main">)</span>
  <span class="main">⇒</span> <span class="main">(</span>real poly list <span class="main">×</span> <span class="main">(</span>rat mat <span class="main">×</span> <span class="main">(</span>nat list list <span class="main">×</span> rat list list<span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">combine_systems</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">qs1</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">m1</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">sub1</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">sgn1</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">qs2</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">m2</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">sub2</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">sgn2</span></span></span><span class="main">)</span> <span class="main">=</span> 
    <span class="main">(</span>smash_systems <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">qs1</span></span></span> <span class="free"><span class="bound"><span class="entity">qs2</span></span></span> <span class="free"><span class="bound"><span class="entity">sub1</span></span></span> <span class="free"><span class="bound"><span class="entity">sub2</span></span></span> <span class="free"><span class="bound"><span class="entity">sgn1</span></span></span> <span class="free"><span class="bound"><span class="entity">sgn2</span></span></span> <span class="free"><span class="bound"><span class="entity">m1</span></span></span> <span class="free"><span class="bound"><span class="entity">m2</span></span></span><span class="main">)</span>"</span></span>

<span class="comment1">(* Overall:
  Start with a matrix equation.
  Input a matrix, subsets, and signs.
  Drop columns of the matrix based on the 0's on the LHS---so extract a list of 0's. Reduce signs accordingly.
  Then find a list of rows to delete based on using rank (use the transpose result, pivot positions!),
   and delete those rows.  Reduce subsets accordingly.
  End with a reduced system! *)</span>
<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">"Reduction"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">find_nonzeros_from_input_vec</span><span class="main">::</span> <span class="quoted"><span class="quoted">"rat vec <span class="main">⇒</span> nat list"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">find_nonzeros_from_input_vec</span> <span class="free"><span class="bound"><span class="entity">lhs_vec</span></span></span> <span class="main">=</span> filter <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">lhs_vec</span></span></span> <span class="main">$</span> <span class="bound">i</span> <span class="main">≠</span> <span class="main">0</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span> dim_vec <span class="free"><span class="bound"><span class="entity">lhs_vec</span></span></span><span class="main">]</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">take_indices</span><span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list <span class="main">⇒</span> nat list <span class="main">⇒</span> <span class="tfree">'a</span> list"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">take_indices</span> <span class="free"><span class="bound"><span class="entity">subsets</span></span></span> <span class="free"><span class="bound"><span class="entity">indices</span></span></span> <span class="main">=</span> map <span class="main">(</span><span class="main">(!)</span> <span class="free"><span class="bound"><span class="entity">subsets</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">indices</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">take_cols_from_matrix</span><span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> mat <span class="main">⇒</span> nat list <span class="main">⇒</span> <span class="tfree">'a</span> mat"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">take_cols_from_matrix</span> <span class="free"><span class="bound"><span class="entity">matr</span></span></span> <span class="free"><span class="bound"><span class="entity">indices_to_keep</span></span></span> <span class="main">=</span> 
    mat_of_cols <span class="main">(</span>dim_row <span class="free"><span class="bound"><span class="entity">matr</span></span></span><span class="main">)</span> <span class="main">(</span><span class="main">(</span>take_indices <span class="main">(</span>cols <span class="free"><span class="bound"><span class="entity">matr</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">indices_to_keep</span></span></span><span class="main">)</span><span class="main">::</span> <span class="tfree">'a</span> vec list<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">take_rows_from_matrix</span><span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> mat <span class="main">⇒</span> nat list <span class="main">⇒</span> <span class="tfree">'a</span> mat"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">take_rows_from_matrix</span> <span class="free"><span class="bound"><span class="entity">matr</span></span></span> <span class="free"><span class="bound"><span class="entity">indices_to_keep</span></span></span> <span class="main">=</span> 
    mat_of_rows <span class="main">(</span>dim_col <span class="free"><span class="bound"><span class="entity">matr</span></span></span><span class="main">)</span> <span class="main">(</span><span class="main">(</span>take_indices <span class="main">(</span>rows <span class="free"><span class="bound"><span class="entity">matr</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">indices_to_keep</span></span></span><span class="main">)</span><span class="main">::</span> <span class="tfree">'a</span> vec list<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">reduce_mat_cols</span><span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> mat <span class="main">⇒</span> rat vec <span class="main">⇒</span> <span class="tfree">'a</span> mat"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">reduce_mat_cols</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">lhs_vec</span></span></span> <span class="main">=</span> take_cols_from_matrix <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">(</span>find_nonzeros_from_input_vec <span class="free"><span class="bound"><span class="entity">lhs_vec</span></span></span><span class="main">)</span>"</span></span>

<span class="comment1">(* Find which rows to drop. *)</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">rows_to_keep</span><span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>field<span class="main">)</span> mat <span class="main">⇒</span> nat list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">rows_to_keep</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">=</span> map snd <span class="main">(</span>pivot_positions <span class="main">(</span>gauss_jordan_single <span class="main">(</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="keyword1"><span class="hidden">⇧</span><sup>T</sup></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">reduction_step</span><span class="main">::</span> <span class="quoted"><span class="quoted">"rat mat <span class="main">⇒</span> rat list list <span class="main">⇒</span> nat list list <span class="main">⇒</span> rat vec <span class="main">⇒</span> rat mat <span class="main">×</span> <span class="main">(</span>nat list list <span class="main">×</span> rat list list<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">reduction_step</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">signs</span></span></span> <span class="free"><span class="bound"><span class="entity">subsets</span></span></span> <span class="free"><span class="bound"><span class="entity">lhs_vec</span></span></span> <span class="main">=</span> 
    <span class="main">(</span><span class="keyword1">let</span> <span class="bound">reduce_cols_A</span> <span class="main">=</span> <span class="main">(</span>reduce_mat_cols <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">lhs_vec</span></span></span><span class="main">)</span><span class="main">;</span>
         <span class="bound">rows_keep</span> <span class="main">=</span> rows_to_keep <span class="bound">reduce_cols_A</span> <span class="keyword1">in</span>
    <span class="main">(</span>take_rows_from_matrix  <span class="bound">reduce_cols_A</span> <span class="bound">rows_keep</span><span class="main">,</span>
      <span class="main">(</span>take_indices <span class="free"><span class="bound"><span class="entity">subsets</span></span></span> <span class="bound">rows_keep</span><span class="main">,</span>
      take_indices <span class="free"><span class="bound"><span class="entity">signs</span></span></span> <span class="main">(</span>find_nonzeros_from_input_vec <span class="free"><span class="bound"><span class="entity">lhs_vec</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">reduce_system</span><span class="main">::</span> <span class="quoted"><span class="quoted">"real poly <span class="main">⇒</span> <span class="main">(</span>real poly list <span class="main">×</span> <span class="main">(</span>rat mat <span class="main">×</span> <span class="main">(</span>nat list list <span class="main">×</span> rat list list<span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span>rat mat <span class="main">×</span> <span class="main">(</span>nat list list <span class="main">×</span> rat list list<span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">reduce_system</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">qs</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">subs</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">signs</span></span></span><span class="main">)</span> <span class="main">=</span>
    reduction_step <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">signs</span></span></span> <span class="free"><span class="bound"><span class="entity">subs</span></span></span> <span class="main">(</span>solve_for_lhs <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">qs</span></span></span> <span class="free"><span class="bound"><span class="entity">subs</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span>"</span></span> 

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">"Overall algorithm "</span></span>
  <span class="comment1">(* 
    Find the matrix, subsets, signs for an input p and qs.
    The "rat mat" in the output is the matrix. The "nat list list" is the list of subsets. 
    The "rat list list" is the list of signs.

    We will want to call this when p is nonzero and when every q in qs is pairwise coprime to p.
    Properties of this algorithm are proved in BKR_Proofs.thy. 
  *)</span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">calculate_data</span><span class="main">::</span> <span class="quoted"><span class="quoted">"real poly <span class="main">⇒</span> real poly list <span class="main">⇒</span>  <span class="main">(</span>rat mat <span class="main">×</span> <span class="main">(</span>nat list list <span class="main">×</span> rat list list<span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">calculate_data</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">qs</span></span></span> <span class="main">=</span> 
  <span class="main">(</span> <span class="keyword1">let</span> <span class="bound">len</span> <span class="main">=</span> length <span class="free"><span class="bound"><span class="entity">qs</span></span></span> <span class="keyword1">in</span>
    <span class="keyword1">if</span> <span class="bound">len</span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span>
      <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span><span class="bound">b</span><span class="main">,</span><span class="bound">c</span><span class="main">)</span><span class="main">.</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span><span class="bound">b</span><span class="main">,</span>map <span class="main">(</span>drop <span class="main">1</span><span class="main">)</span> <span class="bound">c</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>reduce_system <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">(</span><span class="main">[</span><span class="main">1</span><span class="main">]</span><span class="main">,</span>base_case_info<span class="main">)</span><span class="main">)</span>
    <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="bound">len</span> <span class="main">≤</span> <span class="main">1</span> <span class="keyword1">then</span> reduce_system <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">qs</span></span></span><span class="main">,</span>base_case_info<span class="main">)</span>
    <span class="keyword1">else</span>
    <span class="main">(</span><span class="keyword1">let</span> <span class="bound">q1</span> <span class="main">=</span> take <span class="main">(</span><span class="bound">len</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">qs</span></span></span><span class="main">;</span> <span class="bound">left</span> <span class="main">=</span> <span class="free">calculate_data</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="bound">q1</span><span class="main">;</span>
         <span class="bound">q2</span> <span class="main">=</span> drop <span class="main">(</span><span class="bound">len</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">qs</span></span></span><span class="main">;</span> <span class="bound">right</span> <span class="main">=</span> <span class="free">calculate_data</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="bound">q2</span><span class="main">;</span>
         <span class="bound">comb</span> <span class="main">=</span> combine_systems <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">(</span><span class="bound">q1</span><span class="main">,</span><span class="bound">left</span><span class="main">)</span> <span class="main">(</span><span class="bound">q2</span><span class="main">,</span><span class="bound">right</span><span class="main">)</span> <span class="keyword1">in</span>
         reduce_system <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="bound">comb</span>
    <span class="main">)</span>
  <span class="main">)</span>"</span></span>

<span class="comment1">(* Extract the list of consistent sign assignments *)</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">find_consistent_signs_at_roots</span><span class="main">::</span> <span class="quoted"><span class="quoted">"real poly <span class="main">⇒</span> real poly list <span class="main">⇒</span> rat list list"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="free">find_consistent_signs_at_roots</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">qs</span></span></span> <span class="main">=</span>
  <span class="main">(</span> <span class="keyword1">let</span> <span class="main">(</span><span class="bound">M</span><span class="main">,</span><span class="bound">S</span><span class="main">,</span><span class="bound">Σ</span><span class="main">)</span> <span class="main">=</span> calculate_data <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">qs</span></span></span> <span class="keyword1">in</span> <span class="bound">Σ</span> <span class="main">)</span>"</span></span>

<span class="keyword1" id="BKR_Algorithm-find_consistent_signs_at_roots_thm"><span class="command">lemma</span></span> find_consistent_signs_at_roots_thm<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"find_consistent_signs_at_roots <span class="free">p</span> <span class="free">qs</span> <span class="main">=</span> snd <span class="main">(</span>snd <span class="main">(</span>calculate_data <span class="free">p</span> <span class="free">qs</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> case_prod_beta find_consistent_signs_at_roots_def<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="Matrix_Equation_Construction">
<div class="head">
<h1>Theory Matrix_Equation_Construction</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> Matrix_Equation_Construction

<span class="keyword2"><span class="keyword">imports</span></span> <span class="quoted">"<a href="#BKR_Algorithm">BKR_Algorithm</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">"Results with Sturm's Theorem"</span></span>

<span class="keyword1" id="Matrix_Equation_Construction-relprime"><span class="command">lemma</span></span> relprime<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">q</span><span class="main">::</span><span class="quoted"><span class="quoted">"real poly"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"coprime <span class="free">p</span> <span class="free">q</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"changes_R_smods <span class="free">p</span> <span class="main">(</span>pderiv <span class="free">p</span><span class="main">)</span> <span class="main">=</span> card <span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> poly <span class="free">q</span> <span class="bound">x</span> <span class="main">&gt;</span> <span class="main">0</span><span class="main">}</span> <span class="main">+</span> card <span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> poly <span class="free">q</span> <span class="bound">x</span> <span class="main">&lt;</span> <span class="main">0</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> poly <span class="free">q</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> coprime_poly_0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"changes_R_smods <span class="free">p</span> <span class="main">(</span>pderiv <span class="free">p</span><span class="main">)</span> <span class="main">=</span> int <span class="main">(</span>card <span class="main">{</span><span class="bound">x</span> <span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> sturm_R <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> poly <span class="free">q</span> <span class="bound">x</span> <span class="main">&gt;</span> <span class="main">0</span><span class="main">}</span> <span class="main">∩</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> poly <span class="free">q</span> <span class="bound">x</span> <span class="main">&lt;</span> <span class="main">0</span><span class="main">}</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">x</span> <span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span> <span class="main">=</span>  <span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> poly <span class="free">q</span> <span class="bound">x</span> <span class="main">&gt;</span> <span class="main">0</span><span class="main">}</span> <span class="main">∪</span><span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> poly <span class="free">q</span> <span class="bound">x</span> <span class="main">&lt;</span> <span class="main">0</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> poly <span class="free">q</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">x</span> <span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> poly <span class="free">q</span> <span class="bound">x</span> <span class="main">&gt;</span> <span class="main">0</span><span class="main">}</span> <span class="main">∪</span><span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> poly <span class="free">q</span> <span class="bound">x</span> <span class="main">&lt;</span> <span class="main">0</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>card <span class="main">{</span><span class="bound">x</span> <span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>card <span class="main">(</span><span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> poly <span class="free">q</span> <span class="bound">x</span> <span class="main">&gt;</span> <span class="main">0</span><span class="main">}</span> <span class="main">∪</span><span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> poly <span class="free">q</span> <span class="bound">x</span> <span class="main">&lt;</span> <span class="main">0</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> 4<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>card <span class="main">{</span><span class="bound">x</span> <span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span>  card <span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> poly <span class="free">q</span> <span class="bound">x</span> <span class="main">&gt;</span> <span class="main">0</span><span class="main">}</span> <span class="main">+</span> card <span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> poly <span class="free">q</span> <span class="bound">x</span> <span class="main">&lt;</span> <span class="main">0</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 3 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> card_Un_disjoint assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> poly_roots_finite<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted">"2"</span> <span class="quoted">"4"</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(* This is the same proof as card_eq_sum *)</span>
<span class="keyword1" id="Matrix_Equation_Construction-card_eq_const_sum"><span class="command">lemma</span></span> card_eq_const_sum<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">k</span><span class="main">::</span> <span class="quoted">real</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span><span class="main">*</span>card <span class="free">A</span> <span class="main">=</span> sum <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">k</span><span class="main">)</span> <span class="free">A</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"plus <span class="main">∘</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> Suc <span class="main">0</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> Suc<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fun_eq_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Finite_Set.fold <span class="main">(</span>plus <span class="main">∘</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> Suc <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Finite_Set.fold <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> Suc<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> arg_cong<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Finite_Set.fold <span class="main">(</span>plus <span class="main">∘</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> Suc <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">0</span> <span class="free">A</span> <span class="main">=</span> Finite_Set.fold <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> Suc<span class="main">)</span> <span class="main">0</span> <span class="free">A</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> fun_cong<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> card.eq_fold sum.eq_fold<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Matrix_Equation_Construction-restate_tarski"><span class="command">lemma</span></span> restate_tarski<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">q</span><span class="main">::</span><span class="quoted"><span class="quoted">"real poly"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"coprime <span class="free">p</span> <span class="free">q</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>       
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"changes_R_smods <span class="free">p</span> <span class="main">(</span><span class="main">(</span>pderiv <span class="free">p</span><span class="main">)</span> <span class="main">*</span> <span class="free">q</span><span class="main">)</span> <span class="main">=</span> card <span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> poly <span class="free">q</span> <span class="bound">x</span> <span class="main">&gt;</span> <span class="main">0</span><span class="main">}</span> <span class="main">-</span>  int<span class="main">(</span>card <span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> poly <span class="free">q</span> <span class="bound">x</span> <span class="main">&lt;</span> <span class="main">0</span><span class="main">}</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"taq <span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span><span class="main">=</span><span class="main">0</span><span class="main">}</span> <span class="free">q</span> <span class="main">≡</span> <span class="main">∑</span><span class="bound">y</span><span class="main">∈</span><span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span><span class="main">=</span><span class="main">0</span><span class="main">}</span><span class="main">.</span> sign <span class="main">(</span>poly <span class="free">q</span> <span class="bound">y</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> taq_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> 4<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span><span class="main">=</span><span class="main">0</span><span class="main">}</span> <span class="main">=</span>  <span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> poly <span class="free">q</span> <span class="bound">x</span> <span class="main">&gt;</span> <span class="main">0</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> poly <span class="free">q</span> <span class="bound">x</span> <span class="main">&lt;</span> <span class="main">0</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> poly <span class="free">q</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> 5<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span><span class="main">=</span><span class="main">0</span><span class="main">}</span> <span class="main">=</span>  <span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> poly <span class="free">q</span> <span class="bound">x</span> <span class="main">&gt;</span> <span class="main">0</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> poly <span class="free">q</span> <span class="bound">x</span> <span class="main">&lt;</span> <span class="main">0</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> coprime_poly_0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> 6<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∑</span><span class="bound">y</span><span class="main">∈</span><span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span><span class="main">=</span><span class="main">0</span><span class="main">}</span><span class="main">.</span> sign <span class="main">(</span>poly <span class="free">q</span> <span class="bound">y</span><span class="main">)</span> <span class="main">≡</span> <span class="main">∑</span><span class="bound">y</span><span class="main">∈</span><span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> poly <span class="free">q</span> <span class="bound">x</span> <span class="main">&gt;</span> <span class="main">0</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> poly <span class="free">q</span> <span class="bound">x</span> <span class="main">&lt;</span> <span class="main">0</span><span class="main">}</span><span class="main">.</span> sign <span class="main">(</span>poly <span class="free">q</span> <span class="bound">y</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> 12<span class="main">:</span> <span class="quoted"><span class="quoted">"taq <span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span><span class="main">=</span><span class="main">0</span><span class="main">}</span> <span class="free">q</span> <span class="main">≡</span> <span class="main">∑</span><span class="bound">y</span><span class="main">∈</span><span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> poly <span class="free">q</span> <span class="bound">x</span> <span class="main">&gt;</span> <span class="main">0</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> poly <span class="free">q</span> <span class="bound">x</span> <span class="main">&lt;</span> <span class="main">0</span><span class="main">}</span><span class="main">.</span> sign <span class="main">(</span>poly <span class="free">q</span> <span class="bound">y</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 3 <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
  <span class="keyword1"><span class="command">have</span></span> 7<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> poly <span class="free">q</span> <span class="bound">x</span> <span class="main">&gt;</span> <span class="main">0</span><span class="main">}</span> <span class="main">∩</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> poly <span class="free">q</span> <span class="bound">x</span> <span class="main">&lt;</span> <span class="main">0</span><span class="main">}</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> 8<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∑</span><span class="bound">y</span><span class="main">∈</span><span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> poly <span class="free">q</span> <span class="bound">x</span> <span class="main">&gt;</span> <span class="main">0</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> poly <span class="free">q</span> <span class="bound">x</span> <span class="main">&lt;</span> <span class="main">0</span><span class="main">}</span><span class="main">.</span> sign <span class="main">(</span>poly <span class="free">q</span> <span class="bound">y</span><span class="main">)</span> <span class="main">≡</span> <span class="main">(</span><span class="main">∑</span><span class="bound">y</span><span class="main">∈</span><span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> poly <span class="free">q</span> <span class="bound">x</span> <span class="main">&gt;</span> <span class="main">0</span><span class="main">}</span><span class="main">.</span>sign <span class="main">(</span>poly <span class="free">q</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="main">∑</span><span class="bound">y</span><span class="main">∈</span><span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> poly <span class="free">q</span> <span class="bound">x</span> <span class="main">&lt;</span> <span class="main">0</span><span class="main">}</span><span class="main">.</span>sign<span class="main">(</span>poly <span class="free">q</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> poly_roots_finite sum.union_disjoint<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> 13<span class="main">:</span> <span class="quoted"><span class="quoted">"taq <span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span><span class="main">=</span><span class="main">0</span><span class="main">}</span> <span class="free">q</span> <span class="main">≡</span> <span class="main">(</span><span class="main">∑</span><span class="bound">y</span><span class="main">∈</span><span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> poly <span class="free">q</span> <span class="bound">x</span> <span class="main">&gt;</span> <span class="main">0</span><span class="main">}</span><span class="main">.</span>sign <span class="main">(</span>poly <span class="free">q</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="main">∑</span><span class="bound">y</span><span class="main">∈</span><span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> poly <span class="free">q</span> <span class="bound">x</span> <span class="main">&lt;</span> <span class="main">0</span><span class="main">}</span><span class="main">.</span>sign<span class="main">(</span>poly <span class="free">q</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 12 <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> 9<span class="main">:</span> <span class="quoted"><span class="quoted">"taq <span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span> <span class="free">q</span> <span class="main">≡</span> <span class="main">(</span><span class="main">∑</span><span class="bound">y</span><span class="main">∈</span><span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> poly <span class="free">q</span> <span class="bound">x</span> <span class="main">&gt;</span> <span class="main">0</span><span class="main">}</span><span class="main">.</span><span class="main">1</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="main">∑</span><span class="bound">y</span><span class="main">∈</span><span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> poly <span class="free">q</span> <span class="bound">x</span> <span class="main">&lt;</span> <span class="main">0</span><span class="main">}</span><span class="main">.</span><span class="main">(</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> 10<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">y</span><span class="main">∈</span><span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> poly <span class="free">q</span> <span class="bound">x</span> <span class="main">&gt;</span> <span class="main">0</span><span class="main">}</span><span class="main">.</span><span class="main">1</span><span class="main">)</span> <span class="main">=</span>  card <span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> poly <span class="free">q</span> <span class="bound">x</span> <span class="main">&gt;</span> <span class="main">0</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> card_eq_sum <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> 11<span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="main">(</span><span class="main">∑</span><span class="bound">y</span><span class="main">∈</span><span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> poly <span class="free">q</span> <span class="bound">x</span> <span class="main">&lt;</span> <span class="main">0</span><span class="main">}</span><span class="main">.</span><span class="main">(</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">-</span><span class="main">1</span><span class="main">*</span>card <span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> poly <span class="free">q</span> <span class="bound">x</span> <span class="main">&lt;</span> <span class="main">0</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> card_eq_const_sum <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> 14<span class="main">:</span> <span class="quoted"><span class="quoted">"taq <span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span> <span class="free">q</span> <span class="main">≡</span> card <span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> poly <span class="free">q</span> <span class="bound">x</span> <span class="main">&gt;</span> <span class="main">0</span><span class="main">}</span> <span class="main">+</span> <span class="main">-</span><span class="main">1</span><span class="main">*</span>card <span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> poly <span class="free">q</span> <span class="bound">x</span> <span class="main">&lt;</span> <span class="main">0</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 9 10 11 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"changes_R_smods <span class="free">p</span> <span class="main">(</span>pderiv <span class="free">p</span> <span class="main">*</span> <span class="free">q</span><span class="main">)</span> <span class="main">=</span> taq <span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span><span class="main">=</span><span class="main">0</span><span class="main">}</span> <span class="free">q</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> sturm_tarski_R <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> 15<span class="main">:</span> <span class="quoted"><span class="quoted">"changes_R_smods <span class="free">p</span> <span class="main">(</span>pderiv <span class="free">p</span> <span class="main">*</span> <span class="free">q</span><span class="main">)</span> <span class="main">=</span> card <span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> poly <span class="free">q</span> <span class="bound">x</span> <span class="main">&gt;</span> <span class="main">0</span><span class="main">}</span> <span class="main">+</span> <span class="main">(</span><span class="main">-</span><span class="main">1</span><span class="main">*</span>card <span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> poly <span class="free">q</span> <span class="bound">x</span> <span class="main">&lt;</span> <span class="main">0</span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 14 <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
  <span class="keyword1"><span class="command">have</span></span> 16<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">-</span><span class="main">1</span><span class="main">*</span>card <span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> poly <span class="free">q</span> <span class="bound">x</span> <span class="main">&lt;</span> <span class="main">0</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> <span class="main">-</span> card <span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> poly <span class="free">q</span> <span class="bound">x</span> <span class="main">&lt;</span> <span class="main">0</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> 15 <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Matrix_Equation_Construction-restate_tarski2"><span class="command">lemma</span></span> restate_tarski2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">q</span><span class="main">::</span><span class="quoted"><span class="quoted">"real poly"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"changes_R_smods <span class="free">p</span> <span class="main">(</span><span class="main">(</span>pderiv <span class="free">p</span><span class="main">)</span> <span class="main">*</span> <span class="free">q</span><span class="main">)</span> <span class="main">=</span>
        int<span class="main">(</span>card <span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> poly <span class="free">q</span> <span class="bound">x</span> <span class="main">&gt;</span> <span class="main">0</span><span class="main">}</span><span class="main">)</span> <span class="main">-</span>
        int<span class="main">(</span>card <span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> poly <span class="free">q</span> <span class="bound">x</span> <span class="main">&lt;</span> <span class="main">0</span><span class="main">}</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> sturm_tarski_R<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> taq_def
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?all</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span><span class="main">=</span><span class="main">0</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?lt</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span><span class="main">=</span><span class="main">0</span> <span class="main">∧</span> poly <span class="free">q</span> <span class="bound">x</span> <span class="main">&lt;</span> <span class="main">0</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?gt</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span><span class="main">=</span><span class="main">0</span> <span class="main">∧</span> poly <span class="free">q</span> <span class="bound">x</span> <span class="main">&gt;</span> <span class="main">0</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?eq</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span><span class="main">=</span><span class="main">0</span> <span class="main">∧</span> poly <span class="free">q</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?all</span> <span class="main">=</span> <span class="var">?lt</span> <span class="main">∪</span> <span class="var">?gt</span> <span class="main">∪</span> <span class="var">?eq</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">from</span></span> poly_roots_finite<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> fin<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="var">?all</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword3"><span class="command">show</span></span>  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound"><span class="bound">x</span></span> <span class="main">|</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">.</span> sign <span class="main">(</span>poly <span class="free">q</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> int <span class="main">(</span>card <span class="var">?gt</span><span class="main">)</span> <span class="main">-</span> int <span class="main">(</span>card <span class="var">?lt</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> eq
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> sum_Un<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>fin<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> sum_Un<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>fin<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Matrix_Equation_Construction-coprime_set_prod"><span class="command">lemma</span></span> coprime_set_prod<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">I</span><span class="main">::</span> <span class="quoted"><span class="quoted">"real poly set"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">I</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">(</span><span class="main">∀</span> <span class="bound">q</span> <span class="main">∈</span> <span class="free">I</span><span class="main">.</span> <span class="main">(</span>coprime <span class="free">p</span> <span class="bound">q</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">(</span>coprime <span class="free">p</span> <span class="main">(</span><span class="main">∏</span> <span class="free">I</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> finite_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> empty
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> 
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>insert <span class="skolem">x</span> <span class="skolem">F</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> coprime_mult_right_iff
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Matrix_Equation_Construction-finite_nonzero_set_prod"><span class="command">lemma</span></span> finite_nonzero_set_prod<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">I</span><span class="main">::</span> <span class="quoted"><span class="quoted">"real poly set"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>  nonzero_hyp<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">I</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">(</span><span class="main">∀</span> <span class="bound">q</span> <span class="main">∈</span> <span class="free">I</span><span class="main">.</span> <span class="bound">q</span> <span class="main">≠</span> <span class="main">0</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">∏</span> <span class="free">I</span> <span class="main">≠</span> <span class="main">0</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> finite_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> empty
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> 
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>insert <span class="skolem">x</span> <span class="skolem">F</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> h<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∏</span> <span class="main">(</span>insert <span class="skolem">x</span> <span class="skolem">F</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">x</span> <span class="main">*</span> <span class="main">(</span><span class="main">∏</span> <span class="skolem">F</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> insert.hyps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> insert.hyps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span> 
  <span class="keyword1"><span class="command">have</span></span> h_xin<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> insert <span class="skolem">x</span> <span class="skolem">F</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> 
  <span class="keyword1"><span class="command">have</span></span> hq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span> <span class="bound">q</span> <span class="main">∈</span> <span class="main">(</span>insert <span class="skolem">x</span> <span class="skolem">F</span><span class="main">)</span><span class="main">.</span> <span class="bound">q</span> <span class="main">≠</span> <span class="main">0</span><span class="main">)</span> <span class="main">⟶</span> <span class="skolem">x</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> h_xin
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> h hq
    <span class="keyword1"><span class="command">using</span></span> insert.hyps<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">"Setting up the construction: Definitions"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">characterize_root_list_p</span><span class="main">::</span> <span class="quoted"><span class="quoted">"real poly <span class="main">⇒</span> real list"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">characterize_root_list_p</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">≡</span> sorted_list_of_set<span class="main">(</span><span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span><span class="main">::</span>real set<span class="main">)</span>"</span></span>

<span class="comment1">(************** Renegar's N(I); towards defining the RHS of the matrix equation **************)</span>

<span class="keyword1" id="Matrix_Equation_Construction-construct_NofI_prop"><span class="command">lemma</span></span> construct_NofI_prop<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">p</span><span class="main">::</span> <span class="quoted"><span class="quoted">"real poly"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">I</span><span class="main">::</span> <span class="quoted"><span class="quoted">"real poly list"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> nonzero<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span><span class="main">≠</span><span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"construct_NofI <span class="free">p</span> <span class="free">I</span> <span class="main">=</span>
    rat_of_int <span class="main">(</span>int <span class="main">(</span>card <span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> poly <span class="main">(</span>prod_list <span class="free">I</span><span class="main">)</span> <span class="bound">x</span> <span class="main">&gt;</span> <span class="main">0</span><span class="main">}</span><span class="main">)</span> <span class="main">-</span> 
    int <span class="main">(</span>card <span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> poly <span class="main">(</span>prod_list <span class="free">I</span><span class="main">)</span> <span class="bound">x</span> <span class="main">&lt;</span> <span class="main">0</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> construct_NofI_def
  <span class="keyword1"><span class="command">using</span></span> assms restate_tarski2 nonzero rsquarefree_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rsquarefree_def<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">construct_s_vector</span><span class="main">::</span> <span class="quoted"><span class="quoted">"real poly <span class="main">⇒</span> real poly list list <span class="main">⇒</span> rat vec"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">construct_s_vector</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">Is</span></span></span> <span class="main">=</span> vec_of_list <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span> <span class="bound">I</span><span class="main">.</span><span class="main">(</span>construct_NofI <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="bound">I</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">Is</span></span></span><span class="main">)</span>"</span></span>

<span class="comment1">(* Consistent sign assignments *)</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">squash</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>linordered_field <span class="main">⇒</span> rat"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">squash</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">&gt;</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="main">1</span>
                    <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">&lt;</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="main">-</span><span class="main">1</span>
                    <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">signs_at</span><span class="main">::</span><span class="quoted"><span class="quoted">"real poly list <span class="main">⇒</span> real <span class="main">⇒</span> rat list"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">signs_at</span> <span class="free"><span class="bound"><span class="entity">qs</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">≡</span>
    map <span class="main">(</span>squash <span class="main">∘</span> <span class="main">(</span><span class="main">λ</span><span class="bound">q</span><span class="main">.</span> poly <span class="bound">q</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">qs</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">characterize_consistent_signs_at_roots</span><span class="main">::</span> <span class="quoted"><span class="quoted">"real poly <span class="main">⇒</span> real poly list <span class="main">⇒</span> rat list list"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">characterize_consistent_signs_at_roots</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">qs</span></span></span> <span class="main">=</span>
  <span class="main">(</span>remdups <span class="main">(</span>map <span class="main">(</span>signs_at <span class="free"><span class="bound"><span class="entity">qs</span></span></span><span class="main">)</span> <span class="main">(</span>characterize_root_list_p <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="comment1">(* An alternate version designed to be used when every polynomial in qs is relatively prime to p*)</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">consistent_sign_vec_copr</span><span class="main">::</span><span class="quoted"><span class="quoted">"real poly list <span class="main">⇒</span> real <span class="main">⇒</span> rat list"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">consistent_sign_vec_copr</span> <span class="free"><span class="bound"><span class="entity">qs</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">≡</span>
    map <span class="main">(</span><span class="main">λ</span> <span class="bound">q</span><span class="main">.</span> <span class="keyword1">if</span> <span class="main">(</span>poly <span class="bound">q</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">&gt;</span> <span class="main">0</span><span class="main">)</span> <span class="keyword1">then</span> <span class="main">(</span><span class="main">1</span><span class="main">::</span>rat<span class="main">)</span> <span class="keyword1">else</span> <span class="main">(</span><span class="main">-</span><span class="main">1</span><span class="main">::</span>rat<span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">qs</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">characterize_consistent_signs_at_roots_copr</span><span class="main">::</span> <span class="quoted"><span class="quoted">"real poly <span class="main">⇒</span> real poly list <span class="main">⇒</span> rat list list"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">characterize_consistent_signs_at_roots_copr</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">qss</span></span></span> <span class="main">=</span>
  <span class="main">(</span>remdups <span class="main">(</span>map <span class="main">(</span>consistent_sign_vec_copr <span class="free"><span class="bound"><span class="entity">qss</span></span></span><span class="main">)</span> <span class="main">(</span>characterize_root_list_p <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Matrix_Equation_Construction-csa_list_copr_rel"><span class="command">lemma</span></span> csa_list_copr_rel<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">p</span><span class="main">::</span> <span class="quoted"><span class="quoted">"real poly"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">qs</span><span class="main">::</span> <span class="quoted"><span class="quoted">"real poly list"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> nonzero<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span><span class="main">≠</span><span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> pairwise_rel_prime<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">q</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span>List.member <span class="free">qs</span> <span class="bound">q</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">(</span>coprime <span class="free">p</span> <span class="bound">q</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"characterize_consistent_signs_at_roots <span class="free">p</span> <span class="free">qs</span> <span class="main">=</span> characterize_consistent_signs_at_roots_copr <span class="free">p</span> <span class="free">qs</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">q</span> <span class="main">∈</span> set<span class="main">(</span><span class="free">qs</span><span class="main">)</span><span class="main">.</span> <span class="main">∀</span> <span class="bound">x</span> <span class="main">∈</span> set <span class="main">(</span>characterize_root_list_p <span class="free">p</span><span class="main">)</span><span class="main">.</span>  poly <span class="bound">q</span> <span class="bound">x</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> pairwise_rel_prime
    <span class="keyword1"><span class="command">using</span></span> coprime_poly_0 in_set_member nonzero poly_roots_finite characterize_root_list_p_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> h<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">q</span> <span class="main">∈</span> set<span class="main">(</span><span class="free">qs</span><span class="main">)</span><span class="main">.</span> <span class="main">∀</span> <span class="bound">x</span> <span class="main">∈</span> set <span class="main">(</span>characterize_root_list_p <span class="free">p</span><span class="main">)</span><span class="main">.</span> squash <span class="main">(</span>poly <span class="bound">q</span> <span class="bound">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="main">(</span>poly <span class="bound">q</span> <span class="bound">x</span> <span class="main">&gt;</span> <span class="main">0</span><span class="main">)</span> <span class="keyword1">then</span> <span class="main">(</span><span class="main">1</span><span class="main">::</span>rat<span class="main">)</span> <span class="keyword1">else</span> <span class="main">(</span><span class="main">-</span><span class="main">1</span><span class="main">::</span>rat<span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> squash_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"map <span class="main">(</span><span class="main">λ</span><span class="bound">r</span><span class="main">.</span> map <span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> <span class="keyword1">if</span> <span class="main">0</span> <span class="main">&lt;</span> poly <span class="bound">p</span> <span class="bound">r</span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="free">qs</span><span class="main">)</span> <span class="main">(</span>characterize_root_list_p <span class="free">p</span><span class="main">)</span> <span class="main">=</span> map <span class="main">(</span><span class="main">λ</span><span class="bound">r</span><span class="main">.</span> map <span class="main">(</span>squash <span class="main">∘</span> <span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> poly <span class="bound">p</span> <span class="bound">r</span><span class="main">)</span><span class="main">)</span> <span class="free">qs</span><span class="main">)</span> <span class="main">(</span>characterize_root_list_p <span class="free">p</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> h<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> characterize_consistent_signs_at_roots_def characterize_consistent_signs_at_roots_copr_def
      signs_at_def consistent_sign_vec_copr_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(************** Towards defining Renegar's polynomial function and the LHS of the matrix equation **************)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">list_constr</span><span class="main">::</span> <span class="quoted"><span class="quoted">"nat list <span class="main">⇒</span> nat <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">list_constr</span> <span class="free"><span class="bound"><span class="entity">L</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">≡</span> list_all <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">L</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">all_list_constr</span><span class="main">::</span> <span class="quoted"><span class="quoted">"nat list list <span class="main">⇒</span> nat <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">all_list_constr</span> <span class="free"><span class="bound"><span class="entity">L</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">.</span> List.member <span class="free"><span class="bound"><span class="entity">L</span></span></span> <span class="bound">x</span> <span class="main">⟶</span> list_constr <span class="bound">x</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span>"</span></span>

<span class="comment1">(* The first input is the subset; the second input is the consistent sign assignment.
  We want to map over the first list and pull out all of the elements in the second list with
  corresponding positions, and then multiply those together.
*)</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">z</span><span class="main">::</span> <span class="quoted"><span class="quoted">"nat list <span class="main">⇒</span> rat list <span class="main">⇒</span> rat"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">z</span> <span class="free"><span class="bound"><span class="entity">index_list</span></span></span> <span class="free"><span class="bound"><span class="entity">sign_asg</span></span></span> <span class="main">≡</span> <span class="main">(</span>prod_list <span class="main">(</span>map <span class="main">(</span>nth <span class="free"><span class="bound"><span class="entity">sign_asg</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">index_list</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">mtx_row</span><span class="main">::</span> <span class="quoted"><span class="quoted">"rat list list <span class="main">⇒</span> nat list <span class="main">⇒</span> rat list"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">mtx_row</span> <span class="free"><span class="bound"><span class="entity">sign_list</span></span></span> <span class="free"><span class="bound"><span class="entity">index_list</span></span></span> <span class="main">≡</span> <span class="main">(</span>map <span class="main">(</span> <span class="main">(</span>z <span class="free"><span class="bound"><span class="entity">index_list</span></span></span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">sign_list</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">matrix_A</span><span class="main">::</span> <span class="quoted"><span class="quoted">"rat list list <span class="main">⇒</span> nat list list <span class="main">⇒</span> rat mat"</span></span> 
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">matrix_A</span> <span class="free"><span class="bound"><span class="entity">sign_list</span></span></span> <span class="free"><span class="bound"><span class="entity">subset_list</span></span></span> <span class="main">=</span> 
    <span class="main">(</span>mat_of_rows_list <span class="main">(</span>length <span class="free"><span class="bound"><span class="entity">sign_list</span></span></span><span class="main">)</span> <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">i</span> <span class="main">.</span><span class="main">(</span>mtx_row <span class="free"><span class="bound"><span class="entity">sign_list</span></span></span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">subset_list</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">alt_matrix_A</span><span class="main">::</span> <span class="quoted"><span class="quoted">"rat list list <span class="main">⇒</span> nat list list <span class="main">⇒</span> rat mat"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">alt_matrix_A</span> <span class="free"><span class="bound"><span class="entity">signs</span></span></span> <span class="free"><span class="bound"><span class="entity">subsets</span></span></span> <span class="main">=</span> <span class="main">(</span>mat <span class="main">(</span>length <span class="free"><span class="bound"><span class="entity">subsets</span></span></span><span class="main">)</span> <span class="main">(</span>length <span class="free"><span class="bound"><span class="entity">signs</span></span></span><span class="main">)</span> 
    <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">i</span><span class="main">,</span> <span class="bound">j</span><span class="main">)</span><span class="main">.</span> z <span class="main">(</span><span class="free"><span class="bound"><span class="entity">subsets</span></span></span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">signs</span></span></span> <span class="main">!</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Matrix_Equation_Construction-alt_matrix_char"><span class="command">lemma</span></span> alt_matrix_char<span class="main">:</span> <span class="quoted"><span class="quoted">"alt_matrix_A <span class="free">signs</span> <span class="free">subsets</span> <span class="main">=</span> matrix_A <span class="free">signs</span> <span class="free">subsets</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
  <span class="keyword1"><span class="command">have</span></span> h0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> length <span class="free">subsets</span> <span class="main">⟹</span>
            <span class="bound">j</span> <span class="main">&lt;</span> length <span class="free">signs</span> <span class="main">⟹</span>
            map <span class="main">(</span><span class="main">λ</span><span class="bound">index_list</span><span class="main">.</span> map <span class="main">(</span>z <span class="bound">index_list</span><span class="main">)</span> <span class="free">signs</span><span class="main">)</span> <span class="free">subsets</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">!</span> <span class="bound">j</span> <span class="main">=</span> z <span class="main">(</span><span class="free">subsets</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="free">signs</span> <span class="main">!</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">j</span>
    <span class="keyword3"><span class="command">assume</span></span> i_lt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="free">subsets</span>"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> j_lt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> length <span class="free">signs</span>"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">index_list</span><span class="main">.</span> map <span class="main">(</span>z <span class="bound">index_list</span><span class="main">)</span> <span class="free">signs</span><span class="main">)</span> <span class="free">subsets</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">j</span> <span class="main">=</span> z <span class="main">(</span><span class="free">subsets</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">(</span><span class="free">signs</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
      <span class="keyword1"><span class="command">have</span></span> h0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">index_list</span><span class="main">.</span> map <span class="main">(</span>z <span class="bound">index_list</span><span class="main">)</span> <span class="free">signs</span><span class="main">)</span> <span class="free">subsets</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">=</span>  map <span class="main">(</span>z <span class="main">(</span><span class="free">subsets</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="free">signs</span>"</span></span> 
        <span class="keyword1"><span class="command">using</span></span> nth_map i_lt
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> nth_map j_lt
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> 
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">have</span></span> h<span class="main">:</span> <span class="quoted"><span class="quoted">" mat <span class="main">(</span>length <span class="free">subsets</span><span class="main">)</span> <span class="main">(</span>length <span class="free">signs</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">i</span><span class="main">,</span> <span class="bound">j</span><span class="main">)</span><span class="main">.</span> z <span class="main">(</span><span class="free">subsets</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="free">signs</span> <span class="main">!</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
    mat <span class="main">(</span>length <span class="free">subsets</span><span class="main">)</span> <span class="main">(</span>length <span class="free">signs</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">i</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> map <span class="main">(</span><span class="main">λ</span><span class="bound">index_list</span><span class="main">.</span> map <span class="main">(</span>z <span class="bound">index_list</span><span class="main">)</span> <span class="free">signs</span><span class="main">)</span> <span class="free">subsets</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">!</span> <span class="bound">y</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> h0 eq_matI<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> A <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"mat <span class="main">(</span>length <span class="free">subsets</span><span class="main">)</span> <span class="main">(</span>length <span class="free">signs</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">i</span><span class="main">,</span> <span class="bound">j</span><span class="main">)</span><span class="main">.</span> z <span class="main">(</span><span class="free">subsets</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="free">signs</span> <span class="main">!</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span>"</span></span><span class="main">,</span>
        <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> B <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"mat <span class="main">(</span>length <span class="free">subsets</span><span class="main">)</span> <span class="main">(</span>length <span class="free">signs</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">i</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> map <span class="main">(</span><span class="main">λ</span><span class="bound">index_list</span><span class="main">.</span> map <span class="main">(</span>z <span class="bound">index_list</span><span class="main">)</span> <span class="free">signs</span><span class="main">)</span> <span class="free">subsets</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">!</span> <span class="bound">y</span><span class="main">)</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> alt_matrix_A_def matrix_A_def mat_of_rows_list_def <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> mtx_row_def
    <span class="keyword1"><span class="command">using</span></span> h   <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Matrix_Equation_Construction-subsets_are_rows"><span class="command">lemma</span></span> subsets_are_rows<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> <span class="main">(</span>length <span class="free">subsets</span><span class="main">)</span><span class="main">.</span> row <span class="main">(</span>alt_matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span> <span class="bound">i</span>  <span class="main">=</span> vec <span class="main">(</span>length <span class="free">signs</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">j</span><span class="main">.</span> z <span class="main">(</span><span class="free">subsets</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="free">signs</span> <span class="main">!</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> row_def <span class="keyword1"><span class="command">unfolding</span></span> alt_matrix_A_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Matrix_Equation_Construction-signs_are_cols"><span class="command">lemma</span></span> signs_are_cols<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> <span class="main">(</span>length <span class="free">signs</span><span class="main">)</span><span class="main">.</span> col <span class="main">(</span>alt_matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span> <span class="bound">i</span>  <span class="main">=</span> vec <span class="main">(</span>length <span class="free">subsets</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">j</span><span class="main">.</span> z <span class="main">(</span><span class="free">subsets</span> <span class="main">!</span> <span class="bound">j</span><span class="main">)</span> <span class="main">(</span><span class="free">signs</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> col_def <span class="keyword1"><span class="command">unfolding</span></span> alt_matrix_A_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="comment1">(* ith entry of LHS vector is the number of (distinct) real zeros of p where the sign vector of the qs  is the ith entry of signs.*)</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">construct_lhs_vector</span><span class="main">::</span> <span class="quoted"><span class="quoted">"real poly <span class="main">⇒</span> real poly list <span class="main">⇒</span> rat list list  <span class="main">⇒</span> rat vec"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">construct_lhs_vector</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">qs</span></span></span> <span class="free"><span class="bound"><span class="entity">signs</span></span></span> <span class="main">≡</span>
  vec_of_list <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">w</span><span class="main">.</span>  rat_of_int <span class="main">(</span>int <span class="main">(</span>length <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> <span class="bound">v</span> <span class="main">=</span> <span class="bound">w</span><span class="main">)</span> <span class="main">(</span>map <span class="main">(</span>consistent_sign_vec_copr <span class="free"><span class="bound"><span class="entity">qs</span></span></span><span class="main">)</span> <span class="main">(</span>characterize_root_list_p <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">signs</span></span></span><span class="main">)</span>"</span></span>

<span class="comment1">(* Putting all of the pieces of the construction together *)</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">satisfy_equation</span><span class="main">::</span> <span class="quoted"><span class="quoted">"real poly <span class="main">⇒</span> real poly list <span class="main">⇒</span> nat list list <span class="main">⇒</span> rat list list <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">satisfy_equation</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">qs</span></span></span> <span class="free"><span class="bound"><span class="entity">subset_list</span></span></span> <span class="free"><span class="bound"><span class="entity">sign_list</span></span></span> <span class="main">=</span>
        <span class="main">(</span>mult_mat_vec <span class="main">(</span>matrix_A <span class="free"><span class="bound"><span class="entity">sign_list</span></span></span> <span class="free"><span class="bound"><span class="entity">subset_list</span></span></span><span class="main">)</span> <span class="main">(</span>construct_lhs_vector <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">qs</span></span></span> <span class="free"><span class="bound"><span class="entity">sign_list</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>construct_rhs_vector <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">qs</span></span></span> <span class="free"><span class="bound"><span class="entity">subset_list</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">"Setting up the construction: Proofs"</span></span>

<span class="comment1">(* Some matrix lemmas  *)</span>
<span class="keyword1" id="Matrix_Equation_Construction-row_mat_of_rows_list"><span class="command">lemma</span></span> row_mat_of_rows_list<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"list_all <span class="main">(</span><span class="main">λ</span><span class="bound">r</span><span class="main">.</span> length <span class="bound">r</span> <span class="main">=</span> <span class="free">nc</span><span class="main">)</span> <span class="free">rs</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> length <span class="free">rs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"row <span class="main">(</span>mat_of_rows_list <span class="free">nc</span> <span class="free">rs</span><span class="main">)</span> <span class="free">i</span> <span class="main">=</span> vec_of_list <span class="main">(</span>nth <span class="free">rs</span> <span class="free">i</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> dim_col_mat<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> dim_vec_of_list eq_vecI index_row<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> index_vec list_all_length mat_of_rows_list_def row_mat split_conv vec_of_list_index<span class="main">)</span>


<span class="keyword1" id="Matrix_Equation_Construction-mult_mat_vec_of_list"><span class="command">lemma</span></span> mult_mat_vec_of_list<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"length <span class="free">ls</span> <span class="main">=</span> <span class="free">nc</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"list_all <span class="main">(</span><span class="main">λ</span><span class="bound">r</span><span class="main">.</span> length <span class="bound">r</span> <span class="main">=</span> <span class="free">nc</span><span class="main">)</span> <span class="free">rs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"mat_of_rows_list <span class="free">nc</span> <span class="free">rs</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>v</sub></span> vec_of_list <span class="free">ls</span> <span class="main">=</span>
    vec_of_list <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">r</span><span class="main">.</span> vec_of_list <span class="bound">r</span> <span class="main">∙</span> vec_of_list <span class="free">ls</span><span class="main">)</span> <span class="free">rs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> mult_mat_vec_def
  <span class="keyword1"><span class="command">using</span></span> row_mat_of_rows_list assms 
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> dim_row_mat<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> dim_vec dim_vec_of_list eq_vecI index_map_vec<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> index_map_vec<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> index_vec list_all_length mat_of_rows_list_def row_mat_of_rows_list vec_of_list_index<span class="main">)</span>

<span class="keyword1" id="Matrix_Equation_Construction-mtx_row_length"><span class="command">lemma</span></span> mtx_row_length<span class="main">:</span>
  <span class="quoted"><span class="quoted">"list_all <span class="main">(</span><span class="main">λ</span><span class="bound">r</span><span class="main">.</span> length <span class="bound">r</span> <span class="main">=</span> length <span class="free">signs</span><span class="main">)</span> <span class="main">(</span>map <span class="main">(</span>mtx_row <span class="free">signs</span><span class="main">)</span> <span class="free">ls</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">ls</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mtx_row_def<span class="main">)</span>

<span class="keyword1"><span class="command">thm</span></span> construct_lhs_vector_def
<span class="keyword1"><span class="command">thm</span></span>  poly_roots_finite

<span class="comment1">(* Recharacterize the LHS vector *)</span>
<span class="keyword1" id="Matrix_Equation_Construction-construct_lhs_vector_clean"><span class="command">lemma</span></span> construct_lhs_vector_clean<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> length <span class="free">signs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>construct_lhs_vector <span class="free">p</span> <span class="free">qs</span> <span class="free">signs</span><span class="main">)</span> <span class="main">$</span> <span class="free">i</span> <span class="main">=</span>
    card <span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> <span class="main">(</span><span class="main">(</span>consistent_sign_vec_copr <span class="free">qs</span> <span class="bound">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>nth <span class="free">signs</span> <span class="free">i</span><span class="main">)</span><span class="main">)</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> poly_roots_finite<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Collect
       <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> <span class="bound">v</span> <span class="main">=</span> <span class="free">signs</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span> <span class="main">∘</span>
        consistent_sign_vec_copr <span class="free">qs</span><span class="main">)</span> <span class="main">∩</span>
      set <span class="main">(</span>sorted_list_of_set
            <span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
    <span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> consistent_sign_vec_copr <span class="free">qs</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">signs</span> <span class="main">!</span> <span class="free">i</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> construct_lhs_vector_def vec_of_list_index characterize_root_list_p_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> nth_map<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> distinct_length_filter<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Matrix_Equation_Construction-construct_lhs_vector_cleaner"><span class="command">lemma</span></span> construct_lhs_vector_cleaner<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>construct_lhs_vector <span class="free">p</span> <span class="free">qs</span> <span class="free">signs</span><span class="main">)</span> <span class="main">=</span>
   vec_of_list <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> rat_of_int <span class="main">(</span>card <span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> <span class="main">(</span><span class="main">(</span>consistent_sign_vec_copr <span class="free">qs</span> <span class="bound">x</span><span class="main">)</span> <span class="main">=</span> <span class="bound">s</span><span class="main">)</span><span class="main">}</span><span class="main">)</span><span class="main">)</span> <span class="free">signs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> eq_vecI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>  construct_lhs_vector_clean<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">]</span></span> <span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> vec_of_list_index<span class="main">)</span>
  <span class="keyword1"><span class="command">unfolding</span></span> construct_lhs_vector_def
  <span class="keyword1"><span class="command">using</span></span> assms construct_lhs_vector_clean construct_lhs_vector_def <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="comment1">(* Show that because our consistent sign vectors consist of 1 and -1's, z returns 1 or -1 
  when applied to a consistent sign vector *)</span>
<span class="keyword1" id="Matrix_Equation_Construction-z_signs"><span class="command">lemma</span></span> z_signs<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"list_all <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> length <span class="free">signs</span><span class="main">)</span> <span class="free">I</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"list_all <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span> <span class="main">=</span> <span class="main">1</span> <span class="main">∨</span> <span class="bound">s</span> <span class="main">=</span> <span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="free">signs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>z <span class="free">I</span> <span class="free">signs</span> <span class="main">=</span> <span class="main">1</span><span class="main">)</span> <span class="main">∨</span> <span class="main">(</span>z <span class="free">I</span> <span class="free">signs</span> <span class="main">=</span> <span class="main">-</span><span class="main">1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">I</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>z_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">I</span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">signs</span> <span class="main">!</span> <span class="skolem">a</span> <span class="main">=</span> <span class="main">1</span> <span class="main">∨</span> <span class="free">signs</span> <span class="main">!</span> <span class="skolem">a</span> <span class="main">=</span> <span class="main">-</span><span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> add_Suc_right calculation<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> calculation<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> gr0_conv_Suc list.size<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> list_all_length nth_Cons_0<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>z_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Matrix_Equation_Construction-z_lemma"><span class="command">lemma</span></span> z_lemma<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">I</span><span class="main">::</span> <span class="quoted"><span class="quoted">"nat list"</span></span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">sign</span><span class="main">::</span> <span class="quoted"><span class="quoted">"rat list"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> consistent<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">sign</span> <span class="main">∈</span> set <span class="main">(</span>characterize_consistent_signs_at_roots_copr <span class="free">p</span> <span class="free">qs</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> welldefined<span class="main">:</span> <span class="quoted"><span class="quoted">"list_constr <span class="free">I</span> <span class="main">(</span>length <span class="free">qs</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>z <span class="free">I</span> <span class="free">sign</span> <span class="main">=</span> <span class="main">1</span><span class="main">)</span> <span class="main">∨</span> <span class="main">(</span>z <span class="free">I</span> <span class="free">sign</span> <span class="main">=</span> <span class="main">-</span><span class="main">1</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> z_signs<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="free">sign</span> <span class="main">=</span> length <span class="free">qs</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> consistent
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> characterize_consistent_signs_at_roots_copr_def consistent_sign_vec_copr_def<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"list_all <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> length <span class="free">sign</span><span class="main">)</span> <span class="free">I</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> welldefined
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> list_constr_def characterize_consistent_signs_at_roots_copr_def consistent_sign_vec_copr_def<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"list_all <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span> <span class="main">=</span> <span class="main">1</span> <span class="main">∨</span> <span class="bound">s</span> <span class="main">=</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="free">sign</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> consistent
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> list.pred_map  characterize_consistent_signs_at_roots_copr_def  consistent_sign_vec_copr_def<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> Ball_set
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(* Show that all consistent sign vectors on roots of polynomials are in characterize_consistent_signs_at_roots_copr  *)</span>
<span class="keyword1" id="Matrix_Equation_Construction-in_set"><span class="command">lemma</span></span> in_set<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">p</span><span class="main">::</span> <span class="quoted"><span class="quoted">"real poly"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> nonzero<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span><span class="main">≠</span><span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">qs</span><span class="main">::</span> <span class="quoted"><span class="quoted">"real poly list"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">I</span><span class="main">::</span> <span class="quoted"><span class="quoted">"nat list"</span></span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">sign</span><span class="main">::</span> <span class="quoted"><span class="quoted">"rat list"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">x</span><span class="main">::</span> <span class="quoted"><span class="quoted">"real"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> root_p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> sign_fix<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">sign</span> <span class="main">=</span> consistent_sign_vec_copr <span class="free">qs</span> <span class="free">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> welldefined<span class="main">:</span> <span class="quoted"><span class="quoted">"list_constr <span class="free">I</span> <span class="main">(</span>length <span class="free">qs</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">sign</span> <span class="main">∈</span> set <span class="main">(</span>characterize_consistent_signs_at_roots_copr <span class="free">p</span> <span class="free">qs</span><span class="main">)</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> h1<span class="main">:</span> <span class="quoted"><span class="quoted">"consistent_sign_vec_copr <span class="free">qs</span> <span class="free">x</span> <span class="main">∈</span>
      set <span class="main">(</span>remdups <span class="main">(</span>map <span class="main">(</span>consistent_sign_vec_copr <span class="free">qs</span><span class="main">)</span> <span class="main">(</span>sorted_list_of_set <span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> root_p <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> set_sorted_list_of_set<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> nonzero poly_roots_finite rsquarefree_def <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> characterize_consistent_signs_at_roots_copr_def characterize_root_list_p_def <span class="keyword1"><span class="command">using</span></span> sign_fix
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(* Since all of the polynomials in qs are relatively prime to p, products of subsets of these
    polynomials are also relatively prime to p  *)</span>
<span class="keyword1" id="Matrix_Equation_Construction-nonzero_product"><span class="command">lemma</span></span> nonzero_product<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">p</span><span class="main">::</span> <span class="quoted"><span class="quoted">"real poly"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> nonzero<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span><span class="main">≠</span><span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">qs</span><span class="main">::</span> <span class="quoted"><span class="quoted">"real poly list"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> pairwise_rel_prime_1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">q</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span>List.member <span class="free">qs</span> <span class="bound">q</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">(</span>coprime <span class="free">p</span> <span class="bound">q</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">I</span><span class="main">::</span> <span class="quoted"><span class="quoted">"nat list"</span></span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">x</span><span class="main">::</span> <span class="quoted"><span class="quoted">"real"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> root_p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> welldefined<span class="main">:</span> <span class="quoted"><span class="quoted">"list_constr <span class="free">I</span> <span class="main">(</span>length <span class="free">qs</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>poly <span class="main">(</span>prod_list <span class="main">(</span>retrieve_polys <span class="free">qs</span> <span class="free">I</span><span class="main">)</span><span class="main">)</span> <span class="free">x</span> <span class="main">&gt;</span> <span class="main">0</span><span class="main">)</span> <span class="main">∨</span> <span class="main">(</span>poly <span class="main">(</span>prod_list <span class="main">(</span>retrieve_polys <span class="free">qs</span> <span class="free">I</span><span class="main">)</span><span class="main">)</span> <span class="free">x</span> <span class="main">&lt;</span> <span class="main">0</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> set <span class="main">(</span>retrieve_polys <span class="free">qs</span> <span class="free">I</span><span class="main">)</span> <span class="main">⟹</span> coprime <span class="free">p</span> <span class="bound">x</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> retrieve_polys_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> in_set_conv_nth in_set_member length_map list_all_length list_constr_def nth_map pairwise_rel_prime_1 welldefined<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> coprimeh<span class="main">:</span> <span class="quoted"><span class="quoted">"coprime <span class="free">p</span> <span class="main">(</span>prod_list <span class="main">(</span>retrieve_polys <span class="free">qs</span> <span class="free">I</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> prod_list_coprime_right <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> root_p
    <span class="keyword1"><span class="command">using</span></span> coprime_poly_0 linorder_neqE_linordered_idom <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(* The next few lemmas relate z to the signs of the product of subsets of polynomials of qs *)</span>
<span class="keyword1" id="Matrix_Equation_Construction-horiz_vector_helper_pos_ind"><span class="command">lemma</span></span> horiz_vector_helper_pos_ind<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">p</span><span class="main">::</span> <span class="quoted"><span class="quoted">"real poly"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> nonzero<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span><span class="main">≠</span><span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">qs</span><span class="main">::</span> <span class="quoted"><span class="quoted">"real poly list"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> pairwise_rel_prime_1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">q</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span>List.member <span class="free">qs</span> <span class="bound">q</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">(</span>coprime <span class="free">p</span> <span class="bound">q</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">I</span><span class="main">::</span> <span class="quoted"><span class="quoted">"nat list"</span></span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">sign</span><span class="main">::</span> <span class="quoted"><span class="quoted">"rat list"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">x</span><span class="main">::</span> <span class="quoted"><span class="quoted">"real"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> root_p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> sign_fix<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">sign</span> <span class="main">=</span> consistent_sign_vec_copr <span class="free">qs</span> <span class="free">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>list_constr <span class="free">I</span> <span class="main">(</span>length <span class="free">qs</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">(</span>poly <span class="main">(</span>prod_list <span class="main">(</span>retrieve_polys <span class="free">qs</span> <span class="free">I</span><span class="main">)</span><span class="main">)</span> <span class="free">x</span> <span class="main">&gt;</span> <span class="main">0</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span>z <span class="free">I</span> <span class="free">sign</span> <span class="main">=</span> <span class="main">1</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">I</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> retrieve_polys_def z_def<span class="main">)</span> 
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">I</span><span class="main">)</span> 
  <span class="keyword1"><span class="command">have</span></span> welldef<span class="main">:</span> <span class="quoted"><span class="quoted">"list_constr <span class="main">(</span><span class="skolem">a</span><span class="main">#</span><span class="skolem">I</span><span class="main">)</span> <span class="main">(</span>length <span class="free">qs</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">(</span>list_constr <span class="skolem">I</span> <span class="main">(</span>length <span class="free">qs</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">unfolding</span></span> list_constr_def list_all_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> set_hyp<span class="main">:</span> <span class="quoted"><span class="quoted">"list_constr <span class="skolem">I</span> <span class="main">(</span>length <span class="free">qs</span><span class="main">)</span> <span class="main">⟶</span> <span class="free">sign</span> <span class="main">∈</span> set <span class="main">(</span>characterize_consistent_signs_at_roots_copr <span class="free">p</span> <span class="free">qs</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> in_set <span class="keyword1"><span class="command">using</span></span> nonzero root_p sign_fix <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
  <span class="keyword1"><span class="command">have</span></span> z_hyp<span class="main">:</span> <span class="quoted"><span class="quoted">"list_constr <span class="skolem">I</span> <span class="main">(</span>length <span class="free">qs</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">(</span>z <span class="skolem">I</span> <span class="free">sign</span> <span class="main">=</span> <span class="main">1</span><span class="main">)</span> <span class="main">∨</span> <span class="main">(</span>z <span class="skolem">I</span> <span class="free">sign</span> <span class="main">=</span> <span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> set_hyp z_lemma<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> sign<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="free">sign</span>"</span></span><span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> I <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">I</span>"</span></span><span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> p<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="free">p</span>"</span></span><span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> qs<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="free">qs</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> sign_hyp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">sign</span> <span class="main">=</span> map <span class="main">(</span><span class="main">λ</span> <span class="bound">q</span><span class="main">.</span> <span class="keyword1">if</span> <span class="main">(</span>poly <span class="bound">q</span> <span class="free">x</span> <span class="main">&gt;</span> <span class="main">0</span><span class="main">)</span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="free">qs</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> sign_fix <span class="keyword1"><span class="command">unfolding</span></span> consistent_sign_vec_copr_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> ind_hyp_1<span class="main">:</span> <span class="quoted"><span class="quoted">"list_constr <span class="main">(</span><span class="skolem">a</span><span class="main">#</span><span class="skolem">I</span><span class="main">)</span> <span class="main">(</span>length <span class="free">qs</span><span class="main">)</span> <span class="main">⟶</span> 
    <span class="main">(</span><span class="main">(</span><span class="main">0</span> <span class="main">&lt;</span> poly <span class="main">(</span>prod_list <span class="main">(</span>retrieve_polys <span class="free">qs</span> <span class="skolem">I</span><span class="main">)</span><span class="main">)</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>z <span class="skolem">I</span> <span class="free">sign</span> <span class="main">=</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> welldef Cons.hyps <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> ind_hyp_2<span class="main">:</span> <span class="quoted"><span class="quoted">"list_constr <span class="main">(</span><span class="skolem">a</span><span class="main">#</span><span class="skolem">I</span><span class="main">)</span> <span class="main">(</span>length <span class="free">qs</span><span class="main">)</span> <span class="main">⟶</span> 
    <span class="main">(</span><span class="main">(</span><span class="main">0</span> <span class="main">&gt;</span> poly <span class="main">(</span>prod_list <span class="main">(</span>retrieve_polys <span class="free">qs</span> <span class="skolem">I</span><span class="main">)</span><span class="main">)</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>z <span class="skolem">I</span> <span class="free">sign</span> <span class="main">=</span> <span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> welldef z_hyp Cons.hyps nonzero_product
    <span class="keyword1"><span class="command">using</span></span> pairwise_rel_prime_1 nonzero root_p <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
  <span class="keyword1"><span class="command">have</span></span> h1<span class="main">:</span> <span class="quoted"><span class="quoted">"prod_list <span class="main">(</span>retrieve_polys <span class="free">qs</span> <span class="main">(</span><span class="skolem">a</span> <span class="main">#</span> <span class="skolem">I</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>nth <span class="free">qs</span> <span class="skolem">a</span><span class="main">)</span><span class="main">*</span><span class="main">(</span>prod_list <span class="main">(</span>retrieve_polys <span class="free">qs</span> <span class="skolem">I</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> retrieve_polys_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> h2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>z <span class="main">(</span><span class="skolem">a</span> <span class="main">#</span> <span class="skolem">I</span><span class="main">)</span> <span class="free">sign</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>nth <span class="free">sign</span> <span class="skolem">a</span><span class="main">)</span><span class="main">*</span><span class="main">(</span>z <span class="skolem">I</span> <span class="free">sign</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> hide_lams<span class="main"><span class="main">)</span></span> list.simps<span class="main"><span class="main">(</span></span>9<span class="main"><span class="main">)</span></span> prod_list.Cons z_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> h3help<span class="main">:</span> <span class="quoted"><span class="quoted">"list_constr <span class="main">(</span><span class="skolem">a</span><span class="main">#</span><span class="skolem">I</span><span class="main">)</span> <span class="main">(</span>length <span class="free">qs</span><span class="main">)</span> <span class="main">⟶</span> <span class="skolem">a</span> <span class="main">&lt;</span> length <span class="free">qs</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> list_constr_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> h3<span class="main">:</span> <span class="quoted"><span class="quoted">"list_constr <span class="main">(</span><span class="skolem">a</span><span class="main">#</span><span class="skolem">I</span><span class="main">)</span> <span class="main">(</span>length <span class="free">qs</span><span class="main">)</span> <span class="main">⟶</span> 
    <span class="main">(</span><span class="main">(</span>nth <span class="free">sign</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="main">(</span>poly <span class="main">(</span>nth <span class="free">qs</span> <span class="skolem">a</span><span class="main">)</span> <span class="free">x</span> <span class="main">&gt;</span> <span class="main">0</span><span class="main">)</span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> nth_map sign_hyp <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> h2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">0</span> <span class="main">&lt;</span> poly <span class="main">(</span><span class="main">(</span>nth <span class="free">qs</span> <span class="skolem">a</span><span class="main">)</span><span class="main">*</span><span class="main">(</span>prod_list <span class="main">(</span>retrieve_polys <span class="free">qs</span> <span class="skolem">I</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">x</span><span class="main">)</span> <span class="main">⟷</span> 
    <span class="main">(</span><span class="main">(</span><span class="main">0</span> <span class="main">&lt;</span> poly <span class="main">(</span>nth <span class="free">qs</span> <span class="skolem">a</span><span class="main">)</span> <span class="free">x</span> <span class="main">∧</span> <span class="main">(</span><span class="main">0</span> <span class="main">&lt;</span> poly <span class="main">(</span>prod_list <span class="main">(</span>retrieve_polys <span class="free">qs</span> <span class="skolem">I</span><span class="main">)</span><span class="main">)</span> <span class="free">x</span><span class="main">)</span><span class="main">)</span> <span class="main">∨</span>
   <span class="main">(</span><span class="main">0</span> <span class="main">&gt;</span> poly <span class="main">(</span>nth <span class="free">qs</span> <span class="skolem">a</span><span class="main">)</span> <span class="free">x</span> <span class="main">∧</span> <span class="main">(</span><span class="main">0</span> <span class="main">&gt;</span> poly <span class="main">(</span>prod_list <span class="main">(</span>retrieve_polys <span class="free">qs</span> <span class="skolem">I</span><span class="main">)</span><span class="main">)</span> <span class="free">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> zero_less_mult_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> final_hyp_a<span class="main">:</span> <span class="quoted"><span class="quoted">"list_constr <span class="main">(</span><span class="skolem">a</span><span class="main">#</span><span class="skolem">I</span><span class="main">)</span> <span class="main">(</span>length <span class="free">qs</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="main">0</span> <span class="main">&lt;</span> poly <span class="main">(</span>nth <span class="free">qs</span> <span class="skolem">a</span><span class="main">)</span> <span class="free">x</span> <span class="main">∧</span> <span class="main">(</span><span class="main">0</span> <span class="main">&lt;</span> poly <span class="main">(</span>prod_list <span class="main">(</span>retrieve_polys <span class="free">qs</span> <span class="skolem">I</span><span class="main">)</span><span class="main">)</span> <span class="free">x</span><span class="main">)</span><span class="main">)</span> 
    <span class="main">∨</span> <span class="main">(</span><span class="main">0</span> <span class="main">&gt;</span> poly <span class="main">(</span>nth <span class="free">qs</span> <span class="skolem">a</span><span class="main">)</span> <span class="free">x</span> <span class="main">∧</span> <span class="main">(</span><span class="main">0</span> <span class="main">&gt;</span> poly <span class="main">(</span>prod_list <span class="main">(</span>retrieve_polys <span class="free">qs</span> <span class="skolem">I</span><span class="main">)</span><span class="main">)</span> <span class="free">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
    <span class="main">(</span><span class="main">(</span>nth <span class="free">sign</span> <span class="skolem">a</span><span class="main">)</span><span class="main">*</span><span class="main">(</span>z <span class="skolem">I</span> <span class="free">sign</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> extra_hyp_a<span class="main">:</span> <span class="quoted"><span class="quoted">"list_constr <span class="main">(</span><span class="skolem">a</span><span class="main">#</span><span class="skolem">I</span><span class="main">)</span> <span class="main">(</span>length <span class="free">qs</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">0</span> <span class="main">&lt;</span> poly <span class="main">(</span>nth <span class="free">qs</span> <span class="skolem">a</span><span class="main">)</span> <span class="free">x</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span>nth <span class="free">sign</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> h3
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> 
    <span class="keyword1"><span class="command">have</span></span> extra_hyp_b<span class="main">:</span> <span class="quoted"><span class="quoted">"list_constr <span class="main">(</span><span class="skolem">a</span><span class="main">#</span><span class="skolem">I</span><span class="main">)</span> <span class="main">(</span>length <span class="free">qs</span><span class="main">)</span> <span class="main">⟶</span>  <span class="main">(</span><span class="main">0</span> <span class="main">&gt;</span> poly <span class="main">(</span>nth <span class="free">qs</span> <span class="skolem">a</span><span class="main">)</span> <span class="free">x</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span>nth <span class="free">sign</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">=</span> <span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> h3 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> coprime_poly_0 h3help in_set_member nth_mem pairwise_rel_prime_1 root_p <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span> 
    <span class="keyword1"><span class="command">have</span></span> ind_hyp_1<span class="main">:</span> <span class="quoted"><span class="quoted">"list_constr <span class="main">(</span><span class="skolem">a</span><span class="main">#</span><span class="skolem">I</span><span class="main">)</span> <span class="main">(</span>length <span class="free">qs</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="main">0</span> <span class="main">&lt;</span> poly <span class="main">(</span>nth <span class="free">qs</span> <span class="skolem">a</span><span class="main">)</span> <span class="free">x</span> <span class="main">∧</span> <span class="main">(</span>z <span class="skolem">I</span> <span class="free">sign</span> <span class="main">=</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">∨</span> 
    <span class="main">(</span><span class="main">0</span> <span class="main">&gt;</span> poly <span class="main">(</span>nth <span class="free">qs</span> <span class="skolem">a</span><span class="main">)</span> <span class="free">x</span> <span class="main">∧</span> <span class="main">(</span>z <span class="skolem">I</span> <span class="free">sign</span> <span class="main">=</span> <span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
      <span class="main">=</span> <span class="main">(</span><span class="main">(</span>nth <span class="free">sign</span> <span class="skolem">a</span><span class="main">)</span><span class="main">*</span><span class="main">(</span>z <span class="skolem">I</span> <span class="free">sign</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> extra_hyp_a extra_hyp_b
      <span class="keyword1"><span class="command">using</span></span> zmult_eq_1_iff
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> h3<span class="main">)</span>   
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> ind_hyp_1 ind_hyp_2 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Cons.hyps welldef<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
    <span class="keyword1"><span class="command">using</span></span> h1 z_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> zero_less_mult_iff<span class="main">)</span>  
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Matrix_Equation_Construction-horiz_vector_helper_pos"><span class="command">lemma</span></span> horiz_vector_helper_pos<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">p</span><span class="main">::</span> <span class="quoted"><span class="quoted">"real poly"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> nonzero<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span><span class="main">≠</span><span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">qs</span><span class="main">::</span> <span class="quoted"><span class="quoted">"real poly list"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> pairwise_rel_prime_1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">q</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span>List.member <span class="free">qs</span> <span class="bound">q</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">(</span>coprime <span class="free">p</span> <span class="bound">q</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">I</span><span class="main">::</span> <span class="quoted"><span class="quoted">"nat list"</span></span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">sign</span><span class="main">::</span> <span class="quoted"><span class="quoted">"rat list"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">x</span><span class="main">::</span> <span class="quoted"><span class="quoted">"real"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> root_p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> sign_fix<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">sign</span> <span class="main">=</span> consistent_sign_vec_copr <span class="free">qs</span> <span class="free">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> welldefined<span class="main">:</span> <span class="quoted"><span class="quoted">"list_constr <span class="free">I</span> <span class="main">(</span>length <span class="free">qs</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>poly <span class="main">(</span>prod_list <span class="main">(</span>retrieve_polys <span class="free">qs</span> <span class="free">I</span><span class="main">)</span><span class="main">)</span> <span class="free">x</span> <span class="main">&gt;</span> <span class="main">0</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span>z <span class="free">I</span> <span class="free">sign</span> <span class="main">=</span> <span class="main">1</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> horiz_vector_helper_pos_ind
  <span class="keyword1"><span class="command">using</span></span> pairwise_rel_prime_1 nonzero  root_p sign_fix welldefined <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 

<span class="keyword1" id="Matrix_Equation_Construction-horiz_vector_helper_neg"><span class="command">lemma</span></span> horiz_vector_helper_neg<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">p</span><span class="main">::</span> <span class="quoted"><span class="quoted">"real poly"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> nonzero<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span><span class="main">≠</span><span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">qs</span><span class="main">::</span> <span class="quoted"><span class="quoted">"real poly list"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> pairwise_rel_prime_1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">q</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span>List.member <span class="free">qs</span> <span class="bound">q</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">(</span>coprime <span class="free">p</span> <span class="bound">q</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">I</span><span class="main">::</span> <span class="quoted"><span class="quoted">"nat list"</span></span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">sign</span><span class="main">::</span> <span class="quoted"><span class="quoted">"rat list"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">x</span><span class="main">::</span> <span class="quoted"><span class="quoted">"real"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> root_p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> sign_fix<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">sign</span> <span class="main">=</span> consistent_sign_vec_copr <span class="free">qs</span> <span class="free">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> welldefined<span class="main">:</span> <span class="quoted"><span class="quoted">"list_constr <span class="free">I</span> <span class="main">(</span>length <span class="free">qs</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>poly <span class="main">(</span>prod_list <span class="main">(</span>retrieve_polys <span class="free">qs</span> <span class="free">I</span><span class="main">)</span><span class="main">)</span> <span class="free">x</span> <span class="main">&lt;</span> <span class="main">0</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span>z <span class="free">I</span> <span class="free">sign</span> <span class="main">=</span> <span class="main">-</span><span class="main">1</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
  <span class="keyword1"><span class="command">have</span></span> set_hyp<span class="main">:</span> <span class="quoted"><span class="quoted">"list_constr <span class="free">I</span> <span class="main">(</span>length <span class="free">qs</span><span class="main">)</span> <span class="main">⟶</span> <span class="free">sign</span> <span class="main">∈</span> set <span class="main">(</span>characterize_consistent_signs_at_roots_copr <span class="free">p</span> <span class="free">qs</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> in_set <span class="keyword1"><span class="command">using</span></span> nonzero root_p sign_fix <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
  <span class="keyword1"><span class="command">have</span></span> z_hyp<span class="main">:</span> <span class="quoted"><span class="quoted">"list_constr <span class="free">I</span> <span class="main">(</span>length <span class="free">qs</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">(</span>z <span class="free">I</span> <span class="free">sign</span> <span class="main">=</span> <span class="main">1</span><span class="main">)</span> <span class="main">∨</span> <span class="main">(</span>z <span class="free">I</span> <span class="free">sign</span> <span class="main">=</span> <span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> set_hyp  z_lemma<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> sign<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="free">sign</span>"</span></span><span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> I <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="free">I</span>"</span></span><span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> p<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="free">p</span>"</span></span><span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> qs<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="free">qs</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> poly_hyp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>poly <span class="main">(</span>prod_list <span class="main">(</span>retrieve_polys <span class="free">qs</span> <span class="free">I</span><span class="main">)</span><span class="main">)</span> <span class="free">x</span> <span class="main">&gt;</span> <span class="main">0</span><span class="main">)</span> <span class="main">∨</span> <span class="main">(</span>poly <span class="main">(</span>prod_list <span class="main">(</span>retrieve_polys <span class="free">qs</span> <span class="free">I</span><span class="main">)</span><span class="main">)</span> <span class="free">x</span> <span class="main">&lt;</span> <span class="main">0</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> nonzero_product
    <span class="keyword1"><span class="command">using</span></span> pairwise_rel_prime_1 nonzero root_p
    <span class="keyword1"><span class="command">using</span></span> welldefined <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> pos_hyp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>poly <span class="main">(</span>prod_list <span class="main">(</span>retrieve_polys <span class="free">qs</span> <span class="free">I</span><span class="main">)</span><span class="main">)</span> <span class="free">x</span> <span class="main">&gt;</span> <span class="main">0</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span>z <span class="free">I</span> <span class="free">sign</span> <span class="main">=</span> <span class="main">1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> horiz_vector_helper_pos
    <span class="keyword1"><span class="command">using</span></span> pairwise_rel_prime_1 nonzero root_p sign_fix welldefined <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> z_hyp poly_hyp pos_hyp <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> welldefined <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(* Recharacterize the dot product *)</span>
<span class="keyword1" id="Matrix_Equation_Construction-vec_of_list_dot_rewrite"><span class="command">lemma</span></span> vec_of_list_dot_rewrite<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"length <span class="free">xs</span> <span class="main">=</span> length <span class="free">ys</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"vec_of_list <span class="free">xs</span> <span class="main">∙</span> vec_of_list <span class="free">ys</span> <span class="main">=</span>
    sum_list <span class="main">(</span>map2 <span class="main">(*)</span> <span class="free">xs</span> <span class="free">ys</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span><span class="quoted"><span class="free">ys</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> <span class="main"><span class="main">(</span></span>verit<span class="main"><span class="main">,</span></span> best<span class="main"><span class="main">)</span></span> Suc_length_conv list.simps<span class="main"><span class="main">(</span></span>9<span class="main"><span class="main">)</span></span> old.prod.case scalar_prod_vCons sum_list.Cons vec_of_list_Cons zip_Cons_Cons<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Matrix_Equation_Construction-lhs_dot_rewrite"><span class="command">lemma</span></span> lhs_dot_rewrite<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">p</span><span class="main">::</span> <span class="quoted"><span class="quoted">"real poly"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">qs</span><span class="main">::</span> <span class="quoted"><span class="quoted">"real poly list"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">I</span><span class="main">::</span> <span class="quoted"><span class="quoted">"nat list"</span></span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">signs</span><span class="main">::</span> <span class="quoted"><span class="quoted">"rat list list"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> nonzero<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span><span class="main">≠</span><span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span>vec_of_list <span class="main">(</span>mtx_row <span class="free">signs</span> <span class="free">I</span><span class="main">)</span> <span class="main">∙</span> <span class="main">(</span>construct_lhs_vector <span class="free">p</span> <span class="free">qs</span> <span class="free">signs</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
   sum_list <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">(</span>z <span class="free">I</span> <span class="bound">s</span><span class="main">)</span>  <span class="main">*</span>  rat_of_int <span class="main">(</span>card <span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> consistent_sign_vec_copr <span class="free">qs</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">s</span><span class="main">}</span><span class="main">)</span><span class="main">)</span> <span class="free">signs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> nonzero <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> construct_lhs_vector_cleaner<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> rhseq<span class="main">:</span> <span class="quoted"><span class="quoted">"construct_lhs_vector <span class="free">p</span> <span class="free">qs</span> <span class="free">signs</span> <span class="main">=</span>
    vec_of_list
    <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> rat_of_int <span class="main">(</span>card <span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> consistent_sign_vec_copr <span class="free">qs</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">s</span><span class="main">}</span><span class="main">)</span><span class="main">)</span> <span class="free">signs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>vec_of_list <span class="main">(</span>mtx_row <span class="free">signs</span> <span class="free">I</span><span class="main">)</span> <span class="main">∙</span> <span class="main">(</span>construct_lhs_vector <span class="free">p</span> <span class="free">qs</span> <span class="free">signs</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>    
    sum_list <span class="main">(</span>map2 <span class="main">(*)</span> <span class="main">(</span>mtx_row <span class="free">signs</span> <span class="free">I</span><span class="main">)</span> <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> rat_of_int <span class="main">(</span>card <span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> consistent_sign_vec_copr <span class="free">qs</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">s</span><span class="main">}</span><span class="main">)</span><span class="main">)</span> <span class="free">signs</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> rhseq
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> vec_of_list_dot_rewrite<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mtx_row_def<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> mtx_row_def
    <span class="keyword1"><span class="command">using</span></span> map2_map_map 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map2_map_map<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Matrix_Equation_Construction-sum_list_distinct_filter"><span class="command">lemma</span></span> sum_list_distinct_filter<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span><span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> int"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"distinct <span class="free">xs</span>"</span></span> <span class="quoted"><span class="quoted">"distinct <span class="free">ys</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"set <span class="free">ys</span> <span class="main">⊆</span> set <span class="free">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> set <span class="free">xs</span> <span class="main">-</span> set <span class="free">ys</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sum_list <span class="main">(</span>map <span class="free">f</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> sum_list <span class="main">(</span>map <span class="free">f</span> <span class="free">ys</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> List.finite_set assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> sum.mono_neutral_cong_left sum_list_distinct_conv_sum_set<span class="main">)</span>

<span class="comment1">(* If we have a superset of the signs, we can drop to just the consistent ones *)</span>
<span class="keyword1" id="Matrix_Equation_Construction-construct_lhs_vector_drop_consistent"><span class="command">lemma</span></span> construct_lhs_vector_drop_consistent<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">p</span><span class="main">::</span> <span class="quoted"><span class="quoted">"real poly"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">qs</span><span class="main">::</span> <span class="quoted"><span class="quoted">"real poly list"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">I</span><span class="main">::</span> <span class="quoted"><span class="quoted">"nat list"</span></span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">signs</span><span class="main">::</span> <span class="quoted"><span class="quoted">"rat list list"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> nonzero<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span><span class="main">≠</span><span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> distinct_signs<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="free">signs</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> all_info<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>characterize_consistent_signs_at_roots_copr <span class="free">p</span> <span class="free">qs</span><span class="main">)</span> <span class="main">⊆</span> set<span class="main">(</span><span class="free">signs</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> welldefined<span class="main">:</span> <span class="quoted"><span class="quoted">"list_constr <span class="free">I</span> <span class="main">(</span>length <span class="free">qs</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span>vec_of_list <span class="main">(</span>mtx_row <span class="free">signs</span> <span class="free">I</span><span class="main">)</span> <span class="main">∙</span> <span class="main">(</span>construct_lhs_vector <span class="free">p</span> <span class="free">qs</span> <span class="free">signs</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
     <span class="main">(</span>vec_of_list <span class="main">(</span>mtx_row <span class="main">(</span>characterize_consistent_signs_at_roots_copr <span class="free">p</span> <span class="free">qs</span><span class="main">)</span> <span class="free">I</span><span class="main">)</span> <span class="main">∙</span>
      <span class="main">(</span>construct_lhs_vector <span class="free">p</span> <span class="free">qs</span> <span class="main">(</span>characterize_consistent_signs_at_roots_copr <span class="free">p</span> <span class="free">qs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
  <span class="keyword1"><span class="command">have</span></span> h0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">sgn</span><span class="main">.</span> <span class="bound">sgn</span> <span class="main">∈</span> set <span class="free">signs</span> <span class="main">∧</span> <span class="bound">sgn</span> <span class="main">∉</span> consistent_sign_vec_copr <span class="free">qs</span> <span class="main">`</span> set <span class="main">(</span>characterize_root_list_p <span class="free">p</span><span class="main">)</span> <span class="main">∧</span> <span class="main">0</span> <span class="main">&lt;</span> rat_of_nat <span class="main">(</span>card
                  <span class="main">{</span><span class="bound">xa</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">xa</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> consistent_sign_vec_copr <span class="free">qs</span> <span class="bound">xa</span> <span class="main">=</span> <span class="bound">sgn</span><span class="main">}</span><span class="main">)</span> <span class="main">⟶</span> z <span class="free">I</span> <span class="bound">sgn</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">sgn</span><span class="main">.</span> <span class="bound">sgn</span> <span class="main">∈</span> set <span class="free">signs</span> <span class="main">∧</span> <span class="bound">sgn</span> <span class="main">∉</span> consistent_sign_vec_copr <span class="free">qs</span> <span class="main">`</span> set <span class="main">(</span>characterize_root_list_p <span class="free">p</span><span class="main">)</span> <span class="main">∧</span> <span class="main">0</span> <span class="main">&lt;</span> rat_of_int <span class="main">(</span>card
                  <span class="main">{</span><span class="bound">xa</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">xa</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> consistent_sign_vec_copr <span class="free">qs</span> <span class="bound">xa</span> <span class="main">=</span> <span class="bound">sgn</span><span class="main">}</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">{</span><span class="bound">xa</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">xa</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> consistent_sign_vec_copr <span class="free">qs</span> <span class="bound">xa</span> <span class="main">=</span> <span class="bound">sgn</span><span class="main">}</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">iis</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"rat list"</span></span>
        <span class="keyword1"><span class="command">have</span></span> ff1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≠</span> <span class="free">p</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> nonzero rsquarefree_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">rr</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>real <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> real"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
          ff2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">p</span><span class="main">.</span> <span class="bound">p</span> <span class="main">(</span><span class="skolem">rr</span> <span class="bound">p</span><span class="main">)</span> <span class="main">∨</span> Collect <span class="bound">p</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">moura</span>
        <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">is</span><span class="main">.</span> <span class="bound">is</span> <span class="main">=</span> <span class="skolem">iis</span> <span class="main">∧</span> <span class="main">{</span><span class="bound">r</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">r</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> consistent_sign_vec_copr <span class="free">qs</span> <span class="bound">r</span> <span class="main">=</span> <span class="bound">is</span><span class="main">}</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">is</span><span class="main">.</span> consistent_sign_vec_copr <span class="free">qs</span> <span class="main">(</span><span class="skolem">rr</span> <span class="main">(</span><span class="main">λ</span><span class="bound">r</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">r</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> consistent_sign_vec_copr <span class="free">qs</span> <span class="bound">r</span> <span class="main">=</span> <span class="bound">is</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">iis</span> <span class="main">∧</span> <span class="main">{</span><span class="bound">r</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">r</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> consistent_sign_vec_copr <span class="free">qs</span> <span class="bound">r</span> <span class="main">=</span> <span class="bound">is</span><span class="main">}</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> ff2
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">r</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">r</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> consistent_sign_vec_copr <span class="free">qs</span> <span class="bound">r</span> <span class="main">=</span> <span class="skolem">iis</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> ff2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">smt</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">iis</span> <span class="main">∈</span> consistent_sign_vec_copr <span class="free">qs</span> <span class="main">`</span> set <span class="main">(</span>sorted_list_of_set <span class="main">{</span><span class="bound">r</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">r</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> ff1 poly_roots_finite <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span> <span class="keyword1"><span class="command">}</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">iis</span> <span class="main">∉</span> set <span class="free">signs</span> <span class="main">∨</span> <span class="skolem">iis</span> <span class="main">∈</span> consistent_sign_vec_copr <span class="free">qs</span> <span class="main">`</span> set <span class="main">(</span>characterize_root_list_p <span class="free">p</span><span class="main">)</span> <span class="main">∨</span> <span class="main">¬</span> <span class="main">0</span> <span class="main">&lt;</span> rat_of_int <span class="main">(</span>int <span class="main">(</span>card <span class="main">{</span><span class="bound">r</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">r</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> consistent_sign_vec_copr <span class="free">qs</span> <span class="bound">r</span> <span class="main">=</span> <span class="skolem">iis</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span><span class="bound">sgn</span><span class="main">.</span> <span class="bound">sgn</span> <span class="main">∈</span> set <span class="free">signs</span> <span class="main">∧</span> <span class="bound">sgn</span> <span class="main">∉</span> consistent_sign_vec_copr <span class="free">qs</span> <span class="main">`</span> set <span class="main">(</span>characterize_root_list_p <span class="free">p</span><span class="main">)</span> <span class="main">∧</span> <span class="main">0</span> <span class="main">&lt;</span> rat_of_int <span class="main">(</span>int <span class="main">(</span>card <span class="main">{</span><span class="bound">xa</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">xa</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> consistent_sign_vec_copr <span class="free">qs</span> <span class="bound">xa</span> <span class="main">=</span> <span class="bound">sgn</span><span class="main">}</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">{</span><span class="bound">xa</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">xa</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> consistent_sign_vec_copr <span class="free">qs</span> <span class="bound">xa</span> <span class="main">=</span> <span class="bound">sgn</span><span class="main">}</span> <span class="main">≠</span> <span class="main">{}</span>›</span></span> characterize_root_list_p_def<span class="main">)</span> <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">sgn</span><span class="main">.</span> <span class="bound">sgn</span> <span class="main">∈</span> set <span class="free">signs</span> <span class="main">∧</span> <span class="bound">sgn</span> <span class="main">∉</span> consistent_sign_vec_copr <span class="free">qs</span> <span class="main">`</span> set <span class="main">(</span>characterize_root_list_p <span class="free">p</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">(</span><span class="main">0</span> <span class="main">=</span> rat_of_nat <span class="main">(</span>card
                  <span class="main">{</span><span class="bound">xa</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">xa</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> consistent_sign_vec_copr <span class="free">qs</span> <span class="bound">xa</span> <span class="main">=</span> <span class="bound">sgn</span><span class="main">}</span><span class="main">)</span> <span class="main">∨</span> z <span class="free">I</span> <span class="bound">sgn</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> hyp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">s</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∈</span> set <span class="free">signs</span> <span class="main">∧</span> <span class="bound">s</span> <span class="main">∉</span> consistent_sign_vec_copr <span class="free">qs</span> <span class="main">`</span> set <span class="main">(</span>characterize_root_list_p <span class="free">p</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">(</span>z <span class="free">I</span> <span class="bound">s</span> <span class="main">*</span> rat_of_nat <span class="main">(</span>card <span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> consistent_sign_vec_copr <span class="free">qs</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">s</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">s</span><span class="main">∈</span> set<span class="main">(</span><span class="free">signs</span><span class="main">)</span><span class="main">.</span> z <span class="free">I</span> <span class="bound">s</span> <span class="main">*</span> rat_of_nat <span class="main">(</span>card <span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> consistent_sign_vec_copr <span class="free">qs</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">s</span><span class="main">}</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
        <span class="main">(</span><span class="main">∑</span><span class="bound">s</span><span class="main">∈</span><span class="main">(</span>set <span class="main">(</span><span class="free">signs</span><span class="main">)</span> <span class="main">∩</span> <span class="main">(</span>consistent_sign_vec_copr <span class="free">qs</span> <span class="main">`</span> set <span class="main">(</span>characterize_root_list_p <span class="free">p</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> z <span class="free">I</span> <span class="bound">s</span> <span class="main">*</span> rat_of_nat <span class="main">(</span>card <span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> consistent_sign_vec_copr <span class="free">qs</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">s</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set<span class="main">(</span><span class="free">signs</span><span class="main">)</span> <span class="main">=</span><span class="main">(</span>set <span class="main">(</span><span class="free">signs</span><span class="main">)</span> <span class="main">∩</span> <span class="main">(</span>consistent_sign_vec_copr <span class="free">qs</span> <span class="main">`</span> set <span class="main">(</span>characterize_root_list_p <span class="free">p</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span>
              <span class="main">(</span>set<span class="main">(</span><span class="free">signs</span><span class="main">)</span><span class="main">-</span><span class="main">(</span>consistent_sign_vec_copr <span class="free">qs</span> <span class="main">`</span> set <span class="main">(</span>characterize_root_list_p <span class="free">p</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> sum_rewrite<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">s</span><span class="main">∈</span> set<span class="main">(</span><span class="free">signs</span><span class="main">)</span><span class="main">.</span> z <span class="free">I</span> <span class="bound">s</span> <span class="main">*</span> rat_of_nat <span class="main">(</span>card <span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> consistent_sign_vec_copr <span class="free">qs</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">s</span><span class="main">}</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>  
          <span class="main">(</span><span class="main">∑</span><span class="bound">s</span><span class="main">∈</span> <span class="main">(</span>set <span class="main">(</span><span class="free">signs</span><span class="main">)</span> <span class="main">∩</span> <span class="main">(</span>consistent_sign_vec_copr <span class="free">qs</span> <span class="main">`</span> set <span class="main">(</span>characterize_root_list_p <span class="free">p</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span>
              <span class="main">(</span>set<span class="main">(</span><span class="free">signs</span><span class="main">)</span><span class="main">-</span><span class="main">(</span>consistent_sign_vec_copr <span class="free">qs</span> <span class="main">`</span> set <span class="main">(</span>characterize_root_list_p <span class="free">p</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> z <span class="free">I</span> <span class="bound">s</span> <span class="main">*</span> rat_of_nat <span class="main">(</span>card <span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> consistent_sign_vec_copr <span class="free">qs</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">s</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> sum_split<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">s</span><span class="main">∈</span> <span class="main">(</span>set <span class="main">(</span><span class="free">signs</span><span class="main">)</span> <span class="main">∩</span> <span class="main">(</span>consistent_sign_vec_copr <span class="free">qs</span> <span class="main">`</span> set <span class="main">(</span>characterize_root_list_p <span class="free">p</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span>
              <span class="main">(</span>set<span class="main">(</span><span class="free">signs</span><span class="main">)</span><span class="main">-</span><span class="main">(</span>consistent_sign_vec_copr <span class="free">qs</span> <span class="main">`</span> set <span class="main">(</span>characterize_root_list_p <span class="free">p</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> z <span class="free">I</span> <span class="bound">s</span> <span class="main">*</span> rat_of_nat <span class="main">(</span>card <span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> consistent_sign_vec_copr <span class="free">qs</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">s</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>
          <span class="main">=</span> 
<span class="main">(</span><span class="main">∑</span><span class="bound">s</span><span class="main">∈</span> <span class="main">(</span>set <span class="main">(</span><span class="free">signs</span><span class="main">)</span> <span class="main">∩</span> <span class="main">(</span>consistent_sign_vec_copr <span class="free">qs</span> <span class="main">`</span> set <span class="main">(</span>characterize_root_list_p <span class="free">p</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> z <span class="free">I</span> <span class="bound">s</span> <span class="main">*</span> rat_of_nat <span class="main">(</span>card <span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> consistent_sign_vec_copr <span class="free">qs</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">s</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>
<span class="main">+</span> <span class="main">(</span><span class="main">∑</span><span class="bound">s</span><span class="main">∈</span> <span class="main">(</span>set<span class="main">(</span><span class="free">signs</span><span class="main">)</span><span class="main">-</span><span class="main">(</span>consistent_sign_vec_copr <span class="free">qs</span> <span class="main">`</span> set <span class="main">(</span>characterize_root_list_p <span class="free">p</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> z <span class="free">I</span> <span class="bound">s</span> <span class="main">*</span> rat_of_nat <span class="main">(</span>card <span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> consistent_sign_vec_copr <span class="free">qs</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">s</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> List.finite_set sum.Int_Diff<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> sum_zero<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">s</span><span class="main">∈</span> <span class="main">(</span>set<span class="main">(</span><span class="free">signs</span><span class="main">)</span><span class="main">-</span><span class="main">(</span>consistent_sign_vec_copr <span class="free">qs</span> <span class="main">`</span> set <span class="main">(</span>characterize_root_list_p <span class="free">p</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> z <span class="free">I</span> <span class="bound">s</span> <span class="main">*</span> rat_of_nat <span class="main">(</span>card <span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> consistent_sign_vec_copr <span class="free">qs</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">s</span><span class="main">}</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>   
      <span class="keyword1"><span class="command">using</span></span> hyp
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> hyp<span class="main">)</span>      
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> sum_rewrite sum_split sum_zero <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> set_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>remdups
           <span class="main">(</span>map <span class="main">(</span>consistent_sign_vec_copr <span class="free">qs</span><span class="main">)</span>
             <span class="main">(</span>characterize_root_list_p <span class="free">p</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> set <span class="main">(</span><span class="free">signs</span><span class="main">)</span> <span class="main">∩</span> <span class="main">(</span>consistent_sign_vec_copr <span class="free">qs</span> <span class="main">`</span> set <span class="main">(</span>characterize_root_list_p <span class="free">p</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> all_info
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> characterize_consistent_signs_at_roots_copr_def subset_antisym<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> hyp1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">s</span><span class="main">←</span><span class="free">signs</span><span class="main">.</span> z <span class="free">I</span> <span class="bound">s</span> <span class="main">*</span> rat_of_nat <span class="main">(</span>card <span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> consistent_sign_vec_copr <span class="free">qs</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">s</span><span class="main">}</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
        <span class="main">(</span><span class="main">∑</span><span class="bound">s</span><span class="main">∈</span>set <span class="main">(</span><span class="free">signs</span><span class="main">)</span><span class="main">.</span> z <span class="free">I</span> <span class="bound">s</span> <span class="main">*</span> rat_of_nat <span class="main">(</span>card <span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> consistent_sign_vec_copr <span class="free">qs</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">s</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> distinct_signs sum_list_distinct_conv_sum_set <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> hyp2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">s</span><span class="main">←</span>remdups
           <span class="main">(</span>map <span class="main">(</span>consistent_sign_vec_copr <span class="free">qs</span><span class="main">)</span>
             <span class="main">(</span>characterize_root_list_p <span class="free">p</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> z <span class="free">I</span> <span class="bound">s</span> <span class="main">*</span> rat_of_nat <span class="main">(</span>card <span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> consistent_sign_vec_copr <span class="free">qs</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">s</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>
  <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">s</span><span class="main">∈</span> set <span class="main">(</span>remdups
           <span class="main">(</span>map <span class="main">(</span>consistent_sign_vec_copr <span class="free">qs</span><span class="main">)</span>
             <span class="main">(</span>characterize_root_list_p <span class="free">p</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> z <span class="free">I</span> <span class="bound">s</span> <span class="main">*</span> rat_of_nat <span class="main">(</span>card <span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> consistent_sign_vec_copr <span class="free">qs</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">s</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> sum_list_distinct_conv_sum_set <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
  <span class="keyword1"><span class="command">have</span></span> set_sum_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">s</span><span class="main">∈</span><span class="main">(</span>set <span class="main">(</span><span class="free">signs</span><span class="main">)</span> <span class="main">∩</span> <span class="main">(</span>consistent_sign_vec_copr <span class="free">qs</span> <span class="main">`</span> set <span class="main">(</span>characterize_root_list_p <span class="free">p</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> z <span class="free">I</span> <span class="bound">s</span> <span class="main">*</span> rat_of_nat <span class="main">(</span>card <span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> consistent_sign_vec_copr <span class="free">qs</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">s</span><span class="main">}</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
    <span class="main">(</span><span class="main">∑</span><span class="bound">s</span><span class="main">∈</span> set <span class="main">(</span>remdups
           <span class="main">(</span>map <span class="main">(</span>consistent_sign_vec_copr <span class="free">qs</span><span class="main">)</span>
             <span class="main">(</span>characterize_root_list_p <span class="free">p</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> z <span class="free">I</span> <span class="bound">s</span> <span class="main">*</span> rat_of_nat <span class="main">(</span>card <span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> consistent_sign_vec_copr <span class="free">qs</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">s</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> set_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">s</span><span class="main">←</span><span class="free">signs</span><span class="main">.</span> z <span class="free">I</span> <span class="bound">s</span> <span class="main">*</span> rat_of_nat <span class="main">(</span>card <span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> consistent_sign_vec_copr <span class="free">qs</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">s</span><span class="main">}</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
    <span class="main">(</span><span class="main">∑</span><span class="bound">s</span><span class="main">←</span>remdups
           <span class="main">(</span>map <span class="main">(</span>consistent_sign_vec_copr <span class="free">qs</span><span class="main">)</span>
             <span class="main">(</span>characterize_root_list_p <span class="free">p</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> z <span class="free">I</span> <span class="bound">s</span> <span class="main">*</span> rat_of_nat <span class="main">(</span>card <span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> consistent_sign_vec_copr <span class="free">qs</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">s</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> set_sum_eq hyp1 hyp2
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main">∑</span><span class="bound">s</span><span class="main">∈</span>set <span class="free">signs</span><span class="main">.</span> z <span class="free">I</span> <span class="bound">s</span> <span class="main">*</span> rat_of_nat <span class="main">(</span>card <span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> consistent_sign_vec_copr <span class="free">qs</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">s</span><span class="main">}</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">s</span><span class="main">∈</span>set <span class="free">signs</span> <span class="main">∩</span> consistent_sign_vec_copr <span class="free">qs</span> <span class="main">`</span> set <span class="main">(</span>characterize_root_list_p <span class="free">p</span><span class="main">)</span><span class="main">.</span> z <span class="free">I</span> <span class="bound">s</span> <span class="main">*</span> rat_of_nat <span class="main">(</span>card <span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> consistent_sign_vec_copr <span class="free">qs</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">s</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"consistent_sign_vec_copr <span class="free">qs</span> <span class="main">`</span> set <span class="main">(</span>characterize_root_list_p <span class="free">p</span><span class="main">)</span> <span class="main">⊆</span> set <span class="free">signs</span> <span class="main">⟹</span>
    <span class="main">(</span><span class="main">⋀</span><span class="bound">p</span> <span class="bound">qss</span><span class="main">.</span>
        characterize_consistent_signs_at_roots_copr <span class="bound">p</span> <span class="bound">qss</span> <span class="main">=</span>
        remdups <span class="main">(</span>map <span class="main">(</span>consistent_sign_vec_copr <span class="bound">qss</span><span class="main">)</span> <span class="main">(</span>characterize_root_list_p <span class="bound">p</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span>
    <span class="main">(</span><span class="main">∑</span><span class="bound">s</span><span class="main">←</span><span class="free">signs</span><span class="main">.</span> z <span class="free">I</span> <span class="bound">s</span> <span class="main">*</span> rat_of_nat <span class="main">(</span>card <span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> consistent_sign_vec_copr <span class="free">qs</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">s</span><span class="main">}</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
    <span class="main">(</span><span class="main">∑</span><span class="bound">s</span><span class="main">←</span>remdups
           <span class="main">(</span>map <span class="main">(</span>consistent_sign_vec_copr <span class="free">qs</span><span class="main">)</span>
             <span class="main">(</span>characterize_root_list_p <span class="free">p</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> z <span class="free">I</span> <span class="bound">s</span> <span class="main">*</span> rat_of_nat <span class="main">(</span>card <span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> consistent_sign_vec_copr <span class="free">qs</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">s</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>  <span class="keyword1"><span class="command">unfolding</span></span> lhs_dot_rewrite<span class="main">[</span><span class="operator">OF</span> nonzero<span class="main">]</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> sum_list_distinct_filter <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> distinct_signs  characterize_consistent_signs_at_roots_copr_def<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> all_info characterize_consistent_signs_at_roots_copr_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(* Both matrix_equation_helper_step and matrix_equation_main_step relate the matrix construction 
   to the Tarski queries, i.e. relate the product of a row of the matrix and the LHS vector to a 
   Tarski query on the RHS *)</span>
<span class="keyword1" id="Matrix_Equation_Construction-matrix_equation_helper_step"><span class="command">lemma</span></span> matrix_equation_helper_step<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">p</span><span class="main">::</span> <span class="quoted"><span class="quoted">"real poly"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">qs</span><span class="main">::</span> <span class="quoted"><span class="quoted">"real poly list"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">I</span><span class="main">::</span> <span class="quoted"><span class="quoted">"nat list"</span></span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">signs</span><span class="main">::</span> <span class="quoted"><span class="quoted">"rat list list"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> nonzero<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span><span class="main">≠</span><span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> distinct_signs<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="free">signs</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> all_info<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>characterize_consistent_signs_at_roots_copr <span class="free">p</span> <span class="free">qs</span><span class="main">)</span> <span class="main">⊆</span> set<span class="main">(</span><span class="free">signs</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> welldefined<span class="main">:</span> <span class="quoted"><span class="quoted">"list_constr <span class="free">I</span> <span class="main">(</span>length <span class="free">qs</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> pairwise_rel_prime_1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">q</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span>List.member <span class="free">qs</span> <span class="bound">q</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">(</span>coprime <span class="free">p</span> <span class="bound">q</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>vec_of_list <span class="main">(</span>mtx_row <span class="free">signs</span> <span class="free">I</span><span class="main">)</span> <span class="main">∙</span> <span class="main">(</span>construct_lhs_vector <span class="free">p</span> <span class="free">qs</span> <span class="free">signs</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
   rat_of_int <span class="main">(</span>card <span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> poly <span class="main">(</span>prod_list <span class="main">(</span>retrieve_polys <span class="free">qs</span> <span class="free">I</span><span class="main">)</span><span class="main">)</span> <span class="bound">x</span> <span class="main">&gt;</span> <span class="main">0</span><span class="main">}</span><span class="main">)</span> <span class="main">-</span>
   rat_of_int <span class="main">(</span>card <span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> poly <span class="main">(</span>prod_list <span class="main">(</span>retrieve_polys <span class="free">qs</span> <span class="free">I</span><span class="main">)</span><span class="main">)</span> <span class="bound">x</span> <span class="main">&lt;</span> <span class="main">0</span><span class="main">}</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>set <span class="main">(</span>map <span class="main">(</span>consistent_sign_vec_copr <span class="free">qs</span><span class="main">)</span>  <span class="main">(</span>characterize_root_list_p <span class="free">p</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?gt</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>set <span class="main">(</span>map <span class="main">(</span>consistent_sign_vec_copr <span class="free">qs</span><span class="main">)</span>  <span class="main">(</span>characterize_root_list_p <span class="free">p</span><span class="main">)</span><span class="main">)</span> <span class="main">∩</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> z <span class="free">I</span> <span class="bound">s</span> <span class="main">=</span> <span class="main">1</span><span class="main">}</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?lt</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"  <span class="main">(</span>set <span class="main">(</span>map <span class="main">(</span>consistent_sign_vec_copr <span class="free">qs</span><span class="main">)</span>  <span class="main">(</span>characterize_root_list_p <span class="free">p</span><span class="main">)</span><span class="main">)</span> <span class="main">∩</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> z <span class="free">I</span> <span class="bound">s</span> <span class="main">=</span> <span class="main">-</span><span class="main">1</span><span class="main">}</span><span class="main">)</span>"</span></span>  
  <span class="keyword1"><span class="command">have</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>map <span class="main">(</span>consistent_sign_vec_copr <span class="free">qs</span><span class="main">)</span>  <span class="main">(</span>characterize_root_list_p <span class="free">p</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="var">?gt</span> <span class="main">∪</span> <span class="var">?lt</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> characterize_root_list_p_def horiz_vector_helper_neg horiz_vector_helper_pos_ind nonzero nonzero_product pairwise_rel_prime_1 poly_roots_finite sorted_list_of_set<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> welldefined<span class="main">)</span>
      <span class="comment1">(* First, drop the signs that are irrelevant *)</span>
  <span class="keyword1"><span class="command">from</span></span> construct_lhs_vector_drop_consistent<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1-4<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span>
    <span class="quoted"><span class="quoted">"vec_of_list <span class="main">(</span>mtx_row <span class="free">signs</span> <span class="free">I</span><span class="main">)</span> <span class="main">∙</span> construct_lhs_vector <span class="free">p</span> <span class="free">qs</span> <span class="free">signs</span> <span class="main">=</span>
  vec_of_list <span class="main">(</span>mtx_row <span class="main">(</span>characterize_consistent_signs_at_roots_copr <span class="free">p</span> <span class="free">qs</span><span class="main">)</span> <span class="free">I</span><span class="main">)</span> <span class="main">∙</span>
  construct_lhs_vector <span class="free">p</span> <span class="free">qs</span> <span class="main">(</span>characterize_consistent_signs_at_roots_copr <span class="free">p</span> <span class="free">qs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="comment1">(* Now we split the sum *)</span>
  <span class="keyword1"><span class="command">from</span></span> lhs_dot_rewrite<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command"><span class="improper">moreover</span></span></span> <span class="keyword1"><span class="command"><span class="improper">have</span></span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span>
  <span class="main">(</span><span class="main">∑</span><span class="bound">s</span><span class="main">←</span>characterize_consistent_signs_at_roots_copr <span class="free">p</span> <span class="free">qs</span><span class="main">.</span>
    z <span class="free">I</span> <span class="bound">s</span> <span class="main">*</span> rat_of_int <span class="main">(</span>card <span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> consistent_sign_vec_copr <span class="free">qs</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">s</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span>
  <span class="main">(</span><span class="main">∑</span><span class="bound">s</span><span class="main">∈</span>set <span class="main">(</span>map <span class="main">(</span>consistent_sign_vec_copr <span class="free">qs</span><span class="main">)</span>  <span class="main">(</span>characterize_root_list_p <span class="free">p</span><span class="main">)</span><span class="main">)</span><span class="main">.</span>
    z <span class="free">I</span> <span class="bound">s</span> <span class="main">*</span> rat_of_int <span class="main">(</span>card <span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> consistent_sign_vec_copr <span class="free">qs</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">s</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> characterize_consistent_signs_at_roots_copr_def sum_code<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span>
  <span class="main">(</span><span class="main">∑</span><span class="bound">s</span><span class="main">∈</span><span class="var">?gt</span><span class="main">.</span> z <span class="free">I</span> <span class="bound">s</span> <span class="main">*</span> rat_of_int <span class="main">(</span>card <span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> consistent_sign_vec_copr <span class="free">qs</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">s</span><span class="main">}</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span>
  <span class="main">(</span><span class="main">∑</span><span class="bound">s</span><span class="main">∈</span><span class="var">?lt</span><span class="main">.</span> z <span class="free">I</span> <span class="bound">s</span> <span class="main">*</span> rat_of_int <span class="main">(</span>card <span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> consistent_sign_vec_copr <span class="free">qs</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">s</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> eq<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> sum.union_disjoint<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="comment1">(* Now recharacterize lt, gt*)</span>
  <span class="keyword1"><span class="command">have</span></span> setroots<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>characterize_root_list_p <span class="free">p</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> characterize_root_list_p_def
    <span class="keyword1"><span class="command">using</span></span> poly_roots_finite nonzero rsquarefree_def set_sorted_list_of_set <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>    
  <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> consistent_sign_vec_copr <span class="free">qs</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">s</span><span class="main">}</span> <span class="main">=</span>
        <span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span><span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span><span class="main">.</span> consistent_sign_vec_copr <span class="free">qs</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">s</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> lem_e1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span> <span class="main">⟹</span>
       card
        <span class="main">{</span><span class="bound"><span class="bound">s</span></span> <span class="main">∈</span> consistent_sign_vec_copr  <span class="free">qs</span> <span class="main">`</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span> <span class="main">∩</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> z <span class="free">I</span> <span class="bound">s</span> <span class="main">=</span> <span class="main">1</span><span class="main">}</span><span class="main">.</span>
         consistent_sign_vec_copr <span class="free">qs</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">s</span><span class="main">}</span> <span class="main">=</span>
       <span class="main">(</span><span class="keyword1">if</span> <span class="main">0</span> <span class="main">&lt;</span> poly <span class="main">(</span>prod_list <span class="main">(</span>retrieve_polys <span class="free">qs</span> <span class="free">I</span><span class="main">)</span><span class="main">)</span> <span class="bound">x</span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
    <span class="keyword3"><span class="command">assume</span></span> rt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound"><span class="bound">s</span></span> <span class="main">∈</span> consistent_sign_vec_copr <span class="free">qs</span> <span class="main">`</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span> <span class="main">∩</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> z <span class="free">I</span> <span class="bound">s</span> <span class="main">=</span> <span class="main">1</span><span class="main">}</span><span class="main">.</span> consistent_sign_vec_copr <span class="free">qs</span> <span class="skolem">x</span> <span class="main">=</span> <span class="bound">s</span><span class="main">}</span> <span class="main">=</span>
      <span class="main">{</span><span class="bound">s</span><span class="main">.</span> z <span class="free">I</span> <span class="bound">s</span> <span class="main">=</span> <span class="main">1</span> <span class="main">∧</span> consistent_sign_vec_copr <span class="free">qs</span> <span class="skolem">x</span> <span class="main">=</span> <span class="bound">s</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> horiz_vector_helper_pos<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> rt<span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="main">(</span><span class="main">0</span> <span class="main">&lt;</span> poly <span class="main">(</span>prod_list <span class="main">(</span>retrieve_polys <span class="free">qs</span> <span class="free">I</span><span class="main">)</span><span class="main">)</span> <span class="skolem">x</span><span class="main">)</span>  <span class="main">∧</span> consistent_sign_vec_copr <span class="free">qs</span> <span class="skolem">x</span> <span class="main">=</span> <span class="bound">s</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> welldefined <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="main">(</span><span class="main">0</span> <span class="main">&lt;</span> poly <span class="main">(</span>prod_list <span class="main">(</span>retrieve_polys <span class="free">qs</span> <span class="free">I</span><span class="main">)</span><span class="main">)</span> <span class="skolem">x</span><span class="main">)</span>  <span class="keyword1">then</span> <span class="main">{</span>consistent_sign_vec_copr <span class="free">qs</span> <span class="skolem">x</span><span class="main">}</span> <span class="keyword1">else</span> <span class="main">{}</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"card <span class="main">{</span><span class="bound"><span class="bound">s</span></span> <span class="main">∈</span> consistent_sign_vec_copr <span class="free">qs</span> <span class="main">`</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span> <span class="main">∩</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> z <span class="free">I</span> <span class="bound">s</span> <span class="main">=</span> <span class="main">1</span><span class="main">}</span><span class="main">.</span> consistent_sign_vec_copr <span class="free">qs</span> <span class="skolem">x</span> <span class="main">=</span> <span class="bound">s</span><span class="main">}</span> <span class="main">=</span>
         <span class="main">(</span><span class="keyword1">if</span> <span class="main">0</span> <span class="main">&lt;</span> poly <span class="main">(</span>prod_list <span class="main">(</span>retrieve_polys <span class="free">qs</span> <span class="free">I</span><span class="main">)</span><span class="main">)</span> <span class="skolem">x</span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span> "</span></span> <span class="keyword1"><span class="command">using</span></span> 1 2 3 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">have</span></span> e1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">s</span><span class="main">∈</span>consistent_sign_vec_copr <span class="free">qs</span> <span class="main">`</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span> <span class="main">∩</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> z <span class="free">I</span> <span class="bound">s</span> <span class="main">=</span> <span class="main">1</span><span class="main">}</span><span class="main">.</span>
       card <span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> consistent_sign_vec_copr <span class="free">qs</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">s</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span>
     <span class="main">(</span>sum <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">if</span> <span class="main">(</span>poly <span class="main">(</span>prod_list <span class="main">(</span>retrieve_polys <span class="free">qs</span> <span class="free">I</span><span class="main">)</span><span class="main">)</span> <span class="bound">x</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> * <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> sum_multicount_gen<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹finite <span class="main">(</span>set <span class="main">(</span>map <span class="main">(</span>consistent_sign_vec_copr <span class="free">qs</span><span class="main">)</span> <span class="main">(</span>characterize_root_list_p <span class="free">p</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>›</span></span> setroots <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> List.finite_set setroots<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> lem_e1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> gtchr<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">s</span><span class="main">∈</span><span class="var">?gt</span><span class="main">.</span> z <span class="free">I</span> <span class="bound">s</span> <span class="main">*</span> rat_of_int <span class="main">(</span>card <span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> consistent_sign_vec_copr <span class="free">qs</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">s</span><span class="main">}</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
    rat_of_int <span class="main">(</span>card <span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> <span class="main">0</span> <span class="main">&lt;</span> poly <span class="main">(</span>prod_list <span class="main">(</span>retrieve_polys <span class="free">qs</span> <span class="free">I</span><span class="main">)</span><span class="main">)</span> <span class="bound">x</span><span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> setroots<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> of_nat_sum<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> of_nat_eq_iff<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> e1<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> card_eq_sum<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> sum.mono_neutral_cong_right<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> List.finite_set setroots<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> lem_e2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span> <span class="main">⟹</span>
       card
        <span class="main">{</span><span class="bound"><span class="bound">s</span></span> <span class="main">∈</span> consistent_sign_vec_copr  <span class="free">qs</span> <span class="main">`</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span> <span class="main">∩</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> z <span class="free">I</span> <span class="bound">s</span> <span class="main">=</span> <span class="main">-</span><span class="main">1</span><span class="main">}</span><span class="main">.</span>
         consistent_sign_vec_copr <span class="free">qs</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">s</span><span class="main">}</span> <span class="main">=</span>
       <span class="main">(</span><span class="keyword1">if</span> poly <span class="main">(</span>prod_list <span class="main">(</span>retrieve_polys <span class="free">qs</span> <span class="free">I</span><span class="main">)</span><span class="main">)</span> <span class="bound">x</span> <span class="main">&lt;</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
    <span class="keyword3"><span class="command">assume</span></span> rt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound"><span class="bound">s</span></span> <span class="main">∈</span> consistent_sign_vec_copr <span class="free">qs</span> <span class="main">`</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span> <span class="main">∩</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> z <span class="free">I</span> <span class="bound">s</span> <span class="main">=</span> <span class="main">-</span><span class="main">1</span><span class="main">}</span><span class="main">.</span> consistent_sign_vec_copr <span class="free">qs</span> <span class="skolem">x</span> <span class="main">=</span> <span class="bound">s</span><span class="main">}</span> <span class="main">=</span>
      <span class="main">{</span><span class="bound">s</span><span class="main">.</span> z <span class="free">I</span> <span class="bound">s</span> <span class="main">=</span> <span class="main">-</span><span class="main">1</span> <span class="main">∧</span> consistent_sign_vec_copr <span class="free">qs</span> <span class="skolem">x</span> <span class="main">=</span> <span class="bound">s</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> horiz_vector_helper_neg<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> rt<span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="main">(</span><span class="main">0</span> <span class="main">&gt;</span> poly <span class="main">(</span>prod_list <span class="main">(</span>retrieve_polys <span class="free">qs</span> <span class="free">I</span><span class="main">)</span><span class="main">)</span> <span class="skolem">x</span><span class="main">)</span>  <span class="main">∧</span> consistent_sign_vec_copr <span class="free">qs</span> <span class="skolem">x</span> <span class="main">=</span> <span class="bound">s</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> welldefined <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="main">(</span><span class="main">0</span> <span class="main">&gt;</span> poly <span class="main">(</span>prod_list <span class="main">(</span>retrieve_polys <span class="free">qs</span> <span class="free">I</span><span class="main">)</span><span class="main">)</span> <span class="skolem">x</span><span class="main">)</span>  <span class="keyword1">then</span> <span class="main">{</span>consistent_sign_vec_copr <span class="free">qs</span> <span class="skolem">x</span><span class="main">}</span> <span class="keyword1">else</span> <span class="main">{}</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"card <span class="main">{</span><span class="bound"><span class="bound">s</span></span> <span class="main">∈</span> consistent_sign_vec_copr <span class="free">qs</span> <span class="main">`</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span> <span class="main">∩</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> z <span class="free">I</span> <span class="bound">s</span> <span class="main">=</span> <span class="main">-</span><span class="main">1</span><span class="main">}</span><span class="main">.</span> consistent_sign_vec_copr <span class="free">qs</span> <span class="skolem">x</span> <span class="main">=</span> <span class="bound">s</span><span class="main">}</span> <span class="main">=</span>
       <span class="main">(</span><span class="keyword1">if</span> poly <span class="main">(</span>prod_list <span class="main">(</span>retrieve_polys <span class="free">qs</span> <span class="free">I</span><span class="main">)</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">&lt;</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1 2 3 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">have</span></span> e2<span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="main">(</span><span class="main">∑</span><span class="bound">s</span><span class="main">∈</span>consistent_sign_vec_copr <span class="free">qs</span> <span class="main">`</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span> <span class="main">∩</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> z <span class="free">I</span> <span class="bound">s</span> <span class="main">=</span> <span class="main">-</span> <span class="main">1</span><span class="main">}</span><span class="main">.</span>
       card <span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> consistent_sign_vec_copr <span class="free">qs</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">s</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span>
     <span class="main">(</span>sum <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">if</span> <span class="main">(</span>poly <span class="main">(</span>prod_list <span class="main">(</span>retrieve_polys <span class="free">qs</span> <span class="free">I</span><span class="main">)</span><span class="main">)</span> <span class="bound">x</span><span class="main">)</span> <span class="main">&lt;</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> * <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> sum_multicount_gen<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹finite <span class="main">(</span>set <span class="main">(</span>map <span class="main">(</span>consistent_sign_vec_copr <span class="free">qs</span><span class="main">)</span> <span class="main">(</span>characterize_root_list_p <span class="free">p</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>›</span></span> setroots <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> List.finite_set setroots<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> lem_e2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> ltchr<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">s</span><span class="main">∈</span><span class="var">?lt</span><span class="main">.</span> z <span class="free">I</span> <span class="bound">s</span> <span class="main">*</span> rat_of_int <span class="main">(</span>card <span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> consistent_sign_vec_copr <span class="free">qs</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">s</span><span class="main">}</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
    <span class="main">-</span> rat_of_int <span class="main">(</span>card <span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> <span class="main">0</span> <span class="main">&gt;</span> poly <span class="main">(</span>prod_list <span class="main">(</span>retrieve_polys <span class="free">qs</span> <span class="free">I</span><span class="main">)</span><span class="main">)</span> <span class="bound">x</span><span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> setroots sum_negf<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> of_nat_sum<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> of_nat_eq_iff<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> e2<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> card_eq_sum<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> sum.mono_neutral_cong_right<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> List.finite_set setroots<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> gtchr ltchr
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main">∑</span><span class="bound">s</span><span class="main">∈</span>set <span class="main">(</span>map <span class="main">(</span>consistent_sign_vec_copr <span class="free">qs</span><span class="main">)</span> <span class="main">(</span>characterize_root_list_p <span class="free">p</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> z <span class="free">I</span> <span class="bound">s</span> <span class="main">*</span> rat_of_int <span class="main">(</span>card <span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> consistent_sign_vec_copr <span class="free">qs</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">s</span><span class="main">}</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">s</span><span class="main">∈</span>set <span class="main">(</span>map <span class="main">(</span>consistent_sign_vec_copr <span class="free">qs</span><span class="main">)</span> <span class="main">(</span>characterize_root_list_p <span class="free">p</span><span class="main">)</span><span class="main">)</span> <span class="main">∩</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> z <span class="free">I</span> <span class="bound">s</span> <span class="main">=</span> <span class="main">1</span><span class="main">}</span><span class="main">.</span> z <span class="free">I</span> <span class="bound">s</span> <span class="main">*</span> rat_of_int <span class="main">(</span>card <span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> consistent_sign_vec_copr <span class="free">qs</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">s</span><span class="main">}</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="main">∑</span><span class="bound">s</span><span class="main">∈</span>set <span class="main">(</span>map <span class="main">(</span>consistent_sign_vec_copr <span class="free">qs</span><span class="main">)</span> <span class="main">(</span>characterize_root_list_p <span class="free">p</span><span class="main">)</span><span class="main">)</span> <span class="main">∩</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> z <span class="free">I</span> <span class="bound">s</span> <span class="main">=</span> <span class="main">-</span> <span class="main">1</span><span class="main">}</span><span class="main">.</span> z <span class="free">I</span> <span class="bound">s</span> <span class="main">*</span> rat_of_int <span class="main">(</span>card <span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> consistent_sign_vec_copr <span class="free">qs</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">s</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main">∑</span><span class="bound">s</span><span class="main">←</span>characterize_consistent_signs_at_roots_copr <span class="free">p</span> <span class="free">qs</span><span class="main">.</span> z <span class="free">I</span> <span class="bound">s</span> <span class="main">*</span> rat_of_int <span class="main">(</span>card <span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> consistent_sign_vec_copr <span class="free">qs</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">s</span><span class="main">}</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">s</span><span class="main">∈</span>set <span class="main">(</span>map <span class="main">(</span>consistent_sign_vec_copr <span class="free">qs</span><span class="main">)</span> <span class="main">(</span>characterize_root_list_p <span class="free">p</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> z <span class="free">I</span> <span class="bound">s</span> <span class="main">*</span> rat_of_int <span class="main">(</span>card <span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> consistent_sign_vec_copr <span class="free">qs</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">s</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹vec_of_list <span class="main">(</span>mtx_row <span class="main">(</span>characterize_consistent_signs_at_roots_copr <span class="free">p</span> <span class="free">qs</span><span class="main">)</span> <span class="free">I</span><span class="main">)</span> <span class="main">∙</span> construct_lhs_vector <span class="free">p</span> <span class="free">qs</span> <span class="main">(</span>characterize_consistent_signs_at_roots_copr <span class="free">p</span> <span class="free">qs</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">s</span><span class="main">←</span>characterize_consistent_signs_at_roots_copr <span class="free">p</span> <span class="free">qs</span><span class="main">.</span> z <span class="free">I</span> <span class="bound">s</span> <span class="main">*</span> rat_of_int <span class="main">(</span>card <span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> consistent_sign_vec_copr <span class="free">qs</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">s</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹vec_of_list <span class="main">(</span>mtx_row <span class="free">signs</span> <span class="free">I</span><span class="main">)</span> <span class="main">∙</span> construct_lhs_vector <span class="free">p</span> <span class="free">qs</span> <span class="free">signs</span> <span class="main">=</span> vec_of_list <span class="main">(</span>mtx_row <span class="main">(</span>characterize_consistent_signs_at_roots_copr <span class="free">p</span> <span class="free">qs</span><span class="main">)</span> <span class="free">I</span><span class="main">)</span> <span class="main">∙</span> construct_lhs_vector <span class="free">p</span> <span class="free">qs</span> <span class="main">(</span>characterize_consistent_signs_at_roots_copr <span class="free">p</span> <span class="free">qs</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(* A clean restatement of the helper lemma *)</span>
<span class="keyword1" id="Matrix_Equation_Construction-matrix_equation_main_step"><span class="command">lemma</span></span> matrix_equation_main_step<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">p</span><span class="main">::</span> <span class="quoted"><span class="quoted">"real poly"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">qs</span><span class="main">::</span> <span class="quoted"><span class="quoted">"real poly list"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">I</span><span class="main">::</span> <span class="quoted"><span class="quoted">"nat list"</span></span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">signs</span><span class="main">::</span> <span class="quoted"><span class="quoted">"rat list list"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> nonzero<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span><span class="main">≠</span><span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> distinct_signs<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="free">signs</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> all_info<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>characterize_consistent_signs_at_roots_copr <span class="free">p</span> <span class="free">qs</span><span class="main">)</span> <span class="main">⊆</span> set<span class="main">(</span><span class="free">signs</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> welldefined<span class="main">:</span> <span class="quoted"><span class="quoted">"list_constr <span class="free">I</span> <span class="main">(</span>length <span class="free">qs</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> pairwise_rel_prime_1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">q</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span>List.member <span class="free">qs</span> <span class="bound">q</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">(</span>coprime <span class="free">p</span> <span class="bound">q</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>vec_of_list <span class="main">(</span>mtx_row <span class="free">signs</span> <span class="free">I</span><span class="main">)</span> <span class="main">∙</span> <span class="main">(</span>construct_lhs_vector <span class="free">p</span> <span class="free">qs</span> <span class="free">signs</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>  
    construct_NofI <span class="free">p</span> <span class="main">(</span>retrieve_polys <span class="free">qs</span> <span class="free">I</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> construct_NofI_prop<span class="main">[</span><span class="operator">OF</span> nonzero<span class="main">]</span>
    <span class="keyword1"><span class="command">using</span></span> matrix_equation_helper_step<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>

<span class="keyword1" id="Matrix_Equation_Construction-map_vec_vec_of_list_eq_intro"><span class="command">lemma</span></span> map_vec_vec_of_list_eq_intro<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"map <span class="free">f</span> <span class="free">xs</span> <span class="main">=</span> map <span class="free">g</span> <span class="free">ys</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"map_vec <span class="free">f</span> <span class="main">(</span>vec_of_list <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> map_vec <span class="free">g</span> <span class="main">(</span>vec_of_list <span class="free">ys</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms vec_of_list_map<span class="main">)</span>

<span class="comment1">(* Shows that as long as we have a "basis" of sign assignments (see assumptions all_info, welldefined), 
  and some other mild assumptions on our inputs (given in nonzero, distinct_signs, pairwise_rel_prime),
  the construction will be satisfied *)</span>
<span class="keyword1"><span class="command">theorem</span></span> matrix_equation<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">p</span><span class="main">::</span> <span class="quoted"><span class="quoted">"real poly"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">qs</span><span class="main">::</span> <span class="quoted"><span class="quoted">"real poly list"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">subsets</span><span class="main">::</span> <span class="quoted"><span class="quoted">"nat list list"</span></span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">signs</span><span class="main">::</span> <span class="quoted"><span class="quoted">"rat list list"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> nonzero<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span><span class="main">≠</span><span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> distinct_signs<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="free">signs</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> all_info<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>characterize_consistent_signs_at_roots_copr <span class="free">p</span> <span class="free">qs</span><span class="main">)</span> <span class="main">⊆</span> set<span class="main">(</span><span class="free">signs</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> pairwise_rel_prime<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">q</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span>List.member <span class="free">qs</span> <span class="bound">q</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">(</span>coprime <span class="free">p</span> <span class="bound">q</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> welldefined<span class="main">:</span> <span class="quoted"><span class="quoted">"all_list_constr <span class="main">(</span><span class="free">subsets</span><span class="main">)</span> <span class="main">(</span>length <span class="free">qs</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"satisfy_equation <span class="free">p</span> <span class="free">qs</span> <span class="free">subsets</span> <span class="free">signs</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> satisfy_equation_def matrix_A_def
    construct_lhs_vector_def construct_rhs_vector_def all_list_constr_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> mult_mat_vec_of_list<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mtx_row_length <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> map_vec_vec_of_list_eq_intro<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> matrix_equation_main_step<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1-3<span class="main"><span class="main">)</span></span> _ assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">unfolded</span> construct_lhs_vector_def<span class="main">]</span>
  <span class="keyword1"><span class="command">using</span></span> all_list_constr_def in_set_member welldefined <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="comment1">(* Prettifying some theorems*)</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">roots</span><span class="main">::</span> <span class="quoted"><span class="quoted">"real poly <span class="main">⇒</span> real set"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">roots</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">sgn</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>linordered_field <span class="main">⇒</span> rat"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">sgn</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">&gt;</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="main">1</span>
                  <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">&lt;</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="main">-</span><span class="main">1</span>
                  <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">sgn_vec</span><span class="main">::</span><span class="quoted"><span class="quoted">"real poly list <span class="main">⇒</span> real <span class="main">⇒</span> rat list"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">sgn_vec</span> <span class="free"><span class="bound"><span class="entity">qs</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">≡</span>  map <span class="main">(</span>sgn <span class="main">∘</span> <span class="main">(</span><span class="main">λ</span><span class="bound">q</span><span class="main">.</span> poly <span class="bound">q</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">qs</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">consistent_signs_at_roots</span><span class="main">::</span> <span class="quoted"><span class="quoted">"real poly <span class="main">⇒</span> real poly list <span class="main">⇒</span> rat list set"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">consistent_signs_at_roots</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">qs</span></span></span> <span class="main">=</span>
    <span class="main">(</span>sgn_vec <span class="free"><span class="bound"><span class="entity">qs</span></span></span><span class="main">)</span> <span class="main">`</span> <span class="main">(</span>roots <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Matrix_Equation_Construction-consistent_signs_at_roots_eq"><span class="command">lemma</span></span> consistent_signs_at_roots_eq<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"consistent_signs_at_roots <span class="free">p</span> <span class="free">qs</span> <span class="main">=</span>
         set <span class="main">(</span>characterize_consistent_signs_at_roots <span class="free">p</span> <span class="free">qs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> consistent_signs_at_roots_def characterize_consistent_signs_at_roots_def
    characterize_root_list_p_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> set_sorted_list_of_set<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> assms poly_roots_finite <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">unfolding</span></span> sgn_vec_def sgn_def signs_at_def squash_def o_def
  <span class="keyword1"><span class="command">using</span></span> roots_def <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> Collect_cong assms image_iff poly_roots_finite roots_def sorted_list_of_set<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">w_vec</span><span class="main">::</span> <span class="quoted"><span class="quoted">"real poly <span class="main">⇒</span> real poly list <span class="main">⇒</span> rat list list  <span class="main">⇒</span> rat vec"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">w_vec</span> <span class="main">≡</span> construct_lhs_vector"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">v_vec</span><span class="main">::</span> <span class="quoted"><span class="quoted">"real poly <span class="main">⇒</span> real poly list <span class="main">⇒</span> nat list list <span class="main">⇒</span> rat vec"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">v_vec</span> <span class="main">≡</span> construct_rhs_vector"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">M_mat</span><span class="main">::</span> <span class="quoted"><span class="quoted">"rat list list <span class="main">⇒</span> nat list list <span class="main">⇒</span> rat mat"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">M_mat</span> <span class="main">≡</span> matrix_A"</span></span>

<span class="keyword1"><span class="command">theorem</span></span> matrix_equation_pretty<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span><span class="main">≠</span><span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">q</span><span class="main">.</span> <span class="bound">q</span> <span class="main">∈</span> set <span class="free">qs</span> <span class="main">⟹</span> coprime <span class="free">p</span> <span class="bound">q</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"distinct <span class="free">signs</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"consistent_signs_at_roots <span class="free">p</span> <span class="free">qs</span> <span class="main">⊆</span> set <span class="free">signs</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">l</span> <span class="bound">i</span><span class="main">.</span> <span class="bound">l</span> <span class="main">∈</span> set <span class="free">subsets</span> <span class="main">⟹</span> <span class="bound">i</span> <span class="main">∈</span> set <span class="bound">l</span> <span class="main">⟹</span> <span class="bound">i</span> <span class="main">&lt;</span> length <span class="free">qs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"M_mat <span class="free">signs</span> <span class="free">subsets</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>v</sub></span> w_vec <span class="free">p</span> <span class="free">qs</span> <span class="free">signs</span> <span class="main">=</span> v_vec <span class="free">p</span> <span class="free">qs</span> <span class="free">subsets</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> satisfy_equation_def<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> matrix_equation<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> consistent_signs_at_roots_eq csa_list_copr_rel member_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> in_set_member<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> Ball_set all_list_constr_def assms<span class="main">(</span>5<span class="main">)</span> list_constr_def member_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="BKR_Proofs">
<div class="head">
<h1>Theory BKR_Proofs</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> BKR_Proofs
  <span class="keyword2"><span class="keyword">imports</span></span> <span class="quoted">"<a href="#Matrix_Equation_Construction">Matrix_Equation_Construction</a>"</span>

<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">well_def_signs</span><span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">=&gt;</span> rat list list <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">well_def_signs</span> <span class="free"><span class="bound"><span class="entity">num_polys</span></span></span> <span class="free"><span class="bound"><span class="entity">sign_conds</span></span></span> <span class="main">≡</span> <span class="main">∀</span> <span class="bound">signs</span> <span class="main">∈</span> set<span class="main">(</span><span class="free"><span class="bound"><span class="entity">sign_conds</span></span></span><span class="main">)</span><span class="main">.</span> <span class="main">(</span>length <span class="bound">signs</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">num_polys</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">satisfies_properties</span><span class="main">::</span> <span class="quoted"><span class="quoted">"real poly <span class="main">⇒</span> real poly list <span class="main">⇒</span> nat list list <span class="main">⇒</span> rat list list <span class="main">⇒</span> rat mat <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">satisfies_properties</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">qs</span></span></span> <span class="free"><span class="bound"><span class="entity">subsets</span></span></span> <span class="free"><span class="bound"><span class="entity">signs</span></span></span> <span class="free"><span class="bound"><span class="entity">matrix</span></span></span> <span class="main">=</span> 
  <span class="main">(</span> all_list_constr <span class="free"><span class="bound"><span class="entity">subsets</span></span></span> <span class="main">(</span>length <span class="free"><span class="bound"><span class="entity">qs</span></span></span><span class="main">)</span> <span class="main">∧</span> well_def_signs <span class="main">(</span>length <span class="free"><span class="bound"><span class="entity">qs</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">signs</span></span></span> <span class="main">∧</span> distinct <span class="free"><span class="bound"><span class="entity">signs</span></span></span>
  <span class="main">∧</span> satisfy_equation <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">qs</span></span></span> <span class="free"><span class="bound"><span class="entity">subsets</span></span></span> <span class="free"><span class="bound"><span class="entity">signs</span></span></span> <span class="main">∧</span>  invertible_mat <span class="free"><span class="bound"><span class="entity">matrix</span></span></span>  <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">matrix</span></span></span> <span class="main">=</span> matrix_A <span class="free"><span class="bound"><span class="entity">signs</span></span></span> <span class="free"><span class="bound"><span class="entity">subsets</span></span></span>
  <span class="main">∧</span> set <span class="main">(</span>characterize_consistent_signs_at_roots_copr <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">qs</span></span></span><span class="main">)</span> <span class="main">⊆</span> set<span class="main">(</span><span class="free"><span class="bound"><span class="entity">signs</span></span></span><span class="main">)</span>
  <span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">"Base Case"</span></span>

<span class="keyword1" id="BKR_Proofs-mat_base_case"><span class="command">lemma</span></span> mat_base_case<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"matrix_A <span class="main">[</span><span class="main">[</span><span class="main">1</span><span class="main">]</span><span class="main">,</span><span class="main">[</span><span class="main">-</span><span class="main">1</span><span class="main">]</span><span class="main">]</span> <span class="main">[</span><span class="main">[]</span><span class="main">,</span><span class="main">[</span><span class="main">0</span><span class="main">]</span><span class="main">]</span> <span class="main">=</span> <span class="main">(</span>mat_of_rows_list <span class="numeral">2</span> <span class="main">[</span><span class="main">[</span><span class="main">1</span><span class="main">,</span> <span class="main">1</span><span class="main">]</span><span class="main">,</span> <span class="main">[</span><span class="main">1</span><span class="main">,</span> <span class="main">-</span><span class="main">1</span><span class="main">]</span><span class="main">]</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> matrix_A_def mtx_row_def z_def <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> numeral_2_eq_2<span class="main">)</span>

<span class="keyword1" id="BKR_Proofs-base_case_sgas"><span class="command">lemma</span></span> base_case_sgas<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">q</span> <span class="free">p</span><span class="main">::</span> <span class="quoted"><span class="quoted">"real poly"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> nonzero<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> rel_prime<span class="main">:</span> <span class="quoted"><span class="quoted">"coprime <span class="free">p</span> <span class="free">q</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>characterize_consistent_signs_at_roots_copr <span class="free">p</span> <span class="main">[</span><span class="free">q</span><span class="main">]</span><span class="main">)</span> <span class="main">⊆</span> <span class="main">{</span><span class="main">[</span><span class="main">1</span><span class="main">]</span><span class="main">,</span> <span class="main">[</span><span class="main">-</span> <span class="main">1</span><span class="main">]</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> characterize_consistent_signs_at_roots_copr_def consistent_sign_vec_copr_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="BKR_Proofs-base_case_sgas_alt"><span class="command">lemma</span></span> base_case_sgas_alt<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">p</span><span class="main">::</span> <span class="quoted"><span class="quoted">"real poly"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">qs</span><span class="main">::</span> <span class="quoted"><span class="quoted">"real poly list"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> len1<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">qs</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> nonzero<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> rel_prime<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">q</span><span class="main">.</span> <span class="main">(</span>List.member <span class="free">qs</span> <span class="bound">q</span><span class="main">)</span> <span class="main">⟶</span> coprime <span class="free">p</span> <span class="bound">q</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>characterize_consistent_signs_at_roots_copr <span class="free">p</span> <span class="free">qs</span><span class="main">)</span> <span class="main">⊆</span> <span class="main">{</span><span class="main">[</span><span class="main">1</span><span class="main">]</span><span class="main">,</span> <span class="main">[</span><span class="main">-</span> <span class="main">1</span><span class="main">]</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
  <span class="keyword1"><span class="command">have</span></span> ex_q<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="main">(</span><span class="bound">q</span><span class="main">::</span>real poly<span class="main">)</span><span class="main">.</span> <span class="free">qs</span> <span class="main">=</span> <span class="main">[</span><span class="bound">q</span><span class="main">]</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> len1    
    <span class="keyword1"><span class="command">using</span></span> length_Suc_conv<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">qs</span></span> <span class="quoted"><span class="main">0</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> base_case_sgas nonzero rel_prime
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> characterize_consistent_signs_at_roots_copr_def consistent_sign_vec_copr_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="BKR_Proofs-base_case_satisfy_equation"><span class="command">lemma</span></span> base_case_satisfy_equation<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">q</span> <span class="free">p</span><span class="main">::</span> <span class="quoted"><span class="quoted">"real poly"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> nonzero<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> rel_prime<span class="main">:</span> <span class="quoted"><span class="quoted">"coprime <span class="free">p</span> <span class="free">q</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"satisfy_equation <span class="free">p</span> <span class="main">[</span><span class="free">q</span><span class="main">]</span> <span class="main">[</span><span class="main">[]</span><span class="main">,</span><span class="main">[</span><span class="main">0</span><span class="main">]</span><span class="main">]</span> <span class="main">[</span><span class="main">[</span><span class="main">1</span><span class="main">]</span><span class="main">,</span><span class="main">[</span><span class="main">-</span><span class="main">1</span><span class="main">]</span><span class="main">]</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
  <span class="keyword1"><span class="command">have</span></span> h1<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>characterize_consistent_signs_at_roots_copr <span class="free">p</span> <span class="main">[</span><span class="free">q</span><span class="main">]</span><span class="main">)</span> <span class="main">⊆</span> <span class="main">{</span><span class="main">[</span><span class="main">1</span><span class="main">]</span><span class="main">,</span> <span class="main">[</span><span class="main">-</span> <span class="main">1</span><span class="main">]</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> base_case_sgas assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> h2<span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="main">∀</span><span class="bound">qa</span><span class="main">.</span> List.member <span class="main">[</span><span class="free">q</span><span class="main">]</span> <span class="bound">qa</span> <span class="main">⟶</span> coprime <span class="free">p</span> <span class="bound">qa</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> rel_prime
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> member_rec<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> member_rec<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> h3<span class="main">:</span> <span class="quoted"><span class="quoted">"all_list_constr <span class="main">[</span><span class="main">[]</span><span class="main">,</span> <span class="main">[</span><span class="main">0</span><span class="main">]</span><span class="main">]</span> <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> all_list_constr_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> list_constr_def member_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> matrix_equation<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> p <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span>"</span></span><span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> qs <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">q</span><span class="main">]</span>"</span></span><span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> signs <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">[</span><span class="main">1</span><span class="main">]</span><span class="main">,</span><span class="main">[</span><span class="main">-</span><span class="main">1</span><span class="main">]</span><span class="main">]</span>"</span></span><span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> subsets <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">[]</span><span class="main">,</span><span class="main">[</span><span class="main">0</span><span class="main">]</span><span class="main">]</span>"</span></span><span class="main">]</span>
      nonzero h1 h2 h3 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="BKR_Proofs-base_case_satisfy_equation_alt"><span class="command">lemma</span></span> base_case_satisfy_equation_alt<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">p</span><span class="main">::</span> <span class="quoted"><span class="quoted">"real poly"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">qs</span><span class="main">::</span> <span class="quoted"><span class="quoted">"real poly list"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> len1<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">qs</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> nonzero<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> rel_prime<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">q</span><span class="main">.</span> <span class="main">(</span>List.member <span class="free">qs</span> <span class="bound">q</span><span class="main">)</span> <span class="main">⟶</span> coprime <span class="free">p</span> <span class="bound">q</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"satisfy_equation <span class="free">p</span> <span class="free">qs</span> <span class="main">[</span><span class="main">[]</span><span class="main">,</span><span class="main">[</span><span class="main">0</span><span class="main">]</span><span class="main">]</span> <span class="main">[</span><span class="main">[</span><span class="main">1</span><span class="main">]</span><span class="main">,</span><span class="main">[</span><span class="main">-</span><span class="main">1</span><span class="main">]</span><span class="main">]</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
  <span class="keyword1"><span class="command">have</span></span> ex_q<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="main">(</span><span class="bound">q</span><span class="main">::</span>real poly<span class="main">)</span><span class="main">.</span> <span class="free">qs</span> <span class="main">=</span> <span class="main">[</span><span class="bound">q</span><span class="main">]</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> len1    
    <span class="keyword1"><span class="command">using</span></span> length_Suc_conv<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">qs</span></span> <span class="quoted"><span class="main">0</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> base_case_satisfy_equation nonzero rel_prime
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> member_rec<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="BKR_Proofs-base_case_matrix_eq"><span class="command">lemma</span></span> base_case_matrix_eq<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">q</span> <span class="free">p</span><span class="main">::</span> <span class="quoted"><span class="quoted">"real poly"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> nonzero<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> rel_prime<span class="main">:</span> <span class="quoted"><span class="quoted">"coprime <span class="free">p</span> <span class="free">q</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>mult_mat_vec <span class="main">(</span>mat_of_rows_list <span class="numeral">2</span> <span class="main">[</span><span class="main">[</span><span class="main">1</span><span class="main">,</span> <span class="main">1</span><span class="main">]</span><span class="main">,</span> <span class="main">[</span><span class="main">1</span><span class="main">,</span> <span class="main">-</span><span class="main">1</span><span class="main">]</span><span class="main">]</span><span class="main">)</span> <span class="main">(</span>construct_lhs_vector <span class="free">p</span> <span class="main">[</span><span class="free">q</span><span class="main">]</span> <span class="main">[</span><span class="main">[</span><span class="main">1</span><span class="main">]</span><span class="main">,</span><span class="main">[</span><span class="main">-</span><span class="main">1</span><span class="main">]</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> 
    <span class="main">(</span>construct_rhs_vector <span class="free">p</span> <span class="main">[</span><span class="free">q</span><span class="main">]</span> <span class="main">[</span><span class="main">[]</span><span class="main">,</span><span class="main">[</span><span class="main">0</span><span class="main">]</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>                      
  <span class="keyword1"><span class="command">using</span></span> mat_base_case base_case_satisfy_equation <span class="keyword1"><span class="command">unfolding</span></span> satisfy_equation_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nonzero rel_prime<span class="main">)</span>

<span class="keyword1" id="BKR_Proofs-less_two"><span class="command">lemma</span></span> less_two<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">&lt;</span> Suc <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span> <span class="main">⟷</span> <span class="free">j</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∨</span> <span class="free">j</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 

<span class="keyword1" id="BKR_Proofs-inverse_mat_base_case"><span class="command">lemma</span></span> inverse_mat_base_case<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"inverts_mat <span class="main">(</span>mat_of_rows_list <span class="numeral">2</span> <span class="main">[</span><span class="main">[</span><span class="main">1</span><span class="main">/</span><span class="numeral">2</span><span class="main">,</span> <span class="main">1</span><span class="main">/</span><span class="numeral">2</span><span class="main">]</span><span class="main">,</span> <span class="main">[</span><span class="main">1</span><span class="main">/</span><span class="numeral">2</span><span class="main">,</span> <span class="main">-</span><span class="main">(</span><span class="main">1</span><span class="main">/</span><span class="numeral">2</span><span class="main">)</span><span class="main">]</span><span class="main">]</span><span class="main">::</span>rat mat<span class="main">)</span> <span class="main">(</span>mat_of_rows_list <span class="numeral">2</span> <span class="main">[</span><span class="main">[</span><span class="main">1</span><span class="main">,</span> <span class="main">1</span><span class="main">]</span><span class="main">,</span> <span class="main">[</span><span class="main">1</span><span class="main">,</span> <span class="main">-</span><span class="main">1</span><span class="main">]</span><span class="main">]</span><span class="main">::</span>rat mat<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> inverts_mat_def mat_of_rows_list_def mat_eq_iff <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">unfolding</span></span> less_two <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> scalar_prod_def<span class="main">)</span>

<span class="keyword1" id="BKR_Proofs-inverse_mat_base_case_2"><span class="command">lemma</span></span> inverse_mat_base_case_2<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"inverts_mat <span class="main">(</span>mat_of_rows_list <span class="numeral">2</span> <span class="main">[</span><span class="main">[</span><span class="main">1</span><span class="main">,</span> <span class="main">1</span><span class="main">]</span><span class="main">,</span> <span class="main">[</span><span class="main">1</span><span class="main">,</span> <span class="main">-</span><span class="main">1</span><span class="main">]</span><span class="main">]</span><span class="main">::</span>rat mat<span class="main">)</span> <span class="main">(</span>mat_of_rows_list <span class="numeral">2</span> <span class="main">[</span><span class="main">[</span><span class="main">1</span><span class="main">/</span><span class="numeral">2</span><span class="main">,</span> <span class="main">1</span><span class="main">/</span><span class="numeral">2</span><span class="main">]</span><span class="main">,</span> <span class="main">[</span><span class="main">1</span><span class="main">/</span><span class="numeral">2</span><span class="main">,</span> <span class="main">-</span><span class="main">(</span><span class="main">1</span><span class="main">/</span><span class="numeral">2</span><span class="main">)</span><span class="main">]</span><span class="main">]</span><span class="main">::</span>rat mat<span class="main">)</span> "</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> inverts_mat_def mat_of_rows_list_def mat_eq_iff <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">unfolding</span></span> less_two <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> scalar_prod_def<span class="main">)</span>

<span class="keyword1" id="BKR_Proofs-base_case_invertible_mat"><span class="command">lemma</span></span> base_case_invertible_mat<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"invertible_mat <span class="main">(</span>matrix_A <span class="main">[</span><span class="main">[</span><span class="main">1</span><span class="main">]</span><span class="main">,</span> <span class="main">[</span><span class="main">-</span> <span class="main">1</span><span class="main">]</span><span class="main">]</span> <span class="main">[</span><span class="main">[]</span><span class="main">,</span> <span class="main">[</span><span class="main">0</span><span class="main">]</span><span class="main">]</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> invertible_mat_def <span class="keyword1"><span class="command">using</span></span> inverse_mat_base_case inverse_mat_base_case_2
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mat_base_case mat_of_rows_list_def<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> mat_base_case <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">"Inductive Step"</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Lemmas on smashing subsets and signs"</span></span>

<span class="keyword1" id="BKR_Proofs-signs_smash_property"><span class="command">lemma</span></span> signs_smash_property<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">signs1</span> <span class="free">signs2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list list"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">a</span> <span class="free">b</span><span class="main">::</span> <span class="quoted"><span class="quoted">"nat"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="main">(</span><span class="bound">elem</span> <span class="main">::</span> <span class="tfree">'a</span> list<span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">elem</span> <span class="main">∈</span> <span class="main">(</span>set <span class="main">(</span>signs_smash <span class="free">signs1</span> <span class="free">signs2</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span> 
    <span class="main">(</span><span class="main">∃</span> <span class="bound">n</span> <span class="bound">m</span> <span class="main">::</span> nat<span class="main">.</span> 
      <span class="bound">elem</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span>nth <span class="free">signs1</span> <span class="bound">n</span><span class="main">)</span><span class="main">@</span><span class="main">(</span>nth <span class="free">signs2</span> <span class="bound">m</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">clarsimp</span> 
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">elem</span> 
  <span class="keyword3"><span class="command">assume</span></span> assum<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">elem</span> <span class="main">∈</span> set <span class="main">(</span>signs_smash <span class="free">signs1</span> <span class="free">signs2</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">n</span> <span class="bound">m</span><span class="main">.</span> <span class="skolem">elem</span> <span class="main">=</span> <span class="free">signs1</span> <span class="main">!</span> <span class="bound">n</span> <span class="main">@</span> <span class="free">signs2</span> <span class="main">!</span> <span class="bound">m</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assum <span class="keyword1"><span class="command">unfolding</span></span> signs_smash_def <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> in_set_conv_nth<span class="main">)</span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="BKR_Proofs-signs_smash_property_set"><span class="command">lemma</span></span> signs_smash_property_set<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">signs1</span> <span class="free">signs2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list list"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">a</span> <span class="free">b</span><span class="main">::</span> <span class="quoted"><span class="quoted">"nat"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="main">(</span><span class="bound">elem</span> <span class="main">::</span> <span class="tfree">'a</span> list<span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">elem</span> <span class="main">∈</span> <span class="main">(</span>set <span class="main">(</span>signs_smash <span class="free">signs1</span> <span class="free">signs2</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span> 
    <span class="main">(</span><span class="main">∃</span> <span class="main">(</span><span class="bound">elem1</span><span class="main">::</span><span class="tfree">'a</span> list<span class="main">)</span><span class="main">.</span> <span class="main">∃</span> <span class="main">(</span><span class="bound">elem2</span><span class="main">::</span><span class="tfree">'a</span> list<span class="main">)</span><span class="main">.</span> 
      <span class="main">(</span><span class="bound">elem1</span> <span class="main">∈</span> set<span class="main">(</span><span class="free">signs1</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">elem2</span> <span class="main">∈</span> set<span class="main">(</span><span class="free">signs2</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">elem</span> <span class="main">=</span> <span class="main">(</span><span class="bound">elem1</span><span class="main">@</span><span class="bound">elem2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">clarsimp</span> 
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">elem</span> 
  <span class="keyword3"><span class="command">assume</span></span> assum<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">elem</span> <span class="main">∈</span> set <span class="main">(</span>signs_smash <span class="free">signs1</span> <span class="free">signs2</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">elem1</span><span class="main">.</span> <span class="bound">elem1</span> <span class="main">∈</span> set <span class="free">signs1</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span><span class="bound">elem2</span><span class="main">.</span> <span class="bound">elem2</span> <span class="main">∈</span> set <span class="free">signs2</span> <span class="main">∧</span> <span class="skolem">elem</span> <span class="main">=</span> <span class="bound">elem1</span> <span class="main">@</span> <span class="bound">elem2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assum <span class="keyword1"><span class="command">unfolding</span></span> signs_smash_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="BKR_Proofs-subsets_smash_property"><span class="command">lemma</span></span> subsets_smash_property<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">subsets1</span> <span class="free">subsets2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat list list"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">n</span><span class="main">::</span> <span class="quoted"><span class="quoted">"nat"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="main">(</span><span class="bound">elem</span> <span class="main">::</span> nat list<span class="main">)</span><span class="main">.</span> <span class="main">(</span>List.member <span class="main">(</span>subsets_smash <span class="free">n</span> <span class="free">subsets1</span> <span class="free">subsets2</span><span class="main">)</span> <span class="bound">elem</span><span class="main">)</span> <span class="main">⟶</span> 
    <span class="main">(</span><span class="main">∃</span> <span class="main">(</span><span class="bound">elem1</span><span class="main">::</span>nat list<span class="main">)</span><span class="main">.</span> <span class="main">∃</span> <span class="main">(</span><span class="bound">elem2</span><span class="main">::</span>nat list<span class="main">)</span><span class="main">.</span>
      <span class="main">(</span><span class="bound">elem1</span> <span class="main">∈</span> set<span class="main">(</span><span class="free">subsets1</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">elem2</span> <span class="main">∈</span> set<span class="main">(</span><span class="free">subsets2</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">elem</span> <span class="main">=</span> <span class="main">(</span><span class="bound">elem1</span> <span class="main">@</span> <span class="main">(</span><span class="main">(</span>map <span class="main">(</span><span class="main">(+)</span> <span class="free">n</span><span class="main">)</span> <span class="bound">elem2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?new_subsets</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>map <span class="main">(</span>map <span class="main">(</span><span class="main">(+)</span> <span class="free">n</span><span class="main">)</span><span class="main">)</span> <span class="free">subsets2</span><span class="main">)</span>"</span></span>
    <span class="comment1">(* a slightly unorthodox use of signs_smash, but it closes the proof *)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"subsets_smash <span class="free">n</span> <span class="free">subsets1</span> <span class="free">subsets2</span> <span class="main">=</span> signs_smash <span class="free">subsets1</span> <span class="var">?new_subsets</span>"</span></span> 
    <span class="keyword1"><span class="command">unfolding</span></span> subsets_smash_def signs_smash_def <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> comp_def<span class="main">)</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> imageE in_set_member set_map signs_smash_property_set<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

  <span class="comment1">(* If subsets for smaller systems are well-defined, then subsets for combined systems
   are well-defined *)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Well-defined subsets preserved when smashing"</span></span>

<span class="keyword1" id="BKR_Proofs-list_constr_append"><span class="command">lemma</span></span> list_constr_append<span class="main">:</span>
  <span class="quoted"><span class="quoted">"list_constr <span class="free">a</span> <span class="free">n</span> <span class="main">∧</span> list_constr <span class="free">b</span> <span class="free">n</span> <span class="main">⟶</span> list_constr <span class="main">(</span><span class="free">a</span><span class="main">@</span><span class="free">b</span><span class="main">)</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> list_constr_def
  <span class="keyword1"><span class="command">using</span></span> list_all_append <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 

<span class="keyword1" id="BKR_Proofs-well_def_step"><span class="command">lemma</span></span> well_def_step<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">qs1</span> <span class="free">qs2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real poly list"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">subsets1</span> <span class="free">subsets2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat list list"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> well_def_subsets1<span class="main">:</span> <span class="quoted"><span class="quoted">"all_list_constr <span class="main">(</span><span class="free">subsets1</span><span class="main">)</span> <span class="main">(</span>length <span class="free">qs1</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> well_def_subsets2<span class="main">:</span> <span class="quoted"><span class="quoted">"all_list_constr <span class="main">(</span><span class="free">subsets2</span><span class="main">)</span> <span class="main">(</span>length <span class="free">qs2</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"all_list_constr <span class="main">(</span><span class="main">(</span>subsets_smash <span class="main">(</span>length <span class="free">qs1</span><span class="main">)</span> <span class="free">subsets1</span> <span class="free">subsets2</span><span class="main">)</span><span class="main">)</span>
     <span class="main">(</span>length <span class="main">(</span><span class="free">qs1</span> <span class="main">@</span> <span class="free">qs2</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
  <span class="keyword1"><span class="command">have</span></span> h1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">elem</span><span class="main">.</span>
     List.member <span class="main">(</span>subsets_smash <span class="main">(</span>length <span class="free">qs1</span><span class="main">)</span> <span class="free">subsets1</span> <span class="free">subsets2</span><span class="main">)</span> <span class="bound">elem</span> <span class="main">⟶</span>
     <span class="main">(</span><span class="main">∃</span><span class="bound">elem1</span> <span class="bound">elem2</span><span class="main">.</span> <span class="bound">elem1</span> <span class="main">∈</span> set <span class="free">subsets1</span> <span class="main">∧</span> <span class="bound">elem2</span> <span class="main">∈</span> set <span class="free">subsets2</span> <span class="main">∧</span> <span class="bound">elem</span> <span class="main">=</span> <span class="bound">elem1</span> <span class="main">@</span> map <span class="main">(</span><span class="main">(+)</span> <span class="main">(</span>length <span class="free">qs1</span><span class="main">)</span><span class="main">)</span> <span class="bound">elem2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> subsets_smash_property <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> h2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">elem1</span> <span class="bound">elem2</span><span class="main">.</span> <span class="main">(</span><span class="bound">elem1</span> <span class="main">∈</span> set <span class="free">subsets1</span> <span class="main">∧</span> <span class="bound">elem2</span> <span class="main">∈</span> set <span class="free">subsets2</span><span class="main">)</span> <span class="main">⟶</span> list_constr <span class="main">(</span><span class="bound">elem1</span> <span class="main">@</span> map <span class="main">(</span><span class="main">(+)</span> <span class="main">(</span>length <span class="free">qs1</span><span class="main">)</span><span class="main">)</span> <span class="bound">elem2</span><span class="main">)</span> <span class="main">(</span>length <span class="main">(</span><span class="free">qs1</span> <span class="main">@</span> <span class="free">qs2</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">clarsimp</span> 
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">elem1</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">elem2</span>
    <span class="keyword3"><span class="command">assume</span></span> e1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">elem1</span> <span class="main">∈</span> set <span class="free">subsets1</span>"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> e2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">elem2</span> <span class="main">∈</span> set <span class="free">subsets2</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> h1<span class="main">:</span> <span class="quoted"><span class="quoted">"list_constr <span class="skolem">elem1</span>  <span class="main">(</span>length <span class="free">qs1</span> <span class="main">+</span> length <span class="free">qs2</span><span class="main">)</span> "</span></span> 
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
      <span class="keyword1"><span class="command">have</span></span> h1<span class="main">:</span> <span class="quoted"><span class="quoted">"list_constr <span class="skolem">elem1</span>  <span class="main">(</span>length <span class="free">qs1</span><span class="main">)</span>"</span></span>  <span class="keyword1"><span class="command">using</span></span> e1 well_def_subsets1 
        <span class="keyword1"><span class="command">unfolding</span></span> all_list_constr_def
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> in_set_member<span class="main">)</span> 
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> list_constr_def
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> list.pred_mono_strong<span class="main">)</span> 
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">have</span></span> h2<span class="main">:</span> <span class="quoted"><span class="quoted">"list_constr <span class="main">(</span>map <span class="main">(</span><span class="main">(+)</span> <span class="main">(</span>length <span class="free">qs1</span><span class="main">)</span><span class="main">)</span> <span class="skolem">elem2</span><span class="main">)</span> <span class="main">(</span>length <span class="free">qs1</span> <span class="main">+</span> length <span class="free">qs2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
      <span class="keyword1"><span class="command">have</span></span> h1<span class="main">:</span> <span class="quoted"><span class="quoted">"list_constr <span class="skolem">elem2</span>  <span class="main">(</span>length <span class="free">qs2</span><span class="main">)</span>"</span></span>  <span class="keyword1"><span class="command">using</span></span> e2 well_def_subsets2 
        <span class="keyword1"><span class="command">unfolding</span></span> all_list_constr_def
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> in_set_member<span class="main">)</span> 
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> list_constr_def
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> list_all_length<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>    
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"list_constr <span class="main">(</span><span class="skolem">elem1</span> <span class="main">@</span> map <span class="main">(</span><span class="main">(+)</span> <span class="main">(</span>length <span class="free">qs1</span><span class="main">)</span><span class="main">)</span> <span class="skolem">elem2</span><span class="main">)</span> <span class="main">(</span>length <span class="free">qs1</span> <span class="main">+</span> length <span class="free">qs2</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> h1 h2 list_constr_append
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> h1 <span class="keyword1"><span class="command">unfolding</span></span> all_list_constr_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Well def signs preserved when smashing"</span></span>
<span class="keyword1" id="BKR_Proofs-well_def_signs_step"><span class="command">lemma</span></span> well_def_signs_step<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">qs1</span> <span class="free">qs2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real poly list"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">signs1</span> <span class="free">signs2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"rat list list"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"length <span class="free">qs1</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"length <span class="free">qs2</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> well_def1<span class="main">:</span> <span class="quoted"><span class="quoted">"well_def_signs <span class="main">(</span>length <span class="free">qs1</span><span class="main">)</span> <span class="free">signs1</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> well_def2<span class="main">:</span> <span class="quoted"><span class="quoted">"well_def_signs <span class="main">(</span>length <span class="free">qs2</span><span class="main">)</span> <span class="free">signs2</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"well_def_signs <span class="main">(</span>length <span class="main">(</span><span class="free">qs1</span><span class="main">@</span><span class="free">qs2</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>signs_smash <span class="free">signs1</span> <span class="free">signs2</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> well_def1 well_def2 <span class="keyword1"><span class="command">unfolding</span></span> well_def_signs_def <span class="keyword1"><span class="command">using</span></span> signs_smash_property_set<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">signs1</span></span> <span class="quoted"><span class="free">signs2</span></span><span class="main">]</span> length_append <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Distinct signs preserved when smashing"</span></span>

<span class="keyword1" id="BKR_Proofs-distinct_map_append"><span class="command">lemma</span></span> distinct_map_append<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"distinct <span class="free">ls</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>map <span class="main">(</span><span class="main">(@)</span> <span class="free">xs</span><span class="main">)</span> <span class="free">ls</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> distinct_map inj_on_def <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="BKR_Proofs-length_eq_append"><span class="command">lemma</span></span> length_eq_append<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"length <span class="free">y</span> <span class="main">=</span> length <span class="free">b</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span> <span class="main">@</span> <span class="free">y</span> <span class="main">=</span> <span class="free">a</span> <span class="main">@</span> <span class="free">b</span><span class="main">)</span> <span class="main">⟷</span> <span class="free">x</span><span class="main">=</span><span class="free">a</span> <span class="main">∧</span> <span class="free">y</span> <span class="main">=</span> <span class="free">b</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main">)</span>

<span class="keyword1" id="BKR_Proofs-distinct_step"><span class="command">lemma</span></span> distinct_step<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">qs1</span> <span class="free">qs2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real poly list"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">signs1</span> <span class="free">signs2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"rat list list"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> well_def1<span class="main">:</span> <span class="quoted"><span class="quoted">"well_def_signs <span class="free">n1</span> <span class="free">signs1</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> well_def2<span class="main">:</span> <span class="quoted"><span class="quoted">"well_def_signs <span class="free">n2</span> <span class="free">signs2</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> distinct1<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="free">signs1</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> distinct2<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="free">signs2</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>signs_smash <span class="free">signs1</span> <span class="free">signs2</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> signs_smash_def
  <span class="keyword1"><span class="command">using</span></span> distinct1
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">signs1</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">signs1</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> distinct2 distinct_map_append<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> well_def_signs_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> distinct1 distinct2 length_eq_append<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(* In this section we will show that if signs1 contains all consistent sign assignments and signs2 
contains all consistent sign assignments, then their smash contains all consistent sign assignments.  
Intuitively, this makes sense because signs1 and signs2 are carrying information about different 
sets of polynomials, and their smash contains all possible combinations of that information.
*)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Consistent sign assignments preserved when smashing"</span></span>

<span class="keyword1" id="BKR_Proofs-subset_smash_signs"><span class="command">lemma</span></span> subset_smash_signs<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">a1</span> <span class="free">b1</span> <span class="free">a2</span> <span class="free">b2</span><span class="main">::</span> <span class="quoted"><span class="quoted">"rat list list"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> sub1<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="free">a1</span> <span class="main">⊆</span> set <span class="free">a2</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> sub2<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="free">b1</span> <span class="main">⊆</span> set <span class="free">b2</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>signs_smash <span class="free">a1</span> <span class="free">b1</span><span class="main">)</span> <span class="main">⊆</span> set <span class="main">(</span>signs_smash <span class="free">a2</span> <span class="free">b2</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> h1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>set <span class="main">(</span>signs_smash <span class="free">a1</span> <span class="free">b1</span><span class="main">)</span><span class="main">.</span> <span class="bound">x</span><span class="main">∈</span>set <span class="main">(</span>signs_smash <span class="free">a2</span> <span class="free">b2</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">clarsimp</span> 
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
    <span class="keyword3"><span class="command">assume</span></span> x_in<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> set <span class="main">(</span>signs_smash <span class="free">a1</span> <span class="free">b1</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> h1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">n</span> <span class="bound">m</span> <span class="main">::</span> nat<span class="main">.</span> <span class="skolem">x</span> <span class="main">=</span> <span class="main">(</span>nth <span class="free">a1</span> <span class="bound">n</span><span class="main">)</span><span class="main">@</span><span class="main">(</span>nth <span class="free">b1</span> <span class="bound">m</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> signs_smash_property<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">a1</span></span> <span class="quoted"><span class="free">b1</span></span><span class="main">]</span> x_in
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> h2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">p</span> <span class="bound">q</span><span class="main">::</span>nat<span class="main">.</span> <span class="skolem">x</span> <span class="main">=</span> <span class="main">(</span>nth <span class="free">a2</span> <span class="bound">p</span><span class="main">)</span><span class="main">@</span><span class="main">(</span>nth <span class="free">b2</span> <span class="bound">q</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> sub1 sub2 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> nth_find_first signs_smash_property_set subset_code<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> x_in<span class="main">)</span> 
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> set <span class="main">(</span>signs_smash <span class="free">a2</span> <span class="free">b2</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">unfolding</span></span> signs_smash_def <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> signs_smash_property_set sub1 sub2 x_in <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span> 
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="BKR_Proofs-subset_helper"><span class="command">lemma</span></span> subset_helper<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">p</span><span class="main">::</span> <span class="quoted"><span class="quoted">"real poly"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">qs1</span> <span class="free">qs2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real poly list"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">signs1</span> <span class="free">signs2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"rat list list"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">x</span> <span class="main">∈</span> set <span class="main">(</span>characterize_consistent_signs_at_roots_copr <span class="free">p</span> <span class="main">(</span><span class="free">qs1</span> <span class="main">@</span> <span class="free">qs2</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> 
        <span class="main">∃</span> <span class="bound">x1</span> <span class="main">∈</span> set <span class="main">(</span>characterize_consistent_signs_at_roots_copr <span class="free">p</span> <span class="free">qs1</span><span class="main">)</span><span class="main">.</span> 
        <span class="main">∃</span> <span class="bound">x2</span> <span class="main">∈</span> set <span class="main">(</span>characterize_consistent_signs_at_roots_copr <span class="free">p</span> <span class="free">qs2</span><span class="main">)</span><span class="main">.</span>
        <span class="bound">x</span> <span class="main">=</span> <span class="bound">x1</span><span class="main">@</span><span class="bound">x2</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">clarsimp</span> 
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
  <span class="keyword3"><span class="command">assume</span></span>  x_in<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> set <span class="main">(</span>characterize_consistent_signs_at_roots_copr <span class="free">p</span> <span class="main">(</span><span class="free">qs1</span> <span class="main">@</span> <span class="free">qs2</span><span class="main">)</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">have</span></span> x_in_csv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> set<span class="main">(</span>map <span class="main">(</span>consistent_sign_vec_copr <span class="main">(</span><span class="free">qs1</span> <span class="main">@</span> <span class="free">qs2</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>characterize_root_list_p <span class="free">p</span><span class="main">)</span><span class="main">)</span>"</span></span>  
    <span class="keyword1"><span class="command">using</span></span> x_in <span class="keyword1"><span class="command">unfolding</span></span> characterize_consistent_signs_at_roots_copr_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> csv_hyp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">r</span><span class="main">.</span> consistent_sign_vec_copr <span class="main">(</span><span class="free">qs1</span> <span class="main">@</span> <span class="free">qs2</span><span class="main">)</span> <span class="bound">r</span> <span class="main">=</span> <span class="main">(</span>consistent_sign_vec_copr <span class="free">qs1</span> <span class="bound">r</span><span class="main">)</span><span class="main">@</span><span class="main">(</span>consistent_sign_vec_copr <span class="free">qs2</span> <span class="bound">r</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> consistent_sign_vec_copr_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> exr_iff<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound">r</span> <span class="main">∈</span> set <span class="main">(</span>characterize_root_list_p <span class="free">p</span><span class="main">)</span><span class="main">.</span> <span class="skolem">x</span> <span class="main">=</span> consistent_sign_vec_copr <span class="main">(</span><span class="free">qs1</span> <span class="main">@</span> <span class="free">qs2</span><span class="main">)</span> <span class="bound">r</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">r</span> <span class="main">∈</span> set <span class="main">(</span>characterize_root_list_p <span class="free">p</span><span class="main">)</span><span class="main">.</span> <span class="skolem">x</span> <span class="main">=</span> <span class="main">(</span>consistent_sign_vec_copr <span class="free">qs1</span> <span class="bound">r</span><span class="main">)</span><span class="main">@</span><span class="main">(</span>consistent_sign_vec_copr <span class="free">qs2</span> <span class="bound">r</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> csv_hyp <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> exr<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> set<span class="main">(</span>map <span class="main">(</span>consistent_sign_vec_copr <span class="main">(</span><span class="free">qs1</span> <span class="main">@</span> <span class="free">qs2</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>characterize_root_list_p <span class="free">p</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">r</span> <span class="main">∈</span> set <span class="main">(</span>characterize_root_list_p <span class="free">p</span><span class="main">)</span><span class="main">.</span> <span class="skolem">x</span> <span class="main">=</span> consistent_sign_vec_copr <span class="main">(</span><span class="free">qs1</span> <span class="main">@</span> <span class="free">qs2</span><span class="main">)</span> <span class="bound">r</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> mem_list1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">r</span> <span class="main">∈</span> set <span class="main">(</span>characterize_root_list_p <span class="free">p</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span>consistent_sign_vec_copr <span class="free">qs1</span> <span class="bound">r</span><span class="main">)</span> <span class="main">∈</span> set<span class="main">(</span>map <span class="main">(</span>consistent_sign_vec_copr <span class="free">qs1</span><span class="main">)</span> <span class="main">(</span>characterize_root_list_p <span class="free">p</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> mem_list2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">r</span> <span class="main">∈</span> set <span class="main">(</span>characterize_root_list_p <span class="free">p</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span>consistent_sign_vec_copr <span class="free">qs2</span> <span class="bound">r</span><span class="main">)</span> <span class="main">∈</span> set<span class="main">(</span>map <span class="main">(</span>consistent_sign_vec_copr <span class="free">qs2</span><span class="main">)</span> <span class="main">(</span>characterize_root_list_p <span class="free">p</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">x1</span><span class="main">∈</span>set <span class="main">(</span>characterize_consistent_signs_at_roots_copr <span class="free">p</span> <span class="free">qs1</span><span class="main">)</span><span class="main">.</span>
            <span class="main">∃</span><span class="bound">x2</span><span class="main">∈</span>set <span class="main">(</span>characterize_consistent_signs_at_roots_copr <span class="free">p</span> <span class="free">qs2</span><span class="main">)</span><span class="main">.</span> <span class="skolem">x</span> <span class="main">=</span> <span class="bound">x1</span> <span class="main">@</span> <span class="bound">x2</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> x_in_csv exr mem_list1 mem_list2 characterize_consistent_signs_at_roots_copr_def exr_iff <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="BKR_Proofs-subset_step"><span class="command">lemma</span></span> subset_step<span class="main">:</span>  
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">p</span><span class="main">::</span> <span class="quoted"><span class="quoted">"real poly"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">qs1</span> <span class="free">qs2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real poly list"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">signs1</span> <span class="free">signs2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"rat list list"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> csa1<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>characterize_consistent_signs_at_roots_copr <span class="free">p</span> <span class="free">qs1</span><span class="main">)</span> <span class="main">⊆</span> set <span class="main">(</span><span class="free">signs1</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> csa2<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>characterize_consistent_signs_at_roots_copr <span class="free">p</span> <span class="free">qs2</span><span class="main">)</span> <span class="main">⊆</span> set <span class="main">(</span><span class="free">signs2</span><span class="main">)</span>"</span></span>  
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>characterize_consistent_signs_at_roots_copr <span class="free">p</span>
          <span class="main">(</span><span class="free">qs1</span> <span class="main">@</span> <span class="free">qs2</span><span class="main">)</span><span class="main">)</span>
    <span class="main">⊆</span> set <span class="main">(</span>signs_smash <span class="free">signs1</span> <span class="free">signs2</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
  <span class="keyword1"><span class="command">have</span></span> h0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">x</span> <span class="main">∈</span> set <span class="main">(</span>characterize_consistent_signs_at_roots_copr <span class="free">p</span> <span class="main">(</span><span class="free">qs1</span> <span class="main">@</span> <span class="free">qs2</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> <span class="main">∃</span> <span class="bound">x1</span> <span class="main">∈</span> set <span class="main">(</span>characterize_consistent_signs_at_roots_copr <span class="free">p</span> <span class="free">qs1</span><span class="main">)</span><span class="main">.</span> <span class="main">∃</span> <span class="bound">x2</span> <span class="main">∈</span> set <span class="main">(</span>characterize_consistent_signs_at_roots_copr <span class="free">p</span> <span class="free">qs2</span><span class="main">)</span><span class="main">.</span>
     <span class="main">(</span><span class="bound">x</span> <span class="main">=</span> <span class="bound">x1</span><span class="main">@</span><span class="bound">x2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> subset_helper<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">p</span></span> <span class="quoted"><span class="free">qs1</span></span> <span class="quoted"><span class="free">qs2</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> set <span class="main">(</span>characterize_consistent_signs_at_roots_copr <span class="free">p</span> <span class="main">(</span><span class="free">qs1</span> <span class="main">@</span> <span class="free">qs2</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> 
          <span class="bound">x</span> <span class="main">∈</span> set <span class="main">(</span>signs_smash <span class="main">(</span>characterize_consistent_signs_at_roots_copr <span class="free">p</span> <span class="free">qs1</span><span class="main">)</span> 
          <span class="main">(</span>characterize_consistent_signs_at_roots_copr <span class="free">p</span> <span class="free">qs2</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> signs_smash_def <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> set <span class="main">(</span>characterize_consistent_signs_at_roots_copr <span class="free">p</span>
          <span class="main">(</span><span class="free">qs1</span> <span class="main">@</span> <span class="free">qs2</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> set <span class="main">(</span>signs_smash <span class="free">signs1</span> <span class="free">signs2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> csa1 csa2 subset_smash_signs<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="free">signs1</span></span> <span class="main">_</span> <span class="quoted"><span class="free">signs2</span></span><span class="main">]</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Main Results"</span></span>

<span class="keyword1" id="BKR_Proofs-dim_row_mat_of_rows_list"><span class="command">lemma</span></span> dim_row_mat_of_rows_list<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"dim_row <span class="main">(</span>mat_of_rows_list <span class="free">nr</span> <span class="free">ls</span><span class="main">)</span> <span class="main">=</span> length <span class="free">ls</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> mat_of_rows_list_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="BKR_Proofs-dim_col_mat_of_rows_list"><span class="command">lemma</span></span> dim_col_mat_of_rows_list<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"dim_col <span class="main">(</span>mat_of_rows_list <span class="free">nr</span> <span class="free">ls</span><span class="main">)</span> <span class="main">=</span> <span class="free">nr</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> mat_of_rows_list_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="BKR_Proofs-dim_row_matrix_A"><span class="command">lemma</span></span> dim_row_matrix_A<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"dim_row <span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span> <span class="main">=</span> length <span class="free">subsets</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> matrix_A_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="BKR_Proofs-dim_col_matrix_A"><span class="command">lemma</span></span> dim_col_matrix_A<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"dim_col <span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span> <span class="main">=</span> length <span class="free">signs</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> matrix_A_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="BKR_Proofs-length_signs_smash"><span class="command">lemma</span></span> length_signs_smash<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"length <span class="main">(</span>signs_smash <span class="free">signs1</span> <span class="free">signs2</span><span class="main">)</span> <span class="main">=</span> length <span class="free">signs1</span> <span class="main">*</span> length <span class="free">signs2</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> signs_smash_def length_concat
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> o_def sum_list_triv<span class="main">)</span>

<span class="keyword1" id="BKR_Proofs-length_subsets_smash"><span class="command">lemma</span></span> length_subsets_smash<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"length <span class="main">(</span>subsets_smash <span class="free">n</span> <span class="free">subs1</span> <span class="free">subs2</span><span class="main">)</span> <span class="main">=</span> length <span class="free">subs1</span> <span class="main">*</span> length <span class="free">subs2</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> subsets_smash_def length_concat
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> o_def sum_list_triv<span class="main">)</span>

<span class="keyword1" id="BKR_Proofs-length_eq_concat"><span class="command">lemma</span></span> length_eq_concat<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> set <span class="free">ls</span> <span class="main">⟹</span> length <span class="bound">x</span> <span class="main">=</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> <span class="free">n</span> <span class="main">*</span> length <span class="free">ls</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"concat <span class="free">ls</span> <span class="main">!</span> <span class="free">i</span> <span class="main">=</span> <span class="free">ls</span> <span class="main">!</span> <span class="main">(</span><span class="free">i</span> <span class="keyword1">div</span> <span class="free">n</span><span class="main">)</span> <span class="main">!</span> <span class="main">(</span><span class="free">i</span> <span class="keyword1">mod</span> <span class="free">n</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">ls</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">i</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">ls</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nth_append<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> div_if mod_geq <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="BKR_Proofs-z_append"><span class="command">lemma</span></span> z_append<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∈</span> set <span class="free">xs</span> <span class="main">⟹</span> <span class="bound">i</span> <span class="main">&lt;</span> length <span class="free">as</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"z <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">(</span>map <span class="main">(</span><span class="main">(+)</span> <span class="main">(</span>length <span class="free">as</span><span class="main">)</span><span class="main">)</span> <span class="free">ys</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">as</span> <span class="main">@</span> <span class="free">bs</span><span class="main">)</span> <span class="main">=</span> z <span class="free">xs</span> <span class="free">as</span> <span class="main">*</span> z <span class="free">ys</span> <span class="free">bs</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"map <span class="main">(</span><span class="main">(!)</span> <span class="main">(</span><span class="free">as</span> <span class="main">@</span> <span class="free">bs</span><span class="main">)</span><span class="main">)</span> <span class="free">xs</span> <span class="main">=</span> map <span class="main">(</span><span class="main">(!)</span> <span class="free">as</span><span class="main">)</span> <span class="free">xs</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> list_eq_iff_nth_eq
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>nth_append<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"map <span class="main">(</span><span class="main">(!)</span> <span class="main">(</span><span class="free">as</span> <span class="main">@</span> <span class="free">bs</span><span class="main">)</span> <span class="main">∘</span> <span class="main">(+)</span> <span class="main">(</span>length <span class="free">as</span><span class="main">)</span><span class="main">)</span> <span class="free">ys</span> <span class="main">=</span> map <span class="main">(</span><span class="main">(!)</span> <span class="free">bs</span><span class="main">)</span> <span class="free">ys</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> list_eq_iff_nth_eq
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> z_def <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">unfolding</span></span> 1 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(* Shows that the matrix of a smashed system is the Kronecker product of the matrices of the two
  systems being combined *)</span>
<span class="keyword1" id="BKR_Proofs-matrix_construction_is_kronecker_product"><span class="command">lemma</span></span> matrix_construction_is_kronecker_product<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">qs1</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real poly list"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">subs1</span> <span class="free">subs2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat list list"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">signs1</span> <span class="free">signs2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"rat list list"</span></span>
    <span class="comment1">(* n1 is the number of polynomials in the "1" sets *)</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">l</span> <span class="bound">i</span><span class="main">.</span> <span class="bound">l</span> <span class="main">∈</span> set <span class="free">subs1</span> <span class="main">⟹</span> <span class="bound">i</span> <span class="main">∈</span> set <span class="bound">l</span> <span class="main">⟹</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="free">n1</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">j</span><span class="main">.</span> <span class="bound">j</span> <span class="main">∈</span> set <span class="free">signs1</span> <span class="main">⟹</span> length <span class="bound">j</span> <span class="main">=</span> <span class="free">n1</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"
    <span class="main">(</span>matrix_A <span class="main">(</span>signs_smash <span class="free">signs1</span> <span class="free">signs2</span><span class="main">)</span> <span class="main">(</span>subsets_smash <span class="free">n1</span> <span class="free">subs1</span> <span class="free">subs2</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
    kronecker_product <span class="main">(</span>matrix_A <span class="free">signs1</span> <span class="free">subs1</span><span class="main">)</span> <span class="main">(</span>matrix_A <span class="free">signs2</span> <span class="free">subs2</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> mat_eq_iff dim_row_matrix_A dim_col_matrix_A
    length_subsets_smash length_signs_smash dim_kronecker
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">safe</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="skolem">j</span>
  <span class="keyword3"><span class="command">assume</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="free">subs1</span> <span class="main">*</span> length <span class="free">subs2</span>"</span></span>
     <span class="keyword2"><span class="keyword">and</span></span> j<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> length <span class="free">signs1</span> <span class="main">*</span> length <span class="free">signs2</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> ld<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="keyword1">div</span> length <span class="free">subs2</span> <span class="main">&lt;</span> length <span class="free">subs1</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="keyword1">div</span> length <span class="free">signs2</span> <span class="main">&lt;</span> length <span class="free">signs1</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> i j less_mult_imp_div_less <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> lm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="keyword1">mod</span> length <span class="free">subs2</span> <span class="main">&lt;</span> length <span class="free">subs2</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="keyword1">mod</span> length <span class="free">signs2</span> <span class="main">&lt;</span> length <span class="free">signs2</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> i j less_mult_imp_mod_less <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> n1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n1</span> <span class="main">=</span> length <span class="main">(</span><span class="free">signs1</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">j</span> <span class="keyword1">div</span> length <span class="free">signs2</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> ld<span class="main">(</span>2<span class="main">)</span> nth_mem <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"matrix_A <span class="main">(</span>signs_smash <span class="free">signs1</span> <span class="free">signs2</span><span class="main">)</span> <span class="main">(</span>subsets_smash <span class="free">n1</span> <span class="free">subs1</span> <span class="free">subs2</span><span class="main">)</span> <span class="main">$$</span> <span class="main">(</span><span class="skolem">i</span><span class="main">,</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">=</span>
    z <span class="main">(</span>subsets_smash <span class="free">n1</span> <span class="free">subs1</span> <span class="free">subs2</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">(</span>signs_smash <span class="free">signs1</span> <span class="free">signs2</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> mat_of_rows_list_def matrix_A_def mtx_row_def
    <span class="keyword1"><span class="command">using</span></span> i j
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> length_signs_smash length_subsets_smash<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="main">...</span> <span class="main">=</span> z <span class="main">(</span><span class="free">subs1</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">i</span> <span class="keyword1">div</span> length <span class="free">subs2</span><span class="main">)</span> <span class="main">@</span> map <span class="main">(</span><span class="main">(+)</span> <span class="free">n1</span><span class="main">)</span> <span class="main">(</span><span class="free">subs2</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">i</span> <span class="keyword1">mod</span> length <span class="free">subs2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
     <span class="main">(</span><span class="free">signs1</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">j</span> <span class="keyword1">div</span> length <span class="free">signs2</span><span class="main">)</span> <span class="main">@</span> <span class="free">signs2</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">j</span> <span class="keyword1">mod</span> length <span class="free">signs2</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> signs_smash_def subsets_smash_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> length_eq_concat<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> i <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mult.commute<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> length_eq_concat<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> j <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mult.commute<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> ld lm <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span>
  z <span class="main">(</span><span class="free">subs1</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">i</span> <span class="keyword1">div</span> length <span class="free">subs2</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">signs1</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">j</span> <span class="keyword1">div</span> length <span class="free">signs2</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span>
  z <span class="main">(</span><span class="free">subs2</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">i</span> <span class="keyword1">mod</span> length <span class="free">subs2</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">signs2</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">j</span> <span class="keyword1">mod</span> length <span class="free">signs2</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> n1
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> z_append<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> n1<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> ld<span class="main">(</span>1<span class="main">)</span> nth_mem <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> 4<span class="main">:</span> <span class="quoted"><span class="quoted">"kronecker_product <span class="main">(</span>matrix_A <span class="free">signs1</span> <span class="free">subs1</span><span class="main">)</span> <span class="main">(</span>matrix_A <span class="free">signs2</span> <span class="free">subs2</span><span class="main">)</span> <span class="main">$$</span> <span class="main">(</span><span class="skolem">i</span><span class="main">,</span><span class="skolem">j</span><span class="main">)</span> <span class="main">=</span>
    z <span class="main">(</span><span class="free">subs1</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">i</span> <span class="keyword1">div</span> length <span class="free">subs2</span><span class="main">)</span><span class="main">)</span>
     <span class="main">(</span><span class="free">signs1</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">j</span> <span class="keyword1">div</span> length <span class="free">signs2</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span>
    z <span class="main">(</span><span class="free">subs2</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">i</span> <span class="keyword1">mod</span> length <span class="free">subs2</span><span class="main">)</span><span class="main">)</span>
     <span class="main">(</span><span class="free">signs2</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">j</span> <span class="keyword1">mod</span> length <span class="free">signs2</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> kronecker_product_def matrix_A_def mat_of_rows_list_def mtx_row_def
    <span class="keyword1"><span class="command">using</span></span> i j <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> index_mat<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">OF</span> ld<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> index_mat<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">OF</span> lm<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> ld lm <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"matrix_A <span class="main">(</span>signs_smash <span class="free">signs1</span> <span class="free">signs2</span><span class="main">)</span> <span class="main">(</span>subsets_smash <span class="free">n1</span> <span class="free">subs1</span> <span class="free">subs2</span><span class="main">)</span> <span class="main">$$</span> <span class="main">(</span><span class="skolem">i</span><span class="main">,</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">=</span>
        kronecker_product <span class="main">(</span>matrix_A <span class="free">signs1</span> <span class="free">subs1</span><span class="main">)</span> <span class="main">(</span>matrix_A <span class="free">signs2</span> <span class="free">subs2</span><span class="main">)</span> <span class="main">$$</span> <span class="main">(</span><span class="skolem">i</span><span class="main">,</span> <span class="skolem">j</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> 1 2 3 4 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(* Given that two smaller systems satisfy some mild constraints, show that their combined system
  (after smashing the signs and subsets) satisfies the matrix equation, and that the matrix of the
  combined system is invertible. *)</span>
<span class="keyword1" id="BKR_Proofs-inductive_step"><span class="command">lemma</span></span> inductive_step<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">p</span><span class="main">::</span> <span class="quoted"><span class="quoted">"real poly"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">qs1</span> <span class="free">qs2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real poly list"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">subsets1</span> <span class="free">subsets2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat list list"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">signs1</span> <span class="free">signs2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"rat list list"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> nonzero<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> nontriv1<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">qs1</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> nontriv2<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">qs2</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> pairwise_rel_prime1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">q</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span>List.member <span class="free">qs1</span> <span class="bound">q</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">(</span>coprime <span class="free">p</span> <span class="bound">q</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> pairwise_rel_prime2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">q</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span>List.member <span class="free">qs2</span> <span class="bound">q</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">(</span>coprime <span class="free">p</span> <span class="bound">q</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> welldefined_signs1<span class="main">:</span> <span class="quoted"><span class="quoted">"well_def_signs <span class="main">(</span>length <span class="free">qs1</span><span class="main">)</span> <span class="free">signs1</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> welldefined_signs2<span class="main">:</span> <span class="quoted"><span class="quoted">"well_def_signs <span class="main">(</span>length <span class="free">qs2</span><span class="main">)</span> <span class="free">signs2</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> distinct_signs1<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="free">signs1</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> distinct_signs2<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="free">signs2</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> all_info1<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>characterize_consistent_signs_at_roots_copr <span class="free">p</span> <span class="free">qs1</span><span class="main">)</span> <span class="main">⊆</span> set<span class="main">(</span><span class="free">signs1</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> all_info2<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>characterize_consistent_signs_at_roots_copr <span class="free">p</span> <span class="free">qs2</span><span class="main">)</span> <span class="main">⊆</span> set<span class="main">(</span><span class="free">signs2</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> welldefined_subsets1<span class="main">:</span> <span class="quoted"><span class="quoted">"all_list_constr <span class="main">(</span><span class="free">subsets1</span><span class="main">)</span> <span class="main">(</span>length <span class="free">qs1</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> welldefined_subsets2<span class="main">:</span> <span class="quoted"><span class="quoted">"all_list_constr <span class="main">(</span><span class="free">subsets2</span><span class="main">)</span> <span class="main">(</span>length <span class="free">qs2</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> invertibleMtx1<span class="main">:</span> <span class="quoted"><span class="quoted">"invertible_mat <span class="main">(</span>matrix_A <span class="free">signs1</span> <span class="free">subsets1</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> invertibleMtx2<span class="main">:</span> <span class="quoted"><span class="quoted">"invertible_mat <span class="main">(</span>matrix_A <span class="free">signs2</span> <span class="free">subsets2</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"satisfy_equation <span class="free">p</span> <span class="main">(</span><span class="free">qs1</span><span class="main">@</span><span class="free">qs2</span><span class="main">)</span> <span class="main">(</span>subsets_smash <span class="main">(</span>length <span class="free">qs1</span><span class="main">)</span> <span class="free">subsets1</span> <span class="free">subsets2</span><span class="main">)</span> <span class="main">(</span>signs_smash <span class="free">signs1</span> <span class="free">signs2</span><span class="main">)</span> 
        <span class="main">∧</span> invertible_mat <span class="main">(</span>matrix_A <span class="main">(</span>signs_smash <span class="free">signs1</span> <span class="free">signs2</span><span class="main">)</span> <span class="main">(</span>subsets_smash <span class="main">(</span>length <span class="free">qs1</span><span class="main">)</span> <span class="free">subsets1</span> <span class="free">subsets2</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
  <span class="keyword1"><span class="command">have</span></span> h1<span class="main">:</span> <span class="quoted"><span class="quoted">"invertible_mat <span class="main">(</span>matrix_A <span class="main">(</span>signs_smash <span class="free">signs1</span> <span class="free">signs2</span><span class="main">)</span> <span class="main">(</span>subsets_smash <span class="main">(</span>length <span class="free">qs1</span><span class="main">)</span> <span class="free">subsets1</span> <span class="free">subsets2</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> matrix_construction_is_kronecker_product
      kronecker_invertible invertibleMtx1 invertibleMtx2
      welldefined_subsets1 welldefined_subsets2 <span class="keyword1"><span class="command">unfolding</span></span> all_list_constr_def list_constr_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> in_set_conv_nth in_set_member list_all_length well_def_signs_def welldefined_signs1<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> h2a<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>signs_smash <span class="free">signs1</span> <span class="free">signs2</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> distinct_signs1 distinct_signs2 welldefined_signs1 welldefined_signs2 nontriv1 nontriv2 
      distinct_step <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> h2ba<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">q</span><span class="main">.</span> List.member <span class="main">(</span><span class="free">qs1</span> <span class="main">@</span> <span class="free">qs2</span><span class="main">)</span> <span class="bound">q</span> <span class="main">⟶</span> <span class="main">(</span>List.member <span class="free">qs1</span> <span class="bound">q</span> <span class="main">∨</span> List.member <span class="free">qs2</span> <span class="bound">q</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">unfolding</span></span> member_def 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> h2b<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">q</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span>List.member <span class="main">(</span><span class="free">qs1</span><span class="main">@</span><span class="free">qs2</span><span class="main">)</span> <span class="bound">q</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">(</span>coprime <span class="free">p</span> <span class="bound">q</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> h2ba pairwise_rel_prime1 pairwise_rel_prime2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> h2c<span class="main">:</span> <span class="quoted"><span class="quoted">"all_list_constr <span class="main">(</span><span class="main">(</span>subsets_smash <span class="main">(</span>length <span class="free">qs1</span><span class="main">)</span> <span class="free">subsets1</span> <span class="free">subsets2</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>length <span class="main">(</span><span class="free">qs1</span><span class="main">@</span><span class="free">qs2</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> well_def_step
      welldefined_subsets1 welldefined_subsets2
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> h2d<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>characterize_consistent_signs_at_roots_copr <span class="free">p</span> <span class="main">(</span><span class="free">qs1</span><span class="main">@</span><span class="free">qs2</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> set<span class="main">(</span>signs_smash <span class="free">signs1</span> <span class="free">signs2</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> subset_step all_info1 all_info2
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> 
  <span class="keyword1"><span class="command">have</span></span> h2<span class="main">:</span> <span class="quoted"><span class="quoted">"satisfy_equation <span class="free">p</span> <span class="main">(</span><span class="free">qs1</span><span class="main">@</span><span class="free">qs2</span><span class="main">)</span> <span class="main">(</span>subsets_smash <span class="main">(</span>length <span class="free">qs1</span><span class="main">)</span> <span class="free">subsets1</span> <span class="free">subsets2</span><span class="main">)</span> <span class="main">(</span>signs_smash <span class="free">signs1</span> <span class="free">signs2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> matrix_equation<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> p<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="free">p</span>"</span></span><span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> qs<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="free">qs1</span><span class="main">@</span><span class="free">qs2</span>"</span></span><span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> subsets <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"subsets_smash <span class="main">(</span>length <span class="free">qs1</span><span class="main">)</span> <span class="free">subsets1</span> <span class="free">subsets2</span>"</span></span><span class="main">,</span>
        <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> signs <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"signs_smash <span class="free">signs1</span> <span class="free">signs2</span>"</span></span><span class="main">]</span> 
        h2a h2b h2c h2d <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> nonzero <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> h1 h2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">"Reduction Step Proofs"</span></span>
  
<span class="comment1">(* Some definitions *)</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">get_matrix</span><span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>rat mat <span class="main">×</span> <span class="main">(</span>nat list list <span class="main">×</span> rat list list<span class="main">)</span><span class="main">)</span> <span class="main">⇒</span> rat mat"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">get_matrix</span> <span class="free"><span class="bound"><span class="entity">data</span></span></span> <span class="main">=</span> fst<span class="main">(</span><span class="free"><span class="bound"><span class="entity">data</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">get_subsets</span><span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>rat mat <span class="main">×</span> <span class="main">(</span>nat list list <span class="main">×</span> rat list list<span class="main">)</span><span class="main">)</span> <span class="main">⇒</span> nat list list"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">get_subsets</span> <span class="free"><span class="bound"><span class="entity">data</span></span></span> <span class="main">=</span> fst<span class="main">(</span>snd<span class="main">(</span><span class="free"><span class="bound"><span class="entity">data</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">get_signs</span><span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>rat mat <span class="main">×</span> <span class="main">(</span>nat list list <span class="main">×</span> rat list list<span class="main">)</span><span class="main">)</span> <span class="main">⇒</span> rat list list"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">get_signs</span> <span class="free"><span class="bound"><span class="entity">data</span></span></span> <span class="main">=</span> snd<span class="main">(</span>snd<span class="main">(</span><span class="free"><span class="bound"><span class="entity">data</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">reduction_signs</span><span class="main">::</span> <span class="quoted"><span class="quoted">"real poly <span class="main">⇒</span> real poly list <span class="main">⇒</span> rat list list <span class="main">⇒</span> nat list list <span class="main">⇒</span> rat mat <span class="main">⇒</span> rat list list"</span></span> 
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">reduction_signs</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">qs</span></span></span> <span class="free"><span class="bound"><span class="entity">signs</span></span></span> <span class="free"><span class="bound"><span class="entity">subsets</span></span></span> <span class="free"><span class="bound"><span class="entity">matr</span></span></span> <span class="main">=</span> 
    <span class="main">(</span>take_indices <span class="free"><span class="bound"><span class="entity">signs</span></span></span> <span class="main">(</span>find_nonzeros_from_input_vec <span class="main">(</span>solve_for_lhs <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">qs</span></span></span> <span class="free"><span class="bound"><span class="entity">subsets</span></span></span> <span class="free"><span class="bound"><span class="entity">matr</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">reduction_subsets</span><span class="main">::</span> <span class="quoted"><span class="quoted">"real poly <span class="main">⇒</span> real poly list <span class="main">⇒</span> rat list list <span class="main">⇒</span> nat list list <span class="main">⇒</span> rat mat <span class="main">⇒</span> nat list list"</span></span> 
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">reduction_subsets</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">qs</span></span></span> <span class="free"><span class="bound"><span class="entity">signs</span></span></span> <span class="free"><span class="bound"><span class="entity">subsets</span></span></span> <span class="free"><span class="bound"><span class="entity">matr</span></span></span> <span class="main">=</span> 
    <span class="main">(</span>take_indices <span class="free"><span class="bound"><span class="entity">subsets</span></span></span> <span class="main">(</span>rows_to_keep <span class="main">(</span>reduce_mat_cols <span class="free"><span class="bound"><span class="entity">matr</span></span></span> <span class="main">(</span>solve_for_lhs <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">qs</span></span></span> <span class="free"><span class="bound"><span class="entity">subsets</span></span></span> <span class="free"><span class="bound"><span class="entity">matr</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="comment1">(* Some basic lemmas *)</span>
<span class="keyword1" id="BKR_Proofs-reduction_signs_is_get_signs"><span class="command">lemma</span></span> reduction_signs_is_get_signs<span class="main">:</span> <span class="quoted"><span class="quoted">"reduction_signs <span class="free">p</span> <span class="free">qs</span> <span class="free">signs</span> <span class="free">subsets</span> <span class="free">m</span> <span class="main">=</span>  get_signs <span class="main">(</span>reduce_system <span class="free">p</span> <span class="main">(</span><span class="free">qs</span><span class="main">,</span> <span class="main">(</span><span class="free">m</span><span class="main">,</span> <span class="main">(</span><span class="free">subsets</span><span class="main">,</span> <span class="free">signs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> reduction_signs_def get_signs_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> reduce_system.simps reduction_step.elims snd_conv<span class="main">)</span> 

<span class="keyword1" id="BKR_Proofs-reduction_subsets_is_get_subsets"><span class="command">lemma</span></span> reduction_subsets_is_get_subsets<span class="main">:</span> <span class="quoted"><span class="quoted">"reduction_subsets <span class="free">p</span> <span class="free">qs</span> <span class="free">signs</span> <span class="free">subsets</span> <span class="free">m</span> <span class="main">=</span>  get_subsets <span class="main">(</span>reduce_system <span class="free">p</span> <span class="main">(</span><span class="free">qs</span><span class="main">,</span> <span class="main">(</span><span class="free">m</span><span class="main">,</span> <span class="main">(</span><span class="free">subsets</span><span class="main">,</span> <span class="free">signs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> reduction_subsets_def get_subsets_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> fst_conv reduce_system.simps reduction_step.elims snd_conv<span class="main">)</span>

<span class="keyword1" id="BKR_Proofs-find_zeros_from_vec_prop"><span class="command">lemma</span></span> find_zeros_from_vec_prop<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">input_vec</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"rat vec"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">n</span></span> <span class="main">&lt;</span> <span class="main">(</span>dim_vec <span class="free">input_vec</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="free">input_vec</span> <span class="main">$</span> <span class="bound">n</span> <span class="main">≠</span> <span class="main">0</span><span class="main">)</span> <span class="main">⟷</span>
         List.member <span class="main">(</span>find_nonzeros_from_input_vec <span class="free">input_vec</span><span class="main">)</span> <span class="bound">n</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
  <span class="keyword1"><span class="command">have</span></span> h1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">n</span></span> <span class="main">&lt;</span> <span class="main">(</span>dim_vec <span class="free">input_vec</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="free">input_vec</span> <span class="main">$</span> <span class="bound">n</span> <span class="main">≠</span> <span class="main">0</span><span class="main">)</span> <span class="main">⟶</span>  List.member <span class="main">(</span>find_nonzeros_from_input_vec <span class="free">input_vec</span><span class="main">)</span> <span class="bound">n</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">unfolding</span></span> find_nonzeros_from_input_vec_def List.member_def  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> h2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">n</span></span> <span class="main">&lt;</span> <span class="main">(</span>dim_vec <span class="free">input_vec</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span>List.member <span class="main">(</span>find_nonzeros_from_input_vec <span class="free">input_vec</span><span class="main">)</span> <span class="bound">n</span> <span class="main">⟶</span> <span class="main">(</span><span class="free">input_vec</span> <span class="main">$</span> <span class="bound">n</span> <span class="main">≠</span> <span class="main">0</span><span class="main">)</span> <span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">unfolding</span></span> find_nonzeros_from_input_vec_def List.member_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> h1 h2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Showing sign conditions preserved when reducing"</span></span>

<span class="keyword1" id="BKR_Proofs-take_indices_lem"><span class="command">lemma</span></span> take_indices_lem<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">p</span><span class="main">::</span> <span class="quoted"><span class="quoted">"real poly"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">qs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real poly list"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">arb_list</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list list"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">index_list</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat list"</span></span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">n</span><span class="main">::</span> <span class="quoted"><span class="quoted">"nat"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> lest<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&lt;</span> length <span class="main">(</span>take_indices <span class="free">arb_list</span> <span class="free">index_list</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> well_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">q</span><span class="main">.</span><span class="main">(</span>List.member <span class="free">index_list</span> <span class="bound">q</span> <span class="main">⟶</span> <span class="bound">q</span> <span class="main">&lt;</span> length <span class="free">arb_list</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">k</span></span><span class="main">&lt;</span>length <span class="free">arb_list</span><span class="main">.</span>
            <span class="main">(</span>take_indices <span class="free">arb_list</span> <span class="free">index_list</span><span class="main">)</span> <span class="main">!</span> <span class="free">n</span> <span class="main">=</span>  <span class="free">arb_list</span> <span class="main">!</span> <span class="bound">k</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> lest well_def <span class="keyword1"><span class="command">unfolding</span></span> take_indices_def <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> in_set_member nth_mem<span class="main">)</span>

<span class="keyword1" id="BKR_Proofs-invertible_means_mult_id"><span class="command">lemma</span></span> invertible_means_mult_id<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span><span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>field mat"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> assm<span class="main">:</span> <span class="quoted"><span class="quoted">"invertible_mat <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"matr_option <span class="main">(</span>dim_row <span class="free">A</span><span class="main">)</span>
     <span class="main">(</span>mat_inverse <span class="main">(</span><span class="free">A</span><span class="main">)</span><span class="main">)</span><span class="main">*</span><span class="free">A</span> <span class="main">=</span> <span class="keyword1">1<span class="hidden">⇩</span><sub>m</sub></span> <span class="main">(</span>dim_row <span class="free">A</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"mat_inverse<span class="main">(</span><span class="free">A</span><span class="main">)</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword">where</span></span> n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">∈</span> carrier_mat <span class="skolem">n</span> <span class="skolem">n</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms invertible_mat_def square_mat.simps <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">case</span></span> None
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">∉</span> Units <span class="main">(</span>ring_mat <span class="keyword1">TYPE</span><span class="main">(</span><span class="tfree">'a</span><span class="main">)</span> <span class="skolem">n</span> <span class="skolem">n</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mat_inverse<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> n<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> assms det_non_zero_imp_unit invertible_Units n unit_imp_det_non_zero<span class="main">)</span> 
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Some <span class="skolem">a</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms carrier_matI invertible_mat_def mat_inverse<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> matr_option.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> square_mat.elims<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="BKR_Proofs-dim_invertible"><span class="command">lemma</span></span> dim_invertible<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span><span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>field mat"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">n</span><span class="main">::</span> <span class="quoted"><span class="quoted">"nat"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> assm<span class="main">:</span> <span class="quoted"><span class="quoted">"invertible_mat <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> dim<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">∈</span> carrier_mat <span class="free">n</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"matr_option <span class="main">(</span>dim_row <span class="free">A</span><span class="main">)</span>
     <span class="main">(</span>mat_inverse <span class="main">(</span><span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> carrier_mat <span class="free">n</span> <span class="free">n</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"mat_inverse<span class="main">(</span><span class="free">A</span><span class="main">)</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword">where</span></span> n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">∈</span> carrier_mat <span class="skolem">n</span> <span class="skolem">n</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms invertible_mat_def square_mat.simps <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">case</span></span> None
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">∉</span> Units <span class="main">(</span>ring_mat <span class="keyword1">TYPE</span><span class="main">(</span><span class="tfree">'a</span><span class="main">)</span> <span class="skolem">n</span> <span class="skolem">n</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mat_inverse<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> n<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> assms det_non_zero_imp_unit invertible_Units n unit_imp_det_non_zero<span class="main">)</span> 
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Some <span class="skolem">a</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> dim mat_inverse<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="BKR_Proofs-mult_assoc"><span class="command">lemma</span></span> mult_assoc<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span> <span class="free">B</span><span class="main">::</span> <span class="quoted"><span class="quoted">"rat mat"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">v</span><span class="main">::</span> <span class="quoted"><span class="quoted">"rat vec"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">n</span><span class="main">::</span> <span class="quoted"><span class="quoted">"nat"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">∈</span> carrier_mat <span class="free">n</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">B</span> <span class="main">∈</span> carrier_mat <span class="free">n</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"dim_vec <span class="free">v</span> <span class="main">=</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>v</sub></span> <span class="main">(</span>mult_mat_vec <span class="free">B</span> <span class="free">v</span><span class="main">)</span> <span class="main">=</span>  <span class="main">(</span><span class="free">A</span><span class="main">*</span><span class="free">B</span><span class="main">)</span><span class="keyword1">*<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">v</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>2<span class="main">)</span> assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="BKR_Proofs-size_of_mat"><span class="command">lemma</span></span> size_of_mat<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">subsets</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat list list"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">signs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"rat list list"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span> <span class="main">∈</span> carrier_mat <span class="main">(</span>length <span class="free">subsets</span><span class="main">)</span> <span class="main">(</span>length <span class="free">signs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> matrix_A_def carrier_mat_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="BKR_Proofs-size_of_lhs"><span class="command">lemma</span></span> size_of_lhs<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">p</span><span class="main">::</span> <span class="quoted"><span class="quoted">"real poly"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">qs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real poly list"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">signs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"rat list list"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"dim_vec <span class="main">(</span>construct_lhs_vector <span class="free">p</span> <span class="free">qs</span> <span class="free">signs</span><span class="main">)</span> <span class="main">=</span> length <span class="free">signs</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> construct_lhs_vector_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="BKR_Proofs-size_of_rhs"><span class="command">lemma</span></span> size_of_rhs<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">p</span><span class="main">::</span> <span class="quoted"><span class="quoted">"real poly"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">qs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real poly list"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">subsets</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat list list"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"dim_vec <span class="main">(</span>construct_rhs_vector <span class="free">p</span> <span class="free">qs</span> <span class="free">subsets</span><span class="main">)</span> <span class="main">=</span> length <span class="free">subsets</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> construct_rhs_vector_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="BKR_Proofs-same_size"><span class="command">lemma</span></span> same_size<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">p</span><span class="main">::</span> <span class="quoted"><span class="quoted">"real poly"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">qs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real poly list"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">subsets</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat list list"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">signs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"rat list list"</span></span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> invertible_mat<span class="main">:</span> <span class="quoted"><span class="quoted">"invertible_mat <span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"length <span class="free">subsets</span> <span class="main">=</span> length <span class="free">signs</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> invertible_mat <span class="keyword1"><span class="command">unfolding</span></span> invertible_mat_def
  <span class="keyword1"><span class="command">using</span></span> size_of_mat<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">signs</span></span> <span class="quoted"><span class="free">subsets</span></span><span class="main">]</span> size_of_lhs<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">p</span></span> <span class="quoted"><span class="free">qs</span></span> <span class="quoted"><span class="free">signs</span></span><span class="main">]</span> size_of_rhs<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">p</span></span> <span class="quoted"><span class="free">qs</span></span> <span class="quoted"><span class="free">subsets</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="BKR_Proofs-mat_equal_list_lem"><span class="command">lemma</span></span> mat_equal_list_lem<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span><span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>field mat"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">B</span><span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>field mat"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>dim_row <span class="free">A</span> <span class="main">=</span> dim_row <span class="free">B</span> <span class="main">∧</span> dim_col <span class="free">A</span> <span class="main">=</span> dim_col <span class="free">B</span> <span class="main">∧</span> mat_to_list <span class="free">A</span> <span class="main">=</span> mat_to_list <span class="free">B</span><span class="main">)</span>
    <span class="main">⟹</span> <span class="free">A</span> <span class="main">=</span> <span class="free">B</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
  <span class="keyword3"><span class="command">assume</span></span> hyp<span class="main">:</span> <span class="quoted"><span class="quoted">"dim_row <span class="free">A</span> <span class="main">=</span> dim_row <span class="free">B</span> <span class="main">∧</span> dim_col <span class="free">A</span> <span class="main">=</span> dim_col <span class="free">B</span> <span class="main">∧</span> mat_to_list <span class="free">A</span> <span class="main">=</span> mat_to_list <span class="free">B</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> dim_row <span class="free">A</span> <span class="main">⟹</span> <span class="bound">j</span> <span class="main">&lt;</span> dim_col <span class="free">A</span> <span class="main">⟹</span> <span class="free">B</span> <span class="main">$$</span> <span class="main">(</span><span class="bound">i</span><span class="main">,</span> <span class="bound">j</span><span class="main">)</span> <span class="main">=</span> <span class="free">A</span> <span class="main">$$</span> <span class="main">(</span><span class="bound">i</span><span class="main">,</span> <span class="bound">j</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> mat_to_list_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> hyp
    <span class="keyword1"><span class="command">unfolding</span></span> mat_to_list_def
    <span class="keyword1"><span class="command">using</span></span> eq_matI<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">A</span></span> <span class="quoted"><span class="free">B</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="BKR_Proofs-mat_inverse_same"><span class="command">lemma</span></span> mat_inverse_same<span class="main">:</span> <span class="quoted"><span class="quoted">"mat_inverse_var <span class="free">A</span> <span class="main">=</span> mat_inverse <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> mat_inverse_var_def mat_inverse_def mat_equal_def
  <span class="keyword1"><span class="command">using</span></span> mat_equal_list_lem <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> case_prod_beta index_one_mat<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> index_one_mat<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> mat_equal_list_lem<span class="main">)</span> 

<span class="keyword1" id="BKR_Proofs-construct_lhs_matches_solve_for_lhs"><span class="command">lemma</span></span> construct_lhs_matches_solve_for_lhs<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">p</span><span class="main">::</span> <span class="quoted"><span class="quoted">"real poly"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">qs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real poly list"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">subsets</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat list list"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">signs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"rat list list"</span></span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> match<span class="main">:</span> <span class="quoted"><span class="quoted">"satisfy_equation <span class="free">p</span> <span class="free">qs</span> <span class="free">subsets</span> <span class="free">signs</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> invertible_mat<span class="main">:</span> <span class="quoted"><span class="quoted">"invertible_mat <span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>construct_lhs_vector <span class="free">p</span> <span class="free">qs</span> <span class="free">signs</span><span class="main">)</span> <span class="main">=</span> solve_for_lhs <span class="free">p</span> <span class="free">qs</span> <span class="free">subsets</span> <span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> matrix_equation_hyp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>mult_mat_vec <span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span> <span class="main">(</span>construct_lhs_vector <span class="free">p</span> <span class="free">qs</span> <span class="free">signs</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>construct_rhs_vector <span class="free">p</span> <span class="free">qs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> match <span class="keyword1"><span class="command">unfolding</span></span> satisfy_equation_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> eqn_hyp<span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="main">(</span><span class="main">(</span>matr_option <span class="main">(</span>dim_row <span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span>
     <span class="main">(</span>mat_inverse <span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>v</sub></span> <span class="main">(</span>mult_mat_vec <span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span> <span class="main">(</span>construct_lhs_vector <span class="free">p</span> <span class="free">qs</span> <span class="free">signs</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
      mult_mat_vec <span class="main">(</span>matr_option <span class="main">(</span>dim_row <span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span>
     <span class="main">(</span>mat_inverse <span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>construct_rhs_vector <span class="free">p</span> <span class="free">qs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> invertible_mat 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> matrix_equation_hyp<span class="main">)</span> 
  <span class="keyword1"><span class="command">have</span></span> match_hyp<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">subsets</span> <span class="main">=</span> length <span class="free">signs</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> same_size invertible_mat <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> dim_hyp1<span class="main">:</span> <span class="quoted"><span class="quoted">"matrix_A <span class="free">signs</span> <span class="free">subsets</span> <span class="main">∈</span> carrier_mat <span class="main">(</span>length <span class="free">signs</span><span class="main">)</span> <span class="main">(</span>length <span class="free">signs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> size_of_mat
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> dim_hyp2<span class="main">:</span> <span class="quoted"><span class="quoted">"matr_option <span class="main">(</span>dim_row <span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span>
     <span class="main">(</span>mat_inverse <span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> carrier_mat <span class="main">(</span>length <span class="free">signs</span><span class="main">)</span> <span class="main">(</span>length <span class="free">signs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> invertible_mat dim_invertible
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
  <span class="keyword1"><span class="command">have</span></span> mult_assoc_hyp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span>matr_option <span class="main">(</span>dim_row <span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span>
     <span class="main">(</span>mat_inverse <span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>v</sub></span> <span class="main">(</span>mult_mat_vec <span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span> <span class="main">(</span>construct_lhs_vector <span class="free">p</span> <span class="free">qs</span> <span class="free">signs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
    <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="main">(</span>matr_option <span class="main">(</span>dim_row <span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span>
     <span class="main">(</span>mat_inverse <span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>v</sub></span>  <span class="main">(</span>construct_lhs_vector <span class="free">p</span> <span class="free">qs</span> <span class="free">signs</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> mult_assoc dim_hyp1 dim_hyp2 size_of_lhs <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> cancel_helper<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">(</span>matr_option <span class="main">(</span>dim_row <span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span>
     <span class="main">(</span>mat_inverse <span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>v</sub></span>  <span class="main">(</span>construct_lhs_vector <span class="free">p</span> <span class="free">qs</span> <span class="free">signs</span><span class="main">)</span><span class="main">)</span>
  <span class="main">=</span> <span class="main">(</span><span class="keyword1">1<span class="hidden">⇩</span><sub>m</sub></span> <span class="main">(</span>length <span class="free">signs</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>v</sub></span>   <span class="main">(</span>construct_lhs_vector <span class="free">p</span> <span class="free">qs</span> <span class="free">signs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> invertible_means_mult_id<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> A<span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"matrix_A <span class="free">signs</span> <span class="free">subsets</span>"</span></span><span class="main">]</span> dim_hyp1
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> invertible_mat match_hyp<span class="main">)</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> cancel_hyp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">(</span>matr_option <span class="main">(</span>dim_row <span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span>
     <span class="main">(</span>mat_inverse <span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>v</sub></span>  <span class="main">(</span>construct_lhs_vector <span class="free">p</span> <span class="free">qs</span> <span class="free">signs</span><span class="main">)</span><span class="main">)</span>
  <span class="main">=</span> <span class="main">(</span>construct_lhs_vector <span class="free">p</span> <span class="free">qs</span> <span class="free">signs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> carrier_vec_dim_vec one_mult_mat_vec size_of_lhs<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> mult_hyp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span>matr_option <span class="main">(</span>dim_row <span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span>
     <span class="main">(</span>mat_inverse <span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>v</sub></span> <span class="main">(</span>mult_mat_vec <span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span> <span class="main">(</span>construct_lhs_vector <span class="free">p</span> <span class="free">qs</span> <span class="free">signs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
    <span class="main">=</span> <span class="main">(</span>construct_lhs_vector <span class="free">p</span> <span class="free">qs</span> <span class="free">signs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> mult_assoc_hyp cancel_hyp  
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>construct_lhs_vector <span class="free">p</span> <span class="free">qs</span> <span class="free">signs</span><span class="main">)</span> <span class="main">=</span>  <span class="main">(</span>mult_mat_vec <span class="main">(</span>matr_option <span class="main">(</span>dim_row <span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span>
     <span class="main">(</span>mat_inverse <span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>construct_rhs_vector <span class="free">p</span> <span class="free">qs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span> "</span></span>
    <span class="keyword1"><span class="command">using</span></span> eqn_hyp
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> solve_for_lhs_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mat_inverse_same<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(* If set(A) is a subset of B then for all n, nth c n = 0 means nth a n not in B  *)</span>
<span class="keyword1" id="BKR_Proofs-reduction_signs_set_helper_lemma"><span class="command">lemma</span></span> reduction_signs_set_helper_lemma<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span><span class="main">::</span> <span class="quoted"><span class="quoted">"rat list set"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">C</span><span class="main">::</span> <span class="quoted"><span class="quoted">"rat vec"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">B</span><span class="main">::</span> <span class="quoted"><span class="quoted">"rat list list"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"dim_vec <span class="free">C</span> <span class="main">=</span> length <span class="free">B</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> sub<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">⊆</span> set<span class="main">(</span><span class="free">B</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> not_in_hyp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound"><span class="bound">n</span></span> <span class="main">&lt;</span> dim_vec <span class="free">C</span><span class="main">.</span> <span class="free">C</span> <span class="main">$</span> <span class="bound">n</span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟶</span> <span class="main">(</span>nth <span class="free">B</span> <span class="bound">n</span><span class="main">)</span> <span class="main">∉</span> <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">⊆</span> set <span class="main">(</span>take_indices <span class="free">B</span>
             <span class="main">(</span>find_nonzeros_from_input_vec <span class="free">C</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
  <span class="keyword1"><span class="command">have</span></span> unfold<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">⟹</span> <span class="bound">x</span> <span class="main">∈</span> set <span class="main">(</span>take_indices <span class="free">B</span>
             <span class="main">(</span>find_nonzeros_from_input_vec <span class="free">C</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>   
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
    <span class="keyword3"><span class="command">assume</span></span> in_a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">A</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> set <span class="main">(</span><span class="free">B</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> sub in_a <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound"><span class="bound">n</span></span> <span class="main">&lt;</span> length <span class="free">B</span><span class="main">.</span> nth <span class="free">B</span> <span class="bound">n</span> <span class="main">=</span> <span class="skolem">x</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> in_set_conv_nth<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound"><span class="bound">n</span></span> <span class="main">&lt;</span> length <span class="free">B</span><span class="main">.</span> <span class="main">(</span>nth <span class="free">B</span> <span class="bound">n</span> <span class="main">=</span> <span class="skolem">x</span> <span class="main">∧</span> <span class="main">(</span>List.member <span class="main">(</span>find_nonzeros_from_input_vec <span class="free">C</span><span class="main">)</span> <span class="bound">n</span><span class="main">)</span> <span class="main">=</span> True<span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> not_in_hyp find_zeros_from_vec_prop<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">C</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> in_a <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> set <span class="main">(</span>take_indices <span class="free">B</span>
             <span class="main">(</span>find_nonzeros_from_input_vec <span class="free">C</span><span class="main">)</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">unfolding</span></span> take_indices_def
      <span class="keyword1"><span class="command">using</span></span> member_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span> 
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="BKR_Proofs-reduction_signs_set_helper_lemma2"><span class="command">lemma</span></span> reduction_signs_set_helper_lemma2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span><span class="main">::</span> <span class="quoted"><span class="quoted">"rat list set"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">C</span><span class="main">::</span> <span class="quoted"><span class="quoted">"rat vec"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">B</span><span class="main">::</span> <span class="quoted"><span class="quoted">"rat list list"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> dist<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="free">B</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> eq_len<span class="main">:</span> <span class="quoted"><span class="quoted">"dim_vec <span class="free">C</span> <span class="main">=</span> length <span class="free">B</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> sub<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">⊆</span> set<span class="main">(</span><span class="free">B</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> not_in_hyp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound"><span class="bound">n</span></span> <span class="main">&lt;</span> dim_vec <span class="free">C</span><span class="main">.</span> <span class="free">C</span> <span class="main">$</span> <span class="bound">n</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">⟶</span> <span class="main">(</span>nth <span class="free">B</span> <span class="bound">n</span><span class="main">)</span> <span class="main">∈</span> <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>take_indices <span class="free">B</span>
             <span class="main">(</span>find_nonzeros_from_input_vec <span class="free">C</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">A</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
  <span class="keyword1"><span class="command">have</span></span> unfold<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span> <span class="main">∈</span> <span class="main">(</span>set <span class="main">(</span>take_indices <span class="free">B</span>
             <span class="main">(</span>find_nonzeros_from_input_vec <span class="free">C</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">A</span><span class="main">)</span>"</span></span>   
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
    <span class="keyword3"><span class="command">assume</span></span> in_set<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> set <span class="main">(</span>take_indices <span class="free">B</span> <span class="main">(</span>find_nonzeros_from_input_vec <span class="free">C</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> h<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">n</span></span><span class="main">&lt;</span> dim_vec <span class="free">C</span><span class="main">.</span> <span class="main">(</span><span class="free">C</span> <span class="main">$</span> <span class="bound">n</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">∧</span> <span class="main">(</span>nth <span class="free">B</span> <span class="bound">n</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
      <span class="keyword1"><span class="command">have</span></span> h1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">n</span></span> <span class="main">&lt;</span> length <span class="free">B</span><span class="main">.</span><span class="main">(</span>nth <span class="free">B</span> <span class="bound">n</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">x</span>"</span></span> 
        <span class="keyword1"><span class="command">using</span></span> in_set <span class="keyword1"><span class="command">unfolding</span></span> take_indices_def
          find_nonzeros_from_input_vec_def eq_len <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> h2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">n</span></span><span class="main">&lt;</span> length <span class="free">B</span><span class="main">.</span> <span class="main">(</span>nth <span class="free">B</span> <span class="bound">n</span> <span class="main">=</span> <span class="skolem">x</span> <span class="main">⟶</span> List.member <span class="main">(</span>find_nonzeros_from_input_vec <span class="free">C</span><span class="main">)</span> <span class="bound">n</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">clarsimp</span> 
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">n</span>
        <span class="keyword3"><span class="command">assume</span></span> leq_hyp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">&lt;</span> length <span class="free">B</span>"</span></span>
        <span class="keyword3"><span class="command">assume</span></span> x_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="free">B</span> <span class="main">!</span> <span class="skolem">n</span>"</span></span>
        <span class="keyword1"><span class="command">have</span></span> h<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">B</span> <span class="main">!</span><span class="skolem">n</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>map <span class="main">(</span><span class="main">(!)</span> <span class="free">B</span><span class="main">)</span> <span class="main">(</span>find_nonzeros_from_input_vec <span class="free">C</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> x_eq in_set
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> take_indices_def<span class="main">)</span> 
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> h2<span class="main">:</span> <span class="quoted"><span class="quoted">"List.member <span class="main">(</span>map <span class="main">(</span><span class="main">(!)</span> <span class="free">B</span><span class="main">)</span> <span class="main">(</span>find_nonzeros_from_input_vec <span class="free">C</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">B</span> <span class="main">!</span> <span class="skolem">n</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> in_set
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> in_set_member<span class="main">)</span> 
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> h3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">k</span></span><span class="main">&lt;</span> length <span class="free">B</span><span class="main">.</span> <span class="main">(</span>List.member <span class="main">(</span>find_nonzeros_from_input_vec <span class="free">C</span><span class="main">)</span> <span class="bound">k</span> <span class="main">∧</span> <span class="main">(</span><span class="main">(</span><span class="free">B</span> <span class="main">!</span> <span class="bound">k</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">B</span> <span class="main">!</span> <span class="skolem">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> atLeastLessThan_iff eq_len find_nonzeros_from_input_vec_def imageE in_set_member mem_Collect_eq set_filter set_map set_upt<span class="main">)</span>
        <span class="keyword1"><span class="command">have</span></span> h4<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">v</span></span><span class="main">&lt;</span> length <span class="free">B</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="free">B</span> <span class="main">!</span> <span class="bound">v</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">B</span> <span class="main">!</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">⟶</span> <span class="bound">v</span> <span class="main">=</span> <span class="skolem">n</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> dist <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
          <span class="keyword1"><span class="command">using</span></span> leq_hyp nth_eq_iff_index_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"List.member <span class="main">(</span>find_nonzeros_from_input_vec <span class="free">C</span><span class="main">)</span> <span class="skolem">n</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> h2 h3 h4 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">n</span></span><span class="main">&lt;</span>length <span class="free">B</span><span class="main">.</span> <span class="main">(</span>nth <span class="free">B</span> <span class="bound">n</span> <span class="main">=</span> <span class="skolem">x</span> <span class="main">⟶</span> <span class="free">C</span> <span class="main">$</span> <span class="bound">n</span> <span class="main">≠</span> <span class="main">0</span><span class="main">)</span>"</span></span> 
        <span class="keyword1"><span class="command">using</span></span> find_zeros_from_vec_prop <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">C</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eq_len<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> h1 eq_len
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> not_in_hyp 
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(* Show that dropping columns doesn't affect the consistent sign assignments *)</span>
<span class="keyword1" id="BKR_Proofs-reduction_doesnt_break_things_signs"><span class="command">lemma</span></span> reduction_doesnt_break_things_signs<span class="main">:</span>  
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">p</span><span class="main">::</span> <span class="quoted"><span class="quoted">"real poly"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">qs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real poly list"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">subsets</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat list list"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">signs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"rat list list"</span></span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> nonzero<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> welldefined_signs1<span class="main">:</span> <span class="quoted"><span class="quoted">"well_def_signs <span class="main">(</span>length <span class="free">qs</span><span class="main">)</span> <span class="free">signs</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> distinct_signs<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="free">signs</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> all_info<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>characterize_consistent_signs_at_roots_copr <span class="free">p</span> <span class="free">qs</span><span class="main">)</span> <span class="main">⊆</span> set<span class="main">(</span><span class="free">signs</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> match<span class="main">:</span> <span class="quoted"><span class="quoted">"satisfy_equation <span class="free">p</span> <span class="free">qs</span> <span class="free">subsets</span> <span class="free">signs</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> invertible_mat<span class="main">:</span> <span class="quoted"><span class="quoted">"invertible_mat <span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>characterize_consistent_signs_at_roots_copr <span class="free">p</span> <span class="free">qs</span><span class="main">)</span> <span class="main">⊆</span> set<span class="main">(</span>reduction_signs <span class="free">p</span> <span class="free">qs</span> <span class="free">signs</span> <span class="free">subsets</span> <span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
  <span class="keyword1"><span class="command">have</span></span> dim_hyp2<span class="main">:</span> <span class="quoted"><span class="quoted">"matr_option <span class="main">(</span>dim_row <span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span>
     <span class="main">(</span>mat_inverse <span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> carrier_mat <span class="main">(</span>length <span class="free">signs</span><span class="main">)</span> <span class="main">(</span>length <span class="free">signs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> invertible_mat dim_invertible
    <span class="keyword1"><span class="command">using</span></span> same_size <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>construct_lhs_vector <span class="free">p</span> <span class="free">qs</span> <span class="free">signs</span><span class="main">)</span> <span class="main">=</span> solve_for_lhs <span class="free">p</span> <span class="free">qs</span> <span class="free">subsets</span> <span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> construct_lhs_matches_solve_for_lhs assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>solve_for_lhs <span class="free">p</span> <span class="free">qs</span> <span class="free">subsets</span> <span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
   vec_of_list <span class="main">(</span>map rat_of_nat <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> card <span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> consistent_sign_vec_copr <span class="free">qs</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">s</span><span class="main">}</span><span class="main">)</span> <span class="free">signs</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> construct_lhs_vector_cleaner assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> list.map_cong map_map o_apply of_int_of_nat_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound"><span class="bound">n</span></span> <span class="main">&lt;</span> <span class="main">(</span>dim_vec <span class="main">(</span>solve_for_lhs <span class="free">p</span> <span class="free">qs</span> <span class="free">subsets</span> <span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> 
       <span class="main">(</span><span class="main">(</span><span class="main">(</span>solve_for_lhs <span class="free">p</span> <span class="free">qs</span> <span class="free">subsets</span> <span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span> <span class="main">$</span> <span class="bound">n</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span> <span class="main">⟶</span>
       <span class="main">(</span>nth <span class="free">signs</span> <span class="bound">n</span><span class="main">)</span> <span class="main">∉</span> set <span class="main">(</span>characterize_consistent_signs_at_roots_copr <span class="free">p</span> <span class="free">qs</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
    <span class="keyword1"><span class="command">have</span></span> h0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound"><span class="bound">n</span></span> <span class="main">&lt;</span> <span class="main">(</span>dim_vec <span class="main">(</span>solve_for_lhs <span class="free">p</span> <span class="free">qs</span> <span class="free">subsets</span> <span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> 
       <span class="main">(</span><span class="main">(</span><span class="main">(</span>solve_for_lhs <span class="free">p</span> <span class="free">qs</span> <span class="free">subsets</span> <span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span> <span class="main">$</span> <span class="bound">n</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span> <span class="main">⟶</span> 
       rat_of_nat <span class="main">(</span>card <span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> consistent_sign_vec_copr <span class="free">qs</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">(</span>nth <span class="free">signs</span> <span class="bound">n</span><span class="main">)</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> <span class="quoted"><span class="quoted">‹construct_lhs_vector <span class="free">p</span> <span class="free">qs</span> <span class="free">signs</span> <span class="main">=</span> solve_for_lhs <span class="free">p</span> <span class="free">qs</span> <span class="free">subsets</span> <span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span>›</span></span> construct_lhs_vector_clean nonzero of_nat_0_eq_iff of_rat_of_nat_eq size_of_lhs<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> h1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">w</span><span class="main">.</span> <span class="main">(</span>rat_of_nat <span class="main">(</span>card <span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> consistent_sign_vec_copr <span class="free">qs</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">w</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟶</span> 
        <span class="main">(</span><span class="main">∄</span> <span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> consistent_sign_vec_copr <span class="free">qs</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">w</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">clarsimp</span> 
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
      <span class="keyword3"><span class="command">assume</span></span> card_asm<span class="main">:</span> <span class="quoted"><span class="quoted">"card <span class="main">{</span><span class="bound">xa</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">xa</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> consistent_sign_vec_copr <span class="free">qs</span> <span class="bound">xa</span> <span class="main">=</span> consistent_sign_vec_copr <span class="free">qs</span> <span class="skolem">x</span><span class="main">}</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
      <span class="keyword3"><span class="command">assume</span></span> zero_asm<span class="main">:</span> <span class="quoted"><span class="quoted">"poly <span class="free">p</span> <span class="skolem">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> card_hyp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">xa</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">xa</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> consistent_sign_vec_copr <span class="free">qs</span> <span class="bound">xa</span> <span class="main">=</span> consistent_sign_vec_copr <span class="free">qs</span> <span class="skolem">x</span><span class="main">}</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> card_eq_0_iff
        <span class="keyword1"><span class="command">using</span></span> card_asm nonzero poly_roots_finite <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span> 
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">xa</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">xa</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> consistent_sign_vec_copr <span class="free">qs</span> <span class="bound">xa</span> <span class="main">=</span> consistent_sign_vec_copr <span class="free">qs</span> <span class="skolem">x</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> zero_asm <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"False"</span></span> <span class="keyword1"><span class="command">using</span></span> card_hyp
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">have</span></span> h2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">w</span><span class="main">.</span> <span class="main">(</span>rat_of_nat <span class="main">(</span>card <span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> consistent_sign_vec_copr <span class="free">qs</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">w</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟹</span>
       <span class="main">(</span><span class="main">¬</span>List.member <span class="main">(</span>characterize_consistent_signs_at_roots_copr <span class="free">p</span> <span class="free">qs</span><span class="main">)</span> <span class="bound">w</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> <span class="main"><span class="main">(</span></span>verit<span class="main"><span class="main">,</span></span> best<span class="main"><span class="main">)</span></span> characterize_consistent_signs_at_roots_copr_def characterize_root_list_p_def h1 imageE in_set_member mem_Collect_eq nonzero poly_roots_finite set_map set_remdups sorted_list_of_set<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> h3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">w</span><span class="main">.</span> rat_of_nat <span class="main">(</span>card <span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> consistent_sign_vec_copr <span class="free">qs</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">w</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟶</span> 
        <span class="bound">w</span> <span class="main">∉</span> set <span class="main">(</span>characterize_consistent_signs_at_roots_copr <span class="free">p</span> <span class="free">qs</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> in_set_member<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> h0 h3
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>characterize_consistent_signs_at_roots_copr <span class="free">p</span> <span class="free">qs</span><span class="main">)</span> <span class="main">⊆</span> set <span class="main">(</span>take_indices <span class="free">signs</span>
             <span class="main">(</span>find_nonzeros_from_input_vec <span class="main">(</span>solve_for_lhs <span class="free">p</span> <span class="free">qs</span> <span class="free">subsets</span> <span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> all_info
      reduction_signs_set_helper_lemma<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> A <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>characterize_consistent_signs_at_roots_copr <span class="free">p</span> <span class="free">qs</span><span class="main">)</span>"</span></span><span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> B <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="free">signs</span>"</span></span><span class="main">,</span>
      <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> C <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>solve_for_lhs <span class="free">p</span> <span class="free">qs</span> <span class="free">subsets</span> <span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">using</span></span> dim_hyp2 solve_for_lhs_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mat_inverse_same<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> reduction_signs_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="BKR_Proofs-reduction_deletes_bad_sign_conds"><span class="command">lemma</span></span> reduction_deletes_bad_sign_conds<span class="main">:</span>  
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">p</span><span class="main">::</span> <span class="quoted"><span class="quoted">"real poly"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">qs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real poly list"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">subsets</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat list list"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">signs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"rat list list"</span></span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> nonzero<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> welldefined_signs1<span class="main">:</span> <span class="quoted"><span class="quoted">"well_def_signs <span class="main">(</span>length <span class="free">qs</span><span class="main">)</span> <span class="free">signs</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> distinct_signs<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="free">signs</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> all_info<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>characterize_consistent_signs_at_roots_copr <span class="free">p</span> <span class="free">qs</span><span class="main">)</span> <span class="main">⊆</span> set<span class="main">(</span><span class="free">signs</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> match<span class="main">:</span> <span class="quoted"><span class="quoted">"satisfy_equation <span class="free">p</span> <span class="free">qs</span> <span class="free">subsets</span> <span class="free">signs</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> invertible_mat<span class="main">:</span> <span class="quoted"><span class="quoted">"invertible_mat <span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>characterize_consistent_signs_at_roots_copr <span class="free">p</span> <span class="free">qs</span><span class="main">)</span> <span class="main">=</span> set<span class="main">(</span>reduction_signs <span class="free">p</span> <span class="free">qs</span> <span class="free">signs</span> <span class="free">subsets</span> <span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
  <span class="keyword1"><span class="command">have</span></span> dim_hyp2<span class="main">:</span> <span class="quoted"><span class="quoted">"matr_option <span class="main">(</span>dim_row <span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span>
       <span class="main">(</span>mat_inverse <span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> carrier_mat <span class="main">(</span>length <span class="free">signs</span><span class="main">)</span> <span class="main">(</span>length <span class="free">signs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> invertible_mat dim_invertible
    <span class="keyword1"><span class="command">using</span></span> same_size <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span> 
  <span class="keyword1"><span class="command">have</span></span> supset<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>characterize_consistent_signs_at_roots_copr <span class="free">p</span> <span class="free">qs</span><span class="main">)</span> <span class="main">⊇</span> set<span class="main">(</span>reduction_signs <span class="free">p</span> <span class="free">qs</span> <span class="free">signs</span> <span class="free">subsets</span> <span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>construct_lhs_vector <span class="free">p</span> <span class="free">qs</span> <span class="free">signs</span><span class="main">)</span> <span class="main">=</span> solve_for_lhs <span class="free">p</span> <span class="free">qs</span> <span class="free">subsets</span> <span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> construct_lhs_matches_solve_for_lhs assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>solve_for_lhs <span class="free">p</span> <span class="free">qs</span> <span class="free">subsets</span> <span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
       vec_of_list <span class="main">(</span>map rat_of_nat <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> card <span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> consistent_sign_vec_copr <span class="free">qs</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">s</span><span class="main">}</span><span class="main">)</span> <span class="free">signs</span><span class="main">)</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> construct_lhs_vector_cleaner assms
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> list.map_cong map_map o_apply of_int_of_nat_eq<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound"><span class="bound">n</span></span> <span class="main">&lt;</span> <span class="main">(</span>dim_vec <span class="main">(</span>solve_for_lhs <span class="free">p</span> <span class="free">qs</span> <span class="free">subsets</span> <span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> 
           <span class="main">(</span><span class="main">(</span><span class="main">(</span>solve_for_lhs <span class="free">p</span> <span class="free">qs</span> <span class="free">subsets</span> <span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span> <span class="main">$</span> <span class="bound">n</span> <span class="main">≠</span> <span class="main">0</span><span class="main">)</span> <span class="main">⟶</span>
           <span class="main">(</span>nth <span class="free">signs</span> <span class="bound">n</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>characterize_consistent_signs_at_roots_copr <span class="free">p</span> <span class="free">qs</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
      <span class="keyword1"><span class="command">have</span></span> h0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound"><span class="bound">n</span></span> <span class="main">&lt;</span> <span class="main">(</span>dim_vec <span class="main">(</span>solve_for_lhs <span class="free">p</span> <span class="free">qs</span> <span class="free">subsets</span> <span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> 
           <span class="main">(</span><span class="main">(</span><span class="main">(</span>solve_for_lhs <span class="free">p</span> <span class="free">qs</span> <span class="free">subsets</span> <span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span> <span class="main">$</span> <span class="bound">n</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span> <span class="main">⟶</span> 
           rat_of_nat <span class="main">(</span>card <span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> consistent_sign_vec_copr <span class="free">qs</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">(</span>nth <span class="free">signs</span> <span class="bound">n</span><span class="main">)</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> <span class="quoted"><span class="quoted">‹construct_lhs_vector <span class="free">p</span> <span class="free">qs</span> <span class="free">signs</span> <span class="main">=</span> solve_for_lhs <span class="free">p</span> <span class="free">qs</span> <span class="free">subsets</span> <span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span>›</span></span> construct_lhs_vector_clean nonzero of_nat_0_eq_iff of_rat_of_nat_eq size_of_lhs<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> h1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">w</span><span class="main">.</span> <span class="main">(</span>rat_of_nat <span class="main">(</span>card <span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> consistent_sign_vec_copr <span class="free">qs</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">w</span><span class="main">}</span><span class="main">)</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">⟶</span> 
            <span class="main">(</span><span class="main">∃</span> <span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> consistent_sign_vec_copr <span class="free">qs</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">w</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">clarsimp</span> 
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">w</span>
        <span class="keyword3"><span class="command">assume</span></span> card_asm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> card <span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> consistent_sign_vec_copr <span class="free">qs</span> <span class="bound">x</span> <span class="main">=</span> <span class="skolem">w</span><span class="main">}</span>"</span></span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> consistent_sign_vec_copr <span class="free">qs</span> <span class="bound">x</span> <span class="main">=</span> <span class="skolem">w</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> Collect_empty_eq card_asm card_eq_0_iff gr_implies_not0<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">have</span></span> h2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">w</span><span class="main">.</span> <span class="main">(</span>rat_of_nat <span class="main">(</span>card <span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> consistent_sign_vec_copr <span class="free">qs</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">w</span><span class="main">}</span><span class="main">)</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">⟹</span>
           <span class="main">(</span>List.member <span class="main">(</span>characterize_consistent_signs_at_roots_copr <span class="free">p</span> <span class="free">qs</span><span class="main">)</span> <span class="bound">w</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">clarsimp</span> 
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">w</span>
        <span class="keyword3"><span class="command">assume</span></span> card_asm<span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="main">0</span> <span class="main">&lt;</span> card <span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> consistent_sign_vec_copr <span class="free">qs</span> <span class="bound">x</span> <span class="main">=</span> <span class="skolem">w</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">have</span></span> h0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> consistent_sign_vec_copr <span class="free">qs</span> <span class="bound">x</span> <span class="main">=</span> <span class="skolem">w</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> card_asm
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> h1<span class="main">)</span> 
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"List.member <span class="main">(</span>characterize_consistent_signs_at_roots_copr <span class="free">p</span> <span class="free">qs</span><span class="main">)</span> <span class="skolem">w</span>"</span></span> 
          <span class="keyword1"><span class="command">unfolding</span></span> characterize_consistent_signs_at_roots_copr_def
          <span class="keyword1"><span class="command">using</span></span> in_set_member nonzero poly_roots_finite characterize_root_list_p_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> h3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">w</span><span class="main">.</span> rat_of_nat <span class="main">(</span>card <span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> consistent_sign_vec_copr <span class="free">qs</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">w</span><span class="main">}</span><span class="main">)</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">⟶</span> 
            <span class="bound">w</span> <span class="main">∈</span> set <span class="main">(</span>characterize_consistent_signs_at_roots_copr <span class="free">p</span> <span class="free">qs</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> in_set_member<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> h0 h3
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> <span class="quoted"><span class="quoted">‹solve_for_lhs <span class="free">p</span> <span class="free">qs</span> <span class="free">subsets</span> <span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span> <span class="main">=</span> vec_of_list <span class="main">(</span>map rat_of_nat <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> card <span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> consistent_sign_vec_copr <span class="free">qs</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">s</span><span class="main">}</span><span class="main">)</span> <span class="free">signs</span><span class="main">)</span><span class="main">)</span>›</span></span> dim_vec_of_list length_map nth_map vec_of_list_index<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>take_indices <span class="free">signs</span>
                 <span class="main">(</span>find_nonzeros_from_input_vec <span class="main">(</span>solve_for_lhs <span class="free">p</span> <span class="free">qs</span> <span class="free">subsets</span> <span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span>
              set <span class="main">(</span>characterize_consistent_signs_at_roots_copr <span class="free">p</span> <span class="free">qs</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> all_info
        reduction_signs_set_helper_lemma2<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> A <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>characterize_consistent_signs_at_roots_copr <span class="free">p</span> <span class="free">qs</span><span class="main">)</span>"</span></span><span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> B <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="free">signs</span>"</span></span><span class="main">,</span>
        <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> C <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>solve_for_lhs <span class="free">p</span> <span class="free">qs</span> <span class="free">subsets</span> <span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span>"</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">using</span></span> distinct_signs dim_hyp2 solve_for_lhs_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mat_inverse_same<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> reduction_signs_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">have</span></span> subset<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>characterize_consistent_signs_at_roots_copr <span class="free">p</span> <span class="free">qs</span><span class="main">)</span> <span class="main">⊆</span> set<span class="main">(</span>reduction_signs <span class="free">p</span> <span class="free">qs</span> <span class="free">signs</span> <span class="free">subsets</span> <span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> reduction_doesnt_break_things_signs<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">p</span></span> <span class="quoted"><span class="free">qs</span></span> <span class="quoted"><span class="free">signs</span></span> <span class="quoted"><span class="free">subsets</span></span><span class="main">]</span> assms
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> supset subset <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">theorem</span></span> reduce_system_sign_conditions<span class="main">:</span>  
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">p</span><span class="main">::</span> <span class="quoted"><span class="quoted">"real poly"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">qs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real poly list"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">subsets</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat list list"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">signs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"rat list list"</span></span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> nonzero<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> welldefined_signs1<span class="main">:</span> <span class="quoted"><span class="quoted">"well_def_signs <span class="main">(</span>length <span class="free">qs</span><span class="main">)</span> <span class="free">signs</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> distinct_signs<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="free">signs</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> all_info<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>characterize_consistent_signs_at_roots_copr <span class="free">p</span> <span class="free">qs</span><span class="main">)</span> <span class="main">⊆</span> set<span class="main">(</span><span class="free">signs</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> match<span class="main">:</span> <span class="quoted"><span class="quoted">"satisfy_equation <span class="free">p</span> <span class="free">qs</span> <span class="free">subsets</span> <span class="free">signs</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> invertible_mat<span class="main">:</span> <span class="quoted"><span class="quoted">"invertible_mat <span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>get_signs <span class="main">(</span>reduce_system <span class="free">p</span> <span class="main">(</span><span class="free">qs</span><span class="main">,</span> <span class="main">(</span><span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free">subsets</span><span class="main">,</span> <span class="free">signs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> set <span class="main">(</span>characterize_consistent_signs_at_roots_copr <span class="free">p</span> <span class="free">qs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> get_signs_def
  <span class="keyword1"><span class="command">using</span></span> reduction_deletes_bad_sign_conds<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">p</span></span> <span class="quoted"><span class="free">qs</span></span> <span class="quoted"><span class="free">signs</span></span> <span class="quoted"><span class="free">subsets</span></span><span class="main">]</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> all_info distinct_signs match nonzero reduction_signs_def welldefined_signs1<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> nonzero invertible_mat <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> snd_conv<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> all_info distinct_signs invertible_mat match nonzero reduction_signs_def snd_conv welldefined_signs1<span class="main">)</span> 

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Showing matrix equation preserved when reducing"</span></span>
<span class="keyword1" id="BKR_Proofs-rows_to_keep_lem"><span class="command">lemma</span></span> rows_to_keep_lem<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span><span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>field<span class="main">)</span> mat"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">ell</span><span class="main">.</span> <span class="bound">ell</span> <span class="main">∈</span> set <span class="main">(</span>rows_to_keep <span class="free">A</span><span class="main">)</span> <span class="main">⟹</span> <span class="bound">ell</span> <span class="main">&lt;</span> dim_row <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> rows_to_keep_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">using</span></span> rref_pivot_positions
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> carrier_mat_triv gauss_jordan_single<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> gauss_jordan_single<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> index_transpose_mat<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span> 

<span class="keyword1" id="BKR_Proofs-reduce_system_matrix_equation_preserved"><span class="command">lemma</span></span> reduce_system_matrix_equation_preserved<span class="main">:</span>  
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">p</span><span class="main">::</span> <span class="quoted"><span class="quoted">"real poly"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">qs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real poly list"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">subsets</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat list list"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">signs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"rat list list"</span></span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> nonzero<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> welldefined_signs<span class="main">:</span> <span class="quoted"><span class="quoted">"well_def_signs <span class="main">(</span>length <span class="free">qs</span><span class="main">)</span> <span class="free">signs</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> welldefined_subsets<span class="main">:</span> <span class="quoted"><span class="quoted">"all_list_constr <span class="main">(</span><span class="free">subsets</span><span class="main">)</span> <span class="main">(</span>length <span class="free">qs</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> distinct_signs<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="free">signs</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> all_info<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>characterize_consistent_signs_at_roots_copr <span class="free">p</span> <span class="free">qs</span><span class="main">)</span> <span class="main">⊆</span> set<span class="main">(</span><span class="free">signs</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> match<span class="main">:</span> <span class="quoted"><span class="quoted">"satisfy_equation <span class="free">p</span> <span class="free">qs</span> <span class="free">subsets</span> <span class="free">signs</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> invertible_mat<span class="main">:</span> <span class="quoted"><span class="quoted">"invertible_mat <span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> pairwise_rel_prime<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">q</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span>List.member <span class="free">qs</span> <span class="bound">q</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">(</span>coprime <span class="free">p</span> <span class="bound">q</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"satisfy_equation <span class="free">p</span> <span class="free">qs</span> <span class="main">(</span>get_subsets <span class="main">(</span>reduce_system <span class="free">p</span> <span class="main">(</span><span class="free">qs</span><span class="main">,</span> <span class="main">(</span><span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free">subsets</span><span class="main">,</span> <span class="free">signs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
  <span class="main">(</span>get_signs <span class="main">(</span>reduce_system <span class="free">p</span> <span class="main">(</span><span class="free">qs</span><span class="main">,</span> <span class="main">(</span><span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free">subsets</span><span class="main">,</span> <span class="free">signs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
  <span class="keyword1"><span class="command">have</span></span> poly_type_hyp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> nonzero <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> distinct_signs_hyp<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>snd <span class="main">(</span>snd <span class="main">(</span>reduce_system <span class="free">p</span> <span class="main">(</span><span class="free">qs</span><span class="main">,</span> <span class="main">(</span><span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free">subsets</span><span class="main">,</span> <span class="free">signs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?sym</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>find_nonzeros_from_input_vec <span class="main">(</span>solve_for_lhs <span class="free">p</span> <span class="free">qs</span> <span class="free">subsets</span> <span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> h1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> length <span class="main">(</span>take_indices <span class="free">signs</span> <span class="var">?sym</span><span class="main">)</span><span class="main">.</span> <span class="main">∀</span><span class="bound"><span class="bound">j</span></span> <span class="main">&lt;</span> length<span class="main">(</span>take_indices <span class="free">signs</span> <span class="var">?sym</span><span class="main">)</span><span class="main">.</span>
      <span class="bound">i</span> <span class="main">≠</span> <span class="bound">j</span> <span class="main">⟶</span> nth <span class="main">(</span>take_indices <span class="free">signs</span> <span class="var">?sym</span><span class="main">)</span> <span class="bound">i</span> <span class="main">≠</span> nth <span class="main">(</span>take_indices <span class="free">signs</span> <span class="var">?sym</span><span class="main">)</span> <span class="bound">j</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> distinct_signs <span class="keyword1"><span class="command">unfolding</span></span> take_indices_def 
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">clarsimp</span> 
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">j</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"distinct <span class="free">signs</span>"</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> length
                <span class="main">(</span>find_nonzeros_from_input_vec <span class="main">(</span>solve_for_lhs <span class="free">p</span> <span class="free">qs</span> <span class="free">subsets</span> <span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> length
                <span class="main">(</span>find_nonzeros_from_input_vec <span class="main">(</span>solve_for_lhs <span class="free">p</span> <span class="free">qs</span> <span class="free">subsets</span> <span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword3"><span class="command">assume</span></span> neq_hyp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">≠</span> <span class="skolem">j</span>"</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">signs</span> <span class="main">!</span> <span class="main">(</span>find_nonzeros_from_input_vec <span class="main">(</span>solve_for_lhs <span class="free">p</span> <span class="free">qs</span> <span class="free">subsets</span> 
              <span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">=</span>
           <span class="free">signs</span> <span class="main">!</span> <span class="main">(</span>find_nonzeros_from_input_vec <span class="main">(</span>solve_for_lhs <span class="free">p</span> <span class="free">qs</span> <span class="free">subsets</span> 
              <span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> h1<span class="main">:</span> <span class="quoted"><span class="quoted">"find_nonzeros_from_input_vec <span class="main">(</span>solve_for_lhs <span class="free">p</span> <span class="free">qs</span> <span class="free">subsets</span> 
              <span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">≠</span> find_nonzeros_from_input_vec <span class="main">(</span>solve_for_lhs <span class="free">p</span> <span class="free">qs</span> <span class="free">subsets</span> 
              <span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">j</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> find_nonzeros_from_input_vec_def <span class="keyword1"><span class="command">using</span></span> neq_hyp
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="main">(</span>find_nonzeros_from_input_vec <span class="main">(</span>solve_for_lhs <span class="free">p</span> <span class="free">qs</span> <span class="free">subsets</span> <span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">j</span> <span class="main">&lt;</span> length <span class="main">(</span>find_nonzeros_from_input_vec <span class="main">(</span>solve_for_lhs <span class="free">p</span> <span class="free">qs</span> <span class="free">subsets</span> <span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>›</span></span> distinct_conv_nth distinct_filter distinct_upt find_nonzeros_from_input_vec_def<span class="main">)</span> 
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"False"</span></span> <span class="keyword1"><span class="command">using</span></span> distinct_signs
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">have</span></span> f1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span> <span class="bound">ns</span> <span class="bound">n</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="bound">n</span><span class="main">::</span>nat<span class="main">)</span> <span class="main">∈</span> <span class="main">{</span><span class="bound"><span class="bound">n</span></span> <span class="main">∈</span> set <span class="bound">ns</span><span class="main">.</span> <span class="bound">p</span> <span class="bound">n</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="bound">n</span> <span class="main">∈</span> set <span class="bound">ns</span> <span class="main">∧</span> <span class="bound">n</span> <span class="main">∈</span> Collect <span class="bound">p</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> f2<span class="main">:</span> <span class="quoted"><span class="quoted">"filter <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> solve_for_lhs <span class="free">p</span> <span class="free">qs</span> <span class="free">subsets</span> <span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span> <span class="main">$</span> <span class="bound">n</span> <span class="main">≠</span> <span class="main">0</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>dim_vec <span class="main">(</span>solve_for_lhs <span class="free">p</span> <span class="free">qs</span> <span class="free">subsets</span> <span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span><span class="main">]</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">∈</span> set <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="free">signs</span><span class="main">]</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="main">(</span>find_nonzeros_from_input_vec <span class="main">(</span>solve_for_lhs <span class="free">p</span> <span class="free">qs</span> <span class="free">subsets</span> <span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>›</span></span> construct_lhs_matches_solve_for_lhs find_nonzeros_from_input_vec_def invertible_mat match nth_mem set_filter size_of_lhs<span class="main">)</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"filter <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> solve_for_lhs <span class="free">p</span> <span class="free">qs</span> <span class="free">subsets</span> <span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span> <span class="main">$</span> <span class="bound">n</span> <span class="main">≠</span> <span class="main">0</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>dim_vec <span class="main">(</span>solve_for_lhs <span class="free">p</span> <span class="free">qs</span> <span class="free">subsets</span> <span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span><span class="main">]</span> <span class="main">!</span> <span class="skolem">j</span> <span class="main">∈</span> set <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="free">signs</span><span class="main">]</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> f1 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">j</span> <span class="main">&lt;</span> length <span class="main">(</span>find_nonzeros_from_input_vec <span class="main">(</span>solve_for_lhs <span class="free">p</span> <span class="free">qs</span> <span class="free">subsets</span> <span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>›</span></span> construct_lhs_matches_solve_for_lhs find_nonzeros_from_input_vec_def invertible_mat match nth_mem set_filter size_of_lhs<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">using</span></span> f2 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹<span class="free">signs</span> <span class="main">!</span> <span class="main">(</span>find_nonzeros_from_input_vec <span class="main">(</span>solve_for_lhs <span class="free">p</span> <span class="free">qs</span> <span class="free">subsets</span> <span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">=</span> <span class="free">signs</span> <span class="main">!</span> <span class="main">(</span>find_nonzeros_from_input_vec <span class="main">(</span>solve_for_lhs <span class="free">p</span> <span class="free">qs</span> <span class="free">subsets</span> <span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">)</span>›</span></span> atLeastLessThan_iff distinct_conv_nth distinct_signs find_nonzeros_from_input_vec_def h1 set_upt<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>take_indices <span class="free">signs</span> <span class="main">(</span>find_nonzeros_from_input_vec <span class="main">(</span>solve_for_lhs <span class="free">p</span> <span class="free">qs</span> <span class="free">subsets</span> <span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> distinct_conv_nth <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> get_signs_def reduction_signs_def reduction_signs_is_get_signs <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">have</span></span> all_info_hyp<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>characterize_consistent_signs_at_roots_copr <span class="free">p</span> <span class="free">qs</span><span class="main">)</span> <span class="main">⊆</span> set<span class="main">(</span>snd <span class="main">(</span>snd <span class="main">(</span>reduce_system <span class="free">p</span> <span class="main">(</span><span class="free">qs</span><span class="main">,</span> <span class="main">(</span><span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free">subsets</span><span class="main">,</span> <span class="free">signs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> reduce_system_sign_conditions assms <span class="keyword1"><span class="command">unfolding</span></span> get_signs_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> pairwise_rel_prime_hyp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">q</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span>List.member <span class="free">qs</span> <span class="bound">q</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">(</span>coprime <span class="free">p</span> <span class="bound">q</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> pairwise_rel_prime <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> welldefined_hyp<span class="main">:</span> <span class="quoted"><span class="quoted">"all_list_constr <span class="main">(</span>fst <span class="main">(</span>snd <span class="main">(</span>reduce_system <span class="free">p</span> <span class="main">(</span><span class="free">qs</span><span class="main">,</span> <span class="main">(</span><span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free">subsets</span><span class="main">,</span> <span class="free">signs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>length <span class="free">qs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> welldefined_subsets rows_to_keep_lem
    <span class="keyword1"><span class="command">unfolding</span></span> all_list_constr_def List.member_def list_constr_def list_all_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def take_indices_def take_cols_from_matrix_def<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> nth_mem <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> poly_type_hyp distinct_signs_hyp all_info_hyp pairwise_rel_prime_hyp welldefined_hyp
    <span class="keyword1"><span class="command">using</span></span> matrix_equation <span class="keyword1"><span class="command">unfolding</span></span> get_subsets_def get_signs_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(* Show that we are tracking the correct matrix in the algorithm *)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Showing matrix preserved"</span></span>
<span class="keyword1" id="BKR_Proofs-reduce_system_matrix_signs_helper_aux"><span class="command">lemma</span></span> reduce_system_matrix_signs_helper_aux<span class="main">:</span>  
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">p</span><span class="main">::</span> <span class="quoted"><span class="quoted">"real poly"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">qs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real poly list"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">subsets</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat list list"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">signs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"rat list list"</span></span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">S</span><span class="main">::</span> <span class="quoted"><span class="quoted">"nat list"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> well_def_h<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">.</span> List.member <span class="free">S</span> <span class="bound">x</span> <span class="main">⟶</span> <span class="bound">x</span> <span class="main">&lt;</span> length <span class="free">signs</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> nonzero<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"alt_matrix_A <span class="main">(</span>take_indices <span class="free">signs</span> <span class="free">S</span><span class="main">)</span> <span class="free">subsets</span> <span class="main">=</span> take_cols_from_matrix <span class="main">(</span>alt_matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span> <span class="free">S</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
  <span class="keyword1"><span class="command">have</span></span> h0a<span class="main">:</span> <span class="quoted"><span class="quoted">"dim_col <span class="main">(</span>take_cols_from_matrix <span class="main">(</span>alt_matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span> <span class="free">S</span><span class="main">)</span> <span class="main">=</span> length <span class="main">(</span>take_indices <span class="free">signs</span> <span class="free">S</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">unfolding</span></span> take_cols_from_matrix_def <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> take_indices_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> h0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> length <span class="main">(</span>take_indices <span class="free">signs</span> <span class="free">S</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span>col <span class="main">(</span>alt_matrix_A <span class="main">(</span>take_indices <span class="free">signs</span> <span class="free">S</span><span class="main">)</span> <span class="free">subsets</span> <span class="main">)</span> <span class="bound">i</span> <span class="main">=</span> 
col <span class="main">(</span>take_cols_from_matrix <span class="main">(</span>alt_matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span> <span class="free">S</span><span class="main">)</span> <span class="bound">i</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">clarsimp</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span>
    <span class="keyword3"><span class="command">assume</span></span> asm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="main">(</span>take_indices <span class="free">signs</span> <span class="free">S</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> i_lt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="main">(</span>map <span class="main">(</span><span class="main">(!)</span> <span class="main">(</span>cols <span class="main">(</span>alt_matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">S</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> asm
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> take_indices_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> h0<span class="main">:</span> <span class="quoted"><span class="quoted">" vec <span class="main">(</span>length <span class="free">subsets</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">j</span><span class="main">.</span> z <span class="main">(</span><span class="free">subsets</span> <span class="main">!</span> <span class="bound">j</span><span class="main">)</span> <span class="main">(</span>map <span class="main">(</span><span class="main">(!)</span> <span class="free">signs</span><span class="main">)</span> <span class="free">S</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
      vec <span class="main">(</span>length <span class="free">subsets</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">j</span><span class="main">.</span> z <span class="main">(</span><span class="free">subsets</span> <span class="main">!</span> <span class="bound">j</span><span class="main">)</span> <span class="main">(</span><span class="free">signs</span> <span class="main">!</span> <span class="main">(</span><span class="free">S</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> nth_map
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="main">(</span>take_indices <span class="free">signs</span> <span class="free">S</span><span class="main">)</span>›</span></span> length_map take_indices_def<span class="main">)</span> 
    <span class="keyword1"><span class="command">have</span></span> dim<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>map <span class="main">(</span><span class="main">(!)</span> <span class="main">(</span>cols <span class="main">(</span>alt_matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">S</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">∈</span> carrier_vec <span class="main">(</span>dim_row <span class="main">(</span>alt_matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"dim_col <span class="main">(</span>alt_matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span> <span class="main">=</span> length <span class="main">(</span><span class="free">signs</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> alt_matrix_A_def<span class="main">)</span> 
      <span class="keyword1"><span class="command">have</span></span> well_d<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">&lt;</span> length <span class="main">(</span><span class="free">signs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> well_def_h
        <span class="keyword1"><span class="command">using</span></span> i_lt in_set_member <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span> 
      <span class="keyword1"><span class="command">have</span></span> 
        map_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>map <span class="main">(</span><span class="main">(!)</span> <span class="main">(</span>cols <span class="main">(</span>alt_matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">S</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">i</span>  <span class="main">=</span> nth <span class="main">(</span>cols <span class="main">(</span>alt_matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span>  <span class="main">(</span><span class="free">S</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> i_lt <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"nth <span class="main">(</span>cols <span class="main">(</span>alt_matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span>  <span class="main">(</span><span class="free">S</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">∈</span> carrier_vec <span class="main">(</span>dim_row <span class="main">(</span>alt_matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> col_dim <span class="keyword1"><span class="command">unfolding</span></span> cols_def <span class="keyword1"><span class="command">using</span></span> nth_map well_d
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹dim_col <span class="main">(</span>alt_matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span> <span class="main">=</span> length <span class="free">signs</span>›</span></span><span class="main">)</span> 
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> map_eq <span class="keyword1"><span class="command">unfolding</span></span> alt_matrix_A_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">have</span></span> h1<span class="main">:</span> <span class="quoted"><span class="quoted">"col <span class="main">(</span>take_cols_from_matrix <span class="main">(</span>alt_matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span> <span class="free">S</span><span class="main">)</span> <span class="skolem">i</span> <span class="main">=</span> 
      col <span class="main">(</span>mat_of_cols <span class="main">(</span>dim_row <span class="main">(</span>alt_matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>map <span class="main">(</span><span class="main">(!)</span> <span class="main">(</span>cols <span class="main">(</span>alt_matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">S</span><span class="main">)</span><span class="main">)</span> <span class="skolem">i</span> "</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> take_cols_from_matrix_def take_indices_def<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> h2<span class="main">:</span> <span class="quoted"><span class="quoted">"col <span class="main">(</span>mat_of_cols <span class="main">(</span>dim_row <span class="main">(</span>alt_matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>map <span class="main">(</span><span class="main">(!)</span> <span class="main">(</span>cols <span class="main">(</span>alt_matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">S</span><span class="main">)</span><span class="main">)</span> <span class="skolem">i</span> 
      <span class="main">=</span> nth <span class="main">(</span>map <span class="main">(</span><span class="main">(!)</span> <span class="main">(</span>cols <span class="main">(</span>alt_matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">S</span><span class="main">)</span> <span class="skolem">i</span> "</span></span> 
      <span class="keyword1"><span class="command">using</span></span> dim i_lt asm col_mat_of_cols<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> j <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span>"</span></span><span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> n <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>dim_row <span class="main">(</span>alt_matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span>"</span></span><span class="main">,</span>
          <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> vs <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>map <span class="main">(</span><span class="main">(!)</span> <span class="main">(</span>cols <span class="main">(</span>alt_matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">S</span><span class="main">)</span>"</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
    <span class="keyword1"><span class="command">have</span></span> h3<span class="main">:</span> <span class="quoted"><span class="quoted">"col <span class="main">(</span>take_cols_from_matrix <span class="main">(</span>alt_matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span> <span class="free">S</span><span class="main">)</span> <span class="skolem">i</span> <span class="main">=</span> <span class="main">(</span>col <span class="main">(</span>alt_matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span> <span class="main">(</span><span class="free">S</span> <span class="main">!</span><span class="skolem">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> h1 h2 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> alt_matrix_char asm cols_nth dim_col_mat<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> in_set_member length_map mat_of_rows_list_def matrix_A_def nth_map nth_mem take_indices_def well_def_h<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"vec <span class="main">(</span>length <span class="free">subsets</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">j</span><span class="main">.</span> z <span class="main">(</span><span class="free">subsets</span> <span class="main">!</span> <span class="bound">j</span><span class="main">)</span> <span class="main">(</span><span class="free">signs</span> <span class="main">!</span> <span class="main">(</span><span class="free">S</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>col <span class="main">(</span>alt_matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span> <span class="main">(</span><span class="free">S</span> <span class="main">!</span><span class="skolem">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> asm in_set_member length_map nth_mem signs_are_cols take_indices_def well_def_h<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"vec <span class="main">(</span>length <span class="free">subsets</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">j</span><span class="main">.</span> z <span class="main">(</span><span class="free">subsets</span> <span class="main">!</span> <span class="bound">j</span><span class="main">)</span> <span class="main">(</span>take_indices <span class="free">signs</span> <span class="free">S</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
      col <span class="main">(</span>take_cols_from_matrix <span class="main">(</span>alt_matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span> <span class="free">S</span><span class="main">)</span> <span class="skolem">i</span> "</span></span>
      <span class="keyword1"><span class="command">using</span></span> h0 h3
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> take_indices_def<span class="main">)</span> 
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"col <span class="main">(</span>alt_matrix_A <span class="main">(</span>take_indices <span class="free">signs</span> <span class="free">S</span><span class="main">)</span> <span class="free">subsets</span><span class="main">)</span> <span class="skolem">i</span> <span class="main">=</span>
         col <span class="main">(</span>take_cols_from_matrix <span class="main">(</span>alt_matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span> <span class="free">S</span><span class="main">)</span> <span class="skolem">i</span> "</span></span>
      <span class="keyword1"><span class="command">using</span></span> asm signs_are_cols<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> signs <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>take_indices <span class="free">signs</span> <span class="free">S</span><span class="main">)</span>"</span></span><span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> subsets <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="free">subsets</span>"</span></span><span class="main">]</span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>   <span class="keyword1"><span class="command">unfolding</span></span> alt_matrix_A_def take_cols_from_matrix_def <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span> 
    <span class="keyword1"><span class="command">using</span></span> h0a mat_col_eqI
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> alt_matrix_A_def dim_col_mat<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> dim_row_mat<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> h0 mat_of_cols_def take_cols_from_matrix_def<span class="main">)</span> 
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1" id="BKR_Proofs-reduce_system_matrix_signs_helper"><span class="command">lemma</span></span> reduce_system_matrix_signs_helper<span class="main">:</span>  
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">p</span><span class="main">::</span> <span class="quoted"><span class="quoted">"real poly"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">qs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real poly list"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">subsets</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat list list"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">signs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"rat list list"</span></span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">S</span><span class="main">::</span> <span class="quoted"><span class="quoted">"nat list"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> well_def_h<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">.</span> List.member <span class="free">S</span> <span class="bound">x</span> <span class="main">⟶</span> <span class="bound">x</span> <span class="main">&lt;</span> length <span class="free">signs</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> nonzero<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"matrix_A <span class="main">(</span>take_indices <span class="free">signs</span> <span class="free">S</span><span class="main">)</span> <span class="free">subsets</span> <span class="main">=</span> take_cols_from_matrix <span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span> <span class="free">S</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> reduce_system_matrix_signs_helper_aux alt_matrix_char assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="BKR_Proofs-reduce_system_matrix_subsets_helper_aux"><span class="command">lemma</span></span> reduce_system_matrix_subsets_helper_aux<span class="main">:</span>  
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">p</span><span class="main">::</span> <span class="quoted"><span class="quoted">"real poly"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">qs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real poly list"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">subsets</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat list list"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">signs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"rat list list"</span></span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">S</span><span class="main">::</span> <span class="quoted"><span class="quoted">"nat list"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> inv<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">subsets</span> <span class="main">≥</span> length <span class="free">signs</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> well_def_h<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">.</span> List.member <span class="free">S</span> <span class="bound">x</span> <span class="main">⟶</span> <span class="bound">x</span> <span class="main">&lt;</span> length <span class="free">subsets</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> nonzero<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"alt_matrix_A <span class="free">signs</span> <span class="main">(</span>take_indices <span class="free">subsets</span> <span class="free">S</span><span class="main">)</span> <span class="main">=</span> take_rows_from_matrix <span class="main">(</span>alt_matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span> <span class="free">S</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
  <span class="keyword1"><span class="command">have</span></span> h0a<span class="main">:</span> <span class="quoted"><span class="quoted">"dim_row <span class="main">(</span>take_rows_from_matrix <span class="main">(</span>alt_matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span> <span class="free">S</span><span class="main">)</span> <span class="main">=</span> length <span class="main">(</span>take_indices <span class="free">subsets</span> <span class="free">S</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">unfolding</span></span> take_rows_from_matrix_def <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> take_indices_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> h0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> length <span class="main">(</span>take_indices <span class="free">subsets</span> <span class="free">S</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span>row <span class="main">(</span>alt_matrix_A <span class="free">signs</span> <span class="main">(</span>take_indices <span class="free">subsets</span> <span class="free">S</span><span class="main">)</span> <span class="main">)</span> <span class="bound">i</span> <span class="main">=</span> 
row <span class="main">(</span>take_rows_from_matrix <span class="main">(</span>alt_matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span> <span class="free">S</span><span class="main">)</span> <span class="bound">i</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">clarsimp</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span>
    <span class="keyword3"><span class="command">assume</span></span> asm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="main">(</span>take_indices <span class="free">subsets</span> <span class="free">S</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> i_lt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="main">(</span>map <span class="main">(</span><span class="main">(!)</span> <span class="main">(</span>rows <span class="main">(</span>alt_matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">S</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> asm
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> take_indices_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> h0<span class="main">:</span> <span class="quoted"><span class="quoted">"row <span class="main">(</span>take_rows_from_matrix <span class="main">(</span>alt_matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span> <span class="free">S</span><span class="main">)</span> <span class="skolem">i</span> <span class="main">=</span>
    row <span class="main">(</span>mat_of_rows <span class="main">(</span>dim_col <span class="main">(</span>alt_matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>map <span class="main">(</span><span class="main">(!)</span> <span class="main">(</span>rows <span class="main">(</span>alt_matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">S</span><span class="main">)</span><span class="main">)</span> <span class="skolem">i</span> "</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> take_rows_from_matrix_def take_indices_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> dim<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>map <span class="main">(</span><span class="main">(!)</span> <span class="main">(</span>rows <span class="main">(</span>alt_matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">S</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">∈</span> carrier_vec <span class="main">(</span>dim_col <span class="main">(</span>alt_matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"dim_col <span class="main">(</span>alt_matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span> <span class="main">=</span> length <span class="main">(</span><span class="free">signs</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> alt_matrix_A_def<span class="main">)</span> 
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> lenh<span class="main">:</span> <span class="quoted"><span class="quoted">"dim_col <span class="main">(</span>alt_matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span> <span class="main">≤</span> length <span class="main">(</span><span class="free">subsets</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> assms
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
      <span class="keyword1"><span class="command">have</span></span> well_d<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">&lt;</span> length <span class="main">(</span><span class="free">subsets</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> well_def_h
        <span class="keyword1"><span class="command">using</span></span> i_lt in_set_member <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span> 
      <span class="keyword1"><span class="command">have</span></span> 
        map_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>map <span class="main">(</span><span class="main">(!)</span> <span class="main">(</span>rows <span class="main">(</span>alt_matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">S</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">i</span>  <span class="main">=</span> nth <span class="main">(</span>rows <span class="main">(</span>alt_matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span>  <span class="main">(</span><span class="free">S</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> i_lt <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"nth <span class="main">(</span>rows <span class="main">(</span>alt_matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span>  <span class="main">(</span><span class="free">S</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">∈</span> carrier_vec <span class="main">(</span>dim_col <span class="main">(</span>alt_matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> col_dim <span class="keyword1"><span class="command">unfolding</span></span> rows_def <span class="keyword1"><span class="command">using</span></span> nth_map well_d
        <span class="keyword1"><span class="command">using</span></span> lenh
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> alt_matrix_A_def<span class="main">)</span> 
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> map_eq <span class="keyword1"><span class="command">unfolding</span></span> alt_matrix_A_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">have</span></span> h1<span class="main">:</span> <span class="quoted"><span class="quoted">" row <span class="main">(</span>mat_of_rows <span class="main">(</span>dim_col <span class="main">(</span>alt_matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>map <span class="main">(</span><span class="main">(!)</span> <span class="main">(</span>rows <span class="main">(</span>alt_matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">S</span><span class="main">)</span><span class="main">)</span> <span class="skolem">i</span>
      <span class="main">=</span> <span class="main">(</span>row  <span class="main">(</span>alt_matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span> <span class="main">(</span><span class="free">S</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span> "</span></span>
      <span class="keyword1"><span class="command">using</span></span> dim i_lt mat_of_rows_row<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> i <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span>"</span></span><span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> n <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>dim_col <span class="main">(</span>alt_matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span>"</span></span><span class="main">,</span>
          <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> vs <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>map <span class="main">(</span><span class="main">(!)</span> <span class="main">(</span>rows <span class="main">(</span>alt_matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">S</span><span class="main">)</span>"</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">using</span></span> alt_matrix_char in_set_member nth_mem well_def_h <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"row <span class="main">(</span>alt_matrix_A <span class="free">signs</span> <span class="main">(</span>take_indices <span class="free">subsets</span> <span class="free">S</span><span class="main">)</span> <span class="main">)</span> <span class="skolem">i</span> <span class="main">=</span> <span class="main">(</span>row  <span class="main">(</span>alt_matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span> <span class="main">(</span><span class="free">S</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> subsets_are_rows
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> f1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="free">S</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> asm length_map take_indices_def<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"List.member <span class="free">S</span> <span class="main">(</span><span class="free">S</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> in_set_member nth_mem<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> f1 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹<span class="main">⋀</span><span class="bound">subsets</span> <span class="bound">signs</span><span class="main">.</span> <span class="main">∀</span><span class="bound"><span class="bound">i</span></span><span class="main">&lt;</span>length <span class="bound">subsets</span><span class="main">.</span> row <span class="main">(</span>alt_matrix_A <span class="bound">signs</span> <span class="bound">subsets</span><span class="main">)</span> <span class="bound">i</span> <span class="main">=</span> vec <span class="main">(</span>length <span class="bound">signs</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">j</span><span class="main">.</span> z <span class="main">(</span><span class="bound">subsets</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="bound">signs</span> <span class="main">!</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span>›</span></span> take_indices_def well_def_h<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span> 
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>row <span class="main">(</span>alt_matrix_A <span class="free">signs</span> <span class="main">(</span>take_indices <span class="free">subsets</span> <span class="free">S</span><span class="main">)</span> <span class="main">)</span> <span class="skolem">i</span> <span class="main">=</span> 
      row <span class="main">(</span>take_rows_from_matrix <span class="main">(</span>alt_matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span> <span class="free">S</span><span class="main">)</span> <span class="skolem">i</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> h0 h1 <span class="keyword1"><span class="command">unfolding</span></span> take_indices_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>  <span class="keyword1"><span class="command">unfolding</span></span> alt_matrix_A_def take_rows_from_matrix_def <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span> 
    <span class="keyword1"><span class="command">using</span></span> eq_rowI
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> alt_matrix_A_def dim_col_mat<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> dim_row_mat<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> h0 length_map mat_of_rows_def take_indices_def take_rows_from_matrix_def<span class="main">)</span> 
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1" id="BKR_Proofs-reduce_system_matrix_subsets_helper"><span class="command">lemma</span></span> reduce_system_matrix_subsets_helper<span class="main">:</span>  
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">p</span><span class="main">::</span> <span class="quoted"><span class="quoted">"real poly"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">qs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real poly list"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">subsets</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat list list"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">signs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"rat list list"</span></span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">S</span><span class="main">::</span> <span class="quoted"><span class="quoted">"nat list"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> nonzero<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> inv<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">subsets</span> <span class="main">≥</span> length <span class="free">signs</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> well_def_h<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">.</span> List.member <span class="free">S</span> <span class="bound">x</span> <span class="main">⟶</span> <span class="bound">x</span> <span class="main">&lt;</span> length <span class="free">subsets</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"matrix_A <span class="free">signs</span> <span class="main">(</span>take_indices <span class="free">subsets</span> <span class="free">S</span><span class="main">)</span> <span class="main">=</span> take_rows_from_matrix <span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span> <span class="free">S</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms reduce_system_matrix_subsets_helper_aux alt_matrix_char
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="BKR_Proofs-reduce_system_matrix_match"><span class="command">lemma</span></span> reduce_system_matrix_match<span class="main">:</span>  
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">p</span><span class="main">::</span> <span class="quoted"><span class="quoted">"real poly"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">qs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real poly list"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">subsets</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat list list"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">signs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"rat list list"</span></span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> nonzero<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> welldefined_signs1<span class="main">:</span> <span class="quoted"><span class="quoted">"well_def_signs <span class="main">(</span>length <span class="free">qs</span><span class="main">)</span> <span class="free">signs</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> distinct_signs<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="free">signs</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> all_info<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>characterize_consistent_signs_at_roots_copr <span class="free">p</span> <span class="free">qs</span><span class="main">)</span> <span class="main">⊆</span> set<span class="main">(</span><span class="free">signs</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> match<span class="main">:</span> <span class="quoted"><span class="quoted">"satisfy_equation <span class="free">p</span> <span class="free">qs</span> <span class="free">subsets</span> <span class="free">signs</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> inv<span class="main">:</span> <span class="quoted"><span class="quoted">"invertible_mat <span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"matrix_A <span class="main">(</span>get_signs <span class="main">(</span>reduce_system <span class="free">p</span> <span class="main">(</span><span class="free">qs</span><span class="main">,</span> <span class="main">(</span><span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free">subsets</span><span class="main">,</span> <span class="free">signs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
  <span class="main">(</span>get_subsets <span class="main">(</span>reduce_system <span class="free">p</span> <span class="main">(</span><span class="free">qs</span><span class="main">,</span> <span class="main">(</span><span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free">subsets</span><span class="main">,</span> <span class="free">signs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
  <span class="main">(</span>get_matrix <span class="main">(</span>reduce_system <span class="free">p</span> <span class="main">(</span><span class="free">qs</span><span class="main">,</span> <span class="main">(</span><span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free">subsets</span><span class="main">,</span> <span class="free">signs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?A</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?lhs_vec</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>solve_for_lhs <span class="free">p</span> <span class="free">qs</span> <span class="free">subsets</span> <span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?red_mtx</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>take_rows_from_matrix <span class="main">(</span>reduce_mat_cols <span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span> <span class="var">?lhs_vec</span><span class="main">)</span> <span class="main">(</span>rows_to_keep <span class="main">(</span>reduce_mat_cols <span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span> <span class="var">?lhs_vec</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> h1<span class="main">:</span> <span class="quoted"><span class="quoted">"matrix_A <span class="main">(</span>get_signs <span class="main">(</span>reduce_system <span class="free">p</span> <span class="main">(</span><span class="free">qs</span><span class="main">,</span> <span class="main">(</span><span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free">subsets</span><span class="main">,</span> <span class="free">signs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
  <span class="main">(</span>get_subsets <span class="main">(</span>reduce_system <span class="free">p</span> <span class="main">(</span><span class="free">qs</span><span class="main">,</span> <span class="main">(</span><span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free">subsets</span><span class="main">,</span> <span class="free">signs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
   <span class="main">=</span> matrix_A <span class="main">(</span>reduction_signs <span class="free">p</span> <span class="free">qs</span> <span class="free">signs</span> <span class="free">subsets</span> <span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>reduction_subsets <span class="free">p</span> <span class="free">qs</span> <span class="free">signs</span> <span class="free">subsets</span> <span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> reduction_signs_is_get_signs reduction_subsets_is_get_subsets <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> h1_var<span class="main">:</span> <span class="quoted"><span class="quoted">"matrix_A <span class="main">(</span>get_signs <span class="main">(</span>reduce_system <span class="free">p</span> <span class="main">(</span><span class="free">qs</span><span class="main">,</span> <span class="main">(</span><span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free">subsets</span><span class="main">,</span> <span class="free">signs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
  <span class="main">(</span>get_subsets <span class="main">(</span>reduce_system <span class="free">p</span> <span class="main">(</span><span class="free">qs</span><span class="main">,</span> <span class="main">(</span><span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free">subsets</span><span class="main">,</span> <span class="free">signs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
   <span class="main">=</span> matrix_A <span class="main">(</span>take_indices <span class="free">signs</span> <span class="main">(</span>find_nonzeros_from_input_vec <span class="var">?lhs_vec</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>take_indices <span class="free">subsets</span> <span class="main">(</span>rows_to_keep <span class="main">(</span>reduce_mat_cols <span class="var">?A</span> <span class="var">?lhs_vec</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> h1 reduction_signs_def reduction_subsets_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
  <span class="keyword1"><span class="command">have</span></span> h2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?red_mtx</span> <span class="main">=</span> <span class="main">(</span>take_rows_from_matrix <span class="main">(</span>take_cols_from_matrix <span class="var">?A</span> <span class="main">(</span>find_nonzeros_from_input_vec <span class="var">?lhs_vec</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>rows_to_keep <span class="main">(</span>take_cols_from_matrix <span class="var">?A</span> <span class="main">(</span>find_nonzeros_from_input_vec <span class="var">?lhs_vec</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> h30<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>construct_lhs_vector <span class="free">p</span> <span class="free">qs</span> <span class="free">signs</span><span class="main">)</span> <span class="main">=</span> <span class="var">?lhs_vec</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms construct_lhs_matches_solve_for_lhs
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> 
  <span class="keyword1"><span class="command">have</span></span> h3a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">.</span> List.member <span class="main">(</span>find_nonzeros_from_input_vec <span class="var">?lhs_vec</span><span class="main">)</span> <span class="bound">x</span> <span class="main">⟶</span><span class="bound">x</span> <span class="main">&lt;</span> length <span class="main">(</span><span class="free">signs</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> h30 size_of_lhs <span class="keyword1"><span class="command">unfolding</span></span> find_nonzeros_from_input_vec_def <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> atLeastLessThan_iff filter_is_subset member_def set_upt subset_eq<span class="main">)</span> 
  <span class="keyword1"><span class="command">have</span></span> h3b_a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">.</span> List.member <span class="main">(</span>find_nonzeros_from_input_vec <span class="var">?lhs_vec</span><span class="main">)</span> <span class="bound">x</span> <span class="main">⟶</span><span class="bound">x</span> <span class="main">&lt;</span> length <span class="main">(</span><span class="free">subsets</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> assms h30 size_of_lhs same_size <span class="keyword1"><span class="command">unfolding</span></span> find_nonzeros_from_input_vec_def <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> find_nonzeros_from_input_vec_def h3a<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> h3ba<span class="main">:</span> <span class="quoted"><span class="quoted">"length
     <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> solve_for_lhs <span class="free">p</span> <span class="free">qs</span> <span class="free">subsets</span> <span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span> <span class="main">$</span> <span class="bound">i</span> <span class="main">≠</span> <span class="main">0</span><span class="main">)</span>
       <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="free">subsets</span><span class="main">]</span><span class="main">)</span>
    <span class="main">≤</span> length <span class="free">subsets</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> length_filter_le<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> P <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> solve_for_lhs <span class="free">p</span> <span class="free">qs</span> <span class="free">subsets</span> <span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span> <span class="main">$</span> <span class="bound">i</span> <span class="main">≠</span> <span class="main">0</span><span class="main">)</span>"</span></span><span class="main">,</span>
    <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> xs <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="free">subsets</span><span class="main">]</span>"</span></span><span class="main">]</span> length_upto <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">" length <span class="free">subsets</span> <span class="main">=</span> dim_vec <span class="main">(</span>solve_for_lhs <span class="free">p</span> <span class="free">qs</span> <span class="free">subsets</span> <span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> h30 inv size_of_lhs same_size<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">signs</span></span> <span class="quoted"><span class="free">subsets</span></span><span class="main">]</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length
     <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> solve_for_lhs <span class="free">p</span> <span class="free">qs</span> <span class="free">subsets</span> <span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span> <span class="main">$</span> <span class="bound">i</span> <span class="main">≠</span> <span class="main">0</span><span class="main">)</span>
       <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>dim_vec <span class="main">(</span>solve_for_lhs <span class="free">p</span> <span class="free">qs</span> <span class="free">subsets</span> <span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span><span class="main">]</span><span class="main">)</span>
    <span class="main">≤</span> length <span class="free">subsets</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> h3ba
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> h3b<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">subsets</span> <span class="main">≥</span> length <span class="main">(</span>take_indices <span class="free">signs</span> <span class="main">(</span>find_nonzeros_from_input_vec <span class="var">?lhs_vec</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">unfolding</span></span> take_indices_def find_nonzeros_from_input_vec_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> h3c<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">.</span> List.member <span class="main">(</span>rows_to_keep <span class="main">(</span>reduce_mat_cols <span class="var">?A</span> <span class="var">?lhs_vec</span><span class="main">)</span><span class="main">)</span> <span class="bound">x</span> <span class="main">⟶</span> <span class="bound">x</span> <span class="main">&lt;</span> length <span class="main">(</span><span class="free">subsets</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">clarsimp</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
    <span class="keyword3"><span class="command">assume</span></span> x_mem<span class="main">:</span> <span class="quoted"><span class="quoted">"List.member <span class="main">(</span>rows_to_keep
            <span class="main">(</span>take_cols_from_matrix <span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span>
              <span class="main">(</span>find_nonzeros_from_input_vec <span class="main">(</span>solve_for_lhs <span class="free">p</span> <span class="free">qs</span> <span class="free">subsets</span> <span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">x</span>"</span></span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">nn</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"rat list list <span class="main">⇒</span> nat list <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x2</span> <span class="bound">x3</span><span class="main">.</span> <span class="main">(</span><span class="main">∃</span><span class="bound">v4</span><span class="main">.</span> <span class="bound">v4</span> <span class="main">∈</span> set <span class="bound">x3</span> <span class="main">∧</span> <span class="main">¬</span> <span class="bound">v4</span> <span class="main">&lt;</span> length <span class="bound">x2</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">nn</span> <span class="bound">x2</span> <span class="bound">x3</span> <span class="main">∈</span> set <span class="bound">x3</span> <span class="main">∧</span> <span class="main">¬</span> <span class="skolem">nn</span> <span class="bound">x2</span> <span class="bound">x3</span> <span class="main">&lt;</span> length <span class="bound">x2</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">moura</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> f4<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">nn</span> <span class="free">signs</span> <span class="main">(</span>find_nonzeros_from_input_vec <span class="main">(</span>solve_for_lhs <span class="free">p</span> <span class="free">qs</span> <span class="free">subsets</span> <span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>find_nonzeros_from_input_vec <span class="main">(</span>solve_for_lhs <span class="free">p</span> <span class="free">qs</span> <span class="free">subsets</span> <span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="main">¬</span> <span class="skolem">nn</span> <span class="free">signs</span> <span class="main">(</span>find_nonzeros_from_input_vec <span class="main">(</span>solve_for_lhs <span class="free">p</span> <span class="free">qs</span> <span class="free">subsets</span> <span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">&lt;</span> length <span class="free">signs</span> <span class="main">∨</span> matrix_A <span class="main">(</span>take_indices <span class="free">signs</span> <span class="main">(</span>find_nonzeros_from_input_vec <span class="main">(</span>solve_for_lhs <span class="free">p</span> <span class="free">qs</span> <span class="free">subsets</span> <span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">subsets</span> <span class="main">=</span> take_cols_from_matrix <span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span> <span class="main">(</span>find_nonzeros_from_input_vec <span class="main">(</span>solve_for_lhs <span class="free">p</span> <span class="free">qs</span> <span class="free">subsets</span> <span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> h3a nonzero reduce_system_matrix_signs_helper <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"matrix_A <span class="main">(</span>take_indices <span class="free">signs</span> <span class="main">(</span>find_nonzeros_from_input_vec <span class="main">(</span>solve_for_lhs <span class="free">p</span> <span class="free">qs</span> <span class="free">subsets</span> <span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">subsets</span> <span class="main">=</span> take_cols_from_matrix <span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span> <span class="main">(</span>find_nonzeros_from_input_vec <span class="main">(</span>solve_for_lhs <span class="free">p</span> <span class="free">qs</span> <span class="free">subsets</span> <span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="skolem">x</span> <span class="main">∈</span> set <span class="main">(</span>map snd <span class="main">(</span>pivot_positions <span class="main">(</span>gauss_jordan_single <span class="main">(</span>take_cols_from_matrix <span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span> <span class="main">(</span>find_nonzeros_from_input_vec <span class="main">(</span>solve_for_lhs <span class="free">p</span> <span class="free">qs</span> <span class="free">subsets</span> <span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="keyword1"><span class="hidden">⇧</span><sup>T</sup></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> f4
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> h3a in_set_member rows_to_keep_def x_mem<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">&lt;</span> length <span class="main">(</span><span class="free">subsets</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> x_mem <span class="keyword1"><span class="command">unfolding</span></span> rows_to_keep_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> dim_row_matrix_A rows_to_keep_def rows_to_keep_lem<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">have</span></span> h3<span class="main">:</span> <span class="quoted"><span class="quoted">"matrix_A <span class="main">(</span>take_indices <span class="free">signs</span> <span class="main">(</span>find_nonzeros_from_input_vec <span class="var">?lhs_vec</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>take_indices <span class="free">subsets</span> <span class="main">(</span>rows_to_keep <span class="main">(</span>reduce_mat_cols <span class="var">?A</span> <span class="var">?lhs_vec</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
    <span class="main">(</span>take_rows_from_matrix <span class="main">(</span>take_cols_from_matrix <span class="var">?A</span> <span class="main">(</span>find_nonzeros_from_input_vec <span class="var">?lhs_vec</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>rows_to_keep <span class="main">(</span>take_cols_from_matrix <span class="var">?A</span> <span class="main">(</span>find_nonzeros_from_input_vec <span class="var">?lhs_vec</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> inv h3a h3b h3c reduce_system_matrix_subsets_helper reduce_system_matrix_signs_helper
      assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> h1 h2 h3
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> fst_conv get_matrix_def h1_var reduce_system.simps reduction_step.simps<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(* gauss_jordan_single_rank is crucial in this section *)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Showing invertibility preserved when reducing"</span></span>

<span class="comment1">(* Overall:
  Start with a matrix equation.
  Input a matrix, subsets, and signs.
  Drop columns of the matrix based on the 0's on the LHS---so extract a list of 0's. Reduce signs accordingly.
  Then find a list of rows to delete based on using rank (use the transpose result, pivot positions!),
   and delete those rows.  Reduce subsets accordingly.
  End with a reduced system! *)</span>
<span class="keyword1" id="BKR_Proofs-well_def_find_zeros_from_lhs_vec"><span class="command">lemma</span></span> well_def_find_zeros_from_lhs_vec<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">p</span><span class="main">::</span> <span class="quoted"><span class="quoted">"real poly"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">qs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real poly list"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">subsets</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat list list"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">signs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"rat list list"</span></span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> len_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">subsets</span> <span class="main">=</span> length <span class="free">signs</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> inv<span class="main">:</span> <span class="quoted"><span class="quoted">"invertible_mat <span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> nonzero<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> welldefined_signs1<span class="main">:</span> <span class="quoted"><span class="quoted">"well_def_signs <span class="main">(</span>length <span class="free">qs</span><span class="main">)</span> <span class="free">signs</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> distinct_signs<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="free">signs</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> all_info<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>characterize_consistent_signs_at_roots_copr <span class="free">p</span> <span class="free">qs</span><span class="main">)</span> <span class="main">⊆</span> set<span class="main">(</span><span class="free">signs</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> match<span class="main">:</span> <span class="quoted"><span class="quoted">"satisfy_equation <span class="free">p</span> <span class="free">qs</span> <span class="free">subsets</span> <span class="free">signs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">j</span><span class="main">.</span> <span class="bound">j</span> <span class="main">∈</span> set <span class="main">(</span>find_nonzeros_from_input_vec
                    <span class="main">(</span>solve_for_lhs <span class="free">p</span> <span class="free">qs</span> <span class="free">subsets</span> <span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span>
          <span class="bound">j</span> <span class="main">&lt;</span> length <span class="main">(</span>cols <span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">j</span>
  <span class="keyword3"><span class="command">assume</span></span> j_in<span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="skolem">j</span> <span class="main">∈</span> set <span class="main">(</span>find_nonzeros_from_input_vec
                      <span class="main">(</span>solve_for_lhs <span class="free">p</span> <span class="free">qs</span> <span class="free">subsets</span> <span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> "</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?og_mat</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?lhs</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>solve_for_lhs <span class="free">p</span> <span class="free">qs</span> <span class="free">subsets</span> <span class="var">?og_mat</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?new_mat</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>take_rows_from_matrix <span class="main">(</span>reduce_mat_cols <span class="var">?og_mat</span> <span class="var">?lhs</span><span class="main">)</span> <span class="main">(</span>rows_to_keep <span class="main">(</span>reduce_mat_cols <span class="var">?og_mat</span> <span class="var">?lhs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"square_mat <span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> inv
    <span class="keyword1"><span class="command">using</span></span> invertible_mat_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> mat_size<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?og_mat</span> <span class="main">∈</span> carrier_mat <span class="main">(</span>length <span class="free">signs</span><span class="main">)</span> <span class="main">(</span>length <span class="free">signs</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> size_of_mat
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"dim_vec <span class="main">(</span>solve_for_lhs <span class="free">p</span> <span class="free">qs</span> <span class="free">subsets</span> <span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>length <span class="free">signs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> size_of_lhs construct_lhs_matches_solve_for_lhs assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> h<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> <span class="main">(</span>length <span class="free">signs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> j_in <span class="keyword1"><span class="command">unfolding</span></span> find_nonzeros_from_input_vec_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span>  length <span class="main">(</span>cols <span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> mat_size <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="BKR_Proofs-take_cols_subsets_og_cols"><span class="command">lemma</span></span> take_cols_subsets_og_cols<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">p</span><span class="main">::</span> <span class="quoted"><span class="quoted">"real poly"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">qs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real poly list"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">subsets</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat list list"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">signs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"rat list list"</span></span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> len_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">subsets</span> <span class="main">=</span> length <span class="free">signs</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> inv<span class="main">:</span> <span class="quoted"><span class="quoted">"invertible_mat <span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> nonzero<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> welldefined_signs1<span class="main">:</span> <span class="quoted"><span class="quoted">"well_def_signs <span class="main">(</span>length <span class="free">qs</span><span class="main">)</span> <span class="free">signs</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> distinct_signs<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="free">signs</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> all_info<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>characterize_consistent_signs_at_roots_copr <span class="free">p</span> <span class="free">qs</span><span class="main">)</span> <span class="main">⊆</span> set<span class="main">(</span><span class="free">signs</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> match<span class="main">:</span> <span class="quoted"><span class="quoted">"satisfy_equation <span class="free">p</span> <span class="free">qs</span> <span class="free">subsets</span> <span class="free">signs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>take_indices <span class="main">(</span>cols <span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span>
          <span class="main">(</span>find_nonzeros_from_input_vec <span class="main">(</span>solve_for_lhs <span class="free">p</span> <span class="free">qs</span> <span class="free">subsets</span> <span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
    <span class="main">⊆</span> set <span class="main">(</span>cols <span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> well_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">j</span><span class="main">.</span> <span class="bound">j</span> <span class="main">∈</span> set <span class="main">(</span>find_nonzeros_from_input_vec
                    <span class="main">(</span>solve_for_lhs <span class="free">p</span> <span class="free">qs</span> <span class="free">subsets</span> <span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span>
          <span class="bound">j</span> <span class="main">&lt;</span> length <span class="main">(</span>cols <span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms well_def_find_zeros_from_lhs_vec <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> set <span class="main">(</span>take_indices <span class="main">(</span>cols <span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span>
          <span class="main">(</span>find_nonzeros_from_input_vec <span class="main">(</span>solve_for_lhs <span class="free">p</span> <span class="free">qs</span> <span class="free">subsets</span> <span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> 
    <span class="main">⟶</span> <span class="bound">x</span> <span class="main">∈</span>  set <span class="main">(</span>cols <span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">clarsimp</span> 
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?og_list</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>cols <span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?ind_list</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>find_nonzeros_from_input_vec
                     <span class="main">(</span>solve_for_lhs <span class="free">p</span> <span class="free">qs</span> <span class="free">subsets</span> <span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> x_in<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> set <span class="main">(</span>take_indices <span class="var">?og_list</span> <span class="var">?ind_list</span><span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> set <span class="main">(</span>cols <span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> x_in <span class="keyword1"><span class="command">unfolding</span></span> take_indices_def <span class="keyword1"><span class="command">using</span></span> in_set_member <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> in_set_conv_nth well_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="BKR_Proofs-reduction_doesnt_break_things_invertibility_step1"><span class="command">lemma</span></span> reduction_doesnt_break_things_invertibility_step1<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">p</span><span class="main">::</span> <span class="quoted"><span class="quoted">"real poly"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">qs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real poly list"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">subsets</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat list list"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">signs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"rat list list"</span></span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> len_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">subsets</span> <span class="main">=</span> length <span class="free">signs</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> inv<span class="main">:</span> <span class="quoted"><span class="quoted">"invertible_mat <span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> nonzero<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> welldefined_signs1<span class="main">:</span> <span class="quoted"><span class="quoted">"well_def_signs <span class="main">(</span>length <span class="free">qs</span><span class="main">)</span> <span class="free">signs</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> distinct_signs<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="free">signs</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> all_info<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>characterize_consistent_signs_at_roots_copr <span class="free">p</span> <span class="free">qs</span><span class="main">)</span> <span class="main">⊆</span> set<span class="main">(</span><span class="free">signs</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> match<span class="main">:</span> <span class="quoted"><span class="quoted">"satisfy_equation <span class="free">p</span> <span class="free">qs</span> <span class="free">subsets</span> <span class="free">signs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"vec_space.rank <span class="main">(</span>length <span class="free">signs</span><span class="main">)</span> <span class="main">(</span>reduce_mat_cols <span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span> <span class="main">(</span>solve_for_lhs <span class="free">p</span> <span class="free">qs</span> <span class="free">subsets</span> <span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
    <span class="main">(</span>length <span class="main">(</span>find_nonzeros_from_input_vec <span class="main">(</span>solve_for_lhs <span class="free">p</span> <span class="free">qs</span> <span class="free">subsets</span> <span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?og_mat</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?lhs</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>solve_for_lhs <span class="free">p</span> <span class="free">qs</span> <span class="free">subsets</span> <span class="var">?og_mat</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?new_mat</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>take_rows_from_matrix <span class="main">(</span>reduce_mat_cols <span class="var">?og_mat</span> <span class="var">?lhs</span><span class="main">)</span> <span class="main">(</span>rows_to_keep <span class="main">(</span>reduce_mat_cols <span class="var">?og_mat</span> <span class="var">?lhs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"square_mat <span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> inv
    <span class="keyword1"><span class="command">using</span></span> invertible_mat_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> mat_size<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?og_mat</span> <span class="main">∈</span> carrier_mat <span class="main">(</span>length <span class="free">signs</span><span class="main">)</span> <span class="main">(</span>length <span class="free">signs</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> size_of_mat
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> mat_size_alt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?og_mat</span> <span class="main">∈</span> carrier_mat <span class="main">(</span>length <span class="free">subsets</span><span class="main">)</span> <span class="main">(</span>length <span class="free">subsets</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> size_of_mat same_size assms 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
  <span class="keyword1"><span class="command">have</span></span> det_h<span class="main">:</span> <span class="quoted"><span class="quoted">"det <span class="var">?og_mat</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> invertible_det<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> A <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"matrix_A <span class="free">signs</span> <span class="free">subsets</span>"</span></span><span class="main">]</span> mat_size
    <span class="keyword1"><span class="command">using</span></span> inv <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> rank_h<span class="main">:</span> <span class="quoted"><span class="quoted">"vec_space.rank <span class="main">(</span>length <span class="free">signs</span><span class="main">)</span> <span class="var">?og_mat</span> <span class="main">=</span> <span class="main">(</span>length <span class="free">signs</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> vec_space.det_rank_iff  mat_size
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> dist_cols<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>cols <span class="var">?og_mat</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> mat_size vec_space.non_distinct_low_rank<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> A <span class="main"><span class="main">=</span></span> <span class="var"><span class="quoted"><span class="var">?og_mat</span></span></span><span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> n <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"length <span class="free">signs</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> well_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">j</span><span class="main">.</span> <span class="bound">j</span> <span class="main">∈</span> set <span class="main">(</span>find_nonzeros_from_input_vec
                    <span class="main">(</span>solve_for_lhs <span class="free">p</span> <span class="free">qs</span> <span class="free">subsets</span> <span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span>
          <span class="bound">j</span> <span class="main">&lt;</span> length <span class="main">(</span>cols <span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms well_def_find_zeros_from_lhs_vec <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> dist1<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct
     <span class="main">(</span>find_nonzeros_from_input_vec <span class="main">(</span>solve_for_lhs <span class="free">p</span> <span class="free">qs</span> <span class="free">subsets</span> <span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> find_nonzeros_from_input_vec_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> clear<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>take_indices <span class="main">(</span>cols <span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span>
          <span class="main">(</span>find_nonzeros_from_input_vec <span class="main">(</span>solve_for_lhs <span class="free">p</span> <span class="free">qs</span> <span class="free">subsets</span> <span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
    <span class="main">⊆</span> set <span class="main">(</span>cols <span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms take_cols_subsets_og_cols <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>take_indices <span class="main">(</span>cols <span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span>
          <span class="main">(</span>find_nonzeros_from_input_vec <span class="main">(</span>solve_for_lhs <span class="free">p</span> <span class="free">qs</span> <span class="free">subsets</span> <span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> take_indices_def
    <span class="keyword1"><span class="command">using</span></span> dist1 dist_cols well_def conjugatable_vec_space.distinct_map_nth<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> ls <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"cols <span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span>"</span></span><span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> inds <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>find_nonzeros_from_input_vec <span class="main">(</span>solve_for_lhs <span class="free">p</span> <span class="free">qs</span> <span class="free">subsets</span> <span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> unfold_thesis<span class="main">:</span> <span class="quoted"><span class="quoted">"vec_space.rank <span class="main">(</span>length <span class="free">signs</span><span class="main">)</span> <span class="main">(</span>mat_of_cols <span class="main">(</span>dim_row <span class="var">?og_mat</span><span class="main">)</span> <span class="main">(</span>take_indices <span class="main">(</span>cols <span class="var">?og_mat</span><span class="main">)</span> <span class="main">(</span>find_nonzeros_from_input_vec <span class="var">?lhs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
<span class="main">=</span> <span class="main">(</span>length <span class="main">(</span>find_nonzeros_from_input_vec <span class="var">?lhs</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> clear inv conjugatable_vec_space.rank_invertible_subset_cols<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> A<span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"matrix_A <span class="free">signs</span> <span class="free">subsets</span>"</span></span><span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> B <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>take_indices <span class="main">(</span>cols <span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span>
         <span class="main">(</span>find_nonzeros_from_input_vec <span class="main">(</span>solve_for_lhs <span class="free">p</span> <span class="free">qs</span> <span class="free">subsets</span> <span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> len_eq mat_size take_indices_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> take_cols_from_matrix_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="BKR_Proofs-rechar_take_cols"><span class="command">lemma</span></span> rechar_take_cols<span class="main">:</span> <span class="quoted"><span class="quoted">"take_cols_var <span class="free">A</span> <span class="free">B</span> <span class="main">=</span> take_cols_from_matrix <span class="free">A</span> <span class="free">B</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> take_cols_var_def take_cols_from_matrix_def take_indices_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="BKR_Proofs-rows_and_cols_transpose"><span class="command">lemma</span></span> rows_and_cols_transpose<span class="main">:</span> <span class="quoted"><span class="quoted">"rows <span class="free">M</span> <span class="main">=</span> cols <span class="free">M</span><span class="keyword1"><span class="hidden">⇧</span><sup>T</sup></span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> row_transpose  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> 

<span class="keyword1" id="BKR_Proofs-take_rows_and_take_cols"><span class="command">lemma</span></span> take_rows_and_take_cols<span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="main">(</span>take_rows_from_matrix <span class="free">M</span> <span class="free">r</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>take_cols_from_matrix <span class="free">M</span><span class="keyword1"><span class="hidden">⇧</span><sup>T</sup></span> <span class="free">r</span><span class="main">)</span><span class="keyword1"><span class="hidden">⇧</span><sup>T</sup></span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> take_rows_from_matrix_def take_cols_from_matrix_def
  <span class="keyword1"><span class="command">using</span></span> transpose_carrier_mat rows_and_cols_transpose <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> transpose_mat_of_cols<span class="main">)</span> 

<span class="keyword1" id="BKR_Proofs-reduction_doesnt_break_things_invertibility"><span class="command">lemma</span></span> reduction_doesnt_break_things_invertibility<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">p</span><span class="main">::</span> <span class="quoted"><span class="quoted">"real poly"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">qs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real poly list"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">subsets</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat list list"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">signs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"rat list list"</span></span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> len_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">subsets</span> <span class="main">=</span> length <span class="free">signs</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> inv<span class="main">:</span> <span class="quoted"><span class="quoted">"invertible_mat <span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> nonzero<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> welldefined_signs1<span class="main">:</span> <span class="quoted"><span class="quoted">"well_def_signs <span class="main">(</span>length <span class="free">qs</span><span class="main">)</span> <span class="free">signs</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> distinct_signs<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="free">signs</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> all_info<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>characterize_consistent_signs_at_roots_copr <span class="free">p</span> <span class="free">qs</span><span class="main">)</span> <span class="main">⊆</span> set<span class="main">(</span><span class="free">signs</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> match<span class="main">:</span> <span class="quoted"><span class="quoted">"satisfy_equation <span class="free">p</span> <span class="free">qs</span> <span class="free">subsets</span> <span class="free">signs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"invertible_mat <span class="main">(</span>get_matrix <span class="main">(</span>reduce_system <span class="free">p</span> <span class="main">(</span><span class="free">qs</span><span class="main">,</span> <span class="main">(</span><span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free">subsets</span><span class="main">,</span> <span class="free">signs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?og_mat</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?lhs</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>solve_for_lhs <span class="free">p</span> <span class="free">qs</span> <span class="free">subsets</span> <span class="var">?og_mat</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?step1_mat</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>reduce_mat_cols <span class="var">?og_mat</span> <span class="var">?lhs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?new_mat</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"take_rows_from_matrix <span class="var">?step1_mat</span> <span class="main">(</span>rows_to_keep <span class="var">?step1_mat</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?ind_list</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>find_nonzeros_from_input_vec  <span class="var">?lhs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"square_mat <span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> inv
    <span class="keyword1"><span class="command">using</span></span> invertible_mat_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> og_mat_size<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?og_mat</span> <span class="main">∈</span> carrier_mat <span class="main">(</span>length <span class="free">signs</span><span class="main">)</span> <span class="main">(</span>length <span class="free">signs</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> size_of_mat
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"dim_col <span class="main">(</span>mat_of_cols <span class="main">(</span>dim_row <span class="var">?og_mat</span><span class="main">)</span> <span class="main">(</span>take_indices <span class="main">(</span>cols <span class="var">?og_mat</span><span class="main">)</span> <span class="var">?ind_list</span><span class="main">)</span><span class="main">)</span>
      <span class="main">=</span> <span class="main">(</span>length <span class="main">(</span>find_nonzeros_from_input_vec <span class="var">?lhs</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> take_indices_def<span class="main">)</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mat_of_cols <span class="main">(</span>dim_row <span class="var">?og_mat</span><span class="main">)</span> <span class="main">(</span>take_indices <span class="main">(</span>cols <span class="var">?og_mat</span><span class="main">)</span> <span class="var">?ind_list</span><span class="main">)</span>
      <span class="main">∈</span> carrier_mat <span class="main">(</span>length <span class="free">signs</span><span class="main">)</span> <span class="main">(</span>length <span class="main">(</span>find_nonzeros_from_input_vec <span class="var">?lhs</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> len_eq mat_of_cols_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> step1_mat_size<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?step1_mat</span> <span class="main">∈</span> carrier_mat <span class="main">(</span>length <span class="free">signs</span><span class="main">)</span> <span class="main">(</span>length <span class="main">(</span>find_nonzeros_from_input_vec <span class="var">?lhs</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> take_cols_from_matrix_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"dim_row <span class="var">?step1_mat</span> <span class="main">≥</span> dim_col <span class="var">?step1_mat</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> carrier_matD<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> carrier_matD<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> construct_lhs_matches_solve_for_lhs diff_zero find_nonzeros_from_input_vec_def inv length_filter_le length_upt match size_of_lhs<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> gt_eq_assm<span class="main">:</span> <span class="quoted"><span class="quoted">"dim_col <span class="var">?step1_mat</span><span class="keyword1"><span class="hidden">⇧</span><sup>T</sup></span>  <span class="main">≥</span> dim_row  <span class="var">?step1_mat</span><span class="keyword1"><span class="hidden">⇧</span><sup>T</sup></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> 
  <span class="keyword1"><span class="command">have</span></span> det_h<span class="main">:</span> <span class="quoted"><span class="quoted">"det <span class="var">?og_mat</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> invertible_det<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> A <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"matrix_A <span class="free">signs</span> <span class="free">subsets</span>"</span></span><span class="main">]</span> og_mat_size
    <span class="keyword1"><span class="command">using</span></span> inv <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> rank_h<span class="main">:</span> <span class="quoted"><span class="quoted">"vec_space.rank <span class="main">(</span>length <span class="free">signs</span><span class="main">)</span> <span class="var">?og_mat</span> <span class="main">=</span> <span class="main">(</span>length <span class="free">signs</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> vec_space.det_rank_iff  og_mat_size
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> rank_drop_cols<span class="main">:</span> <span class="quoted"><span class="quoted">"vec_space.rank <span class="main">(</span>length <span class="free">signs</span><span class="main">)</span> <span class="var">?step1_mat</span> <span class="main">=</span> <span class="main">(</span>dim_col <span class="var">?step1_mat</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms reduction_doesnt_break_things_invertibility_step1 step1_mat_size 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?step1_T</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="var">?step1_mat</span><span class="keyword1"><span class="hidden">⇧</span><sup>T</sup></span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> rank_transpose<span class="main">:</span> <span class="quoted"><span class="quoted">"vec_space.rank <span class="main">(</span>length <span class="free">signs</span><span class="main">)</span> <span class="var">?step1_mat</span> <span class="main">=</span> vec_space.rank <span class="main">(</span>length <span class="main">(</span>find_nonzeros_from_input_vec <span class="var">?lhs</span><span class="main">)</span><span class="main">)</span> <span class="var">?step1_T</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> transpose_rank<span class="main">[</span><span class="operator">of</span> <span class="var"><span class="quoted"><span class="var">?step1_mat</span></span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">using</span></span> step1_mat_size <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>  
  <span class="keyword1"><span class="command">have</span></span> obv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?step1_T</span> <span class="main">∈</span> carrier_mat <span class="main">(</span>dim_row <span class="var">?step1_T</span><span class="main">)</span> <span class="main">(</span>dim_col <span class="var">?step1_T</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> should_have_this<span class="main">:</span><span class="quoted"><span class="quoted">"vec_space.rank <span class="main">(</span>length <span class="main">(</span>find_nonzeros_from_input_vec <span class="var">?lhs</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>take_cols <span class="var">?step1_T</span> <span class="main">(</span>map snd <span class="main">(</span>pivot_positions <span class="main">(</span>gauss_jordan_single <span class="main">(</span><span class="var">?step1_T</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> vec_space.rank <span class="main">(</span>length <span class="main">(</span>find_nonzeros_from_input_vec <span class="var">?lhs</span><span class="main">)</span><span class="main">)</span> <span class="var">?step1_T</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> obv gt_eq_assm conjugatable_vec_space.gauss_jordan_single_rank<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> A <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="var">?step1_T</span>"</span></span><span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> n <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"dim_row <span class="var">?step1_T</span>"</span></span><span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> nc <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"dim_col <span class="var">?step1_T</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> take_cols_from_matrix_def take_indices_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"vec_space.rank <span class="main">(</span>length <span class="main">(</span>find_nonzeros_from_input_vec <span class="var">?lhs</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>take_cols <span class="var">?step1_T</span> <span class="main">(</span>map snd <span class="main">(</span>pivot_positions <span class="main">(</span>gauss_jordan_single <span class="main">(</span><span class="var">?step1_T</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> dim_col <span class="var">?step1_mat</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> rank_drop_cols rank_transpose <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> with_take_cols_from_matrix<span class="main">:</span> <span class="quoted"><span class="quoted">"vec_space.rank <span class="main">(</span>length <span class="main">(</span>find_nonzeros_from_input_vec <span class="var">?lhs</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>take_cols_from_matrix <span class="var">?step1_T</span> <span class="main">(</span>map snd <span class="main">(</span>pivot_positions <span class="main">(</span>gauss_jordan_single <span class="main">(</span><span class="var">?step1_T</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> dim_col <span class="var">?step1_mat</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> rank_transpose rechar_take_cols conjugatable_vec_space.gjs_and_take_cols_var
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> conjugatable_vec_space.gjs_and_take_cols_var gt_eq_assm obv rechar_take_cols reduce_mat_cols.simps<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>take_rows_from_matrix <span class="var">?step1_mat</span> <span class="main">(</span>rows_to_keep <span class="var">?step1_mat</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>take_cols_from_matrix <span class="var">?step1_T</span>  <span class="main">(</span>rows_to_keep <span class="var">?step1_mat</span><span class="main">)</span><span class="main">)</span><span class="keyword1"><span class="hidden">⇧</span><sup>T</sup></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> take_rows_and_take_cols
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> rank_new_mat<span class="main">:</span> <span class="quoted"><span class="quoted">"vec_space.rank <span class="main">(</span>dim_row <span class="var">?new_mat</span><span class="main">)</span> <span class="var">?new_mat</span> <span class="main">=</span> dim_col <span class="var">?step1_mat</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> with_take_cols_from_matrix transpose_rank <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">assume</span></span> a1<span class="main">:</span> <span class="quoted"><span class="quoted">"vec_space.rank <span class="main">(</span>length <span class="main">(</span>find_nonzeros_from_input_vec <span class="main">(</span>solve_for_lhs <span class="free">p</span> <span class="free">qs</span> <span class="free">subsets</span> <span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>take_cols_from_matrix <span class="main">(</span>take_cols_from_matrix <span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span> <span class="main">(</span>find_nonzeros_from_input_vec <span class="main">(</span>solve_for_lhs <span class="free">p</span> <span class="free">qs</span> <span class="free">subsets</span> <span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="keyword1"><span class="hidden">⇧</span><sup>T</sup></span> <span class="main">(</span>map snd <span class="main">(</span>pivot_positions <span class="main">(</span>gauss_jordan_single <span class="main">(</span>take_cols_from_matrix <span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span> <span class="main">(</span>find_nonzeros_from_input_vec <span class="main">(</span>solve_for_lhs <span class="free">p</span> <span class="free">qs</span> <span class="free">subsets</span> <span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="keyword1"><span class="hidden">⇧</span><sup>T</sup></span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> dim_col <span class="main">(</span>take_cols_from_matrix <span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span> <span class="main">(</span>find_nonzeros_from_input_vec <span class="main">(</span>solve_for_lhs <span class="free">p</span> <span class="free">qs</span> <span class="free">subsets</span> <span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> f2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">m</span><span class="main">.</span> vec_space.rank <span class="main">(</span>dim_row <span class="main">(</span><span class="bound">m</span><span class="main">::</span>rat mat<span class="main">)</span><span class="main">)</span> <span class="bound">m</span> <span class="main">=</span> vec_space.rank <span class="main">(</span>dim_row <span class="bound">m</span><span class="keyword1"><span class="hidden">⇧</span><sup>T</sup></span><span class="main">)</span> <span class="bound">m</span><span class="keyword1"><span class="hidden">⇧</span><sup>T</sup></span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> transpose_rank<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> f3<span class="main">:</span> <span class="quoted"><span class="quoted">"dim_row <span class="main">(</span>mat_of_cols <span class="main">(</span>dim_row <span class="main">(</span>mat_of_cols <span class="main">(</span>dim_row <span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>take_indices <span class="main">(</span>cols <span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>find_nonzeros_from_input_vec <span class="main">(</span>solve_for_lhs <span class="free">p</span> <span class="free">qs</span> <span class="free">subsets</span> <span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="keyword1"><span class="hidden">⇧</span><sup>T</sup></span><span class="main">)</span> <span class="main">(</span>take_indices <span class="main">(</span>cols <span class="main">(</span>mat_of_cols <span class="main">(</span>dim_row <span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>take_indices <span class="main">(</span>cols <span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>find_nonzeros_from_input_vec <span class="main">(</span>solve_for_lhs <span class="free">p</span> <span class="free">qs</span> <span class="free">subsets</span> <span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="keyword1"><span class="hidden">⇧</span><sup>T</sup></span><span class="main">)</span> <span class="main">(</span>map snd <span class="main">(</span>pivot_positions <span class="main">(</span>gauss_jordan_single <span class="main">(</span>mat_of_cols <span class="main">(</span>dim_row <span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>take_indices <span class="main">(</span>cols <span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>find_nonzeros_from_input_vec <span class="main">(</span>solve_for_lhs <span class="free">p</span> <span class="free">qs</span> <span class="free">subsets</span> <span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="keyword1"><span class="hidden">⇧</span><sup>T</sup></span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> length <span class="main">(</span>find_nonzeros_from_input_vec <span class="main">(</span>solve_for_lhs <span class="free">p</span> <span class="free">qs</span> <span class="free">subsets</span> <span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹dim_col <span class="main">(</span>mat_of_cols <span class="main">(</span>dim_row <span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>take_indices <span class="main">(</span>cols <span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>find_nonzeros_from_input_vec <span class="main">(</span>solve_for_lhs <span class="free">p</span> <span class="free">qs</span> <span class="free">subsets</span> <span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> length <span class="main">(</span>find_nonzeros_from_input_vec <span class="main">(</span>solve_for_lhs <span class="free">p</span> <span class="free">qs</span> <span class="free">subsets</span> <span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"vec_space.rank <span class="main">(</span>length <span class="main">(</span>find_nonzeros_from_input_vec <span class="main">(</span>solve_for_lhs <span class="free">p</span> <span class="free">qs</span> <span class="free">subsets</span> <span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>mat_of_cols <span class="main">(</span>dim_row <span class="main">(</span>mat_of_cols <span class="main">(</span>dim_row <span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>take_indices <span class="main">(</span>cols <span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>find_nonzeros_from_input_vec <span class="main">(</span>solve_for_lhs <span class="free">p</span> <span class="free">qs</span> <span class="free">subsets</span> <span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="keyword1"><span class="hidden">⇧</span><sup>T</sup></span><span class="main">)</span> <span class="main">(</span>take_indices <span class="main">(</span>cols <span class="main">(</span>mat_of_cols <span class="main">(</span>dim_row <span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>take_indices <span class="main">(</span>cols <span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>find_nonzeros_from_input_vec <span class="main">(</span>solve_for_lhs <span class="free">p</span> <span class="free">qs</span> <span class="free">subsets</span> <span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="keyword1"><span class="hidden">⇧</span><sup>T</sup></span><span class="main">)</span> <span class="main">(</span>map snd <span class="main">(</span>pivot_positions <span class="main">(</span>gauss_jordan_single <span class="main">(</span>mat_of_cols <span class="main">(</span>dim_row <span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>take_indices <span class="main">(</span>cols <span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>find_nonzeros_from_input_vec <span class="main">(</span>solve_for_lhs <span class="free">p</span> <span class="free">qs</span> <span class="free">subsets</span> <span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="keyword1"><span class="hidden">⇧</span><sup>T</sup></span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> dim_row <span class="main">(</span>mat_of_cols <span class="main">(</span>dim_row <span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>take_indices <span class="main">(</span>cols <span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>find_nonzeros_from_input_vec <span class="main">(</span>solve_for_lhs <span class="free">p</span> <span class="free">qs</span> <span class="free">subsets</span> <span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="keyword1"><span class="hidden">⇧</span><sup>T</sup></span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> a1 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> take_cols_from_matrix_def<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"vec_space.rank <span class="main">(</span>dim_row <span class="main">(</span>mat_of_cols <span class="main">(</span>dim_row <span class="main">(</span>mat_of_cols <span class="main">(</span>dim_row <span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>take_indices <span class="main">(</span>cols <span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>find_nonzeros_from_input_vec <span class="main">(</span>solve_for_lhs <span class="free">p</span> <span class="free">qs</span> <span class="free">subsets</span> <span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="keyword1"><span class="hidden">⇧</span><sup>T</sup></span><span class="main">)</span> <span class="main">(</span>take_indices <span class="main">(</span>cols <span class="main">(</span>mat_of_cols <span class="main">(</span>dim_row <span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>take_indices <span class="main">(</span>cols <span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>find_nonzeros_from_input_vec <span class="main">(</span>solve_for_lhs <span class="free">p</span> <span class="free">qs</span> <span class="free">subsets</span> <span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="keyword1"><span class="hidden">⇧</span><sup>T</sup></span><span class="main">)</span> <span class="main">(</span>map snd <span class="main">(</span>pivot_positions <span class="main">(</span>gauss_jordan_single <span class="main">(</span>mat_of_cols <span class="main">(</span>dim_row <span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>take_indices <span class="main">(</span>cols <span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>find_nonzeros_from_input_vec <span class="main">(</span>solve_for_lhs <span class="free">p</span> <span class="free">qs</span> <span class="free">subsets</span> <span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="keyword1"><span class="hidden">⇧</span><sup>T</sup></span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="keyword1"><span class="hidden">⇧</span><sup>T</sup></span><span class="main">)</span> <span class="main">(</span>mat_of_cols <span class="main">(</span>dim_row <span class="main">(</span>mat_of_cols <span class="main">(</span>dim_row <span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>take_indices <span class="main">(</span>cols <span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>find_nonzeros_from_input_vec <span class="main">(</span>solve_for_lhs <span class="free">p</span> <span class="free">qs</span> <span class="free">subsets</span> <span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="keyword1"><span class="hidden">⇧</span><sup>T</sup></span><span class="main">)</span> <span class="main">(</span>take_indices <span class="main">(</span>cols <span class="main">(</span>mat_of_cols <span class="main">(</span>dim_row <span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>take_indices <span class="main">(</span>cols <span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>find_nonzeros_from_input_vec <span class="main">(</span>solve_for_lhs <span class="free">p</span> <span class="free">qs</span> <span class="free">subsets</span> <span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="keyword1"><span class="hidden">⇧</span><sup>T</sup></span><span class="main">)</span> <span class="main">(</span>map snd <span class="main">(</span>pivot_positions <span class="main">(</span>gauss_jordan_single <span class="main">(</span>mat_of_cols <span class="main">(</span>dim_row <span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>take_indices <span class="main">(</span>cols <span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>find_nonzeros_from_input_vec <span class="main">(</span>solve_for_lhs <span class="free">p</span> <span class="free">qs</span> <span class="free">subsets</span> <span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="keyword1"><span class="hidden">⇧</span><sup>T</sup></span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="keyword1"><span class="hidden">⇧</span><sup>T</sup></span> <span class="main">=</span> dim_row <span class="main">(</span>mat_of_cols <span class="main">(</span>dim_row <span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>take_indices <span class="main">(</span>cols <span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>find_nonzeros_from_input_vec <span class="main">(</span>solve_for_lhs <span class="free">p</span> <span class="free">qs</span> <span class="free">subsets</span> <span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="keyword1"><span class="hidden">⇧</span><sup>T</sup></span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> f3 f2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"vec_space.rank <span class="main">(</span>dim_col <span class="main">(</span>take_cols_from_matrix <span class="main">(</span>take_cols_from_matrix <span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span> <span class="main">(</span>find_nonzeros_from_input_vec <span class="main">(</span>solve_for_lhs <span class="free">p</span> <span class="free">qs</span> <span class="free">subsets</span> <span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="keyword1"><span class="hidden">⇧</span><sup>T</sup></span> <span class="main">(</span>rows_to_keep <span class="main">(</span>take_cols_from_matrix <span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span> <span class="main">(</span>find_nonzeros_from_input_vec <span class="main">(</span>solve_for_lhs <span class="free">p</span> <span class="free">qs</span> <span class="free">subsets</span> <span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>take_cols_from_matrix <span class="main">(</span>take_cols_from_matrix <span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span> <span class="main">(</span>find_nonzeros_from_input_vec <span class="main">(</span>solve_for_lhs <span class="free">p</span> <span class="free">qs</span> <span class="free">subsets</span> <span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="keyword1"><span class="hidden">⇧</span><sup>T</sup></span> <span class="main">(</span>rows_to_keep <span class="main">(</span>take_cols_from_matrix <span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span> <span class="main">(</span>find_nonzeros_from_input_vec <span class="main">(</span>solve_for_lhs <span class="free">p</span> <span class="free">qs</span> <span class="free">subsets</span> <span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="keyword1"><span class="hidden">⇧</span><sup>T</sup></span> <span class="main">=</span> dim_col <span class="main">(</span>take_cols_from_matrix <span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span> <span class="main">(</span>find_nonzeros_from_input_vec <span class="main">(</span>solve_for_lhs <span class="free">p</span> <span class="free">qs</span> <span class="free">subsets</span> <span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rows_to_keep_def take_cols_from_matrix_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>pivot_positions <span class="main">(</span>gauss_jordan_single <span class="main">(</span><span class="var">?step1_mat</span><span class="keyword1"><span class="hidden">⇧</span><sup>T</sup></span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> <span class="main">(</span>length <span class="main">(</span>find_nonzeros_from_input_vec <span class="var">?lhs</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> obv length_pivot_positions_dim_row<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> A <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>gauss_jordan_single <span class="main">(</span><span class="var">?step1_mat</span><span class="keyword1"><span class="hidden">⇧</span><sup>T</sup></span><span class="main">)</span><span class="main">)</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> carrier_matD<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> carrier_matD<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> gauss_jordan_single<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> gauss_jordan_single<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> index_transpose_mat<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> step1_mat_size<span class="main">)</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> len_lt_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>pivot_positions <span class="main">(</span>gauss_jordan_single <span class="main">(</span><span class="var">?step1_mat</span><span class="keyword1"><span class="hidden">⇧</span><sup>T</sup></span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> dim_col <span class="var">?step1_mat</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> step1_mat_size
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> 
  <span class="keyword1"><span class="command">have</span></span> len_gt_false<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>rows_to_keep <span class="var">?step1_mat</span><span class="main">)</span> <span class="main">&lt;</span> <span class="main">(</span>dim_col <span class="var">?step1_mat</span><span class="main">)</span> <span class="main">⟹</span> False"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
    <span class="keyword3"><span class="command">assume</span></span> length_lt<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>rows_to_keep <span class="var">?step1_mat</span><span class="main">)</span> <span class="main">&lt;</span> <span class="main">(</span>dim_col <span class="var">?step1_mat</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> h<span class="main">:</span> <span class="quoted"><span class="quoted">"dim_row <span class="var">?new_mat</span> <span class="main">&lt;</span> <span class="main">(</span>dim_col <span class="var">?step1_mat</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Matrix.transpose_transpose index_transpose_mat<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> length_lt length_map mat_of_cols_carrier<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> take_cols_from_matrix_def take_indices_def take_rows_and_take_cols<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"False"</span></span> <span class="keyword1"><span class="command">using</span></span> rank_new_mat
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Matrix.transpose_transpose carrier_matI index_transpose_mat<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> nat_less_le not_less_iff_gr_or_eq transpose_rank vec_space.rank_le_nc<span class="main">)</span>    
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> len_gt_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>rows_to_keep <span class="var">?step1_mat</span><span class="main">)</span> <span class="main">≥</span> <span class="main">(</span>dim_col <span class="var">?step1_mat</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> not_less <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> len_match<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>rows_to_keep <span class="var">?step1_mat</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>dim_col <span class="var">?step1_mat</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> len_lt_eq len_gt_eq
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rows_to_keep_def<span class="main">)</span> 
  <span class="keyword1"><span class="command">have</span></span> mat_match<span class="main">:</span> <span class="quoted"><span class="quoted">"matrix_A <span class="main">(</span>get_signs <span class="main">(</span>reduce_system <span class="free">p</span> <span class="main">(</span><span class="free">qs</span><span class="main">,</span> <span class="main">(</span><span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free">subsets</span><span class="main">,</span> <span class="free">signs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
  <span class="main">(</span>get_subsets <span class="main">(</span>reduce_system <span class="free">p</span> <span class="main">(</span><span class="free">qs</span><span class="main">,</span> <span class="main">(</span><span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free">subsets</span><span class="main">,</span> <span class="free">signs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
  <span class="main">(</span>get_matrix <span class="main">(</span>reduce_system <span class="free">p</span> <span class="main">(</span><span class="free">qs</span><span class="main">,</span> <span class="main">(</span><span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free">subsets</span><span class="main">,</span> <span class="free">signs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> reduce_system_matrix_match<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">p</span></span> <span class="quoted"><span class="free">qs</span></span> <span class="quoted"><span class="free">signs</span></span> <span class="quoted"><span class="free">subsets</span></span><span class="main">]</span>  assms
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
  <span class="keyword1"><span class="command">have</span></span> f2<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>get_subsets <span class="main">(</span>take_rows_from_matrix <span class="main">(</span>mat_of_cols <span class="main">(</span>dim_row <span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>map <span class="main">(</span><span class="main">(!)</span> <span class="main">(</span>cols <span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>find_nonzeros_from_input_vec <span class="main">(</span>solve_for_lhs <span class="free">p</span> <span class="free">qs</span> <span class="free">subsets</span> <span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>rows_to_keep <span class="main">(</span>mat_of_cols <span class="main">(</span>dim_row <span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>map <span class="main">(</span><span class="main">(!)</span> <span class="main">(</span>cols <span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>find_nonzeros_from_input_vec <span class="main">(</span>solve_for_lhs <span class="free">p</span> <span class="free">qs</span> <span class="free">subsets</span> <span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> map <span class="main">(</span><span class="main">(!)</span> <span class="free">subsets</span><span class="main">)</span> <span class="main">(</span>rows_to_keep <span class="main">(</span>mat_of_cols <span class="main">(</span>dim_row <span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>map <span class="main">(</span><span class="main">(!)</span> <span class="main">(</span>cols <span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>find_nonzeros_from_input_vec <span class="main">(</span>solve_for_lhs <span class="free">p</span> <span class="free">qs</span> <span class="free">subsets</span> <span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> map <span class="main">(</span><span class="main">(!)</span> <span class="free">signs</span><span class="main">)</span> <span class="main">(</span>find_nonzeros_from_input_vec <span class="main">(</span>solve_for_lhs <span class="free">p</span> <span class="free">qs</span> <span class="free">subsets</span> <span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> length <span class="main">(</span>find_nonzeros_from_input_vec <span class="main">(</span>solve_for_lhs <span class="free">p</span> <span class="free">qs</span> <span class="free">subsets</span> <span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> <span class="quoted"><span class="quoted">‹dim_col <span class="main">(</span>mat_of_cols <span class="main">(</span>dim_row <span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>take_indices <span class="main">(</span>cols <span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>find_nonzeros_from_input_vec <span class="main">(</span>solve_for_lhs <span class="free">p</span> <span class="free">qs</span> <span class="free">subsets</span> <span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> length <span class="main">(</span>find_nonzeros_from_input_vec <span class="main">(</span>solve_for_lhs <span class="free">p</span> <span class="free">qs</span> <span class="free">subsets</span> <span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹length <span class="main">(</span>rows_to_keep <span class="main">(</span>reduce_mat_cols <span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span> <span class="main">(</span>solve_for_lhs <span class="free">p</span> <span class="free">qs</span> <span class="free">subsets</span> <span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> dim_col <span class="main">(</span>reduce_mat_cols <span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span> <span class="main">(</span>solve_for_lhs <span class="free">p</span> <span class="free">qs</span> <span class="free">subsets</span> <span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>›</span></span> length_map reduce_mat_cols.simps reduce_system.simps reduction_step.simps reduction_subsets_def reduction_subsets_is_get_subsets take_cols_from_matrix_def take_indices_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> f3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span> <span class="bound">ps</span> <span class="bound">rss</span> <span class="bound">nss</span> <span class="bound">m</span><span class="main">.</span> map <span class="main">(</span><span class="main">(!)</span> <span class="bound">rss</span><span class="main">)</span> <span class="main">(</span>find_nonzeros_from_input_vec <span class="main">(</span>solve_for_lhs <span class="bound">p</span> <span class="bound">ps</span> <span class="bound">nss</span> <span class="bound">m</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> get_signs <span class="main">(</span>reduce_system <span class="bound">p</span> <span class="main">(</span><span class="bound">ps</span><span class="main">,</span> <span class="bound">m</span><span class="main">,</span> <span class="bound">nss</span><span class="main">,</span> <span class="bound">rss</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> reduction_signs_def reduction_signs_is_get_signs take_indices_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> square_final_mat<span class="main">:</span> <span class="quoted"><span class="quoted">"square_mat <span class="main">(</span>get_matrix <span class="main">(</span>reduce_system <span class="free">p</span> <span class="main">(</span><span class="free">qs</span><span class="main">,</span> <span class="main">(</span><span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free">subsets</span><span class="main">,</span> <span class="free">signs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> mat_match assms size_of_mat same_size   
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> f2 f3
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> Matrix.transpose_transpose fst_conv get_matrix_def index_transpose_mat<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> len_match length_map mat_of_cols_carrier<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> mat_of_cols_carrier<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> reduce_mat_cols.simps take_cols_from_matrix_def take_indices_def take_rows_and_take_cols<span class="main">)</span> 
  <span class="keyword1"><span class="command">have</span></span> rank_match<span class="main">:</span> <span class="quoted"><span class="quoted">"vec_space.rank <span class="main">(</span>dim_row <span class="var">?new_mat</span><span class="main">)</span> <span class="var">?new_mat</span> <span class="main">=</span> dim_row <span class="var">?new_mat</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> len_match rank_new_mat
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> take_cols_from_matrix_def take_indices_def take_rows_and_take_cols<span class="main">)</span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"invertible_mat <span class="var">?new_mat</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> invertible_det og_mat_size
    <span class="keyword1"><span class="command">using</span></span> vec_space.det_rank_iff square_final_mat
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> dim_col_matrix_A dim_row_matrix_A fst_conv get_matrix_def mat_match rank_match reduce_system.simps reduction_step.simps size_of_mat square_mat.elims<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> fst_conv get_matrix_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Well def signs preserved when reducing"</span></span>

<span class="keyword1" id="BKR_Proofs-reduction_doesnt_break_length_signs"><span class="command">lemma</span></span> reduction_doesnt_break_length_signs<span class="main">:</span>  
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">p</span><span class="main">::</span> <span class="quoted"><span class="quoted">"real poly"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">qs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real poly list"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">subsets</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat list list"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">signs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"rat list list"</span></span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> length_init <span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">x</span><span class="main">∈</span> set<span class="main">(</span><span class="free">signs</span><span class="main">)</span><span class="main">.</span> length <span class="bound">x</span> <span class="main">=</span> length <span class="free">qs</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> sat_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"satisfy_equation <span class="free">p</span> <span class="free">qs</span> <span class="free">subsets</span> <span class="free">signs</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> inv_mat<span class="main">:</span> <span class="quoted"><span class="quoted">"invertible_mat <span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> set<span class="main">(</span>reduction_signs <span class="free">p</span> <span class="free">qs</span> <span class="free">signs</span> <span class="free">subsets</span> <span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> 
    length <span class="bound">x</span> <span class="main">=</span> length <span class="free">qs</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">clarsimp</span> 
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
  <span class="keyword3"><span class="command">assume</span></span> x_in_set<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> set <span class="main">(</span>reduction_signs <span class="free">p</span> <span class="free">qs</span> <span class="free">signs</span> <span class="free">subsets</span> <span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"List.member <span class="main">(</span>reduction_signs <span class="free">p</span> <span class="free">qs</span> <span class="free">signs</span> <span class="free">subsets</span> <span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span> <span class="skolem">x</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> x_in_set <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> in_set_member<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> take_ind<span class="main">:</span> <span class="quoted"><span class="quoted">"List.member <span class="main">(</span>take_indices <span class="free">signs</span>
     <span class="main">(</span>find_nonzeros_from_input_vec <span class="main">(</span>solve_for_lhs <span class="free">p</span> <span class="free">qs</span> <span class="free">subsets</span> <span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">x</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> reduction_signs_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> find_nz_len<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">y</span><span class="main">.</span> List.member <span class="main">(</span>find_nonzeros_from_input_vec <span class="main">(</span>solve_for_lhs <span class="free">p</span> <span class="free">qs</span> <span class="free">subsets</span> <span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="bound">y</span> <span class="main">⟶</span>  <span class="bound">y</span> <span class="main">&lt;</span> length <span class="free">signs</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> size_of_lhs sat_eq inv_mat construct_lhs_matches_solve_for_lhs<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">p</span></span> <span class="quoted"><span class="free">qs</span></span> <span class="quoted"><span class="free">subsets</span></span> <span class="quoted"><span class="free">signs</span></span><span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> find_nonzeros_from_input_vec_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> atLeastLessThan_iff filter_is_subset in_set_member set_upt subset_code<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound"><span class="bound">n</span></span> <span class="main">&lt;</span> length <span class="free">signs</span><span class="main">.</span> <span class="skolem">x</span> <span class="main">=</span> <span class="free">signs</span> <span class="main">!</span> <span class="bound">n</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> take_ind
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> in_set_conv_nth reduction_signs_def take_indices_lem x_in_set<span class="main">)</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">x</span> <span class="main">=</span> length <span class="free">qs</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> length_init take_indices_lem
    <span class="keyword1"><span class="command">using</span></span> nth_mem <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Distinct signs preserved when reducing"</span></span>

<span class="keyword1" id="BKR_Proofs-reduction_signs_are_distinct"><span class="command">lemma</span></span> reduction_signs_are_distinct<span class="main">:</span>  
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">p</span><span class="main">::</span> <span class="quoted"><span class="quoted">"real poly"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">qs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real poly list"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">subsets</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat list list"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">signs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"rat list list"</span></span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> sat_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"satisfy_equation <span class="free">p</span> <span class="free">qs</span> <span class="free">subsets</span> <span class="free">signs</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> inv_mat<span class="main">:</span> <span class="quoted"><span class="quoted">"invertible_mat <span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> distinct_init<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="free">signs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>reduction_signs <span class="free">p</span> <span class="free">qs</span> <span class="free">signs</span> <span class="free">subsets</span> <span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> solve_construct<span class="main">:</span> <span class="quoted"><span class="quoted">"construct_lhs_vector <span class="free">p</span> <span class="free">qs</span> <span class="free">signs</span> <span class="main">=</span>
  solve_for_lhs <span class="free">p</span> <span class="free">qs</span> <span class="free">subsets</span> <span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> construct_lhs_matches_solve_for_lhs assms
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> h1<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>find_nonzeros_from_input_vec <span class="main">(</span>solve_for_lhs <span class="free">p</span> <span class="free">qs</span> <span class="free">subsets</span> <span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> find_nonzeros_from_input_vec_def 
    <span class="keyword1"><span class="command">using</span></span> distinct_filter
    <span class="keyword1"><span class="command">using</span></span> distinct_upt <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
  <span class="keyword1"><span class="command">have</span></span> h2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">j</span><span class="main">.</span> <span class="bound">j</span> <span class="main">∈</span> set <span class="main">(</span>find_nonzeros_from_input_vec <span class="main">(</span>solve_for_lhs <span class="free">p</span> <span class="free">qs</span> <span class="free">subsets</span> <span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span>
          <span class="bound">j</span> <span class="main">&lt;</span> length <span class="free">signs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">j</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">∈</span> set <span class="main">(</span>find_nonzeros_from_input_vec <span class="main">(</span>solve_for_lhs <span class="free">p</span> <span class="free">qs</span> <span class="free">subsets</span> <span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> length <span class="free">signs</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> solve_construct size_of_lhs
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹<span class="skolem">j</span> <span class="main">∈</span> set <span class="main">(</span>find_nonzeros_from_input_vec <span class="main">(</span>solve_for_lhs <span class="free">p</span> <span class="free">qs</span> <span class="free">subsets</span> <span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>›</span></span> atLeastLessThan_iff filter_is_subset find_nonzeros_from_input_vec_def set_upt subset_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> reduction_signs_def <span class="keyword1"><span class="command">unfolding</span></span> take_indices_def
    <span class="keyword1"><span class="command">using</span></span> distinct_init h1 h2 conjugatable_vec_space.distinct_map_nth<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> ls <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="free">signs</span>"</span></span><span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> inds <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>find_nonzeros_from_input_vec <span class="main">(</span>solve_for_lhs <span class="free">p</span> <span class="free">qs</span> <span class="free">subsets</span> <span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Well def subsets preserved when reducing"</span></span>

<span class="keyword1" id="BKR_Proofs-reduction_doesnt_break_subsets"><span class="command">lemma</span></span> reduction_doesnt_break_subsets<span class="main">:</span>  
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">p</span><span class="main">::</span> <span class="quoted"><span class="quoted">"real poly"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">qs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real poly list"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">subsets</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat list list"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">signs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"rat list list"</span></span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> nonzero<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> length_init <span class="main">:</span> <span class="quoted"><span class="quoted">"all_list_constr <span class="free">subsets</span> <span class="main">(</span>length <span class="free">qs</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> sat_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"satisfy_equation <span class="free">p</span> <span class="free">qs</span> <span class="free">subsets</span> <span class="free">signs</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> inv_mat<span class="main">:</span> <span class="quoted"><span class="quoted">"invertible_mat <span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"all_list_constr <span class="main">(</span>reduction_subsets <span class="free">p</span> <span class="free">qs</span> <span class="free">signs</span> <span class="free">subsets</span> <span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>length <span class="free">qs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> all_list_constr_def 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">clarsimp</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
  <span class="keyword3"><span class="command">assume</span></span> in_red_subsets<span class="main">:</span> <span class="quoted"><span class="quoted">"List.member <span class="main">(</span>reduction_subsets <span class="free">p</span> <span class="free">qs</span> <span class="free">signs</span> <span class="free">subsets</span> <span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span> <span class="skolem">x</span> "</span></span>
  <span class="keyword1"><span class="command">have</span></span> solve_construct<span class="main">:</span> <span class="quoted"><span class="quoted">"construct_lhs_vector <span class="free">p</span> <span class="free">qs</span> <span class="free">signs</span> <span class="main">=</span>
  solve_for_lhs <span class="free">p</span> <span class="free">qs</span> <span class="free">subsets</span> <span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> construct_lhs_matches_solve_for_lhs assms
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> rows_to_keep_hyp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> set <span class="main">(</span>rows_to_keep <span class="main">(</span>reduce_mat_cols <span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span> <span class="main">(</span>solve_for_lhs <span class="free">p</span> <span class="free">qs</span> <span class="free">subsets</span> <span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span> 
      <span class="bound">y</span> <span class="main">&lt;</span> length <span class="free">subsets</span>"</span></span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">clarsimp</span> 
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">y</span>
    <span class="keyword3"><span class="command">assume</span></span> in_set<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> set <span class="main">(</span>rows_to_keep
                   <span class="main">(</span>take_cols_from_matrix <span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span> <span class="main">(</span>find_nonzeros_from_input_vec <span class="main">(</span>solve_for_lhs <span class="free">p</span> <span class="free">qs</span> <span class="free">subsets</span> <span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> in_set_2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> set <span class="main">(</span>rows_to_keep
                   <span class="main">(</span>take_cols_from_matrix <span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span> <span class="main">(</span>find_nonzeros_from_input_vec <span class="main">(</span>construct_lhs_vector <span class="free">p</span> <span class="free">qs</span> <span class="free">signs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> in_set solve_construct <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?lhs_vec</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>solve_for_lhs <span class="free">p</span> <span class="free">qs</span> <span class="free">subsets</span> <span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> h30<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>construct_lhs_vector <span class="free">p</span> <span class="free">qs</span> <span class="free">signs</span><span class="main">)</span> <span class="main">=</span> <span class="var">?lhs_vec</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms construct_lhs_matches_solve_for_lhs
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> 
    <span class="keyword1"><span class="command">have</span></span> h3a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">.</span> List.member <span class="main">(</span>find_nonzeros_from_input_vec <span class="var">?lhs_vec</span><span class="main">)</span> <span class="bound">x</span> <span class="main">⟶</span><span class="bound">x</span> <span class="main">&lt;</span> length <span class="main">(</span><span class="free">signs</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> h30 size_of_lhs <span class="keyword1"><span class="command">unfolding</span></span> find_nonzeros_from_input_vec_def <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> atLeastLessThan_iff filter_is_subset member_def set_upt subset_eq<span class="main">)</span> 
    <span class="keyword1"><span class="command">have</span></span> h3c<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">.</span> List.member <span class="main">(</span>rows_to_keep <span class="main">(</span>reduce_mat_cols <span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span> <span class="main">(</span>solve_for_lhs <span class="free">p</span> <span class="free">qs</span> <span class="free">subsets</span> <span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="bound">x</span> <span class="main">⟶</span> <span class="bound">x</span> <span class="main">&lt;</span> length <span class="main">(</span><span class="free">subsets</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">clarsimp</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
      <span class="keyword3"><span class="command">assume</span></span> x_mem<span class="main">:</span> <span class="quoted"><span class="quoted">"List.member <span class="main">(</span>rows_to_keep
            <span class="main">(</span>take_cols_from_matrix <span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span>
              <span class="main">(</span>find_nonzeros_from_input_vec <span class="main">(</span>solve_for_lhs <span class="free">p</span> <span class="free">qs</span> <span class="free">subsets</span> <span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">x</span>"</span></span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">nn</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"rat list list <span class="main">⇒</span> nat list <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
        <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x2</span> <span class="bound">x3</span><span class="main">.</span> <span class="main">(</span><span class="main">∃</span><span class="bound">v4</span><span class="main">.</span> <span class="bound">v4</span> <span class="main">∈</span> set <span class="bound">x3</span> <span class="main">∧</span> <span class="main">¬</span> <span class="bound">v4</span> <span class="main">&lt;</span> length <span class="bound">x2</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">nn</span> <span class="bound">x2</span> <span class="bound">x3</span> <span class="main">∈</span> set <span class="bound">x3</span> <span class="main">∧</span> <span class="main">¬</span> <span class="skolem">nn</span> <span class="bound">x2</span> <span class="bound">x3</span> <span class="main">&lt;</span> length <span class="bound">x2</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">moura</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> f4<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">nn</span> <span class="free">signs</span> <span class="main">(</span>find_nonzeros_from_input_vec <span class="main">(</span>solve_for_lhs <span class="free">p</span> <span class="free">qs</span> <span class="free">subsets</span> <span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>find_nonzeros_from_input_vec <span class="main">(</span>solve_for_lhs <span class="free">p</span> <span class="free">qs</span> <span class="free">subsets</span> <span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="main">¬</span> <span class="skolem">nn</span> <span class="free">signs</span> <span class="main">(</span>find_nonzeros_from_input_vec <span class="main">(</span>solve_for_lhs <span class="free">p</span> <span class="free">qs</span> <span class="free">subsets</span> <span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">&lt;</span> length <span class="free">signs</span> <span class="main">∨</span> matrix_A <span class="main">(</span>take_indices <span class="free">signs</span> <span class="main">(</span>find_nonzeros_from_input_vec <span class="main">(</span>solve_for_lhs <span class="free">p</span> <span class="free">qs</span> <span class="free">subsets</span> <span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">subsets</span> <span class="main">=</span> take_cols_from_matrix <span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span> <span class="main">(</span>find_nonzeros_from_input_vec <span class="main">(</span>solve_for_lhs <span class="free">p</span> <span class="free">qs</span> <span class="free">subsets</span> <span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> h3a nonzero reduce_system_matrix_signs_helper <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"matrix_A <span class="main">(</span>take_indices <span class="free">signs</span> <span class="main">(</span>find_nonzeros_from_input_vec <span class="main">(</span>solve_for_lhs <span class="free">p</span> <span class="free">qs</span> <span class="free">subsets</span> <span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">subsets</span> <span class="main">=</span> take_cols_from_matrix <span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span> <span class="main">(</span>find_nonzeros_from_input_vec <span class="main">(</span>solve_for_lhs <span class="free">p</span> <span class="free">qs</span> <span class="free">subsets</span> <span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="skolem">x</span> <span class="main">∈</span> set <span class="main">(</span>map snd <span class="main">(</span>pivot_positions <span class="main">(</span>gauss_jordan_single <span class="main">(</span>take_cols_from_matrix <span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span> <span class="main">(</span>find_nonzeros_from_input_vec <span class="main">(</span>solve_for_lhs <span class="free">p</span> <span class="free">qs</span> <span class="free">subsets</span> <span class="main">(</span>matrix_A <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="keyword1"><span class="hidden">⇧</span><sup>T</sup></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> h3a in_set_member rows_to_keep_def x_mem<span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">&lt;</span> length <span class="main">(</span><span class="free">subsets</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> x_mem <span class="keyword1"><span class="command">unfolding</span></span> rows_to_keep_def <span class="keyword1"><span class="command">using</span></span> pivot_positions
        <span class="keyword1"><span class="command">using</span></span>  dim_row_matrix_A h3a in_set_member nonzero reduce_system_matrix_signs_helper rows_to_keep_def rows_to_keep_lem
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> <span class="main"><span class="main">(</span></span>z3<span class="main"><span class="main">)</span></span> <span class="quoted"><span class="quoted">‹M_mat <span class="main">(</span>take_indices <span class="free">signs</span> <span class="main">(</span>find_nonzeros_from_input_vec <span class="main">(</span>solve_for_lhs <span class="free">p</span> <span class="free">qs</span> <span class="free">subsets</span> <span class="main">(</span>M_mat <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">subsets</span> <span class="main">=</span> take_cols_from_matrix <span class="main">(</span>M_mat <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span> <span class="main">(</span>find_nonzeros_from_input_vec <span class="main">(</span>solve_for_lhs <span class="free">p</span> <span class="free">qs</span> <span class="free">subsets</span> <span class="main">(</span>M_mat <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="skolem">x</span> <span class="main">∈</span> set <span class="main">(</span>map snd <span class="main">(</span>pivot_positions <span class="main">(</span>gauss_jordan_single <span class="main">(</span>take_cols_from_matrix <span class="main">(</span>M_mat <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span> <span class="main">(</span>find_nonzeros_from_input_vec <span class="main">(</span>solve_for_lhs <span class="free">p</span> <span class="free">qs</span> <span class="free">subsets</span> <span class="main">(</span>M_mat <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="keyword1"><span class="hidden">⇧</span><sup>T</sup></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>›</span></span> dim_row_matrix_A rows_to_keep_def rows_to_keep_lem<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">&lt;</span> length <span class="free">subsets</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> in_set_member <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> in_set_2 solve_construct <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>  
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"list_constr <span class="skolem">x</span> <span class="main">(</span>length <span class="free">qs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> in_red_subsets  <span class="keyword1"><span class="command">unfolding</span></span>  reduction_subsets_def 
    <span class="keyword1"><span class="command">using</span></span> take_indices_lem<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="free">subsets</span></span><span class="main">]</span>  rows_to_keep_hyp
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> all_list_constr_def in_set_conv_nth in_set_member length_init<span class="main">)</span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">"Overall Lemmas"</span></span>

<span class="keyword1" id="BKR_Proofs-combining_to_smash"><span class="command">lemma</span></span> combining_to_smash<span class="main">:</span>  <span class="quoted"><span class="quoted">"combine_systems <span class="free">p</span> <span class="main">(</span><span class="free">qs1</span><span class="main">,</span> <span class="free">m1</span><span class="main">,</span> <span class="main">(</span><span class="free">sub1</span><span class="main">,</span> <span class="free">sgn1</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">qs2</span><span class="main">,</span> <span class="free">m2</span><span class="main">,</span> <span class="main">(</span><span class="free">sub2</span><span class="main">,</span> <span class="free">sgn2</span><span class="main">)</span><span class="main">)</span>
 <span class="main">=</span>  smash_systems <span class="free">p</span> <span class="free">qs1</span> <span class="free">qs2</span> <span class="free">sub1</span> <span class="free">sub2</span> <span class="free">sgn1</span> <span class="free">sgn2</span> <span class="free">m1</span> <span class="free">m2</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="BKR_Proofs-getter_functions"><span class="command">lemma</span></span> getter_functions<span class="main">:</span> <span class="quoted"><span class="quoted">"calculate_data <span class="free">p</span> <span class="free">qs</span> <span class="main">=</span> <span class="main">(</span>get_matrix <span class="main">(</span>calculate_data <span class="free">p</span> <span class="free">qs</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>get_subsets <span class="main">(</span>calculate_data <span class="free">p</span> <span class="free">qs</span><span class="main">)</span><span class="main">,</span> get_signs <span class="main">(</span>calculate_data <span class="free">p</span> <span class="free">qs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> "</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> get_matrix_def get_subsets_def get_signs_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Key properties preserved"</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">"Properties preserved when combining and reducing systems"</span></span>
<span class="keyword1" id="BKR_Proofs-combining_sys_satisfies_properties_helper"><span class="command">lemma</span></span> combining_sys_satisfies_properties_helper<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">p</span><span class="main">::</span> <span class="quoted"><span class="quoted">"real poly"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">qs1</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real poly list"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">qs2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real poly list"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">subsets1</span> <span class="free">subsets2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat list list"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">signs1</span> <span class="free">signs2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"rat list list"</span></span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">matrix1</span> <span class="free">matrix2</span><span class="main">::</span> <span class="quoted"><span class="quoted">"rat mat"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> nonzero<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> nontriv1<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">qs1</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> pairwise_rel_prime1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">q</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span>List.member <span class="free">qs1</span> <span class="bound">q</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">(</span>coprime <span class="free">p</span> <span class="bound">q</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> nontriv2<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">qs2</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> pairwise_rel_prime2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">q</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span>List.member <span class="free">qs2</span> <span class="bound">q</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">(</span>coprime <span class="free">p</span> <span class="bound">q</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> satisfies_properties_sys1<span class="main">:</span> <span class="quoted"><span class="quoted">"satisfies_properties <span class="free">p</span> <span class="free">qs1</span> <span class="free">subsets1</span> <span class="free">signs1</span> <span class="free">matrix1</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> satisfies_properties_sys2<span class="main">:</span> <span class="quoted"><span class="quoted">"satisfies_properties <span class="free">p</span> <span class="free">qs2</span> <span class="free">subsets2</span> <span class="free">signs2</span> <span class="free">matrix2</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>  <span class="quoted"><span class="quoted">"satisfies_properties <span class="free">p</span> <span class="main">(</span><span class="free">qs1</span><span class="main">@</span><span class="free">qs2</span><span class="main">)</span> <span class="main">(</span>get_subsets <span class="main">(</span>snd <span class="main">(</span><span class="main">(</span>combine_systems <span class="free">p</span> <span class="main">(</span><span class="free">qs1</span><span class="main">,</span><span class="main">(</span><span class="free">matrix1</span><span class="main">,</span> <span class="main">(</span><span class="free">subsets1</span><span class="main">,</span> <span class="free">signs1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">qs2</span><span class="main">,</span><span class="main">(</span><span class="free">matrix2</span><span class="main">,</span> <span class="main">(</span><span class="free">subsets2</span><span class="main">,</span> <span class="free">signs2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> 
  <span class="main">(</span>get_signs <span class="main">(</span>snd <span class="main">(</span><span class="main">(</span>combine_systems <span class="free">p</span> <span class="main">(</span><span class="free">qs1</span><span class="main">,</span><span class="main">(</span><span class="free">matrix1</span><span class="main">,</span> <span class="main">(</span><span class="free">subsets1</span><span class="main">,</span> <span class="free">signs1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">qs2</span><span class="main">,</span><span class="main">(</span><span class="free">matrix2</span><span class="main">,</span> <span class="main">(</span><span class="free">subsets2</span><span class="main">,</span> <span class="free">signs2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> 
  <span class="main">(</span>get_matrix <span class="main">(</span>snd <span class="main">(</span><span class="main">(</span>combine_systems <span class="free">p</span> <span class="main">(</span><span class="free">qs1</span><span class="main">,</span><span class="main">(</span><span class="free">matrix1</span><span class="main">,</span> <span class="main">(</span><span class="free">subsets1</span><span class="main">,</span> <span class="free">signs1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">qs2</span><span class="main">,</span><span class="main">(</span><span class="free">matrix2</span><span class="main">,</span> <span class="main">(</span><span class="free">subsets2</span><span class="main">,</span> <span class="free">signs2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>     
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?subsets</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>get_subsets <span class="main">(</span>snd <span class="main">(</span>combine_systems <span class="free">p</span> <span class="main">(</span><span class="free">qs1</span><span class="main">,</span> <span class="free">matrix1</span><span class="main">,</span> <span class="free">subsets1</span><span class="main">,</span> <span class="free">signs1</span><span class="main">)</span>
              <span class="main">(</span><span class="free">qs2</span><span class="main">,</span> <span class="free">matrix2</span><span class="main">,</span> <span class="free">subsets2</span><span class="main">,</span> <span class="free">signs2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?signs</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>get_signs <span class="main">(</span>snd <span class="main">(</span>combine_systems <span class="free">p</span> <span class="main">(</span><span class="free">qs1</span><span class="main">,</span> <span class="free">matrix1</span><span class="main">,</span> <span class="free">subsets1</span><span class="main">,</span> <span class="free">signs1</span><span class="main">)</span> <span class="main">(</span><span class="free">qs2</span><span class="main">,</span> <span class="free">matrix2</span><span class="main">,</span> <span class="free">subsets2</span><span class="main">,</span> <span class="free">signs2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?matrix</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>get_matrix <span class="main">(</span>snd <span class="main">(</span>combine_systems <span class="free">p</span> <span class="main">(</span><span class="free">qs1</span><span class="main">,</span> <span class="free">matrix1</span><span class="main">,</span> <span class="free">subsets1</span><span class="main">,</span> <span class="free">signs1</span><span class="main">)</span> <span class="main">(</span><span class="free">qs2</span><span class="main">,</span> <span class="free">matrix2</span><span class="main">,</span> <span class="free">subsets2</span><span class="main">,</span> <span class="free">signs2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> h1<span class="main">:</span> <span class="quoted"><span class="quoted">"all_list_constr <span class="var">?subsets</span> <span class="main">(</span>length <span class="main">(</span><span class="free">qs1</span> <span class="main">@</span> <span class="free">qs2</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> well_def_step<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">subsets1</span></span> <span class="quoted"><span class="free">qs1</span></span> <span class="quoted"><span class="free">subsets2</span></span> <span class="quoted"><span class="free">qs2</span></span><span class="main">]</span> assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nontriv2 get_subsets_def satisfies_properties_def smash_systems_def<span class="main">)</span> 
  <span class="keyword1"><span class="command">have</span></span> h2<span class="main">:</span> <span class="quoted"><span class="quoted">"well_def_signs <span class="main">(</span>length <span class="main">(</span><span class="free">qs1</span> <span class="main">@</span> <span class="free">qs2</span><span class="main">)</span><span class="main">)</span> <span class="var">?signs</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> well_def_signs_step<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">qs1</span></span> <span class="quoted"><span class="free">qs2</span></span> <span class="quoted"><span class="free">signs1</span></span> <span class="quoted"><span class="free">signs2</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">using</span></span> get_signs_def nontriv1 nontriv2 satisfies_properties_def satisfies_properties_sys1 satisfies_properties_sys2 smash_systems_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
  <span class="keyword1"><span class="command">have</span></span> h3<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="var">?signs</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> distinct_step<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="free">signs1</span></span> <span class="main">_</span> <span class="quoted"><span class="free">signs2</span></span><span class="main">]</span> assms
    <span class="keyword1"><span class="command">using</span></span> combine_systems.simps get_signs_def satisfies_properties_def smash_systems_def snd_conv <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> h4<span class="main">:</span> <span class="quoted"><span class="quoted">"satisfy_equation <span class="free">p</span> <span class="main">(</span><span class="free">qs1</span> <span class="main">@</span> <span class="free">qs2</span><span class="main">)</span> <span class="var">?subsets</span> <span class="var">?signs</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> assms inductive_step<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">p</span></span> <span class="quoted"><span class="free">qs1</span></span> <span class="quoted"><span class="free">qs2</span></span> <span class="quoted"><span class="free">signs1</span></span> <span class="quoted"><span class="free">signs2</span></span> <span class="quoted"><span class="free">subsets1</span></span> <span class="quoted"><span class="free">subsets2</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">using</span></span> get_signs_def get_subsets_def satisfies_properties_def smash_systems_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>  
  <span class="keyword1"><span class="command">have</span></span> h5<span class="main">:</span> <span class="quoted"><span class="quoted">" invertible_mat <span class="var">?matrix</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms inductive_step<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">p</span></span> <span class="quoted"><span class="free">qs1</span></span> <span class="quoted"><span class="free">qs2</span></span> <span class="quoted"><span class="free">signs1</span></span> <span class="quoted"><span class="free">signs2</span></span> <span class="quoted"><span class="free">subsets1</span></span> <span class="quoted"><span class="free">subsets2</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> combining_to_smash fst_conv get_matrix_def kronecker_invertible satisfies_properties_def smash_systems_def snd_conv<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> h6<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?matrix</span> <span class="main">=</span> matrix_A <span class="var">?signs</span> <span class="var">?subsets</span>"</span></span> 
    <span class="keyword1"><span class="command">unfolding</span></span> get_matrix_def combine_systems.simps smash_systems_def get_signs_def get_subsets_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> matrix_construction_is_kronecker_product<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">subsets1</span></span></span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">signs1</span></span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">signs2</span></span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">subsets2</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> Ball_set all_list_constr_def in_set_member list_constr_def satisfies_properties_def satisfies_properties_sys1<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> satisfies_properties_def satisfies_properties_sys1 well_def_signs_def <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">using</span></span> satisfies_properties_def satisfies_properties_sys1 satisfies_properties_sys2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> h7<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>characterize_consistent_signs_at_roots_copr <span class="free">p</span> <span class="main">(</span><span class="free">qs1</span> <span class="main">@</span> <span class="free">qs2</span><span class="main">)</span><span class="main">)</span>
    <span class="main">⊆</span> set <span class="main">(</span><span class="var">?signs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> subset_step<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">p</span></span> <span class="quoted"><span class="free">qs1</span></span> <span class="quoted"><span class="free">signs1</span></span> <span class="quoted"><span class="free">qs2</span></span>  <span class="quoted"><span class="free">signs2</span></span><span class="main">]</span> assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nonzero get_signs_def satisfies_properties_def smash_systems_def<span class="main">)</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> satisfies_properties_def <span class="keyword1"><span class="command">using</span></span> h1 h2 h3 h4 h5 h6 h7 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="BKR_Proofs-combining_sys_satisfies_properties"><span class="command">lemma</span></span> combining_sys_satisfies_properties<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">p</span><span class="main">::</span> <span class="quoted"><span class="quoted">"real poly"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">qs1</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real poly list"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">qs2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real poly list"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> nonzero<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> nontriv1<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">qs1</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> pairwise_rel_prime1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">q</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span>List.member <span class="free">qs1</span> <span class="bound">q</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">(</span>coprime <span class="free">p</span> <span class="bound">q</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> nontriv2<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">qs2</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> pairwise_rel_prime2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">q</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span>List.member <span class="free">qs2</span> <span class="bound">q</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">(</span>coprime <span class="free">p</span> <span class="bound">q</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> satisfies_properties_sys1<span class="main">:</span> <span class="quoted"><span class="quoted">"satisfies_properties <span class="free">p</span> <span class="free">qs1</span> <span class="main">(</span>get_subsets <span class="main">(</span>calculate_data <span class="free">p</span> <span class="free">qs1</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>get_signs <span class="main">(</span>calculate_data <span class="free">p</span> <span class="free">qs1</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>get_matrix <span class="main">(</span>calculate_data <span class="free">p</span> <span class="free">qs1</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> satisfies_properties_sys2<span class="main">:</span> <span class="quoted"><span class="quoted">"satisfies_properties <span class="free">p</span> <span class="free">qs2</span> <span class="main">(</span>get_subsets <span class="main">(</span>calculate_data <span class="free">p</span> <span class="free">qs2</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>get_signs <span class="main">(</span>calculate_data <span class="free">p</span> <span class="free">qs2</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>get_matrix <span class="main">(</span>calculate_data <span class="free">p</span> <span class="free">qs2</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>  <span class="quoted"><span class="quoted">"satisfies_properties <span class="free">p</span> <span class="main">(</span><span class="free">qs1</span><span class="main">@</span><span class="free">qs2</span><span class="main">)</span> <span class="main">(</span>get_subsets <span class="main">(</span>snd <span class="main">(</span><span class="main">(</span>combine_systems <span class="free">p</span> <span class="main">(</span><span class="free">qs1</span><span class="main">,</span>calculate_data <span class="free">p</span> <span class="free">qs1</span><span class="main">)</span> <span class="main">(</span><span class="free">qs2</span><span class="main">,</span>calculate_data <span class="free">p</span> <span class="free">qs2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> 
  <span class="main">(</span>get_signs <span class="main">(</span>snd <span class="main">(</span><span class="main">(</span>combine_systems <span class="free">p</span> <span class="main">(</span><span class="free">qs1</span><span class="main">,</span>calculate_data <span class="free">p</span> <span class="free">qs1</span><span class="main">)</span> <span class="main">(</span><span class="free">qs2</span><span class="main">,</span>calculate_data <span class="free">p</span> <span class="free">qs2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> 
  <span class="main">(</span>get_matrix <span class="main">(</span>snd <span class="main">(</span><span class="main">(</span>combine_systems <span class="free">p</span> <span class="main">(</span><span class="free">qs1</span><span class="main">,</span>calculate_data <span class="free">p</span> <span class="free">qs1</span><span class="main">)</span> <span class="main">(</span><span class="free">qs2</span><span class="main">,</span>calculate_data <span class="free">p</span> <span class="free">qs2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> combining_sys_satisfies_properties_helper
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> getter_functions nontriv1 nontriv2 nonzero pairwise_rel_prime1 pairwise_rel_prime2 nonzero satisfies_properties_sys1 satisfies_properties_sys2<span class="main">)</span> 

<span class="keyword1" id="BKR_Proofs-reducing_sys_satisfies_properties"><span class="command">lemma</span></span> reducing_sys_satisfies_properties<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">p</span><span class="main">::</span> <span class="quoted"><span class="quoted">"real poly"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">qs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real poly list"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">subsets</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat list list"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">signs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"rat list list"</span></span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">matrix</span><span class="main">::</span> <span class="quoted"><span class="quoted">"rat mat"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> nonzero<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> nontriv<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">qs</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> pairwise_rel_prime<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">q</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span>List.member <span class="free">qs</span> <span class="bound">q</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">(</span>coprime <span class="free">p</span> <span class="bound">q</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> satisfies_properties_sys<span class="main">:</span> <span class="quoted"><span class="quoted">"satisfies_properties <span class="free">p</span> <span class="free">qs</span> <span class="free">subsets</span> <span class="free">signs</span> <span class="free">matrix</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>  <span class="quoted"><span class="quoted">"satisfies_properties <span class="free">p</span> <span class="free">qs</span> <span class="main">(</span>get_subsets <span class="main">(</span>reduce_system <span class="free">p</span> <span class="main">(</span><span class="free">qs</span><span class="main">,</span><span class="free">matrix</span><span class="main">,</span><span class="free">subsets</span><span class="main">,</span><span class="free">signs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
  <span class="main">(</span>get_signs <span class="main">(</span>reduce_system <span class="free">p</span> <span class="main">(</span><span class="free">qs</span><span class="main">,</span><span class="free">matrix</span><span class="main">,</span><span class="free">subsets</span><span class="main">,</span><span class="free">signs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
  <span class="main">(</span>get_matrix <span class="main">(</span>reduce_system <span class="free">p</span> <span class="main">(</span><span class="free">qs</span><span class="main">,</span><span class="free">matrix</span><span class="main">,</span><span class="free">subsets</span><span class="main">,</span><span class="free">signs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> h1<span class="main">:</span> <span class="quoted"><span class="quoted">" all_list_constr <span class="main">(</span>get_subsets <span class="main">(</span>reduce_system <span class="free">p</span> <span class="main">(</span><span class="free">qs</span><span class="main">,</span> <span class="free">matrix</span><span class="main">,</span> <span class="free">subsets</span><span class="main">,</span> <span class="free">signs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>length <span class="free">qs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> reduction_doesnt_break_subsets assms reduction_subsets_is_get_subsets satisfies_properties_def satisfies_properties_sys <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> h2<span class="main">:</span> <span class="quoted"><span class="quoted">"well_def_signs <span class="main">(</span>length <span class="free">qs</span><span class="main">)</span> <span class="main">(</span>get_signs <span class="main">(</span>reduce_system <span class="free">p</span> <span class="main">(</span><span class="free">qs</span><span class="main">,</span> <span class="free">matrix</span><span class="main">,</span> <span class="free">subsets</span><span class="main">,</span> <span class="free">signs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> reduction_doesnt_break_length_signs<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">signs</span></span> <span class="quoted"><span class="free">qs</span></span> <span class="quoted"><span class="free">p</span></span> <span class="quoted"><span class="free">subsets</span></span><span class="main">]</span> assms reduction_signs_is_get_signs satisfies_properties_def well_def_signs_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> h3<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>get_signs <span class="main">(</span>reduce_system <span class="free">p</span> <span class="main">(</span><span class="free">qs</span><span class="main">,</span> <span class="free">matrix</span><span class="main">,</span> <span class="free">subsets</span><span class="main">,</span> <span class="free">signs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> reduction_signs_are_distinct<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">p</span></span> <span class="quoted"><span class="free">qs</span></span> <span class="quoted"><span class="free">subsets</span></span> <span class="quoted"><span class="free">signs</span></span><span class="main">]</span> assms reduction_signs_is_get_signs satisfies_properties_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
  <span class="keyword1"><span class="command">have</span></span> h4<span class="main">:</span> <span class="quoted"><span class="quoted">"satisfy_equation <span class="free">p</span> <span class="free">qs</span> <span class="main">(</span>get_subsets <span class="main">(</span>reduce_system <span class="free">p</span> <span class="main">(</span><span class="free">qs</span><span class="main">,</span> <span class="free">matrix</span><span class="main">,</span> <span class="free">subsets</span><span class="main">,</span> <span class="free">signs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
     <span class="main">(</span>get_signs <span class="main">(</span>reduce_system <span class="free">p</span> <span class="main">(</span><span class="free">qs</span><span class="main">,</span> <span class="free">matrix</span><span class="main">,</span> <span class="free">subsets</span><span class="main">,</span> <span class="free">signs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> reduce_system_matrix_equation_preserved<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">p</span></span> <span class="quoted"><span class="free">qs</span></span> <span class="quoted"><span class="free">signs</span></span> <span class="quoted"><span class="free">subsets</span></span><span class="main">]</span> assms satisfies_properties_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> h5<span class="main">:</span> <span class="quoted"><span class="quoted">"invertible_mat <span class="main">(</span>get_matrix <span class="main">(</span>reduce_system <span class="free">p</span> <span class="main">(</span><span class="free">qs</span><span class="main">,</span> <span class="free">matrix</span><span class="main">,</span> <span class="free">subsets</span><span class="main">,</span> <span class="free">signs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> reduction_doesnt_break_things_invertibility assms same_size satisfies_properties_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
  <span class="keyword1"><span class="command">have</span></span> h6<span class="main">:</span> <span class="quoted"><span class="quoted">"get_matrix <span class="main">(</span>reduce_system <span class="free">p</span> <span class="main">(</span><span class="free">qs</span><span class="main">,</span> <span class="free">matrix</span><span class="main">,</span> <span class="free">subsets</span><span class="main">,</span> <span class="free">signs</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
    matrix_A <span class="main">(</span>get_signs <span class="main">(</span>reduce_system <span class="free">p</span> <span class="main">(</span><span class="free">qs</span><span class="main">,</span> <span class="free">matrix</span><span class="main">,</span> <span class="free">subsets</span><span class="main">,</span> <span class="free">signs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
     <span class="main">(</span>get_subsets <span class="main">(</span>reduce_system <span class="free">p</span> <span class="main">(</span><span class="free">qs</span><span class="main">,</span> <span class="free">matrix</span><span class="main">,</span> <span class="free">subsets</span><span class="main">,</span> <span class="free">signs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> reduce_system_matrix_match<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">p</span></span> <span class="quoted"><span class="free">qs</span></span> <span class="quoted"><span class="free">signs</span></span> <span class="quoted"><span class="free">subsets</span></span><span class="main">]</span> assms satisfies_properties_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> h7<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>characterize_consistent_signs_at_roots_copr <span class="free">p</span> <span class="free">qs</span><span class="main">)</span> <span class="main">⊆</span> set <span class="main">(</span>get_signs <span class="main">(</span>reduce_system <span class="free">p</span> <span class="main">(</span><span class="free">qs</span><span class="main">,</span> <span class="free">matrix</span><span class="main">,</span> <span class="free">subsets</span><span class="main">,</span> <span class="free">signs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> reduction_doesnt_break_things_signs<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">p</span></span> <span class="quoted"><span class="free">qs</span></span> <span class="quoted"><span class="free">signs</span></span> <span class="quoted"><span class="free">subsets</span></span><span class="main">]</span> assms reduction_signs_is_get_signs satisfies_properties_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> satisfies_properties_def <span class="keyword1"><span class="command">using</span></span> h1 h2 h3 h4 h5 h6 h7
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">"For length 1 qs"</span></span>

<span class="keyword1" id="BKR_Proofs-length_1_calculate_data_satisfies_properties"><span class="command">lemma</span></span>  length_1_calculate_data_satisfies_properties<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">p</span><span class="main">::</span> <span class="quoted"><span class="quoted">"real poly"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">qs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real poly list"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">subsets</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat list list"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">signs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"rat list list"</span></span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> nonzero<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> len1<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">qs</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> pairwise_rel_prime<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">q</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span>List.member <span class="free">qs</span> <span class="bound">q</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">(</span>coprime <span class="free">p</span> <span class="bound">q</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"satisfies_properties <span class="free">p</span> <span class="free">qs</span> <span class="main">(</span>get_subsets <span class="main">(</span>calculate_data <span class="free">p</span> <span class="free">qs</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>get_signs <span class="main">(</span>calculate_data <span class="free">p</span> <span class="free">qs</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>get_matrix <span class="main">(</span>calculate_data <span class="free">p</span> <span class="free">qs</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
  <span class="keyword1"><span class="command">have</span></span> h1<span class="main">:</span> <span class="quoted"><span class="quoted">"all_list_constr <span class="main">[</span><span class="main">[]</span><span class="main">,</span><span class="main">[</span><span class="main">0</span><span class="main">]</span><span class="main">]</span> <span class="main">(</span>length <span class="free">qs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> len1 <span class="keyword1"><span class="command">unfolding</span></span> all_list_constr_def list_constr_def <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> length_Cons less_Suc0 list.size<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> list_all_length list_all_simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> member_rec<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> member_rec<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> nth_Cons_0<span class="main">)</span> 
  <span class="keyword1"><span class="command">have</span></span> h2<span class="main">:</span> <span class="quoted"><span class="quoted">"well_def_signs <span class="main">(</span>length <span class="free">qs</span><span class="main">)</span> <span class="main">[</span><span class="main">[</span><span class="main">1</span><span class="main">]</span><span class="main">,</span><span class="main">[</span><span class="main">-</span><span class="main">1</span><span class="main">]</span><span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> well_def_signs_def <span class="keyword1"><span class="command">using</span></span> len1 in_set_member 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> h3<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span><span class="main">[</span><span class="main">[</span><span class="main">1</span><span class="main">]</span><span class="main">,</span><span class="main">[</span><span class="main">-</span><span class="main">1</span><span class="main">]</span><span class="main">]</span><span class="main">::</span>rat list list<span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">unfolding</span></span> distinct_def <span class="keyword1"><span class="command">using</span></span> in_set_member <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> h4<span class="main">:</span> <span class="quoted"><span class="quoted">"satisfy_equation <span class="free">p</span> <span class="free">qs</span> <span class="main">[</span><span class="main">[]</span><span class="main">,</span><span class="main">[</span><span class="main">0</span><span class="main">]</span><span class="main">]</span> <span class="main">[</span><span class="main">[</span><span class="main">1</span><span class="main">]</span><span class="main">,</span><span class="main">[</span><span class="main">-</span><span class="main">1</span><span class="main">]</span><span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms base_case_satisfy_equation_alt<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">qs</span></span> <span class="quoted"><span class="free">p</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> h6<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>mat_of_rows_list <span class="numeral">2</span> <span class="main">[</span><span class="main">[</span><span class="main">1</span><span class="main">,</span><span class="main">1</span><span class="main">]</span><span class="main">,</span> <span class="main">[</span><span class="main">1</span><span class="main">,</span><span class="main">-</span><span class="main">1</span><span class="main">]</span><span class="main">]</span><span class="main">::</span>rat mat<span class="main">)</span> <span class="main">=</span> <span class="main">(</span>matrix_A <span class="main">(</span><span class="main">[</span><span class="main">[</span><span class="main">1</span><span class="main">]</span><span class="main">,</span><span class="main">[</span><span class="main">-</span><span class="main">1</span><span class="main">]</span><span class="main">]</span><span class="main">)</span> <span class="main">(</span><span class="main">[</span><span class="main">[]</span><span class="main">,</span><span class="main">[</span><span class="main">0</span><span class="main">]</span><span class="main">]</span><span class="main">)</span> <span class="main">::</span> rat mat<span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> mat_base_case <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> h5<span class="main">:</span> <span class="quoted"><span class="quoted">"invertible_mat <span class="main">(</span>mat_of_rows_list <span class="numeral">2</span> <span class="main">[</span><span class="main">[</span><span class="main">1</span><span class="main">,</span><span class="main">1</span><span class="main">]</span><span class="main">,</span> <span class="main">[</span><span class="main">1</span><span class="main">,</span><span class="main">-</span><span class="main">1</span><span class="main">]</span><span class="main">]</span><span class="main">::</span> rat mat<span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> base_case_invertible_mat
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> h7<span class="main">:</span>  <span class="quoted"><span class="quoted">"set <span class="main">(</span>characterize_consistent_signs_at_roots_copr <span class="free">p</span> <span class="free">qs</span><span class="main">)</span> <span class="main">⊆</span> set <span class="main">(</span><span class="main">[</span><span class="main">[</span><span class="main">1</span><span class="main">]</span><span class="main">,</span><span class="main">[</span><span class="main">-</span><span class="main">1</span><span class="main">]</span><span class="main">]</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms base_case_sgas_alt<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">qs</span></span> <span class="quoted"><span class="free">p</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>  
  <span class="keyword1"><span class="command">have</span></span> base_case_hyp<span class="main">:</span> <span class="quoted"><span class="quoted">"satisfies_properties <span class="free">p</span> <span class="free">qs</span> <span class="main">[</span><span class="main">[]</span><span class="main">,</span><span class="main">[</span><span class="main">0</span><span class="main">]</span><span class="main">]</span> <span class="main">[</span><span class="main">[</span><span class="main">1</span><span class="main">]</span><span class="main">,</span><span class="main">[</span><span class="main">-</span><span class="main">1</span><span class="main">]</span><span class="main">]</span> <span class="main">(</span>mat_of_rows_list <span class="numeral">2</span> <span class="main">[</span><span class="main">[</span><span class="main">1</span><span class="main">,</span><span class="main">1</span><span class="main">]</span><span class="main">,</span> <span class="main">[</span><span class="main">1</span><span class="main">,</span><span class="main">-</span><span class="main">1</span><span class="main">]</span><span class="main">]</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> h1 h2 h3 h4 h5 h6 h7
    <span class="keyword1"><span class="command">using</span></span> satisfies_properties_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> key_hyp<span class="main">:</span> <span class="quoted"><span class="quoted">"satisfies_properties <span class="free">p</span> <span class="free">qs</span> <span class="main">(</span>get_subsets <span class="main">(</span>reduce_system <span class="free">p</span> <span class="main">(</span><span class="free">qs</span><span class="main">,</span>base_case_info<span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>get_signs <span class="main">(</span>reduce_system <span class="free">p</span> <span class="main">(</span><span class="free">qs</span><span class="main">,</span>base_case_info<span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>get_matrix <span class="main">(</span>reduce_system <span class="free">p</span> <span class="main">(</span><span class="free">qs</span><span class="main">,</span>base_case_info<span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> reducing_sys_satisfies_properties
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> base_case_info_def len1 nonzero pairwise_rel_prime nonzero zero_less_one_class.zero_less_one<span class="main">)</span> 
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> key_hyp len1<span class="main">)</span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">"For arbitrary qs"</span></span>
<span class="keyword1" id="BKR_Proofs-append_not_distinct_helper"><span class="command">lemma</span></span> append_not_distinct_helper<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>List.member <span class="free">l1</span> <span class="free">m</span> <span class="main">∧</span> List.member <span class="free">l2</span> <span class="free">m</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">(</span>distinct <span class="main">(</span><span class="free">l1</span><span class="main">@</span><span class="free">l2</span><span class="main">)</span> <span class="main">=</span> False<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
  <span class="keyword1"><span class="command">have</span></span> h1<span class="main">:</span> <span class="quoted"><span class="quoted">"List.member <span class="free">l1</span> <span class="free">m</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">&lt;</span> length <span class="free">l1</span> <span class="main">∧</span> <span class="main">(</span>nth <span class="free">l1</span> <span class="bound">n</span><span class="main">)</span> <span class="main">=</span> <span class="free">m</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> member_def nth_find_first
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> member_def in_set_conv_nth<span class="main">)</span> 
  <span class="keyword1"><span class="command">have</span></span> h2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">&lt;</span> length <span class="free">l1</span> <span class="main">∧</span> <span class="main">(</span>nth <span class="free">l1</span> <span class="bound">n</span><span class="main">)</span> <span class="main">=</span> <span class="free">m</span> <span class="main">⟶</span> <span class="main">(</span>nth <span class="main">(</span><span class="free">l1</span><span class="main">@</span><span class="free">l2</span><span class="main">)</span> <span class="bound">n</span><span class="main">)</span> <span class="main">=</span> <span class="free">m</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">clarsimp</span> 
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">n</span>
    <span class="keyword3"><span class="command">assume</span></span> lt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">&lt;</span> length <span class="free">l1</span>"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> nth_l1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">=</span> <span class="free">l1</span> <span class="main">!</span> <span class="skolem">n</span>"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">l1</span> <span class="main">@</span> <span class="free">l2</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">n</span> <span class="main">=</span> <span class="free">l1</span> <span class="main">!</span> <span class="skolem">n</span>"</span></span> 
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">l2</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> Nil
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> 
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">l2</span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lt nth_append<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">have</span></span> h3<span class="main">:</span> <span class="quoted"><span class="quoted">"List.member <span class="free">l1</span> <span class="free">m</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">n</span><span class="main">.</span>  <span class="bound">n</span> <span class="main">&lt;</span> length <span class="free">l1</span> <span class="main">∧</span> <span class="main">(</span>nth <span class="main">(</span><span class="free">l1</span><span class="main">@</span><span class="free">l2</span><span class="main">)</span> <span class="bound">n</span><span class="main">)</span> <span class="main">=</span> <span class="free">m</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> h1 h2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> h4<span class="main">:</span> <span class="quoted"><span class="quoted">"List.member <span class="free">l2</span> <span class="free">m</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">n</span><span class="main">.</span> <span class="main">(</span>nth <span class="free">l2</span> <span class="bound">n</span><span class="main">)</span> <span class="main">=</span> <span class="free">m</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> member_def nth_find_first<span class="main">)</span> 
  <span class="keyword1"><span class="command">have</span></span> h5<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">n</span><span class="main">.</span> <span class="main">(</span>nth <span class="free">l2</span> <span class="bound">n</span><span class="main">)</span> <span class="main">=</span> <span class="free">m</span> <span class="main">⟶</span> <span class="main">(</span>nth <span class="main">(</span><span class="free">l1</span><span class="main">@</span><span class="free">l2</span><span class="main">)</span> <span class="main">(</span><span class="bound">n</span> <span class="main">+</span> length <span class="free">l1</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">m</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">clarsimp</span> 
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">n</span>
    <span class="keyword3"><span class="command">assume</span></span> nth_l2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">=</span> <span class="free">l2</span> <span class="main">!</span> <span class="skolem">n</span>"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">l1</span> <span class="main">@</span> <span class="free">l2</span><span class="main">)</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">n</span> <span class="main">+</span> length <span class="free">l1</span><span class="main">)</span> <span class="main">=</span> <span class="free">l2</span> <span class="main">!</span> <span class="skolem">n</span>"</span></span> 
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">l2</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> Nil
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> add.commute nth_append_length_plus<span class="main">)</span> 
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">l2</span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nth_append<span class="main">)</span> 
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">have</span></span> h6<span class="main">:</span> <span class="quoted"><span class="quoted">"List.member <span class="free">l2</span> <span class="free">m</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">n</span><span class="main">.</span> <span class="main">(</span>nth <span class="main">(</span><span class="free">l1</span><span class="main">@</span><span class="free">l2</span><span class="main">)</span> <span class="main">(</span><span class="bound">n</span> <span class="main">+</span> length <span class="free">l1</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">m</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> h4 h5
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> h3 h6
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> distinct_append equalityI insert_disjoint<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> insert_subset member_def order_refl<span class="main">)</span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="BKR_Proofs-calculate_data_satisfies_properties"><span class="command">lemma</span></span>  calculate_data_satisfies_properties<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">p</span><span class="main">::</span> <span class="quoted"><span class="quoted">"real poly"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">qs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real poly list"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">subsets</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat list list"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">signs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"rat list list"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">p</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">∧</span> <span class="main">(</span>length <span class="free">qs</span> <span class="main">&gt;</span> <span class="main">0</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">q</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span>List.member <span class="free">qs</span> <span class="bound">q</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">(</span>coprime <span class="free">p</span> <span class="bound">q</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">)</span>
    <span class="main">⟶</span> satisfies_properties <span class="free">p</span> <span class="free">qs</span> <span class="main">(</span>get_subsets <span class="main">(</span>calculate_data <span class="free">p</span> <span class="free">qs</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>get_signs <span class="main">(</span>calculate_data <span class="free">p</span> <span class="free">qs</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>get_matrix <span class="main">(</span>calculate_data <span class="free">p</span> <span class="free">qs</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="quoted">"length <span class="free">qs</span>"</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">qs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> less_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> less
  <span class="keyword1"><span class="command">have</span></span> len1_h<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="skolem">qs</span> <span class="main">=</span> <span class="main">1</span> <span class="main">⟶</span> <span class="main">(</span> <span class="free">p</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">∧</span> <span class="main">(</span>length <span class="skolem">qs</span> <span class="main">&gt;</span> <span class="main">0</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">q</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span>List.member <span class="skolem">qs</span> <span class="bound">q</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">(</span>coprime <span class="free">p</span> <span class="bound">q</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">)</span> <span class="main">⟶</span> satisfies_properties <span class="free">p</span> <span class="skolem">qs</span> <span class="main">(</span>get_subsets <span class="main">(</span>calculate_data <span class="free">p</span> <span class="skolem">qs</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>get_signs <span class="main">(</span>calculate_data <span class="free">p</span> <span class="skolem">qs</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>get_matrix <span class="main">(</span>calculate_data <span class="free">p</span> <span class="skolem">qs</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span>  length_1_calculate_data_satisfies_properties
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?len</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"length <span class="skolem">qs</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?q1</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"take <span class="main">(</span><span class="var">?len</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="skolem">qs</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?left</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"calculate_data <span class="free">p</span> <span class="var">?q1</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?q2</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"drop <span class="main">(</span><span class="var">?len</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="skolem">qs</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?right</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"calculate_data <span class="free">p</span> <span class="var">?q2</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?comb</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"combine_systems <span class="free">p</span> <span class="main">(</span><span class="var">?q1</span><span class="main">,</span><span class="var">?left</span><span class="main">)</span> <span class="main">(</span><span class="var">?q2</span><span class="main">,</span><span class="var">?right</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?red</span></span></span> <span class="main">=</span>  <span class="quoted"><span class="quoted">"reduce_system <span class="free">p</span> <span class="var">?comb</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> h_q1_len<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="skolem">qs</span> <span class="main">&gt;</span> <span class="main">1</span> <span class="main">⟶</span> <span class="main">(</span>length <span class="var">?q1</span> <span class="main">&gt;</span> <span class="main">0</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
  <span class="keyword1"><span class="command">have</span></span> h_q2_len<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="skolem">qs</span> <span class="main">&gt;</span> <span class="main">1</span> <span class="main">⟶</span> <span class="main">(</span>length <span class="var">?q2</span> <span class="main">&gt;</span> <span class="main">0</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> h_q1_copr<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">q</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span>List.member <span class="skolem">qs</span> <span class="bound">q</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">(</span>coprime <span class="free">p</span> <span class="bound">q</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∀</span><span class="bound">q</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span>List.member <span class="var">?q1</span> <span class="bound">q</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">(</span>coprime <span class="free">p</span> <span class="bound">q</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> mem_hyp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">q</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span>List.member <span class="var">?q1</span> <span class="bound">q</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">(</span>List.member <span class="skolem">qs</span> <span class="bound">q</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> in_set_member in_set_takeD<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">have</span></span> h_q2_copr<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">q</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span>List.member <span class="skolem">qs</span> <span class="bound">q</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">(</span>coprime <span class="free">p</span> <span class="bound">q</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∀</span><span class="bound">q</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span>List.member <span class="var">?q2</span> <span class="bound">q</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">(</span>coprime <span class="free">p</span> <span class="bound">q</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> mem_hyp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">q</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span>List.member <span class="var">?q2</span> <span class="bound">q</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">(</span>List.member <span class="skolem">qs</span> <span class="bound">q</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> in_set_dropD in_set_member<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">have</span></span> q1_sat_props<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="skolem">qs</span> <span class="main">&gt;</span> <span class="main">1</span> <span class="main">⟶</span> <span class="main">(</span><span class="free">p</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">∧</span> <span class="main">(</span>length <span class="skolem">qs</span> <span class="main">&gt;</span> <span class="main">0</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">q</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span>List.member <span class="skolem">qs</span> <span class="bound">q</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">(</span>coprime <span class="free">p</span> <span class="bound">q</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">)</span> <span class="main">⟶</span> satisfies_properties <span class="free">p</span> <span class="var">?q1</span> <span class="main">(</span>get_subsets <span class="main">(</span>calculate_data <span class="free">p</span> <span class="var">?q1</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>get_signs <span class="main">(</span>calculate_data <span class="free">p</span> <span class="var">?q1</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>get_matrix <span class="main">(</span>calculate_data <span class="free">p</span> <span class="var">?q1</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> less.hyps<span class="main">[</span><span class="operator">of</span> <span class="var"><span class="quoted"><span class="var">?q1</span></span></span><span class="main">]</span> h_q1_len h_q1_copr <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> q2_help<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="skolem">qs</span> <span class="main">&gt;</span> <span class="main">1</span> <span class="main">⟶</span> length <span class="main">(</span>drop <span class="main">(</span>length <span class="skolem">qs</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="skolem">qs</span><span class="main">)</span> <span class="main">&lt;</span> length <span class="skolem">qs</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> h_q1_len <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>  
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> q2_sat_props<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="skolem">qs</span> <span class="main">&gt;</span> <span class="main">1</span> <span class="main">⟶</span> <span class="main">(</span><span class="free">p</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">∧</span> <span class="main">(</span>length <span class="skolem">qs</span> <span class="main">&gt;</span> <span class="main">0</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">q</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span>List.member <span class="skolem">qs</span> <span class="bound">q</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">(</span>coprime <span class="free">p</span> <span class="bound">q</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">)</span> <span class="main">⟶</span> satisfies_properties <span class="free">p</span> <span class="var">?q2</span> <span class="main">(</span>get_subsets <span class="main">(</span>calculate_data <span class="free">p</span> <span class="var">?q2</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>get_signs <span class="main">(</span>calculate_data <span class="free">p</span> <span class="var">?q2</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>get_matrix <span class="main">(</span>calculate_data <span class="free">p</span> <span class="var">?q2</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> less.hyps<span class="main">[</span><span class="operator">of</span> <span class="var"><span class="quoted"><span class="var">?q2</span></span></span><span class="main">]</span> h_q2_len h_q2_copr
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> put_tog<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?q1</span><span class="main">@</span><span class="var">?q2</span> <span class="main">=</span> <span class="skolem">qs</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> append_take_drop_id <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> comb_sat_props<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="skolem">qs</span> <span class="main">&gt;</span> <span class="main">1</span> <span class="main">⟶</span> <span class="main">(</span><span class="free">p</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">∧</span> <span class="main">(</span>length <span class="skolem">qs</span> <span class="main">&gt;</span> <span class="main">0</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">q</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span>List.member <span class="skolem">qs</span> <span class="bound">q</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">(</span>coprime <span class="free">p</span> <span class="bound">q</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">)</span> <span class="main">⟶</span> <span class="main">(</span>satisfies_properties <span class="free">p</span> <span class="main">(</span><span class="skolem">qs</span><span class="main">)</span> <span class="main">(</span>get_subsets <span class="main">(</span>snd <span class="main">(</span><span class="main">(</span>combine_systems <span class="free">p</span> <span class="main">(</span><span class="var">?q1</span><span class="main">,</span>calculate_data <span class="free">p</span> <span class="var">?q1</span><span class="main">)</span> <span class="main">(</span><span class="var">?q2</span><span class="main">,</span>calculate_data <span class="free">p</span> <span class="var">?q2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> 
  <span class="main">(</span>get_signs <span class="main">(</span>snd <span class="main">(</span><span class="main">(</span>combine_systems <span class="free">p</span> <span class="main">(</span><span class="var">?q1</span><span class="main">,</span>calculate_data <span class="free">p</span> <span class="var">?q1</span><span class="main">)</span> <span class="main">(</span><span class="var">?q2</span><span class="main">,</span>calculate_data <span class="free">p</span> <span class="var">?q2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> 
  <span class="main">(</span>get_matrix <span class="main">(</span>snd <span class="main">(</span><span class="main">(</span>combine_systems <span class="free">p</span> <span class="main">(</span><span class="var">?q1</span><span class="main">,</span>calculate_data <span class="free">p</span> <span class="var">?q1</span><span class="main">)</span> <span class="main">(</span><span class="var">?q2</span><span class="main">,</span>calculate_data <span class="free">p</span> <span class="var">?q2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> q1_sat_props q2_sat_props  combining_sys_satisfies_properties
    <span class="keyword1"><span class="command">using</span></span> h_q1_copr h_q1_len h_q2_copr h_q2_len  put_tog
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> comb_sat<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="skolem">qs</span> <span class="main">&gt;</span> <span class="main">1</span> <span class="main">⟶</span> <span class="main">(</span><span class="free">p</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">∧</span> <span class="main">(</span>length <span class="skolem">qs</span> <span class="main">&gt;</span> <span class="main">0</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">q</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span>List.member <span class="skolem">qs</span> <span class="bound">q</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">(</span>coprime <span class="free">p</span> <span class="bound">q</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">)</span> <span class="main">⟶</span> 
      <span class="main">(</span>satisfies_properties <span class="free">p</span> <span class="main">(</span><span class="skolem">qs</span><span class="main">)</span> <span class="main">(</span>get_subsets <span class="main">(</span>snd <span class="var">?comb</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>get_signs <span class="main">(</span>snd <span class="var">?comb</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>get_matrix <span class="main">(</span>snd <span class="var">?comb</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> red_char<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?red</span> <span class="main">=</span> <span class="main">(</span>reduce_system <span class="free">p</span> <span class="main">(</span><span class="skolem">qs</span><span class="main">,</span><span class="main">(</span>get_matrix <span class="main">(</span>snd <span class="var">?comb</span><span class="main">)</span><span class="main">)</span><span class="main">,</span><span class="main">(</span>get_subsets <span class="main">(</span>snd <span class="var">?comb</span><span class="main">)</span><span class="main">)</span><span class="main">,</span><span class="main">(</span>get_signs <span class="main">(</span>snd <span class="var">?comb</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> getter_functions
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> Pair_inject combining_to_smash get_matrix_def get_signs_def get_subsets_def prod.collapse put_tog smash_systems_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">qs</span> <span class="main">&gt;</span> <span class="main">1</span> <span class="main">⟶</span> <span class="main">(</span><span class="free">p</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">∧</span> <span class="main">(</span>length <span class="skolem">qs</span> <span class="main">&gt;</span> <span class="main">0</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">q</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span>List.member <span class="skolem">qs</span> <span class="bound">q</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">(</span>coprime <span class="free">p</span> <span class="bound">q</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">)</span>  <span class="main">⟶</span> <span class="main">(</span>satisfies_properties <span class="free">p</span> <span class="skolem">qs</span> <span class="main">(</span>get_subsets <span class="var">?red</span><span class="main">)</span> <span class="main">(</span>get_signs <span class="var">?red</span><span class="main">)</span> <span class="main">(</span>get_matrix <span class="var">?red</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> reducing_sys_satisfies_properties comb_sat  <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span> 
  <span class="keyword1"><span class="command">have</span></span> len_gt1<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="skolem">qs</span> <span class="main">&gt;</span> <span class="main">1</span> <span class="main">⟶</span> <span class="main">(</span><span class="free">p</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">∧</span> <span class="main">(</span>length <span class="skolem">qs</span> <span class="main">&gt;</span> <span class="main">0</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">q</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span>List.member <span class="skolem">qs</span> <span class="bound">q</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">(</span>coprime <span class="free">p</span> <span class="bound">q</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">)</span> <span class="main">⟶</span> satisfies_properties <span class="free">p</span> <span class="skolem">qs</span> <span class="main">(</span>get_subsets <span class="main">(</span>calculate_data <span class="free">p</span> <span class="skolem">qs</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>get_signs <span class="main">(</span>calculate_data <span class="free">p</span> <span class="skolem">qs</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>get_matrix <span class="main">(</span>calculate_data <span class="free">p</span> <span class="skolem">qs</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> <span class="quoted"><span class="quoted">‹<span class="main">1</span> <span class="main">&lt;</span> length <span class="skolem">qs</span> <span class="main">⟶</span>  <span class="free">p</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">∧</span> <span class="main">0</span> <span class="main">&lt;</span> length <span class="skolem">qs</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">q</span><span class="main">.</span> List.member <span class="skolem">qs</span> <span class="bound">q</span> <span class="main">⟶</span> coprime <span class="free">p</span> <span class="bound">q</span><span class="main">)</span> <span class="main">⟶</span> satisfies_properties <span class="free">p</span> <span class="skolem">qs</span> <span class="main">(</span>get_subsets <span class="main">(</span>reduce_system <span class="free">p</span> <span class="main">(</span>combine_systems <span class="free">p</span> <span class="main">(</span>take <span class="main">(</span>length <span class="skolem">qs</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="skolem">qs</span><span class="main">,</span> calculate_data <span class="free">p</span> <span class="main">(</span>take <span class="main">(</span>length <span class="skolem">qs</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="skolem">qs</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>drop <span class="main">(</span>length <span class="skolem">qs</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="skolem">qs</span><span class="main">,</span> calculate_data <span class="free">p</span> <span class="main">(</span>drop <span class="main">(</span>length <span class="skolem">qs</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="skolem">qs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>get_signs <span class="main">(</span>reduce_system <span class="free">p</span> <span class="main">(</span>combine_systems <span class="free">p</span> <span class="main">(</span>take <span class="main">(</span>length <span class="skolem">qs</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="skolem">qs</span><span class="main">,</span> calculate_data <span class="free">p</span> <span class="main">(</span>take <span class="main">(</span>length <span class="skolem">qs</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="skolem">qs</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>drop <span class="main">(</span>length <span class="skolem">qs</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="skolem">qs</span><span class="main">,</span> calculate_data <span class="free">p</span> <span class="main">(</span>drop <span class="main">(</span>length <span class="skolem">qs</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="skolem">qs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>get_matrix <span class="main">(</span>reduce_system <span class="free">p</span> <span class="main">(</span>combine_systems <span class="free">p</span> <span class="main">(</span>take <span class="main">(</span>length <span class="skolem">qs</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="skolem">qs</span><span class="main">,</span> calculate_data <span class="free">p</span> <span class="main">(</span>take <span class="main">(</span>length <span class="skolem">qs</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="skolem">qs</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>drop <span class="main">(</span>length <span class="skolem">qs</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="skolem">qs</span><span class="main">,</span> calculate_data <span class="free">p</span> <span class="main">(</span>drop <span class="main">(</span>length <span class="skolem">qs</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="skolem">qs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>›</span></span> calculate_data.simps neq0_conv not_less<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> len1_h len_gt1
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> One_nat_def Suc_lessI<span class="main">)</span> 
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Some key results on consistent sign assignments"</span></span>

<span class="keyword1" id="BKR_Proofs-find_consistent_signs_at_roots_len1"><span class="command">lemma</span></span> find_consistent_signs_at_roots_len1<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">p</span><span class="main">::</span> <span class="quoted"><span class="quoted">"real poly"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">qs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real poly list"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">subsets</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat list list"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">signs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"rat list list"</span></span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> nonzero<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> len1<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">qs</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> pairwise_rel_prime<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">q</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span>List.member <span class="free">qs</span> <span class="bound">q</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">(</span>coprime <span class="free">p</span> <span class="bound">q</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>find_consistent_signs_at_roots <span class="free">p</span> <span class="free">qs</span><span class="main">)</span> <span class="main">=</span> set <span class="main">(</span>characterize_consistent_signs_at_roots_copr <span class="free">p</span> <span class="free">qs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?signs</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">[</span><span class="main">1</span><span class="main">]</span><span class="main">,</span><span class="main">[</span><span class="main">-</span><span class="main">1</span><span class="main">]</span><span class="main">]</span><span class="main">::</span>rat list list"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?subsets</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">[]</span><span class="main">,</span><span class="main">[</span><span class="main">0</span><span class="main">]</span><span class="main">]</span><span class="main">::</span>nat list list"</span></span>
  <span class="keyword1"><span class="command">have</span></span> mat_help<span class="main">:</span> <span class="quoted"><span class="quoted">"matrix_A <span class="main">[</span><span class="main">[</span><span class="main">1</span><span class="main">]</span><span class="main">,</span><span class="main">[</span><span class="main">-</span><span class="main">1</span><span class="main">]</span><span class="main">]</span> <span class="main">[</span><span class="main">[]</span><span class="main">,</span><span class="main">[</span><span class="main">0</span><span class="main">]</span><span class="main">]</span> <span class="main">=</span> <span class="main">(</span>mat_of_rows_list <span class="numeral">2</span> <span class="main">[</span><span class="main">[</span><span class="main">1</span><span class="main">,</span><span class="main">1</span><span class="main">]</span><span class="main">,</span> <span class="main">[</span><span class="main">1</span><span class="main">,</span><span class="main">-</span><span class="main">1</span><span class="main">]</span><span class="main">]</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> mat_base_case <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> well_def_signs<span class="main">:</span> <span class="quoted"><span class="quoted">"well_def_signs <span class="main">(</span>length <span class="free">qs</span><span class="main">)</span> <span class="var">?signs</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> well_def_signs_def 
    <span class="keyword1"><span class="command">using</span></span> len1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> distinct_signs<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="var">?signs</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> distinct_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> ex_q<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="main">(</span><span class="bound">q</span><span class="main">::</span>real poly<span class="main">)</span><span class="main">.</span> <span class="free">qs</span> <span class="main">=</span> <span class="main">[</span><span class="bound">q</span><span class="main">]</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> len1    
    <span class="keyword1"><span class="command">using</span></span> length_Suc_conv<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">qs</span></span> <span class="quoted"><span class="main">0</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> all_info<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>characterize_consistent_signs_at_roots_copr <span class="free">p</span> <span class="free">qs</span><span class="main">)</span> <span class="main">⊆</span> set<span class="main">(</span><span class="var">?signs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms base_case_sgas <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> in_mono insertE insert_absorb insert_not_empty member_rec<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span> 
  <span class="keyword1"><span class="command">have</span></span> match<span class="main">:</span> <span class="quoted"><span class="quoted">"satisfy_equation <span class="free">p</span> <span class="free">qs</span> <span class="var">?subsets</span> <span class="var">?signs</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ex_q base_case_satisfy_equation nonzero pairwise_rel_prime
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> member_rec<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span> 
  <span class="keyword1"><span class="command">have</span></span> invertible_mat<span class="main">:</span> <span class="quoted"><span class="quoted">"invertible_mat <span class="main">(</span>matrix_A <span class="var">?signs</span> <span class="var">?subsets</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> inverse_mat_base_case inverse_mat_base_case_2 <span class="keyword1"><span class="command">unfolding</span></span> invertible_mat_def <span class="keyword1"><span class="command">using</span></span> mat_base_case 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> h<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>get_signs <span class="main">(</span>reduce_system <span class="free">p</span> <span class="main">(</span><span class="free">qs</span><span class="main">,</span> <span class="main">(</span><span class="main">(</span>matrix_A <span class="var">?signs</span> <span class="var">?subsets</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="var">?subsets</span><span class="main">,</span> <span class="var">?signs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
    set <span class="main">(</span>characterize_consistent_signs_at_roots_copr <span class="free">p</span> <span class="free">qs</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> nonzero nonzero well_def_signs distinct_signs all_info match invertible_mat
      reduce_system_sign_conditions<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> p <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span>"</span></span><span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> qs <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="free">qs</span>"</span></span><span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> signs <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">[</span><span class="main">1</span><span class="main">]</span><span class="main">,</span><span class="main">[</span><span class="main">-</span><span class="main">1</span><span class="main">]</span><span class="main">]</span>"</span></span><span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> subsets <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">[]</span><span class="main">,</span><span class="main">[</span><span class="main">0</span><span class="main">]</span><span class="main">]</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span>  <span class="quoted"><span class="quoted">"set <span class="main">(</span>snd <span class="main">(</span>snd <span class="main">(</span>reduce_system <span class="free">p</span> <span class="main">(</span><span class="free">qs</span><span class="main">,</span> <span class="main">(</span><span class="main">(</span>mat_of_rows_list <span class="numeral">2</span> <span class="main">[</span><span class="main">[</span><span class="main">1</span><span class="main">,</span><span class="main">1</span><span class="main">]</span><span class="main">,</span> <span class="main">[</span><span class="main">1</span><span class="main">,</span><span class="main">-</span><span class="main">1</span><span class="main">]</span><span class="main">]</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="main">[</span><span class="main">[]</span><span class="main">,</span><span class="main">[</span><span class="main">0</span><span class="main">]</span><span class="main">]</span><span class="main">,</span> <span class="main">[</span><span class="main">[</span><span class="main">1</span><span class="main">]</span><span class="main">,</span><span class="main">[</span><span class="main">-</span><span class="main">1</span><span class="main">]</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
    set <span class="main">(</span>characterize_consistent_signs_at_roots_copr <span class="free">p</span> <span class="free">qs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> get_signs_def <span class="keyword1"><span class="command">using</span></span> mat_help <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>snd <span class="main">(</span>snd <span class="main">(</span>reduce_system <span class="free">p</span> <span class="main">(</span><span class="free">qs</span><span class="main">,</span> base_case_info<span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> set <span class="main">(</span>characterize_consistent_signs_at_roots_copr <span class="free">p</span> <span class="free">qs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> base_case_info_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> len1
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> find_consistent_signs_at_roots_thm<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1" id="BKR_Proofs-smaller_sys_are_good"><span class="command">lemma</span></span> smaller_sys_are_good<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">p</span><span class="main">::</span> <span class="quoted"><span class="quoted">"real poly"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">qs1</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real poly list"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">qs2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real poly list"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">subsets</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat list list"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">signs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"rat list list"</span></span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> nonzero<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> nontriv1<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">qs1</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> pairwise_rel_prime1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">q</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span>List.member <span class="free">qs1</span> <span class="bound">q</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">(</span>coprime <span class="free">p</span> <span class="bound">q</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> nontriv2<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">qs2</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> pairwise_rel_prime2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">q</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span>List.member <span class="free">qs2</span> <span class="bound">q</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">(</span>coprime <span class="free">p</span> <span class="bound">q</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"set<span class="main">(</span>find_consistent_signs_at_roots <span class="free">p</span> <span class="free">qs1</span><span class="main">)</span> <span class="main">=</span> set<span class="main">(</span>characterize_consistent_signs_at_roots_copr <span class="free">p</span> <span class="free">qs1</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"set<span class="main">(</span>find_consistent_signs_at_roots <span class="free">p</span> <span class="free">qs2</span><span class="main">)</span> <span class="main">=</span> set<span class="main">(</span>characterize_consistent_signs_at_roots_copr <span class="free">p</span> <span class="free">qs2</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"set<span class="main">(</span>snd<span class="main">(</span>snd<span class="main">(</span>reduce_system <span class="free">p</span> <span class="main">(</span>combine_systems <span class="free">p</span> <span class="main">(</span><span class="free">qs1</span><span class="main">,</span>calculate_data <span class="free">p</span> <span class="free">qs1</span><span class="main">)</span> <span class="main">(</span><span class="free">qs2</span><span class="main">,</span>calculate_data <span class="free">p</span> <span class="free">qs2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
    <span class="main">=</span> set<span class="main">(</span>characterize_consistent_signs_at_roots_copr <span class="free">p</span> <span class="main">(</span><span class="free">qs1</span><span class="main">@</span><span class="free">qs2</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?signs</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>get_signs <span class="main">(</span>snd <span class="main">(</span><span class="main">(</span>combine_systems <span class="free">p</span> <span class="main">(</span><span class="free">qs1</span><span class="main">,</span>calculate_data <span class="free">p</span> <span class="free">qs1</span><span class="main">)</span> <span class="main">(</span><span class="free">qs2</span><span class="main">,</span>calculate_data <span class="free">p</span> <span class="free">qs2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> "</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?subsets</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>get_subsets <span class="main">(</span>snd <span class="main">(</span><span class="main">(</span>combine_systems <span class="free">p</span> <span class="main">(</span><span class="free">qs1</span><span class="main">,</span>calculate_data <span class="free">p</span> <span class="free">qs1</span><span class="main">)</span> <span class="main">(</span><span class="free">qs2</span><span class="main">,</span>calculate_data <span class="free">p</span> <span class="free">qs2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> "</span></span>
  <span class="keyword1"><span class="command">have</span></span> h0<span class="main">:</span> <span class="quoted"><span class="quoted">"satisfies_properties <span class="free">p</span> <span class="main">(</span><span class="free">qs1</span><span class="main">@</span><span class="free">qs2</span><span class="main">)</span> <span class="var">?subsets</span> <span class="var">?signs</span>
    <span class="main">(</span>get_matrix <span class="main">(</span>snd <span class="main">(</span><span class="main">(</span>combine_systems <span class="free">p</span> <span class="main">(</span><span class="free">qs1</span><span class="main">,</span>calculate_data <span class="free">p</span> <span class="free">qs1</span><span class="main">)</span> <span class="main">(</span><span class="free">qs2</span><span class="main">,</span>calculate_data <span class="free">p</span> <span class="free">qs2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> calculate_data_satisfies_properties combining_sys_satisfies_properties
    <span class="keyword1"><span class="command">using</span></span> nontriv1 nontriv2 nonzero pairwise_rel_prime1 pairwise_rel_prime2 nonzero
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> h1<span class="main">:</span> <span class="quoted"><span class="quoted">"set<span class="main">(</span>characterize_consistent_signs_at_roots_copr <span class="free">p</span> <span class="main">(</span><span class="free">qs1</span><span class="main">@</span><span class="free">qs2</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> set <span class="var">?signs</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> satisfies_properties_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span> 
  <span class="keyword1"><span class="command">have</span></span> h2<span class="main">:</span> <span class="quoted"><span class="quoted">"well_def_signs <span class="main">(</span>length <span class="main">(</span><span class="free">qs1</span><span class="main">@</span><span class="free">qs2</span><span class="main">)</span><span class="main">)</span> <span class="var">?signs</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> calculate_data_satisfies_properties
    <span class="keyword1"><span class="command">using</span></span> h0 satisfies_properties_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
  <span class="keyword1"><span class="command">have</span></span> h3<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="var">?signs</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> calculate_data_satisfies_properties
    <span class="keyword1"><span class="command">using</span></span> h0 satisfies_properties_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
  <span class="keyword1"><span class="command">have</span></span> h4<span class="main">:</span> <span class="quoted"><span class="quoted">"satisfy_equation <span class="free">p</span> <span class="main">(</span><span class="free">qs1</span><span class="main">@</span><span class="free">qs2</span><span class="main">)</span> <span class="var">?subsets</span> <span class="var">?signs</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> calculate_data_satisfies_properties
    <span class="keyword1"><span class="command">using</span></span> h0 satisfies_properties_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
  <span class="keyword1"><span class="command">have</span></span> h5<span class="main">:</span> <span class="quoted"><span class="quoted">"invertible_mat <span class="main">(</span>matrix_A <span class="var">?signs</span> <span class="var">?subsets</span><span class="main">)</span> "</span></span>
    <span class="keyword1"><span class="command">using</span></span> calculate_data_satisfies_properties  
    <span class="keyword1"><span class="command">using</span></span> h0 satisfies_properties_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> h<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>take_indices <span class="var">?signs</span> 
            <span class="main">(</span>find_nonzeros_from_input_vec <span class="main">(</span>solve_for_lhs <span class="free">p</span> <span class="main">(</span><span class="free">qs1</span><span class="main">@</span><span class="free">qs2</span><span class="main">)</span> <span class="var">?subsets</span>  <span class="main">(</span>matrix_A <span class="var">?signs</span> <span class="var">?subsets</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
        <span class="main">=</span>  set<span class="main">(</span>characterize_consistent_signs_at_roots_copr <span class="free">p</span> <span class="main">(</span><span class="free">qs1</span><span class="main">@</span><span class="free">qs2</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> h1 h2 h3 h4 h5 reduction_deletes_bad_sign_conds
    <span class="keyword1"><span class="command">using</span></span> nonzero nonzero reduction_signs_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> h<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>characterize_consistent_signs_at_roots_copr <span class="free">p</span> <span class="main">(</span><span class="free">qs1</span><span class="main">@</span><span class="free">qs2</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
    set <span class="main">(</span>reduction_signs <span class="free">p</span> <span class="main">(</span><span class="free">qs1</span><span class="main">@</span><span class="free">qs2</span><span class="main">)</span> <span class="var">?signs</span> <span class="var">?subsets</span>  <span class="main">(</span>matrix_A <span class="var">?signs</span> <span class="var">?subsets</span> <span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">unfolding</span></span> reduction_signs_def get_signs_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>  
  <span class="keyword1"><span class="command">have</span></span> help_h<span class="main">:</span> <span class="quoted"><span class="quoted">"reduction_signs <span class="free">p</span> <span class="main">(</span><span class="free">qs1</span><span class="main">@</span><span class="free">qs2</span><span class="main">)</span> <span class="var">?signs</span> <span class="var">?subsets</span>  <span class="main">(</span>matrix_A <span class="var">?signs</span> <span class="var">?subsets</span><span class="main">)</span> 
      <span class="main">=</span> <span class="main">(</span>take_indices <span class="var">?signs</span> <span class="main">(</span>find_nonzeros_from_input_vec <span class="main">(</span>solve_for_lhs <span class="free">p</span> <span class="main">(</span><span class="free">qs1</span><span class="main">@</span><span class="free">qs2</span><span class="main">)</span> <span class="var">?subsets</span>  <span class="main">(</span>matrix_A <span class="var">?signs</span> <span class="var">?subsets</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> reduction_signs_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> clear_signs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>signs_smash <span class="main">(</span>get_signs <span class="main">(</span>calculate_data <span class="free">p</span> <span class="free">qs1</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>get_signs <span class="main">(</span>calculate_data <span class="free">p</span> <span class="free">qs2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>get_signs <span class="main">(</span>snd <span class="main">(</span><span class="main">(</span>combine_systems <span class="free">p</span> <span class="main">(</span><span class="free">qs1</span><span class="main">,</span>calculate_data <span class="free">p</span> <span class="free">qs1</span><span class="main">)</span> <span class="main">(</span><span class="free">qs2</span><span class="main">,</span>calculate_data <span class="free">p</span> <span class="free">qs2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> combining_to_smash get_signs_def getter_functions smash_systems_def snd_conv<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> clear_subsets<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>subsets_smash <span class="main">(</span>length <span class="free">qs1</span><span class="main">)</span> <span class="main">(</span>get_subsets<span class="main">(</span>calculate_data <span class="free">p</span> <span class="free">qs1</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>get_subsets <span class="main">(</span>calculate_data <span class="free">p</span> <span class="free">qs2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>get_subsets <span class="main">(</span>snd <span class="main">(</span><span class="main">(</span>combine_systems <span class="free">p</span> <span class="main">(</span><span class="free">qs1</span><span class="main">,</span>calculate_data <span class="free">p</span> <span class="free">qs1</span><span class="main">)</span> <span class="main">(</span><span class="free">qs2</span><span class="main">,</span>calculate_data <span class="free">p</span> <span class="free">qs2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> Pair_inject combining_to_smash get_subsets_def prod.collapse smash_systems_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"well_def_signs <span class="main">(</span>length <span class="free">qs1</span><span class="main">)</span> <span class="main">(</span>get_signs <span class="main">(</span>calculate_data <span class="free">p</span> <span class="free">qs1</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> calculate_data_satisfies_properties
    <span class="keyword1"><span class="command">using</span></span> nontriv1 nonzero pairwise_rel_prime1 nonzero satisfies_properties_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> well_def_signs1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">j</span><span class="main">.</span> <span class="bound">j</span> <span class="main">∈</span> set <span class="main">(</span>get_signs <span class="main">(</span>calculate_data <span class="free">p</span> <span class="free">qs1</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> length <span class="bound">j</span> <span class="main">=</span> <span class="main">(</span>length <span class="free">qs1</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> well_def_signs_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"all_list_constr <span class="main">(</span>get_subsets<span class="main">(</span>calculate_data <span class="free">p</span> <span class="free">qs1</span><span class="main">)</span><span class="main">)</span>  <span class="main">(</span>length <span class="free">qs1</span><span class="main">)</span> "</span></span>
    <span class="keyword1"><span class="command">using</span></span> calculate_data_satisfies_properties
    <span class="keyword1"><span class="command">using</span></span> nontriv1 nonzero pairwise_rel_prime1 nonzero satisfies_properties_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> well_def_subsets1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">l</span> <span class="bound">i</span><span class="main">.</span> <span class="bound">l</span> <span class="main">∈</span> set <span class="main">(</span>get_subsets<span class="main">(</span>calculate_data <span class="free">p</span> <span class="free">qs1</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> <span class="bound">i</span> <span class="main">∈</span> set <span class="bound">l</span> <span class="main">⟹</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="main">(</span>length <span class="free">qs1</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> all_list_constr_def list_constr_def <span class="keyword1"><span class="command">using</span></span> in_set_member
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> in_set_conv_nth list_all_length<span class="main">)</span> 
  <span class="keyword1"><span class="command">have</span></span> extra_matrix_same<span class="main">:</span> <span class="quoted"><span class="quoted">"matrix_A <span class="main">(</span>signs_smash <span class="main">(</span>get_signs <span class="main">(</span>calculate_data <span class="free">p</span> <span class="free">qs1</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>get_signs <span class="main">(</span>calculate_data <span class="free">p</span> <span class="free">qs2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
         <span class="main">(</span>subsets_smash <span class="main">(</span>length <span class="free">qs1</span><span class="main">)</span> <span class="main">(</span>get_subsets<span class="main">(</span>calculate_data <span class="free">p</span> <span class="free">qs1</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>get_subsets <span class="main">(</span>calculate_data <span class="free">p</span> <span class="free">qs2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> 
        <span class="main">=</span> kronecker_product <span class="main">(</span>get_matrix <span class="main">(</span>calculate_data <span class="free">p</span> <span class="free">qs1</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>get_matrix <span class="main">(</span>calculate_data <span class="free">p</span> <span class="free">qs2</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span>  well_def_signs1 well_def_subsets1
    <span class="keyword1"><span class="command">using</span></span> matrix_construction_is_kronecker_product
    <span class="keyword1"><span class="command">using</span></span> calculate_data_satisfies_properties nontriv1 nontriv2 nonzero pairwise_rel_prime1 pairwise_rel_prime2 nonzero satisfies_properties_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> matrix_same<span class="main">:</span> <span class="quoted"><span class="quoted">"matrix_A <span class="var">?signs</span> <span class="var">?subsets</span> <span class="main">=</span> kronecker_product <span class="main">(</span>get_matrix <span class="main">(</span>calculate_data <span class="free">p</span> <span class="free">qs1</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>get_matrix <span class="main">(</span>calculate_data <span class="free">p</span> <span class="free">qs2</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> clear_signs clear_subsets
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> comb_sys_h<span class="main">:</span> <span class="quoted"><span class="quoted">"snd<span class="main">(</span>snd<span class="main">(</span>reduce_system <span class="free">p</span> <span class="main">(</span>combine_systems <span class="free">p</span> <span class="main">(</span><span class="free">qs1</span><span class="main">,</span>calculate_data <span class="free">p</span> <span class="free">qs1</span><span class="main">)</span> <span class="main">(</span><span class="free">qs2</span><span class="main">,</span>calculate_data <span class="free">p</span> <span class="free">qs2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
      snd<span class="main">(</span>snd<span class="main">(</span>reduce_system <span class="free">p</span> <span class="main">(</span><span class="free">qs1</span><span class="main">@</span><span class="free">qs2</span><span class="main">,</span> <span class="main">(</span>matrix_A <span class="var">?signs</span> <span class="var">?subsets</span><span class="main">,</span> <span class="main">(</span><span class="var">?subsets</span><span class="main">,</span> <span class="var">?signs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> get_signs_def get_subsets_def <span class="keyword1"><span class="command">using</span></span> matrix_same
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> combining_to_smash get_signs_def get_subsets_def getter_functions prod.collapse prod.inject smash_systems_def<span class="main">)</span>   
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> extra_h<span class="main">:</span> <span class="quoted"><span class="quoted">" snd<span class="main">(</span>snd<span class="main">(</span>reduce_system <span class="free">p</span> <span class="main">(</span><span class="free">qs1</span><span class="main">@</span><span class="free">qs2</span><span class="main">,</span> <span class="main">(</span>matrix_A <span class="var">?signs</span> <span class="var">?subsets</span><span class="main">,</span> <span class="main">(</span><span class="var">?subsets</span><span class="main">,</span> <span class="var">?signs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
      snd<span class="main">(</span>snd<span class="main">(</span>reduction_step <span class="main">(</span>matrix_A <span class="var">?signs</span> <span class="var">?subsets</span><span class="main">)</span> <span class="var">?signs</span> <span class="var">?subsets</span> <span class="main">(</span>solve_for_lhs <span class="free">p</span> <span class="main">(</span><span class="free">qs1</span><span class="main">@</span><span class="free">qs2</span><span class="main">)</span> <span class="var">?subsets</span> <span class="main">(</span>matrix_A <span class="var">?signs</span> <span class="var">?subsets</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> "</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> same_h<span class="main">:</span> <span class="quoted"><span class="quoted">"set<span class="main">(</span>snd<span class="main">(</span>snd<span class="main">(</span>reduce_system <span class="free">p</span> <span class="main">(</span>combine_systems <span class="free">p</span> <span class="main">(</span><span class="free">qs1</span><span class="main">,</span>calculate_data <span class="free">p</span> <span class="free">qs1</span><span class="main">)</span> <span class="main">(</span><span class="free">qs2</span><span class="main">,</span>calculate_data <span class="free">p</span> <span class="free">qs2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> 
      <span class="main">=</span> set <span class="main">(</span>reduction_signs <span class="free">p</span> <span class="main">(</span><span class="free">qs1</span><span class="main">@</span><span class="free">qs2</span><span class="main">)</span> <span class="var">?signs</span> <span class="var">?subsets</span>  <span class="main">(</span>matrix_A <span class="var">?signs</span> <span class="var">?subsets</span> <span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> comb_sys_h <span class="keyword1"><span class="command">unfolding</span></span> reduction_signs_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> get_signs_def help_h reduction_signs_is_get_signs<span class="main">)</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> h
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="BKR_Proofs-find_consistent_signs_at_roots_1"><span class="command">lemma</span></span> find_consistent_signs_at_roots_1<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">p</span><span class="main">::</span> <span class="quoted"><span class="quoted">"real poly"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">qs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real poly list"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">p</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">∧</span> length <span class="free">qs</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">∧</span>
    <span class="main">(</span><span class="main">∀</span><span class="bound">q</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span>List.member <span class="free">qs</span> <span class="bound">q</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">(</span>coprime <span class="free">p</span> <span class="bound">q</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span> 
    set<span class="main">(</span>find_consistent_signs_at_roots <span class="free">p</span> <span class="free">qs</span><span class="main">)</span> <span class="main">=</span> set<span class="main">(</span>characterize_consistent_signs_at_roots_copr <span class="free">p</span> <span class="free">qs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="quoted">"length <span class="free">qs</span>"</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">qs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> less_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> less 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">clarsimp</span>
    <span class="keyword3"><span class="command">assume</span></span> ind_hyp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">qsa</span><span class="main">.</span>
        length <span class="bound">qsa</span> <span class="main">&lt;</span> length <span class="skolem">qs</span> <span class="main">⟹</span> <span class="bound">qsa</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">q</span><span class="main">.</span> List.member <span class="bound">qsa</span> <span class="bound">q</span> <span class="main">⟶</span> coprime <span class="free">p</span> <span class="bound">q</span><span class="main">)</span> <span class="main">⟶</span>
        set <span class="main">(</span>find_consistent_signs_at_roots <span class="free">p</span> <span class="bound">qsa</span><span class="main">)</span> <span class="main">=</span>
        set <span class="main">(</span>characterize_consistent_signs_at_roots_copr <span class="free">p</span> <span class="bound">qsa</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> nonzero<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>  
    <span class="keyword3"><span class="command">assume</span></span> nontriv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">qs</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> copr<span class="main">:</span><span class="quoted"><span class="quoted">" <span class="main">∀</span><span class="bound">q</span><span class="main">.</span> List.member <span class="skolem">qs</span> <span class="bound">q</span> <span class="main">⟶</span> coprime <span class="free">p</span> <span class="bound">q</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?len</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"length <span class="skolem">qs</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?q1</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"take <span class="main">(</span><span class="main">(</span><span class="var">?len</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="skolem">qs</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?left</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"calculate_data <span class="free">p</span> <span class="var">?q1</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?q2</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"drop <span class="main">(</span><span class="main">(</span><span class="var">?len</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="skolem">qs</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?right</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"calculate_data <span class="free">p</span> <span class="var">?q2</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> nontriv_q1<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="skolem">qs</span><span class="main">&gt;</span><span class="main">1</span> <span class="main">⟶</span> length <span class="var">?q1</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> qs_more_q1<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="skolem">qs</span><span class="main">&gt;</span><span class="main">1</span> <span class="main">⟶</span> length <span class="skolem">qs</span> <span class="main">&gt;</span> length <span class="var">?q1</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> pairwise_rel_prime_q1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">q</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span>List.member <span class="var">?q1</span> <span class="bound">q</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">(</span>coprime <span class="free">p</span> <span class="bound">q</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">clarsimp</span> 
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">q</span> 
      <span class="keyword3"><span class="command">assume</span></span> mem<span class="main">:</span> <span class="quoted"><span class="quoted">"List.member <span class="main">(</span>take <span class="main">(</span>length <span class="skolem">qs</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="skolem">qs</span><span class="main">)</span> <span class="skolem">q</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"List.member <span class="skolem">qs</span> <span class="skolem">q</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> mem set_take_subset<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> n <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">qs</span> <span class="keyword1">div</span> <span class="numeral">2</span>"</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> <span class="quoted"><span class="quoted">‹List.member <span class="main">(</span>take <span class="main">(</span>length <span class="skolem">qs</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="skolem">qs</span><span class="main">)</span> <span class="skolem">q</span>›</span></span> in_set_member in_set_takeD<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>  
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"coprime <span class="free">p</span> <span class="skolem">q</span>"</span></span> 
        <span class="keyword1"><span class="command">using</span></span> copr <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">have</span></span> nontriv_q2<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="skolem">qs</span><span class="main">&gt;</span><span class="main">1</span> <span class="main">⟶</span>length <span class="var">?q2</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> qs_more_q2<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="skolem">qs</span><span class="main">&gt;</span><span class="main">1</span> <span class="main">⟶</span> length <span class="skolem">qs</span> <span class="main">&gt;</span> length <span class="var">?q2</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> pairwise_rel_prime_q2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">q</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span>List.member <span class="var">?q2</span> <span class="bound">q</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">(</span>coprime <span class="free">p</span> <span class="bound">q</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">clarsimp</span> 
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">q</span> 
      <span class="keyword3"><span class="command">assume</span></span> mem<span class="main">:</span> <span class="quoted"><span class="quoted">"List.member <span class="main">(</span>drop <span class="main">(</span>length <span class="skolem">qs</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="skolem">qs</span><span class="main">)</span> <span class="skolem">q</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"List.member <span class="skolem">qs</span> <span class="skolem">q</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> mem set_take_subset<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> n <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">qs</span> <span class="keyword1">div</span> <span class="numeral">2</span>"</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> <span class="quoted"><span class="quoted">‹List.member <span class="main">(</span>drop <span class="main">(</span>length <span class="skolem">qs</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="skolem">qs</span><span class="main">)</span> <span class="skolem">q</span>›</span></span> in_set_dropD in_set_member<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"coprime <span class="free">p</span> <span class="skolem">q</span>"</span></span> 
        <span class="keyword1"><span class="command">using</span></span> copr <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">have</span></span> key_h<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>snd <span class="main">(</span>snd <span class="main">(</span><span class="keyword1">if</span> <span class="var">?len</span> <span class="main">≤</span> Suc <span class="main">0</span> <span class="keyword1">then</span> reduce_system <span class="free">p</span> <span class="main">(</span><span class="skolem">qs</span><span class="main">,</span> base_case_info<span class="main">)</span>
                        <span class="keyword1">else</span>   Let <span class="main">(</span>combine_systems <span class="free">p</span> <span class="main">(</span><span class="var">?q1</span><span class="main">,</span> <span class="var">?left</span><span class="main">)</span> <span class="main">(</span><span class="var">?q2</span><span class="main">,</span> <span class="var">?right</span><span class="main">)</span><span class="main">)</span>
                                  <span class="main">(</span>reduce_system <span class="free">p</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
       set <span class="main">(</span>characterize_consistent_signs_at_roots_copr <span class="free">p</span> <span class="skolem">qs</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
      <span class="keyword1"><span class="command">have</span></span> h_len1 <span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?len</span> <span class="main">=</span> <span class="main">1</span> <span class="main">⟶</span> set <span class="main">(</span>snd <span class="main">(</span>snd <span class="main">(</span><span class="keyword1">if</span> <span class="var">?len</span> <span class="main">≤</span> Suc <span class="main">0</span> <span class="keyword1">then</span> reduce_system <span class="free">p</span> <span class="main">(</span><span class="skolem">qs</span><span class="main">,</span> base_case_info<span class="main">)</span>
                        <span class="keyword1">else</span>   Let <span class="main">(</span>combine_systems <span class="free">p</span> <span class="main">(</span><span class="var">?q1</span><span class="main">,</span> <span class="var">?left</span><span class="main">)</span> <span class="main">(</span><span class="var">?q2</span><span class="main">,</span> <span class="var">?right</span><span class="main">)</span><span class="main">)</span>
                                  <span class="main">(</span>reduce_system <span class="free">p</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
       set <span class="main">(</span>characterize_consistent_signs_at_roots_copr <span class="free">p</span> <span class="skolem">qs</span><span class="main">)</span>"</span></span> 
        <span class="keyword1"><span class="command">using</span></span> find_consistent_signs_at_roots_len1<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">p</span></span> <span class="quoted"><span class="skolem">qs</span></span><span class="main">]</span> copr nonzero nontriv
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> find_consistent_signs_at_roots_thm<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> h_len_gt1 <span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?len</span> <span class="main">&gt;</span> <span class="main">1</span> <span class="main">⟶</span> set <span class="main">(</span>snd <span class="main">(</span>snd <span class="main">(</span><span class="keyword1">if</span> <span class="var">?len</span> <span class="main">≤</span> Suc <span class="main">0</span> <span class="keyword1">then</span> reduce_system <span class="free">p</span> <span class="main">(</span><span class="skolem">qs</span><span class="main">,</span> base_case_info<span class="main">)</span>
                        <span class="keyword1">else</span>   Let <span class="main">(</span>combine_systems <span class="free">p</span> <span class="main">(</span><span class="var">?q1</span><span class="main">,</span> <span class="var">?left</span><span class="main">)</span> <span class="main">(</span><span class="var">?q2</span><span class="main">,</span> <span class="var">?right</span><span class="main">)</span><span class="main">)</span>
                                  <span class="main">(</span>reduce_system <span class="free">p</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
       set <span class="main">(</span>characterize_consistent_signs_at_roots_copr <span class="free">p</span> <span class="skolem">qs</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
        <span class="keyword1"><span class="command">have</span></span> h_imp_a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?len</span> <span class="main">&gt;</span> <span class="main">1</span> <span class="main">⟶</span> set <span class="main">(</span>snd <span class="main">(</span>snd <span class="main">(</span>reduce_system <span class="free">p</span> <span class="main">(</span>combine_systems <span class="free">p</span> <span class="main">(</span><span class="var">?q1</span><span class="main">,</span> <span class="var">?left</span><span class="main">)</span> <span class="main">(</span><span class="var">?q2</span><span class="main">,</span> <span class="var">?right</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
              set <span class="main">(</span>characterize_consistent_signs_at_roots_copr <span class="free">p</span> <span class="skolem">qs</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
          <span class="keyword1"><span class="command">have</span></span> h1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?len</span> <span class="main">&gt;</span> <span class="main">1</span> <span class="main">⟶</span> set<span class="main">(</span>snd<span class="main">(</span>snd<span class="main">(</span><span class="var">?left</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> set <span class="main">(</span>characterize_consistent_signs_at_roots_copr <span class="free">p</span> <span class="var">?q1</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> nontriv_q1 pairwise_rel_prime_q1 ind_hyp<span class="main">[</span><span class="operator">of</span> <span class="var"><span class="quoted"><span class="var">?q1</span></span></span><span class="main">]</span> qs_more_q1             <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> find_consistent_signs_at_roots_thm less_numeral_extra<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> list.size<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command">have</span></span> h2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?len</span> <span class="main">&gt;</span> <span class="main">1</span> <span class="main">⟶</span> set<span class="main">(</span>snd<span class="main">(</span>snd<span class="main">(</span><span class="var">?right</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> set <span class="main">(</span>characterize_consistent_signs_at_roots_copr <span class="free">p</span> <span class="var">?q2</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> nontriv_q2 pairwise_rel_prime_q2 ind_hyp<span class="main">[</span><span class="operator">of</span> <span class="var"><span class="quoted"><span class="var">?q2</span></span></span><span class="main">]</span> qs_more_q2
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> find_consistent_signs_at_roots_thm list.size<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> not_less_zero<span class="main">)</span>
          <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> nonzero nontriv_q1 pairwise_rel_prime_q1 nontriv_q2 pairwise_rel_prime_q2 h1 h2
              smaller_sys_are_good
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> append_take_drop_id find_consistent_signs_at_roots_thm<span class="main">)</span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> h_imp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?len</span> <span class="main">&gt;</span> <span class="main">1</span> <span class="main">⟶</span> set <span class="main">(</span>snd <span class="main">(</span>snd <span class="main">(</span>Let <span class="main">(</span>combine_systems <span class="free">p</span> <span class="main">(</span><span class="var">?q1</span><span class="main">,</span> <span class="var">?left</span><span class="main">)</span> <span class="main">(</span><span class="var">?q2</span><span class="main">,</span> <span class="var">?right</span><span class="main">)</span><span class="main">)</span>
                                  <span class="main">(</span>reduce_system <span class="free">p</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
       set <span class="main">(</span>characterize_consistent_signs_at_roots_copr <span class="free">p</span> <span class="skolem">qs</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> h_len1 h_len_gt1
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> <span class="quoted"><span class="quoted">‹<span class="skolem">qs</span> <span class="main">≠</span> <span class="main">[]</span>›</span></span> length_0_conv less_one nat_neq_iff<span class="main">)</span> 
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>find_consistent_signs_at_roots <span class="free">p</span> <span class="skolem">qs</span><span class="main">)</span> <span class="main">=</span> set <span class="main">(</span>characterize_consistent_signs_at_roots_copr <span class="free">p</span> <span class="skolem">qs</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> One_nat_def calculate_data.simps find_consistent_signs_at_roots_thm length_0_conv nontriv<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="BKR_Proofs-find_consistent_signs_at_roots_0"><span class="command">lemma</span></span> find_consistent_signs_at_roots_0<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">p</span><span class="main">::</span> <span class="quoted"><span class="quoted">"real poly"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"set<span class="main">(</span>find_consistent_signs_at_roots <span class="free">p</span> <span class="main">[]</span><span class="main">)</span> <span class="main">=</span>
         set<span class="main">(</span>characterize_consistent_signs_at_roots_copr <span class="free">p</span> <span class="main">[]</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="skolem"><span class="skolem">b</span></span> <span class="skolem"><span class="skolem">c</span></span> <span class="keyword2"><span class="keyword">where</span></span> abc<span class="main">:</span> <span class="quoted"><span class="quoted">"reduce_system <span class="free">p</span> <span class="main">(</span><span class="main">[</span><span class="main">1</span><span class="main">]</span><span class="main">,</span> base_case_info<span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">a</span><span class="main">,</span><span class="skolem">b</span><span class="main">,</span><span class="skolem">c</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> prod_cases3 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"find_consistent_signs_at_roots <span class="free">p</span> <span class="main">[</span><span class="main">1</span><span class="main">]</span> <span class="main">=</span> <span class="skolem">c</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> abc
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> find_consistent_signs_at_roots_thm<span class="main">)</span> 
  <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>find_consistent_signs_at_roots <span class="free">p</span> <span class="main">[</span><span class="main">1</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> set <span class="main">(</span>characterize_consistent_signs_at_roots_copr <span class="free">p</span> <span class="main">[</span><span class="main">1</span><span class="main">]</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> find_consistent_signs_at_roots_1<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> member_rec<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> member_rec<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set<span class="main">(</span>characterize_consistent_signs_at_roots_copr <span class="free">p</span> <span class="main">[]</span><span class="main">)</span> <span class="main">=</span> drop <span class="main">1</span> <span class="main">`</span> set<span class="main">(</span>characterize_consistent_signs_at_roots_copr <span class="free">p</span> <span class="main">[</span><span class="main">1</span><span class="main">]</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> characterize_consistent_signs_at_roots_copr_def consistent_sign_vec_copr_def <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> drop0 drop_Suc_Cons image_cong image_image<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> abc *
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> find_consistent_signs_at_roots_thm<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> find_consistent_signs_at_roots_thm<span class="main">)</span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="BKR_Proofs-find_consistent_signs_at_roots_copr"><span class="command">lemma</span></span> find_consistent_signs_at_roots_copr<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">p</span><span class="main">::</span> <span class="quoted"><span class="quoted">"real poly"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">qs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real poly list"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">q</span><span class="main">.</span> <span class="bound">q</span> <span class="main">∈</span> set <span class="free">qs</span> <span class="main">⟹</span> coprime <span class="free">p</span> <span class="bound">q</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"set<span class="main">(</span>find_consistent_signs_at_roots <span class="free">p</span> <span class="free">qs</span><span class="main">)</span> <span class="main">=</span> set<span class="main">(</span>characterize_consistent_signs_at_roots_copr <span class="free">p</span> <span class="free">qs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms find_consistent_signs_at_roots_0 find_consistent_signs_at_roots_1 in_set_member length_greater_0_conv<span class="main">)</span>

<span class="keyword1" id="BKR_Proofs-find_consistent_signs_at_roots"><span class="command">lemma</span></span> find_consistent_signs_at_roots<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">p</span><span class="main">::</span> <span class="quoted"><span class="quoted">"real poly"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">qs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real poly list"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">q</span><span class="main">.</span> <span class="bound">q</span> <span class="main">∈</span> set <span class="free">qs</span> <span class="main">⟹</span> coprime <span class="free">p</span> <span class="bound">q</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"set<span class="main">(</span>find_consistent_signs_at_roots <span class="free">p</span> <span class="free">qs</span><span class="main">)</span> <span class="main">=</span> set<span class="main">(</span>characterize_consistent_signs_at_roots <span class="free">p</span> <span class="free">qs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms find_consistent_signs_at_roots_copr csa_list_copr_rel
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> in_set_member<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="BKR_Decision">
<div class="head">
<h1>Theory BKR_Decision</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> BKR_Decision
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="#BKR_Algorithm">BKR_Algorithm</a>
    <span class="quoted">"<a href="../../berlekamp_zassenhaus/theories/#Factorize_Rat_Poly">Berlekamp_Zassenhaus.Factorize_Rat_Poly</a>"</span>
    <span class="quoted">"<a href="../../algebraic_numbers/theories/#Real_Roots">Algebraic_Numbers.Real_Roots</a>"</span>
    <span class="quoted">"<a href="#BKR_Proofs">BKR_Proofs</a>"</span>
    <span class="quoted">"<a href="https://www.cl.cam.ac.uk/research/hvg/Isabelle/dist/library/HOL/HOL/Deriv.html">HOL.Deriv</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">"Algorithm"</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Parsing"</span></span>
  <span class="comment1">(* Formula type *)</span>
<span class="keyword1"><span class="command">datatype</span></span> <span class="tfree">'a</span> fml <span class="main">=</span>
  And <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> fml"</span></span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> fml"</span></span>
  <span class="main">|</span> Or <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> fml"</span></span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> fml"</span></span>
  <span class="main">|</span> Gt <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span>   <span class="comment1">(* 'a &gt; 0 *)</span>
  <span class="main">|</span> Geq <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span>  <span class="comment1">(* 'a ≥ 0 *)</span>
  <span class="main">|</span> Lt <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span>   <span class="comment1">(* 'a &lt; 0 *)</span>
  <span class="main">|</span> Leq <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span>  <span class="comment1">(* 'a ≤ 0 *)</span>
  <span class="main">|</span> Eq <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span>   <span class="comment1">(* 'a = 0 *)</span>
  <span class="main">|</span> Neq <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span>  <span class="comment1">(* 'a ≠ 0 *)</span>

<span class="comment1">(* Evaluating a formula over a lookup semantics where 'a is nat *)</span>
<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">lookup_sem</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat fml <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>linordered_field list<span class="main">)</span> <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">lookup_sem</span> <span class="main">(</span>And <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ls</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="free">lookup_sem</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">ls</span></span></span> <span class="main">∧</span> <span class="free">lookup_sem</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">ls</span></span></span><span class="main">)</span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">lookup_sem</span> <span class="main">(</span>Or <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ls</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="free">lookup_sem</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">ls</span></span></span> <span class="main">∨</span> <span class="free">lookup_sem</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">ls</span></span></span><span class="main">)</span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">lookup_sem</span> <span class="main">(</span>Gt <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ls</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">ls</span></span></span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">&gt;</span> <span class="main">0</span><span class="main">)</span>"</span></span>  
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">lookup_sem</span> <span class="main">(</span>Geq <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ls</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">ls</span></span></span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">≥</span> <span class="main">0</span><span class="main">)</span>"</span></span> 
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">lookup_sem</span> <span class="main">(</span>Lt <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ls</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">ls</span></span></span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">&lt;</span> <span class="main">0</span><span class="main">)</span>"</span></span> 
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">lookup_sem</span> <span class="main">(</span>Leq <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ls</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">ls</span></span></span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">≤</span> <span class="main">0</span><span class="main">)</span>"</span></span> 
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">lookup_sem</span> <span class="main">(</span>Eq <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ls</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">ls</span></span></span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span>"</span></span> 
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">lookup_sem</span> <span class="main">(</span>Neq <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ls</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">ls</span></span></span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">≠</span> <span class="main">0</span><span class="main">)</span>"</span></span> 

<span class="comment1">(* (compute) all polynomials mentioned in a formula *)</span>
<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">poly_list</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> fml <span class="main">⇒</span> <span class="tfree">'a</span> list"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">poly_list</span> <span class="main">(</span>And <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">poly_list</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">@</span> <span class="free">poly_list</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span>"</span></span>  
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">poly_list</span> <span class="main">(</span>Or <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">poly_list</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">@</span> <span class="free">poly_list</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span>"</span></span>  
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">poly_list</span> <span class="main">(</span>Gt <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">]</span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">poly_list</span> <span class="main">(</span>Geq <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">]</span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">poly_list</span> <span class="main">(</span>Lt <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">]</span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">poly_list</span> <span class="main">(</span>Leq <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">]</span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">poly_list</span> <span class="main">(</span>Eq <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">]</span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">poly_list</span> <span class="main">(</span>Neq <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">]</span>"</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">index_of_aux</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> nat <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">index_of_aux</span> <span class="main">[]</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">index_of_aux</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span>
  <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="keyword1">else</span> <span class="free">index_of_aux</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">index_of</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">index_of</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">=</span> index_of_aux <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">0</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">convert</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> fml <span class="main">⇒</span> <span class="main">(</span>nat fml <span class="main">×</span> <span class="tfree">'a</span> list<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">convert</span> <span class="free"><span class="bound"><span class="entity">fml</span></span></span> <span class="main">=</span> <span class="main">(</span>
    <span class="keyword1">let</span> <span class="bound">ps</span> <span class="main">=</span> remdups <span class="main">(</span>poly_list <span class="free"><span class="bound"><span class="entity">fml</span></span></span><span class="main">)</span>
    <span class="keyword1">in</span>
    <span class="main">(</span>map_fml <span class="main">(</span>index_of <span class="bound">ps</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">fml</span></span></span><span class="main">,</span> <span class="bound">ps</span><span class="main">)</span>
  <span class="main">)</span>"</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Factoring"</span></span>

<span class="comment1">(* Makes sure the result of factorize_rat_poly is monic *)</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">factorize_rat_poly_monic</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"rat poly <span class="main">⇒</span> <span class="main">(</span>rat <span class="main">×</span> <span class="main">(</span>rat poly <span class="main">×</span> nat<span class="main">)</span> list<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">factorize_rat_poly_monic</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span> <span class="main">(</span>
    <span class="keyword1">let</span> <span class="main">(</span><span class="bound">c</span><span class="main">,</span><span class="bound">fs</span><span class="main">)</span> <span class="main">=</span>  factorize_rat_poly <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">;</span>
        <span class="bound">lcs</span> <span class="main">=</span> prod_list <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">f</span><span class="main">,</span><span class="bound">i</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span>lead_coeff <span class="bound">f</span><span class="main">)</span> <span class="main">^</span> Suc <span class="bound">i</span><span class="main">)</span> <span class="bound">fs</span><span class="main">)</span> <span class="main">;</span>
        <span class="bound">fs</span> <span class="main">=</span> map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">f</span><span class="main">,</span><span class="bound">i</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span>normalize <span class="bound">f</span><span class="main">,</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="bound">fs</span>
    <span class="keyword1">in</span>
    <span class="main">(</span><span class="bound">c</span> <span class="main">*</span> <span class="bound">lcs</span><span class="main">,</span><span class="bound">fs</span><span class="main">)</span>
  <span class="main">)</span>"</span></span>

<span class="comment1">(* Factoring an input list of polynomials *)</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">factorize_polys</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"rat poly list <span class="main">⇒</span> <span class="main">(</span>rat poly list <span class="main">×</span> <span class="main">(</span>rat <span class="main">×</span> <span class="main">(</span>nat <span class="main">×</span> nat<span class="main">)</span> list<span class="main">)</span> list<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">factorize_polys</span> <span class="free"><span class="bound"><span class="entity">ps</span></span></span> <span class="main">=</span> <span class="main">(</span>
    <span class="keyword1">let</span> <span class="bound">fact_ps</span> <span class="main">=</span> map factorize_rat_poly_monic <span class="free"><span class="bound"><span class="entity">ps</span></span></span><span class="main">;</span>
        <span class="bound">factors</span> <span class="main">=</span> remdups <span class="main">(</span>map fst <span class="main">(</span>concat <span class="main">(</span>map snd <span class="bound">fact_ps</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">;</span>
        <span class="bound">data</span> <span class="main">=</span> map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">c</span><span class="main">,</span><span class="bound">fs</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">c</span><span class="main">,</span> map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">f</span><span class="main">,</span><span class="bound">pow</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span>index_of <span class="bound">factors</span> <span class="bound">f</span><span class="main">,</span> <span class="bound">pow</span><span class="main">)</span> <span class="main">)</span> <span class="bound">fs</span><span class="main">)</span><span class="main">)</span> <span class="bound">fact_ps</span>
    <span class="keyword1">in</span>
      <span class="main">(</span><span class="bound">factors</span><span class="main">,</span><span class="bound">data</span><span class="main">)</span>
  <span class="main">)</span>"</span></span>

<span class="comment1">(* After turning a polynomial into factors,
  this turns a sign condition on the factors
  into a sign condition for the polynomial *)</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">undo_factorize</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"rat <span class="main">×</span> <span class="main">(</span>nat <span class="main">×</span> nat<span class="main">)</span> list <span class="main">⇒</span> rat list <span class="main">⇒</span> rat"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">undo_factorize</span> <span class="free"><span class="bound"><span class="entity">cfs</span></span></span> <span class="free"><span class="bound"><span class="entity">signs</span></span></span> <span class="main">=</span>
   squash
    <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">cfs</span></span></span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">c</span><span class="main">,</span><span class="bound">fs</span><span class="main">)</span> <span class="main">⇒</span>
    <span class="main">(</span><span class="bound">c</span> <span class="main">*</span> prod_list <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">f</span><span class="main">,</span><span class="bound">pow</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">signs</span></span></span> <span class="main">!</span> <span class="bound">f</span><span class="main">)</span> <span class="main">^</span> Suc <span class="bound">pow</span><span class="main">)</span> <span class="bound">fs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
  "</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">undo_factorize_polys</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>rat <span class="main">×</span> <span class="main">(</span>nat <span class="main">×</span> nat<span class="main">)</span> list<span class="main">)</span> list <span class="main">⇒</span> rat list <span class="main">⇒</span> rat list"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">undo_factorize_polys</span> <span class="free"><span class="bound"><span class="entity">ls</span></span></span> <span class="free"><span class="bound"><span class="entity">signs</span></span></span> <span class="main">=</span> map <span class="main">(</span><span class="main">λ</span><span class="bound">l</span><span class="main">.</span> undo_factorize <span class="bound">l</span> <span class="free"><span class="bound"><span class="entity">signs</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ls</span></span></span>"</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Auxiliary Polynomial"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">crb</span><span class="main">::</span> <span class="quoted"><span class="quoted">"real poly <span class="main">⇒</span> int"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">crb</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span> ceiling <span class="main">(</span><span class="numeral">2</span> <span class="main">+</span> max_list_non_empty <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span> <span class="bound">i</span><span class="main">.</span> norm <span class="main">(</span>coeff <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span> <span class="main">..&lt;</span> degree <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">]</span><span class="main">)</span> 
    <span class="main">/</span> norm <span class="main">(</span>lead_coeff <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="comment1">(* Because we are using prod_list instead of lcm, it's important that this is called 
    when ps is pairwise coprime. *)</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">coprime_r</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real poly list <span class="main">⇒</span> real poly"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">coprime_r</span> <span class="free"><span class="bound"><span class="entity">ps</span></span></span> <span class="main">=</span> pderiv <span class="main">(</span>prod_list <span class="free"><span class="bound"><span class="entity">ps</span></span></span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">[:</span><span class="main">-</span><span class="main">(</span>crb <span class="main">(</span>prod_list <span class="free"><span class="bound"><span class="entity">ps</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">,</span><span class="main">1</span><span class="main">:]</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">[:</span><span class="main">(</span>crb <span class="main">(</span>prod_list <span class="free"><span class="bound"><span class="entity">ps</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">,</span><span class="main">1</span><span class="main">:]</span><span class="main">)</span>"</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Setting Up the Procedure"</span></span>
  <span class="comment1">(* 0 indexed *)</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">insertAt</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="tfree">'a</span>  <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">insertAt</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">ls</span></span></span> <span class="main">=</span> take <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">ls</span></span></span> <span class="main">@</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="main">(</span>drop <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">ls</span></span></span><span class="main">)</span>"</span></span>

<span class="comment1">(* 0 indexed *)</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">removeAt</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">removeAt</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">ls</span></span></span> <span class="main">=</span> take <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">ls</span></span></span> <span class="main">@</span> <span class="main">(</span>drop <span class="main">(</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ls</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">find_sgas_aux</span><span class="main">::</span> <span class="quoted"><span class="quoted">"real poly list <span class="main">⇒</span> rat list list"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">find_sgas_aux</span> <span class="free"><span class="bound"><span class="entity">in_list</span></span></span> <span class="main">=</span>
  concat <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span>
    map <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> insertAt <span class="bound">i</span> <span class="main">0</span> <span class="bound">v</span><span class="main">)</span> <span class="main">(</span>find_consistent_signs_at_roots <span class="main">(</span><span class="free"><span class="bound"><span class="entity">in_list</span></span></span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span>removeAt <span class="bound">i</span> <span class="free"><span class="bound"><span class="entity">in_list</span></span></span><span class="main">)</span><span class="main">)</span>
  <span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="free"><span class="bound"><span class="entity">in_list</span></span></span><span class="main">]</span><span class="main">)</span>"</span></span>

<span class="comment1">(* For an input list of real polynomials, apply BKR to all positions *)</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">find_sgas</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real poly list <span class="main">⇒</span> rat list list"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">find_sgas</span> <span class="free"><span class="bound"><span class="entity">ps</span></span></span> <span class="main">=</span> <span class="main">(</span> 
    <span class="keyword1">let</span> <span class="bound">r</span> <span class="main">=</span> coprime_r <span class="free"><span class="bound"><span class="entity">ps</span></span></span> <span class="keyword1">in</span>
    find_consistent_signs_at_roots <span class="bound">r</span> <span class="free"><span class="bound"><span class="entity">ps</span></span></span> <span class="main">@</span> find_sgas_aux <span class="free"><span class="bound"><span class="entity">ps</span></span></span>
  <span class="main">)</span>"</span></span>

<span class="comment1">(* Putting the sign condition preprocessing together with BKR *)</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">find_consistent_signs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"rat poly list <span class="main">⇒</span> rat list list"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">find_consistent_signs</span> <span class="free"><span class="bound"><span class="entity">ps</span></span></span> <span class="main">=</span> <span class="main">(</span>
     <span class="keyword1">let</span> <span class="main">(</span><span class="bound">fs</span><span class="main">,</span><span class="bound">data</span><span class="main">)</span> <span class="main">=</span> factorize_polys <span class="free"><span class="bound"><span class="entity">ps</span></span></span><span class="main">;</span>
         <span class="bound">sgas</span> <span class="main">=</span> find_sgas <span class="main">(</span>map <span class="main">(</span>map_poly of_rat<span class="main">)</span> <span class="bound">fs</span><span class="main">)</span><span class="main">;</span>
         <span class="bound">rsgas</span> <span class="main">=</span> map <span class="main">(</span>undo_factorize_polys <span class="bound">data</span><span class="main">)</span> <span class="bound">sgas</span>
    <span class="keyword1">in</span>
    <span class="main">(</span><span class="keyword1">if</span> <span class="bound">fs</span> <span class="main">=</span> <span class="main">[]</span> <span class="keyword1">then</span> <span class="main">[</span><span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">if</span> poly <span class="bound">x</span> <span class="main">0</span> <span class="main">&lt;</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="main">-</span><span class="main">1</span> <span class="keyword1">else</span> <span class="keyword1">if</span> poly <span class="bound">x</span> <span class="main">0</span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="main">0</span> <span class="keyword1">else</span> <span class="main">1</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ps</span></span></span><span class="main">)</span><span class="main">]</span> <span class="keyword1">else</span> <span class="bound">rsgas</span><span class="main">)</span>
  <span class="main">)</span>"</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Deciding Univariate Problems"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">decide_universal</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"rat poly fml <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="free">decide_universal</span> <span class="free"><span class="bound"><span class="entity">fml</span></span></span> <span class="main">=</span> <span class="main">(</span>
    <span class="keyword1">let</span> <span class="main">(</span><span class="bound">fml_struct</span><span class="main">,</span><span class="bound">polys</span><span class="main">)</span> <span class="main">=</span> convert <span class="free"><span class="bound"><span class="entity">fml</span></span></span><span class="main">;</span>
        <span class="bound">conds</span> <span class="main">=</span> find_consistent_signs <span class="bound">polys</span>
    <span class="keyword1">in</span>
     list_all <span class="main">(</span>lookup_sem <span class="bound">fml_struct</span><span class="main">)</span> <span class="bound">conds</span>
  <span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">decide_existential</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"rat poly fml <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="free">decide_existential</span> <span class="free"><span class="bound"><span class="entity">fml</span></span></span> <span class="main">=</span> <span class="main">(</span>
    <span class="keyword1">let</span> <span class="main">(</span><span class="bound">fml_struct</span><span class="main">,</span><span class="bound">polys</span><span class="main">)</span> <span class="main">=</span> convert <span class="free"><span class="bound"><span class="entity">fml</span></span></span><span class="main">;</span>
        <span class="bound">conds</span> <span class="main">=</span> find_consistent_signs <span class="bound">polys</span>
    <span class="keyword1">in</span>
      find <span class="main">(</span>lookup_sem <span class="bound">fml_struct</span><span class="main">)</span> <span class="bound">conds</span> <span class="main">≠</span> None
  <span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">"Proofs"</span></span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Parsing and Semantics"</span></span>
  <span class="comment1">(* Evaluating a formula where 'a is a real poly *)</span>
<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">real_sem</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real poly fml <span class="main">⇒</span> real <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">real_sem</span> <span class="main">(</span>And <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="free">real_sem</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">∧</span> <span class="free">real_sem</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">real_sem</span> <span class="main">(</span>Or <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="free">real_sem</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">∨</span> <span class="free">real_sem</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">real_sem</span> <span class="main">(</span>Gt <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="main">(</span>poly <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">&gt;</span> <span class="main">0</span><span class="main">)</span>"</span></span> 
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">real_sem</span> <span class="main">(</span>Geq <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="main">(</span>poly <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">≥</span> <span class="main">0</span><span class="main">)</span>"</span></span> 
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">real_sem</span> <span class="main">(</span>Lt <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="main">(</span>poly <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">&lt;</span> <span class="main">0</span><span class="main">)</span>"</span></span> 
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">real_sem</span> <span class="main">(</span>Leq <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="main">(</span>poly <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">≤</span> <span class="main">0</span><span class="main">)</span>"</span></span> 
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">real_sem</span> <span class="main">(</span>Eq <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="main">(</span>poly <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span>"</span></span> 
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">real_sem</span> <span class="main">(</span>Neq <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="main">(</span>poly <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">≠</span> <span class="main">0</span><span class="main">)</span>"</span></span> 

<span class="comment1">(* Evaluating a formula where 'a is a rat poly *)</span>
<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">fml_sem</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"rat poly fml <span class="main">⇒</span> real <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">fml_sem</span> <span class="main">(</span>And <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="free">fml_sem</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">∧</span> <span class="free">fml_sem</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">fml_sem</span> <span class="main">(</span>Or <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="free">fml_sem</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">∨</span> <span class="free">fml_sem</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">fml_sem</span> <span class="main">(</span>Gt <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="main">(</span>rpoly <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">&gt;</span> <span class="main">0</span><span class="main">)</span>"</span></span> 
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">fml_sem</span> <span class="main">(</span>Geq <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="main">(</span>rpoly <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">≥</span> <span class="main">0</span><span class="main">)</span>"</span></span> 
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">fml_sem</span> <span class="main">(</span>Lt <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="main">(</span>rpoly <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">&lt;</span> <span class="main">0</span><span class="main">)</span>"</span></span> 
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">fml_sem</span> <span class="main">(</span>Leq <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="main">(</span>rpoly <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">≤</span> <span class="main">0</span><span class="main">)</span>"</span></span> 
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">fml_sem</span> <span class="main">(</span>Eq <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="main">(</span>rpoly <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span>"</span></span> 
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">fml_sem</span> <span class="main">(</span>Neq <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="main">(</span>rpoly <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">≠</span> <span class="main">0</span><span class="main">)</span>"</span></span> 

<span class="keyword1" id="BKR_Decision-poly_list_set_fml"><span class="command">lemma</span></span> poly_list_set_fml<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>poly_list <span class="free">fml</span><span class="main">)</span> <span class="main">=</span> set_fml <span class="free">fml</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induction</span><span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="BKR_Decision-convert_semantics_lem"><span class="command">lemma</span></span> convert_semantics_lem<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">p</span><span class="main">.</span> <span class="bound">p</span> <span class="main">∈</span> set <span class="main">(</span>poly_list <span class="free">fml</span><span class="main">)</span> <span class="main">⟹</span>
    <span class="free">ls</span> <span class="main">!</span> <span class="main">(</span>index_of <span class="free">ps</span> <span class="bound">p</span><span class="main">)</span> <span class="main">=</span> rpoly <span class="bound">p</span> <span class="free">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"fml_sem <span class="free">fml</span> <span class="free">x</span> <span class="main">=</span> lookup_sem <span class="main">(</span>map_fml <span class="main">(</span>index_of <span class="free">ps</span><span class="main">)</span> <span class="free">fml</span><span class="main">)</span> <span class="free">ls</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">fml</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="BKR_Decision-index_of_aux_more"><span class="command">lemma</span></span> index_of_aux_more<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"index_of_aux <span class="free">ls</span> <span class="free">p</span> <span class="free">n</span> <span class="main">≥</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">ls</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">using</span></span> Suc_leD <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="BKR_Decision-index_of_aux_lookup"><span class="command">lemma</span></span> index_of_aux_lookup<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> set <span class="free">ls</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>index_of_aux <span class="free">ls</span> <span class="free">p</span> <span class="free">n</span><span class="main">)</span> <span class="main">-</span> <span class="free">n</span> <span class="main">&lt;</span> length <span class="free">ls</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">ls</span> <span class="main">!</span> <span class="main">(</span><span class="main">(</span>index_of_aux <span class="free">ls</span> <span class="free">p</span> <span class="free">n</span><span class="main">)</span> <span class="main">-</span> <span class="free">n</span><span class="main">)</span> <span class="main">=</span> <span class="free">p</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">ls</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> Suc_diff_Suc index_of_aux_more lessI less_Suc_eq_0_disj less_le_trans<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Suc_diff_Suc index_of_aux_more lessI less_le_trans nth_Cons_Suc<span class="main">)</span>

<span class="keyword1" id="BKR_Decision-index_of_lookup"><span class="command">lemma</span></span> index_of_lookup<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> set <span class="free">ls</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"index_of <span class="free">ls</span> <span class="free">p</span> <span class="main">&lt;</span> length <span class="free">ls</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">ls</span> <span class="main">!</span> <span class="main">(</span>index_of <span class="free">ls</span> <span class="free">p</span><span class="main">)</span> <span class="main">=</span> <span class="free">p</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> assms index_of_aux_lookup<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> index_of_def minus_nat.diff_0<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms index_of_aux_lookup<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> index_of_def minus_nat.diff_0<span class="main">)</span>

<span class="keyword1" id="BKR_Decision-convert_semantics"><span class="command">lemma</span></span> convert_semantics<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"fml_sem <span class="free">fml</span> <span class="free">x</span> <span class="main">=</span> lookup_sem <span class="main">(</span>fst <span class="main">(</span>convert <span class="free">fml</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> rpoly <span class="bound">p</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span>snd <span class="main">(</span>convert <span class="free">fml</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> convert_def Let_def <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> convert_semantics_lem<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> index_of_lookup<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> index_of_lookup<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1" id="BKR_Decision-convert_closed"><span class="command">lemma</span></span> convert_closed<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∈</span> set_fml <span class="main">(</span>fst <span class="main">(</span>convert <span class="free">fml</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> <span class="bound">i</span> <span class="main">&lt;</span> length <span class="main">(</span>snd <span class="main">(</span>convert <span class="free">fml</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> convert_def Let_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fml.set_map<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> index_of_lookup<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> poly_list_set_fml<span class="main">)</span>

<span class="comment1">(* Rational sign vector of polynomials qs with rational coefficients at x *)</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">sign_vec</span><span class="main">::</span><span class="quoted"><span class="quoted">"rat poly list <span class="main">⇒</span> real <span class="main">⇒</span> rat list"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">sign_vec</span> <span class="free"><span class="bound"><span class="entity">qs</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">≡</span>
    map <span class="main">(</span>squash <span class="main">∘</span> <span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> rpoly <span class="bound">p</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">qs</span></span></span>"</span></span>

<span class="comment1">(* The set of all rational sign vectors for qs wrt the set S
  When S = UNIV, then this quantifies over all reals *)</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">consistent_sign_vectors</span><span class="main">::</span><span class="quoted"><span class="quoted">"rat poly list <span class="main">⇒</span> real set <span class="main">⇒</span> rat list set"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">consistent_sign_vectors</span> <span class="free"><span class="bound"><span class="entity">qs</span></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">=</span> <span class="main">(</span>sign_vec <span class="free"><span class="bound"><span class="entity">qs</span></span></span><span class="main">)</span> <span class="main">`</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span>"</span></span>

<span class="keyword1" id="BKR_Decision-sign_vec_semantics"><span class="command">lemma</span></span> sign_vec_semantics<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∈</span> set_fml <span class="free">fml</span> <span class="main">⟹</span> <span class="bound">i</span> <span class="main">&lt;</span> length <span class="free">ls</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"lookup_sem <span class="free">fml</span> <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> rpoly <span class="bound">p</span> <span class="free">x</span><span class="main">)</span> <span class="free">ls</span><span class="main">)</span> <span class="main">=</span> lookup_sem <span class="free">fml</span> <span class="main">(</span>sign_vec <span class="free">ls</span> <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induction</span><span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sign_vec_def squash_def<span class="main">)</span>

<span class="comment1">(* The universal and existential decision procedure is easy if we know the consistent sign vectors *)</span>
<span class="keyword1" id="BKR_Decision-universal_lookup_sem"><span class="command">lemma</span></span> universal_lookup_sem<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∈</span> set_fml <span class="free">fml</span> <span class="main">⟹</span> <span class="bound">i</span> <span class="main">&lt;</span> length <span class="free">qs</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"set <span class="free">signs</span> <span class="main">=</span> consistent_sign_vectors <span class="free">qs</span> UNIV"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">::</span>real<span class="main">.</span> lookup_sem <span class="free">fml</span> <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> rpoly <span class="bound">p</span> <span class="bound">x</span><span class="main">)</span> <span class="free">qs</span><span class="main">)</span><span class="main">)</span> <span class="main">⟷</span>
    list_all <span class="main">(</span>lookup_sem <span class="free">fml</span><span class="main">)</span> <span class="free">signs</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> consistent_sign_vectors_def list_all_iff
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> sign_vec_semantics<span class="main">)</span>

<span class="keyword1" id="BKR_Decision-existential_lookup_sem"><span class="command">lemma</span></span> existential_lookup_sem<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∈</span> set_fml <span class="free">fml</span> <span class="main">⟹</span> <span class="bound">i</span> <span class="main">&lt;</span> length <span class="free">qs</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"set <span class="free">signs</span> <span class="main">=</span> consistent_sign_vectors <span class="free">qs</span> UNIV"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound">x</span><span class="main">::</span>real<span class="main">.</span> lookup_sem <span class="free">fml</span> <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> rpoly <span class="bound">p</span> <span class="bound">x</span><span class="main">)</span> <span class="free">qs</span><span class="main">)</span><span class="main">)</span> <span class="main">⟷</span>
    find <span class="main">(</span>lookup_sem <span class="free">fml</span><span class="main">)</span> <span class="free">signs</span> <span class="main">≠</span> None"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> consistent_sign_vectors_def find_None_iff
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> sign_vec_semantics<span class="main">)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Factoring Lemmas"</span></span>
  <span class="comment1">(*definition real_factorize_list:: "rat poly list ⇒ real poly list"
where "real_factorize_list qs = map (map_poly of_rat) (fst(factorize_polys qs))"
*)</span>
<span class="keyword1"><span class="command">interpretation</span></span> of_rat_poly_hom<span class="main">:</span> map_poly_comm_semiring_hom <span class="quoted">of_rat</span><span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">interpretation</span></span> of_rat_poly_hom<span class="main">:</span> map_poly_comm_ring_hom <span class="quoted">of_rat</span><span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">interpretation</span></span> of_rat_poly_hom<span class="main">:</span> map_poly_idom_hom <span class="quoted">of_rat</span><span class="keyword1"><span class="command">..</span></span>

<span class="keyword1" id="BKR_Decision-finite_prod_map_of_rat_poly_hom"><span class="command">lemma</span></span> finite_prod_map_of_rat_poly_hom<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"poly <span class="main">(</span>real_of_rat_poly <span class="main">(</span><span class="main">∏</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span><span class="bound">b</span><span class="main">)</span><span class="main">∈</span><span class="free">s</span><span class="main">.</span> <span class="free">f</span> <span class="bound">a</span> <span class="bound">b</span><span class="main">)</span><span class="main">)</span> <span class="free">y</span> <span class="main">=</span> <span class="main">(</span><span class="main">∏</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span><span class="bound">b</span><span class="main">)</span><span class="main">∈</span><span class="free">s</span><span class="main">.</span> poly <span class="main">(</span>real_of_rat_poly <span class="main">(</span><span class="free">f</span> <span class="bound">a</span> <span class="bound">b</span><span class="main">)</span><span class="main">)</span> <span class="free">y</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> of_rat_poly_hom.hom_prod poly_prod<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> case_prod_app prod.case_distrib<span class="main">)</span>

<span class="keyword1" id="BKR_Decision-sign_vec_index_of"><span class="command">lemma</span></span> sign_vec_index_of<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">∈</span> set <span class="free">ftrs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sign_vec <span class="free">ftrs</span> <span class="free">x</span> <span class="main">!</span> <span class="main">(</span>index_of <span class="free">ftrs</span> <span class="free">f</span><span class="main">)</span> <span class="main">=</span> squash <span class="main">(</span>rpoly <span class="free">f</span> <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms index_of_lookup<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> index_of_lookup<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> sign_vec_def<span class="main">)</span>

<span class="keyword1" id="BKR_Decision-squash_idem"><span class="command">lemma</span></span> squash_idem<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"squash <span class="main">(</span>squash <span class="free">x</span><span class="main">)</span> <span class="main">=</span> squash <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> squash_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="BKR_Decision-squash_mult"><span class="command">lemma</span></span> squash_mult<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"squash <span class="main">(</span><span class="main">(</span><span class="free">a</span><span class="main">::</span>real<span class="main">)</span> <span class="main">*</span> <span class="free">b</span><span class="main">)</span> <span class="main">=</span> squash <span class="free">a</span> <span class="main">*</span> squash <span class="free">b</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> squash_def <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">using</span></span> less_not_sym mult_neg_neg <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">using</span></span> mult_less_0_iff <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="BKR_Decision-squash_prod_list"><span class="command">lemma</span></span> squash_prod_list<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"squash <span class="main">(</span>prod_list <span class="main">(</span><span class="free">ls</span><span class="main">::</span>real list<span class="main">)</span><span class="main">)</span> <span class="main">=</span> prod_list <span class="main">(</span>map squash <span class="free">ls</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">ls</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">unfolding</span></span> squash_def <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mult_less_0_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> zero_less_mult_iff<span class="main">)</span>

<span class="keyword1" id="BKR_Decision-squash_pow"><span class="command">lemma</span></span> squash_pow<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"squash <span class="main">(</span><span class="main">(</span><span class="free">x</span><span class="main">::</span>real<span class="main">)</span> <span class="main">^</span> <span class="main">(</span><span class="free">y</span><span class="main">::</span>nat<span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>squash <span class="free">x</span><span class="main">)</span> <span class="main">^</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> squash_def <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> zero_less_power_eq<span class="main">)</span>

<span class="keyword1" id="BKR_Decision-squash_real_of_rat"><span class="command">lemma</span></span> squash_real_of_rat<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"squash <span class="main">(</span>real_of_rat <span class="free">x</span><span class="main">)</span> <span class="main">=</span> squash <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> squash_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="BKR_Decision-factorize_rat_poly_monic_irreducible_monic"><span class="command">lemma</span></span> factorize_rat_poly_monic_irreducible_monic<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"factorize_rat_poly_monic <span class="free">f</span> <span class="main">=</span> <span class="main">(</span><span class="free">c</span><span class="main">,</span><span class="free">fs</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">fi</span><span class="main">,</span><span class="free">i</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">fs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"irreducible <span class="free">fi</span> <span class="main">∧</span> monic <span class="free">fi</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">c'</span></span> <span class="skolem"><span class="skolem">fs'</span></span> <span class="keyword2"><span class="keyword">where</span></span> cfs<span class="main">:</span> <span class="quoted"><span class="quoted">"factorize_rat_poly <span class="free">f</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">c'</span><span class="main">,</span><span class="skolem">fs'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> surj_pair<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> fs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">fs</span> <span class="main">=</span> map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">f</span><span class="main">,</span><span class="bound">i</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span>normalize <span class="bound">f</span><span class="main">,</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="skolem">fs'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> factorize_rat_poly_monic_def assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="quoted">"<span class="skolem"><span class="skolem">fi'</span></span>"</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">fi'</span><span class="main">,</span><span class="free">i</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">fs'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">fi</span> <span class="main">=</span> normalize <span class="skolem">fi'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> fs <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> factorize_rat_poly irreducible_normalize_iff
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> cfs monic_normalize not_irreducible_zero<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="BKR_Decision-square_free_normalize"><span class="command">lemma</span></span> square_free_normalize<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"square_free <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"square_free <span class="main">(</span>normalize <span class="free">p</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms square_free_multD<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> unit_factor_mult_normalize<span class="main">)</span>

<span class="keyword1" id="BKR_Decision-coprime_normalize"><span class="command">lemma</span></span> coprime_normalize<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"coprime <span class="free">a</span> <span class="free">b</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"coprime <span class="main">(</span>normalize <span class="free">a</span><span class="main">)</span> <span class="free">b</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="BKR_Decision-undo_normalize"><span class="command">lemma</span></span> undo_normalize<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">=</span> Polynomial.smult <span class="main">(</span>unit_factor <span class="main">(</span>lead_coeff <span class="free">a</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>normalize <span class="free">a</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> add.right_neutral mult_pCons_right mult_zero_right normalize_mult_unit_factor pCons_0_hom.hom_zero unit_factor_poly_def<span class="main">)</span>

<span class="keyword1" id="BKR_Decision-finite_smult_distr"><span class="command">lemma</span></span> finite_smult_distr<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"distinct <span class="free">fs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∏</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">y</span><span class="main">)</span><span class="main">∈</span>set <span class="free">fs</span><span class="main">.</span> Polynomial.smult <span class="main">(</span><span class="main">(</span><span class="free">f</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span><span class="main">::</span>rat<span class="main">)</span> <span class="main">(</span><span class="free">g</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
    Polynomial.smult <span class="main">(</span><span class="main">∏</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">y</span><span class="main">)</span><span class="main">∈</span>set <span class="free">fs</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span> <span class="main">(</span><span class="main">∏</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">y</span><span class="main">)</span><span class="main">∈</span>set <span class="free">fs</span><span class="main">.</span> <span class="free">g</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">fs</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">fs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">using</span></span> mult.commute mult_smult_right prod.case_distrib smult_smult split_cong split_conv
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Groups.mult_ac<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> split_beta<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="BKR_Decision-normalize_coprime_degree"><span class="command">lemma</span></span> normalize_coprime_degree<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"normalize <span class="main">(</span><span class="free">f</span><span class="main">::</span>rat poly<span class="main">)</span> <span class="main">=</span> normalize <span class="free">g</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"coprime <span class="free">f</span> <span class="free">g</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"degree <span class="free">f</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="keyword1">dvd</span> <span class="free">g</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> associatedD2<span class="main">)</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="keyword1">dvd</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> associatedD1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> Missing_Polynomial_Factorial.is_unit_field_poly <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="BKR_Decision-factorize_rat_poly_monic_square_free_factorization"><span class="command">lemma</span></span> factorize_rat_poly_monic_square_free_factorization<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> res<span class="main">:</span> <span class="quoted"><span class="quoted">"factorize_rat_poly_monic <span class="free">f</span> <span class="main">=</span> <span class="main">(</span><span class="free">c</span><span class="main">,</span><span class="free">fs</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"square_free_factorization <span class="free">f</span> <span class="main">(</span><span class="free">c</span><span class="main">,</span><span class="free">fs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">unfold</span> square_free_factorization_def split<span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> conjI impI allI<span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">c'</span></span> <span class="skolem"><span class="skolem">fs'</span></span> <span class="keyword2"><span class="keyword">where</span></span> cfs<span class="main">:</span> <span class="quoted"><span class="quoted">"factorize_rat_poly <span class="free">f</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">c'</span><span class="main">,</span><span class="skolem">fs'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> surj_pair<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> fs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">fs</span> <span class="main">=</span> map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">f</span><span class="main">,</span><span class="bound">i</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span>normalize <span class="bound">f</span><span class="main">,</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="skolem">fs'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> factorize_rat_poly_monic_def assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> sq<span class="main">:</span> <span class="quoted"><span class="quoted">"square_free_factorization <span class="free">f</span> <span class="main">(</span><span class="skolem">c'</span><span class="main">,</span><span class="skolem">fs'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> cfs factorize_rat_poly<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">lcs</span></span> <span class="keyword2"><span class="keyword">where</span></span> lcs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">lcs</span> <span class="main">=</span> prod_list <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">f</span><span class="main">,</span><span class="bound">i</span><span class="main">)</span><span class="main">.</span> lead_coeff <span class="bound">f</span> <span class="main">^</span> Suc <span class="bound">i</span><span class="main">)</span> <span class="skolem">fs'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">have</span></span> c<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">=</span> <span class="skolem">c'</span> <span class="main">*</span> <span class="skolem">lcs</span>"</span></span>  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> factorize_rat_poly_monic_def cfs Let_def lcs <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟹</span> <span class="free">c</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> c cfs <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>                       
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟹</span> <span class="free">fs</span> <span class="main">=</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> fs cfs <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> dist<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="skolem">fs'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> sq square_free_factorizationD<span class="main">(</span>5<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">show</span></span> dist2<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="free">fs</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> fs
    <span class="keyword1"><span class="command">unfolding</span></span> distinct_conv_nth <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="skolem">j</span>
    <span class="keyword3"><span class="command">assume</span></span> ij<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="skolem">fs'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> length <span class="skolem">fs'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">≠</span> <span class="skolem">j</span>"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">case</span> <span class="skolem">fs'</span> <span class="main">!</span> <span class="skolem">i</span> <span class="keyword1">of</span>
            <span class="main">(</span><span class="bound">f</span><span class="main">,</span> <span class="bound">x</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span>normalize <span class="bound">f</span><span class="main">,</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
           <span class="main">(</span><span class="keyword1">case</span> <span class="skolem">fs'</span> <span class="main">!</span> <span class="skolem">j</span> <span class="keyword1">of</span>
            <span class="main">(</span><span class="bound">f</span><span class="main">,</span> <span class="bound">x</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span>normalize <span class="bound">f</span><span class="main">,</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">f</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="keyword2"><span class="keyword">where</span></span> fa<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">fs'</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">f</span><span class="main">,</span><span class="skolem">a</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">g</span></span> <span class="keyword2"><span class="keyword">where</span></span> g<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">fs'</span> <span class="main">!</span> <span class="skolem">j</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">g</span><span class="main">,</span><span class="skolem">a</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"normalize <span class="skolem">f</span> <span class="main">=</span> normalize <span class="skolem">g</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> eq fa  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> case_prod_conv prod.collapse prod.inject<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">≠</span> <span class="skolem">g</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> dist ij fa g
      <span class="keyword1"><span class="command">using</span></span> nth_eq_iff_index_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"coprime <span class="skolem">f</span> <span class="skolem">g</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> square_free_factorizationD<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> sq<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">f</span></span> <span class="quoted"><span class="skolem">a</span></span> <span class="quoted"><span class="skolem">g</span></span> <span class="quoted"><span class="skolem">a</span></span><span class="main">]</span> fa g ij
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">using</span></span> nth_mem <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"degree <span class="skolem">f</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> g<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> normalize_coprime_degree<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted">False</span>
      <span class="keyword1"><span class="command">using</span></span> fa ij<span class="main">(</span>1<span class="main">)</span> nth_mem sq square_free_factorizationD'<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span> 
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">have</span></span> ceq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">=</span> <span class="skolem">c'</span> <span class="main">*</span> <span class="main">(</span><span class="main">∏</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">i</span><span class="main">)</span><span class="main">∈</span>set <span class="skolem">fs'</span><span class="main">.</span> <span class="main">(</span>lead_coeff <span class="bound">a</span><span class="main">)</span> <span class="main">^</span> Suc <span class="bound">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> c lcs
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dist prod.distinct_set_conv_list<span class="main">)</span> 
  <span class="keyword1"><span class="command">have</span></span> fseq<span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="main">(</span><span class="main">∏</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">i</span><span class="main">)</span><span class="main">∈</span>set <span class="free">fs</span><span class="main">.</span> <span class="bound">a</span> <span class="main">^</span> Suc <span class="bound">i</span><span class="main">)</span> <span class="main">=</span>  <span class="main">(</span><span class="main">∏</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">i</span><span class="main">)</span><span class="main">∈</span>set <span class="skolem">fs'</span><span class="main">.</span> <span class="main">(</span>normalize <span class="bound">a</span><span class="main">)</span> <span class="main">^</span> Suc <span class="bound">i</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> prod.distinct_set_conv_list<span class="main"><span class="main">[</span></span><span class="operator">OF</span> dist<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> prod.distinct_set_conv_list<span class="main"><span class="main">[</span></span><span class="operator">OF</span> dist2<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">unfolding</span></span> fs <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> o_def <span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> case_prod_conv old.prod.exhaust<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">=</span> Polynomial.smult <span class="skolem">c'</span> <span class="main">(</span><span class="main">∏</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">i</span><span class="main">)</span><span class="main">∈</span>set <span class="skolem">fs'</span><span class="main">.</span> <span class="bound">a</span> <span class="main">^</span> Suc <span class="bound">i</span><span class="main">)</span>"</span></span>  <span class="keyword1"><span class="command">using</span></span> sq square_free_factorizationD<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span>  Polynomial.smult <span class="skolem">c'</span> <span class="main">(</span><span class="main">∏</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">i</span><span class="main">)</span><span class="main">∈</span>set <span class="skolem">fs'</span><span class="main">.</span> <span class="main">(</span>Polynomial.smult <span class="main">(</span><span class="main">(</span>unit_factor <span class="main">(</span>lead_coeff <span class="bound">a</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>normalize <span class="bound">a</span><span class="main">)</span><span class="main">)</span> <span class="main">^</span> Suc <span class="bound">i</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> undo_normalize<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span>  Polynomial.smult <span class="skolem">c'</span>
    <span class="main">(</span><span class="main">∏</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">i</span><span class="main">)</span><span class="main">∈</span>set <span class="skolem">fs'</span><span class="main">.</span> <span class="main">(</span>Polynomial.smult <span class="main">(</span><span class="main">(</span>lead_coeff <span class="bound">a</span><span class="main">)</span> <span class="main">^</span> Suc <span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span>normalize <span class="bound">a</span><span class="main">)</span> <span class="main">^</span> Suc <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> smult_power<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span>  Polynomial.smult <span class="skolem">c'</span>
    <span class="main">(</span>Polynomial.smult <span class="main">(</span><span class="main">∏</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">i</span><span class="main">)</span><span class="main">∈</span>set <span class="skolem">fs'</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span>lead_coeff <span class="bound">a</span><span class="main">)</span> <span class="main">^</span> Suc <span class="bound">i</span><span class="main">)</span><span class="main">)</span>
        <span class="main">(</span><span class="main">∏</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">i</span><span class="main">)</span><span class="main">∈</span>set <span class="skolem">fs'</span><span class="main">.</span> <span class="main">(</span>normalize <span class="bound">a</span><span class="main">)</span> <span class="main">^</span> Suc <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> finite_smult_distr<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dist<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span>  Polynomial.smult <span class="main">(</span><span class="skolem">c'</span> <span class="main">*</span> <span class="main">(</span><span class="main">∏</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">i</span><span class="main">)</span><span class="main">∈</span>set <span class="skolem">fs'</span><span class="main">.</span> <span class="main">(</span>lead_coeff <span class="bound">a</span><span class="main">)</span> <span class="main">^</span> Suc <span class="bound">i</span><span class="main">)</span><span class="main">)</span>
        <span class="main">(</span><span class="main">∏</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">i</span><span class="main">)</span><span class="main">∈</span>set <span class="skolem">fs'</span><span class="main">.</span> <span class="main">(</span>normalize <span class="bound">a</span><span class="main">)</span> <span class="main">^</span> Suc <span class="bound">i</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> smult_smult <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> Polynomial.smult <span class="free">c</span>  <span class="main">(</span><span class="main">∏</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">i</span><span class="main">)</span><span class="main">∈</span>set <span class="free">fs</span><span class="main">.</span> <span class="bound">a</span> <span class="main">^</span> Suc <span class="bound">i</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> ceq fseq <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">=</span>  Polynomial.smult <span class="free">c</span>  <span class="main">(</span><span class="main">∏</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">i</span><span class="main">)</span><span class="main">∈</span>set <span class="free">fs</span><span class="main">.</span> <span class="bound">a</span> <span class="main">^</span> Suc <span class="bound">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span> <span class="skolem">i</span>
  <span class="keyword3"><span class="command">assume</span></span> ai<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">a</span><span class="main">,</span><span class="skolem">i</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">fs</span>"</span></span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a'</span></span> <span class="keyword2"><span class="keyword">where</span></span> a'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">a'</span><span class="main">,</span><span class="skolem">i</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">fs'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">=</span> normalize <span class="skolem">a'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ai <span class="keyword1"><span class="command">unfolding</span></span> fs <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"square_free <span class="skolem">a</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> square_free_normalize a'
    <span class="keyword1"><span class="command">using</span></span> sq square_free_factorizationD<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> degree <span class="skolem">a</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> degree_normalize a'
    <span class="keyword1"><span class="command">using</span></span> sq square_free_factorizationD'<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword3"><span class="command">fix</span></span>  <span class="skolem">b</span> <span class="skolem">j</span>
  <span class="keyword3"><span class="command">assume</span></span> bj<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">b</span><span class="main">,</span><span class="skolem">j</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">fs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">a</span><span class="main">,</span><span class="skolem">i</span><span class="main">)</span> <span class="main">≠</span> <span class="main">(</span><span class="skolem">b</span><span class="main">,</span><span class="skolem">j</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">b'</span></span> <span class="keyword2"><span class="keyword">where</span></span> b'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">b'</span><span class="main">,</span><span class="skolem">j</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">fs'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">=</span> normalize <span class="skolem">b'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> bj <span class="keyword1"><span class="command">unfolding</span></span> fs <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"algebraic_semidom_class.coprime <span class="skolem">a</span> <span class="skolem">b</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> a' b' <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">using</span></span> bj<span class="main">(</span>2<span class="main">)</span> sq square_free_factorizationD<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">qed</span></span>  

<span class="keyword1" id="BKR_Decision-undo_factorize_correct"><span class="command">lemma</span></span> undo_factorize_correct<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"factorize_rat_poly_monic <span class="free">p</span> <span class="main">=</span> <span class="main">(</span><span class="free">c</span><span class="main">,</span><span class="free">fs</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">f</span> <span class="bound">p</span><span class="main">.</span> <span class="main">(</span><span class="bound">f</span><span class="main">,</span><span class="bound">p</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">fs</span> <span class="main">⟹</span> <span class="bound">f</span> <span class="main">∈</span> set <span class="free">ftrs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"undo_factorize <span class="main">(</span><span class="free">c</span><span class="main">,</span>map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">f</span><span class="main">,</span><span class="bound">pow</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span>index_of <span class="free">ftrs</span> <span class="bound">f</span><span class="main">,</span> <span class="bound">pow</span><span class="main">)</span><span class="main">)</span> <span class="free">fs</span><span class="main">)</span> <span class="main">(</span>sign_vec <span class="free">ftrs</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> squash <span class="main">(</span>rpoly <span class="free">p</span> <span class="free">x</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">=</span> smult <span class="free">c</span> <span class="main">(</span><span class="main">∏</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">i</span><span class="main">)</span><span class="main">∈</span> set <span class="free">fs</span><span class="main">.</span> <span class="bound">a</span> <span class="main">^</span> Suc <span class="bound">i</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> factorize_rat_poly_monic_square_free_factorization square_free_factorizationD<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> fs<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="free">fs</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> factorize_rat_poly_monic_square_free_factorization square_free_factorizationD<span class="main">(</span>5<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"rpoly <span class="free">p</span> <span class="free">x</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span>real_of_rat <span class="free">c</span><span class="main">)</span> <span class="main">*</span> rpoly <span class="main">(</span><span class="main">∏</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">i</span><span class="main">)</span><span class="main">∈</span> set <span class="free">fs</span><span class="main">.</span> <span class="bound">a</span> <span class="main">^</span> Suc <span class="bound">i</span><span class="main">)</span> <span class="free">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> p <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> of_rat_hom.map_poly_hom_smult<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span>real_of_rat <span class="free">c</span><span class="main">)</span> <span class="main">*</span> rpoly <span class="main">(</span><span class="main">∏</span><span class="bound">ai</span><span class="main">∈</span> set <span class="free">fs</span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">ai</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span><span class="bound">i</span><span class="main">)</span> <span class="main">⇒</span> <span class="bound">a</span> <span class="main">^</span> Suc <span class="bound">i</span><span class="main">)</span> <span class="free">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span>real_of_rat <span class="free">c</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">∏</span><span class="bound">ai</span><span class="main">∈</span> set <span class="free">fs</span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">ai</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span><span class="bound">i</span><span class="main">)</span> <span class="main">⇒</span> rpoly <span class="main">(</span><span class="bound">a</span> <span class="main">^</span> Suc <span class="bound">i</span><span class="main">)</span> <span class="free">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> finite_prod_map_of_rat_poly_hom<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span>real_of_rat <span class="free">c</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">∏</span><span class="bound">ai</span><span class="main">∈</span> set <span class="free">fs</span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">ai</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span><span class="bound">i</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span>rpoly <span class="bound">a</span> <span class="free">x</span><span class="main">)</span> <span class="main">^</span> Suc <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> of_rat_poly_hom.hom_power poly_hom.hom_power split_cong<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span>  <span class="main">=</span> <span class="main">(</span><span class="main">(</span>real_of_rat <span class="free">c</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span>prod_list <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">ai</span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">ai</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span><span class="bound">i</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span>rpoly <span class="bound">a</span> <span class="free">x</span><span class="main">)</span> <span class="main">^</span> Suc <span class="bound">i</span><span class="main">)</span> <span class="free">fs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fs prod.distinct_set_conv_list<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"rpoly <span class="free">p</span> <span class="free">x</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span>real_of_rat <span class="free">c</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span>prod_list <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">ai</span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">ai</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span><span class="bound">i</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span>rpoly <span class="bound">a</span> <span class="free">x</span><span class="main">)</span> <span class="main">^</span> Suc <span class="bound">i</span><span class="main">)</span> <span class="free">fs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"squash <span class="main">(</span>rpoly <span class="free">p</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> squash <span class="free">c</span> <span class="main">*</span> prod_list <span class="main">(</span>map squash <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">ai</span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">ai</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span><span class="bound">i</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span>rpoly <span class="bound">a</span> <span class="free">x</span><span class="main">)</span> <span class="main">^</span> Suc <span class="bound">i</span><span class="main">)</span> <span class="free">fs</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> squash_mult squash_prod_list o_def<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> squash <span class="free">c</span> <span class="main">*</span> prod_list <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">ai</span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">ai</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span><span class="bound">i</span><span class="main">)</span> <span class="main">⇒</span> squash <span class="main">(</span><span class="main">(</span>rpoly <span class="bound">a</span> <span class="free">x</span><span class="main">)</span> <span class="main">^</span> Suc <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="free">fs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> o_def<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> prod.case_distrib<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> rp<span class="main">:</span><span class="quoted"><span class="quoted">"squash<span class="main">(</span>rpoly <span class="free">p</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> squash <span class="free">c</span> <span class="main">*</span> prod_list <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">ai</span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">ai</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span><span class="bound">i</span><span class="main">)</span> <span class="main">⇒</span> squash <span class="main">(</span>rpoly <span class="bound">a</span> <span class="free">x</span><span class="main">)</span> <span class="main">^</span> Suc <span class="bound">i</span><span class="main">)</span> <span class="free">fs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> squash_pow
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"undo_factorize
     <span class="main">(</span><span class="free">c</span><span class="main">,</span> map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">f</span><span class="main">,</span> <span class="bound">pow</span><span class="main">)</span><span class="main">.</span><span class="main">(</span>index_of <span class="free">ftrs</span> <span class="bound">f</span><span class="main">,</span> <span class="bound">pow</span><span class="main">)</span><span class="main">)</span> <span class="free">fs</span><span class="main">)</span> <span class="main">(</span>sign_vec <span class="free">ftrs</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span>
    squash
     <span class="main">(</span><span class="free">c</span> <span class="main">*</span> <span class="main">(</span><span class="main">∏</span><span class="bound">xa</span><span class="main">←</span><span class="free">fs</span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">xa</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">f</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span> <span class="main">⇒</span> sign_vec <span class="free">ftrs</span> <span class="free">x</span> <span class="main">!</span> index_of <span class="free">ftrs</span> <span class="bound">f</span> <span class="main">^</span> Suc <span class="bound">y</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> undo_factorize_def <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> o_def<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> case_prod_conv old.prod.exhaust<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span>  squash
     <span class="main">(</span><span class="free">c</span> <span class="main">*</span> <span class="main">(</span><span class="main">∏</span><span class="bound">xa</span><span class="main">←</span><span class="free">fs</span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">xa</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">f</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span>squash <span class="main">(</span>rpoly <span class="bound">f</span> <span class="free">x</span><span class="main">)</span><span class="main">)</span> <span class="main">^</span> Suc <span class="bound">y</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> sign_vec_index_of
      map_eq_conv split_cong
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> map_eq_conv split_cong<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> rp
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> of_rat_hom.hom_mult squash_idem squash_mult squash_real_of_rat<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="BKR_Decision-length_sign_vec"><span class="command">lemma</span></span> length_sign_vec<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>sign_vec <span class="free">ps</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> length <span class="free">ps</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> sign_vec_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="BKR_Decision-factorize_polys_has_factors"><span class="command">lemma</span></span> factorize_polys_has_factors<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"factorize_polys <span class="free">ps</span> <span class="main">=</span> <span class="main">(</span><span class="free">ftrs</span><span class="main">,</span><span class="free">data</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> set <span class="free">ps</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"factorize_rat_poly_monic <span class="free">p</span> <span class="main">=</span> <span class="main">(</span><span class="free">c</span><span class="main">,</span><span class="free">fs</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>map fst <span class="free">fs</span><span class="main">)</span> <span class="main">⊆</span> set <span class="free">ftrs</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> factorize_polys_def Let_def <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> UN_iff fst_conv image_eqI snd_conv<span class="main">)</span>

<span class="keyword1" id="BKR_Decision-factorize_polys_undo_factorize_polys"><span class="command">lemma</span></span> factorize_polys_undo_factorize_polys<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"factorize_polys <span class="free">ps</span> <span class="main">=</span> <span class="main">(</span><span class="free">ftrs</span><span class="main">,</span><span class="free">data</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"undo_factorize_polys <span class="free">data</span> <span class="main">(</span>sign_vec <span class="free">ftrs</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> sign_vec <span class="free">ps</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> list_eq_iff_nth_eq undo_factorize_polys_def <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">show</span></span> leq<span class="main">:</span><span class="quoted"><span class="quoted">"length <span class="free">data</span> <span class="main">=</span> length <span class="free">ps</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> factorize_polys_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span>
  <span class="keyword3"><span class="command">assume</span></span> il<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="free">data</span>"</span></span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">c</span></span> <span class="skolem"><span class="skolem">fs</span></span> <span class="keyword2"><span class="keyword">where</span></span> cfs<span class="main">:</span> <span class="quoted"><span class="quoted">"factorize_rat_poly_monic <span class="main">(</span><span class="free">ps</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">c</span><span class="main">,</span><span class="skolem">fs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> surj_pair<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> fsts<span class="main">:</span><span class="quoted"><span class="quoted">"set <span class="main">(</span>map fst <span class="skolem">fs</span><span class="main">)</span> <span class="main">⊆</span> set <span class="free">ftrs</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms factorize_polys_has_factors il leq nth_mem <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="free">data</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">c</span><span class="main">,</span>map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">f</span><span class="main">,</span><span class="bound">pow</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span>index_of <span class="free">ftrs</span> <span class="bound">f</span><span class="main">,</span> <span class="bound">pow</span><span class="main">)</span><span class="main">)</span> <span class="skolem">fs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> factorize_polys_def
    <span class="keyword1"><span class="command">using</span></span> cfs il <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def cfs<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"undo_factorize <span class="main">(</span><span class="free">data</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">(</span>sign_vec <span class="free">ftrs</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> squash <span class="main">(</span>rpoly <span class="main">(</span><span class="free">ps</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span> <span class="free">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> *
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span>  undo_factorize_correct<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="free"><span class="free">ps</span></span> <span class="main"><span class="main">!</span></span> <span class="skolem"><span class="skolem">i</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cfs<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> fsts <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"undo_factorize <span class="main">(</span><span class="free">data</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">(</span>sign_vec <span class="free">ftrs</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span>  sign_vec <span class="free">ps</span> <span class="free">x</span> <span class="main">!</span> <span class="skolem">i</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> leq il sign_vec_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="BKR_Decision-factorize_polys_irreducible_monic"><span class="command">lemma</span></span> factorize_polys_irreducible_monic<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"factorize_polys <span class="free">ps</span> <span class="main">=</span> <span class="main">(</span><span class="free">fs</span><span class="main">,</span><span class="free">data</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"distinct <span class="free">fs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">f</span><span class="main">.</span> <span class="bound">f</span> <span class="main">∈</span> set <span class="free">fs</span> <span class="main">⟹</span> irreducible <span class="bound">f</span> <span class="main">∧</span> monic <span class="bound">f</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> factorize_polys_def Let_def <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">using</span></span> factorize_rat_poly_monic_irreducible_monic
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> prod.collapse<span class="main">)</span> 
  <span class="keyword1"><span class="command">using</span></span> factorize_rat_poly_monic_irreducible_monic
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> prod.collapse<span class="main">)</span>

<span class="keyword1" id="BKR_Decision-factorize_polys_square_free"><span class="command">lemma</span></span> factorize_polys_square_free<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"factorize_polys <span class="free">ps</span> <span class="main">=</span> <span class="main">(</span><span class="free">fs</span><span class="main">,</span><span class="free">data</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">f</span><span class="main">.</span> <span class="bound">f</span> <span class="main">∈</span> set <span class="free">fs</span> <span class="main">⟹</span> square_free <span class="bound">f</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms factorize_polys_irreducible_monic<span class="main">(</span>2<span class="main">)</span> irreducible_imp_square_free <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="BKR_Decision-irreducible_monic_coprime"><span class="command">lemma</span></span> irreducible_monic_coprime<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> f<span class="main">:</span> <span class="quoted"><span class="quoted">"monic <span class="free">f</span>"</span></span> <span class="quoted"><span class="quoted">"irreducible <span class="main">(</span><span class="free">f</span><span class="main">::</span>rat poly<span class="main">)</span>"</span></span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> g<span class="main">:</span> <span class="quoted"><span class="quoted">"monic <span class="free">g</span>"</span></span> <span class="quoted"><span class="quoted">"irreducible <span class="main">(</span><span class="free">g</span><span class="main">::</span>rat poly<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">≠</span> <span class="free">g</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"coprime <span class="free">f</span> <span class="free">g</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> coprime_0<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> coprime_def' f<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> f<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> g<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> g<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> irreducible_normalized_divisors normalize_dvd_iff normalize_idem normalize_monic<span class="main">)</span>

<span class="keyword1" id="BKR_Decision-factorize_polys_coprime"><span class="command">lemma</span></span> factorize_polys_coprime<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"factorize_polys <span class="free">ps</span> <span class="main">=</span> <span class="main">(</span><span class="free">fs</span><span class="main">,</span><span class="free">data</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">f</span> <span class="bound">g</span><span class="main">.</span> <span class="bound">f</span> <span class="main">∈</span> set <span class="free">fs</span> <span class="main">⟹</span> <span class="bound">g</span> <span class="main">∈</span> set <span class="free">fs</span> <span class="main">⟹</span> <span class="bound">f</span> <span class="main">≠</span> <span class="bound">g</span> <span class="main">⟹</span> coprime <span class="bound">f</span> <span class="bound">g</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms factorize_polys_irreducible_monic<span class="main">(</span>2<span class="main">)</span> irreducible_monic_coprime <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="BKR_Decision-coprime_rat_poly_real_poly"><span class="command">lemma</span></span> coprime_rat_poly_real_poly<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"coprime <span class="free">p</span> <span class="main">(</span><span class="free">q</span><span class="main">::</span>rat poly<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"coprime <span class="main">(</span>real_of_rat_poly <span class="free">p</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span>real_of_rat_poly <span class="free">q</span><span class="main">)</span><span class="main">::</span>real poly<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms gcd_dvd_1 of_rat_hom.map_poly_gcd of_rat_poly_hom.hom_dvd_1<span class="main">)</span>

<span class="keyword1" id="BKR_Decision-coprime_rat_poly_iff_coprimereal_poly"><span class="command">lemma</span></span> coprime_rat_poly_iff_coprimereal_poly<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"coprime <span class="free">p</span> <span class="main">(</span><span class="free">q</span><span class="main">::</span>rat poly<span class="main">)</span> <span class="main">⟷</span> coprime <span class="main">(</span>real_of_rat_poly <span class="free">p</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span>real_of_rat_poly <span class="free">q</span><span class="main">)</span><span class="main">::</span>real poly<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> forward<span class="main">:</span> <span class="quoted"><span class="quoted">"coprime <span class="free">p</span> <span class="main">(</span><span class="free">q</span><span class="main">::</span>rat poly<span class="main">)</span> <span class="main">⟶</span> coprime <span class="main">(</span>real_of_rat_poly <span class="free">p</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span>real_of_rat_poly <span class="free">q</span><span class="main">)</span><span class="main">::</span>real poly<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> coprime_rat_poly_real_poly <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> backward<span class="main">:</span> <span class="quoted"><span class="quoted">"coprime <span class="main">(</span>real_of_rat_poly <span class="free">p</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span>real_of_rat_poly <span class="free">q</span><span class="main">)</span><span class="main">::</span>real poly<span class="main">)</span> <span class="main">⟹</span> coprime <span class="free">p</span> <span class="main">(</span><span class="free">q</span><span class="main">::</span>rat poly<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">assume</span></span> copr_real<span class="main">:</span> <span class="quoted"><span class="quoted">"comm_monoid_mult_class.coprime <span class="main">(</span>real_of_rat_poly <span class="free">p</span><span class="main">)</span> <span class="main">(</span>real_of_rat_poly <span class="free">q</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"degree <span class="main">(</span>gcd <span class="free">p</span> <span class="main">(</span><span class="free">q</span><span class="main">::</span>rat poly<span class="main">)</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">⟹</span> False"</span></span> 
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword3"><span class="command">assume</span></span> deg<span class="main">:</span> <span class="quoted"><span class="quoted">"degree <span class="main">(</span>gcd <span class="free">p</span> <span class="main">(</span><span class="free">q</span><span class="main">::</span>rat poly<span class="main">)</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="keyword1">dvd</span> <span class="free">p</span> <span class="main">∧</span> <span class="bound">y</span> <span class="keyword1">dvd</span> <span class="free">q</span> <span class="main">∧</span> degree <span class="bound">y</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="keyword2"><span class="keyword">where</span></span> yprop<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="keyword1">dvd</span> <span class="free">p</span> <span class="main">∧</span> <span class="skolem">y</span> <span class="keyword1">dvd</span> <span class="free">q</span> <span class="main">∧</span> degree <span class="skolem">y</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>real_of_rat_poly <span class="skolem">y</span><span class="main">)</span> <span class="keyword1">dvd</span> <span class="main">(</span>real_of_rat_poly <span class="free">p</span><span class="main">)</span> <span class="main">∧</span>
        <span class="main">(</span>real_of_rat_poly <span class="skolem">y</span> <span class="main">)</span> <span class="keyword1">dvd</span> <span class="main">(</span>real_of_rat_poly <span class="free">q</span><span class="main">)</span> <span class="main">∧</span> degree <span class="skolem">y</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"False"</span></span> 
        <span class="keyword1"><span class="command">using</span></span> copr_real <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span> 
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"comm_monoid_mult_class.coprime <span class="free">p</span> <span class="main">(</span><span class="free">q</span><span class="main">::</span>rat poly<span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> comm_monoid_gcd_class.gcd_dvd_1
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Missing_Polynomial_Factorial.is_unit_field_poly copr_real gcd_zero_iff' neq0_conv of_rat_poly_hom.hom_zero<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> forward backward <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="BKR_Decision-factorize_polys_map_distinct"><span class="command">lemma</span></span> factorize_polys_map_distinct<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"factorize_polys <span class="free">ps</span> <span class="main">=</span> <span class="main">(</span><span class="free">fs</span><span class="main">,</span><span class="free">data</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">fss</span> <span class="main">=</span>  map real_of_rat_poly <span class="free">fs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"distinct <span class="free">fss</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> factorize_polys_irreducible_monic<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">unfolding</span></span> assms<span class="main">(</span>2<span class="main">)</span> 
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> distinct_conv_nth<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> of_rat_eq_iff of_rat_hom.coeff_map_poly_hom poly_eqI<span class="main">)</span>

<span class="keyword1" id="BKR_Decision-factorize_polys_map_square_free"><span class="command">lemma</span></span> factorize_polys_map_square_free<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"factorize_polys <span class="free">ps</span> <span class="main">=</span> <span class="main">(</span><span class="free">fs</span><span class="main">,</span><span class="free">data</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">fss</span> <span class="main">=</span>  map real_of_rat_poly <span class="free">fs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">f</span><span class="main">.</span> <span class="bound">f</span> <span class="main">∈</span> set <span class="free">fss</span> <span class="main">⟹</span> square_free <span class="bound">f</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> factorize_polys_square_free<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> field_hom_0'.square_free_map_poly of_rat_hom.field_hom_0'_axioms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 

<span class="keyword1" id="BKR_Decision-factorize_polys_map_coprime"><span class="command">lemma</span></span> factorize_polys_map_coprime<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"factorize_polys <span class="free">ps</span> <span class="main">=</span> <span class="main">(</span><span class="free">fs</span><span class="main">,</span><span class="free">data</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">fss</span> <span class="main">=</span>  map real_of_rat_poly <span class="free">fs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">f</span> <span class="bound">g</span><span class="main">.</span> <span class="bound">f</span> <span class="main">∈</span> set <span class="free">fss</span> <span class="main">⟹</span> <span class="bound">g</span> <span class="main">∈</span> set <span class="free">fss</span> <span class="main">⟹</span> <span class="bound">f</span> <span class="main">≠</span> <span class="bound">g</span> <span class="main">⟹</span> coprime <span class="bound">f</span> <span class="bound">g</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> factorize_polys_coprime<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> coprime_rat_poly_real_poly <span class="keyword1"><span class="command">unfolding</span></span> assms<span class="main">(</span>2<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="BKR_Decision-coprime_prod_list"><span class="command">lemma</span></span> coprime_prod_list<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">p</span><span class="main">.</span> <span class="bound">p</span> <span class="main">∈</span> set <span class="free">ps</span> <span class="main">⟹</span> <span class="bound">p</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"coprime <span class="main">(</span>prod_list <span class="free">ps</span><span class="main">)</span> <span class="main">(</span><span class="free">q</span><span class="main">::</span>real poly<span class="main">)</span>"</span></span>  
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">p</span><span class="main">.</span> <span class="bound">p</span> <span class="main">∈</span> set <span class="free">ps</span> <span class="main">⟹</span> coprime <span class="bound">p</span> <span class="free">q</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">p</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> set <span class="free">ps</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword">where</span></span> r<span class="main">:</span> <span class="quoted"><span class="quoted">"prod_list <span class="free">ps</span> <span class="main">=</span> <span class="skolem">r</span> <span class="main">*</span> <span class="skolem">p</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> remove1_retains_prod <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"coprime <span class="skolem">p</span> <span class="free">q</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> coprime_prod<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">r</span></span></span></span> <span class="quoted"><span class="main"><span class="quoted"><span class="main">1</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> assms r <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(* basically copied from square_free_factorizationD' *)</span>
<span class="keyword1" id="BKR_Decision-factorize_polys_square_free_prod_list"><span class="command">lemma</span></span> factorize_polys_square_free_prod_list<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"factorize_polys <span class="free">ps</span> <span class="main">=</span> <span class="main">(</span><span class="free">fs</span><span class="main">,</span><span class="free">data</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"square_free <span class="main">(</span>prod_list <span class="free">fs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> square_freeI<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> factorize_polys_coprime<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> coprime<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">p</span> <span class="bound">q</span><span class="main">.</span> <span class="bound">p</span> <span class="main">∈</span> set <span class="free">fs</span> <span class="main">⟹</span> <span class="bound">q</span> <span class="main">∈</span> set <span class="free">fs</span> <span class="main">⟹</span> <span class="bound">p</span> <span class="main">≠</span> <span class="bound">q</span> <span class="main">⟹</span> coprime <span class="bound">p</span> <span class="bound">q</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">from</span></span> factorize_polys_square_free<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> sq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">p</span><span class="main">.</span> <span class="bound">p</span> <span class="main">∈</span> set <span class="free">fs</span> <span class="main">⟹</span> square_free <span class="bound">p</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"prod_list <span class="free">fs</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> prod_list_zero_iff
    <span class="keyword1"><span class="command">using</span></span> square_free_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">q</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"degree <span class="skolem">q</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">*</span> <span class="skolem">q</span> <span class="keyword1">dvd</span> prod_list <span class="free">fs</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> irreducible<span class="hidden">⇩</span><sub>d</sub>_factor<span class="main">[</span><span class="operator">OF</span> this<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> this<span class="main">(</span>2<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">q</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
    irr<span class="main">:</span> <span class="quoted"><span class="quoted">"irreducible <span class="skolem">q</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> dvd<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">*</span> <span class="skolem">q</span> <span class="keyword1">dvd</span> prod_list <span class="free">fs</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> dvd_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> dvd'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="keyword1">dvd</span> prod_list <span class="free">fs</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> dvd_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> irreducible_dvd_prod_list<span class="main">[</span><span class="operator">OF</span> irr dvd'<span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">b</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
    mem<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">∈</span> set <span class="free">fs</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> dvd1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="keyword1">dvd</span> <span class="skolem">b</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> dvd1 <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> b<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">=</span> <span class="skolem">q</span> <span class="main">*</span> <span class="skolem">k</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> dvd_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> split_list<span class="main">[</span><span class="operator">OF</span> mem<span class="main">]</span> b <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">bs1</span></span> <span class="skolem"><span class="skolem">bs2</span></span> <span class="keyword2"><span class="keyword">where</span></span> bs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">fs</span> <span class="main">=</span> <span class="skolem">bs1</span> <span class="main">@</span> <span class="skolem">b</span> <span class="main">#</span> <span class="skolem">bs2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> irr <span class="keyword1"><span class="command">have</span></span> q0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> dq<span class="main">:</span> <span class="quoted"><span class="quoted">"degree <span class="skolem">q</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> irreducible<span class="hidden">⇩</span><sub>d</sub>_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"square_free <span class="main">(</span><span class="skolem">q</span> <span class="main">*</span> <span class="skolem">k</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> sq b mem <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> this<span class="main">[</span><span class="operator">unfolded</span> square_free_def<span class="main">,</span> <span class="operator">THEN</span> conjunct2<span class="main">,</span> <span class="operator">rule_format</span><span class="main">,</span> <span class="operator">OF</span> dq<span class="main">]</span> 
  <span class="keyword1"><span class="command">have</span></span> qk<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="skolem">q</span> <span class="keyword1">dvd</span> <span class="skolem">k</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> dvd<span class="main">[</span><span class="operator">unfolded</span> bs b<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">*</span> <span class="skolem">q</span> <span class="keyword1">dvd</span> <span class="skolem">q</span> <span class="main">*</span> <span class="main">(</span><span class="skolem">k</span> <span class="main">*</span> prod_list <span class="main">(</span><span class="skolem">bs1</span> <span class="main">@</span> <span class="skolem">bs2</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">ac_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> q0 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="keyword1">dvd</span> <span class="skolem">k</span> <span class="main">*</span> prod_list <span class="main">(</span><span class="skolem">bs1</span> <span class="main">@</span> <span class="skolem">bs2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> irr qk <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="keyword1">dvd</span> prod_list <span class="main">(</span><span class="skolem">bs1</span> <span class="main">@</span> <span class="skolem">bs2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> irreducible_dvd_prod_list<span class="main">[</span><span class="operator">OF</span> irr this<span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">b'</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
    mem'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">b'</span> <span class="main">∈</span> set <span class="main">(</span><span class="skolem">bs1</span> <span class="main">@</span> <span class="skolem">bs2</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> dvd2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="keyword1">dvd</span> <span class="skolem">b'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">from</span></span> dvd1 dvd2 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="keyword1">dvd</span> gcd <span class="skolem">b</span> <span class="skolem">b'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> dq is_unit_iff_degree<span class="main">[</span><span class="operator">OF</span> q0<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> cop<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> coprime <span class="skolem">b</span> <span class="skolem">b'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">from</span></span> mem' <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b'</span> <span class="main">∈</span> set <span class="free">fs</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> bs <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> b'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">b'</span> <span class="main">=</span> <span class="skolem">b</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> coprime
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">b'</span> <span class="main">∈</span> set <span class="free">fs</span>›</span></span> cop mem <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">with</span></span> mem' bs factorize_polys_irreducible_monic<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="BKR_Decision-factorize_polys_map_square_free_prod_list"><span class="command">lemma</span></span> factorize_polys_map_square_free_prod_list<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"factorize_polys <span class="free">ps</span> <span class="main">=</span> <span class="main">(</span><span class="free">fs</span><span class="main">,</span><span class="free">data</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">fss</span> <span class="main">=</span>  map real_of_rat_poly <span class="free">fs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"square_free <span class="main">(</span>prod_list <span class="free">fss</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span>  factorize_polys_square_free_prod_list<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> assms<span class="main">(</span>2<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> of_rat_hom.square_free_map_poly<span class="main">)</span>

<span class="keyword1" id="BKR_Decision-factorize_polys_map_coprime_pderiv"><span class="command">lemma</span></span> factorize_polys_map_coprime_pderiv<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"factorize_polys <span class="free">ps</span> <span class="main">=</span> <span class="main">(</span><span class="free">fs</span><span class="main">,</span><span class="free">data</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">fss</span> <span class="main">=</span> map real_of_rat_poly <span class="free">fs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">f</span><span class="main">.</span> <span class="bound">f</span> <span class="main">∈</span> set <span class="free">fss</span> <span class="main">⟹</span> coprime <span class="bound">f</span> <span class="main">(</span>pderiv <span class="main">(</span>prod_list <span class="free">fss</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">f</span>
  <span class="keyword3"><span class="command">assume</span></span> f<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">∈</span> set <span class="free">fss</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> factorize_polys_map_square_free<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> sq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">p</span><span class="main">.</span> <span class="bound">p</span> <span class="main">∈</span> set <span class="free">fss</span> <span class="main">⟹</span> square_free <span class="bound">p</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">have</span></span> z<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">p</span><span class="main">.</span> <span class="bound">p</span> <span class="main">∈</span> set <span class="free">fss</span> <span class="main">⟹</span> <span class="bound">p</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> sq square_free_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> c<span class="main">:</span> <span class="quoted"><span class="quoted">"coprime <span class="main">(</span>prod_list <span class="free">fss</span><span class="main">)</span> <span class="main">(</span>pderiv <span class="main">(</span>prod_list <span class="free">fss</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> separable_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> square_free_iff_separable<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> factorize_polys_map_square_free_prod_list<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">from</span></span> coprime_prod_list<span class="main">[</span><span class="operator">OF</span> z c f<span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"coprime <span class="skolem">f</span> <span class="main">(</span>pderiv <span class="main">(</span>prod_list <span class="free">fss</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">pairwise_coprime_list</span><span class="main">::</span> <span class="quoted"><span class="quoted">"rat poly list <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">pairwise_coprime_list</span> <span class="free"><span class="bound"><span class="entity">qs</span></span></span> <span class="main">=</span> 
    <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">m</span></span> <span class="main">&lt;</span> length <span class="free"><span class="bound"><span class="entity">qs</span></span></span><span class="main">.</span> <span class="main">∀</span> <span class="bound"><span class="bound">n</span></span> <span class="main">&lt;</span> length <span class="free"><span class="bound"><span class="entity">qs</span></span></span><span class="main">.</span>
     <span class="bound">m</span> <span class="main">≠</span> <span class="bound">n</span> <span class="main">⟶</span> coprime <span class="main">(</span><span class="free"><span class="bound"><span class="entity">qs</span></span></span> <span class="main">!</span> <span class="bound">n</span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">qs</span></span></span> <span class="main">!</span> <span class="bound">m</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="comment1">(* Restating factorize_polys_map_coprime to match later definitions *)</span>
<span class="keyword1" id="BKR_Decision-coprime_factorize"><span class="command">lemma</span></span> coprime_factorize<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">qs</span><span class="main">::</span> <span class="quoted"><span class="quoted">"rat poly list"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"pairwise_coprime_list <span class="main">(</span>fst<span class="main">(</span>factorize_polys <span class="free">qs</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?fs</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"fst<span class="main">(</span>factorize_polys <span class="free">qs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">m</span></span> <span class="main">&lt;</span> length <span class="var">?fs</span><span class="main">.</span> <span class="main">∀</span> <span class="bound"><span class="bound">n</span></span> <span class="main">&lt;</span> length <span class="var">?fs</span><span class="main">.</span>
     <span class="bound">m</span> <span class="main">≠</span> <span class="bound">n</span> <span class="main">⟶</span> coprime <span class="main">(</span><span class="var">?fs</span> <span class="main">!</span> <span class="bound">n</span><span class="main">)</span> <span class="main">(</span><span class="var">?fs</span> <span class="main">!</span> <span class="bound">m</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">clarsimp</span> 
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">m</span> <span class="skolem">n</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">&lt;</span> length <span class="main">(</span>fst <span class="main">(</span>factorize_polys <span class="free">qs</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">&lt;</span> length <span class="main">(</span>fst <span class="main">(</span>factorize_polys <span class="free">qs</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">≠</span> <span class="skolem">n</span>"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">" algebraic_semidom_class.coprime <span class="main">(</span>fst <span class="main">(</span>factorize_polys <span class="free">qs</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">n</span><span class="main">)</span>
            <span class="main">(</span>fst <span class="main">(</span>factorize_polys <span class="free">qs</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">m</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹<span class="skolem">m</span> <span class="main">&lt;</span> length <span class="main">(</span>fst <span class="main">(</span>factorize_polys <span class="free">qs</span><span class="main">)</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">m</span> <span class="main">≠</span> <span class="skolem">n</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">n</span> <span class="main">&lt;</span> length <span class="main">(</span>fst <span class="main">(</span>factorize_polys <span class="free">qs</span><span class="main">)</span><span class="main">)</span>›</span></span> coprime_iff_coprime distinct_conv_nth factorize_polys_coprime factorize_polys_def factorize_polys_irreducible_monic<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> fstI nth_mem<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> pairwise_coprime_list_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="BKR_Decision-squarefree_factorization_degree"><span class="command">lemma</span></span> squarefree_factorization_degree<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"square_free_factorization <span class="free">p</span> <span class="main">(</span><span class="free">c</span><span class="main">,</span><span class="free">fs</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"degree <span class="free">p</span> <span class="main">=</span> sum_list <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">f</span><span class="main">,</span><span class="bound">c</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">c</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">*</span> degree <span class="bound">f</span><span class="main">)</span> <span class="free">fs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">=</span>
    Polynomial.smult <span class="free">c</span>
     <span class="main">(</span><span class="main">∏</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">i</span><span class="main">)</span><span class="main">∈</span>set <span class="free">fs</span><span class="main">.</span> <span class="bound">a</span> <span class="main">^</span> Suc <span class="bound">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> square_free_factorization_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"degree <span class="free">p</span> <span class="main">=</span> degree <span class="main">(</span><span class="main">∏</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">i</span><span class="main">)</span><span class="main">∈</span>set <span class="free">fs</span><span class="main">.</span> <span class="bound">a</span> <span class="main">^</span> Suc <span class="bound">i</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms square_free_factorizationD<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> degree <span class="main">(</span>prod_list <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">f</span><span class="main">,</span><span class="bound">c</span><span class="main">)</span><span class="main">.</span> <span class="bound">f</span> <span class="main">^</span> Suc <span class="bound">c</span><span class="main">)</span> <span class="free">fs</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms prod.distinct_set_conv_list square_free_factorizationD<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">i</span><span class="main">)</span><span class="main">←</span><span class="free">fs</span><span class="main">.</span> degree <span class="main">(</span><span class="bound">a</span> <span class="main">^</span> Suc <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> degree_prod_list_eq<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> o_def<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> assms degree_0 square_free_factorizationD<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">using</span></span> assms degree_0 square_free_factorizationD<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> prod.case_distrib<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> Polynomial.degree_power_eq add.commute assms degree_0 map_eq_conv plus_1_eq_Suc split_cong square_free_factorizationD<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>  
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Auxiliary Polynomial Lemmas"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">roots_of_coprime_r</span><span class="main">::</span> <span class="quoted"><span class="quoted">"real poly list <span class="main">⇒</span> real set"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">roots_of_coprime_r</span> <span class="free"><span class="bound"><span class="entity">qs</span></span></span> <span class="main">=</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="main">(</span>coprime_r <span class="free"><span class="bound"><span class="entity">qs</span></span></span><span class="main">)</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span>"</span></span>

<span class="keyword1" id="BKR_Decision-crb_lem_pos"><span class="command">lemma</span></span> crb_lem_pos<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">x</span><span class="main">::</span> <span class="quoted"><span class="quoted">"real"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">p</span><span class="main">::</span> <span class="quoted"><span class="quoted">"real poly"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"poly <span class="free">p</span> <span class="free">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">&lt;</span> crb <span class="free">p</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> cauchy_root_bound<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">p</span></span> <span class="quoted"><span class="free">x</span></span><span class="main">]</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">unfolding</span></span> crb_def <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> p x 
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span> 

<span class="keyword1" id="BKR_Decision-crb_lem_neg"><span class="command">lemma</span></span> crb_lem_neg<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">x</span><span class="main">::</span> <span class="quoted"><span class="quoted">"real"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">p</span><span class="main">::</span> <span class="quoted"><span class="quoted">"real poly"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"poly <span class="free">p</span> <span class="free">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">&gt;</span> <span class="main">-</span>crb <span class="free">p</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> cauchy_root_bound<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">p</span></span> <span class="quoted"><span class="free">x</span></span><span class="main">]</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">unfolding</span></span> crb_def <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> p x <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span> 

<span class="comment1">(* Show that the product of the polynomial list is 0 at x iff there is a polynomial 
  in the list that is 0 at x *)</span>
<span class="keyword1" id="BKR_Decision-prod_zero"><span class="command">lemma</span></span> prod_zero<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span> <span class="main">.</span> poly <span class="main">(</span>prod_list <span class="main">(</span><span class="free">qs</span><span class="main">::</span> rat poly list<span class="main">)</span><span class="main">)</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">q</span> <span class="main">∈</span> set <span class="main">(</span><span class="free">qs</span><span class="main">)</span><span class="main">.</span> poly <span class="bound">q</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">using</span></span> poly_prod_list_zero_iff <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">using</span></span> poly_prod_list_zero_iff <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="BKR_Decision-coprime_r_zero1"><span class="command">lemma</span></span> coprime_r_zero1<span class="main">:</span> <span class="quoted"><span class="quoted">"poly <span class="main">(</span>coprime_r <span class="free">qs</span><span class="main">)</span> <span class="main">(</span>crb <span class="main">(</span>prod_list <span class="free">qs</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> coprime_r_def<span class="main">)</span> 

<span class="keyword1" id="BKR_Decision-coprime_r_zero2"><span class="command">lemma</span></span> coprime_r_zero2<span class="main">:</span> <span class="quoted"><span class="quoted">"poly <span class="main">(</span>coprime_r <span class="free">qs</span><span class="main">)</span> <span class="main">(</span><span class="main">-</span>crb <span class="main">(</span>prod_list <span class="free">qs</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> coprime_r_def<span class="main">)</span> 

<span class="keyword1" id="BKR_Decision-coprime_mult"><span class="command">lemma</span></span> coprime_mult<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">a</span><span class="main">::</span> <span class="quoted"><span class="quoted">"real poly"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">b</span><span class="main">::</span> <span class="quoted"><span class="quoted">"real poly"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">c</span><span class="main">::</span> <span class="quoted"><span class="quoted">"real poly"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"algebraic_semidom_class.coprime <span class="free">a</span> <span class="free">b</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"algebraic_semidom_class.coprime <span class="free">a</span> <span class="free">c</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"algebraic_semidom_class.coprime <span class="free">a</span> <span class="main">(</span><span class="free">b</span><span class="main">*</span><span class="free">c</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="comment1">(* Will be needed when we call the BKR roots on coprime_r *)</span>
<span class="keyword1" id="BKR_Decision-coprime_r_coprime_prop"><span class="command">lemma</span></span> coprime_r_coprime_prop<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">ps</span><span class="main">::</span> <span class="quoted"><span class="quoted">"rat poly list"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"factorize_polys <span class="free">ps</span> <span class="main">=</span> <span class="main">(</span><span class="free">fs</span><span class="main">,</span><span class="free">data</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">fss</span> <span class="main">=</span> map real_of_rat_poly <span class="free">fs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">f</span><span class="main">.</span> <span class="bound">f</span> <span class="main">∈</span> set <span class="free">fss</span> <span class="main">⟹</span> coprime <span class="bound">f</span> <span class="main">(</span>coprime_r <span class="free">fss</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">clarsimp</span> 
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">f</span><span class="main">::</span> <span class="quoted"><span class="quoted">"real poly"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> f_in<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">∈</span> set <span class="free">fss</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> nonz_prod<span class="main">:</span> <span class="quoted"><span class="quoted">"prod_list <span class="free">fss</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> factorize_polys_map_square_free <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>2<span class="main">)</span> square_free_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span> 
  <span class="keyword1"><span class="command">have</span></span> nonz_f<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> f_in factorize_polys_map_square_free <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>2<span class="main">)</span> square_free_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span> 
  <span class="keyword1"><span class="command">have</span></span> copr_pderiv<span class="main">:</span> <span class="quoted"><span class="quoted">"algebraic_semidom_class.coprime <span class="skolem">f</span> <span class="main">(</span>pderiv <span class="main">(</span>prod_list <span class="free">fss</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> factorize_polys_map_coprime_pderiv
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> f_in assms<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
  <span class="keyword1"><span class="command">have</span></span> z_iff<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">.</span> poly <span class="skolem">f</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟶</span> poly <span class="main">(</span>prod_list <span class="free">fss</span><span class="main">)</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> f_in <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> poly_prod_list_zero_iff <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?inf_p</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">[:</span><span class="main">-</span><span class="main">(</span>crb <span class="main">(</span>prod_list <span class="free">fss</span><span class="main">)</span><span class="main">)</span><span class="main">,</span><span class="main">1</span><span class="main">:]</span><span class="main">::</span>real poly"</span></span>
  <span class="keyword1"><span class="command">have</span></span> copr_inf<span class="main">:</span> <span class="quoted"><span class="quoted">"algebraic_semidom_class.coprime <span class="skolem">f</span> <span class="main">(</span><span class="main">[:</span><span class="main">-</span><span class="main">(</span>crb <span class="main">(</span>prod_list <span class="free">fss</span><span class="main">)</span><span class="main">)</span><span class="main">,</span><span class="main">1</span><span class="main">:]</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
    <span class="keyword1"><span class="command">have</span></span> zero_prop<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">.</span> poly <span class="var">?inf_p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟷</span> <span class="bound">x</span> <span class="main">=</span> crb <span class="main">(</span>prod_list <span class="free">fss</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span>  <span class="quoted"><span class="quoted">"poly <span class="main">(</span>prod_list <span class="free">fss</span><span class="main">)</span> <span class="main">(</span>crb <span class="main">(</span>prod_list <span class="free">fss</span><span class="main">)</span><span class="main">)</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> h<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">.</span> poly <span class="main">(</span>prod_list <span class="free">fss</span><span class="main">)</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟶</span> <span class="bound">x</span> <span class="main">&lt;</span> <span class="main">(</span>crb <span class="main">(</span>prod_list <span class="free">fss</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> nonz_prod crb_lem_pos<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> p <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"prod_list <span class="free">fss</span>"</span></span><span class="main">]</span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span>  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> nonzero<span class="main">:</span> <span class="quoted"><span class="quoted">"poly <span class="skolem">f</span> <span class="main">(</span>crb <span class="main">(</span>prod_list <span class="free">fss</span><span class="main">)</span><span class="main">)</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> z_iff <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="main">(</span><span class="main">∃</span><span class="bound">x</span><span class="main">.</span> poly <span class="skolem">f</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> poly <span class="var">?inf_p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">have</span></span> is_unit_gcd<span class="main">:</span> <span class="quoted"><span class="quoted">"is_unit <span class="main">(</span>gcd <span class="var">?inf_p</span> <span class="skolem">f</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> prime_elem_imp_gcd_eq  prime_elem_iff_irreducible linear_irreducible_field
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> nonzero
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> f1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x0</span><span class="main">.</span> <span class="main">-</span> <span class="main">(</span><span class="bound">x0</span><span class="main">::</span>real<span class="main">)</span> <span class="main">=</span> <span class="main">-</span> <span class="main">1</span> <span class="main">*</span> <span class="bound">x0</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">1</span><span class="main">::</span>real<span class="main">)</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"is_unit <span class="main">(</span>gcd <span class="main">(</span>pCons <span class="main">(</span><span class="main">-</span> <span class="main">1</span> <span class="main">*</span> real_of_int <span class="main">(</span>crb <span class="main">(</span>prod_list <span class="free">fss</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">1</span><span class="main">)</span> <span class="skolem">f</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> f1 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> is_unit_gcd nonzero one_poly_eq_simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> poly_eq_0_iff_dvd prime_elem_imp_coprime prime_elem_linear_field_poly<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"degree <span class="main">(</span>gcd <span class="main">(</span>pCons <span class="main">(</span><span class="main">-</span> real_of_int <span class="main">(</span>crb <span class="main">(</span>prod_list <span class="free">fss</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">1</span><span class="main">)</span> <span class="skolem">f</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span> 
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> is_unit_gcd
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> gcd.commute gcd_eq_1_imp_coprime is_unit_gcd_iff<span class="main">)</span> 
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?ninf_p</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">[:</span><span class="main">(</span>crb <span class="main">(</span>prod_list <span class="free">fss</span><span class="main">)</span><span class="main">)</span><span class="main">,</span><span class="main">1</span><span class="main">:]</span><span class="main">::</span>real poly"</span></span>
  <span class="keyword1"><span class="command">have</span></span> copr_neg_inf<span class="main">:</span> <span class="quoted"><span class="quoted">"algebraic_semidom_class.coprime <span class="skolem">f</span> <span class="main">(</span><span class="main">[:</span><span class="main">(</span>crb <span class="main">(</span>prod_list <span class="free">fss</span><span class="main">)</span><span class="main">)</span><span class="main">,</span><span class="main">1</span><span class="main">:]</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
    <span class="keyword1"><span class="command">have</span></span> h<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">.</span> poly <span class="skolem">f</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟶</span> poly <span class="main">(</span>prod_list <span class="free">fss</span><span class="main">)</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> f_in <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> poly_prod_list_zero_iff <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
    <span class="keyword1"><span class="command">have</span></span> zero_prop<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">.</span> poly <span class="var">?ninf_p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟷</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">-</span>crb <span class="main">(</span>prod_list <span class="free">fss</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span>  <span class="quoted"><span class="quoted">"poly <span class="main">(</span>prod_list <span class="free">fss</span><span class="main">)</span> <span class="main">(</span><span class="main">-</span>crb <span class="main">(</span>prod_list <span class="free">fss</span><span class="main">)</span><span class="main">)</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span>  <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> h<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">.</span> poly <span class="main">(</span>prod_list <span class="free">fss</span><span class="main">)</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟶</span> <span class="bound">x</span> <span class="main">&gt;</span> <span class="main">(</span><span class="main">-</span>crb <span class="main">(</span>prod_list <span class="free">fss</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> nonz_prod crb_lem_neg<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> p <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"prod_list <span class="free">fss</span>"</span></span><span class="main">]</span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span>  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> nonzero<span class="main">:</span> <span class="quoted"><span class="quoted">"poly <span class="skolem">f</span> <span class="main">(</span><span class="main">-</span>crb <span class="main">(</span>prod_list <span class="free">fss</span><span class="main">)</span><span class="main">)</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> z_iff <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="main">(</span><span class="main">∃</span><span class="bound">x</span><span class="main">.</span> poly <span class="skolem">f</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> poly <span class="var">?ninf_p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> zero_prop <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> is_unit_gcd<span class="main">:</span> <span class="quoted"><span class="quoted">"is_unit <span class="main">(</span>gcd <span class="var">?ninf_p</span> <span class="skolem">f</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> prime_elem_imp_gcd_eq  prime_elem_iff_irreducible linear_irreducible_field
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> nonzero
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> f1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">1</span><span class="main">::</span>real<span class="main">)</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> pCons <span class="main">(</span>real_of_int <span class="main">(</span>crb <span class="main">(</span>prod_list <span class="free">fss</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">1</span> <span class="keyword1">dvd</span> <span class="skolem">f</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> nonzero <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"degree <span class="main">(</span>gcd <span class="main">(</span>pCons <span class="main">(</span>real_of_int <span class="main">(</span>crb <span class="main">(</span>prod_list <span class="free">fss</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">1</span><span class="main">)</span> <span class="skolem">f</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> f1 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> Missing_Polynomial_Factorial.is_unit_field_poly coprime_imp_gcd_eq_1 is_unit_gcd_iff one_poly_eq_simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> prime_elem_imp_coprime prime_elem_linear_field_poly<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
      <span class="keyword1"><span class="command">using</span></span> is_unit_gcd
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> gcd.commute gcd_eq_1_imp_coprime is_unit_gcd_iff<span class="main">)</span> 
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"algebraic_semidom_class.coprime <span class="skolem">f</span> <span class="main">(</span>coprime_r <span class="free">fss</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> copr_pderiv coprime_mult <span class="keyword1"><span class="command">unfolding</span></span> coprime_r_def
    <span class="keyword1"><span class="command">using</span></span> copr_inf copr_neg_inf <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="BKR_Decision-coprime_r_nonzero"><span class="command">lemma</span></span> coprime_r_nonzero<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">ps</span><span class="main">::</span> <span class="quoted"><span class="quoted">"rat poly list"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"factorize_polys <span class="free">ps</span> <span class="main">=</span> <span class="main">(</span><span class="free">fs</span><span class="main">,</span><span class="free">data</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> nonempty_fs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">fs</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> fss_is<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">fss</span> <span class="main">=</span> map real_of_rat_poly <span class="free">fs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>coprime_r <span class="free">fss</span><span class="main">)</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
  <span class="keyword1"><span class="command">have</span></span> nonempty_fss<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">fss</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> nonempty_fs fss_is <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> deg_f<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">f</span> <span class="main">∈</span> set <span class="main">(</span><span class="free">fs</span><span class="main">)</span><span class="main">.</span> degree <span class="bound">f</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> factorize_polys_irreducible_monic 
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> irreducible_degree_field <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> deg_fss<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">f</span> <span class="main">∈</span> set <span class="main">(</span><span class="free">fss</span><span class="main">)</span><span class="main">.</span> degree <span class="bound">f</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> fss_is <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> fss_nonz<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">f</span> <span class="main">∈</span> set <span class="main">(</span><span class="free">fss</span><span class="main">)</span><span class="main">.</span> <span class="bound">f</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">fss</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">(</span><span class="main">∀</span><span class="bound">f</span> <span class="main">∈</span> set <span class="main">(</span><span class="free">fss</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span>degree <span class="bound">f</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">∧</span> <span class="bound">f</span> <span class="main">≠</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span> degree <span class="main">(</span>prod_list <span class="free">fss</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">fss</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> Nil
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">fss</span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">clarsimp</span> 
      <span class="keyword3"><span class="command">assume</span></span> z_lt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> degree <span class="skolem">a</span>"</span></span>
      <span class="keyword3"><span class="command">assume</span></span> anonz<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
      <span class="keyword3"><span class="command">assume</span></span> fnonz<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">f</span><span class="main">∈</span>set <span class="skolem">fss</span><span class="main">.</span> <span class="main">0</span> <span class="main">&lt;</span> degree <span class="bound">f</span> <span class="main">∧</span> <span class="bound">f</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> h<span class="main">:</span> <span class="quoted"><span class="quoted">"degree <span class="main">(</span><span class="skolem">a</span> <span class="main">*</span> prod_list <span class="skolem">fss</span><span class="main">)</span> <span class="main">=</span> degree <span class="skolem">a</span> <span class="main">+</span> degree <span class="main">(</span>prod_list <span class="skolem">fss</span><span class="main">)</span> "</span></span>
        <span class="keyword1"><span class="command">using</span></span> degree_mult_eq<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> p <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span>"</span></span><span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> q <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"prod_list <span class="skolem">fss</span>"</span></span><span class="main">]</span> anonz fnonz 
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> degree <span class="main">(</span><span class="skolem">a</span> <span class="main">*</span> prod_list <span class="skolem">fss</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> z_lt Cons.hyps <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"degree <span class="main">(</span>prod_list <span class="free">fss</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> nonempty_fss deg_fss fss_nonz <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> pderiv_nonzero<span class="main">:</span> <span class="quoted"><span class="quoted">"pderiv <span class="main">(</span>prod_list <span class="free">fss</span><span class="main">)</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pderiv_eq_0_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">[:</span><span class="main">-</span><span class="main">(</span>crb <span class="main">(</span>prod_list <span class="free">fss</span><span class="main">)</span><span class="main">)</span><span class="main">,</span><span class="main">1</span><span class="main">:]</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">[:</span><span class="main">(</span>crb <span class="main">(</span>prod_list <span class="free">fss</span><span class="main">)</span><span class="main">)</span><span class="main">,</span><span class="main">1</span><span class="main">:]</span><span class="main">)</span><span class="main">)</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> pderiv_nonzero
    <span class="keyword1"><span class="command">unfolding</span></span> coprime_r_def <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> offset_poly_eq_0_lemma right_minus_eq synthetic_div_unique_lemma<span class="main">)</span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="BKR_Decision-Rolle_pderiv"><span class="command">lemma</span></span> Rolle_pderiv<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">q</span><span class="main">::</span> <span class="quoted"><span class="quoted">"real poly"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">x1</span> <span class="free">x2</span><span class="main">::</span> <span class="quoted"><span class="quoted">"real"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x1</span> <span class="main">&lt;</span> <span class="free">x2</span> <span class="main">∧</span> poly <span class="free">q</span> <span class="free">x1</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> poly <span class="free">q</span> <span class="free">x2</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">w</span><span class="main">.</span> <span class="free">x1</span> <span class="main">&lt;</span> <span class="bound">w</span> <span class="main">∧</span> <span class="bound">w</span> <span class="main">&lt;</span> <span class="free">x2</span> <span class="main">∧</span> poly <span class="main">(</span>pderiv <span class="free">q</span><span class="main">)</span> <span class="bound">w</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> Rolle_deriv <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> DERIV_unique Rolle continuous_at_imp_continuous_on poly_DERIV poly_differentiable poly_isCont<span class="main">)</span> 

<span class="keyword1" id="BKR_Decision-coprime_r_roots_prop"><span class="command">lemma</span></span> coprime_r_roots_prop<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">qs</span><span class="main">::</span> <span class="quoted"><span class="quoted">"real poly list"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> pairwise_rel_prime<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">q1</span> <span class="bound">q2</span><span class="main">.</span> <span class="main">(</span><span class="bound">q1</span> <span class="main">≠</span> <span class="bound">q2</span> <span class="main">∧</span> <span class="main">(</span>List.member <span class="free">qs</span> <span class="bound">q1</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span>List.member <span class="free">qs</span> <span class="bound">q2</span><span class="main">)</span><span class="main">)</span><span class="main">⟶</span> coprime <span class="bound">q1</span> <span class="bound">q2</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x1</span><span class="main">.</span> <span class="main">∀</span><span class="bound">x2</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="bound">x1</span> <span class="main">&lt;</span> <span class="bound">x2</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span><span class="bound">q1</span> <span class="main">∈</span> set <span class="main">(</span><span class="free">qs</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span>poly <span class="bound">q1</span> <span class="bound">x1</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span><span class="bound">q2</span><span class="main">∈</span> set<span class="main">(</span><span class="free">qs</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span>poly <span class="bound">q2</span> <span class="bound">x2</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">q</span><span class="main">.</span> <span class="bound">x1</span> <span class="main">&lt;</span> <span class="bound">q</span> <span class="main">∧</span> <span class="bound">q</span> <span class="main">&lt;</span> <span class="bound">x2</span> <span class="main">∧</span> poly <span class="main">(</span>coprime_r <span class="free">qs</span><span class="main">)</span> <span class="bound">q</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">clarsimp</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x1</span><span class="main">::</span> <span class="quoted"><span class="quoted">"real"</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x2</span><span class="main">::</span> <span class="quoted"><span class="quoted">"real"</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">q1</span><span class="main">::</span> <span class="quoted"><span class="quoted">"real poly"</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">q2</span><span class="main">::</span> <span class="quoted"><span class="quoted">"real poly"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x1</span> <span class="main">&lt;</span> <span class="skolem">x2</span>"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> q1_in<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">q1</span> <span class="main">∈</span> set <span class="free">qs</span>"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> q1_0<span class="main">:</span> <span class="quoted"><span class="quoted">"poly <span class="skolem">q1</span> <span class="skolem">x1</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> q2_in<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">q2</span> <span class="main">∈</span> set <span class="free">qs</span>"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> q2_0<span class="main">:</span> <span class="quoted"><span class="quoted">"poly <span class="skolem">q2</span> <span class="skolem">x2</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> prod_z_x1<span class="main">:</span> <span class="quoted"><span class="quoted">"poly <span class="main">(</span>prod_list <span class="free">qs</span><span class="main">)</span> <span class="skolem">x1</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> q1_in q1_0
    <span class="keyword1"><span class="command">using</span></span> poly_prod_list_zero_iff <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>  
  <span class="keyword1"><span class="command">have</span></span> prod_z_x2<span class="main">:</span> <span class="quoted"><span class="quoted">"poly <span class="main">(</span>prod_list <span class="free">qs</span><span class="main">)</span> <span class="skolem">x2</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> q2_in q2_0 
    <span class="keyword1"><span class="command">using</span></span> poly_prod_list_zero_iff <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">w</span></span><span class="main">&gt;</span><span class="skolem">x1</span><span class="main">.</span> <span class="bound">w</span> <span class="main">&lt;</span> <span class="skolem">x2</span> <span class="main">∧</span> poly <span class="main">(</span>pderiv <span class="main">(</span>prod_list <span class="free">qs</span><span class="main">)</span><span class="main">)</span> <span class="bound">w</span> <span class="main">=</span> <span class="main">0</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> Rolle_pderiv<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> q <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"prod_list <span class="free">qs</span>"</span></span><span class="main">]</span> prod_z_x1 prod_z_x2
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x1</span> <span class="main">&lt;</span> <span class="skolem">x2</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">w</span></span> <span class="keyword2"><span class="keyword">where</span></span> w_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="main">&gt;</span> <span class="skolem">x1</span> <span class="main">∧</span><span class="skolem">w</span> <span class="main">&lt;</span> <span class="skolem">x2</span> <span class="main">∧</span> poly <span class="main">(</span>pderiv <span class="main">(</span>prod_list <span class="free">qs</span><span class="main">)</span><span class="main">)</span> <span class="skolem">w</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"poly <span class="main">(</span>coprime_r <span class="free">qs</span><span class="main">)</span> <span class="skolem">w</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> coprime_r_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">q</span></span><span class="main">&gt;</span><span class="skolem">x1</span><span class="main">.</span> <span class="bound">q</span> <span class="main">&lt;</span> <span class="skolem">x2</span> <span class="main">∧</span> poly <span class="main">(</span>coprime_r <span class="free">qs</span><span class="main">)</span> <span class="bound">q</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> w_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Setting Up the Procedure: Lemmas"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">has_no_zeros</span><span class="main">::</span><span class="quoted"><span class="quoted">"rat list <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">has_no_zeros</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">0</span> <span class="main">∉</span> set <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="BKR_Decision-hnz_prop"><span class="command">lemma</span></span> hnz_prop<span class="main">:</span> <span class="quoted"><span class="quoted">"has_no_zeros <span class="free">l</span> <span class="main">⟷</span> <span class="main">¬</span><span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">k</span></span> <span class="main">&lt;</span> length <span class="free">l</span><span class="main">.</span> <span class="free">l</span> <span class="main">!</span> <span class="bound">k</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> has_no_zeros_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> in_set_conv_nth<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">cast_rat_list</span><span class="main">::</span> <span class="quoted"><span class="quoted">"rat poly list <span class="main">⇒</span> real poly list"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">cast_rat_list</span> <span class="free"><span class="bound"><span class="entity">qs</span></span></span> <span class="main">=</span> map real_of_rat_poly <span class="free"><span class="bound"><span class="entity">qs</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">consistent_sign_vectors_r</span><span class="main">::</span><span class="quoted"><span class="quoted">"real poly list <span class="main">⇒</span> real set <span class="main">⇒</span> rat list set"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">consistent_sign_vectors_r</span> <span class="free"><span class="bound"><span class="entity">qs</span></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">=</span> <span class="main">(</span>signs_at <span class="free"><span class="bound"><span class="entity">qs</span></span></span><span class="main">)</span> <span class="main">`</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span>"</span></span>

<span class="keyword1" id="BKR_Decision-consistent_sign_vectors_consistent_sign_vectors_r"><span class="command">lemma</span></span> consistent_sign_vectors_consistent_sign_vectors_r<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span><span class="quoted"><span class="quoted">"consistent_sign_vectors_r <span class="main">(</span>cast_rat_list <span class="free">qs</span><span class="main">)</span> <span class="free">S</span> <span class="main">=</span> consistent_sign_vectors <span class="free">qs</span> <span class="free">S</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> consistent_sign_vectors_r_def cast_rat_list_def consistent_sign_vectors_def
    sign_vec_def signs_at_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="comment1">(* Relies on coprime_rat_poly_real_poly *)</span>
<span class="keyword1" id="BKR_Decision-coprime_over_reals_coprime_over_rats"><span class="command">lemma</span></span> coprime_over_reals_coprime_over_rats<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">qs</span><span class="main">::</span> <span class="quoted"><span class="quoted">"rat poly list"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> csa_in<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">csa</span> <span class="main">∈</span> <span class="main">(</span>consistent_sign_vectors <span class="free">qs</span> UNIV<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> p1p2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p1</span><span class="main">≠</span><span class="free">p2</span> <span class="main">∧</span> <span class="free">p1</span> <span class="main">&lt;</span> length <span class="free">csa</span> <span class="main">∧</span> <span class="free">p2</span> <span class="main">&lt;</span> length <span class="free">csa</span> <span class="main">∧</span> <span class="free">csa</span> <span class="main">!</span> <span class="free">p1</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> <span class="free">csa</span> <span class="main">!</span> <span class="free">p2</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> algebraic_semidom_class.coprime <span class="main">(</span>nth <span class="free">qs</span> <span class="free">p1</span><span class="main">)</span> <span class="main">(</span>nth <span class="free">qs</span> <span class="free">p2</span><span class="main">)</span> "</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
  <span class="keyword1"><span class="command">have</span></span> isx<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="main">(</span><span class="bound">x</span><span class="main">::</span>real<span class="main">)</span><span class="main">.</span> <span class="free">csa</span> <span class="main">=</span> <span class="main">(</span>sign_vec <span class="free">qs</span> <span class="bound">x</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> csa_in <span class="keyword1"><span class="command">unfolding</span></span> consistent_sign_vectors_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="keyword2"><span class="keyword">where</span></span> havex<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">csa</span> <span class="main">=</span> <span class="main">(</span>sign_vec <span class="free">qs</span> <span class="skolem">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> expolys<span class="main">:</span> <span class="quoted"><span class="quoted">"poly <span class="main">(</span>real_of_rat_poly <span class="main">(</span>nth <span class="free">qs</span> <span class="free">p1</span><span class="main">)</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> poly <span class="main">(</span>real_of_rat_poly <span class="main">(</span>nth <span class="free">qs</span> <span class="free">p2</span><span class="main">)</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> havex <span class="keyword1"><span class="command">unfolding</span></span> sign_vec_def squash_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> class_field.neg_1_not_0 length_map map_map nth_map one_neq_zero p1p2<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> coprime <span class="main">(</span>real_of_rat_poly <span class="main">(</span>nth <span class="free">qs</span> <span class="free">p1</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span>real_of_rat_poly <span class="main">(</span>nth <span class="free">qs</span> <span class="free">p2</span><span class="main">)</span><span class="main">)</span><span class="main">::</span>real poly<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> coprime_poly_0 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> coprime_rat_poly_real_poly <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(* This and the following lemma are designed to show that if you have two sgas that aren't the same, 
   there's a 0 in between! The proof uses IVT. It hones in on the component that's changed sign 
   (either from 1 to {0, -1} or from -1 to {0, 1}) *)</span>
<span class="keyword1" id="BKR_Decision-zero_above"><span class="command">lemma</span></span> zero_above<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">qs</span><span class="main">::</span> <span class="quoted"><span class="quoted">"rat poly list"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">x1</span><span class="main">::</span> <span class="quoted"><span class="quoted">"real"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> hnz<span class="main">:</span> <span class="quoted"><span class="quoted">"has_no_zeros <span class="main">(</span>sign_vec <span class="free">qs</span> <span class="free">x1</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span> <span class="bound"><span class="bound">x2</span></span> <span class="main">&gt;</span> <span class="free">x1</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span>sign_vec <span class="free">qs</span> <span class="free">x1</span><span class="main">)</span> <span class="main">≠</span> <span class="main">(</span>sign_vec <span class="free">qs</span> <span class="bound">x2</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span> 
  <span class="main">(</span><span class="main">∃</span><span class="main">(</span><span class="bound"><span class="bound">r</span></span><span class="main">::</span>real<span class="main">)</span> <span class="main">&gt;</span> <span class="free">x1</span><span class="main">.</span> <span class="main">(</span><span class="bound">r</span> <span class="main">≤</span> <span class="bound">x2</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">q</span> <span class="main">∈</span> set<span class="main">(</span><span class="free">qs</span><span class="main">)</span><span class="main">.</span> rpoly <span class="bound">q</span> <span class="bound">r</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">clarsimp</span> 
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x2</span>
  <span class="keyword3"><span class="command">assume</span></span> x1_lt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x1</span> <span class="main">&lt;</span> <span class="skolem">x2</span>"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> diff_sign_vec<span class="main">:</span> <span class="quoted"><span class="quoted">"sign_vec <span class="free">qs</span> <span class="free">x1</span> <span class="main">≠</span> sign_vec <span class="free">qs</span> <span class="skolem">x2</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">q</span> <span class="main">∈</span> set <span class="free">qs</span><span class="main">.</span> squash <span class="main">(</span>rpoly <span class="bound">q</span> <span class="free">x1</span><span class="main">)</span> <span class="main">≠</span> squash <span class="main">(</span>rpoly <span class="bound">q</span> <span class="skolem">x2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> sign_vec_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">q</span></span> <span class="keyword2"><span class="keyword">where</span></span> q_prop<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">∈</span> set <span class="free">qs</span> <span class="main">∧</span> squash <span class="main">(</span>rpoly <span class="skolem">q</span> <span class="free">x1</span><span class="main">)</span> <span class="main">≠</span> squash <span class="main">(</span>rpoly <span class="skolem">q</span> <span class="skolem">x2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> q_in<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">∈</span> set <span class="free">qs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> poss1<span class="main">:</span> <span class="quoted"><span class="quoted">"squash <span class="main">(</span>rpoly <span class="skolem">q</span> <span class="free">x1</span><span class="main">)</span> <span class="main">=</span> <span class="main">-</span><span class="main">1</span> <span class="main">∧</span> squash <span class="main">(</span>rpoly <span class="skolem">q</span> <span class="skolem">x2</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">r</span></span><span class="main">&gt;</span><span class="free">x1</span><span class="main">.</span> <span class="bound">r</span> <span class="main">≤</span> <span class="skolem">x2</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span><span class="bound">q</span><span class="main">∈</span>set <span class="free">qs</span><span class="main">.</span> rpoly <span class="bound">q</span> <span class="bound">r</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> poly_IVT_pos<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">x1</span></span> <span class="quoted"><span class="skolem">x2</span></span><span class="main">]</span> <span class="keyword1"><span class="command">using</span></span> x1_lt <span class="keyword1"><span class="command">unfolding</span></span> squash_def <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> q_prop <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span> 
  <span class="keyword1"><span class="command">have</span></span> poss2<span class="main">:</span> <span class="quoted"><span class="quoted">"squash <span class="main">(</span>rpoly <span class="skolem">q</span> <span class="free">x1</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span> <span class="main">∧</span> squash <span class="main">(</span>rpoly <span class="skolem">q</span> <span class="skolem">x2</span><span class="main">)</span> <span class="main">=</span> <span class="main">-</span><span class="main">1</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">r</span></span><span class="main">&gt;</span><span class="free">x1</span><span class="main">.</span> <span class="bound">r</span> <span class="main">≤</span> <span class="skolem">x2</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span><span class="bound">q</span><span class="main">∈</span>set <span class="free">qs</span><span class="main">.</span> rpoly <span class="bound">q</span> <span class="bound">r</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> poly_IVT_neg<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">x1</span></span> <span class="quoted"><span class="skolem">x2</span></span><span class="main">]</span> <span class="keyword1"><span class="command">using</span></span> x1_lt <span class="keyword1"><span class="command">unfolding</span></span> squash_def <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> q_prop <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span> 
  <span class="keyword1"><span class="command">have</span></span> poss3<span class="main">:</span> <span class="quoted"><span class="quoted">"squash <span class="main">(</span>rpoly <span class="skolem">q</span> <span class="skolem">x2</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">r</span></span><span class="main">&gt;</span><span class="free">x1</span><span class="main">.</span> <span class="bound">r</span> <span class="main">≤</span> <span class="skolem">x2</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span><span class="bound">q</span><span class="main">∈</span>set <span class="free">qs</span><span class="main">.</span> rpoly <span class="bound">q</span> <span class="bound">r</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> x1_lt <span class="keyword1"><span class="command">unfolding</span></span> squash_def <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> q_prop <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">q</span> <span class="main">∈</span> set <span class="free">qs</span> <span class="main">∧</span> rpoly <span class="skolem">q</span> <span class="free">x1</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">¬</span>has_no_zeros <span class="main">(</span>sign_vec <span class="free">qs</span> <span class="free">x1</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> has_no_zeros_def sign_vec_def <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> image_iff squash_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> not_poss4<span class="main">:</span> <span class="quoted"><span class="quoted">"squash <span class="main">(</span>rpoly <span class="skolem">q</span> <span class="free">x1</span><span class="main">)</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> hnz q_in <span class="keyword1"><span class="command">unfolding</span></span> squash_def
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">q</span> <span class="main">∈</span> set <span class="free">qs</span> <span class="main">∧</span> rpoly <span class="skolem">q</span> <span class="free">x1</span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟶</span> <span class="main">¬</span> has_no_zeros <span class="main">(</span>sign_vec <span class="free">qs</span> <span class="free">x1</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">r</span></span><span class="main">&gt;</span><span class="free">x1</span><span class="main">.</span> <span class="bound">r</span> <span class="main">≤</span> <span class="skolem">x2</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span><span class="bound">q</span><span class="main">∈</span>set <span class="free">qs</span><span class="main">.</span> rpoly <span class="bound">q</span> <span class="bound">r</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> q_prop poss1 poss2 poss3 not_poss4 
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">meson</span> squash_def<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> squash_def<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> squash_def<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> squash_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="BKR_Decision-zero_below"><span class="command">lemma</span></span> zero_below<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">qs</span><span class="main">::</span> <span class="quoted"><span class="quoted">"rat poly list"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">x1</span><span class="main">::</span> <span class="quoted"><span class="quoted">"real"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> hnz<span class="main">:</span> <span class="quoted"><span class="quoted">"has_no_zeros <span class="main">(</span>sign_vec <span class="free">qs</span> <span class="free">x1</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">x2</span></span> <span class="main">&lt;</span> <span class="free">x1</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span>sign_vec <span class="free">qs</span> <span class="free">x1</span><span class="main">)</span> <span class="main">≠</span> <span class="main">(</span>sign_vec <span class="free">qs</span> <span class="bound">x2</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span> 
  <span class="main">(</span><span class="main">∃</span><span class="main">(</span><span class="bound"><span class="bound">r</span></span><span class="main">::</span>real<span class="main">)</span> <span class="main">&lt;</span> <span class="free">x1</span><span class="main">.</span> <span class="main">(</span><span class="bound">r</span> <span class="main">≥</span> <span class="bound">x2</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">q</span> <span class="main">∈</span> set<span class="main">(</span><span class="free">qs</span><span class="main">)</span><span class="main">.</span> rpoly <span class="bound">q</span> <span class="bound">r</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">clarsimp</span> 
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x2</span>
  <span class="keyword3"><span class="command">assume</span></span> x1_gt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x2</span> <span class="main">&lt;</span> <span class="free">x1</span>"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> diff_sign_vec<span class="main">:</span> <span class="quoted"><span class="quoted">"sign_vec <span class="free">qs</span> <span class="free">x1</span> <span class="main">≠</span> sign_vec <span class="free">qs</span> <span class="skolem">x2</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">q</span> <span class="main">∈</span> set <span class="free">qs</span><span class="main">.</span> squash <span class="main">(</span>rpoly <span class="bound">q</span> <span class="free">x1</span><span class="main">)</span> <span class="main">≠</span> squash <span class="main">(</span>rpoly <span class="bound">q</span> <span class="skolem">x2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> sign_vec_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">q</span></span> <span class="keyword2"><span class="keyword">where</span></span> q_prop<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">∈</span> set <span class="free">qs</span> <span class="main">∧</span> squash <span class="main">(</span>rpoly <span class="skolem">q</span> <span class="free">x1</span><span class="main">)</span> <span class="main">≠</span> squash <span class="main">(</span>rpoly <span class="skolem">q</span> <span class="skolem">x2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> q_in<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">∈</span> set <span class="free">qs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> poss1<span class="main">:</span> <span class="quoted"><span class="quoted">"squash <span class="main">(</span>rpoly <span class="skolem">q</span> <span class="free">x1</span><span class="main">)</span> <span class="main">=</span> <span class="main">-</span><span class="main">1</span> <span class="main">∧</span> squash <span class="main">(</span>rpoly <span class="skolem">q</span> <span class="skolem">x2</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">r</span></span><span class="main">&lt;</span><span class="free">x1</span><span class="main">.</span> <span class="main">(</span><span class="bound">r</span> <span class="main">≥</span> <span class="skolem">x2</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">q</span> <span class="main">∈</span> set<span class="main">(</span><span class="free">qs</span><span class="main">)</span><span class="main">.</span> rpoly <span class="bound">q</span> <span class="bound">r</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> poly_IVT_neg<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">x2</span></span> <span class="quoted"><span class="free">x1</span></span><span class="main">]</span> <span class="keyword1"><span class="command">using</span></span> x1_gt <span class="keyword1"><span class="command">unfolding</span></span> squash_def <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> q_prop <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span> 
  <span class="keyword1"><span class="command">have</span></span> poss2<span class="main">:</span> <span class="quoted"><span class="quoted">"squash <span class="main">(</span>rpoly <span class="skolem">q</span> <span class="free">x1</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span> <span class="main">∧</span> squash <span class="main">(</span>rpoly <span class="skolem">q</span> <span class="skolem">x2</span><span class="main">)</span> <span class="main">=</span> <span class="main">-</span><span class="main">1</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">r</span></span><span class="main">&lt;</span><span class="free">x1</span><span class="main">.</span> <span class="main">(</span><span class="bound">r</span> <span class="main">≥</span> <span class="skolem">x2</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">q</span> <span class="main">∈</span> set<span class="main">(</span><span class="free">qs</span><span class="main">)</span><span class="main">.</span> rpoly <span class="bound">q</span> <span class="bound">r</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> poly_IVT_pos<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">x2</span></span> <span class="quoted"><span class="free">x1</span></span><span class="main">]</span> <span class="keyword1"><span class="command">using</span></span> x1_gt <span class="keyword1"><span class="command">unfolding</span></span> squash_def <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> q_prop <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span> 
  <span class="keyword1"><span class="command">have</span></span> poss3<span class="main">:</span> <span class="quoted"><span class="quoted">"squash <span class="main">(</span>rpoly <span class="skolem">q</span> <span class="skolem">x2</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">r</span></span><span class="main">&lt;</span><span class="free">x1</span><span class="main">.</span> <span class="main">(</span><span class="bound">r</span> <span class="main">≥</span> <span class="skolem">x2</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">q</span> <span class="main">∈</span> set<span class="main">(</span><span class="free">qs</span><span class="main">)</span><span class="main">.</span> rpoly <span class="bound">q</span> <span class="bound">r</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> x1_gt <span class="keyword1"><span class="command">unfolding</span></span> squash_def <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> q_prop <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">q</span> <span class="main">∈</span> set <span class="free">qs</span> <span class="main">∧</span> rpoly <span class="skolem">q</span> <span class="free">x1</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">¬</span>has_no_zeros <span class="main">(</span>sign_vec <span class="free">qs</span> <span class="free">x1</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> has_no_zeros_def sign_vec_def <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">using</span></span> image_iff squash_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> image_iff squash_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> not_poss4<span class="main">:</span> <span class="quoted"><span class="quoted">"squash <span class="main">(</span>rpoly <span class="skolem">q</span> <span class="free">x1</span><span class="main">)</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> hnz q_in <span class="keyword1"><span class="command">unfolding</span></span> squash_def
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">q</span> <span class="main">∈</span> set <span class="free">qs</span> <span class="main">∧</span> rpoly <span class="skolem">q</span> <span class="free">x1</span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟶</span> <span class="main">¬</span> has_no_zeros <span class="main">(</span>sign_vec <span class="free">qs</span> <span class="free">x1</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">r</span></span><span class="main">&lt;</span><span class="free">x1</span><span class="main">.</span> <span class="main">(</span><span class="bound">r</span> <span class="main">≥</span> <span class="skolem">x2</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">q</span> <span class="main">∈</span> set<span class="main">(</span><span class="free">qs</span><span class="main">)</span><span class="main">.</span> rpoly <span class="bound">q</span> <span class="bound">r</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> q_prop poss1 poss2 poss3 not_poss4 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">meson</span> squash_def<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> squash_def<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> squash_def<span class="main">)</span>
       <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> squash_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="BKR_Decision-sorted_list_lemma"><span class="command">lemma</span></span> sorted_list_lemma<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">l</span><span class="main">::</span> <span class="quoted"><span class="quoted">"real list"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">a</span> <span class="free">b</span><span class="main">::</span> <span class="quoted"><span class="quoted">"real"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">n</span><span class="main">::</span> <span class="quoted"><span class="quoted">"nat"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">&lt;</span> <span class="free">b</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">&lt;</span> length <span class="free">l</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> strict_sort<span class="main">:</span> <span class="quoted"><span class="quoted">"strict_sorted <span class="free">l</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> lt_a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">l</span> <span class="main">!</span> <span class="free">n</span><span class="main">)</span> <span class="main">&lt;</span> <span class="free">a</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> b_lt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">&lt;</span> <span class="main">(</span><span class="free">l</span> <span class="main">!</span> <span class="main">(</span><span class="free">n</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="main">(</span><span class="main">∃</span><span class="main">(</span><span class="bound">x</span><span class="main">::</span>real<span class="main">)</span><span class="main">.</span> <span class="main">(</span>List.member <span class="free">l</span> <span class="bound">x</span> <span class="main">∧</span> <span class="free">a</span> <span class="main">≤</span> <span class="bound">x</span> <span class="main">∧</span> <span class="bound">x</span> <span class="main">≤</span> <span class="free">b</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> sorted_hyp_var<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">q1</span></span> <span class="main">&lt;</span> length <span class="free">l</span><span class="main">.</span> <span class="main">∀</span><span class="bound"><span class="bound">q2</span></span> <span class="main">&lt;</span> length <span class="free">l</span><span class="main">.</span> <span class="main">(</span><span class="bound">q1</span> <span class="main">&lt;</span> <span class="bound">q2</span> <span class="main">⟶</span>
     <span class="main">(</span><span class="free">l</span> <span class="main">!</span> <span class="bound">q1</span><span class="main">)</span> <span class="main">&lt;</span> <span class="main">(</span><span class="free">l</span> <span class="main">!</span> <span class="bound">q2</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> strict_sort sorted_wrt_iff_nth_less strict_sorted_sorted_wrt<span class="main">)</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> sorted_hyp_var2<span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">q1</span></span> <span class="main">&lt;</span> length <span class="free">l</span><span class="main">.</span> <span class="main">∀</span><span class="bound"><span class="bound">q2</span></span> <span class="main">&lt;</span> length <span class="free">l</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="free">l</span> <span class="main">!</span> <span class="bound">q1</span><span class="main">)</span> <span class="main">&lt;</span> <span class="main">(</span><span class="free">l</span> <span class="main">!</span> <span class="bound">q2</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span> <span class="bound">q1</span> <span class="main">&lt;</span> <span class="bound">q2</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> linorder_neqE_nat
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Groups.add_ac<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> add_mono_thms_linordered_field<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> less_irrefl<span class="main">)</span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="main">(</span><span class="bound">x</span><span class="main">::</span>real<span class="main">)</span><span class="main">.</span> <span class="main">(</span>List.member <span class="free">l</span> <span class="bound">x</span> <span class="main">∧</span> <span class="free">a</span> <span class="main">≤</span> <span class="bound">x</span> <span class="main">∧</span> <span class="bound">x</span> <span class="main">≤</span> <span class="free">b</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> False"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="main">(</span><span class="bound">x</span><span class="main">::</span>real<span class="main">)</span><span class="main">.</span> <span class="main">(</span>List.member <span class="free">l</span> <span class="bound">x</span> <span class="main">∧</span> <span class="free">a</span> <span class="main">≤</span> <span class="bound">x</span> <span class="main">∧</span> <span class="bound">x</span> <span class="main">≤</span> <span class="free">b</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="keyword2"><span class="keyword">where</span></span> x_prop<span class="main">:</span> <span class="quoted"><span class="quoted">"List.member <span class="free">l</span> <span class="skolem">x</span> <span class="main">∧</span> <span class="free">a</span> <span class="main">≤</span> <span class="skolem">x</span> <span class="main">∧</span> <span class="skolem">x</span> <span class="main">≤</span> <span class="free">b</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> l_prop<span class="main">:</span> <span class="quoted"><span class="quoted">"List.member <span class="free">l</span> <span class="skolem">x</span> <span class="main">∧</span> <span class="main">(</span><span class="free">l</span> <span class="main">!</span> <span class="free">n</span><span class="main">)</span> <span class="main">&lt;</span> <span class="skolem">x</span> <span class="main">∧</span> <span class="skolem">x</span> <span class="main">&lt;</span> <span class="main">(</span><span class="free">l</span> <span class="main">!</span> <span class="main">(</span><span class="free">n</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> lt_a b_lt <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> nth_l<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">!</span> <span class="free">n</span> <span class="main">&lt;</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> l_prop <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> np1th_l<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">&lt;</span> <span class="free">l</span> <span class="main">!</span> <span class="main">(</span><span class="free">n</span><span class="main">+</span><span class="main">1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> l_prop <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">k</span><span class="main">.</span> <span class="bound">k</span> <span class="main">&lt;</span> length <span class="free">l</span> <span class="main">∧</span> nth <span class="free">l</span> <span class="bound">k</span> <span class="main">=</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> l_prop
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> in_set_member index_of_lookup<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> index_of_lookup<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> k_prop<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">&lt;</span> length <span class="free">l</span> <span class="main">∧</span> nth <span class="free">l</span> <span class="skolem">k</span> <span class="main">=</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> n_lt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&lt;</span> <span class="skolem">k</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> nth_l sorted_hyp_var k_prop add_lessD1 assms<span class="main">(</span>2<span class="main">)</span> linorder_neqE_nat nat_SN.gt_trans
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> sorted_hyp_var2<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> k_gt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">&lt;</span> <span class="free">n</span> <span class="main">+</span> <span class="main">1</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> sorted_hyp_var np1th_l k_prop
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> sorted_hyp_var2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> 
      <span class="keyword1"><span class="command">using</span></span> n_lt k_gt <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(* This lemma shows that any zero of coprime_r is either between two roots or it's smaller than the 
least root (neg inf) or it's greater than the biggest root (pos inf). *)</span>
<span class="keyword1" id="BKR_Decision-roots_of_coprime_r_location_property"><span class="command">lemma</span></span> roots_of_coprime_r_location_property<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">qs</span><span class="main">::</span> <span class="quoted"><span class="quoted">"rat poly list"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">sga</span><span class="main">::</span> <span class="quoted"><span class="quoted">"rat list"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">zer_list</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> pairwise_rel_prime<span class="main">:</span> <span class="quoted"><span class="quoted">"pairwise_coprime_list <span class="free">qs</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> all_squarefree<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">q</span><span class="main">.</span> <span class="bound">q</span> <span class="main">∈</span> set <span class="free">qs</span> <span class="main">⟹</span> rsquarefree <span class="bound">q</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> x1_prop<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">sga</span> <span class="main">=</span> sign_vec <span class="free">qs</span> <span class="free">x1</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> hnz<span class="main">:</span> <span class="quoted"><span class="quoted">"has_no_zeros <span class="free">sga</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> zer_list_prop<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">zer_list</span> <span class="main">=</span> sorted_list_of_set <span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">::</span>real<span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="main">∃</span><span class="bound">q</span> <span class="main">∈</span> set<span class="main">(</span><span class="free">qs</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span>rpoly <span class="bound">q</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">zer_list</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">(</span><span class="free">x1</span> <span class="main">&lt;</span> <span class="main">(</span><span class="free">zer_list</span> <span class="main">!</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">∨</span> <span class="main">(</span><span class="free">x1</span> <span class="main">&gt;</span> <span class="main">(</span><span class="free">zer_list</span> <span class="main">!</span> <span class="main">(</span>length <span class="free">zer_list</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">∨</span>
    <span class="main">(</span><span class="main">∃</span> <span class="bound"><span class="bound">n</span></span> <span class="main">&lt;</span> <span class="main">(</span>length <span class="free">zer_list</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">.</span> <span class="free">x1</span> <span class="main">&gt;</span> <span class="main">(</span><span class="free">zer_list</span> <span class="main">!</span> <span class="bound">n</span><span class="main">)</span> <span class="main">∧</span> <span class="free">x1</span> <span class="main">&lt;</span> <span class="main">(</span><span class="free">zer_list</span> <span class="main">!</span> <span class="main">(</span><span class="bound">n</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?zer_list</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"sorted_list_of_set <span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">::</span>real<span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="main">∃</span><span class="bound">q</span> <span class="main">∈</span> set<span class="main">(</span><span class="free">qs</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span>rpoly <span class="bound">q</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span><span class="main">}</span> <span class="main">::</span> real list"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">∀</span><span class="bound">q</span><span class="main">.</span> <span class="main">(</span>List.member <span class="free">qs</span> <span class="bound">q</span><span class="main">)</span> <span class="main">⟶</span> <span class="bound">q</span> <span class="main">≠</span> <span class="main">0</span><span class="main">)</span> <span class="main">∧</span> has_no_zeros <span class="main">(</span>sign_vec <span class="free">qs</span> <span class="free">x1</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">¬</span> List.member <span class="var">?zer_list</span> <span class="free">x1</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">qs</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> Nil
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> member_rec<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span> 
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">qs</span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">clarsimp</span> 
        <span class="keyword3"><span class="command">assume</span></span> imp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">∀</span><span class="bound">q</span><span class="main">.</span> List.member <span class="skolem">qs</span> <span class="bound">q</span> <span class="main">⟶</span> <span class="bound">q</span> <span class="main">≠</span> <span class="main">0</span><span class="main">)</span> <span class="main">∧</span>
     has_no_zeros <span class="main">(</span>sign_vec <span class="skolem">qs</span> <span class="free">x1</span><span class="main">)</span> <span class="main">⟹</span>
     <span class="main">¬</span> List.member <span class="main">(</span>sorted_list_of_set <span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="main">∃</span><span class="bound">q</span><span class="main">∈</span>set <span class="skolem">qs</span><span class="main">.</span> rpoly <span class="bound">q</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span><span class="main">)</span>
         <span class="free">x1</span><span class="main">)</span>"</span></span>
        <span class="keyword3"><span class="command">assume</span></span> nonz<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">q</span><span class="main">.</span> List.member <span class="main">(</span><span class="skolem">a</span> <span class="main">#</span> <span class="skolem">qs</span><span class="main">)</span> <span class="bound">q</span> <span class="main">⟶</span> <span class="bound">q</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
        <span class="keyword3"><span class="command">assume</span></span> hnz<span class="main">:</span> <span class="quoted"><span class="quoted">" has_no_zeros <span class="main">(</span>sign_vec <span class="main">(</span><span class="skolem">a</span> <span class="main">#</span> <span class="skolem">qs</span><span class="main">)</span> <span class="free">x1</span><span class="main">)</span>"</span></span>
        <span class="keyword3"><span class="command">assume</span></span> mem_list<span class="main">:</span> <span class="quoted"><span class="quoted">"List.member
     <span class="main">(</span>sorted_list_of_set <span class="main">{</span><span class="bound">x</span><span class="main">.</span> rpoly <span class="skolem">a</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound">q</span><span class="main">∈</span>set <span class="skolem">qs</span><span class="main">.</span> rpoly <span class="bound">q</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span><span class="main">}</span><span class="main">)</span>
     <span class="free">x1</span>"</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"has_no_zeros <span class="main">(</span>sign_vec <span class="main">(</span><span class="skolem">a</span> <span class="main">#</span> <span class="skolem">qs</span><span class="main">)</span> <span class="free">x1</span><span class="main">)</span> <span class="main">⟹</span> has_no_zeros <span class="main">(</span>sign_vec <span class="skolem">qs</span> <span class="free">x1</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
          <span class="keyword3"><span class="command">assume</span></span> hnz<span class="main">:</span> <span class="quoted"><span class="quoted">"has_no_zeros <span class="main">(</span>sign_vec <span class="main">(</span><span class="skolem">a</span> <span class="main">#</span> <span class="skolem">qs</span><span class="main">)</span> <span class="free">x1</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">have</span></span> same_vec<span class="main">:</span> <span class="quoted"><span class="quoted">"sign_vec <span class="main">(</span><span class="skolem">a</span> <span class="main">#</span> <span class="skolem">qs</span><span class="main">)</span> <span class="free">x1</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="keyword1">if</span> rpoly <span class="skolem">a</span> <span class="free">x1</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="keyword1">if</span> rpoly <span class="skolem">a</span> <span class="free">x1</span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="main">0</span> <span class="keyword1">else</span> <span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">#</span> sign_vec <span class="main">(</span><span class="skolem">qs</span><span class="main">)</span> <span class="free">x1</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">unfolding</span></span> sign_vec_def squash_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"has_no_zeros <span class="main">(</span><span class="main">(</span><span class="keyword1">if</span> rpoly <span class="skolem">a</span> <span class="free">x1</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="keyword1">if</span> rpoly <span class="skolem">a</span> <span class="free">x1</span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="main">0</span> <span class="keyword1">else</span> <span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">#</span> sign_vec <span class="main">(</span><span class="skolem">qs</span><span class="main">)</span> <span class="free">x1</span><span class="main">)</span>
            <span class="main">⟹</span>  has_no_zeros <span class="main">(</span>sign_vec <span class="main">(</span><span class="skolem">qs</span><span class="main">)</span> <span class="free">x1</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> has_no_zeros_def<span class="main">)</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"has_no_zeros <span class="main">(</span>sign_vec <span class="skolem">qs</span> <span class="free">x1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> hnz same_vec <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> nmem<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> List.member <span class="main">(</span>sorted_list_of_set <span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="main">∃</span><span class="bound">q</span><span class="main">∈</span>set <span class="skolem">qs</span><span class="main">.</span> rpoly <span class="bound">q</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span><span class="main">)</span> <span class="free">x1</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> hnz nonz imp <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> member_rec<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">q</span> <span class="main">∈</span>set <span class="skolem">qs</span><span class="main">.</span> <span class="bound">q</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> nonz <span class="keyword1"><span class="command">using</span></span> in_set_member <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span> 
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">q</span> <span class="main">∈</span>set <span class="skolem">qs</span><span class="main">.</span> finite <span class="main">{</span><span class="bound">x</span><span class="main">.</span> rpoly <span class="bound">q</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> poly_roots_finite<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> fin_set<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="main">∃</span><span class="bound">q</span><span class="main">∈</span>set <span class="skolem">qs</span><span class="main">.</span> rpoly <span class="bound">q</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">have</span></span> not_in<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x1</span> <span class="main">∉</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="main">∃</span><span class="bound">q</span><span class="main">∈</span>set <span class="skolem">qs</span><span class="main">.</span> rpoly <span class="bound">q</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> fin_set nmem set_sorted_list_of_set
            all_squarefree
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> List.member_def <span class="quoted"><span class="quoted">‹finite <span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="main">∃</span><span class="bound">q</span><span class="main">∈</span>set <span class="skolem">qs</span><span class="main">.</span> rpoly <span class="bound">q</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span>›</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">have</span></span> x1_in<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x1</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> rpoly <span class="skolem">a</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound">q</span><span class="main">∈</span>set <span class="skolem">qs</span><span class="main">.</span> rpoly <span class="bound">q</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span><span class="main">}</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> mem_list sorted_list_of_set 
        <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
          <span class="keyword1"><span class="command">have</span></span> f1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">r</span> <span class="bound">R</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="bound">r</span><span class="main">::</span>real<span class="main">)</span> <span class="main">∈</span> <span class="bound">R</span> <span class="main">∨</span> <span class="main">¬</span> List.member <span class="main">(</span>sorted_list_of_set <span class="bound">R</span><span class="main">)</span> <span class="bound">r</span><span class="main">)</span> <span class="main">∨</span> infinite <span class="bound">R</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> in_set_member set_sorted_list_of_set<span class="main">)</span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="bound">r</span><span class="main">.</span> rpoly <span class="skolem">a</span> <span class="main">(</span><span class="bound">r</span><span class="main">::</span>real<span class="main">)</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> List.finite_set member_rec<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> nonz real_roots_of_rat_poly<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
            <span class="keyword1"><span class="command">using</span></span> f1 <span class="quoted"><span class="quoted">‹finite <span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="main">∃</span><span class="bound">q</span><span class="main">∈</span>set <span class="skolem">qs</span><span class="main">.</span> rpoly <span class="bound">q</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span>›</span></span> mem_list <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"rpoly <span class="skolem">a</span> <span class="free">x1</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> hnz 
          <span class="keyword1"><span class="command">unfolding</span></span> has_no_zeros_def sign_vec_def squash_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"False"</span></span> <span class="keyword1"><span class="command">using</span></span> not_in x1_in 
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> non_mem<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> List.member <span class="var">?zer_list</span> <span class="free">x1</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> all_squarefree <span class="keyword1"><span class="command">unfolding</span></span> rsquarefree_def hnz <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> hnz x1_prop
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> in_set_member<span class="main">)</span> 
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?zer_list</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">(</span><span class="free">x1</span> <span class="main">≥</span> <span class="main">(</span><span class="var">?zer_list</span> <span class="main">!</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="free">x1</span> <span class="main">≤</span> <span class="main">(</span><span class="var">?zer_list</span> <span class="main">!</span> <span class="main">(</span>length <span class="var">?zer_list</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
<span class="main">⟹</span> <span class="main">(</span><span class="main">∃</span> <span class="bound"><span class="bound">n</span></span> <span class="main">&lt;</span> <span class="main">(</span>length <span class="var">?zer_list</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">.</span> <span class="free">x1</span> <span class="main">&gt;</span> <span class="main">(</span><span class="var">?zer_list</span> <span class="main">!</span> <span class="bound">n</span><span class="main">)</span> <span class="main">∧</span> <span class="free">x1</span> <span class="main">&lt;</span> <span class="main">(</span><span class="var">?zer_list</span> <span class="main">!</span> <span class="main">(</span><span class="bound">n</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="var">?zer_list</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
      <span class="keyword3"><span class="command">assume</span></span> x1_asm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x1</span> <span class="main">≥</span> <span class="main">(</span><span class="var">?zer_list</span> <span class="main">!</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="free">x1</span> <span class="main">≤</span> <span class="main">(</span><span class="var">?zer_list</span> <span class="main">!</span> <span class="main">(</span>length <span class="var">?zer_list</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> nm1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x1</span> <span class="main">≠</span> <span class="var">?zer_list</span> <span class="main">!</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> non_mem
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹sorted_list_of_set <span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="main">∃</span><span class="bound">q</span><span class="main">∈</span>set <span class="free">qs</span><span class="main">.</span> rpoly <span class="bound">q</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span> <span class="main">≠</span> <span class="main">[]</span>›</span></span> in_set_member
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> in_set_conv_nth length_greater_0_conv<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> nm2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x1</span> <span class="main">≠</span> <span class="var">?zer_list</span> <span class="main">!</span> <span class="main">(</span>length <span class="var">?zer_list</span> <span class="main">-</span><span class="main">1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> non_mem
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> One_nat_def <span class="quoted"><span class="quoted">‹sorted_list_of_set <span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="main">∃</span><span class="bound">q</span><span class="main">∈</span>set <span class="free">qs</span><span class="main">.</span> rpoly <span class="bound">q</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span> <span class="main">≠</span> <span class="main">[]</span>›</span></span> diff_Suc_less in_set_member length_greater_0_conv nth_mem<span class="main">)</span> 
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> x_asm_var<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x1</span> <span class="main">&gt;</span> <span class="main">(</span><span class="var">?zer_list</span> <span class="main">!</span> <span class="main">0</span><span class="main">)</span> <span class="main">∧</span> <span class="free">x1</span> <span class="main">&lt;</span> <span class="var">?zer_list</span> <span class="main">!</span> <span class="main">(</span>length <span class="var">?zer_list</span> <span class="main">-</span><span class="main">1</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> x1_asm nm1 nm2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">n</span><span class="main">.</span> <span class="main">(</span><span class="bound">n</span> <span class="main">&lt;</span> <span class="main">(</span>length <span class="var">?zer_list</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">∧</span>  <span class="free">x1</span> <span class="main">≥</span> <span class="main">(</span><span class="var">?zer_list</span> <span class="main">!</span> <span class="bound">n</span><span class="main">)</span> <span class="main">⟶</span> <span class="free">x1</span> <span class="main">≥</span> <span class="main">(</span><span class="var">?zer_list</span> <span class="main">!</span> <span class="main">(</span><span class="bound">n</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> False"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
        <span class="keyword3"><span class="command">assume</span></span> assump<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">n</span><span class="main">.</span> <span class="main">(</span><span class="bound">n</span> <span class="main">&lt;</span> <span class="main">(</span>length <span class="var">?zer_list</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">∧</span>  <span class="free">x1</span> <span class="main">≥</span> <span class="main">(</span><span class="var">?zer_list</span> <span class="main">!</span> <span class="bound">n</span><span class="main">)</span> <span class="main">⟶</span> <span class="free">x1</span> <span class="main">≥</span> <span class="main">(</span><span class="var">?zer_list</span> <span class="main">!</span> <span class="main">(</span><span class="bound">n</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">have</span></span> zer_case<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x1</span> <span class="main">≥</span> <span class="var">?zer_list</span> <span class="main">!</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> x_asm_var <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">have</span></span> all_n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">n</span><span class="main">.</span> <span class="main">(</span><span class="bound">n</span> <span class="main">&lt;</span> <span class="main">(</span>length <span class="var">?zer_list</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">⟶</span> <span class="free">x1</span> <span class="main">≥</span> <span class="var">?zer_list</span> <span class="main">!</span> <span class="bound">n</span><span class="main">)</span> "</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
          <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">n</span>
          <span class="keyword3"><span class="command">show</span></span> n_lt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">n</span> <span class="main">&lt;</span> <span class="main">(</span>length <span class="var">?zer_list</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">⟶</span> <span class="free">x1</span> <span class="main">≥</span> <span class="var">?zer_list</span> <span class="main">!</span> <span class="skolem">n</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">n</span></span><span class="main">)</span>
            <span class="keyword3"><span class="command">case</span></span> 0
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> zer_case
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
          <span class="keyword1"><span class="command">next</span></span>
            <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
              <span class="keyword1"><span class="command">using</span></span> assump
              <span class="keyword1"><span class="command">using</span></span> Suc_eq_plus1 Suc_lessD <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span> 
          <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>length <span class="var">?zer_list</span> <span class="main">-</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">≤</span> length <span class="var">?zer_list</span> <span class="main">-</span><span class="main">1</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> diff_le_mono2 one_le_numeral <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">x1</span> <span class="main">≥</span> <span class="var">?zer_list</span> <span class="main">!</span> <span class="main">(</span>length <span class="var">?zer_list</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
          <span class="keyword1"><span class="command">have</span></span> h1<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="var">?zer_list</span> <span class="main">=</span> <span class="main">1</span> <span class="main">⟶</span> <span class="free">x1</span> <span class="main">≥</span> <span class="var">?zer_list</span> <span class="main">!</span> <span class="main">(</span>length <span class="var">?zer_list</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> assump zer_case <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">have</span></span> h2<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="var">?zer_list</span> <span class="main">&gt;</span> <span class="main">1</span> <span class="main">⟶</span> <span class="free">x1</span> <span class="main">≥</span> <span class="var">?zer_list</span> <span class="main">!</span> <span class="main">(</span>length <span class="var">?zer_list</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> all_n assump <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> Suc_diff_Suc lessI<span class="main">)</span> 
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> h1 h2 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
            <span class="keyword1"><span class="command">using</span></span> zer_case <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> all_n x_asm_var  
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span> 
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> x1_asm
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> One_nat_def Suc_pred <span class="quoted"><span class="quoted">‹sorted_list_of_set <span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="main">∃</span><span class="bound">q</span><span class="main">∈</span>set <span class="free">qs</span><span class="main">.</span> rpoly <span class="bound">q</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span> <span class="main">≠</span> <span class="main">[]</span>›</span></span> in_set_member length_greater_0_conv less_SucI non_mem nth_mem<span class="main">)</span> 
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> h1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?zer_list</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">∧</span> <span class="main">(</span><span class="free">x1</span> <span class="main">≥</span> <span class="main">(</span><span class="var">?zer_list</span> <span class="main">!</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="free">x1</span> <span class="main">≤</span> <span class="main">(</span><span class="var">?zer_list</span> <span class="main">!</span> <span class="main">(</span>length <span class="var">?zer_list</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span>
      <span class="main">(</span><span class="main">∃</span> <span class="bound"><span class="bound">n</span></span> <span class="main">&lt;</span> <span class="main">(</span>length <span class="var">?zer_list</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">.</span> <span class="free">x1</span> <span class="main">&gt;</span> <span class="main">(</span><span class="var">?zer_list</span> <span class="main">!</span> <span class="bound">n</span><span class="main">)</span> <span class="main">∧</span> <span class="free">x1</span> <span class="main">&lt;</span> <span class="main">(</span><span class="var">?zer_list</span> <span class="main">!</span> <span class="main">(</span><span class="bound">n</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> zer_list_prop not_less
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(* This lemma is essentially saying that the zeros of coprime_r capture all relevant sample points.
From roots_of_coprime_r_location_property, we know that any zero of coprime_r is either between two 
  roots, or it's smaller than the least root (neg inf), or it's greater than the biggest root (pos inf).
Then, since the polynomials have constant signs within those intervals, the zeros of coprime_r 
  capture all the relevant information.
*)</span>
<span class="keyword1" id="BKR_Decision-roots_of_coprime_r_capture_sgas_without_zeros"><span class="command">lemma</span></span> roots_of_coprime_r_capture_sgas_without_zeros<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">qs</span><span class="main">::</span> <span class="quoted"><span class="quoted">"rat poly list"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">sga</span><span class="main">::</span> <span class="quoted"><span class="quoted">"rat list"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> pairwise_rel_prime<span class="main">:</span> <span class="quoted"><span class="quoted">"pairwise_coprime_list <span class="free">qs</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> all_squarefree<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">q</span><span class="main">.</span> <span class="bound">q</span> <span class="main">∈</span> set <span class="free">qs</span> <span class="main">⟹</span> rsquarefree <span class="bound">q</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ex_x1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">sga</span> <span class="main">=</span> sign_vec <span class="free">qs</span> <span class="free">x1</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> hnz<span class="main">:</span> <span class="quoted"><span class="quoted">"has_no_zeros <span class="free">sga</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound">w</span> <span class="main">∈</span> <span class="main">(</span>roots_of_coprime_r <span class="main">(</span>cast_rat_list <span class="free">qs</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> <span class="free">sga</span> <span class="main">=</span> <span class="main">(</span>sign_vec <span class="free">qs</span> <span class="bound">w</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x1</span></span> <span class="keyword2"><span class="keyword">where</span></span> x1_prop<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">sga</span> <span class="main">=</span> <span class="main">(</span>sign_vec <span class="free">qs</span> <span class="skolem">x1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ex_x1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?zer_list</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"sorted_list_of_set <span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">::</span>real<span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="main">∃</span><span class="bound">q</span> <span class="main">∈</span> set<span class="main">(</span><span class="free">qs</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span>rpoly <span class="bound">q</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span><span class="main">}</span> <span class="main">::</span> real list"</span></span>
  <span class="keyword1"><span class="command">have</span></span> strict_sorted_h<span class="main">:</span> <span class="quoted"><span class="quoted">"strict_sorted <span class="var">?zer_list</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> sorted_sorted_list_of_set
      strict_sorted_iff <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> sorted_hyp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">q</span></span> <span class="main">&lt;</span> length <span class="var">?zer_list</span><span class="main">.</span> <span class="main">(</span><span class="bound">q</span> <span class="main">+</span> <span class="main">1</span> <span class="main">&lt;</span> length <span class="var">?zer_list</span><span class="main">)</span> <span class="main">⟶</span>
     <span class="main">(</span><span class="var">?zer_list</span> <span class="main">!</span> <span class="bound">q</span><span class="main">)</span> <span class="main">&lt;</span> <span class="main">(</span><span class="var">?zer_list</span> <span class="main">!</span> <span class="main">(</span><span class="bound">q</span> <span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> lessI sorted_wrt_iff_nth_less strict_sorted_sorted_wrt
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> length_sorted_list_of_set strict_sorted_h<span class="main">)</span>  
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> sorted_hyp_var<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">q1</span></span> <span class="main">&lt;</span> length <span class="var">?zer_list</span><span class="main">.</span> <span class="main">∀</span><span class="bound"><span class="bound">q2</span></span> <span class="main">&lt;</span> length <span class="var">?zer_list</span><span class="main">.</span> <span class="main">(</span><span class="bound">q1</span> <span class="main">&lt;</span> <span class="bound">q2</span> <span class="main">⟶</span>
     <span class="main">(</span><span class="var">?zer_list</span> <span class="main">!</span> <span class="bound">q1</span><span class="main">)</span> <span class="main">&lt;</span> <span class="main">(</span><span class="var">?zer_list</span> <span class="main">!</span> <span class="bound">q2</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> sorted_wrt_iff_nth_less strict_sorted_h strict_sorted_sorted_wrt<span class="main">)</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> sorted_hyp_var2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">q1</span></span> <span class="main">&lt;</span> length <span class="var">?zer_list</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="var">?zer_list</span> <span class="main">!</span> <span class="bound">q1</span><span class="main">)</span><span class="main">::</span>real<span class="main">)</span> <span class="main">≤</span> <span class="main">(</span><span class="var">?zer_list</span> <span class="main">!</span> <span class="main">(</span>length <span class="var">?zer_list</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> <span class="main"><span class="main">(</span></span>z3<span class="main"><span class="main">)</span></span> Suc_pred diff_less gr_implies_not0 less_SucE zero_less_Suc<span class="main">)</span> 
  <span class="keyword1"><span class="command">have</span></span> nonz_q<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">q</span> <span class="main">∈</span>set <span class="free">qs</span><span class="main">.</span> <span class="bound">q</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> all_squarefree <span class="keyword1"><span class="command">unfolding</span></span> rsquarefree_def <span class="keyword1"><span class="command">using</span></span> in_set_member <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">q</span> <span class="main">∈</span>set <span class="free">qs</span><span class="main">.</span> finite <span class="main">{</span><span class="bound">x</span><span class="main">.</span> rpoly <span class="bound">q</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> poly_roots_finite<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> fin_set<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="main">∃</span><span class="bound">q</span><span class="main">∈</span>set <span class="free">qs</span><span class="main">.</span> rpoly <span class="bound">q</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> x1_and_roots<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?zer_list</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">(</span><span class="skolem">x1</span> <span class="main">&lt;</span> <span class="main">(</span><span class="var">?zer_list</span> <span class="main">!</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">∨</span> <span class="main">(</span><span class="skolem">x1</span> <span class="main">&gt;</span> <span class="main">(</span><span class="var">?zer_list</span> <span class="main">!</span> <span class="main">(</span>length <span class="var">?zer_list</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">∨</span>
    <span class="main">(</span><span class="main">∃</span> <span class="bound"><span class="bound">n</span></span> <span class="main">&lt;</span> <span class="main">(</span>length <span class="var">?zer_list</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">.</span> <span class="skolem">x1</span> <span class="main">&gt;</span> <span class="main">(</span><span class="var">?zer_list</span> <span class="main">!</span> <span class="bound">n</span><span class="main">)</span> <span class="main">∧</span> <span class="skolem">x1</span> <span class="main">&lt;</span> <span class="main">(</span><span class="var">?zer_list</span> <span class="main">!</span> <span class="main">(</span><span class="bound">n</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> roots_of_coprime_r_location_property x1_prop assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> x2gt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">x2</span></span><span class="main">&gt;</span><span class="skolem">x1</span><span class="main">.</span> sign_vec <span class="free">qs</span> <span class="skolem">x1</span> <span class="main">≠</span> sign_vec <span class="free">qs</span> <span class="bound">x2</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">r</span></span><span class="main">&gt;</span><span class="skolem">x1</span><span class="main">.</span> <span class="bound">r</span> <span class="main">≤</span> <span class="bound">x2</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span><span class="bound">q</span><span class="main">∈</span>set <span class="free">qs</span><span class="main">.</span> rpoly <span class="bound">q</span> <span class="bound">r</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> hnz x1_prop zero_above<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">qs</span></span> <span class="quoted"><span class="skolem">x1</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> x2lt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">x2</span></span><span class="main">&lt;</span><span class="skolem">x1</span><span class="main">.</span> sign_vec <span class="free">qs</span> <span class="skolem">x1</span> <span class="main">≠</span> sign_vec <span class="free">qs</span> <span class="bound">x2</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">r</span></span><span class="main">&lt;</span><span class="skolem">x1</span><span class="main">.</span> <span class="bound">x2</span> <span class="main">≤</span> <span class="bound">r</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span><span class="bound">q</span><span class="main">∈</span>set <span class="free">qs</span><span class="main">.</span> rpoly <span class="bound">q</span> <span class="bound">r</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> hnz x1_prop zero_below<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">qs</span></span> <span class="quoted"><span class="skolem">x1</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span> 
  <span class="keyword1"><span class="command">have</span></span> triv_neg_inf_h<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?zer_list</span> <span class="main">=</span> <span class="main">[]</span> <span class="main">⟹</span>  <span class="free">sga</span> <span class="main">=</span> <span class="main">(</span>sign_vec <span class="free">qs</span> <span class="main">(</span><span class="main">-</span>crb <span class="main">(</span>prod_list <span class="main">(</span>cast_rat_list <span class="free">qs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">assume</span></span> empty_zer<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?zer_list</span><span class="main">::</span> real list<span class="main">)</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?zer_set</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="main">∃</span><span class="bound">q</span><span class="main">∈</span>set <span class="free">qs</span><span class="main">.</span> rpoly <span class="bound">q</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span><span class="main">::</span> real set"</span></span>
    <span class="keyword1"><span class="command">have</span></span> fin_zer<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="var">?zer_set</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> fin_set <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="var">?zer_set</span> <span class="main">⟹</span> <span class="main">(</span>sorted_list_of_set <span class="var">?zer_set</span> <span class="main">=</span> <span class="main">[]</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="var">?zer_set</span> <span class="main">=</span> <span class="main">{}</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> fin_zer sorted_list_of_set_eq_Nil_iff<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> A <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="var">?zer_set</span>"</span></span><span class="main">]</span>  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>sorted_list_of_set <span class="var">?zer_set</span> <span class="main">=</span> <span class="main">[]</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="var">?zer_set</span> <span class="main">=</span> <span class="main">{}</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> fin_zer <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> nozers<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?zer_set</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> empty_zer <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="main">(</span><span class="main">∃</span><span class="main">(</span><span class="bound">r</span><span class="main">::</span>real<span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="main">∃</span><span class="main">(</span><span class="bound">q</span><span class="main">::</span>rat poly<span class="main">)</span><span class="main">∈</span>set <span class="free">qs</span><span class="main">.</span> rpoly <span class="bound">q</span> <span class="bound">r</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> nozers <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">y</span><span class="main">.</span> sign_vec <span class="free">qs</span> <span class="skolem">x1</span> <span class="main">=</span> sign_vec <span class="free">qs</span> <span class="bound">y</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">y</span>
      <span class="keyword1"><span class="command">have</span></span> gt_prop<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x1</span> <span class="main">&gt;</span> <span class="skolem">y</span> <span class="main">⟶</span> sign_vec <span class="free">qs</span> <span class="skolem">x1</span> <span class="main">=</span> sign_vec <span class="free">qs</span> <span class="skolem">y</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> hnz x1_prop zero_below<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">qs</span></span> <span class="quoted"><span class="skolem">x1</span></span><span class="main">]</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∄</span><span class="bound">r</span><span class="main">.</span> <span class="main">∃</span><span class="bound">q</span><span class="main">∈</span>set <span class="free">qs</span><span class="main">.</span> rpoly <span class="bound">q</span> <span class="bound">r</span> <span class="main">=</span> <span class="main">0</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">have</span></span> lt_prop<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x1</span> <span class="main">&lt;</span> <span class="skolem">y</span> <span class="main">⟶</span> sign_vec <span class="free">qs</span> <span class="skolem">x1</span> <span class="main">=</span> sign_vec <span class="free">qs</span> <span class="skolem">y</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> zero_above<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">qs</span></span> <span class="quoted"><span class="skolem">x1</span></span><span class="main">]</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∄</span><span class="bound">r</span><span class="main">.</span> <span class="main">∃</span><span class="bound">q</span><span class="main">∈</span>set <span class="free">qs</span><span class="main">.</span> rpoly <span class="bound">q</span> <span class="bound">r</span> <span class="main">=</span> <span class="main">0</span>›</span></span> x2gt <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> gt_prop lt_prop <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹<span class="main">∄</span><span class="bound">r</span><span class="main">.</span> <span class="main">∃</span><span class="bound">q</span><span class="main">∈</span>set <span class="free">qs</span><span class="main">.</span> rpoly <span class="bound">q</span> <span class="bound">r</span> <span class="main">=</span> <span class="main">0</span>›</span></span> linorder_neqE_linordered_idom x2gt x2lt<span class="main">)</span>
        <span class="keyword1"><span class="command">using</span></span> x2gt x2lt <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹<span class="main">∄</span><span class="bound">r</span><span class="main">.</span> <span class="main">∃</span><span class="bound">q</span><span class="main">∈</span>set <span class="free">qs</span><span class="main">.</span> rpoly <span class="bound">q</span> <span class="bound">r</span> <span class="main">=</span> <span class="main">0</span>›</span></span> linorder_neqE_linordered_idom<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹<span class="main">∄</span><span class="bound">r</span><span class="main">.</span> <span class="main">∃</span><span class="bound">q</span><span class="main">∈</span>set <span class="free">qs</span><span class="main">.</span> rpoly <span class="bound">q</span> <span class="bound">r</span> <span class="main">=</span> <span class="main">0</span>›</span></span> linorder_neqE_linordered_idom<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹<span class="main">∄</span><span class="bound">r</span><span class="main">.</span> <span class="main">∃</span><span class="bound">q</span><span class="main">∈</span>set <span class="free">qs</span><span class="main">.</span> rpoly <span class="bound">q</span> <span class="bound">r</span> <span class="main">=</span> <span class="main">0</span>›</span></span> linorder_neqE_linordered_idom<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> x1_prop<span class="main">)</span> 
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">have</span></span> neg_inf_h<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?zer_list</span> <span class="main">≠</span><span class="main">[]</span> <span class="main">⟹</span> <span class="main">(</span><span class="skolem">x1</span> <span class="main">&lt;</span> <span class="main">(</span><span class="var">?zer_list</span> <span class="main">!</span> <span class="main">0</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">sga</span> <span class="main">=</span> <span class="main">(</span>sign_vec <span class="free">qs</span> <span class="main">(</span><span class="main">-</span>crb <span class="main">(</span>prod_list <span class="main">(</span>cast_rat_list <span class="free">qs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?neg_crb</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">-</span>crb <span class="main">(</span>prod_list <span class="main">(</span>cast_rat_list <span class="free">qs</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> len_nontriv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?zer_list</span> <span class="main">≠</span><span class="main">[]</span>"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> x1_lt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x1</span> <span class="main">&lt;</span> <span class="var">?zer_list</span> <span class="main">!</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> r_gt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">r</span><span class="main">.</span> <span class="main">(</span><span class="main">∃</span><span class="bound">q</span><span class="main">∈</span>set <span class="free">qs</span><span class="main">.</span> rpoly <span class="bound">q</span> <span class="bound">r</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span> <span class="main">⟶</span> <span class="bound">r</span> <span class="main">≥</span> <span class="main">(</span><span class="var">?zer_list</span> <span class="main">!</span> <span class="main">0</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">clarsimp</span> 
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">q</span><span class="main">::</span><span class="quoted"><span class="quoted">"rat poly"</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">r</span><span class="main">::</span> <span class="quoted"><span class="quoted">"real"</span></span>
      <span class="keyword3"><span class="command">assume</span></span> q_in<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">∈</span> set <span class="free">qs</span>"</span></span> 
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"rpoly <span class="skolem">q</span> <span class="skolem">r</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">∈</span>  <span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="main">∃</span><span class="bound">q</span><span class="main">∈</span>set <span class="free">qs</span><span class="main">.</span> rpoly <span class="bound">q</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> q_in <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"List.member <span class="main">(</span>sorted_list_of_set <span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="main">∃</span><span class="bound">q</span><span class="main">∈</span>set <span class="free">qs</span><span class="main">.</span> rpoly <span class="bound">q</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span><span class="main">)</span> <span class="skolem">r</span>"</span></span> 
        <span class="keyword1"><span class="command">using</span></span>  in_set_member set_sorted_list_of_set fin_set <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="main">∃</span><span class="bound">q</span><span class="main">∈</span>set <span class="free">qs</span><span class="main">.</span> rpoly <span class="bound">q</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span>›</span></span> fin_set in_set_member set_sorted_list_of_set<span class="main">)</span> 
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"sorted_list_of_set <span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="main">∃</span><span class="bound">q</span><span class="main">∈</span>set <span class="free">qs</span><span class="main">.</span> rpoly <span class="bound">q</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span> <span class="main">!</span> <span class="main">0</span> <span class="main">≤</span> <span class="skolem">r</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> sorted_hyp_var
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> gr_implies_not0 in_set_conv_nth in_set_member not_less sorted_iff_nth_mono sorted_sorted_list_of_set<span class="main">)</span> 
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">have</span></span> prod_zer<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="main">∃</span><span class="bound">q</span><span class="main">∈</span>set <span class="free">qs</span><span class="main">.</span> rpoly <span class="bound">q</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">(</span>poly <span class="main">(</span>prod_list <span class="main">(</span>cast_rat_list <span class="free">qs</span><span class="main">)</span><span class="main">)</span> <span class="bound">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> prod_list_zero_iff<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> xs <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>cast_rat_list <span class="free">qs</span><span class="main">)</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> cast_rat_list_def
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> nonz_q <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> hide_lams<span class="main"><span class="main">)</span></span> image_eqI list.set_map of_rat_poly_hom.prod_list_map_hom poly_prod_list_zero_iff<span class="main">)</span> 
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?zer_list</span> <span class="main">≠</span><span class="main">[]</span> <span class="main">⟶</span> List.member <span class="main">(</span>sorted_list_of_set <span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="main">∃</span><span class="bound">q</span><span class="main">∈</span>set <span class="free">qs</span><span class="main">.</span> rpoly <span class="bound">q</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span><span class="main">)</span>
     <span class="main">(</span><span class="var">?zer_list</span> <span class="main">!</span> <span class="main">0</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> nth_Cons_0 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> gr0I in_set_member length_0_conv nth_mem<span class="main">)</span> 
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?zer_list</span> <span class="main">≠</span><span class="main">[]</span> <span class="main">⟶</span> <span class="main">(</span><span class="var">?zer_list</span> <span class="main">!</span> <span class="main">0</span><span class="main">)</span>
   <span class="main">∈</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="main">∃</span><span class="bound">q</span><span class="main">∈</span>set <span class="free">qs</span><span class="main">.</span> rpoly <span class="bound">q</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> in_set_member<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>sorted_list_of_set <span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="main">∃</span><span class="bound">q</span><span class="main">∈</span>set <span class="free">qs</span><span class="main">.</span> rpoly <span class="bound">q</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span> <span class="main">!</span> <span class="main">0</span><span class="main">)</span>"</span></span><span class="main">,</span>
          <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> xs <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"sorted_list_of_set <span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="main">∃</span><span class="bound">q</span><span class="main">∈</span>set <span class="free">qs</span><span class="main">.</span> rpoly <span class="bound">q</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span>"</span></span><span class="main">]</span>
          set_sorted_list_of_set fin_set
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?zer_list</span> <span class="main">≠</span><span class="main">[]</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">q</span><span class="main">∈</span>set <span class="free">qs</span><span class="main">.</span> rpoly <span class="bound">q</span> <span class="main">(</span><span class="var">?zer_list</span> <span class="main">!</span> <span class="main">0</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> poly_zer<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?zer_list</span> <span class="main">≠</span><span class="main">[]</span> <span class="main">⟶</span> <span class="main">(</span>poly <span class="main">(</span>prod_list <span class="main">(</span>cast_rat_list <span class="free">qs</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="var">?zer_list</span> <span class="main">!</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> prod_zer <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">q</span><span class="main">.</span> List.member <span class="main">(</span>cast_rat_list <span class="free">qs</span><span class="main">)</span> <span class="bound">q</span> <span class="main">⟶</span><span class="bound">q</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> nonz_q
      <span class="keyword1"><span class="command">unfolding</span></span> cast_rat_list_def <span class="keyword1"><span class="command">using</span></span> in_set_member imageE image_set map_poly_zero of_rat_eq_0_iff
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">smt</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>prod_list <span class="main">(</span>cast_rat_list <span class="free">qs</span><span class="main">)</span><span class="main">)</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> prod_list_zero_iff in_set_member <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span> 
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> crb_lt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?zer_list</span> <span class="main">≠</span><span class="main">[]</span> <span class="main">⟶</span> <span class="var">?neg_crb</span> <span class="main">&lt;</span> <span class="var">?zer_list</span> <span class="main">!</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> crb_lem_neg<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> p <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>prod_list <span class="main">(</span>cast_rat_list <span class="free">qs</span><span class="main">)</span><span class="main">)</span>"</span></span><span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"sorted_list_of_set <span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="main">∃</span><span class="bound">q</span><span class="main">∈</span>set <span class="free">qs</span><span class="main">.</span> rpoly <span class="bound">q</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span> <span class="main">!</span> <span class="main">0</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span> 
      <span class="keyword1"><span class="command">using</span></span> poly_zer
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
    <span class="keyword1"><span class="command">have</span></span> crb_gt_x1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?zer_list</span> <span class="main">≠</span><span class="main">[]</span> <span class="main">⟶</span> <span class="main">(</span><span class="var">?neg_crb</span> <span class="main">&gt;</span> <span class="skolem">x1</span> <span class="main">⟶</span> <span class="main">(</span><span class="free">sga</span> <span class="main">≠</span> <span class="main">(</span>sign_vec <span class="free">qs</span> <span class="var">?neg_crb</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">r</span></span><span class="main">&gt;</span><span class="skolem">x1</span><span class="main">.</span> <span class="bound">r</span> <span class="main">≤</span> <span class="var">?neg_crb</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span><span class="bound">q</span><span class="main">∈</span>set <span class="free">qs</span><span class="main">.</span> rpoly <span class="bound">q</span> <span class="bound">r</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> x2gt <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> crb_lt r_gt x1_prop <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span> 
    <span class="keyword1"><span class="command">have</span></span> crb_lt_x1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?neg_crb</span> <span class="main">&lt;</span> <span class="skolem">x1</span> <span class="main">⟶</span> <span class="main">(</span><span class="free">sga</span> <span class="main">≠</span> <span class="main">(</span>sign_vec <span class="free">qs</span> <span class="var">?neg_crb</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">r</span></span><span class="main">&lt;</span><span class="skolem">x1</span><span class="main">.</span> <span class="var">?neg_crb</span> <span class="main">≤</span> <span class="bound">r</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span><span class="bound">q</span><span class="main">∈</span>set <span class="free">qs</span><span class="main">.</span> rpoly <span class="bound">q</span> <span class="bound">r</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> x2lt <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> x1_lt r_gt x1_prop <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>  
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> len_nontriv crb_gt_x1 crb_lt_x1  x1_lt crb_lt r_gt  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> x1_prop <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">have</span></span> pos_inf_h<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?zer_list</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">⟹</span> <span class="main">(</span><span class="skolem">x1</span> <span class="main">&gt;</span> <span class="main">(</span><span class="var">?zer_list</span> <span class="main">!</span> <span class="main">(</span>length <span class="var">?zer_list</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">sga</span> <span class="main">=</span> <span class="main">(</span>sign_vec <span class="free">qs</span> <span class="main">(</span>crb <span class="main">(</span>prod_list <span class="main">(</span>cast_rat_list <span class="free">qs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?pos_crb</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"crb <span class="main">(</span>prod_list <span class="main">(</span>cast_rat_list <span class="free">qs</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> len_nontriv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?zer_list</span> <span class="main">≠</span><span class="main">[]</span>"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> x1_lt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x1</span> <span class="main">&gt;</span> <span class="var">?zer_list</span> <span class="main">!</span> <span class="main">(</span>length <span class="var">?zer_list</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> r_gt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">r</span><span class="main">.</span> <span class="main">(</span><span class="main">∃</span><span class="bound">q</span><span class="main">∈</span>set <span class="free">qs</span><span class="main">.</span> rpoly <span class="bound">q</span> <span class="bound">r</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span> <span class="main">⟹</span> <span class="bound">r</span> <span class="main">≤</span> <span class="main">(</span><span class="var">?zer_list</span> <span class="main">!</span> <span class="main">(</span>length <span class="var">?zer_list</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">r</span><span class="main">::</span> <span class="quoted"><span class="quoted">"real"</span></span>
      <span class="keyword3"><span class="command">assume</span></span> q_in<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound">q</span><span class="main">∈</span>set <span class="free">qs</span><span class="main">.</span> rpoly <span class="bound">q</span> <span class="skolem">r</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">q</span></span><span class="main">::</span><span class="quoted"><span class="quoted">"rat poly"</span></span> <span class="keyword2"><span class="keyword">where</span></span> q_prop<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">∈</span> set <span class="free">qs</span> <span class="main">∧</span> rpoly <span class="skolem">q</span> <span class="skolem">r</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">∈</span>  <span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="main">∃</span><span class="bound">q</span><span class="main">∈</span>set <span class="free">qs</span><span class="main">.</span> rpoly <span class="bound">q</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> q_in <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"List.member <span class="main">(</span>sorted_list_of_set <span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="main">∃</span><span class="bound">q</span><span class="main">∈</span>set <span class="free">qs</span><span class="main">.</span> rpoly <span class="bound">q</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span><span class="main">)</span> <span class="skolem">r</span>"</span></span> 
        <span class="keyword1"><span class="command">using</span></span> in_set_member set_sorted_list_of_set fin_set <span class="keyword1"><span class="command">by</span></span> <span class="operator">smt</span>    
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">n</span></span> <span class="main">&lt;</span> <span class="main">(</span>length <span class="var">?zer_list</span><span class="main">)</span><span class="main">.</span> <span class="skolem">r</span> <span class="main">=</span> <span class="var">?zer_list</span> <span class="main">!</span> <span class="bound">n</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> in_set_conv_nth in_set_member<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword">where</span></span> n_prop<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">&lt;</span> length <span class="var">?zer_list</span> <span class="main">∧</span> <span class="skolem">r</span> <span class="main">=</span> <span class="var">?zer_list</span> <span class="main">!</span> <span class="skolem">n</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">≤</span> <span class="main">(</span><span class="var">?zer_list</span> <span class="main">!</span> <span class="main">(</span>length <span class="var">?zer_list</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">q1</span><span class="main">.</span> <span class="bound">q1</span> <span class="main">&lt;</span> length <span class="var">?zer_list</span> <span class="main">⟶</span> <span class="main">(</span><span class="var">?zer_list</span> <span class="main">!</span> <span class="bound">q1</span><span class="main">)</span> <span class="main">≤</span> <span class="main">(</span><span class="var">?zer_list</span> <span class="main">!</span> <span class="main">(</span>length <span class="var">?zer_list</span> <span class="main">-</span> <span class="main">1</span><span class="main">::</span> nat<span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> sorted_hyp_var2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?zer_list</span> <span class="main">!</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">≤</span> <span class="main">(</span><span class="var">?zer_list</span> <span class="main">!</span> <span class="main">(</span>length <span class="var">?zer_list</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> n_prop <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> n_prop <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">have</span></span> prod_zer<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="main">∃</span><span class="bound">q</span><span class="main">∈</span>set <span class="free">qs</span><span class="main">.</span> rpoly <span class="bound">q</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">(</span>poly <span class="main">(</span>prod_list <span class="main">(</span>cast_rat_list <span class="free">qs</span><span class="main">)</span><span class="main">)</span> <span class="bound">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> prod_list_zero_iff<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> xs <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>cast_rat_list <span class="free">qs</span><span class="main">)</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> cast_rat_list_def
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> nonz_q <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> hide_lams<span class="main"><span class="main">)</span></span> image_eqI list.set_map of_rat_poly_hom.prod_list_map_hom poly_prod_list_zero_iff<span class="main">)</span> 
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?zer_list</span> <span class="main">≠</span><span class="main">[]</span> <span class="main">⟶</span> List.member <span class="main">(</span>sorted_list_of_set <span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="main">∃</span><span class="bound">q</span><span class="main">∈</span>set <span class="free">qs</span><span class="main">.</span> rpoly <span class="bound">q</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span><span class="main">)</span>
     <span class="main">(</span><span class="var">?zer_list</span> <span class="main">!</span> <span class="main">(</span>length <span class="var">?zer_list</span> <span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> nth_Cons_0 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> diff_less in_set_conv_nth in_set_member length_greater_0_conv length_sorted_list_of_set zero_less_Suc<span class="main">)</span> 
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?zer_list</span> <span class="main">≠</span><span class="main">[]</span> <span class="main">⟶</span> <span class="main">(</span><span class="var">?zer_list</span> <span class="main">!</span> <span class="main">(</span>length <span class="var">?zer_list</span> <span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">)</span>
   <span class="main">∈</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="main">∃</span><span class="bound">q</span><span class="main">∈</span>set <span class="free">qs</span><span class="main">.</span> rpoly <span class="bound">q</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> in_set_member<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>sorted_list_of_set <span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="main">∃</span><span class="bound">q</span><span class="main">∈</span>set <span class="free">qs</span><span class="main">.</span> rpoly <span class="bound">q</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span> <span class="main">!</span> <span class="main">(</span>length <span class="var">?zer_list</span> <span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span><span class="main">,</span>
          <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> xs <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"sorted_list_of_set <span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="main">∃</span><span class="bound">q</span><span class="main">∈</span>set <span class="free">qs</span><span class="main">.</span> rpoly <span class="bound">q</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span>"</span></span><span class="main">]</span>
          set_sorted_list_of_set fin_set
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?zer_list</span> <span class="main">≠</span><span class="main">[]</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">q</span><span class="main">∈</span>set <span class="free">qs</span><span class="main">.</span> rpoly <span class="bound">q</span> <span class="main">(</span><span class="var">?zer_list</span> <span class="main">!</span> <span class="main">(</span>length <span class="var">?zer_list</span> <span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> poly_zer<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?zer_list</span> <span class="main">≠</span><span class="main">[]</span> <span class="main">⟶</span> <span class="main">(</span>poly <span class="main">(</span>prod_list <span class="main">(</span>cast_rat_list <span class="free">qs</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="var">?zer_list</span> <span class="main">!</span> <span class="main">(</span>length <span class="var">?zer_list</span> <span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> prod_zer <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">q</span><span class="main">.</span> List.member <span class="main">(</span>cast_rat_list <span class="free">qs</span><span class="main">)</span> <span class="bound">q</span> <span class="main">⟶</span><span class="bound">q</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> nonz_q
      <span class="keyword1"><span class="command">unfolding</span></span> cast_rat_list_def <span class="keyword1"><span class="command">using</span></span> in_set_member imageE image_set map_poly_zero of_rat_eq_0_iff
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">smt</span> 
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>prod_list <span class="main">(</span>cast_rat_list <span class="free">qs</span><span class="main">)</span><span class="main">)</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> prod_list_zero_iff in_set_member <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span> 
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> crb_lt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?zer_list</span> <span class="main">≠</span><span class="main">[]</span> <span class="main">⟶</span> <span class="var">?pos_crb</span> <span class="main">&gt;</span> <span class="var">?zer_list</span> <span class="main">!</span> <span class="main">(</span>length <span class="var">?zer_list</span> <span class="main">-</span><span class="main">1</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> crb_lem_pos<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> p <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>prod_list <span class="main">(</span>cast_rat_list <span class="free">qs</span><span class="main">)</span><span class="main">)</span>"</span></span><span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"sorted_list_of_set <span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="main">∃</span><span class="bound">q</span><span class="main">∈</span>set <span class="free">qs</span><span class="main">.</span> rpoly <span class="bound">q</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span> <span class="main">!</span> <span class="main">(</span>length <span class="var">?zer_list</span> <span class="main">-</span><span class="main">1</span><span class="main">)</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span> 
      <span class="keyword1"><span class="command">using</span></span> poly_zer
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> 
    <span class="keyword1"><span class="command">have</span></span> crb_gt_x1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?zer_list</span> <span class="main">≠</span><span class="main">[]</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">(</span><span class="var">?pos_crb</span><span class="main">::</span>real<span class="main">)</span> <span class="main">&gt;</span> <span class="main">(</span><span class="skolem">x1</span><span class="main">::</span>real<span class="main">)</span> <span class="main">⟶</span> <span class="main">(</span><span class="free">sga</span> <span class="main">≠</span> <span class="main">(</span>sign_vec <span class="main">(</span><span class="free">qs</span><span class="main">::</span>rat poly list<span class="main">)</span> <span class="main">(</span><span class="var">?pos_crb</span><span class="main">::</span>real<span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="main">(</span><span class="bound"><span class="bound">r</span></span><span class="main">::</span>real<span class="main">)</span><span class="main">&lt;</span><span class="skolem">x1</span><span class="main">.</span> <span class="bound">r</span> <span class="main">≥</span> <span class="var">?pos_crb</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span><span class="main">(</span><span class="bound">q</span><span class="main">::</span>rat poly<span class="main">)</span><span class="main">∈</span>set <span class="free">qs</span><span class="main">.</span> rpoly <span class="bound">q</span> <span class="bound">r</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> x2gt <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> crb_lt r_gt x1_prop 
      <span class="keyword1"><span class="command">using</span></span> x1_lt <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span> 
    <span class="keyword1"><span class="command">have</span></span> crb_lt_x1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?pos_crb</span> <span class="main">&lt;</span> <span class="skolem">x1</span> <span class="main">⟶</span> <span class="main">(</span><span class="free">sga</span> <span class="main">≠</span> <span class="main">(</span>sign_vec <span class="free">qs</span> <span class="var">?pos_crb</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">r</span></span><span class="main">&gt;</span><span class="skolem">x1</span><span class="main">.</span> <span class="var">?pos_crb</span> <span class="main">≥</span> <span class="bound">r</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span><span class="bound">q</span><span class="main">∈</span>set <span class="free">qs</span><span class="main">.</span> poly <span class="main">(</span>real_of_rat_poly <span class="bound">q</span><span class="main">)</span> <span class="bound">r</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> x2lt <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> x1_lt r_gt x1_prop
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> <span class="quoted"><span class="quoted">‹prod_list <span class="main">(</span>cast_rat_list <span class="free">qs</span><span class="main">)</span> <span class="main">≠</span> <span class="main">0</span>›</span></span> crb_lem_pos not_less prod_zer<span class="main">)</span> 
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> len_nontriv crb_gt_x1 crb_lt_x1  x1_lt crb_lt r_gt  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> x1_prop
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">have</span></span> between_h<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span> <span class="bound"><span class="bound">n</span></span> <span class="main">&lt;</span> <span class="main">(</span>length <span class="var">?zer_list</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">.</span> <span class="skolem">x1</span> <span class="main">&gt;</span> <span class="main">(</span><span class="var">?zer_list</span> <span class="main">!</span> <span class="bound">n</span><span class="main">)</span> <span class="main">∧</span> <span class="skolem">x1</span> <span class="main">&lt;</span> <span class="main">(</span><span class="var">?zer_list</span> <span class="main">!</span> <span class="main">(</span><span class="bound">n</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">∃</span><span class="bound">w</span> <span class="main">∈</span> <span class="main">(</span>roots_of_coprime_r <span class="main">(</span>cast_rat_list <span class="free">qs</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> <span class="free">sga</span> <span class="main">=</span> <span class="main">(</span>sign_vec <span class="free">qs</span> <span class="bound">w</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span> <span class="bound"><span class="bound">n</span></span> <span class="main">&lt;</span> <span class="main">(</span>length <span class="var">?zer_list</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">.</span> <span class="skolem">x1</span> <span class="main">&gt;</span> <span class="main">(</span><span class="var">?zer_list</span> <span class="main">!</span> <span class="bound">n</span><span class="main">)</span> <span class="main">∧</span> <span class="skolem">x1</span> <span class="main">&lt;</span> <span class="main">(</span><span class="var">?zer_list</span> <span class="main">!</span> <span class="main">(</span><span class="bound">n</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword">where</span></span> n_prop<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">&lt;</span> <span class="main">(</span>length <span class="var">?zer_list</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">∧</span> <span class="skolem">x1</span> <span class="main">&gt;</span> <span class="main">(</span><span class="var">?zer_list</span> <span class="main">!</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">∧</span> <span class="skolem">x1</span> <span class="main">&lt;</span> <span class="main">(</span><span class="var">?zer_list</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">n</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">q1</span> <span class="bound">q2</span><span class="main">.</span> <span class="main">(</span><span class="bound">q1</span> <span class="main">≠</span> <span class="bound">q2</span> <span class="main">∧</span> <span class="main">(</span>List.member <span class="main">(</span>cast_rat_list <span class="free">qs</span><span class="main">)</span> <span class="bound">q1</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span>List.member <span class="main">(</span>cast_rat_list <span class="free">qs</span><span class="main">)</span> <span class="bound">q2</span><span class="main">)</span><span class="main">)</span><span class="main">⟶</span> coprime <span class="bound">q1</span> <span class="bound">q2</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> pairwise_rel_prime coprime_rat_poly_iff_coprimereal_poly
      <span class="keyword1"><span class="command">unfolding</span></span> pairwise_coprime_list_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> cast_rat_list_def imageE image_set in_set_conv_nth in_set_member<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> all_prop<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x1</span><span class="main">.</span> <span class="main">∀</span><span class="bound">x2</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="bound">x1</span> <span class="main">&lt;</span> <span class="bound">x2</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span><span class="bound">q1</span> <span class="main">∈</span> set <span class="main">(</span>cast_rat_list<span class="main">(</span><span class="free">qs</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span>poly <span class="bound">q1</span> <span class="bound">x1</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span><span class="bound">q2</span><span class="main">∈</span> set<span class="main">(</span><span class="main">(</span>cast_rat_list<span class="main">(</span><span class="free">qs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span>poly <span class="bound">q2</span> <span class="bound">x2</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">q</span><span class="main">.</span> <span class="bound">x1</span> <span class="main">&lt;</span> <span class="bound">q</span> <span class="main">∧</span> <span class="bound">q</span> <span class="main">&lt;</span> <span class="bound">x2</span> <span class="main">∧</span> poly <span class="main">(</span>coprime_r <span class="main">(</span>cast_rat_list <span class="free">qs</span><span class="main">)</span><span class="main">)</span> <span class="bound">q</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> coprime_r_roots_prop 
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> exq1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound">q1</span> <span class="main">∈</span> set <span class="main">(</span>cast_rat_list<span class="main">(</span><span class="free">qs</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span>poly <span class="bound">q1</span> <span class="main">(</span><span class="var">?zer_list</span> <span class="main">!</span> <span class="skolem">n</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> cast_rat_list_def <span class="keyword1"><span class="command">using</span></span> n_prop <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> <span class="main"><span class="main">(</span></span>verit<span class="main"><span class="main">,</span></span> ccfv_SIG<span class="main"><span class="main">)</span></span> One_nat_def Suc_eq_plus1 Suc_lessD fin_set length_sorted_list_of_set less_diff_conv mem_Collect_eq nth_mem set_sorted_list_of_set<span class="main">)</span>    
    <span class="keyword1"><span class="command">have</span></span> exq2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound">q2</span> <span class="main">∈</span> set <span class="main">(</span>cast_rat_list<span class="main">(</span><span class="free">qs</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span>poly <span class="bound">q2</span> <span class="main">(</span><span class="var">?zer_list</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">n</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> cast_rat_list_def <span class="keyword1"><span class="command">using</span></span> n_prop One_nat_def Suc_eq_plus1 fin_set less_diff_conv mem_Collect_eq nth_mem set_sorted_list_of_set
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> <span class="main"><span class="main">(</span></span>verit<span class="main"><span class="main">,</span></span> ccfv_SIG<span class="main"><span class="main">)</span></span> image_eqI set_map<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> n_prop2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="var">?zer_list</span> <span class="main">!</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">&lt;</span> <span class="main">(</span><span class="var">?zer_list</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">n</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span><span class="bound">q1</span> <span class="main">∈</span> set <span class="main">(</span>cast_rat_list<span class="main">(</span><span class="free">qs</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span>poly <span class="bound">q1</span> <span class="main">(</span><span class="var">?zer_list</span> <span class="main">!</span> <span class="skolem">n</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span><span class="bound">q2</span><span class="main">∈</span> set<span class="main">(</span><span class="main">(</span>cast_rat_list<span class="main">(</span><span class="free">qs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span>poly <span class="bound">q2</span> <span class="main">(</span><span class="var">?zer_list</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">n</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> exq1 exq2 sorted_hyp n_prop <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound">q</span><span class="main">.</span> <span class="main">(</span><span class="var">?zer_list</span> <span class="main">!</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">&lt;</span> <span class="bound">q</span> <span class="main">∧</span> <span class="bound">q</span> <span class="main">&lt;</span> <span class="main">(</span><span class="var">?zer_list</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">n</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> poly <span class="main">(</span>coprime_r <span class="main">(</span>cast_rat_list <span class="free">qs</span><span class="main">)</span><span class="main">)</span> <span class="bound">q</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> all_prop n_prop2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span>  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">w</span> <span class="main">∈</span> <span class="main">(</span>roots_of_coprime_r <span class="main">(</span>cast_rat_list <span class="free">qs</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="var">?zer_list</span> <span class="main">!</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">&lt;</span> <span class="bound">w</span> <span class="main">∧</span> <span class="bound">w</span> <span class="main">&lt;</span> <span class="main">(</span><span class="var">?zer_list</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">n</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> roots_of_coprime_r_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">w</span></span> <span class="keyword2"><span class="keyword">where</span></span> w_prop<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="main">∈</span> <span class="main">(</span>roots_of_coprime_r <span class="main">(</span>cast_rat_list <span class="free">qs</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="var">?zer_list</span> <span class="main">!</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">&lt;</span> <span class="skolem">w</span> <span class="main">∧</span> <span class="skolem">w</span> <span class="main">&lt;</span> <span class="main">(</span><span class="var">?zer_list</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">n</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> n_lt1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">&lt;</span> length <span class="var">?zer_list</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> n_prop
      <span class="keyword1"><span class="command">using</span></span> add_lessD1 less_diff_conv <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">have</span></span> n_lt2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">+</span> <span class="main">1</span> <span class="main">&lt;</span> length <span class="var">?zer_list</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> n_prop
      <span class="keyword1"><span class="command">using</span></span> less_diff_conv <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
    <span class="keyword1"><span class="command">have</span></span> sorted_hyp_var3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?zer_list</span> <span class="main">!</span> <span class="skolem">n</span>  <span class="main">&lt;</span> <span class="var">?zer_list</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> sorted_hyp 
        n_lt1 n_lt2  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> helper<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="main">&gt;</span> <span class="skolem">x1</span> <span class="main">⟶</span> <span class="main">¬</span><span class="main">(</span><span class="main">∃</span><span class="main">(</span><span class="bound">x</span><span class="main">::</span>real<span class="main">)</span><span class="main">.</span> <span class="main">(</span>List.member <span class="var">?zer_list</span> <span class="bound">x</span> <span class="main">∧</span> <span class="skolem">x1</span> <span class="main">≤</span> <span class="bound">x</span> <span class="main">∧</span> <span class="bound">x</span> <span class="main">≤</span> <span class="skolem">w</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> n_prop w_prop x1_prop strict_sorted_h sorted_list_lemma<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> n <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span>"</span></span><span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> l <span class="main"><span class="main">=</span></span> <span class="var"><span class="quoted"><span class="var">?zer_list</span></span></span><span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> a <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x1</span>"</span></span><span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> b <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span>"</span></span><span class="main">]</span> sorted_hyp_var3 
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> no_root1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="main">&gt;</span> <span class="skolem">x1</span> <span class="main">⟹</span> <span class="main">¬</span><span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">r</span></span><span class="main">&gt;</span><span class="skolem">x1</span><span class="main">.</span> <span class="bound">r</span> <span class="main">≤</span> <span class="skolem">w</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span><span class="bound">q</span><span class="main">∈</span>set <span class="free">qs</span><span class="main">.</span> rpoly <span class="bound">q</span> <span class="bound">r</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="main">&gt;</span> <span class="skolem">x1</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> nex<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="main">(</span><span class="main">∃</span><span class="main">(</span><span class="bound">x</span><span class="main">::</span>real<span class="main">)</span><span class="main">.</span> <span class="main">(</span>List.member <span class="var">?zer_list</span> <span class="bound">x</span> <span class="main">∧</span> <span class="skolem">x1</span> <span class="main">≤</span> <span class="bound">x</span> <span class="main">∧</span> <span class="bound">x</span> <span class="main">≤</span> <span class="skolem">w</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> helper <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">r</span></span><span class="main">&gt;</span><span class="skolem">x1</span><span class="main">.</span> <span class="bound">r</span> <span class="main">≤</span> <span class="skolem">w</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span><span class="bound">q</span><span class="main">∈</span>set <span class="free">qs</span><span class="main">.</span> rpoly <span class="bound">q</span> <span class="bound">r</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> False"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">r</span></span><span class="main">&gt;</span><span class="skolem">x1</span><span class="main">.</span> <span class="bound">r</span> <span class="main">≤</span> <span class="skolem">w</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span><span class="bound">q</span><span class="main">∈</span>set <span class="free">qs</span><span class="main">.</span> rpoly <span class="bound">q</span> <span class="bound">r</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword">where</span></span> r_prop<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">&gt;</span> <span class="skolem">x1</span> <span class="main">∧</span><span class="skolem">r</span> <span class="main">≤</span> <span class="skolem">w</span> <span class="main">∧</span><span class="main">(</span><span class="main">∃</span><span class="bound">q</span><span class="main">∈</span>set <span class="free">qs</span><span class="main">.</span> rpoly <span class="bound">q</span> <span class="skolem">r</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"List.member <span class="var">?zer_list</span> <span class="skolem">r</span> <span class="main">∧</span><span class="skolem">x1</span> <span class="main">≤</span> <span class="skolem">r</span> <span class="main">∧</span><span class="skolem">x1</span> <span class="main">≤</span> <span class="skolem">w</span> "</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> fin_set in_set_member mem_Collect_eq set_sorted_list_of_set<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> nex r_prop
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">have</span></span> helper2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="main">&lt;</span> <span class="skolem">x1</span> <span class="main">⟶</span> <span class="main">¬</span><span class="main">(</span><span class="main">∃</span><span class="main">(</span><span class="bound">x</span><span class="main">::</span>real<span class="main">)</span><span class="main">.</span> <span class="main">(</span>List.member <span class="var">?zer_list</span> <span class="bound">x</span> <span class="main">∧</span> <span class="skolem">w</span> <span class="main">≤</span> <span class="bound">x</span> <span class="main">∧</span> <span class="bound">x</span> <span class="main">≤</span> <span class="skolem">x1</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> n_prop w_prop x1_prop strict_sorted_h sorted_list_lemma<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> n <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span>"</span></span><span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> l <span class="main"><span class="main">=</span></span> <span class="var"><span class="quoted"><span class="var">?zer_list</span></span></span><span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> a <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span>"</span></span><span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> b <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x1</span>"</span></span><span class="main">]</span> sorted_hyp_var3 
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> no_root2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="main">&lt;</span> <span class="skolem">x1</span> <span class="main">⟹</span> <span class="main">¬</span><span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">r</span></span><span class="main">&lt;</span><span class="skolem">x1</span><span class="main">.</span> <span class="skolem">w</span> <span class="main">≤</span> <span class="bound">r</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span><span class="bound">q</span><span class="main">∈</span>set <span class="free">qs</span><span class="main">.</span> rpoly <span class="bound">q</span> <span class="bound">r</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="main">&lt;</span> <span class="skolem">x1</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> nex<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="main">(</span><span class="main">∃</span><span class="main">(</span><span class="bound">x</span><span class="main">::</span>real<span class="main">)</span><span class="main">.</span> <span class="main">(</span>List.member <span class="var">?zer_list</span> <span class="bound">x</span> <span class="main">∧</span>  <span class="skolem">w</span> <span class="main">≤</span> <span class="bound">x</span> <span class="main">∧</span> <span class="bound">x</span> <span class="main">≤</span> <span class="skolem">x1</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> helper2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">r</span></span><span class="main">&lt;</span><span class="skolem">x1</span><span class="main">.</span> <span class="skolem">w</span> <span class="main">≤</span> <span class="bound">r</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span><span class="bound">q</span><span class="main">∈</span>set <span class="free">qs</span><span class="main">.</span> rpoly <span class="bound">q</span> <span class="bound">r</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> False"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">r</span></span><span class="main">&lt;</span><span class="skolem">x1</span><span class="main">.</span> <span class="skolem">w</span> <span class="main">≤</span> <span class="bound">r</span><span class="main">∧</span> <span class="main">(</span><span class="main">∃</span><span class="bound">q</span><span class="main">∈</span>set <span class="free">qs</span><span class="main">.</span> rpoly <span class="bound">q</span> <span class="bound">r</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword">where</span></span> r_prop<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">&lt;</span> <span class="skolem">x1</span> <span class="main">∧</span> <span class="skolem">w</span> <span class="main">≤</span> <span class="skolem">r</span> <span class="main">∧</span><span class="main">(</span><span class="main">∃</span><span class="bound">q</span><span class="main">∈</span>set <span class="free">qs</span><span class="main">.</span> rpoly <span class="bound">q</span> <span class="skolem">r</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"List.member <span class="var">?zer_list</span> <span class="skolem">r</span> <span class="main">∧</span> <span class="skolem">w</span> <span class="main">≤</span> <span class="skolem">r</span> <span class="main">∧</span> <span class="skolem">r</span> <span class="main">≤</span> <span class="skolem">x1</span> "</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> fin_set in_set_member mem_Collect_eq set_sorted_list_of_set<span class="main">)</span> 
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> nex r_prop
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> w_gt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="main">&gt;</span> <span class="skolem">x1</span> <span class="main">⟶</span> <span class="main">(</span>sign_vec <span class="free">qs</span> <span class="skolem">x1</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>sign_vec <span class="free">qs</span> <span class="skolem">w</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> no_root1 n_prop x2gt <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> w_lt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="main">&lt;</span> <span class="skolem">x1</span> <span class="main">⟶</span> <span class="main">(</span>sign_vec <span class="free">qs</span> <span class="skolem">x1</span><span class="main">)</span>  <span class="main">=</span> <span class="main">(</span>sign_vec <span class="free">qs</span> <span class="skolem">w</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> no_root2 n_prop x2lt  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">sga</span> <span class="main">=</span> <span class="main">(</span>sign_vec <span class="free">qs</span> <span class="skolem">w</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> w_gt w_lt x1_prop <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound">w</span> <span class="main">∈</span> <span class="main">(</span>roots_of_coprime_r <span class="main">(</span>cast_rat_list <span class="free">qs</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> <span class="free">sga</span> <span class="main">=</span> <span class="main">(</span>sign_vec <span class="free">qs</span> <span class="bound">w</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> w_prop <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> triv_neg_inf_h neg_inf_h pos_inf_h between_h x1_and_roots
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> coprime_r_zero1 coprime_r_zero2 mem_Collect_eq roots_of_coprime_r_def<span class="main">)</span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(* This lemma heavily relies on the main BKR_Proofs result and also the lemma named
  roots_of_coprime_r_capture_sgas_without_zeros *)</span>
<span class="keyword1" id="BKR_Decision-find_csas_lemma_nozeros"><span class="command">lemma</span></span> find_csas_lemma_nozeros<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">qs</span><span class="main">::</span> <span class="quoted"><span class="quoted">"rat poly list"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> fs<span class="main">:</span> <span class="quoted"><span class="quoted">"factorize_polys <span class="free">qs</span> <span class="main">=</span> <span class="main">(</span><span class="free">fs</span><span class="main">,</span><span class="free">data</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">fs</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">csa</span> <span class="main">∈</span> <span class="main">(</span>consistent_sign_vectors <span class="free">fs</span> UNIV<span class="main">)</span> <span class="main">∧</span> has_no_zeros <span class="free">csa</span><span class="main">)</span> <span class="main">⟷</span> 
    <span class="free">csa</span> <span class="main">∈</span> set <span class="main">(</span>find_consistent_signs_at_roots <span class="main">(</span>coprime_r <span class="main">(</span>cast_rat_list <span class="free">fs</span><span class="main">)</span><span class="main">)</span>  <span class="main">(</span>cast_rat_list <span class="free">fs</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?new_l</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"cast_rat_list <span class="free">fs</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?copr</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"coprime_r <span class="var">?new_l</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> copr_nonz<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?copr</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> coprime_r_nonzero<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1-2<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> cast_rat_list_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> nontriv_list<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> length <span class="var">?new_l</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms cast_rat_list_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> pairwise_cp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">q</span><span class="main">.</span> <span class="bound">q</span> <span class="main">∈</span> set <span class="var">?new_l</span> <span class="main">⟹</span>
       algebraic_semidom_class.coprime <span class="var">?copr</span> <span class="bound">q</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> coprime_r_coprime_prop<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> cast_rat_list_def comm_monoid_mult_class.coprime_commute coprime_iff_coprime list.set_map<span class="main">)</span> 
  <span class="keyword1"><span class="command">have</span></span> set_fsga<span class="main">:</span> <span class="quoted"><span class="quoted">"set<span class="main">(</span>find_consistent_signs_at_roots <span class="var">?copr</span> <span class="var">?new_l</span><span class="main">)</span> <span class="main">=</span> set<span class="main">(</span>characterize_consistent_signs_at_roots <span class="var">?copr</span> <span class="var">?new_l</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> find_consistent_signs_at_roots<span class="main">[</span><span class="operator">OF</span> copr_nonz pairwise_cp<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> csa_in_hyp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">csa</span> <span class="main">∈</span> set <span class="main">(</span>find_consistent_signs_at_roots <span class="var">?copr</span> <span class="var">?new_l</span><span class="main">)</span>
      <span class="main">⟷</span> <span class="free">csa</span> <span class="main">∈</span> set<span class="main">(</span>characterize_consistent_signs_at_roots <span class="var">?copr</span> <span class="var">?new_l</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> forward<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">csa</span> <span class="main">∈</span> <span class="main">(</span>consistent_sign_vectors <span class="free">fs</span> UNIV<span class="main">)</span> <span class="main">∧</span> has_no_zeros <span class="free">csa</span><span class="main">)</span>
     <span class="main">⟹</span> <span class="free">csa</span> <span class="main">∈</span> set<span class="main">(</span>characterize_consistent_signs_at_roots <span class="var">?copr</span> <span class="var">?new_l</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
    <span class="keyword3"><span class="command">assume</span></span> csa_in<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">csa</span> <span class="main">∈</span> <span class="main">(</span>consistent_sign_vectors <span class="free">fs</span> UNIV<span class="main">)</span> <span class="main">∧</span> has_no_zeros <span class="free">csa</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> fin<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="main">(</span>coprime_r <span class="main">(</span>cast_rat_list <span class="free">fs</span><span class="main">)</span><span class="main">)</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> copr_nonz poly_roots_finite
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> poly_roots_finite fs<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> pcl<span class="main">:</span> <span class="quoted"><span class="quoted">"pairwise_coprime_list <span class="free">fs</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> coprime_factorize fs
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> fst_conv<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> sqf<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">q</span><span class="main">.</span> <span class="bound">q</span> <span class="main">∈</span> set <span class="free">fs</span> <span class="main">⟹</span> rsquarefree <span class="bound">q</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> factorize_polys_square_free<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> square_free_rsquarefree<span class="main">)</span> 
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x1</span></span> <span class="keyword2"><span class="keyword">where</span></span> x1<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="free">csa</span> <span class="main">=</span> sign_vec <span class="free">fs</span> <span class="skolem">x1</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> consistent_sign_vectors_def csa_in <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
    <span class="keyword1"><span class="command">have</span></span> hnz<span class="main">:</span> <span class="quoted"><span class="quoted">"has_no_zeros <span class="free">csa</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> csa_in <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">w</span></span> <span class="keyword2"><span class="keyword">where</span></span> w_prop<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span><span class="main">∈</span>roots_of_coprime_r <span class="main">(</span>cast_rat_list <span class="free">fs</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">csa</span> <span class="main">=</span> sign_vec <span class="free">fs</span> <span class="skolem">w</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> roots_of_coprime_r_capture_sgas_without_zeros<span class="main">[</span><span class="operator">OF</span> pcl sqf x1 hnz<span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> w_root<span class="main">:</span> <span class="quoted"><span class="quoted">"poly <span class="main">(</span>coprime_r <span class="main">(</span>cast_rat_list <span class="free">fs</span><span class="main">)</span><span class="main">)</span> <span class="skolem">w</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> w_prop
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> roots_of_coprime_r_def<span class="main">)</span> 
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="main">(</span>coprime_r <span class="main">(</span>cast_rat_list <span class="free">fs</span><span class="main">)</span><span class="main">)</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> w_ins<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="main">∈</span> set <span class="main">(</span>characterize_root_list_p <span class="main">(</span>coprime_r <span class="main">(</span>cast_rat_list <span class="free">fs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> fin set_sorted_list_of_set<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> A<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="main">(</span>coprime_r <span class="main">(</span>cast_rat_list <span class="free">fs</span><span class="main">)</span><span class="main">)</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span>"</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">unfolding</span></span> characterize_root_list_p_def
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"map <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">if</span> <span class="main">0</span> <span class="main">&lt;</span> <span class="bound">x</span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="bound">x</span> <span class="main">&lt;</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="main">-</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span> <span class="main">∘</span> <span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> rpoly <span class="bound">p</span> <span class="skolem">w</span><span class="main">)</span><span class="main">)</span> <span class="free">fs</span> <span class="main">=</span>
          map <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">if</span> <span class="main">0</span> <span class="main">&lt;</span> <span class="bound">x</span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">∘</span> <span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> rpoly <span class="bound">p</span> <span class="skolem">w</span><span class="main">)</span><span class="main">)</span> <span class="free">fs</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="main">(</span><span class="main">∃</span><span class="bound">x</span> <span class="main">∈</span> set <span class="free">fs</span><span class="main">.</span> rpoly <span class="bound">x</span> <span class="skolem">w</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">clarsimp</span> 
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
        <span class="keyword3"><span class="command">assume</span></span> x_in<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> set <span class="free">fs</span>"</span></span>
        <span class="keyword3"><span class="command">assume</span></span> x_zer<span class="main">:</span> <span class="quoted"><span class="quoted">"rpoly <span class="skolem">x</span> <span class="skolem">w</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">k</span></span> <span class="main">&lt;</span> length <span class="free">fs</span><span class="main">.</span> nth <span class="free">fs</span> <span class="bound">k</span> <span class="main">=</span> <span class="skolem">x</span>"</span></span> 
          <span class="keyword1"><span class="command">using</span></span> x_in
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> in_set_conv_nth<span class="main">)</span> 
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> k_prop<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">&lt;</span> length <span class="free">fs</span> <span class="main">∧</span> <span class="free">fs</span> <span class="main">!</span> <span class="skolem">k</span> <span class="main">=</span> <span class="skolem">x</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>sign_vec <span class="free">fs</span> <span class="skolem">w</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">k</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> x_zer <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span> 
          <span class="keyword1"><span class="command">unfolding</span></span> sign_vec_def squash_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span>has_no_zeros <span class="main">(</span>sign_vec <span class="free">fs</span> <span class="skolem">w</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> hnz_prop k_prop<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> hnz <span class="keyword1"><span class="command">unfolding</span></span> sign_vec_def squash_def
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> has_no_zeros <span class="main">(</span>sign_vec <span class="free">fs</span> <span class="skolem">w</span><span class="main">)</span>›</span></span> w_prop<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> hnz <span class="keyword1"><span class="command">unfolding</span></span> sign_vec_def squash_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"map <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">if</span> <span class="main">0</span> <span class="main">&lt;</span> <span class="bound">x</span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="bound">x</span> <span class="main">&lt;</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="main">-</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span> <span class="main">∘</span> <span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> rpoly <span class="bound">p</span> <span class="skolem">w</span><span class="main">)</span><span class="main">)</span> <span class="free">fs</span> <span class="main">=</span>
    map <span class="main">(</span><span class="main">λ</span><span class="bound">q</span><span class="main">.</span> <span class="keyword1">if</span> <span class="main">0</span> <span class="main">&lt;</span> poly <span class="bound">q</span> <span class="skolem">w</span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>
     <span class="main">(</span>cast_rat_list <span class="free">fs</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">unfolding</span></span> cast_rat_list_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">csa</span> <span class="main">=</span> map <span class="main">(</span><span class="main">λ</span><span class="bound">q</span><span class="main">.</span> <span class="keyword1">if</span> <span class="main">0</span> <span class="main">&lt;</span> poly <span class="bound">q</span> <span class="skolem">w</span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>
             <span class="main">(</span>cast_rat_list <span class="free">fs</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> comp_def sign_vec_def squash_def w_prop<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>    
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> characterize_consistent_signs_at_roots_def  
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> signs_at_def <span class="keyword1"><span class="command">using</span></span> w_ins w_prop
      <span class="keyword1"><span class="command">using</span></span> consistent_sign_vectors_consistent_sign_vectors_r consistent_sign_vectors_def consistent_sign_vectors_r_def signs_at_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">have</span></span> backward<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">csa</span> <span class="main">∈</span> set<span class="main">(</span>characterize_consistent_signs_at_roots <span class="var">?copr</span> <span class="var">?new_l</span><span class="main">)</span> <span class="main">⟹</span>
    <span class="main">(</span><span class="free">csa</span> <span class="main">∈</span> <span class="main">(</span>consistent_sign_vectors <span class="free">fs</span> UNIV<span class="main">)</span> <span class="main">∧</span> has_no_zeros <span class="free">csa</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
    <span class="keyword3"><span class="command">assume</span></span> csa_in<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">csa</span> <span class="main">∈</span> set<span class="main">(</span>characterize_consistent_signs_at_roots <span class="var">?copr</span> <span class="var">?new_l</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> csa_in_old_set<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">csa</span> <span class="main">∈</span> set <span class="main">(</span>characterize_consistent_signs_at_roots_copr <span class="var">?copr</span> <span class="var">?new_l</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> csa_list_copr_rel copr_nonz csa_in find_consistent_signs_at_roots_copr pairwise_cp set_fsga <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="main">(</span><span class="bound">x</span><span class="main">::</span>real<span class="main">)</span><span class="main">.</span> <span class="main">∀</span> <span class="main">(</span><span class="bound">l</span><span class="main">::</span>real poly list<span class="main">)</span><span class="main">.</span> rec_list True <span class="main">(</span><span class="main">λ</span><span class="bound">h</span> <span class="bound">T</span><span class="main">.</span> If <span class="main">(</span><span class="bound">h</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span> False<span class="main">)</span>
          <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">q</span><span class="main">.</span> <span class="keyword1">if</span> <span class="main">0</span> <span class="main">&lt;</span> poly <span class="bound">q</span> <span class="bound">x</span> <span class="keyword1">then</span> <span class="main">(</span><span class="main">1</span><span class="main">::</span>rat<span class="main">)</span> <span class="keyword1">else</span> <span class="main">(</span><span class="main">-</span><span class="main">1</span><span class="main">::</span>rat<span class="main">)</span><span class="main">)</span>
            <span class="bound">l</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">clarsimp</span>  
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span><span class="main">::</span><span class="quoted"><span class="quoted">"real"</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">l</span><span class="main">::</span><span class="quoted"><span class="quoted">"real poly list"</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">" rec_list True <span class="main">(</span><span class="main">λ</span><span class="bound">h</span> <span class="bound">T</span><span class="main">.</span> If <span class="main">(</span><span class="bound">h</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span> False<span class="main">)</span>
            <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">q</span><span class="main">.</span> <span class="keyword1">if</span> <span class="main">0</span> <span class="main">&lt;</span> poly <span class="bound">q</span> <span class="skolem">x</span> <span class="keyword1">then</span> <span class="main">(</span><span class="main">1</span><span class="main">::</span>rat<span class="main">)</span> <span class="keyword1">else</span> <span class="main">(</span><span class="main">-</span><span class="main">1</span><span class="main">::</span>rat<span class="main">)</span><span class="main">)</span> <span class="skolem">l</span><span class="main">)</span> "</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">l</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> Nil
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> 
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">l</span><span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">.</span> rec_list True <span class="main">(</span><span class="main">λ</span><span class="bound">h</span> <span class="bound">T</span><span class="main">.</span> If <span class="main">(</span><span class="bound">h</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span> False<span class="main">)</span>
          <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">q</span><span class="main">.</span> <span class="keyword1">if</span> <span class="main">0</span> <span class="main">&lt;</span> poly <span class="bound">q</span> <span class="bound">x</span> <span class="keyword1">then</span> <span class="main">(</span><span class="main">1</span><span class="main">::</span>rat<span class="main">)</span> <span class="keyword1">else</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>
            <span class="main">(</span>cast_rat_list <span class="free">fs</span><span class="main">)</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> hnz<span class="main">:</span> <span class="quoted"><span class="quoted">"has_no_zeros <span class="free">csa</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> csa_in_old_set
      <span class="keyword1"><span class="command">unfolding</span></span> characterize_consistent_signs_at_roots_copr_def consistent_sign_vec_copr_def 
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> has_no_zeros_def  
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">w</span> <span class="main">∈</span> set<span class="main">(</span>characterize_root_list_p <span class="var">?copr</span><span class="main">)</span><span class="main">.</span> <span class="free">csa</span> <span class="main">=</span> consistent_sign_vec_copr <span class="var">?new_l</span> <span class="bound">w</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> csa_in_old_set <span class="keyword1"><span class="command">using</span></span> characterize_consistent_signs_at_roots_copr_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">w</span></span> <span class="keyword2"><span class="keyword">where</span></span> w_prop<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="main">∈</span> set <span class="main">(</span>characterize_root_list_p <span class="var">?copr</span><span class="main">)</span> <span class="main">∧</span> <span class="free">csa</span> <span class="main">=</span> consistent_sign_vec_copr <span class="var">?new_l</span> <span class="skolem">w</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"poly <span class="var">?copr</span> <span class="skolem">w</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> characterize_root_list_p_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> copr_nonz poly_roots_finite<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> copr_prop<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span> <span class="main">∈</span> set<span class="main">(</span><span class="var">?new_l</span><span class="main">)</span><span class="main">.</span> poly <span class="bound">p</span> <span class="skolem">w</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> w_prop coprime_r_coprime_prop <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> coprime_poly_0 in_set_member pairwise_cp<span class="main">)</span> 
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"consistent_sign_vec_copr <span class="var">?new_l</span> <span class="skolem">w</span> <span class="main">=</span> sign_vec <span class="free">fs</span> <span class="skolem">w</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> sign_vec_def squash_def consistent_sign_vec_copr_def
        cast_rat_list_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> hnz w_prop <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> consistent_sign_vectors_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">csa</span> <span class="main">∈</span> <span class="main">(</span>consistent_sign_vectors <span class="free">fs</span> UNIV<span class="main">)</span> <span class="main">∧</span> has_no_zeros <span class="free">csa</span><span class="main">)</span>
     <span class="main">⟷</span> <span class="free">csa</span> <span class="main">∈</span> set<span class="main">(</span>characterize_consistent_signs_at_roots <span class="var">?copr</span> <span class="var">?new_l</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> forward backward <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span>  csa_in_hyp <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="BKR_Decision-range_eq"><span class="command">lemma</span></span> range_eq<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">a</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">b</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">=</span> <span class="free">b</span> <span class="main">⟶</span> range <span class="free">a</span> <span class="main">=</span> range <span class="free">b</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="BKR_Decision-removeAt_distinct"><span class="command">lemma</span></span> removeAt_distinct<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"distinct <span class="free">fss</span> <span class="main">⟹</span> distinct <span class="main">(</span>removeAt <span class="free">i</span> <span class="free">fss</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> removeAt_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> set_take_disj_set_drop_if_distinct<span class="main">)</span>

<span class="keyword1" id="BKR_Decision-consistent_signs_atw"><span class="command">lemma</span></span> consistent_signs_atw<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">p</span><span class="main">.</span> <span class="bound">p</span> <span class="main">∈</span> set <span class="free">fs</span> <span class="main">⟹</span> poly <span class="bound">p</span> <span class="free">x</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"consistent_sign_vec_copr <span class="free">fs</span> <span class="free">x</span> <span class="main">=</span> signs_at <span class="free">fs</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> consistent_sign_vec_copr_def signs_at_def squash_def o_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main">)</span>

<span class="comment1">(* This could be an alternate (equivalent) definition *)</span>
<span class="keyword1" id="BKR_Decision-characterize_consistent_signs_at_roots_rw"><span class="command">lemma</span></span> characterize_consistent_signs_at_roots_rw<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> copr<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">q</span><span class="main">.</span> <span class="bound">q</span> <span class="main">∈</span> set <span class="free">fs</span> <span class="main">⟹</span> coprime <span class="free">p</span> <span class="bound">q</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>characterize_consistent_signs_at_roots <span class="free">p</span> <span class="free">fs</span><span class="main">)</span> <span class="main">=</span>
    consistent_sign_vectors_r <span class="free">fs</span> <span class="main">(</span><span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> characterize_consistent_signs_at_roots_def consistent_sign_vectors_r_def poly_roots_finite characterize_root_list_p_def<span class="main">)</span>

<span class="keyword1" id="BKR_Decision-signs_at_insert"><span class="command">lemma</span></span> signs_at_insert<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≤</span> length <span class="free">qs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"insertAt <span class="free">i</span> <span class="main">(</span>squash <span class="main">(</span>poly <span class="free">p</span> <span class="free">x</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>signs_at <span class="free">qs</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span>
    signs_at <span class="main">(</span>insertAt <span class="free">i</span> <span class="free">p</span> <span class="free">qs</span><span class="main">)</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> insertAt_def signs_at_def o_def <span class="keyword1"><span class="command">using</span></span> assms take_map <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> drop_map<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="BKR_Decision-length_removeAt"><span class="command">lemma</span></span> length_removeAt<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> length <span class="free">ls</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>removeAt <span class="free">i</span> <span class="free">ls</span><span class="main">)</span> <span class="main">=</span> length <span class="free">ls</span> <span class="main">-</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> removeAt_def <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="BKR_Decision-insertAt_removeAt"><span class="command">lemma</span></span> insertAt_removeAt<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> length <span class="free">ls</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"insertAt <span class="free">i</span> <span class="main">(</span><span class="free">ls</span><span class="main">!</span><span class="free">i</span><span class="main">)</span> <span class="main">(</span>removeAt <span class="free">i</span> <span class="free">ls</span><span class="main">)</span> <span class="main">=</span> <span class="free">ls</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> insertAt_def removeAt_def <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Cons_nth_drop_Suc<span class="main">)</span>

<span class="keyword1" id="BKR_Decision-insertAt_nth"><span class="command">lemma</span></span> insertAt_nth<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≤</span> length <span class="free">ls</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"insertAt <span class="free">i</span> <span class="free">n</span> <span class="free">ls</span> <span class="main">!</span> <span class="free">i</span> <span class="main">=</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> insertAt_def <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nth_append_take<span class="main">)</span>

<span class="keyword1" id="BKR_Decision-length_signs_at"><span class="command">lemma</span></span> length_signs_at<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>signs_at <span class="free">qs</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> length <span class="free">qs</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> signs_at_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="BKR_Decision-find_csa_at_index"><span class="command">lemma</span></span> find_csa_at_index<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> length <span class="free">fss</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">p</span> <span class="bound">q</span><span class="main">.</span> <span class="bound">p</span> <span class="main">∈</span> set <span class="free">fss</span> <span class="main">⟹</span> <span class="bound">q</span> <span class="main">∈</span> set <span class="free">fss</span> <span class="main">⟹</span> <span class="bound">p</span> <span class="main">≠</span> <span class="bound">q</span> <span class="main">⟹</span> coprime <span class="bound">p</span> <span class="bound">q</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">p</span><span class="main">.</span> <span class="bound">p</span> <span class="main">∈</span> set <span class="free">fss</span> <span class="main">⟹</span> <span class="bound">p</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"distinct <span class="free">fss</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"
  set <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> insertAt <span class="free">i</span> <span class="main">0</span> <span class="bound">v</span><span class="main">)</span> <span class="main">(</span>find_consistent_signs_at_roots <span class="main">(</span><span class="free">fss</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span> <span class="main">(</span>removeAt <span class="free">i</span> <span class="free">fss</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
    <span class="main">{</span><span class="bound"><span class="bound">v</span></span> <span class="main">∈</span> consistent_sign_vectors_r <span class="free">fss</span> UNIV<span class="main">.</span> <span class="bound">v</span> <span class="main">!</span> <span class="free">i</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> removeAt_distinct<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> neq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">fss</span> <span class="main">!</span> <span class="free">i</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> cop<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">q</span><span class="main">.</span> <span class="bound">q</span> <span class="main">∈</span> set <span class="main">(</span>removeAt <span class="free">i</span> <span class="free">fss</span><span class="main">)</span> <span class="main">⟹</span> coprime <span class="main">(</span><span class="free">fss</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span> <span class="bound">q</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">unfolding</span></span> removeAt_def 
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">using</span></span> dual_order.strict_trans find_first_unique image_iff less_imp_le_nat less_not_refl nth_image nth_mem
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">smt</span> atLeastLessThan_iff dual_order.strict_trans find_first_unique image_iff less_imp_le_nat less_not_refl nth_image nth_mem<span class="main">)</span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Cons_nth_drop_Suc distinct.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> distinct_drop in_set_dropD nth_mem<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> find_consistent_signs_at_roots<span class="main">[</span><span class="operator">OF</span> neq<span class="main">]</span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>find_consistent_signs_at_roots <span class="main">(</span><span class="free">fss</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span> <span class="main">(</span>removeAt <span class="free">i</span> <span class="free">fss</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
        set <span class="main">(</span>characterize_consistent_signs_at_roots <span class="main">(</span><span class="free">fss</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span> <span class="main">(</span>removeAt <span class="free">i</span> <span class="free">fss</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> cop <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> eq<span class="main">:</span>  <span class="quoted"><span class="quoted">"set <span class="main">(</span>map <span class="main">(</span>insertAt <span class="free">i</span> <span class="main">0</span><span class="main">)</span>
          <span class="main">(</span>find_consistent_signs_at_roots <span class="main">(</span><span class="free">fss</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span>
            <span class="main">(</span>removeAt <span class="free">i</span> <span class="free">fss</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> insertAt <span class="free">i</span> <span class="main">0</span> <span class="main">`</span> set <span class="main">(</span>characterize_consistent_signs_at_roots <span class="main">(</span><span class="free">fss</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span> <span class="main">(</span>removeAt <span class="free">i</span> <span class="free">fss</span><span class="main">)</span><span class="main">)</span> "</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> characterize_consistent_signs_at_roots_rw<span class="main">[</span><span class="operator">OF</span> neq cop<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> eq2<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>characterize_consistent_signs_at_roots <span class="main">(</span><span class="free">fss</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span> <span class="main">(</span>removeAt <span class="free">i</span> <span class="free">fss</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> consistent_sign_vectors_r <span class="main">(</span>removeAt <span class="free">i</span> <span class="free">fss</span><span class="main">)</span>  <span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="main">(</span><span class="free">fss</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">have</span></span> ile<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≤</span> length <span class="main">(</span>removeAt <span class="free">i</span> <span class="free">fss</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span>  length_removeAt<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
  <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">xb</span><span class="main">.</span> poly <span class="main">(</span><span class="free">fss</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span> <span class="bound">xb</span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟹</span>
          insertAt <span class="free">i</span> <span class="main">0</span> <span class="main">(</span>signs_at <span class="main">(</span>removeAt <span class="free">i</span> <span class="free">fss</span><span class="main">)</span> <span class="bound">xb</span><span class="main">)</span> <span class="main">∈</span> range <span class="main">(</span>signs_at <span class="free">fss</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"poly <span class="main">(</span><span class="free">fss</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"insertAt <span class="free">i</span> <span class="main">0</span> <span class="main">(</span>signs_at <span class="main">(</span>removeAt <span class="free">i</span> <span class="free">fss</span><span class="main">)</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">=</span>
        insertAt <span class="free">i</span> <span class="main">(</span>squash <span class="main">(</span>poly <span class="main">(</span><span class="free">fss</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>signs_at <span class="main">(</span>removeAt <span class="free">i</span> <span class="free">fss</span><span class="main">)</span> <span class="skolem">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> squash_def<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span>  signs_at <span class="main">(</span>insertAt <span class="free">i</span> <span class="main">(</span><span class="free">fss</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span>  <span class="main">(</span>removeAt <span class="free">i</span> <span class="free">fss</span><span class="main">)</span><span class="main">)</span> <span class="skolem">x</span>"</span></span> 
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> signs_at_insert<span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span>  length_removeAt<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> signs_at <span class="free">fss</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> insertAt_removeAt<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span><span class="quoted"><span class="quoted">"insertAt <span class="free">i</span> <span class="main">0</span> <span class="main">(</span>signs_at <span class="main">(</span>removeAt <span class="free">i</span> <span class="free">fss</span><span class="main">)</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">=</span> signs_at <span class="free">fss</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"insertAt <span class="free">i</span> <span class="main">0</span> <span class="main">(</span>signs_at <span class="main">(</span>removeAt <span class="free">i</span> <span class="free">fss</span><span class="main">)</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">∈</span> range <span class="main">(</span>signs_at <span class="free">fss</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">xa</span><span class="main">.</span> signs_at <span class="free">fss</span> <span class="bound">xa</span> <span class="main">!</span> <span class="free">i</span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟹</span>
          <span class="free">i</span> <span class="main">≤</span> length <span class="main">(</span>removeAt <span class="free">i</span> <span class="free">fss</span><span class="main">)</span> <span class="main">⟹</span>
          signs_at <span class="free">fss</span> <span class="bound">xa</span>
          <span class="main">∈</span> insertAt <span class="free">i</span> <span class="main">0</span> <span class="main">`</span>
             signs_at <span class="main">(</span>removeAt <span class="free">i</span> <span class="free">fss</span><span class="main">)</span> <span class="main">`</span>
             <span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="main">(</span><span class="free">fss</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"signs_at <span class="free">fss</span> <span class="skolem">x</span> <span class="main">!</span> <span class="free">i</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> z<span class="main">:</span><span class="quoted"><span class="quoted">"poly <span class="main">(</span><span class="free">fss</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> signs_at_def o_def squash_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> class_field.zero_not_one nth_map zero_neq_neg_one<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"insertAt <span class="free">i</span> <span class="main">0</span> <span class="main">(</span>signs_at <span class="main">(</span>removeAt <span class="free">i</span> <span class="free">fss</span><span class="main">)</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">=</span>
      insertAt <span class="free">i</span> <span class="main">(</span>squash <span class="main">(</span>poly <span class="main">(</span><span class="free">fss</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>signs_at <span class="main">(</span>removeAt <span class="free">i</span> <span class="free">fss</span><span class="main">)</span> <span class="skolem">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> squash_def<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span>  signs_at <span class="main">(</span>insertAt <span class="free">i</span> <span class="main">(</span><span class="free">fss</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span>  <span class="main">(</span>removeAt <span class="free">i</span> <span class="free">fss</span><span class="main">)</span><span class="main">)</span> <span class="skolem">x</span>"</span></span> 
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> signs_at_insert<span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span>  length_removeAt<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> signs_at <span class="free">fss</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> insertAt_removeAt<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span><span class="quoted"><span class="quoted">"insertAt <span class="free">i</span> <span class="main">0</span> <span class="main">(</span>signs_at <span class="main">(</span>removeAt <span class="free">i</span> <span class="free">fss</span><span class="main">)</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">=</span> signs_at <span class="free">fss</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"signs_at <span class="free">fss</span> <span class="skolem">x</span> <span class="main">∈</span> insertAt <span class="free">i</span> <span class="main">0</span> <span class="main">`</span> signs_at <span class="main">(</span>removeAt <span class="free">i</span> <span class="free">fss</span><span class="main">)</span> <span class="main">`</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="main">(</span><span class="free">fss</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> z
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> mem_Collect_eq rev_image_eqI<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"insertAt <span class="free">i</span> <span class="main">0</span> <span class="main">`</span> consistent_sign_vectors_r <span class="main">(</span>removeAt <span class="free">i</span> <span class="free">fss</span><span class="main">)</span>  <span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="main">(</span><span class="free">fss</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span> <span class="main">=</span>
         <span class="main">{</span><span class="bound"><span class="bound">v</span></span> <span class="main">∈</span> consistent_sign_vectors_r <span class="free">fss</span> UNIV<span class="main">.</span> <span class="bound">v</span> <span class="main">!</span> <span class="free">i</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> consistent_sign_vectors_r_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> 1<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> insertAt_nth<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> ile <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> 2<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> eq eq2 <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="BKR_Decision-in_set_concat_map"><span class="command">lemma</span></span> in_set_concat_map<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> length <span class="free">ls</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> set <span class="main">(</span><span class="free">f</span> <span class="main">(</span><span class="free">ls</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> set <span class="main">(</span>concat <span class="main">(</span>map <span class="free">f</span> <span class="free">ls</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="BKR_Decision-find_csas_lemma_onezero_gen"><span class="command">lemma</span></span> find_csas_lemma_onezero_gen<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">qs</span><span class="main">::</span> <span class="quoted"><span class="quoted">"rat poly list"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> fs<span class="main">:</span> <span class="quoted"><span class="quoted">"factorize_polys <span class="free">qs</span> <span class="main">=</span> <span class="main">(</span><span class="free">fs</span><span class="main">,</span><span class="free">data</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> fss<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">fss</span> <span class="main">=</span> cast_rat_list <span class="free">fs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">csa</span> <span class="main">∈</span> <span class="main">(</span>consistent_sign_vectors_r <span class="free">fss</span> UNIV<span class="main">)</span> <span class="main">∧</span> <span class="main">¬</span><span class="main">(</span>has_no_zeros <span class="free">csa</span><span class="main">)</span><span class="main">)</span>
    <span class="main">⟷</span>  <span class="free">csa</span> <span class="main">∈</span> set <span class="main">(</span>find_sgas_aux <span class="free">fss</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> a<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">p</span> <span class="bound">q</span><span class="main">.</span> <span class="bound">p</span> <span class="main">∈</span> set <span class="free">fss</span> <span class="main">⟹</span>
          <span class="bound">q</span> <span class="main">∈</span> set <span class="free">fss</span> <span class="main">⟹</span>
          <span class="bound">p</span> <span class="main">≠</span> <span class="bound">q</span> <span class="main">⟹</span> coprime <span class="bound">p</span>
           <span class="bound">q</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> cast_rat_list_def factorize_polys_map_coprime fs fss <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
  <span class="keyword1"><span class="command">have</span></span> b<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">p</span><span class="main">.</span> <span class="bound">p</span> <span class="main">∈</span> set <span class="free">fss</span> <span class="main">⟹</span> <span class="bound">p</span> <span class="main">≠</span> <span class="main">0</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> factorize_polys_map_square_free_prod_list semidom_class.prod_list_zero_iff square_free_def
    <span class="keyword1"><span class="command">using</span></span> cast_rat_list_def fs fss <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> c<span class="main">:</span><span class="quoted"><span class="quoted">"distinct <span class="free">fss</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> factorize_polys_map_distinct<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> cast_rat_list_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> forwards<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">csa</span> <span class="main">∈</span> <span class="main">(</span>consistent_sign_vectors_r <span class="free">fss</span> UNIV<span class="main">)</span> <span class="main">⟹</span>
    <span class="main">¬</span> <span class="main">(</span>has_no_zeros <span class="free">csa</span><span class="main">)</span>
    <span class="main">⟹</span> <span class="free">csa</span> <span class="main">∈</span> set <span class="main">(</span>find_sgas_aux <span class="free">fss</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> find_sgas_aux_def
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">assume</span></span> csa<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">csa</span> <span class="main">∈</span> <span class="main">(</span>consistent_sign_vectors_r <span class="free">fss</span> UNIV<span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> hnz<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="main">(</span>has_no_zeros <span class="free">csa</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="free">csa</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">csa</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> hnz_prop <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> cin<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">csa</span> <span class="main">∈</span> <span class="main">{</span><span class="bound"><span class="bound">v</span></span> <span class="main">∈</span> consistent_sign_vectors_r <span class="free">fss</span> UNIV<span class="main">.</span> <span class="bound">v</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> csa <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="free">fss</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> i csa <span class="keyword1"><span class="command">unfolding</span></span> consistent_sign_vectors_r_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> find_csa_at_index<span class="main">[</span><span class="operator">OF</span> 1 a b c<span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> insertAt <span class="skolem">i</span> <span class="main">0</span> <span class="bound">v</span><span class="main">)</span> <span class="main">(</span>find_consistent_signs_at_roots <span class="main">(</span><span class="free">fss</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">(</span>removeAt <span class="skolem">i</span> <span class="free">fss</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
      <span class="main">{</span><span class="bound"><span class="bound">v</span></span> <span class="main">∈</span> consistent_sign_vectors_r <span class="free">fss</span> UNIV<span class="main">.</span> <span class="bound">v</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">csa</span> <span class="main">∈</span> set <span class="main">(</span>concat <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> map <span class="main">(</span>insertAt <span class="bound">i</span> <span class="main">0</span><span class="main">)</span> <span class="main">(</span>find_consistent_signs_at_roots <span class="main">(</span><span class="free">fss</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span>removeAt <span class="bound">i</span> <span class="free">fss</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="free">fss</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> cin i <span class="keyword1"><span class="command">unfolding</span></span> eq<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span>  in_set_concat_map<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">i</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>      
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">have</span></span> backwards<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">csa</span> <span class="main">∈</span> set <span class="main">(</span>find_sgas_aux <span class="free">fss</span><span class="main">)</span> <span class="main">⟹</span>
    <span class="main">¬</span> <span class="main">(</span>has_no_zeros <span class="free">csa</span><span class="main">)</span> <span class="main">∧</span> <span class="free">csa</span> <span class="main">∈</span> <span class="main">(</span>consistent_sign_vectors_r <span class="free">fss</span> UNIV<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">assume</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">csa</span> <span class="main">∈</span> set <span class="main">(</span>find_sgas_aux <span class="free">fss</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="free">fss</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="free">csa</span> <span class="main">∈</span> set <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> insertAt <span class="skolem">i</span> <span class="main">0</span> <span class="bound">v</span><span class="main">)</span> <span class="main">(</span>find_consistent_signs_at_roots <span class="main">(</span><span class="free">fss</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">(</span>removeAt <span class="skolem">i</span> <span class="free">fss</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> find_sgas_aux_def
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> find_csa_at_index<span class="main">[</span><span class="operator">OF</span> i<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> a b c<span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> insertAt <span class="skolem">i</span> <span class="main">0</span> <span class="bound">v</span><span class="main">)</span> <span class="main">(</span>find_consistent_signs_at_roots <span class="main">(</span><span class="free">fss</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">(</span>removeAt <span class="skolem">i</span> <span class="free">fss</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
      <span class="main">{</span><span class="bound"><span class="bound">v</span></span> <span class="main">∈</span> consistent_sign_vectors_r <span class="free">fss</span> UNIV<span class="main">.</span> <span class="bound">v</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">csa</span> <span class="main">∈</span> <span class="main">{</span><span class="bound"><span class="bound">v</span></span> <span class="main">∈</span> consistent_sign_vectors_r <span class="free">fss</span> UNIV<span class="main">.</span> <span class="bound">v</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> i eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="free">csa</span> <span class="main">=</span> length <span class="free">fss</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> consistent_sign_vectors_r_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> has_no_zeros_def <span class="keyword1"><span class="command">using</span></span> * <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>in_set_conv_nth<span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> i<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span>  forwards backwards <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="BKR_Decision-mem_append"><span class="command">lemma</span></span> mem_append<span class="main">:</span> <span class="quoted"><span class="quoted">"List.member <span class="main">(</span><span class="free">l1</span><span class="main">@</span><span class="free">l2</span><span class="main">)</span> <span class="free">m</span> <span class="main">⟷</span> <span class="main">(</span>List.member <span class="free">l1</span> <span class="free">m</span> <span class="main">∨</span> List.member <span class="free">l2</span> <span class="free">m</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> List.member_def<span class="main">)</span>

<span class="keyword1" id="BKR_Decision-same_sign_cond_rationals_reals"><span class="command">lemma</span></span> same_sign_cond_rationals_reals<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">qs</span><span class="main">::</span> <span class="quoted"><span class="quoted">"rat poly list"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> lenh<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>fst<span class="main">(</span>factorize_polys <span class="free">qs</span><span class="main">)</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"set<span class="main">(</span>find_sgas <span class="main">(</span>map <span class="main">(</span>map_poly of_rat<span class="main">)</span> <span class="main">(</span>fst<span class="main">(</span>factorize_polys <span class="free">qs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> consistent_sign_vectors <span class="main">(</span>fst<span class="main">(</span>factorize_polys <span class="free">qs</span><span class="main">)</span><span class="main">)</span> UNIV"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?ftrs</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>fst<span class="main">(</span>factorize_polys <span class="free">qs</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> pairwise_rel_prime<span class="main">:</span> <span class="quoted"><span class="quoted">"pairwise_coprime_list <span class="main">(</span>fst<span class="main">(</span>factorize_polys <span class="free">qs</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> factorize_polys_coprime
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> coprime_factorize<span class="main">)</span> 
  <span class="keyword1"><span class="command">have</span></span> all_squarefree<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">q</span><span class="main">.</span> <span class="main">(</span>List.member <span class="main">(</span>fst<span class="main">(</span>factorize_polys <span class="free">qs</span><span class="main">)</span><span class="main">)</span> <span class="bound">q</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">(</span>rsquarefree <span class="bound">q</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> factorize_polys_square_free
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> in_set_member prod.collapse square_free_rsquarefree<span class="main">)</span> 
  <span class="keyword1"><span class="command">have</span></span> allnonzero<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">q</span><span class="main">.</span> <span class="main">(</span>List.member <span class="var">?ftrs</span> <span class="bound">q</span><span class="main">)</span> <span class="main">⟶</span> <span class="bound">q</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> all_squarefree <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> rsquarefree_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
  <span class="keyword1"><span class="command">have</span></span> h1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">csa</span><span class="main">.</span> <span class="main">(</span><span class="bound">csa</span> <span class="main">∈</span> <span class="main">(</span>consistent_sign_vectors <span class="var">?ftrs</span> UNIV<span class="main">)</span> <span class="main">∧</span> <span class="main">¬</span> <span class="main">(</span>has_no_zeros <span class="bound">csa</span><span class="main">)</span><span class="main">)</span>
    <span class="main">⟷</span>  <span class="bound">csa</span> <span class="main">∈</span> set <span class="main">(</span>find_sgas_aux <span class="main">(</span>cast_rat_list <span class="var">?ftrs</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> lenh find_csas_lemma_onezero_gen pairwise_rel_prime allnonzero
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> consistent_sign_vectors_consistent_sign_vectors_r eq_fst_iff<span class="main">)</span> 
  <span class="keyword1"><span class="command">have</span></span> h2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">csa</span><span class="main">.</span> <span class="main">(</span><span class="bound">csa</span> <span class="main">∈</span> <span class="main">(</span>consistent_sign_vectors <span class="var">?ftrs</span> UNIV<span class="main">)</span> <span class="main">∧</span> has_no_zeros <span class="bound">csa</span><span class="main">)</span> <span class="main">⟷</span> 
    List.member <span class="main">(</span>find_consistent_signs_at_roots <span class="main">(</span>coprime_r <span class="main">(</span>cast_rat_list <span class="var">?ftrs</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>cast_rat_list <span class="var">?ftrs</span><span class="main">)</span><span class="main">)</span> <span class="bound">csa</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> lenh find_csas_lemma_nozeros pairwise_rel_prime allnonzero
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> in_set_member length_greater_0_conv prod.collapse<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> h3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">csa</span><span class="main">.</span> List.member <span class="main">(</span>find_sgas <span class="main">(</span>map <span class="main">(</span>map_poly of_rat<span class="main">)</span> <span class="var">?ftrs</span><span class="main">)</span><span class="main">)</span> <span class="bound">csa</span> <span class="main">⟷</span> 
      <span class="main">(</span><span class="main">(</span>List.member <span class="main">(</span>find_sgas_aux <span class="main">(</span>cast_rat_list <span class="var">?ftrs</span><span class="main">)</span><span class="main">)</span> <span class="bound">csa</span><span class="main">)</span> <span class="main">∨</span>  <span class="main">(</span>List.member <span class="main">(</span>find_consistent_signs_at_roots <span class="main">(</span>coprime_r <span class="main">(</span>cast_rat_list <span class="var">?ftrs</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>cast_rat_list <span class="var">?ftrs</span><span class="main">)</span><span class="main">)</span> <span class="bound">csa</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> find_sgas_def cast_rat_list_def <span class="keyword1"><span class="command">using</span></span> mem_append
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span> 
  <span class="keyword1"><span class="command">have</span></span> h4<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">csa</span><span class="main">.</span> List.member <span class="main">(</span>find_sgas <span class="main">(</span>map <span class="main">(</span>map_poly of_rat<span class="main">)</span> <span class="var">?ftrs</span><span class="main">)</span><span class="main">)</span> <span class="bound">csa</span> <span class="main">⟷</span>
   <span class="main">(</span><span class="main">(</span><span class="bound">csa</span> <span class="main">∈</span> <span class="main">(</span>consistent_sign_vectors <span class="var">?ftrs</span> UNIV<span class="main">)</span> <span class="main">∧</span> has_no_zeros <span class="bound">csa</span><span class="main">)</span> <span class="main">∨</span>  <span class="main">(</span><span class="bound">csa</span> <span class="main">∈</span> <span class="main">(</span>consistent_sign_vectors <span class="var">?ftrs</span> UNIV<span class="main">)</span> <span class="main">∧</span> <span class="main">¬</span> <span class="main">(</span>has_no_zeros <span class="bound">csa</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> h1 h2 h3  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> in_set_member<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> in_set_member<span class="main">)</span>  
  <span class="keyword1"><span class="command">have</span></span> h5<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">csa</span><span class="main">.</span> <span class="main">(</span><span class="bound">csa</span> <span class="main">∈</span> <span class="main">(</span>consistent_sign_vectors <span class="var">?ftrs</span> UNIV<span class="main">)</span> <span class="main">∧</span> has_no_zeros <span class="bound">csa</span><span class="main">)</span> <span class="main">∨</span>  <span class="main">(</span><span class="bound">csa</span> <span class="main">∈</span> <span class="main">(</span>consistent_sign_vectors <span class="var">?ftrs</span> UNIV<span class="main">)</span> <span class="main">∧</span> <span class="main">¬</span> <span class="main">(</span>has_no_zeros <span class="bound">csa</span><span class="main">)</span><span class="main">)</span>
    <span class="main">⟷</span> <span class="bound">csa</span> <span class="main">∈</span> <span class="main">(</span>consistent_sign_vectors <span class="var">?ftrs</span> UNIV<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">csa</span><span class="main">.</span> List.member <span class="main">(</span>find_sgas <span class="main">(</span>map <span class="main">(</span>map_poly of_rat<span class="main">)</span> <span class="var">?ftrs</span><span class="main">)</span><span class="main">)</span> <span class="bound">csa</span> <span class="main">⟷</span> <span class="bound">csa</span> <span class="main">∈</span> <span class="main">(</span>consistent_sign_vectors <span class="var">?ftrs</span> UNIV<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> h4
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> in_set_member <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> in_set_member<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> in_set_member<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="BKR_Decision-factorize_polys_undo_factorize_polys_set"><span class="command">lemma</span></span> factorize_polys_undo_factorize_polys_set<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"factorize_polys <span class="free">ps</span> <span class="main">=</span> <span class="main">(</span><span class="free">ftrs</span><span class="main">,</span><span class="free">data</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">sgas</span> <span class="main">=</span>  find_sgas <span class="main">(</span>map <span class="main">(</span>map_poly of_rat<span class="main">)</span> <span class="free">ftrs</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> sgas_set<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span><span class="free">sgas</span><span class="main">)</span> <span class="main">=</span> consistent_sign_vectors <span class="free">ftrs</span> UNIV"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>map <span class="main">(</span>undo_factorize_polys <span class="free">data</span><span class="main">)</span> <span class="free">sgas</span><span class="main">)</span> <span class="main">=</span> consistent_sign_vectors <span class="free">ps</span> UNIV"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> h<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">.</span> undo_factorize_polys <span class="free">data</span> <span class="main">(</span>sign_vec <span class="free">ftrs</span> <span class="bound">x</span><span class="main">)</span> <span class="main">=</span> sign_vec <span class="free">ps</span> <span class="bound">x</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> factorize_polys_undo_factorize_polys
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span> 
  <span class="keyword1"><span class="command">have</span></span> h1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">.</span> sign_vec <span class="free">ps</span> <span class="bound">x</span> <span class="main">∈</span> set <span class="main">(</span>map <span class="main">(</span>undo_factorize_polys <span class="free">data</span><span class="main">)</span> <span class="free">sgas</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> sgas_set
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> UNIV_I consistent_sign_vectors_def h image_eqI image_set<span class="main">)</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> subset_h<span class="main">:</span> <span class="quoted"><span class="quoted">"consistent_sign_vectors <span class="free">ps</span> UNIV <span class="main">⊆</span> set <span class="main">(</span>map <span class="main">(</span>undo_factorize_polys <span class="free">data</span><span class="main">)</span> <span class="free">sgas</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> consistent_sign_vectors_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> supset_h<span class="main">:</span>  <span class="quoted"><span class="quoted">"consistent_sign_vectors <span class="free">ps</span> UNIV <span class="main">⊇</span> set <span class="main">(</span>map <span class="main">(</span>undo_factorize_polys <span class="free">data</span><span class="main">)</span> <span class="free">sgas</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">ele</span><span class="main">.</span> <span class="bound">ele</span> <span class="main">∈</span> set <span class="main">(</span>map <span class="main">(</span>undo_factorize_polys <span class="free">data</span><span class="main">)</span> <span class="free">sgas</span><span class="main">)</span> <span class="main">⟶</span>
       <span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">n</span></span> <span class="main">&lt;</span> length <span class="free">sgas</span><span class="main">.</span> <span class="bound">ele</span> <span class="main">=</span> <span class="main">(</span>undo_factorize_polys <span class="free">data</span> <span class="main">(</span>nth <span class="free">sgas</span> <span class="bound">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> index_of_lookup<span class="main">(</span>1<span class="main">)</span> index_of_lookup<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">ele</span><span class="main">.</span> <span class="bound">ele</span> <span class="main">∈</span> set <span class="main">(</span>map <span class="main">(</span>undo_factorize_polys <span class="free">data</span><span class="main">)</span> <span class="free">sgas</span><span class="main">)</span> <span class="main">⟶</span>
       <span class="main">(</span><span class="main">∃</span><span class="bound">x</span><span class="main">.</span> <span class="bound">ele</span> <span class="main">=</span> <span class="main">(</span>undo_factorize_polys <span class="free">data</span> <span class="main">(</span>sign_vec <span class="free">ftrs</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> sgas_set <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>  <span class="keyword1"><span class="command">using</span></span> consistent_sign_vectors_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> h
      <span class="keyword1"><span class="command">using</span></span> consistent_sign_vectors_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> subset_h supset_h
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="BKR_Decision-main_step_aux1"><span class="command">lemma</span></span> main_step_aux1<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">qs</span><span class="main">::</span> <span class="quoted"><span class="quoted">"rat poly list"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> empty<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>fst<span class="main">(</span>factorize_polys <span class="free">qs</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>find_consistent_signs <span class="free">qs</span><span class="main">)</span> <span class="main">=</span>  consistent_sign_vectors <span class="free">qs</span> UNIV"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> set_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>find_consistent_signs <span class="free">qs</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">if</span> poly <span class="bound">x</span> <span class="main">0</span> <span class="main">&lt;</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="main">-</span><span class="main">1</span> <span class="keyword1">else</span> <span class="keyword1">if</span> poly <span class="bound">x</span> <span class="main">0</span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="main">0</span> <span class="keyword1">else</span> <span class="main">1</span><span class="main">)</span> <span class="free">qs</span><span class="main">)</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> empty <span class="keyword1"><span class="command">unfolding</span></span> find_consistent_signs_def <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> fst_conv<span class="main">)</span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> prod.collapse<span class="main">)</span> 
  <span class="keyword1"><span class="command">have</span></span> deg_q_prop<span class="main">:</span> <span class="quoted"><span class="quoted">"fst<span class="main">(</span>factorize_polys <span class="free">qs</span><span class="main">)</span> <span class="main">=</span> <span class="main">[]</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">∀</span><span class="bound">q</span> <span class="main">∈</span>set<span class="main">(</span><span class="free">qs</span><span class="main">)</span><span class="main">.</span> degree <span class="bound">q</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">clarsimp</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">q</span>
    <span class="keyword3"><span class="command">assume</span></span> *<span class="main">:</span><span class="quoted"><span class="quoted">"fst<span class="main">(</span>factorize_polys <span class="free">qs</span><span class="main">)</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> q<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">∈</span> set <span class="free">qs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> degree <span class="skolem">q</span>"</span></span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">arb</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"factorize_rat_poly_monic <span class="skolem">q</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">arb</span><span class="main">,</span><span class="main">[]</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> * q <span class="keyword1"><span class="command">unfolding</span></span> factorize_polys_def <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>Let_def<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> prod.collapse<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> squarefree_factorization_degree<span class="main">[</span><span class="operator">OF</span> factorize_rat_poly_monic_square_free_factorization<span class="main"><span class="main">[</span></span><span class="operator">OF</span> this<span class="main"><span class="main">]</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"degree <span class="skolem">q</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> q <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">have</span></span> deg_q_cons<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">q</span> <span class="main">∈</span>set<span class="main">(</span><span class="free">qs</span><span class="main">)</span><span class="main">.</span> degree <span class="bound">q</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">(</span>consistent_sign_vectors <span class="free">qs</span> UNIV <span class="main">=</span>  <span class="main">{</span><span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">if</span> poly <span class="bound">x</span> <span class="main">0</span> <span class="main">&lt;</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="main">-</span><span class="main">1</span> <span class="keyword1">else</span> <span class="keyword1">if</span> poly <span class="bound">x</span> <span class="main">0</span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="main">0</span> <span class="keyword1">else</span> <span class="main">1</span><span class="main">)</span> <span class="free">qs</span><span class="main">)</span><span class="main">}</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
    <span class="keyword3"><span class="command">assume</span></span> deg_z<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">q</span> <span class="main">∈</span>set<span class="main">(</span><span class="free">qs</span><span class="main">)</span><span class="main">.</span> degree <span class="bound">q</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">q</span> <span class="main">∈</span>set<span class="main">(</span><span class="free">qs</span><span class="main">)</span><span class="main">.</span> <span class="main">∀</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> poly <span class="bound">q</span> <span class="bound">x</span> <span class="main">=</span> poly <span class="bound">q</span> <span class="bound">y</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> constant_def constant_degree<span class="main">)</span> 
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> csv<span class="main">:</span> <span class="quoted"><span class="quoted">"consistent_sign_vectors <span class="free">qs</span> UNIV <span class="main">=</span> <span class="main">{</span>sign_vec <span class="free">qs</span> <span class="main">0</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> consistent_sign_vectors_def sign_vec_def <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span> 
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> deg_z degree_0_id of_rat_hom.map_poly_hom_coeff_lift poly_0_coeff_0 poly_const_conv squash_real_of_rat<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> class_semiring.add.one_closed comp_def image_iff list.map_cong0 of_rat_hom.poly_map_poly_0<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sign_vec <span class="free">qs</span> <span class="main">0</span> <span class="main">=</span> <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">if</span> poly <span class="bound">x</span> <span class="main">0</span> <span class="main">&lt;</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="main">-</span><span class="main">1</span> <span class="keyword1">else</span> <span class="keyword1">if</span> poly <span class="bound">x</span> <span class="main">0</span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="main">0</span> <span class="keyword1">else</span> <span class="main">1</span><span class="main">)</span> <span class="free">qs</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> sign_vec_def squash_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"consistent_sign_vectors <span class="free">qs</span> UNIV <span class="main">=</span>  <span class="main">{</span><span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">if</span> poly <span class="bound">x</span> <span class="main">0</span> <span class="main">&lt;</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="main">-</span><span class="main">1</span> <span class="keyword1">else</span> <span class="keyword1">if</span> poly <span class="bound">x</span> <span class="main">0</span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="main">0</span> <span class="keyword1">else</span> <span class="main">1</span><span class="main">)</span> <span class="free">qs</span><span class="main">)</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> csv <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> deg_q_prop deg_q_cons set_eq
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> empty<span class="main">)</span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="BKR_Decision-main_step_aux2"><span class="command">lemma</span></span> main_step_aux2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">qs</span><span class="main">::</span> <span class="quoted"><span class="quoted">"rat poly list"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> lenh<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>fst<span class="main">(</span>factorize_polys <span class="free">qs</span><span class="main">)</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>find_consistent_signs <span class="free">qs</span><span class="main">)</span> <span class="main">=</span>  consistent_sign_vectors <span class="free">qs</span> UNIV"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?fs</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"fst<span class="main">(</span>factorize_polys <span class="free">qs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?data</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"snd<span class="main">(</span>factorize_polys <span class="free">qs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?sgas</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"find_sgas <span class="main">(</span>map <span class="main">(</span>map_poly of_rat<span class="main">)</span> <span class="var">?fs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> h0<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span><span class="var">?sgas</span><span class="main">)</span> <span class="main">=</span> consistent_sign_vectors <span class="var">?fs</span> UNIV"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> lenh same_sign_cond_rationals_reals coprime_factorize <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> h1<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>map <span class="main">(</span>undo_factorize_polys <span class="var">?data</span><span class="main">)</span> <span class="var">?sgas</span><span class="main">)</span> <span class="main">=</span> consistent_sign_vectors <span class="free">qs</span> UNIV"</span></span>
    <span class="keyword1"><span class="command">using</span></span> factorize_polys_undo_factorize_polys_set
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> lenh <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">smt</span> case_prod_unfold find_consistent_signs_def h1 main_step_aux1<span class="main">)</span> 
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> find_consistent_signs_def prod.case_eq_if<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="BKR_Decision-main_step"><span class="command">lemma</span></span> main_step<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">qs</span><span class="main">::</span> <span class="quoted"><span class="quoted">"rat poly list"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>find_consistent_signs <span class="free">qs</span><span class="main">)</span> <span class="main">=</span>  consistent_sign_vectors <span class="free">qs</span> UNIV"</span></span>
  <span class="keyword1"><span class="command">using</span></span> main_step_aux1 main_step_aux2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Decision Procedure: Main Lemmas"</span></span>

<span class="keyword1" id="BKR_Decision-decide_univ_lem_helper"><span class="command">lemma</span></span> decide_univ_lem_helper<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">fml_struct</span><span class="main">,</span><span class="free">polys</span><span class="main">)</span> <span class="main">=</span> convert <span class="free">fml</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">::</span>real<span class="main">.</span> lookup_sem <span class="free">fml_struct</span> <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> rpoly <span class="bound">p</span> <span class="bound">x</span><span class="main">)</span> <span class="free">polys</span><span class="main">)</span><span class="main">)</span> <span class="main">⟷</span>
    <span class="main">(</span>decide_universal <span class="free">fml</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> universal_lookup_sem main_step <span class="keyword1"><span class="command">unfolding</span></span> decide_universal_def <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> assms convert_closed fst_conv snd_conv<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> assms convert_closed fst_conv snd_conv<span class="main">)</span>

<span class="keyword1" id="BKR_Decision-decide_exis_lem_helper"><span class="command">lemma</span></span> decide_exis_lem_helper<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">fml_struct</span><span class="main">,</span><span class="free">polys</span><span class="main">)</span> <span class="main">=</span> convert <span class="free">fml</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound">x</span><span class="main">::</span>real<span class="main">.</span> lookup_sem <span class="free">fml_struct</span> <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> rpoly <span class="bound">p</span> <span class="bound">x</span><span class="main">)</span> <span class="free">polys</span><span class="main">)</span><span class="main">)</span> <span class="main">⟷</span>
    <span class="main">(</span>decide_existential <span class="free">fml</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> existential_lookup_sem main_step <span class="keyword1"><span class="command">unfolding</span></span> decide_existential_def <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> assms convert_closed fst_conv snd_conv<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> assms convert_closed fst_conv snd_conv<span class="main">)</span>

<span class="keyword1"><span class="command">theorem</span></span> decision_procedure<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">::</span>real<span class="main">.</span> fml_sem <span class="free">fml</span> <span class="bound">x</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span>decide_universal <span class="free">fml</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">x</span><span class="main">::</span>real<span class="main">.</span> fml_sem <span class="free">fml</span> <span class="bound">x</span> <span class="main">⟷</span> <span class="main">(</span>decide_existential <span class="free">fml</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span>  convert_semantics_lem decide_univ_lem_helper <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> convert_semantics<span class="main">)</span>   
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> convert_def convert_semantics fst_conv snd_conv<span class="main">)</span>  
  <span class="keyword1"><span class="command">using</span></span> convert_semantics_lem 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> convert_def convert_semantics decide_exis_lem_helper fst_conv snd_conv<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="Renegar_Algorithm">
<div class="head">
<h1>Theory Renegar_Algorithm</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> Renegar_Algorithm
  <span class="keyword2"><span class="keyword">imports</span></span>  <a href="#BKR_Algorithm">BKR_Algorithm</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="comment1">(* There is significant overlap between Renegar's algorithm and BKR's.  
  However, the RHS vector is constructed differently in Renegar. The base case is also different.
  In general, the _R's on definition and lemma names in this file are to emphasize that we are 
  working with Renegar style.
*)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">construct_NofI_R</span><span class="main">::</span> <span class="quoted"><span class="quoted">"real poly <span class="main">⇒</span> real poly list <span class="main">⇒</span> real poly list <span class="main">⇒</span> rat"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">construct_NofI_R</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">I1</span></span></span> <span class="free"><span class="bound"><span class="entity">I2</span></span></span> <span class="main">=</span> <span class="main">(</span>
    <span class="keyword1">let</span> <span class="bound">new_p</span> <span class="main">=</span> sum_list <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span><span class="main">^</span><span class="numeral">2</span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">I1</span></span></span><span class="main">)</span><span class="main">)</span> <span class="keyword1">in</span>
    rat_of_int <span class="main">(</span>changes_R_smods <span class="bound">new_p</span> <span class="main">(</span><span class="main">(</span>pderiv <span class="bound">new_p</span><span class="main">)</span><span class="main">*</span><span class="main">(</span>prod_list <span class="free"><span class="bound"><span class="entity">I2</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="comment1">(* Renegar's RHS vector will have type (nat list * nat list) list.
   Note the change from BKR, where the RHS vector had type nat list list*)</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">construct_rhs_vector_R</span><span class="main">::</span> <span class="quoted"><span class="quoted">"real poly <span class="main">⇒</span> real poly list <span class="main">⇒</span> <span class="main">(</span>nat list <span class="main">*</span> nat list<span class="main">)</span> list <span class="main">⇒</span> rat vec"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">construct_rhs_vector_R</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">qs</span></span></span> <span class="free"><span class="bound"><span class="entity">Is</span></span></span> <span class="main">=</span>
  vec_of_list <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">I1</span><span class="main">,</span><span class="bound">I2</span><span class="main">)</span><span class="main">.</span>
    <span class="main">(</span>construct_NofI_R <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">(</span>retrieve_polys <span class="free"><span class="bound"><span class="entity">qs</span></span></span> <span class="bound">I1</span><span class="main">)</span> <span class="main">(</span>retrieve_polys <span class="free"><span class="bound"><span class="entity">qs</span></span></span> <span class="bound">I2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">Is</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">"Base Case"</span></span>

<span class="comment1">(* Renegar's matrix is 3x3 instead of 2x2 *)</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">base_case_info_R</span><span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>rat mat <span class="main">×</span> <span class="main">(</span><span class="main">(</span>nat list <span class="main">*</span> nat list<span class="main">)</span> list <span class="main">×</span> rat list list<span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">base_case_info_R</span> <span class="main">=</span>
    <span class="main">(</span><span class="main">(</span>mat_of_rows_list <span class="numeral">3</span> <span class="main">[</span><span class="main">[</span><span class="main">1</span><span class="main">,</span><span class="main">1</span><span class="main">,</span><span class="main">1</span><span class="main">]</span><span class="main">,</span> <span class="main">[</span><span class="main">0</span><span class="main">,</span><span class="main">1</span><span class="main">,</span><span class="main">0</span><span class="main">]</span><span class="main">,</span> <span class="main">[</span><span class="main">1</span><span class="main">,</span><span class="main">0</span><span class="main">,</span><span class="main">-</span><span class="main">1</span><span class="main">]</span><span class="main">]</span><span class="main">)</span><span class="main">,</span><span class="main">(</span><span class="main">[</span><span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span><span class="main">,</span><span class="main">(</span><span class="main">[</span><span class="main">0</span><span class="main">]</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span><span class="main">,</span><span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="main">[</span><span class="main">0</span><span class="main">]</span><span class="main">)</span><span class="main">]</span><span class="main">,</span> <span class="main">[</span><span class="main">[</span><span class="main">1</span><span class="main">]</span><span class="main">,</span><span class="main">[</span><span class="main">0</span><span class="main">]</span><span class="main">,</span><span class="main">[</span><span class="main">-</span><span class="main">1</span><span class="main">]</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="comment1">(* When p, q are coprime, this will actually be an int vec, which is why taking the floor is okay *)</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">base_case_solve_for_lhs</span><span class="main">::</span> <span class="quoted"><span class="quoted">"real poly <span class="main">⇒</span> real poly <span class="main">⇒</span> rat vec"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">base_case_solve_for_lhs</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">=</span> <span class="main">(</span>mult_mat_vec <span class="main">(</span>mat_of_rows_list <span class="numeral">3</span> <span class="main">[</span><span class="main">[</span><span class="main">1</span><span class="main">/</span><span class="numeral">2</span><span class="main">,</span> <span class="main">-</span><span class="main">1</span><span class="main">/</span><span class="numeral">2</span><span class="main">,</span> <span class="main">1</span><span class="main">/</span><span class="numeral">2</span><span class="main">]</span><span class="main">,</span> <span class="main">[</span><span class="main">0</span><span class="main">,</span> <span class="main">1</span><span class="main">,</span> <span class="main">0</span><span class="main">]</span><span class="main">,</span> <span class="main">[</span><span class="main">1</span><span class="main">/</span><span class="numeral">2</span><span class="main">,</span> <span class="main">-</span><span class="main">1</span><span class="main">/</span><span class="numeral">2</span><span class="main">,</span> <span class="main">-</span><span class="main">1</span><span class="main">/</span><span class="numeral">2</span><span class="main">]</span><span class="main">]</span><span class="main">)</span>  <span class="main">(</span>construct_rhs_vector_R <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">]</span> <span class="main">[</span><span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span><span class="main">,</span><span class="main">(</span><span class="main">[</span><span class="main">0</span><span class="main">]</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span><span class="main">,</span><span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="main">[</span><span class="main">0</span><span class="main">]</span><span class="main">)</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="comment1">(* Solve for LHS in general: mat_inverse returns an option type, and we pattern match on this. 
  Notice that when we call this function in the algorithm, the matrix we pass will always be invertible,
  given how the construction works. *)</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">solve_for_lhs_R</span><span class="main">::</span> <span class="quoted"><span class="quoted">"real poly <span class="main">⇒</span> real poly list <span class="main">⇒</span> <span class="main">(</span>nat list <span class="main">*</span> nat list<span class="main">)</span> list <span class="main">⇒</span> rat mat <span class="main">⇒</span> rat vec"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">solve_for_lhs_R</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">qs</span></span></span> <span class="free"><span class="bound"><span class="entity">subsets</span></span></span> <span class="free"><span class="bound"><span class="entity">matr</span></span></span> <span class="main">=</span>
     mult_mat_vec <span class="main">(</span>matr_option <span class="main">(</span>dim_row <span class="free"><span class="bound"><span class="entity">matr</span></span></span><span class="main">)</span> <span class="main">(</span>mat_inverse_var <span class="free"><span class="bound"><span class="entity">matr</span></span></span><span class="main">)</span><span class="main">)</span>  <span class="main">(</span>construct_rhs_vector_R <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">qs</span></span></span> <span class="free"><span class="bound"><span class="entity">subsets</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">"Smashing"</span></span> 

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">subsets_smash_R</span><span class="main">::</span><span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="main">(</span>nat list<span class="main">*</span>nat list<span class="main">)</span> list <span class="main">⇒</span> <span class="main">(</span>nat list<span class="main">*</span>nat list<span class="main">)</span> list <span class="main">⇒</span> <span class="main">(</span>nat list<span class="main">*</span>nat list<span class="main">)</span> list"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">subsets_smash_R</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">s1</span></span></span> <span class="free"><span class="bound"><span class="entity">s2</span></span></span> <span class="main">=</span> concat <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">l1</span><span class="main">.</span> map <span class="main">(</span><span class="main">λ</span> <span class="bound">l2</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="main">(</span>fst <span class="bound">l1</span><span class="main">)</span> <span class="main">@</span> <span class="main">(</span>map <span class="main">(</span><span class="main">(+)</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">(</span>fst <span class="bound">l2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>snd <span class="bound">l1</span><span class="main">)</span> <span class="main">@</span> <span class="main">(</span>map <span class="main">(</span><span class="main">(+)</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">(</span>snd <span class="bound">l2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">s2</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">s1</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">smash_systems_R</span><span class="main">::</span> <span class="quoted"><span class="quoted">"real poly <span class="main">⇒</span> real poly list <span class="main">⇒</span> real poly list <span class="main">⇒</span> <span class="main">(</span>nat list <span class="main">*</span> nat list<span class="main">)</span> list <span class="main">⇒</span> <span class="main">(</span>nat list <span class="main">*</span> nat list<span class="main">)</span> list <span class="main">⇒</span>
  rat list list <span class="main">⇒</span> rat list list <span class="main">⇒</span> rat mat <span class="main">⇒</span> rat mat <span class="main">⇒</span> 
  real poly list <span class="main">×</span> <span class="main">(</span>rat mat <span class="main">×</span> <span class="main">(</span><span class="main">(</span>nat list <span class="main">*</span> nat list<span class="main">)</span> list <span class="main">×</span> rat list list<span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">smash_systems_R</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">qs1</span></span></span> <span class="free"><span class="bound"><span class="entity">qs2</span></span></span> <span class="free"><span class="bound"><span class="entity">subsets1</span></span></span> <span class="free"><span class="bound"><span class="entity">subsets2</span></span></span> <span class="free"><span class="bound"><span class="entity">signs1</span></span></span> <span class="free"><span class="bound"><span class="entity">signs2</span></span></span> <span class="free"><span class="bound"><span class="entity">mat1</span></span></span> <span class="free"><span class="bound"><span class="entity">mat2</span></span></span> <span class="main">=</span>
    <span class="main">(</span><span class="free"><span class="bound"><span class="entity">qs1</span></span></span><span class="main">@</span><span class="free"><span class="bound"><span class="entity">qs2</span></span></span><span class="main">,</span> <span class="main">(</span>kronecker_product <span class="free"><span class="bound"><span class="entity">mat1</span></span></span> <span class="free"><span class="bound"><span class="entity">mat2</span></span></span><span class="main">,</span> <span class="main">(</span>subsets_smash_R <span class="main">(</span>length <span class="free"><span class="bound"><span class="entity">qs1</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">subsets1</span></span></span> <span class="free"><span class="bound"><span class="entity">subsets2</span></span></span><span class="main">,</span> signs_smash <span class="free"><span class="bound"><span class="entity">signs1</span></span></span> <span class="free"><span class="bound"><span class="entity">signs2</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">combine_systems_R</span><span class="main">::</span> <span class="quoted"><span class="quoted">"real poly <span class="main">⇒</span> <span class="main">(</span>real poly list <span class="main">×</span> <span class="main">(</span>rat mat <span class="main">×</span> <span class="main">(</span><span class="main">(</span>nat list <span class="main">*</span> nat list<span class="main">)</span> list <span class="main">×</span> rat list list<span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span>real poly list <span class="main">×</span> <span class="main">(</span>rat mat <span class="main">×</span> <span class="main">(</span><span class="main">(</span>nat list <span class="main">*</span> nat list<span class="main">)</span> list <span class="main">×</span> rat list list<span class="main">)</span><span class="main">)</span><span class="main">)</span>
  <span class="main">⇒</span> <span class="main">(</span>real poly list <span class="main">×</span> <span class="main">(</span>rat mat <span class="main">×</span> <span class="main">(</span><span class="main">(</span>nat list <span class="main">*</span> nat list<span class="main">)</span> list <span class="main">×</span> rat list list<span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">combine_systems_R</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">qs1</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">m1</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">sub1</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">sgn1</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">qs2</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">m2</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">sub2</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">sgn2</span></span></span><span class="main">)</span> <span class="main">=</span> 
    <span class="main">(</span>smash_systems_R <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">qs1</span></span></span> <span class="free"><span class="bound"><span class="entity">qs2</span></span></span> <span class="free"><span class="bound"><span class="entity">sub1</span></span></span> <span class="free"><span class="bound"><span class="entity">sub2</span></span></span> <span class="free"><span class="bound"><span class="entity">sgn1</span></span></span> <span class="free"><span class="bound"><span class="entity">sgn2</span></span></span> <span class="free"><span class="bound"><span class="entity">m1</span></span></span> <span class="free"><span class="bound"><span class="entity">m2</span></span></span><span class="main">)</span>"</span></span>

<span class="comment1">(* Overall:
  Start with a matrix equation.
  Input a matrix, subsets, and signs.
  Drop columns of the matrix based on the 0's on the LHS---so extract a list of 0's. Reduce signs accordingly.
  Then find a list of rows to delete based on using rank (use the transpose result, pivot positions!),
   and delete those rows.  Reduce subsets accordingly.
  End with a reduced system! *)</span>
<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">"Reduction"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">reduction_step_R</span><span class="main">::</span> <span class="quoted"><span class="quoted">"rat mat <span class="main">⇒</span> rat list list <span class="main">⇒</span> <span class="main">(</span>nat list<span class="main">*</span>nat list<span class="main">)</span> list <span class="main">⇒</span> rat vec <span class="main">⇒</span> rat mat <span class="main">×</span> <span class="main">(</span><span class="main">(</span>nat list<span class="main">*</span>nat list<span class="main">)</span> list <span class="main">×</span> rat list list<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">reduction_step_R</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">signs</span></span></span> <span class="free"><span class="bound"><span class="entity">subsets</span></span></span> <span class="free"><span class="bound"><span class="entity">lhs_vec</span></span></span> <span class="main">=</span> 
    <span class="main">(</span><span class="keyword1">let</span> <span class="bound">reduce_cols_A</span> <span class="main">=</span> <span class="main">(</span>reduce_mat_cols <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">lhs_vec</span></span></span><span class="main">)</span><span class="main">;</span>
         <span class="bound">rows_keep</span> <span class="main">=</span> rows_to_keep <span class="bound">reduce_cols_A</span> <span class="keyword1">in</span>
    <span class="main">(</span>take_rows_from_matrix  <span class="bound">reduce_cols_A</span> <span class="bound">rows_keep</span><span class="main">,</span>
      <span class="main">(</span>take_indices <span class="free"><span class="bound"><span class="entity">subsets</span></span></span> <span class="bound">rows_keep</span><span class="main">,</span>
      take_indices <span class="free"><span class="bound"><span class="entity">signs</span></span></span> <span class="main">(</span>find_nonzeros_from_input_vec <span class="free"><span class="bound"><span class="entity">lhs_vec</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">reduce_system_R</span><span class="main">::</span> <span class="quoted"><span class="quoted">"real poly <span class="main">⇒</span> <span class="main">(</span>real poly list <span class="main">×</span> <span class="main">(</span>rat mat <span class="main">×</span> <span class="main">(</span><span class="main">(</span>nat list<span class="main">*</span>nat list<span class="main">)</span> list <span class="main">×</span> rat list list<span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span>rat mat <span class="main">×</span> <span class="main">(</span><span class="main">(</span>nat list<span class="main">*</span>nat list<span class="main">)</span> list <span class="main">×</span> rat list list<span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">reduce_system_R</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">qs</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">subs</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">signs</span></span></span><span class="main">)</span> <span class="main">=</span>
    reduction_step_R <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">signs</span></span></span> <span class="free"><span class="bound"><span class="entity">subs</span></span></span> <span class="main">(</span>solve_for_lhs_R <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">qs</span></span></span> <span class="free"><span class="bound"><span class="entity">subs</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span>"</span></span> 

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">"Overall algorithm "</span></span>
<span class="comment1">(* Find matrix, subsets, signs.
   The "rat mat" in the output is the matrix. The "(nat list*nat list) list" is the list of subsets. 
   The "rat list list" is the list of signs.
*)</span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">calculate_data_R</span><span class="main">::</span> <span class="quoted"><span class="quoted">"real poly <span class="main">⇒</span> real poly list <span class="main">⇒</span>  <span class="main">(</span>rat mat <span class="main">×</span> <span class="main">(</span><span class="main">(</span>nat list<span class="main">*</span>nat list<span class="main">)</span> list <span class="main">×</span> rat list list<span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">calculate_data_R</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">qs</span></span></span> <span class="main">=</span> 
  <span class="main">(</span> <span class="keyword1">let</span> <span class="bound">len</span> <span class="main">=</span> length <span class="free"><span class="bound"><span class="entity">qs</span></span></span> <span class="keyword1">in</span>
    <span class="keyword1">if</span> <span class="bound">len</span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span>
      <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span><span class="bound">b</span><span class="main">,</span><span class="bound">c</span><span class="main">)</span><span class="main">.</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span><span class="bound">b</span><span class="main">,</span>map <span class="main">(</span>drop <span class="main">1</span><span class="main">)</span> <span class="bound">c</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>reduce_system_R <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">(</span><span class="main">[</span><span class="main">1</span><span class="main">]</span><span class="main">,</span>base_case_info_R<span class="main">)</span><span class="main">)</span>
    <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="bound">len</span> <span class="main">≤</span> <span class="main">1</span> <span class="keyword1">then</span> reduce_system_R <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">qs</span></span></span><span class="main">,</span>base_case_info_R<span class="main">)</span>
    <span class="keyword1">else</span>
    <span class="main">(</span><span class="keyword1">let</span> <span class="bound">q1</span> <span class="main">=</span> take <span class="main">(</span><span class="bound">len</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">qs</span></span></span><span class="main">;</span> <span class="bound">left</span> <span class="main">=</span> <span class="free">calculate_data_R</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="bound">q1</span><span class="main">;</span>
         <span class="bound">q2</span> <span class="main">=</span> drop <span class="main">(</span><span class="bound">len</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">qs</span></span></span><span class="main">;</span> <span class="bound">right</span> <span class="main">=</span> <span class="free">calculate_data_R</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="bound">q2</span><span class="main">;</span>
         <span class="bound">comb</span> <span class="main">=</span> combine_systems_R <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">(</span><span class="bound">q1</span><span class="main">,</span><span class="bound">left</span><span class="main">)</span> <span class="main">(</span><span class="bound">q2</span><span class="main">,</span><span class="bound">right</span><span class="main">)</span> <span class="keyword1">in</span>
         reduce_system_R <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="bound">comb</span>
    <span class="main">)</span>
  <span class="main">)</span>"</span></span>

<span class="comment1">(* Extract the list of consistent sign assignments *)</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">find_consistent_signs_at_roots_R</span><span class="main">::</span> <span class="quoted"><span class="quoted">"real poly <span class="main">⇒</span> real poly list <span class="main">⇒</span> rat list list"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">find_consistent_signs_at_roots_R</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">qs</span></span></span> <span class="main">=</span>
  <span class="main">(</span> <span class="keyword1">let</span> <span class="main">(</span><span class="bound">M</span><span class="main">,</span><span class="bound">S</span><span class="main">,</span><span class="bound">Σ</span><span class="main">)</span> <span class="main">=</span> calculate_data_R <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">qs</span></span></span> <span class="keyword1">in</span> <span class="bound">Σ</span> <span class="main">)</span>"</span></span>

<span class="keyword1" id="Renegar_Algorithm-find_consistent_signs_at_roots_thm_R"><span class="command">lemma</span></span> find_consistent_signs_at_roots_thm_R<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"find_consistent_signs_at_roots_R <span class="free">p</span> <span class="free">qs</span> <span class="main">=</span> snd <span class="main">(</span>snd <span class="main">(</span>calculate_data_R <span class="free">p</span> <span class="free">qs</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> case_prod_beta find_consistent_signs_at_roots_R_def<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="Renegar_Proofs">
<div class="head">
<h1>Theory Renegar_Proofs</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> Renegar_Proofs
  <span class="keyword2"><span class="keyword">imports</span></span> <span class="quoted">"<a href="#Renegar_Algorithm">Renegar_Algorithm</a>"</span>
    <span class="quoted">"<a href="#BKR_Proofs">BKR_Proofs</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="comment1">(* Note that there is significant overlap between Renegar and BKR in general, so there is some
  similarity between this file and BKR_Proofs.thy
  The main difference is that the RHS vector in Renegar is different from the RHS vector in BKR 
  In BKR, all of the qs are assumed to be relatively prime to p. Renegar removes this assumption. 

  In general, the _R's on definition and lemma names in this file are to emphasize that we are 
  working with Renegar style.
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">"Tarski Queries Changed"</span></span>

<span class="keyword1" id="Renegar_Proofs-construct_NofI_R_relation"><span class="command">lemma</span></span> construct_NofI_R_relation<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">p</span><span class="main">::</span> <span class="quoted"><span class="quoted">"real poly"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">I1</span><span class="main">::</span> <span class="quoted"><span class="quoted">"real poly list"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">I2</span><span class="main">::</span> <span class="quoted"><span class="quoted">"real poly list"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"construct_NofI_R <span class="free">p</span> <span class="free">I1</span> <span class="free">I2</span> <span class="main">=</span>
    construct_NofI <span class="main">(</span>sum_list <span class="main">(</span>map power2 <span class="main">(</span><span class="free">p</span> <span class="main">#</span> <span class="free">I1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">I2</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> construct_NofI_R_def construct_NofI_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

<span class="keyword1" id="Renegar_Proofs-sum_list_map_power2"><span class="command">lemma</span></span> sum_list_map_power2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sum_list <span class="main">(</span>map power2 <span class="free">ls</span><span class="main">)</span> <span class="main">≥</span> <span class="main">(</span><span class="main">0</span><span class="main">::</span>real poly<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">ls</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Renegar_Proofs-sum_list_map_power2_poly"><span class="command">lemma</span></span> sum_list_map_power2_poly<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"poly <span class="main">(</span>sum_list <span class="main">(</span>map power2 <span class="main">(</span><span class="free">ls</span><span class="main">::</span>real poly list<span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">x</span> <span class="main">≥</span> <span class="main">(</span><span class="main">0</span><span class="main">::</span>real<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">ls</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Renegar_Proofs-construct_NofI_R_prop_helper"><span class="command">lemma</span></span> construct_NofI_R_prop_helper<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">p</span><span class="main">::</span> <span class="quoted"><span class="quoted">"real poly"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">I1</span><span class="main">::</span> <span class="quoted"><span class="quoted">"real poly list"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">I2</span><span class="main">::</span> <span class="quoted"><span class="quoted">"real poly list"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> nonzero<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span><span class="main">≠</span><span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"construct_NofI_R <span class="free">p</span> <span class="free">I1</span> <span class="free">I2</span> <span class="main">=</span>
    rat_of_int <span class="main">(</span>int <span class="main">(</span>card <span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="main">(</span>sum_list <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span><span class="main">^</span><span class="numeral">2</span><span class="main">)</span> <span class="main">(</span><span class="free">p</span> <span class="main">#</span> <span class="free">I1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> poly <span class="main">(</span>prod_list <span class="free">I2</span><span class="main">)</span> <span class="bound">x</span> <span class="main">&gt;</span> <span class="main">0</span><span class="main">}</span><span class="main">)</span> <span class="main">-</span> 
    int <span class="main">(</span>card <span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="main">(</span>sum_list <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span><span class="main">^</span><span class="numeral">2</span><span class="main">)</span> <span class="main">(</span><span class="free">p</span> <span class="main">#</span> <span class="free">I1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span>  <span class="main">∧</span> poly <span class="main">(</span>prod_list <span class="free">I2</span><span class="main">)</span> <span class="bound">x</span> <span class="main">&lt;</span> <span class="main">0</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> construct_NofI_R_relation<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">p</span></span> <span class="quoted"><span class="free">I1</span></span> <span class="quoted"><span class="free">I2</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> construct_NofI_prop<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">I2</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">using</span></span> assms sum_list_map_power2
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> le_add_same_cancel1 power2_less_eq_zero_iff<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Renegar_Proofs-zer_iff"><span class="command">lemma</span></span> zer_iff<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">p</span><span class="main">::</span> <span class="quoted"><span class="quoted">"real poly"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">ls</span><span class="main">::</span> <span class="quoted"><span class="quoted">"real poly list"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"poly <span class="main">(</span>sum_list <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span><span class="main">^</span><span class="numeral">2</span><span class="main">)</span> <span class="free">ls</span><span class="main">)</span><span class="main">)</span> <span class="free">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">i</span> <span class="main">∈</span> set <span class="free">ls</span><span class="main">.</span> poly <span class="bound">i</span> <span class="free">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">ls</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">I1</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> add_nonneg_eq_0_iff<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> zero_le_power2 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">using</span></span> sum_list_map_power2_poly <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">presburger</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Renegar_Proofs-construct_NofI_prop_R"><span class="command">lemma</span></span> construct_NofI_prop_R<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">p</span><span class="main">::</span> <span class="quoted"><span class="quoted">"real poly"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">I1</span><span class="main">::</span> <span class="quoted"><span class="quoted">"real poly list"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">I2</span><span class="main">::</span> <span class="quoted"><span class="quoted">"real poly list"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> nonzero<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span><span class="main">≠</span><span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"construct_NofI_R <span class="free">p</span> <span class="free">I1</span> <span class="free">I2</span> <span class="main">=</span>
    rat_of_int <span class="main">(</span>int <span class="main">(</span>card <span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">q</span> <span class="main">∈</span> set <span class="free">I1</span><span class="main">.</span> poly <span class="bound">q</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span> <span class="main">∧</span> poly <span class="main">(</span>prod_list <span class="free">I2</span><span class="main">)</span> <span class="bound">x</span> <span class="main">&gt;</span> <span class="main">0</span><span class="main">}</span><span class="main">)</span> <span class="main">-</span> 
    int <span class="main">(</span>card <span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span>  <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">q</span> <span class="main">∈</span> set <span class="free">I1</span><span class="main">.</span> poly <span class="bound">q</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span> <span class="main">∧</span> poly <span class="main">(</span>prod_list <span class="free">I2</span><span class="main">)</span> <span class="bound">x</span> <span class="main">&lt;</span> <span class="main">0</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> construct_NofI_R_prop_helper<span class="main">[</span><span class="operator">OF</span> nonzero<span class="main">]</span> 
  <span class="keyword1"><span class="command">using</span></span> zer_iff
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> <span class="main"><span class="main">(</span></span>verit<span class="main"><span class="main">,</span></span> del_insts<span class="main"><span class="main">)</span></span> Collect_cong sum_list_map_power2_poly zero_le_power2 zero_less_power2<span class="main">)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">"Matrix Equation"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">map_sgas</span><span class="main">::</span> <span class="quoted"><span class="quoted">"rat list <span class="main">⇒</span> rat list"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">map_sgas</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">=</span> map <span class="main">(</span><span class="main">λ</span><span class="bound">r</span><span class="main">.</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="bound">r</span><span class="main">^</span><span class="numeral">2</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">z_R</span><span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>nat list<span class="main">*</span>nat list<span class="main">)</span> <span class="main">⇒</span> rat list <span class="main">⇒</span> rat"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">z_R</span> <span class="free"><span class="bound"><span class="entity">index_list</span></span></span> <span class="free"><span class="bound"><span class="entity">sign_asg</span></span></span> <span class="main">≡</span> <span class="main">(</span>prod_list <span class="main">(</span>map <span class="main">(</span>nth <span class="main">(</span>map_sgas <span class="free"><span class="bound"><span class="entity">sign_asg</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>fst<span class="main">(</span><span class="free"><span class="bound"><span class="entity">index_list</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">*</span><span class="main">(</span>prod_list <span class="main">(</span>map <span class="main">(</span>nth <span class="free"><span class="bound"><span class="entity">sign_asg</span></span></span><span class="main">)</span> <span class="main">(</span>snd<span class="main">(</span><span class="free"><span class="bound"><span class="entity">index_list</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">mtx_row_R</span><span class="main">::</span> <span class="quoted"><span class="quoted">"rat list list <span class="main">⇒</span> <span class="main">(</span>nat list <span class="main">*</span> nat list<span class="main">)</span> <span class="main">⇒</span> rat list"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">mtx_row_R</span> <span class="free"><span class="bound"><span class="entity">sign_list</span></span></span> <span class="free"><span class="bound"><span class="entity">index_list</span></span></span> <span class="main">≡</span> <span class="main">(</span>map <span class="main">(</span><span class="main">(</span>z_R <span class="free"><span class="bound"><span class="entity">index_list</span></span></span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">sign_list</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">matrix_A_R</span><span class="main">::</span> <span class="quoted"><span class="quoted">"rat list list <span class="main">⇒</span>  <span class="main">(</span>nat list <span class="main">*</span> nat list<span class="main">)</span> list <span class="main">⇒</span> rat mat"</span></span> 
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">matrix_A_R</span> <span class="free"><span class="bound"><span class="entity">sign_list</span></span></span> <span class="free"><span class="bound"><span class="entity">subset_list</span></span></span> <span class="main">=</span> 
    <span class="main">(</span>mat_of_rows_list <span class="main">(</span>length <span class="free"><span class="bound"><span class="entity">sign_list</span></span></span><span class="main">)</span> <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">i</span> <span class="main">.</span><span class="main">(</span>mtx_row_R <span class="free"><span class="bound"><span class="entity">sign_list</span></span></span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">subset_list</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">all_list_constr_R</span><span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>nat list<span class="main">*</span>nat list<span class="main">)</span> list <span class="main">⇒</span> nat <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">all_list_constr_R</span> <span class="free"><span class="bound"><span class="entity">L</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">.</span> List.member <span class="free"><span class="bound"><span class="entity">L</span></span></span> <span class="bound">x</span> <span class="main">⟶</span> <span class="main">(</span>list_constr <span class="main">(</span>fst <span class="bound">x</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">∧</span> list_constr <span class="main">(</span>snd <span class="bound">x</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">alt_matrix_A_R</span><span class="main">::</span> <span class="quoted"><span class="quoted">"rat list list <span class="main">⇒</span> <span class="main">(</span>nat list<span class="main">*</span>nat list<span class="main">)</span> list <span class="main">⇒</span> rat mat"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">alt_matrix_A_R</span> <span class="free"><span class="bound"><span class="entity">signs</span></span></span> <span class="free"><span class="bound"><span class="entity">subsets</span></span></span> <span class="main">=</span> <span class="main">(</span>mat <span class="main">(</span>length <span class="free"><span class="bound"><span class="entity">subsets</span></span></span><span class="main">)</span> <span class="main">(</span>length <span class="free"><span class="bound"><span class="entity">signs</span></span></span><span class="main">)</span> 
    <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">i</span><span class="main">,</span> <span class="bound">j</span><span class="main">)</span><span class="main">.</span> z_R <span class="main">(</span><span class="free"><span class="bound"><span class="entity">subsets</span></span></span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">signs</span></span></span> <span class="main">!</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Renegar_Proofs-alt_matrix_char_R"><span class="command">lemma</span></span> alt_matrix_char_R<span class="main">:</span> <span class="quoted"><span class="quoted">"alt_matrix_A_R <span class="free">signs</span> <span class="free">subsets</span> <span class="main">=</span> matrix_A_R <span class="free">signs</span> <span class="free">subsets</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
  <span class="keyword1"><span class="command">have</span></span> h0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> length <span class="free">subsets</span> <span class="main">⟹</span>
            <span class="bound">j</span> <span class="main">&lt;</span> length <span class="free">signs</span> <span class="main">⟹</span>
            map <span class="main">(</span><span class="main">λ</span><span class="bound">index_list</span><span class="main">.</span> map <span class="main">(</span>z_R <span class="bound">index_list</span><span class="main">)</span> <span class="free">signs</span><span class="main">)</span> <span class="free">subsets</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">!</span> <span class="bound">j</span> <span class="main">=</span> z_R <span class="main">(</span><span class="free">subsets</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="free">signs</span> <span class="main">!</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">j</span>
    <span class="keyword3"><span class="command">assume</span></span> i_lt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="free">subsets</span>"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> j_lt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> length <span class="free">signs</span>"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">index_list</span><span class="main">.</span> map <span class="main">(</span>z_R <span class="bound">index_list</span><span class="main">)</span> <span class="free">signs</span><span class="main">)</span> <span class="free">subsets</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">j</span> <span class="main">=</span> z_R <span class="main">(</span><span class="free">subsets</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">(</span><span class="free">signs</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
      <span class="keyword1"><span class="command">have</span></span> h0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">index_list</span><span class="main">.</span> map <span class="main">(</span>z_R <span class="bound">index_list</span><span class="main">)</span> <span class="free">signs</span><span class="main">)</span> <span class="free">subsets</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">=</span>  map <span class="main">(</span>z_R <span class="main">(</span><span class="free">subsets</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="free">signs</span>"</span></span> 
        <span class="keyword1"><span class="command">using</span></span> nth_map i_lt
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> nth_map j_lt
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> 
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">have</span></span> h<span class="main">:</span> <span class="quoted"><span class="quoted">" mat <span class="main">(</span>length <span class="free">subsets</span><span class="main">)</span> <span class="main">(</span>length <span class="free">signs</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">i</span><span class="main">,</span> <span class="bound">j</span><span class="main">)</span><span class="main">.</span> z_R <span class="main">(</span><span class="free">subsets</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="free">signs</span> <span class="main">!</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
    mat <span class="main">(</span>length <span class="free">subsets</span><span class="main">)</span> <span class="main">(</span>length <span class="free">signs</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">i</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> map <span class="main">(</span><span class="main">λ</span><span class="bound">index_list</span><span class="main">.</span> map <span class="main">(</span>z_R <span class="bound">index_list</span><span class="main">)</span> <span class="free">signs</span><span class="main">)</span> <span class="free">subsets</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">!</span> <span class="bound">y</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> h0 eq_matI<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> A <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"mat <span class="main">(</span>length <span class="free">subsets</span><span class="main">)</span> <span class="main">(</span>length <span class="free">signs</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">i</span><span class="main">,</span> <span class="bound">j</span><span class="main">)</span><span class="main">.</span> z_R <span class="main">(</span><span class="free">subsets</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="free">signs</span> <span class="main">!</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span>"</span></span><span class="main">,</span>
        <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> B <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"mat <span class="main">(</span>length <span class="free">subsets</span><span class="main">)</span> <span class="main">(</span>length <span class="free">signs</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">i</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> map <span class="main">(</span><span class="main">λ</span><span class="bound">index_list</span><span class="main">.</span> map <span class="main">(</span>z_R <span class="bound">index_list</span><span class="main">)</span> <span class="free">signs</span><span class="main">)</span> <span class="free">subsets</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">!</span> <span class="bound">y</span><span class="main">)</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> alt_matrix_A_R_def matrix_A_R_def mat_of_rows_list_def <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> mtx_row_R_def
    <span class="keyword1"><span class="command">using</span></span> h  <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Renegar_Proofs-subsets_are_rows_R"><span class="command">lemma</span></span> subsets_are_rows_R<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> <span class="main">(</span>length <span class="free">subsets</span><span class="main">)</span><span class="main">.</span> row <span class="main">(</span>alt_matrix_A_R <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span> <span class="bound">i</span>  <span class="main">=</span> vec <span class="main">(</span>length <span class="free">signs</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">j</span><span class="main">.</span> z_R <span class="main">(</span><span class="free">subsets</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="free">signs</span> <span class="main">!</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> row_def <span class="keyword1"><span class="command">unfolding</span></span> alt_matrix_A_R_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Renegar_Proofs-signs_are_cols_R"><span class="command">lemma</span></span> signs_are_cols_R<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> <span class="main">(</span>length <span class="free">signs</span><span class="main">)</span><span class="main">.</span> col <span class="main">(</span>alt_matrix_A_R <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span> <span class="bound">i</span>  <span class="main">=</span> vec <span class="main">(</span>length <span class="free">subsets</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">j</span><span class="main">.</span> z_R <span class="main">(</span><span class="free">subsets</span> <span class="main">!</span> <span class="bound">j</span><span class="main">)</span> <span class="main">(</span><span class="free">signs</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> col_def <span class="keyword1"><span class="command">unfolding</span></span> alt_matrix_A_R_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">consistent_sign_vec</span><span class="main">::</span><span class="quoted"><span class="quoted">"real poly list <span class="main">⇒</span> real <span class="main">⇒</span> rat list"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">consistent_sign_vec</span> <span class="free"><span class="bound"><span class="entity">qs</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">≡</span>
    map <span class="main">(</span><span class="main">λ</span> <span class="bound">q</span><span class="main">.</span> <span class="keyword1">if</span> <span class="main">(</span>poly <span class="bound">q</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">&gt;</span> <span class="main">0</span><span class="main">)</span> <span class="keyword1">then</span> <span class="main">(</span><span class="main">1</span><span class="main">::</span>rat<span class="main">)</span> <span class="keyword1">else</span> <span class="main">(</span><span class="keyword1">if</span> <span class="main">(</span>poly <span class="bound">q</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span> <span class="keyword1">then</span> <span class="main">(</span><span class="main">0</span><span class="main">::</span>rat<span class="main">)</span> <span class="keyword1">else</span> <span class="main">(</span><span class="main">-</span><span class="main">1</span><span class="main">::</span>rat<span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">qs</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">construct_lhs_vector_R</span><span class="main">::</span> <span class="quoted"><span class="quoted">"real poly <span class="main">⇒</span> real poly list <span class="main">⇒</span> rat list list  <span class="main">⇒</span> rat vec"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">construct_lhs_vector_R</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">qs</span></span></span> <span class="free"><span class="bound"><span class="entity">signs</span></span></span> <span class="main">≡</span>                                                           
 vec_of_list <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">w</span><span class="main">.</span>  rat_of_int <span class="main">(</span>int <span class="main">(</span>length <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> <span class="bound">v</span> <span class="main">=</span> <span class="bound">w</span><span class="main">)</span> <span class="main">(</span>map <span class="main">(</span>consistent_sign_vec <span class="free"><span class="bound"><span class="entity">qs</span></span></span><span class="main">)</span> <span class="main">(</span>characterize_root_list_p <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">signs</span></span></span><span class="main">)</span>"</span></span>

<span class="comment1">(* The ith entry of LHS vector is the number of (distinct) real zeros of p where the sign vector of 
   the qs is the ith entry of signs.*)</span>

<span class="comment1">(* Putting all of the pieces of the construction together *)</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">satisfy_equation_R</span><span class="main">::</span> <span class="quoted"><span class="quoted">"real poly <span class="main">⇒</span> real poly list <span class="main">⇒</span> <span class="main">(</span>nat list<span class="main">*</span>nat list<span class="main">)</span> list <span class="main">⇒</span> rat list list <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">satisfy_equation_R</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">qs</span></span></span> <span class="free"><span class="bound"><span class="entity">subset_list</span></span></span> <span class="free"><span class="bound"><span class="entity">sign_list</span></span></span> <span class="main">=</span>
        <span class="main">(</span>mult_mat_vec <span class="main">(</span>matrix_A_R <span class="free"><span class="bound"><span class="entity">sign_list</span></span></span> <span class="free"><span class="bound"><span class="entity">subset_list</span></span></span><span class="main">)</span> <span class="main">(</span>construct_lhs_vector_R <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">qs</span></span></span> <span class="free"><span class="bound"><span class="entity">sign_list</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>construct_rhs_vector_R <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">qs</span></span></span> <span class="free"><span class="bound"><span class="entity">subset_list</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="comment1">(* Recharacterize the LHS vector *)</span>
<span class="keyword1" id="Renegar_Proofs-construct_lhs_vector_clean_R"><span class="command">lemma</span></span> construct_lhs_vector_clean_R<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> length <span class="free">signs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>construct_lhs_vector_R <span class="free">p</span> <span class="free">qs</span> <span class="free">signs</span><span class="main">)</span> <span class="main">$</span> <span class="free">i</span> <span class="main">=</span>
    card <span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> <span class="main">(</span><span class="main">(</span>consistent_sign_vec <span class="free">qs</span> <span class="bound">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>nth <span class="free">signs</span> <span class="free">i</span><span class="main">)</span><span class="main">)</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> poly_roots_finite<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Collect
       <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> <span class="bound">v</span> <span class="main">=</span> <span class="free">signs</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span> <span class="main">∘</span>
        consistent_sign_vec <span class="free">qs</span><span class="main">)</span> <span class="main">∩</span>
      set <span class="main">(</span>sorted_list_of_set
            <span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
    <span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> consistent_sign_vec <span class="free">qs</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">signs</span> <span class="main">!</span> <span class="free">i</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> construct_lhs_vector_R_def vec_of_list_index characterize_root_list_p_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> nth_map<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> distinct_length_filter<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span> 
    <span class="keyword1"><span class="command">using</span></span> eq 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Renegar_Proofs-construct_lhs_vector_cleaner_R"><span class="command">lemma</span></span> construct_lhs_vector_cleaner_R<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>construct_lhs_vector_R <span class="free">p</span> <span class="free">qs</span> <span class="free">signs</span><span class="main">)</span> <span class="main">=</span>
   vec_of_list <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> rat_of_int <span class="main">(</span>card <span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> <span class="main">(</span><span class="main">(</span>consistent_sign_vec <span class="free">qs</span> <span class="bound">x</span><span class="main">)</span> <span class="main">=</span> <span class="bound">s</span><span class="main">)</span><span class="main">}</span><span class="main">)</span><span class="main">)</span> <span class="free">signs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> eq_vecI<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>  construct_lhs_vector_clean_R<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">]</span></span> <span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> vec_of_list_index<span class="main">)</span>
  <span class="keyword1"><span class="command">unfolding</span></span> construct_lhs_vector_R_def
  <span class="keyword1"><span class="command">using</span></span> assms construct_lhs_vector_clean_R construct_lhs_vector_def <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> construct_lhs_vector_R_def<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="comment1">(* Show that because our consistent sign vectors consist of 1, 0's, and -1's, z returns 1, 0, or -1 
  when applied to a consistent sign vector *)</span>
<span class="keyword1" id="Renegar_Proofs-z_signs_R2"><span class="command">lemma</span></span> z_signs_R2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">I</span><span class="main">::</span> <span class="quoted"><span class="quoted">"nat list"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">signs</span><span class="main">::</span> <span class="quoted"><span class="quoted">"rat list"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> lf<span class="main">:</span> <span class="quoted"><span class="quoted">"list_all <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> length <span class="free">signs</span><span class="main">)</span> <span class="free">I</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> la<span class="main">:</span>  <span class="quoted"><span class="quoted">"list_all <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span> <span class="main">=</span> <span class="main">1</span> <span class="main">∨</span> <span class="bound">s</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∨</span> <span class="bound">s</span> <span class="main">=</span> <span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="free">signs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>prod_list <span class="main">(</span>map <span class="main">(</span>nth <span class="free">signs</span><span class="main">)</span> <span class="free">I</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span> <span class="main">∨</span>
  <span class="main">(</span>prod_list <span class="main">(</span>map <span class="main">(</span>nth <span class="free">signs</span><span class="main">)</span> <span class="free">I</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∨</span>
  <span class="main">(</span>prod_list <span class="main">(</span>map <span class="main">(</span>nth <span class="free">signs</span><span class="main">)</span> <span class="free">I</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">-</span><span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">I</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">I</span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> eo<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">signs</span> <span class="main">!</span> <span class="skolem">a</span> <span class="main">=</span> <span class="main">1</span> <span class="main">∨</span> <span class="free">signs</span> <span class="main">!</span> <span class="skolem">a</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∨</span> <span class="free">signs</span> <span class="main">!</span> <span class="skolem">a</span> <span class="main">=</span> <span class="main">-</span><span class="main">1</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> <span class="main"><span class="main">(</span></span>verit<span class="main"><span class="main">,</span></span> del_insts<span class="main"><span class="main">)</span></span> calculation<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> list_all_length list_all_simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"prod_list <span class="main">(</span>map <span class="main">(</span><span class="main">(!)</span> <span class="main">(</span>map_sgas <span class="free">signs</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">a</span> <span class="main">#</span> <span class="skolem">I</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="main">(</span><span class="free">signs</span> <span class="main">!</span> <span class="skolem">a</span><span class="main">)</span><span class="main">^</span><span class="numeral">2</span><span class="main">)</span><span class="main">*</span>prod_list <span class="main">(</span>map <span class="main">(</span><span class="main">(!)</span> <span class="main">(</span>map_sgas <span class="free">signs</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">I</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> map_sgas_def <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> calculation<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> eo
    <span class="keyword1"><span class="command">using</span></span> Cons.hyps calculation<span class="main">(</span>2<span class="main">)</span> la <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Renegar_Proofs-z_signs_R1"><span class="command">lemma</span></span> z_signs_R1<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">I</span><span class="main">::</span> <span class="quoted"><span class="quoted">"nat list"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">signs</span><span class="main">::</span> <span class="quoted"><span class="quoted">"rat list"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> lf<span class="main">:</span> <span class="quoted"><span class="quoted">"list_all <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> length <span class="free">signs</span><span class="main">)</span> <span class="free">I</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> la<span class="main">:</span>  <span class="quoted"><span class="quoted">"list_all <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span> <span class="main">=</span> <span class="main">1</span> <span class="main">∨</span> <span class="bound">s</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∨</span> <span class="bound">s</span> <span class="main">=</span> <span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="free">signs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>prod_list <span class="main">(</span>map <span class="main">(</span>nth <span class="main">(</span>map_sgas <span class="free">signs</span><span class="main">)</span><span class="main">)</span> <span class="free">I</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span> <span class="main">∨</span>
<span class="main">(</span>prod_list <span class="main">(</span>map <span class="main">(</span>nth <span class="main">(</span>map_sgas <span class="free">signs</span><span class="main">)</span><span class="main">)</span> <span class="free">I</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">I</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">I</span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">signs</span> <span class="main">!</span> <span class="skolem">a</span> <span class="main">=</span> <span class="main">1</span> <span class="main">∨</span> <span class="free">signs</span> <span class="main">!</span> <span class="skolem">a</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∨</span> <span class="free">signs</span> <span class="main">!</span> <span class="skolem">a</span> <span class="main">=</span> <span class="main">-</span><span class="main">1</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> <span class="main"><span class="main">(</span></span>verit<span class="main"><span class="main">,</span></span> best<span class="main"><span class="main">)</span></span> calculation<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> list_all_length list_all_simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> eo<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">-</span> <span class="main">(</span><span class="free">signs</span> <span class="main">!</span> <span class="skolem">a</span><span class="main">)</span><span class="main">^</span><span class="numeral">2</span> <span class="main">=</span> <span class="main">1</span> <span class="main">∨</span> <span class="main">1</span> <span class="main">-</span> <span class="main">(</span><span class="free">signs</span> <span class="main">!</span><span class="skolem">a</span><span class="main">)</span><span class="main">^</span><span class="numeral">2</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> cancel_comm_monoid_add_class.diff_cancel diff_zero <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"prod_list <span class="main">(</span>map <span class="main">(</span><span class="main">(!)</span> <span class="main">(</span>map_sgas <span class="free">signs</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">a</span> <span class="main">#</span> <span class="skolem">I</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="main">(</span><span class="free">signs</span> <span class="main">!</span> <span class="skolem">a</span><span class="main">)</span><span class="main">^</span><span class="numeral">2</span><span class="main">)</span><span class="main">*</span>prod_list <span class="main">(</span>map <span class="main">(</span><span class="main">(!)</span> <span class="main">(</span>map_sgas <span class="free">signs</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">I</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> map_sgas_def <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> calculation<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> eo
    <span class="keyword1"><span class="command">using</span></span> Cons.hyps calculation<span class="main">(</span>2<span class="main">)</span> la <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Renegar_Proofs-z_signs_R"><span class="command">lemma</span></span> z_signs_R<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">I</span><span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>nat list <span class="main">*</span> nat list<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">signs</span><span class="main">::</span> <span class="quoted"><span class="quoted">"rat list"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> lf<span class="main">:</span> <span class="quoted"><span class="quoted">"list_all <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> length <span class="free">signs</span><span class="main">)</span> <span class="main">(</span>fst<span class="main">(</span><span class="free">I</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ls<span class="main">:</span> <span class="quoted"><span class="quoted">"list_all <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> length <span class="free">signs</span><span class="main">)</span> <span class="main">(</span>snd<span class="main">(</span><span class="free">I</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> la<span class="main">:</span>  <span class="quoted"><span class="quoted">"list_all <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span> <span class="main">=</span> <span class="main">1</span> <span class="main">∨</span> <span class="bound">s</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∨</span> <span class="bound">s</span> <span class="main">=</span> <span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="free">signs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>z_R <span class="free">I</span> <span class="free">signs</span> <span class="main">=</span> <span class="main">1</span><span class="main">)</span> <span class="main">∨</span> <span class="main">(</span>z_R <span class="free">I</span> <span class="free">signs</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span> <span class="main">∨</span> <span class="main">(</span>z_R <span class="free">I</span> <span class="free">signs</span> <span class="main">=</span> <span class="main">-</span><span class="main">1</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> assms z_signs_R2 z_signs_R1 <span class="keyword1"><span class="command">unfolding</span></span> z_R_def <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> mult_cancel_left1 mult_minus1_right<span class="main">)</span>

<span class="keyword1" id="Renegar_Proofs-z_lemma_R"><span class="command">lemma</span></span> z_lemma_R<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">I</span><span class="main">::</span> <span class="quoted"><span class="quoted">"nat list <span class="main">*</span> nat list"</span></span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">sign</span><span class="main">::</span> <span class="quoted"><span class="quoted">"rat list"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> consistent<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">sign</span> <span class="main">∈</span> set <span class="main">(</span>characterize_consistent_signs_at_roots <span class="free">p</span> <span class="free">qs</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> welldefined1<span class="main">:</span> <span class="quoted"><span class="quoted">"list_constr <span class="main">(</span>fst <span class="free">I</span><span class="main">)</span> <span class="main">(</span>length <span class="free">qs</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> welldefined2<span class="main">:</span> <span class="quoted"><span class="quoted">"list_constr <span class="main">(</span>snd <span class="free">I</span><span class="main">)</span> <span class="main">(</span>length <span class="free">qs</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>z_R <span class="free">I</span> <span class="free">sign</span> <span class="main">=</span> <span class="main">1</span><span class="main">)</span> <span class="main">∨</span> <span class="main">(</span>z_R <span class="free">I</span> <span class="free">sign</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span> <span class="main">∨</span> <span class="main">(</span>z_R <span class="free">I</span> <span class="free">sign</span> <span class="main">=</span> <span class="main">-</span><span class="main">1</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> z_signs_R<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> same<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">sign</span> <span class="main">=</span> length <span class="free">qs</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> consistent
    <span class="keyword1"><span class="command">using</span></span> characterize_consistent_signs_at_roots_def signs_at_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>list_all <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> length <span class="free">sign</span><span class="main">)</span> <span class="main">(</span>fst <span class="free">I</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> welldefined1  
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> list_constr_def characterize_consistent_signs_at_roots_def consistent_sign_vec_copr_def<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>list_all <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> length <span class="free">sign</span><span class="main">)</span> <span class="main">(</span>snd <span class="free">I</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> same welldefined2  
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> list_constr_def characterize_consistent_signs_at_roots_def consistent_sign_vec_copr_def<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"list_all <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span> <span class="main">=</span> <span class="main">1</span> <span class="main">∨</span> <span class="bound">s</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∨</span> <span class="bound">s</span> <span class="main">=</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="free">sign</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> consistent
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> list.pred_map  characterize_consistent_signs_at_roots_def  consistent_sign_vec_def<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> Ball_set
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> list_all_length signs_at_def squash_def<span class="main">)</span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(* Show that all consistent sign vectors on roots of polynomials are in characterize_consistent_signs_at_roots  *)</span>
<span class="keyword1" id="Renegar_Proofs-in_set_R"><span class="command">lemma</span></span> in_set_R<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">p</span><span class="main">::</span> <span class="quoted"><span class="quoted">"real poly"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> nonzero<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span><span class="main">≠</span><span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">qs</span><span class="main">::</span> <span class="quoted"><span class="quoted">"real poly list"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">sign</span><span class="main">::</span> <span class="quoted"><span class="quoted">"rat list"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">x</span><span class="main">::</span> <span class="quoted"><span class="quoted">"real"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> root_p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> sign_fix<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">sign</span> <span class="main">=</span> consistent_sign_vec <span class="free">qs</span> <span class="free">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">sign</span> <span class="main">∈</span> set <span class="main">(</span>characterize_consistent_signs_at_roots <span class="free">p</span> <span class="free">qs</span><span class="main">)</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> h1<span class="main">:</span> <span class="quoted"><span class="quoted">"consistent_sign_vec <span class="free">qs</span> <span class="free">x</span> <span class="main">∈</span>
      set <span class="main">(</span>remdups <span class="main">(</span>map <span class="main">(</span>signs_at <span class="free">qs</span><span class="main">)</span> <span class="main">(</span>sorted_list_of_set <span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">unfolding</span></span> consistent_sign_vec_def signs_at_def squash_def
    <span class="keyword1"><span class="command">using</span></span> root_p nonzero poly_roots_finite set_sorted_list_of_set <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> <span class="main"><span class="main">(</span></span>verit<span class="main"><span class="main">,</span></span> ccfv_SIG<span class="main"><span class="main">)</span></span> Collect_cong comp_def image_eqI map_eq_conv mem_Collect_eq poly_roots_finite set_sorted_list_of_set<span class="main">)</span> 
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> characterize_consistent_signs_at_roots_def characterize_root_list_p_def <span class="keyword1"><span class="command">using</span></span> sign_fix
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Renegar_Proofs-consistent_signs_prop_R"><span class="command">lemma</span></span> consistent_signs_prop_R<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">p</span><span class="main">::</span> <span class="quoted"><span class="quoted">"real poly"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> nonzero<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span><span class="main">≠</span><span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">qs</span><span class="main">::</span> <span class="quoted"><span class="quoted">"real poly list"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">sign</span><span class="main">::</span> <span class="quoted"><span class="quoted">"rat list"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">x</span><span class="main">::</span> <span class="quoted"><span class="quoted">"real"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> root_p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> sign_fix<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">sign</span> <span class="main">=</span> consistent_sign_vec <span class="free">qs</span> <span class="free">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>  <span class="quoted"><span class="quoted">"list_all <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span> <span class="main">=</span> <span class="main">1</span> <span class="main">∨</span> <span class="bound">s</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∨</span> <span class="bound">s</span> <span class="main">=</span> <span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="free">sign</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> consistent_sign_vec_def squash_def <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> <span class="main"><span class="main">(</span></span>z3<span class="main"><span class="main">)</span></span> length_map list_all_length nth_map<span class="main">)</span> 

<span class="comment1">(* The next few lemmas relate z_R to the signs of the product of subsets of polynomials of qs *)</span>
<span class="keyword1" id="Renegar_Proofs-horiz_vector_helper_pos_ind_R1"><span class="command">lemma</span></span> horiz_vector_helper_pos_ind_R1<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">p</span><span class="main">::</span> <span class="quoted"><span class="quoted">"real poly"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> nonzero<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span><span class="main">≠</span><span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">qs</span><span class="main">::</span> <span class="quoted"><span class="quoted">"real poly list"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">I</span><span class="main">::</span> <span class="quoted"><span class="quoted">"nat list"</span></span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">sign</span><span class="main">::</span> <span class="quoted"><span class="quoted">"rat list"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">x</span><span class="main">::</span> <span class="quoted"><span class="quoted">"real"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> root_p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> sign_fix<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">sign</span> <span class="main">=</span> consistent_sign_vec <span class="free">qs</span> <span class="free">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> asm<span class="main">:</span> <span class="quoted"><span class="quoted">"list_constr <span class="free">I</span> <span class="main">(</span>length <span class="free">qs</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>prod_list <span class="main">(</span>map <span class="main">(</span>nth <span class="main">(</span>map_sgas <span class="free">sign</span><span class="main">)</span><span class="main">)</span> <span class="free">I</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span> <span class="main">⟷</span> 
    <span class="main">(</span><span class="main">∀</span><span class="bound">p</span> <span class="main">∈</span> set <span class="main">(</span>retrieve_polys <span class="free">qs</span> <span class="free">I</span><span class="main">)</span><span class="main">.</span> poly <span class="bound">p</span> <span class="free">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> asm
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="quoted">"<span class="free">I</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> map_sgas_def <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> retrieve_polys_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">xa</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> same0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>prod_list <span class="main">(</span>map <span class="main">(</span>nth <span class="main">(</span>map_sgas <span class="free">sign</span><span class="main">)</span><span class="main">)</span> <span class="skolem">xa</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span> <span class="main">⟷</span> 
    <span class="main">(</span><span class="main">∀</span><span class="bound">p</span> <span class="main">∈</span> set <span class="main">(</span>retrieve_polys <span class="free">qs</span> <span class="skolem">xa</span><span class="main">)</span><span class="main">.</span> poly <span class="bound">p</span> <span class="free">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> list_constr_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> welldef<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">&lt;</span> length <span class="free">qs</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Cons.prems assms <span class="keyword1"><span class="command">unfolding</span></span> list_constr_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> h<span class="main">:</span> <span class="quoted"><span class="quoted">"prod_list <span class="main">(</span>map <span class="main">(</span><span class="main">(!)</span> <span class="main">(</span>map_sgas <span class="free">sign</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">a</span><span class="main">#</span><span class="skolem">xa</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="main">(</span><span class="free">sign</span> <span class="main">!</span> <span class="skolem">a</span><span class="main">)</span><span class="main">^</span><span class="numeral">2</span><span class="main">)</span><span class="main">*</span><span class="main">(</span>prod_list <span class="main">(</span>map <span class="main">(</span><span class="main">(!)</span> <span class="main">(</span>map_sgas <span class="free">sign</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">xa</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> map_sgas_def <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> consistent_sign_vec_def length_map nth_map<span class="main">)</span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"list_all <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span> <span class="main">=</span> <span class="main">1</span> <span class="main">∨</span> <span class="bound">s</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∨</span> <span class="bound">s</span> <span class="main">=</span> <span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="free">sign</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> sign_fix <span class="keyword1"><span class="command">unfolding</span></span> consistent_sign_vec_def squash_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> <span class="main"><span class="main">(</span></span>z3<span class="main"><span class="main">)</span></span> length_map list_all_length nth_map<span class="main">)</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> eo<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>prod_list <span class="main">(</span>map <span class="main">(</span><span class="main">(!)</span> <span class="main">(</span>map_sgas <span class="free">sign</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">xa</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∨</span> <span class="main">(</span>prod_list <span class="main">(</span>map <span class="main">(</span><span class="main">(!)</span> <span class="main">(</span>map_sgas <span class="free">sign</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">xa</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> z_signs_R1 assms Cons.prems consistent_sign_vec_def length_map list_all_simps<span class="main">(</span>1<span class="main">)</span> length_map list_all_length list_constr_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> <span class="main"><span class="main">(</span></span>verit<span class="main"><span class="main">,</span></span> best<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">sign</span> <span class="main">!</span> <span class="skolem">a</span><span class="main">)</span><span class="main">^</span><span class="numeral">2</span> <span class="main">=</span> <span class="main">1</span> <span class="main">∨</span> <span class="main">(</span><span class="free">sign</span> <span class="main">!</span> <span class="skolem">a</span><span class="main">)</span><span class="main">^</span><span class="numeral">2</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> sign_fix welldef  <span class="keyword1"><span class="command">unfolding</span></span> consistent_sign_vec_def 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> s1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>prod_list <span class="main">(</span>map <span class="main">(</span>nth <span class="main">(</span>map_sgas <span class="free">sign</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">a</span><span class="main">#</span><span class="skolem">xa</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span> <span class="main">⟷</span> 
    <span class="main">(</span><span class="main">(</span><span class="free">sign</span> <span class="main">!</span> <span class="skolem">a</span><span class="main">)</span><span class="main">^</span><span class="numeral">2</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> <span class="main">(</span>prod_list <span class="main">(</span>map <span class="main">(</span><span class="main">(!)</span> <span class="main">(</span>map_sgas <span class="free">sign</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">xa</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> eo h
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> hide_lams<span class="main"><span class="main">)</span></span> cancel_comm_monoid_add_class.diff_cancel diff_zero mult.left_neutral mult_zero_left<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">sign</span> <span class="main">!</span> <span class="skolem">a</span><span class="main">)</span><span class="main">^</span><span class="numeral">2</span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟷</span> <span class="main">(</span>poly <span class="main">(</span><span class="free">qs</span> <span class="main">!</span> <span class="skolem">a</span><span class="main">)</span> <span class="free">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> sign_fix <span class="keyword1"><span class="command">unfolding</span></span> consistent_sign_vec_def welldef <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">smt</span> <span class="main"><span class="main">(</span></span>z3<span class="main"><span class="main">)</span></span> class_field.neg_1_not_0 class_field.zero_not_one nth_map welldef<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> <span class="main"><span class="main">(</span></span>z3<span class="main"><span class="main">)</span></span> nth_map welldef<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> same1<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">(</span>prod_list <span class="main">(</span>map <span class="main">(</span>nth <span class="main">(</span>map_sgas <span class="free">sign</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">a</span><span class="main">#</span><span class="skolem">xa</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span> <span class="main">⟷</span> 
    <span class="main">(</span><span class="main">(</span>poly <span class="main">(</span><span class="free">qs</span> <span class="main">!</span> <span class="skolem">a</span><span class="main">)</span> <span class="free">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span>prod_list <span class="main">(</span>map <span class="main">(</span><span class="main">(!)</span> <span class="main">(</span>map_sgas <span class="free">sign</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">xa</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> s1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>retrieve_polys <span class="free">qs</span> <span class="main">(</span><span class="skolem">a</span><span class="main">#</span><span class="skolem">xa</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="main">(</span><span class="free">qs</span> <span class="main">!</span> <span class="skolem">a</span><span class="main">)</span><span class="main">}</span> <span class="main">∪</span> set <span class="main">(</span>retrieve_polys <span class="free">qs</span> <span class="skolem">xa</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> insert_is_Un list.simps<span class="main"><span class="main">(</span></span>15<span class="main"><span class="main">)</span></span> list.simps<span class="main"><span class="main">(</span></span>9<span class="main"><span class="main">)</span></span> retrieve_polys_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> same2<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">p</span> <span class="main">∈</span> set <span class="main">(</span>retrieve_polys <span class="free">qs</span> <span class="main">(</span><span class="skolem">a</span><span class="main">#</span><span class="skolem">xa</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> poly <span class="bound">p</span> <span class="free">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span>poly <span class="main">(</span><span class="free">qs</span> <span class="main">!</span> <span class="skolem">a</span><span class="main">)</span> <span class="free">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span>
      <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">p</span> <span class="main">∈</span> set <span class="main">(</span>retrieve_polys <span class="free">qs</span> <span class="main">(</span><span class="skolem">xa</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> poly <span class="bound">p</span> <span class="free">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> same0 same1 same2 
      assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Renegar_Proofs-csv_length_same_as_qlist"><span class="command">lemma</span></span> csv_length_same_as_qlist<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">p</span><span class="main">::</span> <span class="quoted"><span class="quoted">"real poly"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> nonzero<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span><span class="main">≠</span><span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">qs</span><span class="main">::</span> <span class="quoted"><span class="quoted">"real poly list"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">sign</span><span class="main">::</span> <span class="quoted"><span class="quoted">"rat list"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">x</span><span class="main">::</span> <span class="quoted"><span class="quoted">"real"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> root_p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> sign_fix<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">sign</span> <span class="main">=</span> consistent_sign_vec <span class="free">qs</span> <span class="free">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"length <span class="free">sign</span> <span class="main">=</span> length <span class="free">qs</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> consistent_sign_vec_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Renegar_Proofs-horiz_vector_helper_zer_ind_R2"><span class="command">lemma</span></span> horiz_vector_helper_zer_ind_R2<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">p</span><span class="main">::</span> <span class="quoted"><span class="quoted">"real poly"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> nonzero<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span><span class="main">≠</span><span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">qs</span><span class="main">::</span> <span class="quoted"><span class="quoted">"real poly list"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">I</span><span class="main">::</span> <span class="quoted"><span class="quoted">"nat list"</span></span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">sign</span><span class="main">::</span> <span class="quoted"><span class="quoted">"rat list"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">x</span><span class="main">::</span> <span class="quoted"><span class="quoted">"real"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> root_p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> sign_fix<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">sign</span> <span class="main">=</span> consistent_sign_vec <span class="free">qs</span> <span class="free">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> asm<span class="main">:</span> <span class="quoted"><span class="quoted">"list_constr <span class="free">I</span> <span class="main">(</span>length <span class="free">qs</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>prod_list <span class="main">(</span>map <span class="main">(</span>nth <span class="free">sign</span><span class="main">)</span> <span class="free">I</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟷</span> 
    <span class="main">(</span>poly <span class="main">(</span>prod_list <span class="main">(</span>retrieve_polys <span class="free">qs</span> <span class="free">I</span><span class="main">)</span><span class="main">)</span> <span class="free">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> asm
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="quoted">"<span class="free">I</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> map_sgas_def <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> retrieve_polys_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">xa</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"poly <span class="main">(</span>prod_list <span class="main">(</span>retrieve_polys <span class="free">qs</span> <span class="main">(</span><span class="skolem">a</span> <span class="main">#</span> <span class="skolem">xa</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">x</span> <span class="main">=</span> <span class="main">(</span>poly <span class="main">(</span><span class="free">qs</span> <span class="main">!</span> <span class="skolem">a</span><span class="main">)</span> <span class="free">x</span><span class="main">)</span><span class="main">*</span>poly <span class="main">(</span>prod_list <span class="main">(</span>retrieve_polys <span class="free">qs</span> <span class="main">(</span><span class="skolem">xa</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">x</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> retrieve_polys_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> Cons.prems
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> <span class="main"><span class="main">(</span></span>z3<span class="main"><span class="main">)</span></span> Cons.IH class_field.neg_1_not_0 class_field.zero_not_one consistent_sign_vec_def list.simps<span class="main"><span class="main">(</span></span>9<span class="main"><span class="main">)</span></span> list_all_simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> list_constr_def mult_eq_0_iff nth_map prod_list.Cons sign_fix<span class="main">)</span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Renegar_Proofs-horiz_vector_helper_pos_ind_R2"><span class="command">lemma</span></span> horiz_vector_helper_pos_ind_R2<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">p</span><span class="main">::</span> <span class="quoted"><span class="quoted">"real poly"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> nonzero<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span><span class="main">≠</span><span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">qs</span><span class="main">::</span> <span class="quoted"><span class="quoted">"real poly list"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">I</span><span class="main">::</span> <span class="quoted"><span class="quoted">"nat list"</span></span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">sign</span><span class="main">::</span> <span class="quoted"><span class="quoted">"rat list"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">x</span><span class="main">::</span> <span class="quoted"><span class="quoted">"real"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> root_p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> sign_fix<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">sign</span> <span class="main">=</span> consistent_sign_vec <span class="free">qs</span> <span class="free">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> asm<span class="main">:</span> <span class="quoted"><span class="quoted">"list_constr <span class="free">I</span> <span class="main">(</span>length <span class="free">qs</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>prod_list <span class="main">(</span>map <span class="main">(</span>nth <span class="free">sign</span><span class="main">)</span> <span class="free">I</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span> <span class="main">⟷</span> 
    <span class="main">(</span>poly <span class="main">(</span>prod_list <span class="main">(</span>retrieve_polys <span class="free">qs</span> <span class="free">I</span><span class="main">)</span><span class="main">)</span> <span class="free">x</span> <span class="main">&gt;</span> <span class="main">0</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> asm
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="quoted">"<span class="free">I</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> map_sgas_def <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> retrieve_polys_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">xa</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> ih<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>prod_list <span class="main">(</span>map <span class="main">(</span><span class="main">(!)</span> <span class="free">sign</span><span class="main">)</span> <span class="skolem">xa</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">0</span> <span class="main">&lt;</span> poly <span class="main">(</span>prod_list <span class="main">(</span>retrieve_polys <span class="free">qs</span> <span class="skolem">xa</span><span class="main">)</span><span class="main">)</span> <span class="free">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> list_constr_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> lensame<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">sign</span> <span class="main">=</span> length <span class="free">qs</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> sign_fix csv_length_same_as_qlist<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">p</span></span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">sign</span></span> <span class="quoted"><span class="free">qs</span></span><span class="main">]</span>
      nonzero root_p <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"poly <span class="main">(</span>prod_list <span class="main">(</span>retrieve_polys <span class="free">qs</span> <span class="main">(</span><span class="skolem">a</span> <span class="main">#</span> <span class="skolem">xa</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">x</span> <span class="main">=</span> <span class="main">(</span>poly <span class="main">(</span><span class="free">qs</span> <span class="main">!</span> <span class="skolem">a</span><span class="main">)</span> <span class="free">x</span><span class="main">)</span><span class="main">*</span>poly <span class="main">(</span>prod_list <span class="main">(</span>retrieve_polys <span class="free">qs</span> <span class="main">(</span><span class="skolem">xa</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">x</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> retrieve_polys_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> iff1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>poly <span class="main">(</span>prod_list <span class="main">(</span>retrieve_polys <span class="free">qs</span> <span class="main">(</span><span class="skolem">a</span><span class="main">#</span><span class="skolem">xa</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">x</span> <span class="main">&gt;</span> <span class="main">0</span><span class="main">)</span> <span class="main">⟷</span> 
      <span class="main">(</span><span class="main">(</span><span class="main">(</span>poly <span class="main">(</span><span class="free">qs</span> <span class="main">!</span> <span class="skolem">a</span><span class="main">)</span> <span class="free">x</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">∧</span> poly <span class="main">(</span>prod_list <span class="main">(</span>retrieve_polys <span class="free">qs</span> <span class="main">(</span><span class="skolem">xa</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">x</span> <span class="main">&gt;</span> <span class="main">0</span><span class="main">)</span> <span class="main">∨</span> 
       <span class="main">(</span><span class="main">(</span>poly <span class="main">(</span><span class="free">qs</span> <span class="main">!</span> <span class="skolem">a</span><span class="main">)</span> <span class="free">x</span><span class="main">)</span> <span class="main">&lt;</span> <span class="main">0</span> <span class="main">∧</span> poly <span class="main">(</span>prod_list <span class="main">(</span>retrieve_polys <span class="free">qs</span> <span class="main">(</span><span class="skolem">xa</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">x</span> <span class="main">&lt;</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> zero_less_mult_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> prodsame<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>prod_list <span class="main">(</span>map <span class="main">(</span>nth <span class="free">sign</span><span class="main">)</span> <span class="main">(</span><span class="skolem">a</span><span class="main">#</span><span class="skolem">xa</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">sign</span> <span class="main">!</span> <span class="skolem">a</span><span class="main">)</span><span class="main">*</span> <span class="main">(</span>prod_list <span class="main">(</span>map <span class="main">(</span>nth <span class="free">sign</span><span class="main">)</span> <span class="main">(</span><span class="skolem">xa</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> lensame Cons.prems <span class="keyword1"><span class="command">unfolding</span></span> list_constr_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> sagt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">sign</span> <span class="main">!</span> <span class="skolem">a</span> <span class="main">=</span> <span class="main">1</span> <span class="main">⟷</span> <span class="main">(</span>poly <span class="main">(</span><span class="free">qs</span> <span class="main">!</span> <span class="skolem">a</span><span class="main">)</span> <span class="free">x</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> consistent_sign_vec_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">smt</span> <span class="main"><span class="main">(</span></span>verit<span class="main"><span class="main">,</span></span> best<span class="main"><span class="main">)</span></span> Cons.prems list_all_simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> list_constr_def neg_equal_zero nth_map zero_neq_one<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> <span class="main"><span class="main">(</span></span>verit<span class="main"><span class="main">,</span></span> ccfv_threshold<span class="main"><span class="main">)</span></span> Cons.prems list_all_simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> list_constr_def nth_map<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> salt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">sign</span> <span class="main">!</span> <span class="skolem">a</span> <span class="main">=</span> <span class="main">-</span><span class="main">1</span> <span class="main">⟷</span> <span class="main">(</span>poly <span class="main">(</span><span class="free">qs</span> <span class="main">!</span> <span class="skolem">a</span><span class="main">)</span> <span class="free">x</span><span class="main">)</span> <span class="main">&lt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> consistent_sign_vec_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">smt</span> <span class="main"><span class="main">(</span></span>verit<span class="main"><span class="main">,</span></span> ccfv_SIG<span class="main"><span class="main">)</span></span> Cons.prems less_minus_one_simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> less_minus_one_simps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> list_all_simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> list_constr_def neg_0_less_iff_less nth_map<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> <span class="main"><span class="main">(</span></span>verit<span class="main"><span class="main">,</span></span> best<span class="main"><span class="main">)</span></span> Cons.prems list_all_simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> list_constr_def nth_map<span class="main">)</span>  
  <span class="keyword1"><span class="command">have</span></span> h1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span>poly <span class="main">(</span><span class="free">qs</span> <span class="main">!</span> <span class="skolem">a</span><span class="main">)</span> <span class="free">x</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">∧</span> poly <span class="main">(</span>prod_list <span class="main">(</span>retrieve_polys <span class="free">qs</span> <span class="main">(</span><span class="skolem">xa</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">x</span> <span class="main">&gt;</span> <span class="main">0</span><span class="main">)</span> <span class="main">⟶</span>
       <span class="main">(</span>prod_list <span class="main">(</span>map <span class="main">(</span>nth <span class="free">sign</span><span class="main">)</span> <span class="main">(</span><span class="skolem">a</span><span class="main">#</span><span class="skolem">xa</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> prodsame sagt ih <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> eo<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>prod_list <span class="main">(</span>map <span class="main">(</span><span class="main">(!)</span> <span class="free">sign</span><span class="main">)</span> <span class="skolem">xa</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span><span class="main">)</span>  <span class="main">∨</span> <span class="main">(</span>prod_list <span class="main">(</span>map <span class="main">(</span><span class="main">(!)</span> <span class="free">sign</span><span class="main">)</span> <span class="skolem">xa</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span> <span class="main">∨</span> 
      <span class="main">(</span>prod_list <span class="main">(</span>map <span class="main">(</span><span class="main">(!)</span> <span class="free">sign</span><span class="main">)</span> <span class="skolem">xa</span><span class="main">)</span> <span class="main">=</span> <span class="main">-</span><span class="main">1</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Cons.prems consistent_signs_prop_R lensame list_constr_def nonzero root_p sign_fix z_signs_R2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> d1<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">(</span>prod_list <span class="main">(</span>map <span class="main">(</span><span class="main">(!)</span> <span class="free">sign</span><span class="main">)</span> <span class="skolem">xa</span><span class="main">)</span> <span class="main">=</span> <span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">0</span> <span class="main">&gt;</span> poly <span class="main">(</span>prod_list <span class="main">(</span>retrieve_polys <span class="free">qs</span> <span class="skolem">xa</span><span class="main">)</span><span class="main">)</span> <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>prod_list <span class="main">(</span>map <span class="main">(</span><span class="main">(!)</span> <span class="free">sign</span><span class="main">)</span> <span class="skolem">xa</span><span class="main">)</span> <span class="main">=</span> <span class="main">-</span><span class="main">1</span><span class="main">)</span> "</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">0</span> <span class="main">&gt;</span> poly <span class="main">(</span>prod_list <span class="main">(</span>retrieve_polys <span class="free">qs</span> <span class="skolem">xa</span><span class="main">)</span><span class="main">)</span> <span class="free">x</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> prodsame salt ih assms Cons.prems class_field.neg_1_not_0 equal_neg_zero horiz_vector_helper_zer_ind_R2 linorder_neqE_linordered_idom list_all_simps<span class="main">(</span>1<span class="main">)</span> list_constr_def
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">smt</span> <span class="main"><span class="main">(</span></span>verit<span class="main"><span class="main">,</span></span> ccfv_threshold<span class="main"><span class="main">)</span></span> class_field.neg_1_not_0 list.set_map list_all_length semidom_class.prod_list_zero_iff<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> <span class="main"><span class="main">(</span></span>verit<span class="main"><span class="main">,</span></span> ccfv_threshold<span class="main"><span class="main">)</span></span> class_field.neg_1_not_0 list.set_map list_all_length semidom_class.prod_list_zero_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">have</span></span> d2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">0</span> <span class="main">&gt;</span> poly <span class="main">(</span>prod_list <span class="main">(</span>retrieve_polys <span class="free">qs</span> <span class="skolem">xa</span><span class="main">)</span><span class="main">)</span> <span class="free">x</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">(</span>prod_list <span class="main">(</span>map <span class="main">(</span><span class="main">(!)</span> <span class="free">sign</span><span class="main">)</span> <span class="skolem">xa</span><span class="main">)</span> <span class="main">=</span> <span class="main">-</span><span class="main">1</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> eo assms horiz_vector_helper_zer_ind_R2<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> p <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span>"</span></span><span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span>"</span></span><span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> sign <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="free">sign</span>"</span></span><span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> I <span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="free">I</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> ih <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> Cons.prems class_field.neg_1_not_0 horiz_vector_helper_zer_ind_R2 ih imageI list.set_map list_all_simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> list_constr_def mem_Collect_eq neg_equal_0_iff_equal semidom_class.prod_list_zero_iff<span class="main">)</span>  
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>prod_list <span class="main">(</span>map <span class="main">(</span><span class="main">(!)</span> <span class="free">sign</span><span class="main">)</span> <span class="skolem">xa</span><span class="main">)</span> <span class="main">=</span> <span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">0</span> <span class="main">&gt;</span> poly <span class="main">(</span>prod_list <span class="main">(</span>retrieve_polys <span class="free">qs</span> <span class="skolem">xa</span><span class="main">)</span><span class="main">)</span> <span class="free">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> d1 d2
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>       
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> h2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span>poly <span class="main">(</span><span class="free">qs</span> <span class="main">!</span> <span class="skolem">a</span><span class="main">)</span> <span class="free">x</span><span class="main">)</span> <span class="main">&lt;</span> <span class="main">0</span> <span class="main">∧</span> poly <span class="main">(</span>prod_list <span class="main">(</span>retrieve_polys <span class="free">qs</span> <span class="main">(</span><span class="skolem">xa</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">x</span> <span class="main">&lt;</span> <span class="main">0</span><span class="main">)</span> <span class="main">⟶</span>
      <span class="main">(</span>prod_list <span class="main">(</span>map <span class="main">(</span>nth <span class="free">sign</span><span class="main">)</span> <span class="main">(</span><span class="skolem">a</span><span class="main">#</span><span class="skolem">xa</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> prodsame salt ih <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> h3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>prod_list <span class="main">(</span>map <span class="main">(</span>nth <span class="free">sign</span><span class="main">)</span> <span class="main">(</span><span class="skolem">a</span><span class="main">#</span><span class="skolem">xa</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">(</span><span class="main">(</span>poly <span class="main">(</span><span class="free">qs</span> <span class="main">!</span> <span class="skolem">a</span><span class="main">)</span> <span class="free">x</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">∧</span> poly <span class="main">(</span>prod_list <span class="main">(</span>retrieve_polys <span class="free">qs</span> <span class="main">(</span><span class="skolem">xa</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">x</span> <span class="main">&gt;</span> <span class="main">0</span><span class="main">)</span> <span class="main">∨</span> 
       <span class="main">(</span><span class="main">(</span>poly <span class="main">(</span><span class="free">qs</span> <span class="main">!</span> <span class="skolem">a</span><span class="main">)</span> <span class="free">x</span><span class="main">)</span> <span class="main">&lt;</span> <span class="main">0</span> <span class="main">∧</span> poly <span class="main">(</span>prod_list <span class="main">(</span>retrieve_polys <span class="free">qs</span> <span class="main">(</span><span class="skolem">xa</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">x</span> <span class="main">&lt;</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> prodsame salt ih assms horiz_vector_helper_zer_ind_R2<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> p <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span>"</span></span><span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span>"</span></span><span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> sign <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="free">sign</span>"</span></span><span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> I <span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="free">I</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> <span class="main"><span class="main">(</span></span>verit<span class="main"><span class="main">,</span></span> ccfv_threshold<span class="main"><span class="main">)</span></span> Cons.prems <span class="quoted"><span class="quoted">‹poly <span class="main">(</span>prod_list <span class="main">(</span>retrieve_polys <span class="free">qs</span> <span class="main">(</span><span class="skolem">a</span> <span class="main">#</span> <span class="skolem">xa</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">x</span> <span class="main">=</span> poly <span class="main">(</span><span class="free">qs</span> <span class="main">!</span> <span class="skolem">a</span><span class="main">)</span> <span class="free">x</span> <span class="main">*</span> poly <span class="main">(</span>prod_list <span class="main">(</span>retrieve_polys <span class="free">qs</span> <span class="skolem">xa</span><span class="main">)</span><span class="main">)</span> <span class="free">x</span>›</span></span> horiz_vector_helper_zer_ind_R2 mem_Collect_eq mult_cancel_left1 mult_not_zero sagt<span class="main">)</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> h1 h2 h3 iff1 Cons.prems <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Renegar_Proofs-horiz_vector_helper_pos_ind_R"><span class="command">lemma</span></span> horiz_vector_helper_pos_ind_R<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">p</span><span class="main">::</span> <span class="quoted"><span class="quoted">"real poly"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> nonzero<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span><span class="main">≠</span><span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">qs</span><span class="main">::</span> <span class="quoted"><span class="quoted">"real poly list"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">I</span><span class="main">::</span> <span class="quoted"><span class="quoted">"nat list <span class="main">*</span> nat list"</span></span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">sign</span><span class="main">::</span> <span class="quoted"><span class="quoted">"rat list"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">x</span><span class="main">::</span> <span class="quoted"><span class="quoted">"real"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> root_p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> sign_fix<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">sign</span> <span class="main">=</span> consistent_sign_vec <span class="free">qs</span> <span class="free">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> asm1<span class="main">:</span> <span class="quoted"><span class="quoted">"list_constr <span class="main">(</span>fst <span class="free">I</span><span class="main">)</span> <span class="main">(</span>length <span class="free">qs</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> asm2<span class="main">:</span> <span class="quoted"><span class="quoted">"list_constr <span class="main">(</span>snd <span class="free">I</span><span class="main">)</span> <span class="main">(</span>length <span class="free">qs</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">∀</span><span class="bound">p</span> <span class="main">∈</span> set <span class="main">(</span>retrieve_polys <span class="free">qs</span> <span class="main">(</span>fst <span class="free">I</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> poly <span class="bound">p</span> <span class="free">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span>poly <span class="main">(</span>prod_list <span class="main">(</span>retrieve_polys <span class="free">qs</span> <span class="main">(</span>snd <span class="free">I</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">x</span> <span class="main">&gt;</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span>z_R <span class="free">I</span> <span class="free">sign</span> <span class="main">=</span> <span class="main">1</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
  <span class="keyword1"><span class="command">have</span></span> len<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">sign</span> <span class="main">=</span> length <span class="free">qs</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> sign_fix csv_length_same_as_qlist<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">p</span></span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">sign</span></span> <span class="quoted"><span class="free">qs</span></span><span class="main">]</span>
      nonzero root_p <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> d1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">∀</span><span class="bound">p</span> <span class="main">∈</span> set <span class="main">(</span>retrieve_polys <span class="free">qs</span> <span class="main">(</span>fst <span class="free">I</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> poly <span class="bound">p</span> <span class="free">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span>poly <span class="main">(</span>prod_list <span class="main">(</span>retrieve_polys <span class="free">qs</span> <span class="main">(</span>snd <span class="free">I</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">x</span> <span class="main">&gt;</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">(</span>z_R <span class="free">I</span> <span class="free">sign</span> <span class="main">=</span> <span class="main">1</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> assms horiz_vector_helper_pos_ind_R1<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> p <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span>"</span></span><span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> qs <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="free">qs</span>"</span></span><span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> sign <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="free">sign</span>"</span></span><span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span>"</span></span><span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> I <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"fst <span class="free">I</span>"</span></span><span class="main">]</span>
      horiz_vector_helper_pos_ind_R2<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> p <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span>"</span></span><span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> qs <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="free">qs</span>"</span></span><span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> sign <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="free">sign</span>"</span></span><span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span>"</span></span><span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> I <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"snd <span class="free">I</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> z_R_def 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> d2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>z_R <span class="free">I</span> <span class="free">sign</span> <span class="main">=</span> <span class="main">1</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">(</span><span class="main">∀</span><span class="bound">p</span> <span class="main">∈</span> set <span class="main">(</span>retrieve_polys <span class="free">qs</span> <span class="main">(</span>fst <span class="free">I</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> poly <span class="bound">p</span> <span class="free">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span>poly <span class="main">(</span>prod_list <span class="main">(</span>retrieve_polys <span class="free">qs</span> <span class="main">(</span>snd <span class="free">I</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">x</span> <span class="main">&gt;</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
    <span class="keyword1"><span class="command">have</span></span> h1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>z_R <span class="free">I</span> <span class="free">sign</span> <span class="main">=</span> <span class="main">1</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∀</span><span class="bound">p</span> <span class="main">∈</span> set <span class="main">(</span>retrieve_polys <span class="free">qs</span> <span class="main">(</span>fst <span class="free">I</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> poly <span class="bound">p</span> <span class="free">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>prod_list <span class="main">(</span>map <span class="main">(</span>nth <span class="main">(</span>map_sgas <span class="free">sign</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>fst <span class="free">I</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span> <span class="main">∨</span> <span class="main">(</span>prod_list <span class="main">(</span>map <span class="main">(</span>nth <span class="main">(</span>map_sgas <span class="free">sign</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>fst <span class="free">I</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span> 
        <span class="keyword1"><span class="command">using</span></span> len consistent_signs_prop_R<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> p <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span>"</span></span><span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> qs <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="free">qs</span>"</span></span><span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span>"</span></span><span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> sign <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="free">sign</span>"</span></span><span class="main">]</span> z_signs_R1<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> signs <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="free">sign</span>"</span></span><span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> I <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"fst <span class="free">I</span>"</span></span><span class="main">]</span> assms 
        <span class="keyword1"><span class="command">unfolding</span></span> list_constr_def 
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> z_signs_R1<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> signs <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="free">sign</span>"</span></span><span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> I <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"fst <span class="free">I</span>"</span></span><span class="main">]</span> horiz_vector_helper_pos_ind_R1<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> sign <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="free">sign</span>"</span></span><span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> I <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"fst <span class="free">I</span>"</span></span><span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> p <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span>"</span></span><span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span>"</span></span><span class="main">]</span> assms 
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> hide_lams<span class="main"><span class="main">)</span></span> <span class="quoted"><span class="quoted">‹prod_list <span class="main">(</span>map <span class="main">(</span><span class="main">(!)</span> <span class="main">(</span>map_sgas <span class="free">sign</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>fst <span class="free">I</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span> <span class="main">∨</span> prod_list <span class="main">(</span>map <span class="main">(</span><span class="main">(!)</span> <span class="main">(</span>map_sgas <span class="free">sign</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>fst <span class="free">I</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>›</span></span> mult_zero_left z_R_def<span class="main">)</span> 
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> h2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>z_R <span class="free">I</span> <span class="free">sign</span> <span class="main">=</span> <span class="main">1</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">(</span>poly <span class="main">(</span>prod_list <span class="main">(</span>retrieve_polys <span class="free">qs</span> <span class="main">(</span>snd <span class="free">I</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">x</span> <span class="main">&gt;</span> <span class="main">0</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">unfolding</span></span> z_R_def <span class="keyword1"><span class="command">using</span></span> assms horiz_vector_helper_pos_ind_R2<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> p <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span>"</span></span><span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span>"</span></span><span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> sign <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="free">sign</span>"</span></span><span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> qs <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="free">qs</span>"</span></span><span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> I <span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"snd <span class="free">I</span>"</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> horiz_vector_helper_pos_ind_R1 mult.left_neutral<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> h1 h2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> d1 d2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Renegar_Proofs-horiz_vector_helper_pos_R"><span class="command">lemma</span></span> horiz_vector_helper_pos_R<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">p</span><span class="main">::</span> <span class="quoted"><span class="quoted">"real poly"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> nonzero<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span><span class="main">≠</span><span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">qs</span><span class="main">::</span> <span class="quoted"><span class="quoted">"real poly list"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">I</span><span class="main">::</span> <span class="quoted"><span class="quoted">"nat list<span class="main">*</span>nat list"</span></span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">sign</span><span class="main">::</span> <span class="quoted"><span class="quoted">"rat list"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">x</span><span class="main">::</span> <span class="quoted"><span class="quoted">"real"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> root_p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> sign_fix<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">sign</span> <span class="main">=</span> consistent_sign_vec <span class="free">qs</span> <span class="free">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> welldefined1<span class="main">:</span> <span class="quoted"><span class="quoted">"list_constr <span class="main">(</span>fst <span class="free">I</span><span class="main">)</span> <span class="main">(</span>length <span class="free">qs</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> welldefined2<span class="main">:</span> <span class="quoted"><span class="quoted">"list_constr <span class="main">(</span>snd <span class="free">I</span><span class="main">)</span> <span class="main">(</span>length <span class="free">qs</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">∀</span><span class="bound">p</span> <span class="main">∈</span> set <span class="main">(</span>retrieve_polys <span class="free">qs</span> <span class="main">(</span>fst <span class="free">I</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> poly <span class="bound">p</span> <span class="free">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span>poly <span class="main">(</span>prod_list <span class="main">(</span>retrieve_polys <span class="free">qs</span> <span class="main">(</span>snd <span class="free">I</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">x</span> <span class="main">&gt;</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span>z_R <span class="free">I</span> <span class="free">sign</span> <span class="main">=</span> <span class="main">1</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> horiz_vector_helper_pos_ind_R
  <span class="keyword1"><span class="command">using</span></span>  nonzero  root_p sign_fix welldefined1 welldefined2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="Renegar_Proofs-horiz_vector_helper_neg_R"><span class="command">lemma</span></span> horiz_vector_helper_neg_R<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">p</span><span class="main">::</span> <span class="quoted"><span class="quoted">"real poly"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> nonzero<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span><span class="main">≠</span><span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">qs</span><span class="main">::</span> <span class="quoted"><span class="quoted">"real poly list"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">I</span><span class="main">::</span> <span class="quoted"><span class="quoted">"nat list<span class="main">*</span>nat list"</span></span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">sign</span><span class="main">::</span> <span class="quoted"><span class="quoted">"rat list"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">x</span><span class="main">::</span> <span class="quoted"><span class="quoted">"real"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> root_p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> sign_fix<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">sign</span> <span class="main">=</span> consistent_sign_vec <span class="free">qs</span> <span class="free">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> welldefined1<span class="main">:</span> <span class="quoted"><span class="quoted">"list_constr <span class="main">(</span>fst <span class="free">I</span><span class="main">)</span> <span class="main">(</span>length <span class="free">qs</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> welldefined2<span class="main">:</span> <span class="quoted"><span class="quoted">"list_constr <span class="main">(</span>snd <span class="free">I</span><span class="main">)</span> <span class="main">(</span>length <span class="free">qs</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">∀</span><span class="bound">p</span> <span class="main">∈</span> set <span class="main">(</span>retrieve_polys <span class="free">qs</span> <span class="main">(</span>fst <span class="free">I</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> poly <span class="bound">p</span> <span class="free">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span>poly <span class="main">(</span>prod_list <span class="main">(</span>retrieve_polys <span class="free">qs</span> <span class="main">(</span>snd <span class="free">I</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">x</span> <span class="main">&lt;</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span>z_R <span class="free">I</span> <span class="free">sign</span> <span class="main">=</span> <span class="main">-</span><span class="main">1</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> set_hyp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">sign</span> <span class="main">∈</span> set <span class="main">(</span>characterize_consistent_signs_at_roots <span class="free">p</span> <span class="free">qs</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> in_set_R<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">p</span></span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">sign</span></span> <span class="quoted"><span class="free">qs</span></span><span class="main">]</span> nonzero root_p sign_fix  <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
  <span class="keyword1"><span class="command">have</span></span> z_hyp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span>z_R <span class="free">I</span> <span class="free">sign</span> <span class="main">=</span> <span class="main">1</span><span class="main">)</span> <span class="main">∨</span> <span class="main">(</span>z_R <span class="free">I</span> <span class="free">sign</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span> <span class="main">∨</span> <span class="main">(</span>z_R <span class="free">I</span> <span class="free">sign</span> <span class="main">=</span> <span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> welldefined1 welldefined2 set_hyp  z_lemma_R<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> sign<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="free">sign</span>"</span></span><span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> I <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="free">I</span>"</span></span><span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> p<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="free">p</span>"</span></span><span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> qs<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="free">qs</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> d1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">∀</span><span class="bound">p</span> <span class="main">∈</span> set <span class="main">(</span>retrieve_polys <span class="free">qs</span> <span class="main">(</span>fst <span class="free">I</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> poly <span class="bound">p</span> <span class="free">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span>poly <span class="main">(</span>prod_list <span class="main">(</span>retrieve_polys <span class="free">qs</span> <span class="main">(</span>snd <span class="free">I</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">x</span> <span class="main">&lt;</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">(</span>z_R <span class="free">I</span> <span class="free">sign</span> <span class="main">=</span> <span class="main">-</span><span class="main">1</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> horiz_vector_helper_pos_R
    <span class="keyword1"><span class="command">using</span></span> nonzero root_p sign_fix welldefined1 welldefined2
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> <span class="main"><span class="main">(</span></span>verit<span class="main"><span class="main">,</span></span> ccfv_threshold<span class="main"><span class="main">)</span></span> horiz_vector_helper_pos_ind_R1 horiz_vector_helper_zer_ind_R2 mem_Collect_eq mult_eq_0_iff z_R_def z_hyp<span class="main">)</span> 
  <span class="keyword1"><span class="command">have</span></span> d2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>z_R <span class="free">I</span> <span class="free">sign</span> <span class="main">=</span> <span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">(</span><span class="main">∀</span><span class="bound">p</span> <span class="main">∈</span> set <span class="main">(</span>retrieve_polys <span class="free">qs</span> <span class="main">(</span>fst <span class="free">I</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> poly <span class="bound">p</span> <span class="free">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span>poly <span class="main">(</span>prod_list <span class="main">(</span>retrieve_polys <span class="free">qs</span> <span class="main">(</span>snd <span class="free">I</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">x</span> <span class="main">&lt;</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> horiz_vector_helper_pos_ind_R1 horiz_vector_helper_zer_ind_R2 nonzero root_p sign_fix welldefined1 welldefined2
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> <span class="main"><span class="main">(</span></span>verit<span class="main"><span class="main">,</span></span> ccfv_threshold<span class="main"><span class="main">)</span></span> class_field.neg_1_not_0 consistent_sign_vec_def consistent_signs_prop_R equal_neg_zero horiz_vector_helper_pos_ind_R2 length_map list_all_length list_constr_def mem_Collect_eq mem_Collect_eq mult_cancel_left1 mult_not_zero retrieve_polys_def z_R_def z_signs_R1 zero_neq_one<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> d1 d2
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Renegar_Proofs-lhs_dot_rewrite"><span class="command">lemma</span></span> lhs_dot_rewrite<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">p</span><span class="main">::</span> <span class="quoted"><span class="quoted">"real poly"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">qs</span><span class="main">::</span> <span class="quoted"><span class="quoted">"real poly list"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">I</span><span class="main">::</span> <span class="quoted"><span class="quoted">"nat list<span class="main">*</span>nat list"</span></span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">signs</span><span class="main">::</span> <span class="quoted"><span class="quoted">"rat list list"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> nonzero<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span><span class="main">≠</span><span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span>vec_of_list <span class="main">(</span>mtx_row_R <span class="free">signs</span> <span class="free">I</span><span class="main">)</span> <span class="main">∙</span> <span class="main">(</span>construct_lhs_vector_R <span class="free">p</span> <span class="free">qs</span> <span class="free">signs</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
   sum_list <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">(</span>z_R <span class="free">I</span> <span class="bound">s</span><span class="main">)</span>  <span class="main">*</span>  rat_of_int <span class="main">(</span>card <span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> consistent_sign_vec <span class="free">qs</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">s</span><span class="main">}</span><span class="main">)</span><span class="main">)</span> <span class="free">signs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> nonzero <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> construct_lhs_vector_cleaner<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> rhseq<span class="main">:</span> <span class="quoted"><span class="quoted">"construct_lhs_vector_R <span class="free">p</span> <span class="free">qs</span> <span class="free">signs</span> <span class="main">=</span>
    vec_of_list
    <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> rat_of_int <span class="main">(</span>card <span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> consistent_sign_vec <span class="free">qs</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">s</span><span class="main">}</span><span class="main">)</span><span class="main">)</span> <span class="free">signs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> construct_lhs_vector_cleaner_R nonzero <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>vec_of_list <span class="main">(</span>mtx_row_R <span class="free">signs</span> <span class="free">I</span><span class="main">)</span> <span class="main">∙</span> <span class="main">(</span>construct_lhs_vector_R <span class="free">p</span> <span class="free">qs</span> <span class="free">signs</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>    
    sum_list <span class="main">(</span>map2 <span class="main">(*)</span> <span class="main">(</span>mtx_row_R <span class="free">signs</span> <span class="free">I</span><span class="main">)</span> <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> rat_of_int <span class="main">(</span>card <span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> consistent_sign_vec <span class="free">qs</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">s</span><span class="main">}</span><span class="main">)</span><span class="main">)</span> <span class="free">signs</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> rhseq 
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> vec_of_list_dot_rewrite<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mtx_row_R_def<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> mtx_row_R_def
    <span class="keyword1"><span class="command">using</span></span> map2_map_map 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map2_map_map<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(* If we have a superset of the signs, we can drop to just the consistent ones *)</span>
<span class="keyword1" id="Renegar_Proofs-construct_lhs_vector_drop_consistent_R"><span class="command">lemma</span></span> construct_lhs_vector_drop_consistent_R<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">p</span><span class="main">::</span> <span class="quoted"><span class="quoted">"real poly"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">qs</span><span class="main">::</span> <span class="quoted"><span class="quoted">"real poly list"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">I</span><span class="main">::</span> <span class="quoted"><span class="quoted">"nat list<span class="main">*</span>nat list"</span></span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">signs</span><span class="main">::</span> <span class="quoted"><span class="quoted">"rat list list"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> nonzero<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span><span class="main">≠</span><span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> distinct_signs<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="free">signs</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> all_info<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>characterize_consistent_signs_at_roots <span class="free">p</span> <span class="free">qs</span><span class="main">)</span> <span class="main">⊆</span> set<span class="main">(</span><span class="free">signs</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> welldefined1<span class="main">:</span> <span class="quoted"><span class="quoted">"list_constr <span class="main">(</span>fst <span class="free">I</span><span class="main">)</span> <span class="main">(</span>length <span class="free">qs</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> welldefined2<span class="main">:</span> <span class="quoted"><span class="quoted">"list_constr <span class="main">(</span>snd <span class="free">I</span><span class="main">)</span> <span class="main">(</span>length <span class="free">qs</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span>vec_of_list <span class="main">(</span>mtx_row_R <span class="free">signs</span> <span class="free">I</span><span class="main">)</span> <span class="main">∙</span> <span class="main">(</span>construct_lhs_vector_R <span class="free">p</span> <span class="free">qs</span> <span class="free">signs</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
     <span class="main">(</span>vec_of_list <span class="main">(</span>mtx_row_R <span class="main">(</span>characterize_consistent_signs_at_roots <span class="free">p</span> <span class="free">qs</span><span class="main">)</span> <span class="free">I</span><span class="main">)</span> <span class="main">∙</span>
      <span class="main">(</span>construct_lhs_vector_R <span class="free">p</span> <span class="free">qs</span> <span class="main">(</span>characterize_consistent_signs_at_roots <span class="free">p</span> <span class="free">qs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
  <span class="keyword1"><span class="command">have</span></span> h0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">sgn</span><span class="main">.</span> <span class="bound">sgn</span> <span class="main">∈</span> set <span class="free">signs</span> <span class="main">∧</span> <span class="bound">sgn</span> <span class="main">∉</span> consistent_sign_vec <span class="free">qs</span> <span class="main">`</span> set <span class="main">(</span>characterize_root_list_p <span class="free">p</span><span class="main">)</span> <span class="main">∧</span> 
    <span class="main">0</span> <span class="main">&lt;</span> rat_of_nat <span class="main">(</span>card  <span class="main">{</span><span class="bound">xa</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">xa</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> consistent_sign_vec <span class="free">qs</span> <span class="bound">xa</span> <span class="main">=</span> <span class="bound">sgn</span><span class="main">}</span><span class="main">)</span> <span class="main">⟶</span> z_R <span class="free">I</span> <span class="bound">sgn</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">sgn</span><span class="main">.</span> <span class="bound">sgn</span> <span class="main">∈</span> set <span class="free">signs</span> <span class="main">∧</span> <span class="bound">sgn</span> <span class="main">∉</span> consistent_sign_vec <span class="free">qs</span> <span class="main">`</span> set <span class="main">(</span>characterize_root_list_p <span class="free">p</span><span class="main">)</span> <span class="main">∧</span> <span class="main">0</span> <span class="main">&lt;</span> rat_of_int <span class="main">(</span>card
                  <span class="main">{</span><span class="bound">xa</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">xa</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> consistent_sign_vec <span class="free">qs</span> <span class="bound">xa</span> <span class="main">=</span> <span class="bound">sgn</span><span class="main">}</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">{</span><span class="bound">xa</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">xa</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> consistent_sign_vec <span class="free">qs</span> <span class="bound">xa</span> <span class="main">=</span> <span class="bound">sgn</span><span class="main">}</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">iis</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"rat list"</span></span>
        <span class="keyword1"><span class="command">have</span></span> ff1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≠</span> <span class="free">p</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> nonzero rsquarefree_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">rr</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>real <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> real"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
          ff2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">p</span><span class="main">.</span> <span class="bound">p</span> <span class="main">(</span><span class="skolem">rr</span> <span class="bound">p</span><span class="main">)</span> <span class="main">∨</span> Collect <span class="bound">p</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">moura</span>
        <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">is</span><span class="main">.</span> <span class="bound">is</span> <span class="main">=</span> <span class="skolem">iis</span> <span class="main">∧</span> <span class="main">{</span><span class="bound">r</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">r</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> consistent_sign_vec <span class="free">qs</span> <span class="bound">r</span> <span class="main">=</span> <span class="bound">is</span><span class="main">}</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">is</span><span class="main">.</span> consistent_sign_vec <span class="free">qs</span> <span class="main">(</span><span class="skolem">rr</span> <span class="main">(</span><span class="main">λ</span><span class="bound">r</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">r</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> consistent_sign_vec <span class="free">qs</span> <span class="bound">r</span> <span class="main">=</span> <span class="bound">is</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">iis</span> <span class="main">∧</span> <span class="main">{</span><span class="bound">r</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">r</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> consistent_sign_vec <span class="free">qs</span> <span class="bound">r</span> <span class="main">=</span> <span class="bound">is</span><span class="main">}</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> ff2
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">r</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">r</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> consistent_sign_vec <span class="free">qs</span> <span class="bound">r</span> <span class="main">=</span> <span class="skolem">iis</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> ff2
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">smt</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">iis</span> <span class="main">∈</span> consistent_sign_vec <span class="free">qs</span> <span class="main">`</span> set <span class="main">(</span>sorted_list_of_set <span class="main">{</span><span class="bound">r</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">r</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> ff1 poly_roots_finite
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">)</span></span> imageI mem_Collect_eq set_sorted_list_of_set<span class="main">)</span> <span class="keyword1"><span class="command">}</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">iis</span> <span class="main">∉</span> set <span class="free">signs</span> <span class="main">∨</span> <span class="skolem">iis</span> <span class="main">∈</span> consistent_sign_vec <span class="free">qs</span> <span class="main">`</span> set <span class="main">(</span>characterize_root_list_p <span class="free">p</span><span class="main">)</span> <span class="main">∨</span> <span class="main">¬</span> <span class="main">0</span> <span class="main">&lt;</span> rat_of_int <span class="main">(</span>int <span class="main">(</span>card <span class="main">{</span><span class="bound">r</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">r</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> consistent_sign_vec <span class="free">qs</span> <span class="bound">r</span> <span class="main">=</span> <span class="skolem">iis</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span><span class="bound">sgn</span><span class="main">.</span> <span class="bound">sgn</span> <span class="main">∈</span> set <span class="free">signs</span> <span class="main">∧</span> <span class="bound">sgn</span> <span class="main">∉</span> consistent_sign_vec <span class="free">qs</span> <span class="main">`</span> set <span class="main">(</span>characterize_root_list_p <span class="free">p</span><span class="main">)</span> <span class="main">∧</span> <span class="main">0</span> <span class="main">&lt;</span> rat_of_int <span class="main">(</span>int <span class="main">(</span>card <span class="main">{</span><span class="bound">xa</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">xa</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> consistent_sign_vec <span class="free">qs</span> <span class="bound">xa</span> <span class="main">=</span> <span class="bound">sgn</span><span class="main">}</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">{</span><span class="bound">xa</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">xa</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> consistent_sign_vec <span class="free">qs</span> <span class="bound">xa</span> <span class="main">=</span> <span class="bound">sgn</span><span class="main">}</span> <span class="main">≠</span> <span class="main">{}</span>›</span></span> characterize_root_list_p_def<span class="main">)</span> <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">sgn</span><span class="main">.</span> <span class="bound">sgn</span> <span class="main">∈</span> set <span class="free">signs</span> <span class="main">∧</span> <span class="bound">sgn</span> <span class="main">∉</span> consistent_sign_vec <span class="free">qs</span> <span class="main">`</span> set <span class="main">(</span>characterize_root_list_p <span class="free">p</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">(</span><span class="main">0</span> <span class="main">=</span> rat_of_nat <span class="main">(</span>card
                  <span class="main">{</span><span class="bound">xa</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">xa</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> consistent_sign_vec <span class="free">qs</span> <span class="bound">xa</span> <span class="main">=</span> <span class="bound">sgn</span><span class="main">}</span><span class="main">)</span> <span class="main">∨</span> z_R <span class="free">I</span> <span class="bound">sgn</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> hyp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">s</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∈</span> set <span class="free">signs</span> <span class="main">∧</span> <span class="bound">s</span> <span class="main">∉</span> consistent_sign_vec <span class="free">qs</span> <span class="main">`</span> set <span class="main">(</span>characterize_root_list_p <span class="free">p</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">(</span>z_R <span class="free">I</span> <span class="bound">s</span> <span class="main">*</span> rat_of_nat <span class="main">(</span>card <span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> consistent_sign_vec <span class="free">qs</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">s</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">s</span><span class="main">∈</span> set<span class="main">(</span><span class="free">signs</span><span class="main">)</span><span class="main">.</span> z_R <span class="free">I</span> <span class="bound">s</span> <span class="main">*</span> rat_of_nat <span class="main">(</span>card <span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> consistent_sign_vec <span class="free">qs</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">s</span><span class="main">}</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
        <span class="main">(</span><span class="main">∑</span><span class="bound">s</span><span class="main">∈</span><span class="main">(</span>set <span class="main">(</span><span class="free">signs</span><span class="main">)</span> <span class="main">∩</span> <span class="main">(</span>consistent_sign_vec <span class="free">qs</span> <span class="main">`</span> set <span class="main">(</span>characterize_root_list_p <span class="free">p</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> z_R <span class="free">I</span> <span class="bound">s</span> <span class="main">*</span> rat_of_nat <span class="main">(</span>card <span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> consistent_sign_vec <span class="free">qs</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">s</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set<span class="main">(</span><span class="free">signs</span><span class="main">)</span> <span class="main">=</span><span class="main">(</span>set <span class="main">(</span><span class="free">signs</span><span class="main">)</span> <span class="main">∩</span> <span class="main">(</span>consistent_sign_vec <span class="free">qs</span> <span class="main">`</span> set <span class="main">(</span>characterize_root_list_p <span class="free">p</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span>
              <span class="main">(</span>set<span class="main">(</span><span class="free">signs</span><span class="main">)</span><span class="main">-</span><span class="main">(</span>consistent_sign_vec <span class="free">qs</span> <span class="main">`</span> set <span class="main">(</span>characterize_root_list_p <span class="free">p</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> sum_rewrite<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">s</span><span class="main">∈</span> set<span class="main">(</span><span class="free">signs</span><span class="main">)</span><span class="main">.</span> z_R <span class="free">I</span> <span class="bound">s</span> <span class="main">*</span> rat_of_nat <span class="main">(</span>card <span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> consistent_sign_vec <span class="free">qs</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">s</span><span class="main">}</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>  
          <span class="main">(</span><span class="main">∑</span><span class="bound">s</span><span class="main">∈</span> <span class="main">(</span>set <span class="main">(</span><span class="free">signs</span><span class="main">)</span> <span class="main">∩</span> <span class="main">(</span>consistent_sign_vec <span class="free">qs</span> <span class="main">`</span> set <span class="main">(</span>characterize_root_list_p <span class="free">p</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span>
              <span class="main">(</span>set<span class="main">(</span><span class="free">signs</span><span class="main">)</span><span class="main">-</span><span class="main">(</span>consistent_sign_vec <span class="free">qs</span> <span class="main">`</span> set <span class="main">(</span>characterize_root_list_p <span class="free">p</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> z_R <span class="free">I</span> <span class="bound">s</span> <span class="main">*</span> rat_of_nat <span class="main">(</span>card <span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> consistent_sign_vec <span class="free">qs</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">s</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> sum_split<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">s</span><span class="main">∈</span> <span class="main">(</span>set <span class="main">(</span><span class="free">signs</span><span class="main">)</span> <span class="main">∩</span> <span class="main">(</span>consistent_sign_vec <span class="free">qs</span> <span class="main">`</span> set <span class="main">(</span>characterize_root_list_p <span class="free">p</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span>
              <span class="main">(</span>set<span class="main">(</span><span class="free">signs</span><span class="main">)</span><span class="main">-</span><span class="main">(</span>consistent_sign_vec <span class="free">qs</span> <span class="main">`</span> set <span class="main">(</span>characterize_root_list_p <span class="free">p</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> z_R <span class="free">I</span> <span class="bound">s</span> <span class="main">*</span> rat_of_nat <span class="main">(</span>card <span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> consistent_sign_vec <span class="free">qs</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">s</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>
          <span class="main">=</span> 
<span class="main">(</span><span class="main">∑</span><span class="bound">s</span><span class="main">∈</span> <span class="main">(</span>set <span class="main">(</span><span class="free">signs</span><span class="main">)</span> <span class="main">∩</span> <span class="main">(</span>consistent_sign_vec <span class="free">qs</span> <span class="main">`</span> set <span class="main">(</span>characterize_root_list_p <span class="free">p</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> z_R <span class="free">I</span> <span class="bound">s</span> <span class="main">*</span> rat_of_nat <span class="main">(</span>card <span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> consistent_sign_vec <span class="free">qs</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">s</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>
<span class="main">+</span> <span class="main">(</span><span class="main">∑</span><span class="bound">s</span><span class="main">∈</span> <span class="main">(</span>set<span class="main">(</span><span class="free">signs</span><span class="main">)</span><span class="main">-</span><span class="main">(</span>consistent_sign_vec <span class="free">qs</span> <span class="main">`</span> set <span class="main">(</span>characterize_root_list_p <span class="free">p</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> z_R <span class="free">I</span> <span class="bound">s</span> <span class="main">*</span> rat_of_nat <span class="main">(</span>card <span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> consistent_sign_vec <span class="free">qs</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">s</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> List.finite_set sum.Int_Diff<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> sum_zero<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">s</span><span class="main">∈</span> <span class="main">(</span>set<span class="main">(</span><span class="free">signs</span><span class="main">)</span><span class="main">-</span><span class="main">(</span>consistent_sign_vec <span class="free">qs</span> <span class="main">`</span> set <span class="main">(</span>characterize_root_list_p <span class="free">p</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> z_R <span class="free">I</span> <span class="bound">s</span> <span class="main">*</span> rat_of_nat <span class="main">(</span>card <span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> consistent_sign_vec <span class="free">qs</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">s</span><span class="main">}</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>   
      <span class="keyword1"><span class="command">using</span></span> hyp
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> hyp<span class="main">)</span>      
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> sum_rewrite sum_split sum_zero <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> set_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>remdups
           <span class="main">(</span>map <span class="main">(</span>consistent_sign_vec <span class="free">qs</span><span class="main">)</span>
             <span class="main">(</span>characterize_root_list_p <span class="free">p</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> set <span class="main">(</span><span class="free">signs</span><span class="main">)</span> <span class="main">∩</span> <span class="main">(</span>consistent_sign_vec <span class="free">qs</span> <span class="main">`</span> set <span class="main">(</span>characterize_root_list_p <span class="free">p</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> all_info <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> characterize_consistent_signs_at_roots_def subset_antisym<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> <span class="main"><span class="main">(</span></span>z3<span class="main"><span class="main">)</span></span> Int_subset_iff consistent_sign_vec_def list.set_map map_eq_conv o_apply signs_at_def squash_def subsetI subset_antisym<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> hyp1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">s</span><span class="main">←</span><span class="free">signs</span><span class="main">.</span> z_R <span class="free">I</span> <span class="bound">s</span> <span class="main">*</span> rat_of_nat <span class="main">(</span>card <span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> consistent_sign_vec <span class="free">qs</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">s</span><span class="main">}</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
        <span class="main">(</span><span class="main">∑</span><span class="bound">s</span><span class="main">∈</span>set <span class="main">(</span><span class="free">signs</span><span class="main">)</span><span class="main">.</span> z_R <span class="free">I</span> <span class="bound">s</span> <span class="main">*</span> rat_of_nat <span class="main">(</span>card <span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> consistent_sign_vec <span class="free">qs</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">s</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> distinct_signs sum_list_distinct_conv_sum_set <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> hyp2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">s</span><span class="main">←</span>remdups
           <span class="main">(</span>map <span class="main">(</span>consistent_sign_vec <span class="free">qs</span><span class="main">)</span>
             <span class="main">(</span>characterize_root_list_p <span class="free">p</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> z_R <span class="free">I</span> <span class="bound">s</span> <span class="main">*</span> rat_of_nat <span class="main">(</span>card <span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> consistent_sign_vec <span class="free">qs</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">s</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>
  <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">s</span><span class="main">∈</span> set <span class="main">(</span>remdups
           <span class="main">(</span>map <span class="main">(</span>consistent_sign_vec <span class="free">qs</span><span class="main">)</span>
             <span class="main">(</span>characterize_root_list_p <span class="free">p</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> z_R <span class="free">I</span> <span class="bound">s</span> <span class="main">*</span> rat_of_nat <span class="main">(</span>card <span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> consistent_sign_vec <span class="free">qs</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">s</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> sum_list_distinct_conv_sum_set <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
  <span class="keyword1"><span class="command">have</span></span> set_sum_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">s</span><span class="main">∈</span><span class="main">(</span>set <span class="main">(</span><span class="free">signs</span><span class="main">)</span> <span class="main">∩</span> <span class="main">(</span>consistent_sign_vec <span class="free">qs</span> <span class="main">`</span> set <span class="main">(</span>characterize_root_list_p <span class="free">p</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> z_R <span class="free">I</span> <span class="bound">s</span> <span class="main">*</span> rat_of_nat <span class="main">(</span>card <span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> consistent_sign_vec <span class="free">qs</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">s</span><span class="main">}</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
    <span class="main">(</span><span class="main">∑</span><span class="bound">s</span><span class="main">∈</span> set <span class="main">(</span>remdups
           <span class="main">(</span>map <span class="main">(</span>consistent_sign_vec <span class="free">qs</span><span class="main">)</span>
             <span class="main">(</span>characterize_root_list_p <span class="free">p</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> z_R <span class="free">I</span> <span class="bound">s</span> <span class="main">*</span> rat_of_nat <span class="main">(</span>card <span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> consistent_sign_vec <span class="free">qs</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">s</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> set_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">s</span><span class="main">←</span><span class="free">signs</span><span class="main">.</span> z_R <span class="free">I</span> <span class="bound">s</span> <span class="main">*</span> rat_of_nat <span class="main">(</span>card <span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> consistent_sign_vec <span class="free">qs</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">s</span><span class="main">}</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
    <span class="main">(</span><span class="main">∑</span><span class="bound">s</span><span class="main">←</span>remdups
           <span class="main">(</span>map <span class="main">(</span>consistent_sign_vec <span class="free">qs</span><span class="main">)</span>
             <span class="main">(</span>characterize_root_list_p <span class="free">p</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> z_R <span class="free">I</span> <span class="bound">s</span> <span class="main">*</span> rat_of_nat <span class="main">(</span>card <span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> consistent_sign_vec <span class="free">qs</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">s</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> set_sum_eq hyp1 hyp2
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main">∑</span><span class="bound">s</span><span class="main">∈</span>set <span class="free">signs</span><span class="main">.</span> z_R <span class="free">I</span> <span class="bound">s</span> <span class="main">*</span> rat_of_nat <span class="main">(</span>card <span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> consistent_sign_vec <span class="free">qs</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">s</span><span class="main">}</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">s</span><span class="main">∈</span>set <span class="free">signs</span> <span class="main">∩</span> consistent_sign_vec <span class="free">qs</span> <span class="main">`</span> set <span class="main">(</span>characterize_root_list_p <span class="free">p</span><span class="main">)</span><span class="main">.</span> z_R <span class="free">I</span> <span class="bound">s</span> <span class="main">*</span> rat_of_nat <span class="main">(</span>card <span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> consistent_sign_vec <span class="free">qs</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">s</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"consistent_sign_vec <span class="free">qs</span> <span class="main">`</span> set <span class="main">(</span>characterize_root_list_p <span class="free">p</span><span class="main">)</span> <span class="main">⊆</span> set <span class="free">signs</span> <span class="main">⟹</span>
    <span class="main">(</span><span class="main">⋀</span><span class="bound">p</span> <span class="bound">qss</span><span class="main">.</span>
        characterize_consistent_signs_at_roots <span class="bound">p</span> <span class="bound">qss</span> <span class="main">=</span>
        remdups <span class="main">(</span>map <span class="main">(</span>consistent_sign_vec <span class="bound">qss</span><span class="main">)</span> <span class="main">(</span>characterize_root_list_p <span class="bound">p</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span>
    <span class="main">(</span><span class="main">∑</span><span class="bound">s</span><span class="main">←</span><span class="free">signs</span><span class="main">.</span> z_R <span class="free">I</span> <span class="bound">s</span> <span class="main">*</span> rat_of_nat <span class="main">(</span>card <span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> consistent_sign_vec <span class="free">qs</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">s</span><span class="main">}</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
    <span class="main">(</span><span class="main">∑</span><span class="bound">s</span><span class="main">←</span>remdups
           <span class="main">(</span>map <span class="main">(</span>consistent_sign_vec <span class="free">qs</span><span class="main">)</span>
             <span class="main">(</span>characterize_root_list_p <span class="free">p</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> z_R <span class="free">I</span> <span class="bound">s</span> <span class="main">*</span> rat_of_nat <span class="main">(</span>card <span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> consistent_sign_vec <span class="free">qs</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">s</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> lhs_dot_rewrite<span class="main">[</span><span class="operator">OF</span> nonzero<span class="main">]</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> sum_list_distinct_filter <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> distinct_signs  consistent_sign_vec_def characterize_consistent_signs_at_roots_def<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> all_info consistent_sign_vec_def characterize_consistent_signs_at_roots_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> <span class="main"><span class="main">(</span></span>z3<span class="main"><span class="main">)</span></span> list.set_map map_eq_conv o_apply set_remdups signs_at_def squash_def<span class="main">)</span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Renegar_Proofs-matrix_equation_helper_step_R"><span class="command">lemma</span></span> matrix_equation_helper_step_R<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">p</span><span class="main">::</span> <span class="quoted"><span class="quoted">"real poly"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">qs</span><span class="main">::</span> <span class="quoted"><span class="quoted">"real poly list"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">I</span><span class="main">::</span> <span class="quoted"><span class="quoted">"nat list<span class="main">*</span>nat list"</span></span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">signs</span><span class="main">::</span> <span class="quoted"><span class="quoted">"rat list list"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> nonzero<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span><span class="main">≠</span><span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> distinct_signs<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="free">signs</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> all_info<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>characterize_consistent_signs_at_roots <span class="free">p</span> <span class="free">qs</span><span class="main">)</span> <span class="main">⊆</span> set<span class="main">(</span><span class="free">signs</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> welldefined1<span class="main">:</span> <span class="quoted"><span class="quoted">"list_constr <span class="main">(</span>fst <span class="free">I</span><span class="main">)</span> <span class="main">(</span>length <span class="free">qs</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> welldefined2<span class="main">:</span> <span class="quoted"><span class="quoted">"list_constr <span class="main">(</span>snd <span class="free">I</span><span class="main">)</span> <span class="main">(</span>length <span class="free">qs</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>vec_of_list <span class="main">(</span>mtx_row_R <span class="free">signs</span> <span class="free">I</span><span class="main">)</span> <span class="main">∙</span> <span class="main">(</span>construct_lhs_vector_R <span class="free">p</span> <span class="free">qs</span> <span class="free">signs</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
   rat_of_int <span class="main">(</span>card <span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">p</span> <span class="main">∈</span> set <span class="main">(</span>retrieve_polys <span class="free">qs</span> <span class="main">(</span>fst <span class="free">I</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> poly <span class="bound">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span> <span class="main">∧</span> poly <span class="main">(</span>prod_list <span class="main">(</span>retrieve_polys <span class="free">qs</span> <span class="main">(</span>snd <span class="free">I</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="bound">x</span> <span class="main">&gt;</span> <span class="main">0</span><span class="main">}</span><span class="main">)</span> <span class="main">-</span>
   rat_of_int <span class="main">(</span>card <span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">p</span> <span class="main">∈</span> set <span class="main">(</span>retrieve_polys <span class="free">qs</span> <span class="main">(</span>fst <span class="free">I</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> poly <span class="bound">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span> <span class="main">∧</span> poly <span class="main">(</span>prod_list <span class="main">(</span>retrieve_polys <span class="free">qs</span> <span class="main">(</span>snd <span class="free">I</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="bound">x</span> <span class="main">&lt;</span> <span class="main">0</span><span class="main">}</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> finset<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>set <span class="main">(</span>map <span class="main">(</span>consistent_sign_vec <span class="free">qs</span><span class="main">)</span>  <span class="main">(</span>characterize_root_list_p <span class="free">p</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?gt</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>set <span class="main">(</span>map <span class="main">(</span>consistent_sign_vec <span class="free">qs</span><span class="main">)</span>  <span class="main">(</span>characterize_root_list_p <span class="free">p</span><span class="main">)</span><span class="main">)</span> <span class="main">∩</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> z_R <span class="free">I</span> <span class="bound">s</span> <span class="main">=</span> <span class="main">1</span><span class="main">}</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?lt</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"  <span class="main">(</span>set <span class="main">(</span>map <span class="main">(</span>consistent_sign_vec <span class="free">qs</span><span class="main">)</span>  <span class="main">(</span>characterize_root_list_p <span class="free">p</span><span class="main">)</span><span class="main">)</span> <span class="main">∩</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> z_R <span class="free">I</span> <span class="bound">s</span> <span class="main">=</span> <span class="main">-</span><span class="main">1</span><span class="main">}</span><span class="main">)</span>"</span></span>  
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?zer</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>set <span class="main">(</span>map <span class="main">(</span>consistent_sign_vec <span class="free">qs</span><span class="main">)</span>  <span class="main">(</span>characterize_root_list_p <span class="free">p</span><span class="main">)</span><span class="main">)</span> <span class="main">∩</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> z_R <span class="free">I</span> <span class="bound">s</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>map <span class="main">(</span>consistent_sign_vec <span class="free">qs</span><span class="main">)</span>  <span class="main">(</span>characterize_root_list_p <span class="free">p</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="var">?gt</span> <span class="main">∪</span> <span class="var">?lt</span><span class="main">)</span> <span class="main">∪</span> <span class="var">?zer</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">safe</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
    <span class="keyword3"><span class="command">assume</span></span> h<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> set <span class="main">(</span>map <span class="main">(</span>consistent_sign_vec <span class="free">qs</span><span class="main">)</span> <span class="main">(</span>characterize_root_list_p <span class="free">p</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="quoted"><span class="quoted">"z_R <span class="free">I</span> <span class="skolem">x</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"z_R <span class="free">I</span> <span class="skolem">x</span> <span class="main">≠</span> <span class="main">-</span> <span class="main">1</span>"</span></span> 
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> set <span class="main">(</span>characterize_consistent_signs_at_roots <span class="free">p</span> <span class="free">qs</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> characterize_consistent_signs_at_roots_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> <span class="main"><span class="main">(</span></span>verit<span class="main"><span class="main">,</span></span> del_insts<span class="main"><span class="main">)</span></span> characterize_consistent_signs_at_roots_def characterize_root_list_p_def imageE in_set_R nonzero poly_roots_finite set_map sorted_list_of_set<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"z_R <span class="free">I</span> <span class="skolem">x</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> h welldefined1 welldefined2 z_lemma_R <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">have</span></span> sumeq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">s</span><span class="main">∈</span><span class="main">(</span><span class="var">?gt</span><span class="main">∪</span><span class="var">?lt</span><span class="main">)</span><span class="main">.</span> z_R <span class="free">I</span> <span class="bound">s</span> <span class="main">*</span> rat_of_int <span class="main">(</span>card <span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> consistent_sign_vec <span class="free">qs</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">s</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>
  <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">s</span><span class="main">∈</span><span class="var">?gt</span><span class="main">.</span> z_R <span class="free">I</span> <span class="bound">s</span> <span class="main">*</span> rat_of_int <span class="main">(</span>card <span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> consistent_sign_vec <span class="free">qs</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">s</span><span class="main">}</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span>
  <span class="main">(</span><span class="main">∑</span><span class="bound">s</span><span class="main">∈</span><span class="var">?lt</span><span class="main">.</span> z_R <span class="free">I</span> <span class="bound">s</span> <span class="main">*</span> rat_of_int <span class="main">(</span>card <span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> consistent_sign_vec <span class="free">qs</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">s</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> sum.union_disjoint<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="comment1">(* First, drop the signs that are irrelevant *)</span>
  <span class="keyword1"><span class="command">from</span></span> construct_lhs_vector_drop_consistent_R<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1-5<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span>
    <span class="quoted"><span class="quoted">"vec_of_list <span class="main">(</span>mtx_row_R <span class="free">signs</span> <span class="free">I</span><span class="main">)</span> <span class="main">∙</span> construct_lhs_vector_R <span class="free">p</span> <span class="free">qs</span> <span class="free">signs</span> <span class="main">=</span>
  vec_of_list <span class="main">(</span>mtx_row_R <span class="main">(</span>characterize_consistent_signs_at_roots <span class="free">p</span> <span class="free">qs</span><span class="main">)</span> <span class="free">I</span><span class="main">)</span> <span class="main">∙</span>
  construct_lhs_vector_R <span class="free">p</span> <span class="free">qs</span> <span class="main">(</span>characterize_consistent_signs_at_roots <span class="free">p</span> <span class="free">qs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="comment1">(* Now we split the sum *)</span>
  <span class="keyword1"><span class="command">from</span></span> lhs_dot_rewrite<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command"><span class="improper">moreover</span></span></span> <span class="keyword1"><span class="command"><span class="improper">have</span></span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span>
  <span class="main">(</span><span class="main">∑</span><span class="bound">s</span><span class="main">←</span>characterize_consistent_signs_at_roots <span class="free">p</span> <span class="free">qs</span><span class="main">.</span>
    z_R <span class="free">I</span> <span class="bound">s</span> <span class="main">*</span> rat_of_int <span class="main">(</span>card <span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> consistent_sign_vec <span class="free">qs</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">s</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span>
  <span class="main">(</span><span class="main">∑</span><span class="bound">s</span><span class="main">∈</span>set <span class="main">(</span>map <span class="main">(</span>consistent_sign_vec <span class="free">qs</span><span class="main">)</span>  <span class="main">(</span>characterize_root_list_p <span class="free">p</span><span class="main">)</span><span class="main">)</span><span class="main">.</span>
    z_R <span class="free">I</span> <span class="bound">s</span> <span class="main">*</span> rat_of_int <span class="main">(</span>card <span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> consistent_sign_vec <span class="free">qs</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">s</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> characterize_consistent_signs_at_roots_def sum_code<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> <span class="main"><span class="main">(</span></span>verit<span class="main"><span class="main">,</span></span> best<span class="main"><span class="main">)</span></span> consistent_sign_vec_def list.set_map map_eq_conv o_apply signs_at_def squash_def sum.set_conv_list<span class="main">)</span> 
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> setc1<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> 
  <span class="main">(</span><span class="main">∑</span><span class="bound">s</span><span class="main">∈</span><span class="main">(</span><span class="var">?gt</span><span class="main">∪</span><span class="var">?lt</span><span class="main">)</span><span class="main">.</span> z_R <span class="free">I</span> <span class="bound">s</span> <span class="main">*</span> rat_of_int <span class="main">(</span>card <span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> consistent_sign_vec <span class="free">qs</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">s</span><span class="main">}</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span>
    <span class="main">(</span><span class="main">∑</span><span class="bound">s</span><span class="main">∈</span><span class="var">?zer</span><span class="main">.</span> z_R <span class="free">I</span> <span class="bound">s</span> <span class="main">*</span> rat_of_int <span class="main">(</span>card <span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> consistent_sign_vec <span class="free">qs</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">s</span><span class="main">}</span><span class="main">)</span><span class="main">)</span> "</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> eq<span class="main">)</span> 
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span>  sum.union_disjoint<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> setc<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span>
  <span class="main">(</span><span class="main">∑</span><span class="bound">s</span><span class="main">∈</span><span class="var">?gt</span><span class="main">.</span> z_R <span class="free">I</span> <span class="bound">s</span> <span class="main">*</span> rat_of_int <span class="main">(</span>card <span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> consistent_sign_vec <span class="free">qs</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">s</span><span class="main">}</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span>
  <span class="main">(</span><span class="main">∑</span><span class="bound">s</span><span class="main">∈</span><span class="var">?lt</span><span class="main">.</span> z_R <span class="free">I</span> <span class="bound">s</span> <span class="main">*</span> rat_of_int <span class="main">(</span>card <span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> consistent_sign_vec <span class="free">qs</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">s</span><span class="main">}</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span>
  <span class="main">(</span><span class="main">∑</span><span class="bound">s</span><span class="main">∈</span><span class="var">?zer</span><span class="main">.</span> z_R <span class="free">I</span> <span class="bound">s</span> <span class="main">*</span> rat_of_int <span class="main">(</span>card <span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> consistent_sign_vec <span class="free">qs</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">s</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> sumeq <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">s</span> <span class="main">∈</span> <span class="var">?zer</span><span class="main">.</span> <span class="main">(</span>z_R <span class="free">I</span> <span class="bound">s</span> <span class="main">*</span> rat_of_int <span class="main">(</span>card <span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> consistent_sign_vec <span class="free">qs</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">s</span><span class="main">}</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> obvzer<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">s</span><span class="main">∈</span><span class="var">?zer</span><span class="main">.</span> z_R <span class="free">I</span> <span class="bound">s</span> <span class="main">*</span> rat_of_int <span class="main">(</span>card <span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> consistent_sign_vec <span class="free">qs</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">s</span><span class="main">}</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="comment1">(* Now recharacterize lt, gt*)</span>
  <span class="keyword1"><span class="command">have</span></span> setroots<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>characterize_root_list_p <span class="free">p</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> characterize_root_list_p_def
    <span class="keyword1"><span class="command">using</span></span> poly_roots_finite nonzero rsquarefree_def set_sorted_list_of_set <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>    
  <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> consistent_sign_vec <span class="free">qs</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">s</span><span class="main">}</span> <span class="main">=</span>
        <span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span><span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span><span class="main">.</span> consistent_sign_vec <span class="free">qs</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">s</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> e1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">s</span><span class="main">∈</span>consistent_sign_vec <span class="free">qs</span> <span class="main">`</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span> <span class="main">∩</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> z_R <span class="free">I</span> <span class="bound">s</span> <span class="main">=</span> <span class="main">1</span><span class="main">}</span><span class="main">.</span>
       card <span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> consistent_sign_vec <span class="free">qs</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">s</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span>
     <span class="main">(</span>sum <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">if</span> <span class="main">(</span><span class="main">∀</span><span class="bound">p</span> <span class="main">∈</span> set <span class="main">(</span>retrieve_polys <span class="free">qs</span> <span class="main">(</span>fst <span class="free">I</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> poly <span class="bound">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span>poly <span class="main">(</span>prod_list <span class="main">(</span>retrieve_polys <span class="free">qs</span> <span class="main">(</span>snd <span class="free">I</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="bound">x</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> * <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> sum_multicount_gen<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹finite <span class="main">(</span>set <span class="main">(</span>map <span class="main">(</span>consistent_sign_vec <span class="free">qs</span><span class="main">)</span> <span class="main">(</span>characterize_root_list_p <span class="free">p</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>›</span></span> setroots <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> List.finite_set setroots<span class="main">)</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">safe</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
    <span class="keyword3"><span class="command">assume</span></span> rt<span class="main">:</span> <span class="quoted"><span class="quoted">"poly <span class="free">p</span> <span class="skolem">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound"><span class="bound">s</span></span> <span class="main">∈</span> consistent_sign_vec <span class="free">qs</span> <span class="main">`</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span> <span class="main">∩</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> z_R <span class="free">I</span> <span class="bound">s</span> <span class="main">=</span> <span class="main">1</span><span class="main">}</span><span class="main">.</span> consistent_sign_vec <span class="free">qs</span> <span class="skolem">x</span> <span class="main">=</span> <span class="bound">s</span><span class="main">}</span> <span class="main">=</span>
      <span class="main">{</span><span class="bound">s</span><span class="main">.</span> z_R <span class="free">I</span> <span class="bound">s</span> <span class="main">=</span> <span class="main">1</span> <span class="main">∧</span> consistent_sign_vec <span class="free">qs</span> <span class="skolem">x</span> <span class="main">=</span> <span class="bound">s</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound">p</span> <span class="main">∈</span> set <span class="main">(</span>retrieve_polys <span class="free">qs</span> <span class="main">(</span>fst <span class="free">I</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> poly <span class="bound">p</span> <span class="skolem">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">0</span> <span class="main">&lt;</span> poly <span class="main">(</span>prod_list <span class="main">(</span>retrieve_polys <span class="free">qs</span> <span class="main">(</span>snd <span class="free">I</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">x</span><span class="main">)</span>  <span class="main">∧</span> consistent_sign_vec <span class="free">qs</span> <span class="skolem">x</span> <span class="main">=</span> <span class="bound">s</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> horiz_vector_helper_pos_R assms welldefined1 welldefined2 rt <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="main">(</span><span class="main">∀</span><span class="bound">p</span> <span class="main">∈</span> set <span class="main">(</span>retrieve_polys <span class="free">qs</span> <span class="main">(</span>fst <span class="free">I</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> poly <span class="bound">p</span> <span class="skolem">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">0</span> <span class="main">&lt;</span> poly <span class="main">(</span>prod_list <span class="main">(</span>retrieve_polys <span class="free">qs</span> <span class="main">(</span>snd <span class="free">I</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">x</span><span class="main">)</span>  <span class="keyword1">then</span> <span class="main">{</span>consistent_sign_vec <span class="free">qs</span> <span class="skolem">x</span><span class="main">}</span> <span class="keyword1">else</span> <span class="main">{}</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">{</span><span class="bound"><span class="bound">s</span></span> <span class="main">∈</span> consistent_sign_vec <span class="free">qs</span> <span class="main">`</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span> <span class="main">∩</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> z_R <span class="free">I</span> <span class="bound">s</span> <span class="main">=</span> <span class="main">1</span><span class="main">}</span><span class="main">.</span> consistent_sign_vec <span class="free">qs</span> <span class="skolem">x</span> <span class="main">=</span> <span class="bound">s</span><span class="main">}</span> <span class="main">=</span>
         <span class="main">(</span><span class="keyword1">if</span> <span class="main">(</span><span class="main">(</span><span class="main">∀</span><span class="bound">p</span> <span class="main">∈</span> set <span class="main">(</span>retrieve_polys <span class="free">qs</span> <span class="main">(</span>fst <span class="free">I</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> poly <span class="bound">p</span> <span class="skolem">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span> <span class="main">∧</span> <span class="main">0</span> <span class="main">&lt;</span> poly <span class="main">(</span>prod_list  <span class="main">(</span>retrieve_polys <span class="free">qs</span> <span class="main">(</span>snd <span class="free">I</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">x</span><span class="main">)</span>
          <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1 2 3 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">" card
          <span class="main">{</span><span class="bound"><span class="bound">s</span></span> <span class="main">∈</span> consistent_sign_vec <span class="free">qs</span> <span class="main">`</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span> <span class="main">∩</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> z_R <span class="free">I</span> <span class="bound">s</span> <span class="main">=</span> <span class="main">1</span><span class="main">}</span><span class="main">.</span>
           consistent_sign_vec <span class="free">qs</span> <span class="skolem">x</span> <span class="main">=</span> <span class="bound">s</span><span class="main">}</span> <span class="main">=</span>
         <span class="main">(</span><span class="keyword1">if</span> <span class="main">(</span><span class="main">∀</span><span class="bound">p</span><span class="main">∈</span>set <span class="main">(</span>retrieve_polys <span class="free">qs</span> <span class="main">(</span>fst <span class="free">I</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> poly <span class="bound">p</span> <span class="skolem">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span> <span class="main">∧</span>
             <span class="main">0</span> <span class="main">&lt;</span> poly <span class="main">(</span>prod_list <span class="main">(</span>retrieve_polys <span class="free">qs</span> <span class="main">(</span>snd <span class="free">I</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">x</span>
          <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">have</span></span> gtchr<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">s</span><span class="main">∈</span><span class="var">?gt</span><span class="main">.</span> z_R <span class="free">I</span> <span class="bound">s</span> <span class="main">*</span> rat_of_int <span class="main">(</span>card <span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> consistent_sign_vec <span class="free">qs</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">s</span><span class="main">}</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
    rat_of_int <span class="main">(</span>card <span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">p</span><span class="main">∈</span>set <span class="main">(</span>retrieve_polys <span class="free">qs</span> <span class="main">(</span>fst <span class="free">I</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> poly <span class="bound">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span> <span class="main">∧</span> <span class="main">0</span> <span class="main">&lt;</span> poly <span class="main">(</span>prod_list <span class="main">(</span>retrieve_polys <span class="free">qs</span> <span class="main">(</span>snd <span class="free">I</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="bound">x</span><span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> setroots<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> of_nat_sum<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> of_nat_eq_iff<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> e1<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> card_eq_sum<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> sum.mono_neutral_cong_right<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> List.finite_set setroots<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> e2<span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="main">(</span><span class="main">∑</span><span class="bound">s</span><span class="main">∈</span>consistent_sign_vec <span class="free">qs</span> <span class="main">`</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span> <span class="main">∩</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> z_R <span class="free">I</span> <span class="bound">s</span> <span class="main">=</span> <span class="main">-</span> <span class="main">1</span><span class="main">}</span><span class="main">.</span>
       card <span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> consistent_sign_vec <span class="free">qs</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">s</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span>
     <span class="main">(</span>sum <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">if</span> <span class="main">(</span><span class="main">∀</span><span class="bound">p</span><span class="main">∈</span>set <span class="main">(</span>retrieve_polys <span class="free">qs</span> <span class="main">(</span>fst <span class="free">I</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> poly <span class="bound">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span>poly <span class="main">(</span>prod_list <span class="main">(</span>retrieve_polys <span class="free">qs</span> <span class="main">(</span>snd <span class="free">I</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="bound">x</span><span class="main">)</span> <span class="main">&lt;</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> * <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> sum_multicount_gen<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹finite <span class="main">(</span>set <span class="main">(</span>map <span class="main">(</span>consistent_sign_vec <span class="free">qs</span><span class="main">)</span> <span class="main">(</span>characterize_root_list_p <span class="free">p</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>›</span></span> setroots <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> List.finite_set setroots<span class="main">)</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">safe</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
    <span class="keyword3"><span class="command">assume</span></span> rt<span class="main">:</span> <span class="quoted"><span class="quoted">"poly <span class="free">p</span> <span class="skolem">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound"><span class="bound">s</span></span> <span class="main">∈</span> consistent_sign_vec <span class="free">qs</span> <span class="main">`</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span> <span class="main">∩</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> z_R <span class="free">I</span> <span class="bound">s</span> <span class="main">=</span> <span class="main">-</span><span class="main">1</span><span class="main">}</span><span class="main">.</span> consistent_sign_vec <span class="free">qs</span> <span class="skolem">x</span> <span class="main">=</span> <span class="bound">s</span><span class="main">}</span> <span class="main">=</span>
      <span class="main">{</span><span class="bound">s</span><span class="main">.</span> z_R <span class="free">I</span> <span class="bound">s</span> <span class="main">=</span> <span class="main">-</span><span class="main">1</span> <span class="main">∧</span> consistent_sign_vec <span class="free">qs</span> <span class="skolem">x</span> <span class="main">=</span> <span class="bound">s</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="main">∀</span><span class="bound">p</span><span class="main">∈</span>set <span class="main">(</span>retrieve_polys <span class="free">qs</span> <span class="main">(</span>fst <span class="free">I</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> poly <span class="bound">p</span> <span class="skolem">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span> <span class="main">∧</span> <span class="main">0</span> <span class="main">&gt;</span> poly <span class="main">(</span>prod_list <span class="main">(</span>retrieve_polys <span class="free">qs</span> <span class="main">(</span>snd <span class="free">I</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">x</span><span class="main">)</span>  <span class="main">∧</span> consistent_sign_vec <span class="free">qs</span> <span class="skolem">x</span> <span class="main">=</span> <span class="bound">s</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> horiz_vector_helper_neg_R assms rt welldefined1 welldefined2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="main">(</span><span class="main">∀</span><span class="bound">p</span><span class="main">∈</span>set <span class="main">(</span>retrieve_polys <span class="free">qs</span> <span class="main">(</span>fst <span class="free">I</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> poly <span class="bound">p</span> <span class="skolem">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">0</span> <span class="main">&gt;</span> poly <span class="main">(</span>prod_list <span class="main">(</span>retrieve_polys <span class="free">qs</span> <span class="main">(</span>snd <span class="free">I</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">x</span><span class="main">)</span>  <span class="keyword1">then</span> <span class="main">{</span>consistent_sign_vec <span class="free">qs</span> <span class="skolem">x</span><span class="main">}</span> <span class="keyword1">else</span> <span class="main">{}</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"card <span class="main">{</span><span class="bound"><span class="bound">s</span></span> <span class="main">∈</span> consistent_sign_vec <span class="free">qs</span> <span class="main">`</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span> <span class="main">∩</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> z_R <span class="free">I</span> <span class="bound">s</span> <span class="main">=</span> <span class="main">-</span><span class="main">1</span><span class="main">}</span><span class="main">.</span> consistent_sign_vec <span class="free">qs</span> <span class="skolem">x</span> <span class="main">=</span> <span class="bound">s</span><span class="main">}</span> <span class="main">=</span>
         <span class="main">(</span><span class="keyword1">if</span> <span class="main">(</span><span class="main">∀</span><span class="bound">p</span><span class="main">∈</span>set <span class="main">(</span>retrieve_polys <span class="free">qs</span> <span class="main">(</span>fst <span class="free">I</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> poly <span class="bound">p</span> <span class="skolem">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span> <span class="main">∧</span> <span class="main">0</span> <span class="main">&gt;</span> poly
                  <span class="main">(</span>prod_list
                    <span class="main">(</span>retrieve_polys <span class="free">qs</span> <span class="main">(</span>snd <span class="free">I</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
                  <span class="skolem">x</span>
          <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1 2 3 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">have</span></span> ltchr<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">s</span><span class="main">∈</span><span class="var">?lt</span><span class="main">.</span> z_R <span class="free">I</span> <span class="bound">s</span> <span class="main">*</span> rat_of_int <span class="main">(</span>card <span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> consistent_sign_vec <span class="free">qs</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">s</span><span class="main">}</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
    <span class="main">-</span> rat_of_int <span class="main">(</span>card <span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">p</span><span class="main">∈</span>set <span class="main">(</span>retrieve_polys <span class="free">qs</span> <span class="main">(</span>fst <span class="free">I</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> poly <span class="bound">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span> <span class="main">∧</span> <span class="main">0</span> <span class="main">&gt;</span> poly <span class="main">(</span>prod_list <span class="main">(</span>retrieve_polys <span class="free">qs</span> <span class="main">(</span>snd <span class="free">I</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="bound">x</span><span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> setroots sum_negf<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> of_nat_sum<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> of_nat_eq_iff<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> e2<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> card_eq_sum<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> sum.mono_neutral_cong_right<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> List.finite_set setroots<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> gtchr ltchr obvzer setc
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main">∑</span><span class="bound">s</span><span class="main">←</span>characterize_consistent_signs_at_roots <span class="free">p</span> <span class="free">qs</span><span class="main">.</span> z_R <span class="free">I</span> <span class="bound">s</span> <span class="main">*</span> rat_of_int <span class="main">(</span>int <span class="main">(</span>card <span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> consistent_sign_vec <span class="free">qs</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">s</span><span class="main">}</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">s</span><span class="main">∈</span>set <span class="main">(</span>map <span class="main">(</span>consistent_sign_vec <span class="free">qs</span><span class="main">)</span> <span class="main">(</span>characterize_root_list_p <span class="free">p</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> z_R <span class="free">I</span> <span class="bound">s</span> <span class="main">*</span> rat_of_int <span class="main">(</span>int <span class="main">(</span>card <span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> consistent_sign_vec <span class="free">qs</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">s</span><span class="main">}</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹vec_of_list <span class="main">(</span>mtx_row_R <span class="main">(</span>characterize_consistent_signs_at_roots <span class="free">p</span> <span class="free">qs</span><span class="main">)</span> <span class="free">I</span><span class="main">)</span> <span class="main">∙</span> construct_lhs_vector_R <span class="free">p</span> <span class="free">qs</span> <span class="main">(</span>characterize_consistent_signs_at_roots <span class="free">p</span> <span class="free">qs</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">s</span><span class="main">←</span>characterize_consistent_signs_at_roots <span class="free">p</span> <span class="free">qs</span><span class="main">.</span> z_R <span class="free">I</span> <span class="bound">s</span> <span class="main">*</span> rat_of_int <span class="main">(</span>int <span class="main">(</span>card <span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> consistent_sign_vec <span class="free">qs</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">s</span><span class="main">}</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹vec_of_list <span class="main">(</span>mtx_row_R <span class="free">signs</span> <span class="free">I</span><span class="main">)</span> <span class="main">∙</span> construct_lhs_vector_R <span class="free">p</span> <span class="free">qs</span> <span class="free">signs</span> <span class="main">=</span> vec_of_list <span class="main">(</span>mtx_row_R <span class="main">(</span>characterize_consistent_signs_at_roots <span class="free">p</span> <span class="free">qs</span><span class="main">)</span> <span class="free">I</span><span class="main">)</span> <span class="main">∙</span> construct_lhs_vector_R <span class="free">p</span> <span class="free">qs</span> <span class="main">(</span>characterize_consistent_signs_at_roots <span class="free">p</span> <span class="free">qs</span><span class="main">)</span>›</span></span> setc1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
<span class="keyword1"><span class="command">qed</span></span>  

<span class="keyword1" id="Renegar_Proofs-matrix_equation_main_step_R"><span class="command">lemma</span></span> matrix_equation_main_step_R<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">p</span><span class="main">::</span> <span class="quoted"><span class="quoted">"real poly"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">qs</span><span class="main">::</span> <span class="quoted"><span class="quoted">"real poly list"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">I</span><span class="main">::</span> <span class="quoted"><span class="quoted">"nat list<span class="main">*</span>nat list"</span></span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">signs</span><span class="main">::</span> <span class="quoted"><span class="quoted">"rat list list"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> nonzero<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span><span class="main">≠</span><span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> distinct_signs<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="free">signs</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> all_info<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>characterize_consistent_signs_at_roots <span class="free">p</span> <span class="free">qs</span><span class="main">)</span> <span class="main">⊆</span> set<span class="main">(</span><span class="free">signs</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> welldefined1<span class="main">:</span> <span class="quoted"><span class="quoted">"list_constr <span class="main">(</span>fst <span class="free">I</span><span class="main">)</span> <span class="main">(</span>length <span class="free">qs</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> welldefined2<span class="main">:</span> <span class="quoted"><span class="quoted">"list_constr <span class="main">(</span>snd <span class="free">I</span><span class="main">)</span> <span class="main">(</span>length <span class="free">qs</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>vec_of_list <span class="main">(</span>mtx_row_R <span class="free">signs</span> <span class="free">I</span><span class="main">)</span> <span class="main">∙</span>
          <span class="main">(</span>construct_lhs_vector_R <span class="free">p</span> <span class="free">qs</span> <span class="free">signs</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>  
    construct_NofI_R <span class="free">p</span> <span class="main">(</span>retrieve_polys <span class="free">qs</span> <span class="main">(</span>fst <span class="free">I</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>retrieve_polys <span class="free">qs</span> <span class="main">(</span>snd <span class="free">I</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> construct_NofI_prop_R<span class="main">[</span><span class="operator">OF</span> nonzero<span class="main">]</span>
    <span class="keyword1"><span class="command">using</span></span> matrix_equation_helper_step_R<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Renegar_Proofs-mtx_row_length_R"><span class="command">lemma</span></span> mtx_row_length_R<span class="main">:</span>
  <span class="quoted"><span class="quoted">"list_all <span class="main">(</span><span class="main">λ</span><span class="bound">r</span><span class="main">.</span> length <span class="bound">r</span> <span class="main">=</span> length <span class="free">signs</span><span class="main">)</span> <span class="main">(</span>map <span class="main">(</span>mtx_row_R <span class="free">signs</span><span class="main">)</span> <span class="free">ls</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">ls</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mtx_row_R_def<span class="main">)</span>

<span class="comment1">(* Shows that as long as we have a "basis" of sign assignments (see assumptions all_info, welldefined), 
  and some other mild assumptions on our inputs (given in nonzero, distinct_signs), the construction 
  will be satisfied *)</span>
<span class="keyword1"><span class="command">theorem</span></span> matrix_equation_R<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">p</span><span class="main">::</span> <span class="quoted"><span class="quoted">"real poly"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">qs</span><span class="main">::</span> <span class="quoted"><span class="quoted">"real poly list"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">subsets</span><span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>nat list<span class="main">*</span>nat list<span class="main">)</span> list"</span></span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">signs</span><span class="main">::</span> <span class="quoted"><span class="quoted">"rat list list"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> nonzero<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span><span class="main">≠</span><span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> distinct_signs<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="free">signs</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> all_info<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>characterize_consistent_signs_at_roots <span class="free">p</span> <span class="free">qs</span><span class="main">)</span> <span class="main">⊆</span> set<span class="main">(</span><span class="free">signs</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> welldefined<span class="main">:</span> <span class="quoted"><span class="quoted">"all_list_constr_R <span class="main">(</span><span class="free">subsets</span><span class="main">)</span> <span class="main">(</span>length <span class="free">qs</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"satisfy_equation_R <span class="free">p</span> <span class="free">qs</span> <span class="free">subsets</span> <span class="free">signs</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> satisfy_equation_R_def matrix_A_R_def
    construct_lhs_vector_R_def construct_rhs_vector_R_def all_list_constr_R_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> mult_mat_vec_of_list<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mtx_row_length_R <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> map_vec_vec_of_list_eq_intro<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> matrix_equation_main_step_R<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1-3<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">unfolded</span> construct_lhs_vector_R_def<span class="main">]</span>
  <span class="keyword1"><span class="command">using</span></span> all_list_constr_R_def in_set_member welldefined <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="comment1">(* Prettifying some theorems*)</span>

<span class="keyword1" id="Renegar_Proofs-consistent_signs_at_roots_eq"><span class="command">lemma</span></span> consistent_signs_at_roots_eq<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"consistent_signs_at_roots <span class="free">p</span> <span class="free">qs</span> <span class="main">=</span>
         set <span class="main">(</span>characterize_consistent_signs_at_roots <span class="free">p</span> <span class="free">qs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> consistent_signs_at_roots_def characterize_consistent_signs_at_roots_def
    characterize_root_list_p_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> set_sorted_list_of_set<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> assms poly_roots_finite <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">unfolding</span></span> sgn_vec_def sgn_def signs_at_def squash_def o_def
  <span class="keyword1"><span class="command">using</span></span> roots_def <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> Collect_cong assms image_iff poly_roots_finite roots_def sorted_list_of_set<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">w_vec_R</span><span class="main">::</span> <span class="quoted"><span class="quoted">"real poly <span class="main">⇒</span> real poly list <span class="main">⇒</span> rat list list  <span class="main">⇒</span> rat vec"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">w_vec_R</span> <span class="main">≡</span> construct_lhs_vector_R"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">v_vec_R</span><span class="main">::</span> <span class="quoted"><span class="quoted">"real poly <span class="main">⇒</span> real poly list <span class="main">⇒</span> <span class="main">(</span>nat list<span class="main">*</span>nat list<span class="main">)</span> list <span class="main">⇒</span> rat vec"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">v_vec_R</span> <span class="main">≡</span> construct_rhs_vector_R"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">M_mat_R</span><span class="main">::</span> <span class="quoted"><span class="quoted">"rat list list <span class="main">⇒</span> <span class="main">(</span>nat list<span class="main">*</span>nat list<span class="main">)</span> list <span class="main">⇒</span> rat mat"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">M_mat_R</span> <span class="main">≡</span> matrix_A_R"</span></span>

<span class="keyword1"><span class="command">theorem</span></span> matrix_equation_pretty<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">subsets</span><span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>nat list<span class="main">*</span>nat list<span class="main">)</span> list"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span><span class="main">≠</span><span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"distinct <span class="free">signs</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"consistent_signs_at_roots <span class="free">p</span> <span class="free">qs</span> <span class="main">⊆</span> set <span class="free">signs</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">a</span> <span class="bound">b</span> <span class="bound">i</span><span class="main">.</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">b</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span> <span class="free">subsets</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">(</span><span class="bound">i</span> <span class="main">∈</span> set <span class="bound">a</span> <span class="main">∨</span> <span class="bound">i</span> <span class="main">∈</span> set <span class="bound">b</span><span class="main">)</span> <span class="main">⟹</span> <span class="bound">i</span> <span class="main">&lt;</span> length <span class="free">qs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"M_mat_R <span class="free">signs</span> <span class="free">subsets</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>v</sub></span> w_vec_R <span class="free">p</span> <span class="free">qs</span> <span class="free">signs</span> <span class="main">=</span> v_vec_R <span class="free">p</span> <span class="free">qs</span> <span class="free">subsets</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> satisfy_equation_R_def<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
  <span class="keyword1"><span class="command">using</span></span> matrix_equation_R<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">p</span></span> <span class="quoted"><span class="free">signs</span></span> <span class="quoted"><span class="free">qs</span></span> <span class="quoted"><span class="free">subsets</span></span><span class="main">]</span> assms 
  <span class="keyword1"><span class="command">using</span></span> consistent_signs_at_roots_eq <span class="keyword1"><span class="command">unfolding</span></span> all_list_constr_R_def list_constr_def <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> Ball_set in_set_member<span class="main">)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">"Base Case"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">satisfies_properties_R</span><span class="main">::</span> <span class="quoted"><span class="quoted">"real poly <span class="main">⇒</span> real poly list <span class="main">⇒</span> <span class="main">(</span>nat list<span class="main">*</span>nat list<span class="main">)</span> list <span class="main">⇒</span> rat list list <span class="main">⇒</span> rat mat <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">satisfies_properties_R</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">qs</span></span></span> <span class="free"><span class="bound"><span class="entity">subsets</span></span></span> <span class="free"><span class="bound"><span class="entity">signs</span></span></span> <span class="free"><span class="bound"><span class="entity">matrix</span></span></span> <span class="main">=</span> 
  <span class="main">(</span> all_list_constr_R <span class="free"><span class="bound"><span class="entity">subsets</span></span></span> <span class="main">(</span>length <span class="free"><span class="bound"><span class="entity">qs</span></span></span><span class="main">)</span> <span class="main">∧</span> well_def_signs <span class="main">(</span>length <span class="free"><span class="bound"><span class="entity">qs</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">signs</span></span></span> <span class="main">∧</span> distinct <span class="free"><span class="bound"><span class="entity">signs</span></span></span>
  <span class="main">∧</span> satisfy_equation_R <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">qs</span></span></span> <span class="free"><span class="bound"><span class="entity">subsets</span></span></span> <span class="free"><span class="bound"><span class="entity">signs</span></span></span> <span class="main">∧</span>  invertible_mat <span class="free"><span class="bound"><span class="entity">matrix</span></span></span>  <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">matrix</span></span></span> <span class="main">=</span> matrix_A_R <span class="free"><span class="bound"><span class="entity">signs</span></span></span> <span class="free"><span class="bound"><span class="entity">subsets</span></span></span>
  <span class="main">∧</span> set <span class="main">(</span>characterize_consistent_signs_at_roots <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">qs</span></span></span><span class="main">)</span> <span class="main">⊆</span> set<span class="main">(</span><span class="free"><span class="bound"><span class="entity">signs</span></span></span><span class="main">)</span>
  <span class="main">)</span>"</span></span>

<span class="keyword1" id="Renegar_Proofs-mat_base_case_R"><span class="command">lemma</span></span> mat_base_case_R<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"matrix_A_R <span class="main">[</span><span class="main">[</span><span class="main">1</span><span class="main">]</span><span class="main">,</span><span class="main">[</span><span class="main">0</span><span class="main">]</span><span class="main">,</span><span class="main">[</span><span class="main">-</span><span class="main">1</span><span class="main">]</span><span class="main">]</span> <span class="main">[</span><span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span><span class="main">,</span><span class="main">(</span><span class="main">[</span><span class="main">0</span><span class="main">]</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span><span class="main">,</span><span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="main">[</span><span class="main">0</span><span class="main">]</span><span class="main">)</span><span class="main">]</span> <span class="main">=</span> <span class="main">(</span>mat_of_rows_list <span class="numeral">3</span> <span class="main">[</span><span class="main">[</span><span class="main">1</span><span class="main">,</span><span class="main">1</span><span class="main">,</span><span class="main">1</span><span class="main">]</span><span class="main">,</span> <span class="main">[</span><span class="main">0</span><span class="main">,</span><span class="main">1</span><span class="main">,</span><span class="main">0</span><span class="main">]</span><span class="main">,</span> <span class="main">[</span><span class="main">1</span><span class="main">,</span><span class="main">0</span><span class="main">,</span><span class="main">-</span><span class="main">1</span><span class="main">]</span><span class="main">]</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> matrix_A_R_def mtx_row_R_def z_R_def map_sgas_def <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> numeral_3_eq_3<span class="main">)</span>

<span class="keyword1" id="Renegar_Proofs-base_case_sgas_R"><span class="command">lemma</span></span> base_case_sgas_R<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">q</span> <span class="free">p</span><span class="main">::</span> <span class="quoted"><span class="quoted">"real poly"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> nonzero<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>characterize_consistent_signs_at_roots <span class="free">p</span> <span class="main">[</span><span class="free">q</span><span class="main">]</span><span class="main">)</span> <span class="main">⊆</span> <span class="main">{</span><span class="main">[</span><span class="main">1</span><span class="main">]</span><span class="main">,</span><span class="main">[</span><span class="main">0</span><span class="main">]</span><span class="main">,</span> <span class="main">[</span><span class="main">-</span> <span class="main">1</span><span class="main">]</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> characterize_consistent_signs_at_roots_def signs_at_def  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> squash_def<span class="main">)</span> 

<span class="keyword1" id="Renegar_Proofs-base_case_sgas_alt_R"><span class="command">lemma</span></span> base_case_sgas_alt_R<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">p</span><span class="main">::</span> <span class="quoted"><span class="quoted">"real poly"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">qs</span><span class="main">::</span> <span class="quoted"><span class="quoted">"real poly list"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> len1<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">qs</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> nonzero<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>characterize_consistent_signs_at_roots <span class="free">p</span> <span class="free">qs</span><span class="main">)</span> <span class="main">⊆</span> <span class="main">{</span><span class="main">[</span><span class="main">1</span><span class="main">]</span><span class="main">,</span> <span class="main">[</span><span class="main">0</span><span class="main">]</span><span class="main">,</span> <span class="main">[</span><span class="main">-</span> <span class="main">1</span><span class="main">]</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
  <span class="keyword1"><span class="command">have</span></span> ex_q<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="main">(</span><span class="bound">q</span><span class="main">::</span>real poly<span class="main">)</span><span class="main">.</span> <span class="free">qs</span> <span class="main">=</span> <span class="main">[</span><span class="bound">q</span><span class="main">]</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> len1    
    <span class="keyword1"><span class="command">using</span></span> length_Suc_conv<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">qs</span></span> <span class="quoted"><span class="main">0</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> base_case_sgas_R nonzero 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Renegar_Proofs-base_case_satisfy_equation_R"><span class="command">lemma</span></span> base_case_satisfy_equation_R<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">q</span> <span class="free">p</span><span class="main">::</span> <span class="quoted"><span class="quoted">"real poly"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> nonzero<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"satisfy_equation_R <span class="free">p</span> <span class="main">[</span><span class="free">q</span><span class="main">]</span> <span class="main">[</span><span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span><span class="main">,</span><span class="main">(</span><span class="main">[</span><span class="main">0</span><span class="main">]</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span><span class="main">,</span><span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="main">[</span><span class="main">0</span><span class="main">]</span><span class="main">)</span><span class="main">]</span> <span class="main">[</span><span class="main">[</span><span class="main">1</span><span class="main">]</span><span class="main">,</span><span class="main">[</span><span class="main">0</span><span class="main">]</span><span class="main">,</span><span class="main">[</span><span class="main">-</span><span class="main">1</span><span class="main">]</span><span class="main">]</span> "</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
  <span class="keyword1"><span class="command">have</span></span> h1<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>characterize_consistent_signs_at_roots <span class="free">p</span> <span class="main">[</span><span class="free">q</span><span class="main">]</span><span class="main">)</span> <span class="main">⊆</span> <span class="main">{</span><span class="main">[</span><span class="main">1</span><span class="main">]</span><span class="main">,</span> <span class="main">[</span><span class="main">0</span><span class="main">]</span><span class="main">,</span><span class="main">[</span><span class="main">-</span> <span class="main">1</span><span class="main">]</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> base_case_sgas_R assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> h2<span class="main">:</span> <span class="quoted"><span class="quoted">"all_list_constr_R <span class="main">[</span><span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span><span class="main">,</span><span class="main">(</span><span class="main">[</span><span class="main">0</span><span class="main">]</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span><span class="main">,</span><span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="main">[</span><span class="main">0</span><span class="main">]</span><span class="main">)</span><span class="main">]</span> <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> all_list_constr_R_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> list_constr_def member_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> matrix_equation_R<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> p <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span>"</span></span><span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> qs <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">q</span><span class="main">]</span>"</span></span><span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> signs <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">[</span><span class="main">1</span><span class="main">]</span><span class="main">,</span><span class="main">[</span><span class="main">0</span><span class="main">]</span><span class="main">,</span><span class="main">[</span><span class="main">-</span><span class="main">1</span><span class="main">]</span><span class="main">]</span> "</span></span><span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> subsets <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span><span class="main">,</span><span class="main">(</span><span class="main">[</span><span class="main">0</span><span class="main">]</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span><span class="main">,</span><span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="main">[</span><span class="main">0</span><span class="main">]</span><span class="main">)</span><span class="main">]</span>"</span></span><span class="main">]</span>
      nonzero h1  h2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Renegar_Proofs-base_case_satisfy_equation_alt_R"><span class="command">lemma</span></span> base_case_satisfy_equation_alt_R<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">p</span><span class="main">::</span> <span class="quoted"><span class="quoted">"real poly"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">qs</span><span class="main">::</span> <span class="quoted"><span class="quoted">"real poly list"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> len1<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">qs</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> nonzero<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"satisfy_equation_R <span class="free">p</span> <span class="free">qs</span> <span class="main">[</span><span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span><span class="main">,</span><span class="main">(</span><span class="main">[</span><span class="main">0</span><span class="main">]</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span><span class="main">,</span><span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="main">[</span><span class="main">0</span><span class="main">]</span><span class="main">)</span><span class="main">]</span> <span class="main">[</span><span class="main">[</span><span class="main">1</span><span class="main">]</span><span class="main">,</span><span class="main">[</span><span class="main">0</span><span class="main">]</span><span class="main">,</span><span class="main">[</span><span class="main">-</span><span class="main">1</span><span class="main">]</span><span class="main">]</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
  <span class="keyword1"><span class="command">have</span></span> ex_q<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="main">(</span><span class="bound">q</span><span class="main">::</span>real poly<span class="main">)</span><span class="main">.</span> <span class="free">qs</span> <span class="main">=</span> <span class="main">[</span><span class="bound">q</span><span class="main">]</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> len1    
    <span class="keyword1"><span class="command">using</span></span> length_Suc_conv<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">qs</span></span> <span class="quoted"><span class="main">0</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> base_case_satisfy_equation_R nonzero
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Renegar_Proofs-base_case_matrix_eq"><span class="command">lemma</span></span> base_case_matrix_eq<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">q</span> <span class="free">p</span><span class="main">::</span> <span class="quoted"><span class="quoted">"real poly"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> nonzero<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>mult_mat_vec <span class="main">(</span>mat_of_rows_list <span class="numeral">3</span> <span class="main">[</span><span class="main">[</span><span class="main">1</span><span class="main">,</span><span class="main">1</span><span class="main">,</span><span class="main">1</span><span class="main">]</span><span class="main">,</span> <span class="main">[</span><span class="main">0</span><span class="main">,</span><span class="main">1</span><span class="main">,</span><span class="main">0</span><span class="main">]</span><span class="main">,</span> <span class="main">[</span><span class="main">1</span><span class="main">,</span><span class="main">0</span><span class="main">,</span><span class="main">-</span><span class="main">1</span><span class="main">]</span><span class="main">]</span><span class="main">)</span> <span class="main">(</span>construct_lhs_vector_R <span class="free">p</span> <span class="main">[</span><span class="free">q</span><span class="main">]</span> <span class="main">[</span><span class="main">[</span><span class="main">1</span><span class="main">]</span><span class="main">,</span><span class="main">[</span><span class="main">0</span><span class="main">]</span><span class="main">,</span><span class="main">[</span><span class="main">-</span><span class="main">1</span><span class="main">]</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> 
    <span class="main">(</span>construct_rhs_vector_R <span class="free">p</span> <span class="main">[</span><span class="free">q</span><span class="main">]</span> <span class="main">[</span><span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span><span class="main">,</span><span class="main">(</span><span class="main">[</span><span class="main">0</span><span class="main">]</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span><span class="main">,</span><span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="main">[</span><span class="main">0</span><span class="main">]</span><span class="main">)</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>                      
  <span class="keyword1"><span class="command">using</span></span> mat_base_case_R base_case_satisfy_equation_R <span class="keyword1"><span class="command">unfolding</span></span> satisfy_equation_R_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nonzero<span class="main">)</span>

<span class="keyword1" id="Renegar_Proofs-less_three"><span class="command">lemma</span></span> less_three<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">n</span><span class="main">::</span>nat<span class="main">)</span> <span class="main">&lt;</span> Suc <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">⟷</span> <span class="free">n</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∨</span> <span class="free">n</span> <span class="main">=</span> <span class="main">1</span> <span class="main">∨</span> <span class="free">n</span> <span class="main">=</span> <span class="numeral">2</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Renegar_Proofs-inverse_mat_base_case_R"><span class="command">lemma</span></span> inverse_mat_base_case_R<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"inverts_mat <span class="main">(</span>mat_of_rows_list <span class="numeral">3</span>  <span class="main">[</span><span class="main">[</span><span class="main">1</span><span class="main">/</span><span class="numeral">2</span><span class="main">,</span> <span class="main">-</span><span class="main">1</span><span class="main">/</span><span class="numeral">2</span><span class="main">,</span> <span class="main">1</span><span class="main">/</span><span class="numeral">2</span><span class="main">]</span><span class="main">,</span> <span class="main">[</span><span class="main">0</span><span class="main">,</span> <span class="main">1</span><span class="main">,</span> <span class="main">0</span><span class="main">]</span><span class="main">,</span> <span class="main">[</span><span class="main">1</span><span class="main">/</span><span class="numeral">2</span><span class="main">,</span> <span class="main">-</span><span class="main">1</span><span class="main">/</span><span class="numeral">2</span><span class="main">,</span> <span class="main">-</span><span class="main">1</span><span class="main">/</span><span class="numeral">2</span><span class="main">]</span><span class="main">]</span><span class="main">::</span>rat mat<span class="main">)</span> <span class="main">(</span>mat_of_rows_list <span class="numeral">3</span> <span class="main">[</span><span class="main">[</span><span class="main">1</span><span class="main">,</span><span class="main">1</span><span class="main">,</span><span class="main">1</span><span class="main">]</span><span class="main">,</span> <span class="main">[</span><span class="main">0</span><span class="main">,</span><span class="main">1</span><span class="main">,</span><span class="main">0</span><span class="main">]</span><span class="main">,</span> <span class="main">[</span><span class="main">1</span><span class="main">,</span><span class="main">0</span><span class="main">,</span><span class="main">-</span><span class="main">1</span><span class="main">]</span><span class="main">]</span><span class="main">::</span>rat mat<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> inverts_mat_def mat_of_rows_list_def mat_eq_iff <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">unfolding</span></span> less_three <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> scalar_prod_def<span class="main">)</span>

<span class="keyword1" id="Renegar_Proofs-inverse_mat_base_case_2_R"><span class="command">lemma</span></span> inverse_mat_base_case_2_R<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"inverts_mat <span class="main">(</span>mat_of_rows_list <span class="numeral">3</span> <span class="main">[</span><span class="main">[</span><span class="main">1</span><span class="main">,</span><span class="main">1</span><span class="main">,</span><span class="main">1</span><span class="main">]</span><span class="main">,</span> <span class="main">[</span><span class="main">0</span><span class="main">,</span><span class="main">1</span><span class="main">,</span><span class="main">0</span><span class="main">]</span><span class="main">,</span> <span class="main">[</span><span class="main">1</span><span class="main">,</span><span class="main">0</span><span class="main">,</span><span class="main">-</span><span class="main">1</span><span class="main">]</span><span class="main">]</span><span class="main">::</span>rat mat<span class="main">)</span> <span class="main">(</span>mat_of_rows_list <span class="numeral">3</span>  <span class="main">[</span><span class="main">[</span><span class="main">1</span><span class="main">/</span><span class="numeral">2</span><span class="main">,</span> <span class="main">-</span><span class="main">1</span><span class="main">/</span><span class="numeral">2</span><span class="main">,</span> <span class="main">1</span><span class="main">/</span><span class="numeral">2</span><span class="main">]</span><span class="main">,</span> <span class="main">[</span><span class="main">0</span><span class="main">,</span> <span class="main">1</span><span class="main">,</span> <span class="main">0</span><span class="main">]</span><span class="main">,</span> <span class="main">[</span><span class="main">1</span><span class="main">/</span><span class="numeral">2</span><span class="main">,</span> <span class="main">-</span><span class="main">1</span><span class="main">/</span><span class="numeral">2</span><span class="main">,</span> <span class="main">-</span><span class="main">1</span><span class="main">/</span><span class="numeral">2</span><span class="main">]</span><span class="main">]</span><span class="main">::</span> rat mat<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> inverts_mat_def mat_of_rows_list_def mat_eq_iff <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">unfolding</span></span> less_three <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> scalar_prod_def<span class="main">)</span>

<span class="keyword1" id="Renegar_Proofs-base_case_invertible_mat_R"><span class="command">lemma</span></span> base_case_invertible_mat_R<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"invertible_mat <span class="main">(</span>matrix_A_R <span class="main">[</span><span class="main">[</span><span class="main">1</span><span class="main">]</span><span class="main">,</span><span class="main">[</span><span class="main">0</span><span class="main">]</span><span class="main">,</span> <span class="main">[</span><span class="main">-</span> <span class="main">1</span><span class="main">]</span><span class="main">]</span> <span class="main">[</span><span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span><span class="main">,</span><span class="main">(</span><span class="main">[</span><span class="main">0</span><span class="main">]</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span><span class="main">,</span><span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="main">[</span><span class="main">0</span><span class="main">]</span><span class="main">)</span><span class="main">]</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> invertible_mat_def <span class="keyword1"><span class="command">using</span></span> inverse_mat_base_case_R inverse_mat_base_case_2_R
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mat_base_case mat_of_rows_list_def<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> mat_base_case_R <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">"Inductive Step"</span></span>

<span class="comment1">(***** Need some properties of smashing; smashing signs is just as it was in BKR *****)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Lemmas on smashing subsets "</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">subsets_first_component_list</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="main">(</span>nat list<span class="main">*</span>nat list<span class="main">)</span> list <span class="main">⇒</span> nat list list"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">subsets_first_component_list</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="main">=</span> map <span class="main">(</span><span class="main">λ</span><span class="bound">I</span><span class="main">.</span> <span class="main">(</span>fst <span class="bound">I</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">subsets_second_component_list</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="main">(</span>nat list<span class="main">*</span>nat list<span class="main">)</span> list <span class="main">⇒</span> nat list list"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">subsets_second_component_list</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="main">=</span> map <span class="main">(</span><span class="main">λ</span><span class="bound">I</span><span class="main">.</span> <span class="main">(</span>snd <span class="bound">I</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">smash_list_list</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> list<span class="main">*</span><span class="tfree">'a</span> list<span class="main">)</span> list <span class="main">⇒</span>  <span class="main">(</span><span class="tfree">'a</span> list<span class="main">*</span><span class="tfree">'a</span> list<span class="main">)</span> list <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> list<span class="main">*</span><span class="tfree">'a</span> list<span class="main">)</span> list"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">smash_list_list</span> <span class="free"><span class="bound"><span class="entity">s1</span></span></span> <span class="free"><span class="bound"><span class="entity">s2</span></span></span> <span class="main">=</span> concat <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">l1</span><span class="main">.</span> map <span class="main">(</span><span class="main">λ</span><span class="bound">l2</span><span class="main">.</span> <span class="main">(</span>fst <span class="bound">l1</span> <span class="main">@</span> fst <span class="bound">l2</span><span class="main">,</span> snd <span class="bound">l1</span> <span class="main">@</span> snd <span class="bound">l2</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">s2</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">s1</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Renegar_Proofs-smash_list_list_property_set"><span class="command">lemma</span></span> smash_list_list_property_set<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">l1</span> <span class="free">l2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> list<span class="main">*</span><span class="tfree">'a</span> list<span class="main">)</span> list"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">a</span> <span class="free">b</span><span class="main">::</span> <span class="quoted"><span class="quoted">"nat"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="main">(</span><span class="bound">elem</span> <span class="main">::</span> <span class="main">(</span><span class="tfree">'a</span> list<span class="main">*</span><span class="tfree">'a</span> list<span class="main">)</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">elem</span> <span class="main">∈</span> <span class="main">(</span>set <span class="main">(</span>smash_list_list <span class="free">l1</span> <span class="free">l2</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span> 
    <span class="main">(</span><span class="main">∃</span> <span class="main">(</span><span class="bound">elem1</span><span class="main">::</span> <span class="main">(</span><span class="tfree">'a</span> list<span class="main">*</span><span class="tfree">'a</span> list<span class="main">)</span><span class="main">)</span><span class="main">.</span> <span class="main">∃</span> <span class="main">(</span><span class="bound">elem2</span><span class="main">::</span> <span class="main">(</span><span class="tfree">'a</span> list<span class="main">*</span><span class="tfree">'a</span> list<span class="main">)</span><span class="main">)</span><span class="main">.</span> 
      <span class="main">(</span><span class="bound">elem1</span> <span class="main">∈</span> set<span class="main">(</span><span class="free">l1</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">elem2</span> <span class="main">∈</span> set<span class="main">(</span><span class="free">l2</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">elem</span> <span class="main">=</span> <span class="main">(</span>fst <span class="bound">elem1</span><span class="main">@</span> fst <span class="bound">elem2</span><span class="main">,</span> snd <span class="bound">elem1</span> <span class="main">@</span> snd <span class="bound">elem2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">clarsimp</span> 
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span> <span class="skolem">b</span> 
  <span class="keyword3"><span class="command">assume</span></span> assum<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">a</span><span class="main">,</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>smash_list_list <span class="free">l1</span> <span class="free">l2</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">aa</span> <span class="bound">ba</span><span class="main">.</span> <span class="main">(</span><span class="bound">aa</span><span class="main">,</span> <span class="bound">ba</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">l1</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span><span class="bound">ab</span> <span class="bound">bb</span><span class="main">.</span> <span class="main">(</span><span class="bound">ab</span><span class="main">,</span> <span class="bound">bb</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">l2</span> <span class="main">∧</span> <span class="skolem">a</span> <span class="main">=</span> <span class="bound">aa</span> <span class="main">@</span> <span class="bound">ab</span> <span class="main">∧</span> <span class="skolem">b</span> <span class="main">=</span> <span class="bound">ba</span> <span class="main">@</span> <span class="bound">bb</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assum <span class="keyword1"><span class="command">unfolding</span></span> smash_list_list_def 
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1" id="Renegar_Proofs-subsets_smash_property_R"><span class="command">lemma</span></span> subsets_smash_property_R<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">subsets1</span> <span class="free">subsets2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>nat list<span class="main">*</span>nat list<span class="main">)</span> list"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">n</span><span class="main">::</span> <span class="quoted"><span class="quoted">"nat"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="main">(</span><span class="bound">elem</span> <span class="main">::</span> nat list<span class="main">*</span>nat list<span class="main">)</span><span class="main">.</span> <span class="main">(</span>List.member <span class="main">(</span>subsets_smash_R <span class="free">n</span> <span class="free">subsets1</span> <span class="free">subsets2</span><span class="main">)</span> <span class="bound">elem</span><span class="main">)</span> <span class="main">⟶</span> 
    <span class="main">(</span><span class="main">∃</span> <span class="main">(</span><span class="bound">elem1</span><span class="main">::</span>nat list<span class="main">*</span>nat list<span class="main">)</span><span class="main">.</span> <span class="main">∃</span> <span class="main">(</span><span class="bound">elem2</span><span class="main">::</span>nat list<span class="main">*</span>nat list<span class="main">)</span><span class="main">.</span>
      <span class="main">(</span><span class="bound">elem1</span> <span class="main">∈</span> set<span class="main">(</span><span class="free">subsets1</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">elem2</span> <span class="main">∈</span> set<span class="main">(</span><span class="free">subsets2</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">elem</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span>fst <span class="bound">elem1</span><span class="main">)</span> <span class="main">@</span> <span class="main">(</span>map <span class="main">(</span><span class="main">(+)</span> <span class="free">n</span><span class="main">)</span> <span class="main">(</span>fst <span class="bound">elem2</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>snd <span class="bound">elem1</span><span class="main">)</span> <span class="main">@</span> <span class="main">(</span>map <span class="main">(</span><span class="main">(+)</span> <span class="free">n</span><span class="main">)</span> <span class="main">(</span>snd <span class="bound">elem2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?fst_component2</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"subsets_first_component_list <span class="free">subsets2</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?snd_component2</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"subsets_second_component_list <span class="free">subsets2</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?new_subsets</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"map <span class="main">(</span><span class="main">λ</span><span class="bound">I</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span>map <span class="main">(</span><span class="main">(+)</span> <span class="free">n</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>fst <span class="bound">I</span><span class="main">)</span><span class="main">,</span>  <span class="main">(</span>map <span class="main">(</span><span class="main">(+)</span> <span class="free">n</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>snd <span class="bound">I</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">subsets2</span>"</span></span>
    <span class="comment1">(* a slightly unorthodox use of signs_smash, but it closes the proof *)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"subsets_smash_R <span class="free">n</span> <span class="free">subsets1</span> <span class="free">subsets2</span> <span class="main">=</span> smash_list_list <span class="free">subsets1</span> <span class="var">?new_subsets</span>"</span></span> 
    <span class="keyword1"><span class="command">unfolding</span></span> subsets_smash_R_def smash_list_list_def <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> comp_def<span class="main">)</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> smash_list_list_property_set<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">subsets1</span></span> <span class="var"><span class="quoted"><span class="var">?new_subsets</span></span></span><span class="main">]</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> imageE in_set_member set_map smash_list_list_property_set
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> <span class="main"><span class="main">(</span></span>z3<span class="main"><span class="main">)</span></span> prod.exhaust_sel<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(* If subsets for smaller systems are well-defined, then subsets for combined systems are, too *)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Well-defined subsets preserved when smashing"</span></span>

<span class="keyword1" id="Renegar_Proofs-well_def_step_R"><span class="command">lemma</span></span> well_def_step_R<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">qs1</span> <span class="free">qs2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real poly list"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">subsets1</span> <span class="free">subsets2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>nat list<span class="main">*</span>nat list<span class="main">)</span> list"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> well_def_subsets1<span class="main">:</span> <span class="quoted"><span class="quoted">"all_list_constr_R <span class="main">(</span><span class="free">subsets1</span><span class="main">)</span> <span class="main">(</span>length <span class="free">qs1</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> well_def_subsets2<span class="main">:</span> <span class="quoted"><span class="quoted">"all_list_constr_R <span class="main">(</span><span class="free">subsets2</span><span class="main">)</span> <span class="main">(</span>length <span class="free">qs2</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"all_list_constr_R <span class="main">(</span><span class="main">(</span>subsets_smash_R <span class="main">(</span>length <span class="free">qs1</span><span class="main">)</span> <span class="free">subsets1</span> <span class="free">subsets2</span><span class="main">)</span><span class="main">)</span>
     <span class="main">(</span>length <span class="main">(</span><span class="free">qs1</span> <span class="main">@</span> <span class="free">qs2</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?n</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>length <span class="free">qs1</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> h1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">elem</span><span class="main">.</span>
     List.member <span class="main">(</span>subsets_smash_R <span class="var">?n</span> <span class="free">subsets1</span> <span class="free">subsets2</span><span class="main">)</span> <span class="bound">elem</span> <span class="main">⟶</span>
     <span class="main">(</span><span class="main">∃</span> <span class="main">(</span><span class="bound">elem1</span><span class="main">::</span>nat list<span class="main">*</span>nat list<span class="main">)</span><span class="main">.</span> <span class="main">∃</span> <span class="main">(</span><span class="bound">elem2</span><span class="main">::</span>nat list<span class="main">*</span>nat list<span class="main">)</span><span class="main">.</span>
      <span class="main">(</span><span class="bound">elem1</span> <span class="main">∈</span> set<span class="main">(</span><span class="free">subsets1</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">elem2</span> <span class="main">∈</span> set<span class="main">(</span><span class="free">subsets2</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">elem</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span>fst <span class="bound">elem1</span><span class="main">)</span> <span class="main">@</span> <span class="main">(</span>map <span class="main">(</span><span class="main">(+)</span> <span class="var">?n</span><span class="main">)</span> <span class="main">(</span>fst <span class="bound">elem2</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>snd <span class="bound">elem1</span><span class="main">)</span> <span class="main">@</span> <span class="main">(</span>map <span class="main">(</span><span class="main">(+)</span> <span class="var">?n</span><span class="main">)</span> <span class="main">(</span>snd <span class="bound">elem2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> subsets_smash_property_R <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> h2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">elem1</span> <span class="bound">elem2</span><span class="main">.</span> <span class="main">(</span><span class="bound">elem1</span> <span class="main">∈</span> set <span class="free">subsets1</span> <span class="main">∧</span> <span class="bound">elem2</span> <span class="main">∈</span> set <span class="free">subsets2</span><span class="main">)</span> <span class="main">⟶</span> list_constr <span class="main">(</span><span class="main">(</span>fst <span class="bound">elem1</span><span class="main">)</span> <span class="main">@</span> map <span class="main">(</span><span class="main">(+)</span> <span class="main">(</span>length <span class="free">qs1</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>fst <span class="bound">elem2</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>length <span class="main">(</span><span class="free">qs1</span> <span class="main">@</span> <span class="free">qs2</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">clarsimp</span> 
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">elem1</span> <span class="skolem">b</span> <span class="skolem">elem2</span> <span class="skolem">ba</span>
    <span class="keyword3"><span class="command">assume</span></span> e1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">elem1</span><span class="main">,</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">subsets1</span>"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> e2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">elem2</span><span class="main">,</span> <span class="skolem">ba</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">subsets2</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> h1<span class="main">:</span> <span class="quoted"><span class="quoted">"list_constr <span class="skolem">elem1</span>  <span class="main">(</span>length <span class="free">qs1</span> <span class="main">+</span> length <span class="free">qs2</span><span class="main">)</span> "</span></span> 
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
      <span class="keyword1"><span class="command">have</span></span> h1<span class="main">:</span> <span class="quoted"><span class="quoted">"list_constr <span class="skolem">elem1</span>  <span class="main">(</span>length <span class="free">qs1</span><span class="main">)</span>"</span></span>  <span class="keyword1"><span class="command">using</span></span> e1 well_def_subsets1
        <span class="keyword1"><span class="command">unfolding</span></span> all_list_constr_R_def
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> in_set_member<span class="main">)</span> 
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> list_constr_def
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> list.pred_mono_strong<span class="main">)</span> 
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">have</span></span> h2<span class="main">:</span> <span class="quoted"><span class="quoted">"list_constr <span class="main">(</span>map <span class="main">(</span><span class="main">(+)</span> <span class="main">(</span>length <span class="free">qs1</span><span class="main">)</span><span class="main">)</span> <span class="skolem">elem2</span><span class="main">)</span> <span class="main">(</span>length <span class="free">qs1</span> <span class="main">+</span> length <span class="free">qs2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
      <span class="keyword1"><span class="command">have</span></span> h1<span class="main">:</span> <span class="quoted"><span class="quoted">"list_constr <span class="skolem">elem2</span>  <span class="main">(</span>length <span class="free">qs2</span><span class="main">)</span>"</span></span>  <span class="keyword1"><span class="command">using</span></span> e2 well_def_subsets2 
        <span class="keyword1"><span class="command">unfolding</span></span> all_list_constr_R_def
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> in_set_member<span class="main">)</span> 
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> list_constr_def
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> list_all_length<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"list_constr <span class="main">(</span><span class="skolem">elem1</span> <span class="main">@</span> map <span class="main">(</span><span class="main">(+)</span> <span class="main">(</span>length <span class="free">qs1</span><span class="main">)</span><span class="main">)</span> <span class="skolem">elem2</span><span class="main">)</span> <span class="main">(</span>length <span class="free">qs1</span> <span class="main">+</span> length <span class="free">qs2</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> h1 h2 list_constr_append
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">have</span></span> h3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">elem1</span> <span class="bound">elem2</span><span class="main">.</span> <span class="main">(</span><span class="bound">elem1</span> <span class="main">∈</span> set <span class="free">subsets1</span> <span class="main">∧</span> <span class="bound">elem2</span> <span class="main">∈</span> set <span class="free">subsets2</span><span class="main">)</span> <span class="main">⟶</span> list_constr <span class="main">(</span><span class="main">(</span>snd <span class="bound">elem1</span><span class="main">)</span> <span class="main">@</span> map <span class="main">(</span><span class="main">(+)</span> <span class="main">(</span>length <span class="free">qs1</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>snd <span class="bound">elem2</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>length <span class="main">(</span><span class="free">qs1</span> <span class="main">@</span> <span class="free">qs2</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">clarsimp</span> 
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">elem1</span> <span class="skolem">b</span> <span class="skolem">elem2</span> <span class="skolem">ba</span>
    <span class="keyword3"><span class="command">assume</span></span> e1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">b</span><span class="main">,</span> <span class="skolem">elem1</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">subsets1</span>"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> e2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">ba</span><span class="main">,</span> <span class="skolem">elem2</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">subsets2</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> h1<span class="main">:</span> <span class="quoted"><span class="quoted">"list_constr <span class="skolem">elem1</span>  <span class="main">(</span>length <span class="free">qs1</span> <span class="main">+</span> length <span class="free">qs2</span><span class="main">)</span> "</span></span> 
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
      <span class="keyword1"><span class="command">have</span></span> h1<span class="main">:</span> <span class="quoted"><span class="quoted">"list_constr <span class="skolem">elem1</span>  <span class="main">(</span>length <span class="free">qs1</span><span class="main">)</span>"</span></span>  <span class="keyword1"><span class="command">using</span></span> e1 well_def_subsets1
        <span class="keyword1"><span class="command">unfolding</span></span> all_list_constr_R_def
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> in_set_member<span class="main">)</span> 
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> list_constr_def
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> list.pred_mono_strong<span class="main">)</span> 
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">have</span></span> h2<span class="main">:</span> <span class="quoted"><span class="quoted">"list_constr <span class="main">(</span>map <span class="main">(</span><span class="main">(+)</span> <span class="main">(</span>length <span class="free">qs1</span><span class="main">)</span><span class="main">)</span> <span class="skolem">elem2</span><span class="main">)</span> <span class="main">(</span>length <span class="free">qs1</span> <span class="main">+</span> length <span class="free">qs2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
      <span class="keyword1"><span class="command">have</span></span> h1<span class="main">:</span> <span class="quoted"><span class="quoted">"list_constr <span class="skolem">elem2</span>  <span class="main">(</span>length <span class="free">qs2</span><span class="main">)</span>"</span></span>  <span class="keyword1"><span class="command">using</span></span> e2 well_def_subsets2 
        <span class="keyword1"><span class="command">unfolding</span></span> all_list_constr_R_def
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> in_set_member<span class="main">)</span> 
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> list_constr_def
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> list_all_length<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"list_constr <span class="main">(</span><span class="skolem">elem1</span> <span class="main">@</span> map <span class="main">(</span><span class="main">(+)</span> <span class="main">(</span>length <span class="free">qs1</span><span class="main">)</span><span class="main">)</span> <span class="skolem">elem2</span><span class="main">)</span> <span class="main">(</span>length <span class="free">qs1</span> <span class="main">+</span> length <span class="free">qs2</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> h1 h2 list_constr_append
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> h1 h2 h3 <span class="keyword1"><span class="command">unfolding</span></span> all_list_constr_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> all_list_constr_R_def fst_conv snd_conv<span class="main">)</span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Consistent Sign Assignments Preserved When Smashing"</span></span>

<span class="keyword1" id="Renegar_Proofs-subset_helper_R"><span class="command">lemma</span></span> subset_helper_R<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">p</span><span class="main">::</span> <span class="quoted"><span class="quoted">"real poly"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">qs1</span> <span class="free">qs2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real poly list"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">signs1</span> <span class="free">signs2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"rat list list"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">x</span> <span class="main">∈</span> set <span class="main">(</span>characterize_consistent_signs_at_roots <span class="free">p</span> <span class="main">(</span><span class="free">qs1</span> <span class="main">@</span> <span class="free">qs2</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> 
        <span class="main">∃</span> <span class="bound">x1</span> <span class="main">∈</span> set <span class="main">(</span>characterize_consistent_signs_at_roots <span class="free">p</span> <span class="free">qs1</span><span class="main">)</span><span class="main">.</span> 
        <span class="main">∃</span> <span class="bound">x2</span> <span class="main">∈</span> set <span class="main">(</span>characterize_consistent_signs_at_roots <span class="free">p</span> <span class="free">qs2</span><span class="main">)</span><span class="main">.</span>
        <span class="bound">x</span> <span class="main">=</span> <span class="bound">x1</span><span class="main">@</span><span class="bound">x2</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">clarsimp</span> 
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
  <span class="keyword3"><span class="command">assume</span></span>  x_in<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> set <span class="main">(</span>characterize_consistent_signs_at_roots <span class="free">p</span> <span class="main">(</span><span class="free">qs1</span> <span class="main">@</span> <span class="free">qs2</span><span class="main">)</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">have</span></span> x_in_csv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> set<span class="main">(</span>map <span class="main">(</span>consistent_sign_vec <span class="main">(</span><span class="free">qs1</span> <span class="main">@</span> <span class="free">qs2</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>characterize_root_list_p <span class="free">p</span><span class="main">)</span><span class="main">)</span>"</span></span>  
    <span class="keyword1"><span class="command">using</span></span> x_in <span class="keyword1"><span class="command">unfolding</span></span> characterize_consistent_signs_at_roots_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> <span class="main"><span class="main">(</span></span>z3<span class="main"><span class="main">)</span></span> consistent_sign_vec_def map_eq_conv o_apply set_remdups signs_at_def squash_def<span class="main">)</span> 
  <span class="keyword1"><span class="command">have</span></span> csv_hyp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">r</span><span class="main">.</span> consistent_sign_vec <span class="main">(</span><span class="free">qs1</span> <span class="main">@</span> <span class="free">qs2</span><span class="main">)</span> <span class="bound">r</span> <span class="main">=</span> <span class="main">(</span>consistent_sign_vec <span class="free">qs1</span> <span class="bound">r</span><span class="main">)</span><span class="main">@</span><span class="main">(</span>consistent_sign_vec <span class="free">qs2</span> <span class="bound">r</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> consistent_sign_vec_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> exr_iff<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound">r</span> <span class="main">∈</span> set <span class="main">(</span>characterize_root_list_p <span class="free">p</span><span class="main">)</span><span class="main">.</span> <span class="skolem">x</span> <span class="main">=</span> consistent_sign_vec <span class="main">(</span><span class="free">qs1</span> <span class="main">@</span> <span class="free">qs2</span><span class="main">)</span> <span class="bound">r</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">r</span> <span class="main">∈</span> set <span class="main">(</span>characterize_root_list_p <span class="free">p</span><span class="main">)</span><span class="main">.</span> <span class="skolem">x</span> <span class="main">=</span> <span class="main">(</span>consistent_sign_vec <span class="free">qs1</span> <span class="bound">r</span><span class="main">)</span><span class="main">@</span><span class="main">(</span>consistent_sign_vec <span class="free">qs2</span> <span class="bound">r</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> csv_hyp <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> exr<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> set<span class="main">(</span>map <span class="main">(</span>consistent_sign_vec <span class="main">(</span><span class="free">qs1</span> <span class="main">@</span> <span class="free">qs2</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>characterize_root_list_p <span class="free">p</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">r</span> <span class="main">∈</span> set <span class="main">(</span>characterize_root_list_p <span class="free">p</span><span class="main">)</span><span class="main">.</span> <span class="skolem">x</span> <span class="main">=</span> consistent_sign_vec <span class="main">(</span><span class="free">qs1</span> <span class="main">@</span> <span class="free">qs2</span><span class="main">)</span> <span class="bound">r</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> mem_list1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">r</span> <span class="main">∈</span> set <span class="main">(</span>characterize_root_list_p <span class="free">p</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span>consistent_sign_vec <span class="free">qs1</span> <span class="bound">r</span><span class="main">)</span> <span class="main">∈</span> set<span class="main">(</span>map <span class="main">(</span>consistent_sign_vec <span class="free">qs1</span><span class="main">)</span> <span class="main">(</span>characterize_root_list_p <span class="free">p</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> mem_list2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">r</span> <span class="main">∈</span> set <span class="main">(</span>characterize_root_list_p <span class="free">p</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span>consistent_sign_vec <span class="free">qs2</span> <span class="bound">r</span><span class="main">)</span> <span class="main">∈</span> set<span class="main">(</span>map <span class="main">(</span>consistent_sign_vec <span class="free">qs2</span><span class="main">)</span> <span class="main">(</span>characterize_root_list_p <span class="free">p</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">x1</span><span class="main">∈</span>set <span class="main">(</span>characterize_consistent_signs_at_roots <span class="free">p</span> <span class="free">qs1</span><span class="main">)</span><span class="main">.</span>
            <span class="main">∃</span><span class="bound">x2</span><span class="main">∈</span>set <span class="main">(</span>characterize_consistent_signs_at_roots <span class="free">p</span> <span class="free">qs2</span><span class="main">)</span><span class="main">.</span> <span class="skolem">x</span> <span class="main">=</span> <span class="bound">x1</span> <span class="main">@</span> <span class="bound">x2</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> x_in_csv exr mem_list1 mem_list2 characterize_consistent_signs_at_roots_def exr_iff
    <span class="keyword1"><span class="command">using</span></span> imageE image_eqI map_append set_map set_remdups signs_at_def x_in
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Renegar_Proofs-subset_step_R"><span class="command">lemma</span></span> subset_step_R<span class="main">:</span>  
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">p</span><span class="main">::</span> <span class="quoted"><span class="quoted">"real poly"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">qs1</span> <span class="free">qs2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real poly list"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">signs1</span> <span class="free">signs2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"rat list list"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> csa1<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>characterize_consistent_signs_at_roots <span class="free">p</span> <span class="free">qs1</span><span class="main">)</span> <span class="main">⊆</span> set <span class="main">(</span><span class="free">signs1</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> csa2<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>characterize_consistent_signs_at_roots <span class="free">p</span> <span class="free">qs2</span><span class="main">)</span> <span class="main">⊆</span> set <span class="main">(</span><span class="free">signs2</span><span class="main">)</span>"</span></span>  
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>characterize_consistent_signs_at_roots <span class="free">p</span>
          <span class="main">(</span><span class="free">qs1</span> <span class="main">@</span> <span class="free">qs2</span><span class="main">)</span><span class="main">)</span>
    <span class="main">⊆</span> set <span class="main">(</span>signs_smash <span class="free">signs1</span> <span class="free">signs2</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
  <span class="keyword1"><span class="command">have</span></span> h0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">x</span> <span class="main">∈</span> set <span class="main">(</span>characterize_consistent_signs_at_roots <span class="free">p</span> <span class="main">(</span><span class="free">qs1</span> <span class="main">@</span> <span class="free">qs2</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> <span class="main">∃</span> <span class="bound">x1</span> <span class="main">∈</span> set <span class="main">(</span>characterize_consistent_signs_at_roots <span class="free">p</span> <span class="free">qs1</span><span class="main">)</span><span class="main">.</span> <span class="main">∃</span> <span class="bound">x2</span> <span class="main">∈</span> set <span class="main">(</span>characterize_consistent_signs_at_roots <span class="free">p</span> <span class="free">qs2</span><span class="main">)</span><span class="main">.</span>
     <span class="main">(</span><span class="bound">x</span> <span class="main">=</span> <span class="bound">x1</span><span class="main">@</span><span class="bound">x2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> subset_helper_R<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">p</span></span> <span class="quoted"><span class="free">qs1</span></span> <span class="quoted"><span class="free">qs2</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> set <span class="main">(</span>characterize_consistent_signs_at_roots <span class="free">p</span> <span class="main">(</span><span class="free">qs1</span> <span class="main">@</span> <span class="free">qs2</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> 
          <span class="bound">x</span> <span class="main">∈</span> set <span class="main">(</span>signs_smash <span class="main">(</span>characterize_consistent_signs_at_roots <span class="free">p</span> <span class="free">qs1</span><span class="main">)</span> 
          <span class="main">(</span>characterize_consistent_signs_at_roots <span class="free">p</span> <span class="free">qs2</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> signs_smash_def <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> set <span class="main">(</span>characterize_consistent_signs_at_roots <span class="free">p</span>
          <span class="main">(</span><span class="free">qs1</span> <span class="main">@</span> <span class="free">qs2</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> set <span class="main">(</span>signs_smash <span class="free">signs1</span> <span class="free">signs2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> csa1 csa2 subset_smash_signs<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="free">signs1</span></span> <span class="main">_</span> <span class="quoted"><span class="free">signs2</span></span><span class="main">]</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Main Results"</span></span>
<span class="keyword1" id="Renegar_Proofs-dim_row_matrix_A_R"><span class="command">lemma</span></span> dim_row_matrix_A_R<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"dim_row <span class="main">(</span>matrix_A_R <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span> <span class="main">=</span> length <span class="free">subsets</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> matrix_A_R_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Renegar_Proofs-dim_col_matrix_A_R"><span class="command">lemma</span></span> dim_col_matrix_A_R<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"dim_col <span class="main">(</span>matrix_A_R <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span> <span class="main">=</span> length <span class="free">signs</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> matrix_A_R_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Renegar_Proofs-length_subsets_smash_R"><span class="command">lemma</span></span> length_subsets_smash_R<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"length <span class="main">(</span>subsets_smash_R <span class="free">n</span> <span class="free">subs1</span> <span class="free">subs2</span><span class="main">)</span> <span class="main">=</span> length <span class="free">subs1</span> <span class="main">*</span> length <span class="free">subs2</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> subsets_smash_R_def length_concat
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> o_def sum_list_triv<span class="main">)</span>

<span class="keyword1" id="Renegar_Proofs-z_append_R"><span class="command">lemma</span></span> z_append_R<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">xs</span><span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>nat list <span class="main">*</span> nat list<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∈</span> set <span class="main">(</span>fst <span class="free">xs</span><span class="main">)</span> <span class="main">⟹</span> <span class="bound">i</span>  <span class="main">&lt;</span> length <span class="free">as</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∈</span> set <span class="main">(</span>snd <span class="free">xs</span><span class="main">)</span> <span class="main">⟹</span> <span class="bound">i</span>  <span class="main">&lt;</span> length <span class="free">as</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"z_R <span class="main">(</span><span class="main">(</span>fst <span class="free">xs</span><span class="main">)</span> <span class="main">@</span> <span class="main">(</span>map <span class="main">(</span><span class="main">(+)</span> <span class="main">(</span>length <span class="free">as</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>fst <span class="free">ys</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>snd <span class="free">xs</span><span class="main">)</span> <span class="main">@</span> <span class="main">(</span>map <span class="main">(</span><span class="main">(+)</span> <span class="main">(</span>length <span class="free">as</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>snd <span class="free">ys</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">as</span> <span class="main">@</span> <span class="free">bs</span><span class="main">)</span> <span class="main">=</span> z_R <span class="free">xs</span> <span class="free">as</span> <span class="main">*</span> z_R <span class="free">ys</span> <span class="free">bs</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"map <span class="main">(</span><span class="main">(!)</span> <span class="main">(</span><span class="free">as</span> <span class="main">@</span> <span class="free">bs</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>fst <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> map <span class="main">(</span><span class="main">(!)</span> <span class="free">as</span><span class="main">)</span> <span class="main">(</span>fst <span class="free">xs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> list_eq_iff_nth_eq
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>nth_append<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"map <span class="main">(</span><span class="main">(!)</span> <span class="main">(</span><span class="free">as</span> <span class="main">@</span> <span class="free">bs</span><span class="main">)</span> <span class="main">∘</span> <span class="main">(+)</span> <span class="main">(</span>length <span class="free">as</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>fst <span class="free">ys</span><span class="main">)</span> <span class="main">=</span> map <span class="main">(</span><span class="main">(!)</span> <span class="free">bs</span><span class="main">)</span> <span class="main">(</span>fst <span class="free">ys</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> list_eq_iff_nth_eq
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"map <span class="main">(</span><span class="main">(!)</span> <span class="main">(</span><span class="free">as</span> <span class="main">@</span> <span class="free">bs</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>snd <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> map <span class="main">(</span><span class="main">(!)</span> <span class="free">as</span><span class="main">)</span> <span class="main">(</span>snd <span class="free">xs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> list_eq_iff_nth_eq
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>nth_append<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> 4<span class="main">:</span> <span class="quoted"><span class="quoted">"map <span class="main">(</span><span class="main">(!)</span> <span class="main">(</span><span class="free">as</span> <span class="main">@</span> <span class="free">bs</span><span class="main">)</span> <span class="main">∘</span> <span class="main">(+)</span> <span class="main">(</span>length <span class="free">as</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>snd <span class="free">ys</span><span class="main">)</span> <span class="main">=</span> map <span class="main">(</span><span class="main">(!)</span> <span class="free">bs</span><span class="main">)</span> <span class="main">(</span>snd <span class="free">ys</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> list_eq_iff_nth_eq
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> z_R_def <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">unfolding</span></span> 1 2 3 4 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> <span class="main"><span class="main">(</span></span>z3<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> comp_apply length_map map_append map_eq_conv map_sgas_def nth_append nth_append_length_plus<span class="main">)</span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(* Shows that the matrix of a smashed system is the Kronecker product of the matrices of the two
  systems being combined *)</span>
<span class="keyword1" id="Renegar_Proofs-matrix_construction_is_kronecker_product_R"><span class="command">lemma</span></span> matrix_construction_is_kronecker_product_R<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">qs1</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real poly list"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">subs1</span> <span class="free">subs2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>nat list<span class="main">*</span>nat list<span class="main">)</span> list"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">signs1</span> <span class="free">signs2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"rat list list"</span></span>
    <span class="comment1">(* n1 is the number of polynomials in the "1" sets *)</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">l</span> <span class="bound">i</span><span class="main">.</span> <span class="bound">l</span> <span class="main">∈</span> set <span class="free">subs1</span> <span class="main">⟹</span> <span class="main">(</span><span class="bound">i</span> <span class="main">∈</span> set <span class="main">(</span>fst <span class="bound">l</span><span class="main">)</span> <span class="main">∨</span> <span class="bound">i</span> <span class="main">∈</span> set <span class="main">(</span>snd <span class="bound">l</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="free">n1</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">j</span><span class="main">.</span> <span class="bound">j</span> <span class="main">∈</span> set <span class="free">signs1</span> <span class="main">⟹</span> length <span class="bound">j</span> <span class="main">=</span> <span class="free">n1</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>matrix_A_R <span class="main">(</span>signs_smash <span class="free">signs1</span> <span class="free">signs2</span><span class="main">)</span> <span class="main">(</span>subsets_smash_R <span class="free">n1</span> <span class="free">subs1</span> <span class="free">subs2</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
    kronecker_product <span class="main">(</span>matrix_A_R <span class="free">signs1</span> <span class="free">subs1</span><span class="main">)</span> <span class="main">(</span>matrix_A_R <span class="free">signs2</span> <span class="free">subs2</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> mat_eq_iff dim_row_matrix_A_R dim_col_matrix_A_R
    length_subsets_smash_R length_signs_smash dim_kronecker
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">safe</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="skolem">j</span>
  <span class="keyword3"><span class="command">assume</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="free">subs1</span> <span class="main">*</span> length <span class="free">subs2</span>"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> j<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> length <span class="free">signs1</span> <span class="main">*</span> length <span class="free">signs2</span>"</span></span>

  <span class="keyword1"><span class="command">have</span></span> ld<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="keyword1">div</span> length <span class="free">subs2</span> <span class="main">&lt;</span> length <span class="free">subs1</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="keyword1">div</span> length <span class="free">signs2</span> <span class="main">&lt;</span> length <span class="free">signs1</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> i j less_mult_imp_div_less <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> lm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="keyword1">mod</span> length <span class="free">subs2</span> <span class="main">&lt;</span> length <span class="free">subs2</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="keyword1">mod</span> length <span class="free">signs2</span> <span class="main">&lt;</span> length <span class="free">signs2</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> i j less_mult_imp_mod_less <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> n1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n1</span> <span class="main">=</span> length <span class="main">(</span><span class="free">signs1</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">j</span> <span class="keyword1">div</span> length <span class="free">signs2</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> ld<span class="main">(</span>2<span class="main">)</span> nth_mem <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"matrix_A_R <span class="main">(</span>signs_smash <span class="free">signs1</span> <span class="free">signs2</span><span class="main">)</span> <span class="main">(</span>subsets_smash_R <span class="free">n1</span> <span class="free">subs1</span> <span class="free">subs2</span><span class="main">)</span> <span class="main">$$</span> <span class="main">(</span><span class="skolem">i</span><span class="main">,</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">=</span>
    z_R <span class="main">(</span>subsets_smash_R <span class="free">n1</span> <span class="free">subs1</span> <span class="free">subs2</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">(</span>signs_smash <span class="free">signs1</span> <span class="free">signs2</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> mat_of_rows_list_def matrix_A_R_def mtx_row_R_def
    <span class="keyword1"><span class="command">using</span></span> i j <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> length_signs_smash length_subsets_smash_R<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="main">...</span> <span class="main">=</span> z_R <span class="main">(</span><span class="main">(</span>fst <span class="main">(</span><span class="free">subs1</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">i</span> <span class="keyword1">div</span> length <span class="free">subs2</span><span class="main">)</span><span class="main">)</span> <span class="main">@</span> map <span class="main">(</span><span class="main">(+)</span> <span class="free">n1</span><span class="main">)</span> <span class="main">(</span>fst<span class="main">(</span><span class="free">subs2</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">i</span> <span class="keyword1">mod</span> length <span class="free">subs2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">,</span>
  <span class="main">(</span>snd <span class="main">(</span><span class="free">subs1</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">i</span> <span class="keyword1">div</span> length <span class="free">subs2</span><span class="main">)</span><span class="main">)</span> <span class="main">@</span> map <span class="main">(</span><span class="main">(+)</span> <span class="free">n1</span><span class="main">)</span> <span class="main">(</span>snd <span class="main">(</span><span class="free">subs2</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">i</span> <span class="keyword1">mod</span> length <span class="free">subs2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
     <span class="main">(</span><span class="free">signs1</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">j</span> <span class="keyword1">div</span> length <span class="free">signs2</span><span class="main">)</span> <span class="main">@</span> <span class="free">signs2</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">j</span> <span class="keyword1">mod</span> length <span class="free">signs2</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> signs_smash_def subsets_smash_R_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> length_eq_concat<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> i <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mult.commute<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> length_eq_concat<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> j <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mult.commute<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> ld lm <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span>
  z_R <span class="main">(</span><span class="free">subs1</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">i</span> <span class="keyword1">div</span> length <span class="free">subs2</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">signs1</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">j</span> <span class="keyword1">div</span> length <span class="free">signs2</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span>
  z_R <span class="main">(</span><span class="free">subs2</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">i</span> <span class="keyword1">mod</span> length <span class="free">subs2</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">signs2</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">j</span> <span class="keyword1">mod</span> length <span class="free">signs2</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> n1
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> z_append_R<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> n1<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> ld<span class="main">(</span>1<span class="main">)</span> nth_mem
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> ld<span class="main">(</span>1<span class="main">)</span> nth_mem <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> 4<span class="main">:</span> <span class="quoted"><span class="quoted">"kronecker_product <span class="main">(</span>matrix_A_R <span class="free">signs1</span> <span class="free">subs1</span><span class="main">)</span> <span class="main">(</span>matrix_A_R <span class="free">signs2</span> <span class="free">subs2</span><span class="main">)</span> <span class="main">$$</span> <span class="main">(</span><span class="skolem">i</span><span class="main">,</span><span class="skolem">j</span><span class="main">)</span> <span class="main">=</span>
    z_R <span class="main">(</span><span class="free">subs1</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">i</span> <span class="keyword1">div</span> length <span class="free">subs2</span><span class="main">)</span><span class="main">)</span>
     <span class="main">(</span><span class="free">signs1</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">j</span> <span class="keyword1">div</span> length <span class="free">signs2</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span>
    z_R <span class="main">(</span><span class="free">subs2</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">i</span> <span class="keyword1">mod</span> length <span class="free">subs2</span><span class="main">)</span><span class="main">)</span>
     <span class="main">(</span><span class="free">signs2</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">j</span> <span class="keyword1">mod</span> length <span class="free">signs2</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> kronecker_product_def matrix_A_R_def mat_of_rows_list_def mtx_row_R_def
    <span class="keyword1"><span class="command">using</span></span> i j <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> index_mat<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">OF</span> ld<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> index_mat<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">OF</span> lm<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> ld lm <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"matrix_A_R <span class="main">(</span>signs_smash <span class="free">signs1</span> <span class="free">signs2</span><span class="main">)</span> <span class="main">(</span>subsets_smash_R <span class="free">n1</span> <span class="free">subs1</span> <span class="free">subs2</span><span class="main">)</span> <span class="main">$$</span> <span class="main">(</span><span class="skolem">i</span><span class="main">,</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">=</span>
        kronecker_product <span class="main">(</span>matrix_A_R <span class="free">signs1</span> <span class="free">subs1</span><span class="main">)</span> <span class="main">(</span>matrix_A_R <span class="free">signs2</span> <span class="free">subs2</span><span class="main">)</span> <span class="main">$$</span> <span class="main">(</span><span class="skolem">i</span><span class="main">,</span> <span class="skolem">j</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> 1 2 3 4 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(* Given that two smaller systems satisfy some mild constraints, show that their combined system
  (after smashing the signs and subsets) satisfies the matrix equation, and that the matrix of the
  combined system is invertible. *)</span>
<span class="keyword1" id="Renegar_Proofs-inductive_step_R"><span class="command">lemma</span></span> inductive_step_R<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">p</span><span class="main">::</span> <span class="quoted"><span class="quoted">"real poly"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">qs1</span> <span class="free">qs2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real poly list"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">subsets1</span> <span class="free">subsets2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>nat list<span class="main">*</span>nat list<span class="main">)</span> list"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">signs1</span> <span class="free">signs2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"rat list list"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> nonzero<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> nontriv1<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">qs1</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> nontriv2<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">qs2</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> welldefined_signs1<span class="main">:</span> <span class="quoted"><span class="quoted">"well_def_signs <span class="main">(</span>length <span class="free">qs1</span><span class="main">)</span> <span class="free">signs1</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> welldefined_signs2<span class="main">:</span> <span class="quoted"><span class="quoted">"well_def_signs <span class="main">(</span>length <span class="free">qs2</span><span class="main">)</span> <span class="free">signs2</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> distinct_signs1<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="free">signs1</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> distinct_signs2<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="free">signs2</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> all_info1<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>characterize_consistent_signs_at_roots <span class="free">p</span> <span class="free">qs1</span><span class="main">)</span> <span class="main">⊆</span> set<span class="main">(</span><span class="free">signs1</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> all_info2<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>characterize_consistent_signs_at_roots <span class="free">p</span> <span class="free">qs2</span><span class="main">)</span> <span class="main">⊆</span> set<span class="main">(</span><span class="free">signs2</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> welldefined_subsets1<span class="main">:</span> <span class="quoted"><span class="quoted">"all_list_constr_R <span class="main">(</span><span class="free">subsets1</span><span class="main">)</span> <span class="main">(</span>length <span class="free">qs1</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> welldefined_subsets2<span class="main">:</span> <span class="quoted"><span class="quoted">"all_list_constr_R <span class="main">(</span><span class="free">subsets2</span><span class="main">)</span> <span class="main">(</span>length <span class="free">qs2</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> invertibleMtx1<span class="main">:</span> <span class="quoted"><span class="quoted">"invertible_mat <span class="main">(</span>matrix_A_R <span class="free">signs1</span> <span class="free">subsets1</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> invertibleMtx2<span class="main">:</span> <span class="quoted"><span class="quoted">"invertible_mat <span class="main">(</span>matrix_A_R <span class="free">signs2</span> <span class="free">subsets2</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"satisfy_equation_R <span class="free">p</span> <span class="main">(</span><span class="free">qs1</span><span class="main">@</span><span class="free">qs2</span><span class="main">)</span> <span class="main">(</span>subsets_smash_R <span class="main">(</span>length <span class="free">qs1</span><span class="main">)</span> <span class="free">subsets1</span> <span class="free">subsets2</span><span class="main">)</span> <span class="main">(</span>signs_smash <span class="free">signs1</span> <span class="free">signs2</span><span class="main">)</span> 
        <span class="main">∧</span> invertible_mat <span class="main">(</span>matrix_A_R <span class="main">(</span>signs_smash <span class="free">signs1</span> <span class="free">signs2</span><span class="main">)</span> <span class="main">(</span>subsets_smash_R <span class="main">(</span>length <span class="free">qs1</span><span class="main">)</span> <span class="free">subsets1</span> <span class="free">subsets2</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
  <span class="keyword1"><span class="command">have</span></span> h1<span class="main">:</span> <span class="quoted"><span class="quoted">"invertible_mat <span class="main">(</span>matrix_A_R <span class="main">(</span>signs_smash <span class="free">signs1</span> <span class="free">signs2</span><span class="main">)</span> <span class="main">(</span>subsets_smash_R <span class="main">(</span>length <span class="free">qs1</span><span class="main">)</span> <span class="free">subsets1</span> <span class="free">subsets2</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> matrix_construction_is_kronecker_product_R
      kronecker_invertible invertibleMtx1 invertibleMtx2
      welldefined_subsets1 welldefined_subsets2 <span class="keyword1"><span class="command">unfolding</span></span> all_list_constr_R_def list_constr_def
    <span class="keyword1"><span class="command">using</span></span> Ball_set in_set_member well_def_signs_def welldefined_signs1 in_set_conv_nth list_all_length
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> <span class="main"><span class="main">(</span></span>z3<span class="main"><span class="main">)</span></span> Ball_set kronecker_invertible member_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> h2a<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>signs_smash <span class="free">signs1</span> <span class="free">signs2</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> distinct_signs1 distinct_signs2 welldefined_signs1 welldefined_signs2 nontriv1 nontriv2 
      distinct_step <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> h2c<span class="main">:</span> <span class="quoted"><span class="quoted">"all_list_constr_R <span class="main">(</span><span class="main">(</span>subsets_smash_R <span class="main">(</span>length <span class="free">qs1</span><span class="main">)</span> <span class="free">subsets1</span> <span class="free">subsets2</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>length <span class="main">(</span><span class="free">qs1</span><span class="main">@</span><span class="free">qs2</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> well_def_step_R
      welldefined_subsets1 welldefined_subsets2
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> h2d<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>characterize_consistent_signs_at_roots <span class="free">p</span> <span class="main">(</span><span class="free">qs1</span><span class="main">@</span><span class="free">qs2</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> set<span class="main">(</span>signs_smash <span class="free">signs1</span> <span class="free">signs2</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> subset_step_R all_info1 all_info2
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> 
  <span class="keyword1"><span class="command">have</span></span> h2<span class="main">:</span> <span class="quoted"><span class="quoted">"satisfy_equation_R <span class="free">p</span> <span class="main">(</span><span class="free">qs1</span><span class="main">@</span><span class="free">qs2</span><span class="main">)</span> <span class="main">(</span>subsets_smash_R <span class="main">(</span>length <span class="free">qs1</span><span class="main">)</span> <span class="free">subsets1</span> <span class="free">subsets2</span><span class="main">)</span> <span class="main">(</span>signs_smash <span class="free">signs1</span> <span class="free">signs2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> matrix_equation_R<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> p<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="free">p</span>"</span></span><span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> qs<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="free">qs1</span><span class="main">@</span><span class="free">qs2</span>"</span></span><span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> subsets <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"subsets_smash_R <span class="main">(</span>length <span class="free">qs1</span><span class="main">)</span> <span class="free">subsets1</span> <span class="free">subsets2</span>"</span></span><span class="main">,</span>
        <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> signs <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"signs_smash <span class="free">signs1</span> <span class="free">signs2</span>"</span></span><span class="main">]</span> 
        h2a h2c h2d <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> nonzero <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> h1 h2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">"Reduction Step Proofs"</span></span>
  <span class="comment1">(* Some definitions *)</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">get_matrix_R</span><span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>rat mat <span class="main">×</span> <span class="main">(</span><span class="main">(</span>nat list<span class="main">*</span>nat list<span class="main">)</span> list <span class="main">×</span> rat list list<span class="main">)</span><span class="main">)</span> <span class="main">⇒</span> rat mat"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">get_matrix_R</span> <span class="free"><span class="bound"><span class="entity">data</span></span></span> <span class="main">=</span> fst<span class="main">(</span><span class="free"><span class="bound"><span class="entity">data</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">get_subsets_R</span><span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>rat mat <span class="main">×</span> <span class="main">(</span><span class="main">(</span>nat list<span class="main">*</span>nat list<span class="main">)</span> list <span class="main">×</span> rat list list<span class="main">)</span><span class="main">)</span> <span class="main">⇒</span>  <span class="main">(</span>nat list<span class="main">*</span>nat list<span class="main">)</span> list"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">get_subsets_R</span> <span class="free"><span class="bound"><span class="entity">data</span></span></span> <span class="main">=</span> fst<span class="main">(</span>snd<span class="main">(</span><span class="free"><span class="bound"><span class="entity">data</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">get_signs_R</span><span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>rat mat <span class="main">×</span> <span class="main">(</span><span class="main">(</span>nat list<span class="main">*</span>nat list<span class="main">)</span> list <span class="main">×</span> rat list list<span class="main">)</span><span class="main">)</span> <span class="main">⇒</span> rat list list"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">get_signs_R</span> <span class="free"><span class="bound"><span class="entity">data</span></span></span> <span class="main">=</span> snd<span class="main">(</span>snd<span class="main">(</span><span class="free"><span class="bound"><span class="entity">data</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">reduction_signs_R</span><span class="main">::</span> <span class="quoted"><span class="quoted">"real poly <span class="main">⇒</span> real poly list <span class="main">⇒</span> rat list list <span class="main">⇒</span> <span class="main">(</span>nat list<span class="main">*</span>nat list<span class="main">)</span> list <span class="main">⇒</span> rat mat <span class="main">⇒</span> rat list list"</span></span> 
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">reduction_signs_R</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">qs</span></span></span> <span class="free"><span class="bound"><span class="entity">signs</span></span></span> <span class="free"><span class="bound"><span class="entity">subsets</span></span></span> <span class="free"><span class="bound"><span class="entity">matr</span></span></span> <span class="main">=</span> 
    <span class="main">(</span>take_indices <span class="free"><span class="bound"><span class="entity">signs</span></span></span> <span class="main">(</span>find_nonzeros_from_input_vec <span class="main">(</span>solve_for_lhs_R <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">qs</span></span></span> <span class="free"><span class="bound"><span class="entity">subsets</span></span></span> <span class="free"><span class="bound"><span class="entity">matr</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">reduction_subsets_R</span><span class="main">::</span> <span class="quoted"><span class="quoted">"real poly <span class="main">⇒</span> real poly list <span class="main">⇒</span> rat list list <span class="main">⇒</span> <span class="main">(</span>nat list<span class="main">*</span>nat list<span class="main">)</span> list <span class="main">⇒</span> rat mat <span class="main">⇒</span> <span class="main">(</span>nat list<span class="main">*</span>nat list<span class="main">)</span> list"</span></span> 
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">reduction_subsets_R</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">qs</span></span></span> <span class="free"><span class="bound"><span class="entity">signs</span></span></span> <span class="free"><span class="bound"><span class="entity">subsets</span></span></span> <span class="free"><span class="bound"><span class="entity">matr</span></span></span> <span class="main">=</span> 
    <span class="main">(</span>take_indices <span class="free"><span class="bound"><span class="entity">subsets</span></span></span> <span class="main">(</span>rows_to_keep <span class="main">(</span>reduce_mat_cols <span class="free"><span class="bound"><span class="entity">matr</span></span></span> <span class="main">(</span>solve_for_lhs_R <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">qs</span></span></span> <span class="free"><span class="bound"><span class="entity">subsets</span></span></span> <span class="free"><span class="bound"><span class="entity">matr</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="comment1">(* Some basic lemmas *)</span>
<span class="keyword1" id="Renegar_Proofs-reduction_signs_is_get_signs_R"><span class="command">lemma</span></span> reduction_signs_is_get_signs_R<span class="main">:</span> <span class="quoted"><span class="quoted">"reduction_signs_R <span class="free">p</span> <span class="free">qs</span> <span class="free">signs</span> <span class="free">subsets</span> <span class="free">m</span> <span class="main">=</span>  get_signs_R <span class="main">(</span>reduce_system_R <span class="free">p</span> <span class="main">(</span><span class="free">qs</span><span class="main">,</span> <span class="main">(</span><span class="free">m</span><span class="main">,</span> <span class="main">(</span><span class="free">subsets</span><span class="main">,</span> <span class="free">signs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> reduction_signs_R_def get_signs_R_def <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> reduction_step_R.elims snd_conv
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span> 

<span class="keyword1" id="Renegar_Proofs-reduction_subsets_is_get_subsets_R"><span class="command">lemma</span></span> reduction_subsets_is_get_subsets_R<span class="main">:</span> <span class="quoted"><span class="quoted">"reduction_subsets_R <span class="free">p</span> <span class="free">qs</span> <span class="free">signs</span> <span class="free">subsets</span> <span class="free">m</span> <span class="main">=</span>  get_subsets_R <span class="main">(</span>reduce_system_R <span class="free">p</span> <span class="main">(</span><span class="free">qs</span><span class="main">,</span> <span class="main">(</span><span class="free">m</span><span class="main">,</span> <span class="main">(</span><span class="free">subsets</span><span class="main">,</span> <span class="free">signs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> reduction_subsets_R_def get_subsets_R_def
  <span class="keyword1"><span class="command">using</span></span> reduce_system.simps reduction_step.elims fst_conv snd_conv
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> reduce_system_R.simps reduction_step_R.simps<span class="main">)</span> 

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Showing sign conditions preserved when reducing"</span></span>

<span class="keyword1" id="Renegar_Proofs-take_indices_lem_R"><span class="command">lemma</span></span> take_indices_lem_R<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">p</span><span class="main">::</span> <span class="quoted"><span class="quoted">"real poly"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">qs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real poly list"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">arb_list</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> list<span class="main">*</span><span class="tfree">'a</span> list<span class="main">)</span> list"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">index_list</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat list"</span></span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">n</span><span class="main">::</span> <span class="quoted"><span class="quoted">"nat"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> lest<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&lt;</span> length <span class="main">(</span>take_indices <span class="free">arb_list</span> <span class="free">index_list</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> well_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">q</span><span class="main">.</span><span class="main">(</span>List.member <span class="free">index_list</span> <span class="bound">q</span> <span class="main">⟶</span> <span class="bound">q</span> <span class="main">&lt;</span> length <span class="free">arb_list</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">k</span></span><span class="main">&lt;</span>length <span class="free">arb_list</span><span class="main">.</span>
            <span class="main">(</span>take_indices <span class="free">arb_list</span> <span class="free">index_list</span><span class="main">)</span> <span class="main">!</span> <span class="free">n</span> <span class="main">=</span>  <span class="free">arb_list</span> <span class="main">!</span> <span class="bound">k</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> lest well_def <span class="keyword1"><span class="command">unfolding</span></span> take_indices_def <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> member_def nth_mem<span class="main">)</span>

<span class="keyword1" id="Renegar_Proofs-size_of_mat_R"><span class="command">lemma</span></span> size_of_mat_R<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">subsets</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>nat list<span class="main">*</span>nat list<span class="main">)</span> list"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">signs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"rat list list"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>matrix_A_R <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span> <span class="main">∈</span> carrier_mat <span class="main">(</span>length <span class="free">subsets</span><span class="main">)</span> <span class="main">(</span>length <span class="free">signs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> matrix_A_R_def carrier_mat_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Renegar_Proofs-size_of_lhs_R"><span class="command">lemma</span></span> size_of_lhs_R<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">p</span><span class="main">::</span> <span class="quoted"><span class="quoted">"real poly"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">qs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real poly list"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">signs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"rat list list"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"dim_vec <span class="main">(</span>construct_lhs_vector_R <span class="free">p</span> <span class="free">qs</span> <span class="free">signs</span><span class="main">)</span> <span class="main">=</span> length <span class="free">signs</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> construct_lhs_vector_R_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Renegar_Proofs-size_of_rhs_R"><span class="command">lemma</span></span> size_of_rhs_R<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">p</span><span class="main">::</span> <span class="quoted"><span class="quoted">"real poly"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">qs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real poly list"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">subsets</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>nat list<span class="main">*</span>nat list<span class="main">)</span> list"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"dim_vec <span class="main">(</span>construct_rhs_vector_R <span class="free">p</span> <span class="free">qs</span> <span class="free">subsets</span><span class="main">)</span> <span class="main">=</span> length <span class="free">subsets</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> construct_rhs_vector_R_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Renegar_Proofs-same_size_R"><span class="command">lemma</span></span> same_size_R<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">p</span><span class="main">::</span> <span class="quoted"><span class="quoted">"real poly"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">qs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real poly list"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">subsets</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>nat list<span class="main">*</span>nat list<span class="main">)</span> list"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">signs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"rat list list"</span></span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> invertible_mat<span class="main">:</span> <span class="quoted"><span class="quoted">"invertible_mat <span class="main">(</span>matrix_A_R <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"length <span class="free">subsets</span> <span class="main">=</span> length <span class="free">signs</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> invertible_mat <span class="keyword1"><span class="command">unfolding</span></span> invertible_mat_def
  <span class="keyword1"><span class="command">using</span></span> size_of_mat_R<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">signs</span></span> <span class="quoted"><span class="free">subsets</span></span><span class="main">]</span> size_of_lhs_R<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">p</span></span> <span class="quoted"><span class="free">qs</span></span> <span class="quoted"><span class="free">signs</span></span><span class="main">]</span> size_of_rhs_R<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">p</span></span> <span class="quoted"><span class="free">qs</span></span> <span class="quoted"><span class="free">subsets</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Renegar_Proofs-construct_lhs_matches_solve_for_lhs_R"><span class="command">lemma</span></span> construct_lhs_matches_solve_for_lhs_R<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">p</span><span class="main">::</span> <span class="quoted"><span class="quoted">"real poly"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">qs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real poly list"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">subsets</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>nat list<span class="main">*</span>nat list<span class="main">)</span> list"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">signs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"rat list list"</span></span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> match<span class="main">:</span> <span class="quoted"><span class="quoted">"satisfy_equation_R <span class="free">p</span> <span class="free">qs</span> <span class="free">subsets</span> <span class="free">signs</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> invertible_mat<span class="main">:</span> <span class="quoted"><span class="quoted">"invertible_mat <span class="main">(</span>matrix_A_R <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>construct_lhs_vector_R <span class="free">p</span> <span class="free">qs</span> <span class="free">signs</span><span class="main">)</span> <span class="main">=</span> solve_for_lhs_R <span class="free">p</span> <span class="free">qs</span> <span class="free">subsets</span> <span class="main">(</span>matrix_A_R <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> matrix_equation_hyp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>mult_mat_vec <span class="main">(</span>matrix_A_R <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span> <span class="main">(</span>construct_lhs_vector_R <span class="free">p</span> <span class="free">qs</span> <span class="free">signs</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>construct_rhs_vector_R <span class="free">p</span> <span class="free">qs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> match <span class="keyword1"><span class="command">unfolding</span></span> satisfy_equation_R_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> eqn_hyp<span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="main">(</span><span class="main">(</span>matr_option <span class="main">(</span>dim_row <span class="main">(</span>matrix_A_R <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span>
     <span class="main">(</span>mat_inverse <span class="main">(</span>matrix_A_R <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>v</sub></span> <span class="main">(</span>mult_mat_vec <span class="main">(</span>matrix_A_R <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span> <span class="main">(</span>construct_lhs_vector_R <span class="free">p</span> <span class="free">qs</span> <span class="free">signs</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
      mult_mat_vec <span class="main">(</span>matr_option <span class="main">(</span>dim_row <span class="main">(</span>matrix_A_R <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span>
     <span class="main">(</span>mat_inverse <span class="main">(</span>matrix_A_R <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>construct_rhs_vector_R <span class="free">p</span> <span class="free">qs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> invertible_mat 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> matrix_equation_hyp<span class="main">)</span> 
  <span class="keyword1"><span class="command">have</span></span> match_hyp<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">subsets</span> <span class="main">=</span> length <span class="free">signs</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> same_size_R invertible_mat <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> dim_hyp1<span class="main">:</span> <span class="quoted"><span class="quoted">"matrix_A_R <span class="free">signs</span> <span class="free">subsets</span> <span class="main">∈</span> carrier_mat <span class="main">(</span>length <span class="free">signs</span><span class="main">)</span> <span class="main">(</span>length <span class="free">signs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> size_of_mat
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> dim_hyp2<span class="main">:</span> <span class="quoted"><span class="quoted">"matr_option <span class="main">(</span>dim_row <span class="main">(</span>matrix_A_R <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span>
     <span class="main">(</span>mat_inverse <span class="main">(</span>matrix_A_R <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> carrier_mat <span class="main">(</span>length <span class="free">signs</span><span class="main">)</span> <span class="main">(</span>length <span class="free">signs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> invertible_mat dim_invertible
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
  <span class="keyword1"><span class="command">have</span></span> mult_assoc_hyp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span>matr_option <span class="main">(</span>dim_row <span class="main">(</span>matrix_A_R <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span>
     <span class="main">(</span>mat_inverse <span class="main">(</span>matrix_A_R <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>v</sub></span> <span class="main">(</span>mult_mat_vec <span class="main">(</span>matrix_A_R <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span> <span class="main">(</span>construct_lhs_vector_R <span class="free">p</span> <span class="free">qs</span> <span class="free">signs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
    <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="main">(</span>matr_option <span class="main">(</span>dim_row <span class="main">(</span>matrix_A_R <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span>
     <span class="main">(</span>mat_inverse <span class="main">(</span>matrix_A_R <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span>matrix_A_R <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>v</sub></span>  <span class="main">(</span>construct_lhs_vector_R <span class="free">p</span> <span class="free">qs</span> <span class="free">signs</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> mult_assoc dim_hyp1 dim_hyp2 size_of_lhs_R <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> cancel_helper<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">(</span>matr_option <span class="main">(</span>dim_row <span class="main">(</span>matrix_A_R <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span>
     <span class="main">(</span>mat_inverse <span class="main">(</span>matrix_A_R <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span>matrix_A_R <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>v</sub></span>  <span class="main">(</span>construct_lhs_vector_R <span class="free">p</span> <span class="free">qs</span> <span class="free">signs</span><span class="main">)</span><span class="main">)</span>
  <span class="main">=</span> <span class="main">(</span><span class="keyword1">1<span class="hidden">⇩</span><sub>m</sub></span> <span class="main">(</span>length <span class="free">signs</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>v</sub></span>   <span class="main">(</span>construct_lhs_vector_R <span class="free">p</span> <span class="free">qs</span> <span class="free">signs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> invertible_means_mult_id<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> A<span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"matrix_A_R <span class="free">signs</span> <span class="free">subsets</span>"</span></span><span class="main">]</span> dim_hyp1
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> invertible_mat match_hyp<span class="main">)</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> cancel_hyp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">(</span>matr_option <span class="main">(</span>dim_row <span class="main">(</span>matrix_A_R <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span>
     <span class="main">(</span>mat_inverse <span class="main">(</span>matrix_A_R <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span>matrix_A_R <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>v</sub></span>  <span class="main">(</span>construct_lhs_vector_R <span class="free">p</span> <span class="free">qs</span> <span class="free">signs</span><span class="main">)</span><span class="main">)</span>
  <span class="main">=</span> <span class="main">(</span>construct_lhs_vector_R <span class="free">p</span> <span class="free">qs</span> <span class="free">signs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> carrier_vec_dim_vec one_mult_mat_vec size_of_lhs_R<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> mult_hyp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span>matr_option <span class="main">(</span>dim_row <span class="main">(</span>matrix_A_R <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span>
     <span class="main">(</span>mat_inverse <span class="main">(</span>matrix_A_R <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>v</sub></span> <span class="main">(</span>mult_mat_vec <span class="main">(</span>matrix_A_R <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span> <span class="main">(</span>construct_lhs_vector_R <span class="free">p</span> <span class="free">qs</span> <span class="free">signs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
    <span class="main">=</span> <span class="main">(</span>construct_lhs_vector_R <span class="free">p</span> <span class="free">qs</span> <span class="free">signs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> mult_assoc_hyp cancel_hyp  
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>construct_lhs_vector_R <span class="free">p</span> <span class="free">qs</span> <span class="free">signs</span><span class="main">)</span> <span class="main">=</span>  <span class="main">(</span>mult_mat_vec <span class="main">(</span>matr_option <span class="main">(</span>dim_row <span class="main">(</span>matrix_A_R <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span>
     <span class="main">(</span>mat_inverse <span class="main">(</span>matrix_A_R <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>construct_rhs_vector_R <span class="free">p</span> <span class="free">qs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span> "</span></span>
    <span class="keyword1"><span class="command">using</span></span> eqn_hyp
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> solve_for_lhs_R_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mat_inverse_same<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(* Then show that dropping columns doesn't affect the consistent sign assignments *)</span>
<span class="keyword1" id="Renegar_Proofs-reduction_doesnt_break_things_signs_R"><span class="command">lemma</span></span> reduction_doesnt_break_things_signs_R<span class="main">:</span>  
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">p</span><span class="main">::</span> <span class="quoted"><span class="quoted">"real poly"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">qs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real poly list"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">subsets</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>nat list<span class="main">*</span>nat list<span class="main">)</span> list"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">signs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"rat list list"</span></span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> nonzero<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> welldefined_signs1<span class="main">:</span> <span class="quoted"><span class="quoted">"well_def_signs <span class="main">(</span>length <span class="free">qs</span><span class="main">)</span> <span class="free">signs</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> distinct_signs<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="free">signs</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> all_info<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>characterize_consistent_signs_at_roots <span class="free">p</span> <span class="free">qs</span><span class="main">)</span> <span class="main">⊆</span> set<span class="main">(</span><span class="free">signs</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> match<span class="main">:</span> <span class="quoted"><span class="quoted">"satisfy_equation_R <span class="free">p</span> <span class="free">qs</span> <span class="free">subsets</span> <span class="free">signs</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> invertible_mat<span class="main">:</span> <span class="quoted"><span class="quoted">"invertible_mat <span class="main">(</span>matrix_A_R <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>characterize_consistent_signs_at_roots <span class="free">p</span> <span class="free">qs</span><span class="main">)</span> <span class="main">⊆</span> set<span class="main">(</span>reduction_signs_R <span class="free">p</span> <span class="free">qs</span> <span class="free">signs</span> <span class="free">subsets</span> <span class="main">(</span>matrix_A_R <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
  <span class="keyword1"><span class="command">have</span></span> dim_hyp2<span class="main">:</span> <span class="quoted"><span class="quoted">"matr_option <span class="main">(</span>dim_row <span class="main">(</span>matrix_A_R <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span>
     <span class="main">(</span>mat_inverse <span class="main">(</span>matrix_A_R <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> carrier_mat <span class="main">(</span>length <span class="free">signs</span><span class="main">)</span> <span class="main">(</span>length <span class="free">signs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> invertible_mat dim_invertible
    <span class="keyword1"><span class="command">using</span></span> same_size_R <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>construct_lhs_vector_R <span class="free">p</span> <span class="free">qs</span> <span class="free">signs</span><span class="main">)</span> <span class="main">=</span> solve_for_lhs_R <span class="free">p</span> <span class="free">qs</span> <span class="free">subsets</span> <span class="main">(</span>matrix_A_R <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> construct_lhs_matches_solve_for_lhs_R assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>solve_for_lhs_R <span class="free">p</span> <span class="free">qs</span> <span class="free">subsets</span> <span class="main">(</span>matrix_A_R <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
   vec_of_list <span class="main">(</span>map rat_of_nat <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> card <span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> consistent_sign_vec <span class="free">qs</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">s</span><span class="main">}</span><span class="main">)</span> <span class="free">signs</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> construct_lhs_vector_cleaner_R assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> list.map_cong map_map o_apply of_int_of_nat_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound"><span class="bound">n</span></span> <span class="main">&lt;</span> <span class="main">(</span>dim_vec <span class="main">(</span>solve_for_lhs_R <span class="free">p</span> <span class="free">qs</span> <span class="free">subsets</span> <span class="main">(</span>matrix_A_R <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> 
       <span class="main">(</span><span class="main">(</span><span class="main">(</span>solve_for_lhs_R <span class="free">p</span> <span class="free">qs</span> <span class="free">subsets</span> <span class="main">(</span>matrix_A_R <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span> <span class="main">$</span> <span class="bound">n</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span> <span class="main">⟶</span>
       <span class="main">(</span>nth <span class="free">signs</span> <span class="bound">n</span><span class="main">)</span> <span class="main">∉</span> set <span class="main">(</span>characterize_consistent_signs_at_roots <span class="free">p</span> <span class="free">qs</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
    <span class="keyword1"><span class="command">have</span></span> h0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound"><span class="bound">n</span></span> <span class="main">&lt;</span> <span class="main">(</span>dim_vec <span class="main">(</span>solve_for_lhs_R <span class="free">p</span> <span class="free">qs</span> <span class="free">subsets</span> <span class="main">(</span>matrix_A_R <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> 
       <span class="main">(</span><span class="main">(</span><span class="main">(</span>solve_for_lhs_R <span class="free">p</span> <span class="free">qs</span> <span class="free">subsets</span> <span class="main">(</span>matrix_A_R <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span> <span class="main">$</span> <span class="bound">n</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span> <span class="main">⟶</span> 
       rat_of_nat <span class="main">(</span>card <span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> consistent_sign_vec <span class="free">qs</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">(</span>nth <span class="free">signs</span> <span class="bound">n</span><span class="main">)</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> <span class="quoted"><span class="quoted">‹construct_lhs_vector_R <span class="free">p</span> <span class="free">qs</span> <span class="free">signs</span> <span class="main">=</span> solve_for_lhs_R <span class="free">p</span> <span class="free">qs</span> <span class="free">subsets</span> <span class="main">(</span>matrix_A_R <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span>›</span></span> construct_lhs_vector_clean_R nonzero of_nat_0_eq_iff of_rat_of_nat_eq size_of_lhs_R<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> h1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">w</span><span class="main">.</span> <span class="main">(</span>rat_of_nat <span class="main">(</span>card <span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> consistent_sign_vec <span class="free">qs</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">w</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟶</span> 
        <span class="main">(</span><span class="main">∄</span> <span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> consistent_sign_vec <span class="free">qs</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">w</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">clarsimp</span> 
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
      <span class="keyword3"><span class="command">assume</span></span> card_asm<span class="main">:</span> <span class="quoted"><span class="quoted">"card <span class="main">{</span><span class="bound">xa</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">xa</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> consistent_sign_vec <span class="free">qs</span> <span class="bound">xa</span> <span class="main">=</span> consistent_sign_vec <span class="free">qs</span> <span class="skolem">x</span><span class="main">}</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
      <span class="keyword3"><span class="command">assume</span></span> zero_asm<span class="main">:</span> <span class="quoted"><span class="quoted">"poly <span class="free">p</span> <span class="skolem">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> card_hyp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">xa</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">xa</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> consistent_sign_vec <span class="free">qs</span> <span class="bound">xa</span> <span class="main">=</span> consistent_sign_vec <span class="free">qs</span> <span class="skolem">x</span><span class="main">}</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> card_eq_0_iff
        <span class="keyword1"><span class="command">using</span></span> card_asm nonzero poly_roots_finite
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> finite_Collect_conjI<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">xa</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">xa</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> consistent_sign_vec <span class="free">qs</span> <span class="bound">xa</span> <span class="main">=</span> consistent_sign_vec <span class="free">qs</span> <span class="skolem">x</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> zero_asm <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"False"</span></span> <span class="keyword1"><span class="command">using</span></span> card_hyp
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">have</span></span> h2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">w</span><span class="main">.</span> <span class="main">(</span>rat_of_nat <span class="main">(</span>card <span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> consistent_sign_vec <span class="free">qs</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">w</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟹</span>
       <span class="main">(</span><span class="main">¬</span>List.member <span class="main">(</span>characterize_consistent_signs_at_roots <span class="free">p</span> <span class="free">qs</span><span class="main">)</span> <span class="bound">w</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">clarsimp</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">w</span>
      <span class="keyword3"><span class="command">assume</span></span> card_asm<span class="main">:</span> <span class="quoted"><span class="quoted">"card <span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> consistent_sign_vec <span class="free">qs</span> <span class="bound">x</span> <span class="main">=</span> <span class="skolem">w</span><span class="main">}</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
      <span class="keyword3"><span class="command">assume</span></span> mem_asm<span class="main">:</span> <span class="quoted"><span class="quoted">"List.member <span class="main">(</span>characterize_consistent_signs_at_roots <span class="free">p</span> <span class="free">qs</span><span class="main">)</span> <span class="skolem">w</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> h0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∄</span> <span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> consistent_sign_vec <span class="free">qs</span> <span class="bound">x</span> <span class="main">=</span> <span class="skolem">w</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> h1 card_asm
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> h1<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> h1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> consistent_sign_vec <span class="free">qs</span> <span class="bound">x</span> <span class="main">=</span> <span class="skolem">w</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> mem_asm 
        <span class="keyword1"><span class="command">unfolding</span></span> characterize_consistent_signs_at_roots_def characterize_root_list_p_def
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="main">∈</span> Collect <span class="main">(</span>List.member <span class="main">(</span>remdups <span class="main">(</span>map <span class="main">(</span>consistent_sign_vec <span class="free">qs</span><span class="main">)</span> <span class="main">(</span>sorted_list_of_set <span class="main">{</span><span class="bound">r</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">r</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> characterize_consistent_signs_at_roots_def mem_asm characterize_root_list_p_def
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> <span class="main"><span class="main">(</span></span>verit<span class="main"><span class="main">,</span></span> ccfv_SIG<span class="main"><span class="main">)</span></span> consistent_sign_vec_def h0 imageE in_set_member list.set_map map_cong mem_Collect_eq nonzero o_apply poly_roots_finite set_remdups set_sorted_list_of_set signs_at_def squash_def<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> f1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="main">∈</span> set <span class="main">(</span>map <span class="main">(</span>consistent_sign_vec <span class="free">qs</span><span class="main">)</span> <span class="main">(</span>sorted_list_of_set <span class="main">{</span><span class="bound">r</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">r</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> in_set_member mem_Collect_eq set_remdups<span class="main">)</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="bound">r</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">r</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> nonzero poly_roots_finite <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">using</span></span> f1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"False"</span></span> <span class="keyword1"><span class="command">using</span></span> h0 h1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> h3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">w</span><span class="main">.</span> rat_of_nat <span class="main">(</span>card <span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> consistent_sign_vec <span class="free">qs</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">w</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟶</span> 
        <span class="bound">w</span> <span class="main">∉</span> set <span class="main">(</span>characterize_consistent_signs_at_roots <span class="free">p</span> <span class="free">qs</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> in_set_member<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> h0 h3
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>characterize_consistent_signs_at_roots <span class="free">p</span> <span class="free">qs</span><span class="main">)</span> <span class="main">⊆</span> set <span class="main">(</span>take_indices <span class="free">signs</span>
             <span class="main">(</span>find_nonzeros_from_input_vec <span class="main">(</span>solve_for_lhs_R <span class="free">p</span> <span class="free">qs</span> <span class="free">subsets</span> <span class="main">(</span>matrix_A_R <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> all_info
      reduction_signs_set_helper_lemma<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> A <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>characterize_consistent_signs_at_roots <span class="free">p</span> <span class="free">qs</span><span class="main">)</span>"</span></span><span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> B <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="free">signs</span>"</span></span><span class="main">,</span>
      <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> C <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>solve_for_lhs_R <span class="free">p</span> <span class="free">qs</span> <span class="free">subsets</span> <span class="main">(</span>matrix_A_R <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">using</span></span> dim_hyp2 solve_for_lhs_R_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mat_inverse_same<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> reduction_signs_R_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Renegar_Proofs-reduction_deletes_bad_sign_conds_R"><span class="command">lemma</span></span> reduction_deletes_bad_sign_conds_R<span class="main">:</span>  
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">p</span><span class="main">::</span> <span class="quoted"><span class="quoted">"real poly"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">qs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real poly list"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">subsets</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>nat list<span class="main">*</span>nat list<span class="main">)</span> list"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">signs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"rat list list"</span></span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> nonzero<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> welldefined_signs1<span class="main">:</span> <span class="quoted"><span class="quoted">"well_def_signs <span class="main">(</span>length <span class="free">qs</span><span class="main">)</span> <span class="free">signs</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> distinct_signs<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="free">signs</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> all_info<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>characterize_consistent_signs_at_roots <span class="free">p</span> <span class="free">qs</span><span class="main">)</span> <span class="main">⊆</span> set<span class="main">(</span><span class="free">signs</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> match<span class="main">:</span> <span class="quoted"><span class="quoted">"satisfy_equation_R <span class="free">p</span> <span class="free">qs</span> <span class="free">subsets</span> <span class="free">signs</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> invertible_mat<span class="main">:</span> <span class="quoted"><span class="quoted">"invertible_mat <span class="main">(</span>matrix_A_R <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>characterize_consistent_signs_at_roots <span class="free">p</span> <span class="free">qs</span><span class="main">)</span> <span class="main">=</span> set<span class="main">(</span>reduction_signs_R <span class="free">p</span> <span class="free">qs</span> <span class="free">signs</span> <span class="free">subsets</span> <span class="main">(</span>matrix_A_R <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
  <span class="keyword1"><span class="command">have</span></span> dim_hyp2<span class="main">:</span> <span class="quoted"><span class="quoted">"matr_option <span class="main">(</span>dim_row <span class="main">(</span>matrix_A_R <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span>
       <span class="main">(</span>mat_inverse <span class="main">(</span>matrix_A_R <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> carrier_mat <span class="main">(</span>length <span class="free">signs</span><span class="main">)</span> <span class="main">(</span>length <span class="free">signs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> invertible_mat dim_invertible
    <span class="keyword1"><span class="command">using</span></span> same_size_R <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span> 
  <span class="keyword1"><span class="command">have</span></span> supset<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>characterize_consistent_signs_at_roots <span class="free">p</span> <span class="free">qs</span><span class="main">)</span> <span class="main">⊇</span> set<span class="main">(</span>reduction_signs_R <span class="free">p</span> <span class="free">qs</span> <span class="free">signs</span> <span class="free">subsets</span> <span class="main">(</span>matrix_A_R <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>construct_lhs_vector_R <span class="free">p</span> <span class="free">qs</span> <span class="free">signs</span><span class="main">)</span> <span class="main">=</span> solve_for_lhs_R <span class="free">p</span> <span class="free">qs</span> <span class="free">subsets</span> <span class="main">(</span>matrix_A_R <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> construct_lhs_matches_solve_for_lhs_R assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>solve_for_lhs_R <span class="free">p</span> <span class="free">qs</span> <span class="free">subsets</span> <span class="main">(</span>matrix_A_R <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
       vec_of_list <span class="main">(</span>map rat_of_nat <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> card <span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> consistent_sign_vec <span class="free">qs</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">s</span><span class="main">}</span><span class="main">)</span> <span class="free">signs</span><span class="main">)</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> construct_lhs_vector_cleaner_R assms
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> list.map_cong map_map o_apply of_int_of_nat_eq<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound"><span class="bound">n</span></span> <span class="main">&lt;</span> <span class="main">(</span>dim_vec <span class="main">(</span>solve_for_lhs_R <span class="free">p</span> <span class="free">qs</span> <span class="free">subsets</span> <span class="main">(</span>matrix_A_R <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> 
           <span class="main">(</span><span class="main">(</span><span class="main">(</span>solve_for_lhs_R <span class="free">p</span> <span class="free">qs</span> <span class="free">subsets</span> <span class="main">(</span>matrix_A_R <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span> <span class="main">$</span> <span class="bound">n</span> <span class="main">≠</span> <span class="main">0</span><span class="main">)</span> <span class="main">⟶</span>
           <span class="main">(</span>nth <span class="free">signs</span> <span class="bound">n</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>characterize_consistent_signs_at_roots <span class="free">p</span> <span class="free">qs</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
      <span class="keyword1"><span class="command">have</span></span> h0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound"><span class="bound">n</span></span> <span class="main">&lt;</span> <span class="main">(</span>dim_vec <span class="main">(</span>solve_for_lhs_R <span class="free">p</span> <span class="free">qs</span> <span class="free">subsets</span> <span class="main">(</span>matrix_A_R <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> 
           <span class="main">(</span><span class="main">(</span><span class="main">(</span>solve_for_lhs_R <span class="free">p</span> <span class="free">qs</span> <span class="free">subsets</span> <span class="main">(</span>matrix_A_R <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span> <span class="main">$</span> <span class="bound">n</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span> <span class="main">⟶</span> 
           rat_of_nat <span class="main">(</span>card <span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> consistent_sign_vec <span class="free">qs</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">(</span>nth <span class="free">signs</span> <span class="bound">n</span><span class="main">)</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹solve_for_lhs_R <span class="free">p</span> <span class="free">qs</span> <span class="free">subsets</span> <span class="main">(</span>M_mat_R <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span> <span class="main">=</span> vec_of_list <span class="main">(</span>map rat_of_nat <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> card <span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> consistent_sign_vec <span class="free">qs</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">s</span><span class="main">}</span><span class="main">)</span> <span class="free">signs</span><span class="main">)</span><span class="main">)</span>›</span></span> vec_of_list_index<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> h1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">w</span><span class="main">.</span> <span class="main">(</span>rat_of_nat <span class="main">(</span>card <span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> consistent_sign_vec <span class="free">qs</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">w</span><span class="main">}</span><span class="main">)</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">⟶</span> 
            <span class="main">(</span><span class="main">∃</span> <span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> consistent_sign_vec <span class="free">qs</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">w</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">clarsimp</span> 
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">w</span>
        <span class="keyword3"><span class="command">assume</span></span> card_asm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> card <span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> consistent_sign_vec <span class="free">qs</span> <span class="bound">x</span> <span class="main">=</span> <span class="skolem">w</span><span class="main">}</span>"</span></span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> consistent_sign_vec <span class="free">qs</span> <span class="bound">x</span> <span class="main">=</span> <span class="skolem">w</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> Collect_empty_eq card_asm card_eq_0_iff gr_implies_not0<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">have</span></span> h2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">w</span><span class="main">.</span> <span class="main">(</span>rat_of_nat <span class="main">(</span>card <span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> consistent_sign_vec <span class="free">qs</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">w</span><span class="main">}</span><span class="main">)</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">⟹</span>
           <span class="main">(</span>List.member <span class="main">(</span>characterize_consistent_signs_at_roots <span class="free">p</span> <span class="free">qs</span><span class="main">)</span> <span class="bound">w</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">clarsimp</span> 
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">w</span>
        <span class="keyword3"><span class="command">assume</span></span> card_asm<span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="main">0</span> <span class="main">&lt;</span> card <span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> consistent_sign_vec <span class="free">qs</span> <span class="bound">x</span> <span class="main">=</span> <span class="skolem">w</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">have</span></span> h0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> consistent_sign_vec <span class="free">qs</span> <span class="bound">x</span> <span class="main">=</span> <span class="skolem">w</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> card_asm
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> h1<span class="main">)</span> 
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"List.member <span class="main">(</span>characterize_consistent_signs_at_roots <span class="free">p</span> <span class="free">qs</span><span class="main">)</span> <span class="skolem">w</span>"</span></span> 
          <span class="keyword1"><span class="command">unfolding</span></span> characterize_consistent_signs_at_roots_def
          <span class="keyword1"><span class="command">using</span></span> in_set_member nonzero poly_roots_finite characterize_root_list_p_def
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> <span class="main"><span class="main">(</span></span>verit<span class="main"><span class="main">)</span></span> characterize_consistent_signs_at_roots_def in_set_R mem_Collect_eq<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> h3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">w</span><span class="main">.</span> rat_of_nat <span class="main">(</span>card <span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> consistent_sign_vec <span class="free">qs</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">w</span><span class="main">}</span><span class="main">)</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">⟶</span> 
            <span class="bound">w</span> <span class="main">∈</span> set <span class="main">(</span>characterize_consistent_signs_at_roots <span class="free">p</span> <span class="free">qs</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> in_set_member<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> h0 h3
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> <span class="quoted"><span class="quoted">‹solve_for_lhs_R <span class="free">p</span> <span class="free">qs</span> <span class="free">subsets</span> <span class="main">(</span>matrix_A_R <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span> <span class="main">=</span> vec_of_list <span class="main">(</span>map rat_of_nat <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> card <span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> consistent_sign_vec <span class="free">qs</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">s</span><span class="main">}</span><span class="main">)</span> <span class="free">signs</span><span class="main">)</span><span class="main">)</span>›</span></span> dim_vec_of_list length_map nth_map vec_of_list_index<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>take_indices <span class="free">signs</span>
                 <span class="main">(</span>find_nonzeros_from_input_vec <span class="main">(</span>solve_for_lhs_R <span class="free">p</span> <span class="free">qs</span> <span class="free">subsets</span> <span class="main">(</span>matrix_A_R <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span>
              set <span class="main">(</span>characterize_consistent_signs_at_roots <span class="free">p</span> <span class="free">qs</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> all_info
        reduction_signs_set_helper_lemma2<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> A <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>characterize_consistent_signs_at_roots <span class="free">p</span> <span class="free">qs</span><span class="main">)</span>"</span></span><span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> B <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="free">signs</span>"</span></span><span class="main">,</span>
        <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> C <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>solve_for_lhs_R <span class="free">p</span> <span class="free">qs</span> <span class="free">subsets</span> <span class="main">(</span>matrix_A_R <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span>"</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">using</span></span> distinct_signs dim_hyp2 solve_for_lhs_R_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mat_inverse_same<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> reduction_signs_R_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">have</span></span> subset<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>characterize_consistent_signs_at_roots <span class="free">p</span> <span class="free">qs</span><span class="main">)</span> <span class="main">⊆</span> set<span class="main">(</span>reduction_signs_R <span class="free">p</span> <span class="free">qs</span> <span class="free">signs</span> <span class="free">subsets</span> <span class="main">(</span>matrix_A_R <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> reduction_doesnt_break_things_signs_R<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">p</span></span> <span class="quoted"><span class="free">qs</span></span> <span class="quoted"><span class="free">signs</span></span> <span class="quoted"><span class="free">subsets</span></span><span class="main">]</span> assms
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> supset subset <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">theorem</span></span> reduce_system_sign_conditions_R<span class="main">:</span>  
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">p</span><span class="main">::</span> <span class="quoted"><span class="quoted">"real poly"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">qs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real poly list"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">subsets</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>nat list<span class="main">*</span>nat list<span class="main">)</span> list"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">signs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"rat list list"</span></span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> nonzero<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> welldefined_signs1<span class="main">:</span> <span class="quoted"><span class="quoted">"well_def_signs <span class="main">(</span>length <span class="free">qs</span><span class="main">)</span> <span class="free">signs</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> distinct_signs<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="free">signs</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> all_info<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>characterize_consistent_signs_at_roots <span class="free">p</span> <span class="free">qs</span><span class="main">)</span> <span class="main">⊆</span> set<span class="main">(</span><span class="free">signs</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> match<span class="main">:</span> <span class="quoted"><span class="quoted">"satisfy_equation_R <span class="free">p</span> <span class="free">qs</span> <span class="free">subsets</span> <span class="free">signs</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> invertible_mat<span class="main">:</span> <span class="quoted"><span class="quoted">"invertible_mat <span class="main">(</span>matrix_A_R <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>get_signs_R <span class="main">(</span>reduce_system_R <span class="free">p</span> <span class="main">(</span><span class="free">qs</span><span class="main">,</span> <span class="main">(</span><span class="main">(</span>matrix_A_R <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free">subsets</span><span class="main">,</span> <span class="free">signs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> set <span class="main">(</span>characterize_consistent_signs_at_roots <span class="free">p</span> <span class="free">qs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> get_signs_R_def
  <span class="keyword1"><span class="command">using</span></span> reduction_deletes_bad_sign_conds_R<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">p</span></span> <span class="quoted"><span class="free">qs</span></span> <span class="quoted"><span class="free">signs</span></span> <span class="quoted"><span class="free">subsets</span></span><span class="main">]</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> all_info distinct_signs match nonzero reduction_signs_def welldefined_signs1<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> nonzero invertible_mat snd_conv
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> reduction_signs_R_def<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> all_info distinct_signs invertible_mat match nonzero reduction_signs_R_def snd_conv welldefined_signs1<span class="main">)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Showing matrix equation preserved when reducing"</span></span>

<span class="keyword1" id="Renegar_Proofs-reduce_system_matrix_equation_preserved_R"><span class="command">lemma</span></span> reduce_system_matrix_equation_preserved_R<span class="main">:</span>  
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">p</span><span class="main">::</span> <span class="quoted"><span class="quoted">"real poly"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">qs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real poly list"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">subsets</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>nat list<span class="main">*</span>nat list<span class="main">)</span> list"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">signs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"rat list list"</span></span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> nonzero<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> welldefined_signs<span class="main">:</span> <span class="quoted"><span class="quoted">"well_def_signs <span class="main">(</span>length <span class="free">qs</span><span class="main">)</span> <span class="free">signs</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> welldefined_subsets<span class="main">:</span> <span class="quoted"><span class="quoted">"all_list_constr_R <span class="main">(</span><span class="free">subsets</span><span class="main">)</span> <span class="main">(</span>length <span class="free">qs</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> distinct_signs<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="free">signs</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> all_info<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>characterize_consistent_signs_at_roots <span class="free">p</span> <span class="free">qs</span><span class="main">)</span> <span class="main">⊆</span> set<span class="main">(</span><span class="free">signs</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> match<span class="main">:</span> <span class="quoted"><span class="quoted">"satisfy_equation_R <span class="free">p</span> <span class="free">qs</span> <span class="free">subsets</span> <span class="free">signs</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> invertible_mat<span class="main">:</span> <span class="quoted"><span class="quoted">"invertible_mat <span class="main">(</span>matrix_A_R <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"satisfy_equation_R <span class="free">p</span> <span class="free">qs</span> <span class="main">(</span>get_subsets_R <span class="main">(</span>reduce_system_R <span class="free">p</span> <span class="main">(</span><span class="free">qs</span><span class="main">,</span> <span class="main">(</span><span class="main">(</span>matrix_A_R <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free">subsets</span><span class="main">,</span> <span class="free">signs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
  <span class="main">(</span>get_signs_R <span class="main">(</span>reduce_system_R <span class="free">p</span> <span class="main">(</span><span class="free">qs</span><span class="main">,</span> <span class="main">(</span><span class="main">(</span>matrix_A_R <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free">subsets</span><span class="main">,</span> <span class="free">signs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
  <span class="keyword1"><span class="command">have</span></span> poly_type_hyp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> nonzero <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> distinct_signs_hyp<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>snd <span class="main">(</span>snd <span class="main">(</span>reduce_system_R <span class="free">p</span> <span class="main">(</span><span class="free">qs</span><span class="main">,</span> <span class="main">(</span><span class="main">(</span>matrix_A_R <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free">subsets</span><span class="main">,</span> <span class="free">signs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?sym</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>find_nonzeros_from_input_vec <span class="main">(</span>solve_for_lhs_R <span class="free">p</span> <span class="free">qs</span> <span class="free">subsets</span> <span class="main">(</span>matrix_A_R <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> h1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> length <span class="main">(</span>take_indices <span class="free">signs</span> <span class="var">?sym</span><span class="main">)</span><span class="main">.</span> <span class="main">∀</span><span class="bound"><span class="bound">j</span></span> <span class="main">&lt;</span> length<span class="main">(</span>take_indices <span class="free">signs</span> <span class="var">?sym</span><span class="main">)</span><span class="main">.</span>
      <span class="bound">i</span> <span class="main">≠</span> <span class="bound">j</span> <span class="main">⟶</span> nth <span class="main">(</span>take_indices <span class="free">signs</span> <span class="var">?sym</span><span class="main">)</span> <span class="bound">i</span> <span class="main">≠</span> nth <span class="main">(</span>take_indices <span class="free">signs</span> <span class="var">?sym</span><span class="main">)</span> <span class="bound">j</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> distinct_signs <span class="keyword1"><span class="command">unfolding</span></span> take_indices_def 
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">clarsimp</span> 
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">j</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"distinct <span class="free">signs</span>"</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> length
                <span class="main">(</span>find_nonzeros_from_input_vec <span class="main">(</span>solve_for_lhs_R <span class="free">p</span> <span class="free">qs</span> <span class="free">subsets</span> <span class="main">(</span>matrix_A_R <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> length
                <span class="main">(</span>find_nonzeros_from_input_vec <span class="main">(</span>solve_for_lhs_R <span class="free">p</span> <span class="free">qs</span> <span class="free">subsets</span> <span class="main">(</span>matrix_A_R <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword3"><span class="command">assume</span></span> neq_hyp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">≠</span> <span class="skolem">j</span>"</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">signs</span> <span class="main">!</span> <span class="main">(</span>find_nonzeros_from_input_vec <span class="main">(</span>solve_for_lhs_R <span class="free">p</span> <span class="free">qs</span> <span class="free">subsets</span> 
              <span class="main">(</span>matrix_A_R <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">=</span>
           <span class="free">signs</span> <span class="main">!</span> <span class="main">(</span>find_nonzeros_from_input_vec <span class="main">(</span>solve_for_lhs_R <span class="free">p</span> <span class="free">qs</span> <span class="free">subsets</span> 
              <span class="main">(</span>matrix_A_R <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> h1<span class="main">:</span> <span class="quoted"><span class="quoted">"find_nonzeros_from_input_vec <span class="main">(</span>solve_for_lhs_R <span class="free">p</span> <span class="free">qs</span> <span class="free">subsets</span> 
              <span class="main">(</span>matrix_A_R <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">≠</span> find_nonzeros_from_input_vec <span class="main">(</span>solve_for_lhs_R <span class="free">p</span> <span class="free">qs</span> <span class="free">subsets</span> 
              <span class="main">(</span>matrix_A_R <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">j</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> find_nonzeros_from_input_vec_def <span class="keyword1"><span class="command">using</span></span> neq_hyp
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="main">(</span>find_nonzeros_from_input_vec <span class="main">(</span>solve_for_lhs_R <span class="free">p</span> <span class="free">qs</span> <span class="free">subsets</span> <span class="main">(</span>matrix_A_R <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">j</span> <span class="main">&lt;</span> length <span class="main">(</span>find_nonzeros_from_input_vec <span class="main">(</span>solve_for_lhs_R <span class="free">p</span> <span class="free">qs</span> <span class="free">subsets</span> <span class="main">(</span>matrix_A_R <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>›</span></span> distinct_conv_nth distinct_filter distinct_upt find_nonzeros_from_input_vec_def<span class="main">)</span> 
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"False"</span></span> <span class="keyword1"><span class="command">using</span></span> distinct_signs
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">have</span></span> f1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span> <span class="bound">ns</span> <span class="bound">n</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="bound">n</span><span class="main">::</span>nat<span class="main">)</span> <span class="main">∈</span> <span class="main">{</span><span class="bound"><span class="bound">n</span></span> <span class="main">∈</span> set <span class="bound">ns</span><span class="main">.</span> <span class="bound">p</span> <span class="bound">n</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="bound">n</span> <span class="main">∈</span> set <span class="bound">ns</span> <span class="main">∧</span> <span class="bound">n</span> <span class="main">∈</span> Collect <span class="bound">p</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> f2<span class="main">:</span> <span class="quoted"><span class="quoted">"filter <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> solve_for_lhs_R <span class="free">p</span> <span class="free">qs</span> <span class="free">subsets</span> <span class="main">(</span>matrix_A_R <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span> <span class="main">$</span> <span class="bound">n</span> <span class="main">≠</span> <span class="main">0</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>dim_vec <span class="main">(</span>solve_for_lhs_R <span class="free">p</span> <span class="free">qs</span> <span class="free">subsets</span> <span class="main">(</span>matrix_A_R <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span><span class="main">]</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">∈</span> set <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="free">signs</span><span class="main">]</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="main">(</span>find_nonzeros_from_input_vec <span class="main">(</span>solve_for_lhs_R <span class="free">p</span> <span class="free">qs</span> <span class="free">subsets</span> <span class="main">(</span>matrix_A_R <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>›</span></span> construct_lhs_matches_solve_for_lhs_R find_nonzeros_from_input_vec_def invertible_mat match nth_mem set_filter size_of_lhs_R<span class="main">)</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"filter <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> solve_for_lhs_R <span class="free">p</span> <span class="free">qs</span> <span class="free">subsets</span> <span class="main">(</span>matrix_A_R <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span> <span class="main">$</span> <span class="bound">n</span> <span class="main">≠</span> <span class="main">0</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>dim_vec <span class="main">(</span>solve_for_lhs_R <span class="free">p</span> <span class="free">qs</span> <span class="free">subsets</span> <span class="main">(</span>matrix_A_R <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span><span class="main">]</span> <span class="main">!</span> <span class="skolem">j</span> <span class="main">∈</span> set <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="free">signs</span><span class="main">]</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> f1 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">j</span> <span class="main">&lt;</span> length <span class="main">(</span>find_nonzeros_from_input_vec <span class="main">(</span>solve_for_lhs_R <span class="free">p</span> <span class="free">qs</span> <span class="free">subsets</span> <span class="main">(</span>matrix_A_R <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>›</span></span> construct_lhs_matches_solve_for_lhs_R find_nonzeros_from_input_vec_def invertible_mat match nth_mem set_filter size_of_lhs_R<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">using</span></span> f2 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹<span class="free">signs</span> <span class="main">!</span> <span class="main">(</span>find_nonzeros_from_input_vec <span class="main">(</span>solve_for_lhs_R <span class="free">p</span> <span class="free">qs</span> <span class="free">subsets</span> <span class="main">(</span>matrix_A_R <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">=</span> <span class="free">signs</span> <span class="main">!</span> <span class="main">(</span>find_nonzeros_from_input_vec <span class="main">(</span>solve_for_lhs_R <span class="free">p</span> <span class="free">qs</span> <span class="free">subsets</span> <span class="main">(</span>matrix_A_R <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">)</span>›</span></span> atLeastLessThan_iff distinct_conv_nth distinct_signs find_nonzeros_from_input_vec_def h1 set_upt<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>take_indices <span class="free">signs</span> <span class="main">(</span>find_nonzeros_from_input_vec <span class="main">(</span>solve_for_lhs_R <span class="free">p</span> <span class="free">qs</span> <span class="free">subsets</span> <span class="main">(</span>matrix_A_R <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> distinct_conv_nth <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> get_signs_R_def reduction_signs_R_def reduction_signs_is_get_signs_R <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">have</span></span> all_info_hyp<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>characterize_consistent_signs_at_roots <span class="free">p</span> <span class="free">qs</span><span class="main">)</span> <span class="main">⊆</span> set<span class="main">(</span>snd <span class="main">(</span>snd <span class="main">(</span>reduce_system_R <span class="free">p</span> <span class="main">(</span><span class="free">qs</span><span class="main">,</span> <span class="main">(</span><span class="main">(</span>matrix_A_R <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free">subsets</span><span class="main">,</span> <span class="free">signs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> reduce_system_sign_conditions_R assms <span class="keyword1"><span class="command">unfolding</span></span> get_signs_R_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> welldefined_hyp<span class="main">:</span> <span class="quoted"><span class="quoted">"all_list_constr_R <span class="main">(</span>fst <span class="main">(</span>snd <span class="main">(</span>reduce_system_R <span class="free">p</span> <span class="main">(</span><span class="free">qs</span><span class="main">,</span> <span class="main">(</span><span class="main">(</span>matrix_A_R <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free">subsets</span><span class="main">,</span> <span class="free">signs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>length <span class="free">qs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> welldefined_subsets rows_to_keep_lem
    <span class="keyword1"><span class="command">unfolding</span></span> all_list_constr_R_def List.member_def list_constr_def list_all_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def take_indices_def take_cols_from_matrix_def<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> nth_mem
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">smt</span> <span class="main"><span class="main">(</span></span>z3<span class="main"><span class="main">)</span></span> mat_of_cols_carrier<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> rows_to_keep_lem<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> <span class="main"><span class="main">(</span></span>z3<span class="main"><span class="main">)</span></span> mat_of_cols_carrier<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> nth_mem rows_to_keep_lem<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> poly_type_hyp distinct_signs_hyp all_info_hyp  welldefined_hyp
    <span class="keyword1"><span class="command">using</span></span> matrix_equation_R <span class="keyword1"><span class="command">unfolding</span></span> get_subsets_R_def get_signs_R_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(* Show that we are tracking the correct matrix in the algorithm *)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Showing matrix preserved"</span></span>
<span class="keyword1" id="Renegar_Proofs-reduce_system_matrix_signs_helper_aux_R"><span class="command">lemma</span></span> reduce_system_matrix_signs_helper_aux_R<span class="main">:</span>  
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">p</span><span class="main">::</span> <span class="quoted"><span class="quoted">"real poly"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">qs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real poly list"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">subsets</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>nat list<span class="main">*</span>nat list<span class="main">)</span> list"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">signs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"rat list list"</span></span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">S</span><span class="main">::</span> <span class="quoted"><span class="quoted">"nat list"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> well_def_h<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">.</span> List.member <span class="free">S</span> <span class="bound">x</span> <span class="main">⟶</span> <span class="bound">x</span> <span class="main">&lt;</span> length <span class="free">signs</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> nonzero<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"alt_matrix_A_R <span class="main">(</span>take_indices <span class="free">signs</span> <span class="free">S</span><span class="main">)</span> <span class="free">subsets</span> <span class="main">=</span> take_cols_from_matrix <span class="main">(</span>alt_matrix_A_R <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span> <span class="free">S</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
  <span class="keyword1"><span class="command">have</span></span> h0a<span class="main">:</span> <span class="quoted"><span class="quoted">"dim_col <span class="main">(</span>take_cols_from_matrix <span class="main">(</span>alt_matrix_A_R <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span> <span class="free">S</span><span class="main">)</span> <span class="main">=</span> length <span class="main">(</span>take_indices <span class="free">signs</span> <span class="free">S</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">unfolding</span></span> take_cols_from_matrix_def <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> take_indices_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> h0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> length <span class="main">(</span>take_indices <span class="free">signs</span> <span class="free">S</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span>col <span class="main">(</span>alt_matrix_A_R <span class="main">(</span>take_indices <span class="free">signs</span> <span class="free">S</span><span class="main">)</span> <span class="free">subsets</span> <span class="main">)</span> <span class="bound">i</span> <span class="main">=</span> 
col <span class="main">(</span>take_cols_from_matrix <span class="main">(</span>alt_matrix_A_R <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span> <span class="free">S</span><span class="main">)</span> <span class="bound">i</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">clarsimp</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span>
    <span class="keyword3"><span class="command">assume</span></span> asm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="main">(</span>take_indices <span class="free">signs</span> <span class="free">S</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> i_lt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="main">(</span>map <span class="main">(</span><span class="main">(!)</span> <span class="main">(</span>cols <span class="main">(</span>alt_matrix_A_R <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">S</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> asm
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> take_indices_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> h0<span class="main">:</span> <span class="quoted"><span class="quoted">" vec <span class="main">(</span>length <span class="free">subsets</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">j</span><span class="main">.</span> z_R <span class="main">(</span><span class="free">subsets</span> <span class="main">!</span> <span class="bound">j</span><span class="main">)</span> <span class="main">(</span>map <span class="main">(</span><span class="main">(!)</span> <span class="free">signs</span><span class="main">)</span> <span class="free">S</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
      vec <span class="main">(</span>length <span class="free">subsets</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">j</span><span class="main">.</span> z_R <span class="main">(</span><span class="free">subsets</span> <span class="main">!</span> <span class="bound">j</span><span class="main">)</span> <span class="main">(</span><span class="free">signs</span> <span class="main">!</span> <span class="main">(</span><span class="free">S</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> nth_map
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="main">(</span>take_indices <span class="free">signs</span> <span class="free">S</span><span class="main">)</span>›</span></span> length_map take_indices_def<span class="main">)</span> 
    <span class="keyword1"><span class="command">have</span></span> dim<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>map <span class="main">(</span><span class="main">(!)</span> <span class="main">(</span>cols <span class="main">(</span>alt_matrix_A_R <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">S</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">∈</span> carrier_vec <span class="main">(</span>dim_row <span class="main">(</span>alt_matrix_A_R <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"dim_col <span class="main">(</span>alt_matrix_A_R <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span> <span class="main">=</span> length <span class="main">(</span><span class="free">signs</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> alt_matrix_A_R_def<span class="main">)</span> 
      <span class="keyword1"><span class="command">have</span></span> well_d<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">&lt;</span> length <span class="main">(</span><span class="free">signs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> well_def_h
        <span class="keyword1"><span class="command">using</span></span> i_lt in_set_member <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span> 
      <span class="keyword1"><span class="command">have</span></span> 
        map_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>map <span class="main">(</span><span class="main">(!)</span> <span class="main">(</span>cols <span class="main">(</span>alt_matrix_A_R <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">S</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">i</span>  <span class="main">=</span> nth <span class="main">(</span>cols <span class="main">(</span>alt_matrix_A_R <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span>  <span class="main">(</span><span class="free">S</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> i_lt <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"nth <span class="main">(</span>cols <span class="main">(</span>alt_matrix_A_R <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span>  <span class="main">(</span><span class="free">S</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">∈</span> carrier_vec <span class="main">(</span>dim_row <span class="main">(</span>alt_matrix_A_R <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> col_dim <span class="keyword1"><span class="command">unfolding</span></span> cols_def <span class="keyword1"><span class="command">using</span></span> nth_map well_d
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹dim_col <span class="main">(</span>alt_matrix_A_R <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span> <span class="main">=</span> length <span class="free">signs</span>›</span></span><span class="main">)</span> 
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> map_eq  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">have</span></span> h1<span class="main">:</span> <span class="quoted"><span class="quoted">"col <span class="main">(</span>take_cols_from_matrix <span class="main">(</span>alt_matrix_A_R <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span> <span class="free">S</span><span class="main">)</span> <span class="skolem">i</span> <span class="main">=</span> 
      col <span class="main">(</span>mat_of_cols <span class="main">(</span>dim_row <span class="main">(</span>alt_matrix_A_R <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>map <span class="main">(</span><span class="main">(!)</span> <span class="main">(</span>cols <span class="main">(</span>alt_matrix_A_R <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">S</span><span class="main">)</span><span class="main">)</span> <span class="skolem">i</span> "</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> take_cols_from_matrix_def take_indices_def<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> h2<span class="main">:</span> <span class="quoted"><span class="quoted">"col <span class="main">(</span>mat_of_cols <span class="main">(</span>dim_row <span class="main">(</span>alt_matrix_A_R <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>map <span class="main">(</span><span class="main">(!)</span> <span class="main">(</span>cols <span class="main">(</span>alt_matrix_A_R <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">S</span><span class="main">)</span><span class="main">)</span> <span class="skolem">i</span> 
      <span class="main">=</span> nth <span class="main">(</span>map <span class="main">(</span><span class="main">(!)</span> <span class="main">(</span>cols <span class="main">(</span>alt_matrix_A_R <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">S</span><span class="main">)</span> <span class="skolem">i</span> "</span></span> 
      <span class="keyword1"><span class="command">using</span></span> dim i_lt asm col_mat_of_cols<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> j <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span>"</span></span><span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> n <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>dim_row <span class="main">(</span>alt_matrix_A_R <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span>"</span></span><span class="main">,</span>
          <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> vs <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>map <span class="main">(</span><span class="main">(!)</span> <span class="main">(</span>cols <span class="main">(</span>alt_matrix_A_R <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">S</span><span class="main">)</span>"</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
    <span class="keyword1"><span class="command">have</span></span> h3<span class="main">:</span> <span class="quoted"><span class="quoted">"col <span class="main">(</span>take_cols_from_matrix <span class="main">(</span>alt_matrix_A_R <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span> <span class="free">S</span><span class="main">)</span> <span class="skolem">i</span> <span class="main">=</span> <span class="main">(</span>col <span class="main">(</span>alt_matrix_A_R <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span> <span class="main">(</span><span class="free">S</span> <span class="main">!</span><span class="skolem">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> h1 h2 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> alt_matrix_char_R asm cols_nth dim_col_mat<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> in_set_member length_map mat_of_rows_list_def matrix_A_R_def nth_map nth_mem take_indices_def well_def_h<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"vec <span class="main">(</span>length <span class="free">subsets</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">j</span><span class="main">.</span> z_R <span class="main">(</span><span class="free">subsets</span> <span class="main">!</span> <span class="bound">j</span><span class="main">)</span> <span class="main">(</span><span class="free">signs</span> <span class="main">!</span> <span class="main">(</span><span class="free">S</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>col <span class="main">(</span>alt_matrix_A_R <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span> <span class="main">(</span><span class="free">S</span> <span class="main">!</span><span class="skolem">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> asm in_set_member length_map nth_mem signs_are_cols_R take_indices_def well_def_h<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"vec <span class="main">(</span>length <span class="free">subsets</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">j</span><span class="main">.</span> z_R <span class="main">(</span><span class="free">subsets</span> <span class="main">!</span> <span class="bound">j</span><span class="main">)</span> <span class="main">(</span>take_indices <span class="free">signs</span> <span class="free">S</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
      col <span class="main">(</span>take_cols_from_matrix <span class="main">(</span>alt_matrix_A_R <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span> <span class="free">S</span><span class="main">)</span> <span class="skolem">i</span> "</span></span>
      <span class="keyword1"><span class="command">using</span></span> h0 h3
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> take_indices_def<span class="main">)</span> 
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"col <span class="main">(</span>alt_matrix_A_R <span class="main">(</span>take_indices <span class="free">signs</span> <span class="free">S</span><span class="main">)</span> <span class="free">subsets</span><span class="main">)</span> <span class="skolem">i</span> <span class="main">=</span>
         col <span class="main">(</span>take_cols_from_matrix <span class="main">(</span>alt_matrix_A_R <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span> <span class="free">S</span><span class="main">)</span> <span class="skolem">i</span> "</span></span>
      <span class="keyword1"><span class="command">using</span></span> asm signs_are_cols_R<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> signs <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>take_indices <span class="free">signs</span> <span class="free">S</span><span class="main">)</span>"</span></span><span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> subsets <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="free">subsets</span>"</span></span><span class="main">]</span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>   <span class="keyword1"><span class="command">unfolding</span></span> alt_matrix_A_R_def take_cols_from_matrix_def <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span> 
    <span class="keyword1"><span class="command">using</span></span> h0a mat_col_eqI
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> alt_matrix_A_R_def dim_col_mat<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> dim_row_mat<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> h0 mat_of_cols_def take_cols_from_matrix_def<span class="main">)</span> 
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1" id="Renegar_Proofs-reduce_system_matrix_signs_helper_R"><span class="command">lemma</span></span> reduce_system_matrix_signs_helper_R<span class="main">:</span>  
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">p</span><span class="main">::</span> <span class="quoted"><span class="quoted">"real poly"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">qs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real poly list"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">subsets</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>nat list<span class="main">*</span>nat list<span class="main">)</span> list"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">signs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"rat list list"</span></span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">S</span><span class="main">::</span> <span class="quoted"><span class="quoted">"nat list"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> well_def_h<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">.</span> List.member <span class="free">S</span> <span class="bound">x</span> <span class="main">⟶</span> <span class="bound">x</span> <span class="main">&lt;</span> length <span class="free">signs</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> nonzero<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"matrix_A_R <span class="main">(</span>take_indices <span class="free">signs</span> <span class="free">S</span><span class="main">)</span> <span class="free">subsets</span> <span class="main">=</span> take_cols_from_matrix <span class="main">(</span>matrix_A_R <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span> <span class="free">S</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> reduce_system_matrix_signs_helper_aux_R alt_matrix_char_R assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Renegar_Proofs-reduce_system_matrix_subsets_helper_aux_R"><span class="command">lemma</span></span> reduce_system_matrix_subsets_helper_aux_R<span class="main">:</span>  
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">p</span><span class="main">::</span> <span class="quoted"><span class="quoted">"real poly"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">qs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real poly list"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">subsets</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>nat list<span class="main">*</span> nat list<span class="main">)</span> list"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">signs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"rat list list"</span></span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">S</span><span class="main">::</span> <span class="quoted"><span class="quoted">"nat list"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> inv<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">subsets</span> <span class="main">≥</span> length <span class="free">signs</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> well_def_h<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">.</span> List.member <span class="free">S</span> <span class="bound">x</span> <span class="main">⟶</span> <span class="bound">x</span> <span class="main">&lt;</span> length <span class="free">subsets</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> nonzero<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"alt_matrix_A_R <span class="free">signs</span> <span class="main">(</span>take_indices <span class="free">subsets</span> <span class="free">S</span><span class="main">)</span> <span class="main">=</span> take_rows_from_matrix <span class="main">(</span>alt_matrix_A_R <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span> <span class="free">S</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
  <span class="keyword1"><span class="command">have</span></span> h0a<span class="main">:</span> <span class="quoted"><span class="quoted">"dim_row <span class="main">(</span>take_rows_from_matrix <span class="main">(</span>alt_matrix_A_R <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span> <span class="free">S</span><span class="main">)</span> <span class="main">=</span> length <span class="main">(</span>take_indices <span class="free">subsets</span> <span class="free">S</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">unfolding</span></span> take_rows_from_matrix_def <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> take_indices_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> h0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> length <span class="main">(</span>take_indices <span class="free">subsets</span> <span class="free">S</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span>row <span class="main">(</span>alt_matrix_A_R <span class="free">signs</span> <span class="main">(</span>take_indices <span class="free">subsets</span> <span class="free">S</span><span class="main">)</span> <span class="main">)</span> <span class="bound">i</span> <span class="main">=</span> 
row <span class="main">(</span>take_rows_from_matrix <span class="main">(</span>alt_matrix_A_R <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span> <span class="free">S</span><span class="main">)</span> <span class="bound">i</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">clarsimp</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span>
    <span class="keyword3"><span class="command">assume</span></span> asm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="main">(</span>take_indices <span class="free">subsets</span> <span class="free">S</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> i_lt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="main">(</span>map <span class="main">(</span><span class="main">(!)</span> <span class="main">(</span>rows <span class="main">(</span>alt_matrix_A_R <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">S</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> asm
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> take_indices_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> h0<span class="main">:</span> <span class="quoted"><span class="quoted">"row <span class="main">(</span>take_rows_from_matrix <span class="main">(</span>alt_matrix_A_R <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span> <span class="free">S</span><span class="main">)</span> <span class="skolem">i</span> <span class="main">=</span>
    row <span class="main">(</span>mat_of_rows <span class="main">(</span>dim_col <span class="main">(</span>alt_matrix_A_R <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>map <span class="main">(</span><span class="main">(!)</span> <span class="main">(</span>rows <span class="main">(</span>alt_matrix_A_R <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">S</span><span class="main">)</span><span class="main">)</span> <span class="skolem">i</span> "</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> take_rows_from_matrix_def take_indices_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> dim<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>map <span class="main">(</span><span class="main">(!)</span> <span class="main">(</span>rows <span class="main">(</span>alt_matrix_A_R <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">S</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">∈</span> carrier_vec <span class="main">(</span>dim_col <span class="main">(</span>alt_matrix_A_R <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"dim_col <span class="main">(</span>alt_matrix_A_R <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span> <span class="main">=</span> length <span class="main">(</span><span class="free">signs</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> alt_matrix_A_R_def<span class="main">)</span> 
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> lenh<span class="main">:</span> <span class="quoted"><span class="quoted">"dim_col <span class="main">(</span>alt_matrix_A_R <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span> <span class="main">≤</span> length <span class="main">(</span><span class="free">subsets</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> assms
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
      <span class="keyword1"><span class="command">have</span></span> well_d<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">&lt;</span> length <span class="main">(</span><span class="free">subsets</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> well_def_h
        <span class="keyword1"><span class="command">using</span></span> i_lt in_set_member <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span> 
      <span class="keyword1"><span class="command">have</span></span> 
        map_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>map <span class="main">(</span><span class="main">(!)</span> <span class="main">(</span>rows <span class="main">(</span>alt_matrix_A_R <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">S</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">i</span>  <span class="main">=</span> nth <span class="main">(</span>rows <span class="main">(</span>alt_matrix_A_R <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span>  <span class="main">(</span><span class="free">S</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> i_lt <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"nth <span class="main">(</span>rows <span class="main">(</span>alt_matrix_A_R <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span>  <span class="main">(</span><span class="free">S</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">∈</span> carrier_vec <span class="main">(</span>dim_col <span class="main">(</span>alt_matrix_A_R <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> col_dim <span class="keyword1"><span class="command">unfolding</span></span> rows_def <span class="keyword1"><span class="command">using</span></span> nth_map well_d
        <span class="keyword1"><span class="command">using</span></span> lenh
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> alt_matrix_A_R_def<span class="main">)</span> 
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> map_eq <span class="keyword1"><span class="command">unfolding</span></span> alt_matrix_A_R_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">have</span></span> h1<span class="main">:</span> <span class="quoted"><span class="quoted">" row <span class="main">(</span>mat_of_rows <span class="main">(</span>dim_col <span class="main">(</span>alt_matrix_A_R <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>map <span class="main">(</span><span class="main">(!)</span> <span class="main">(</span>rows <span class="main">(</span>alt_matrix_A_R <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">S</span><span class="main">)</span><span class="main">)</span> <span class="skolem">i</span>
      <span class="main">=</span> <span class="main">(</span>row  <span class="main">(</span>alt_matrix_A_R <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span> <span class="main">(</span><span class="free">S</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span> "</span></span>
      <span class="keyword1"><span class="command">using</span></span> dim i_lt mat_of_rows_row<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> i <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span>"</span></span><span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> n <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>dim_col <span class="main">(</span>alt_matrix_A_R <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span>"</span></span><span class="main">,</span>
          <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> vs <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>map <span class="main">(</span><span class="main">(!)</span> <span class="main">(</span>rows <span class="main">(</span>alt_matrix_A_R <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">S</span><span class="main">)</span>"</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">using</span></span> alt_matrix_char_R in_set_member nth_mem well_def_h
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"row <span class="main">(</span>alt_matrix_A_R <span class="free">signs</span> <span class="main">(</span>take_indices <span class="free">subsets</span> <span class="free">S</span><span class="main">)</span> <span class="main">)</span> <span class="skolem">i</span> <span class="main">=</span> <span class="main">(</span>row  <span class="main">(</span>alt_matrix_A_R <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span> <span class="main">(</span><span class="free">S</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> subsets_are_rows_R
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> f1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="free">S</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> asm length_map take_indices_def<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"List.member <span class="free">S</span> <span class="main">(</span><span class="free">S</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> in_set_member nth_mem<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> f1 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹<span class="main">⋀</span><span class="bound">subsets</span> <span class="bound">signs</span><span class="main">.</span> <span class="main">∀</span><span class="bound"><span class="bound">i</span></span><span class="main">&lt;</span>length <span class="bound">subsets</span><span class="main">.</span> row <span class="main">(</span>alt_matrix_A_R <span class="bound">signs</span> <span class="bound">subsets</span><span class="main">)</span> <span class="bound">i</span> <span class="main">=</span> vec <span class="main">(</span>length <span class="bound">signs</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">j</span><span class="main">.</span> z_R <span class="main">(</span><span class="bound">subsets</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="bound">signs</span> <span class="main">!</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span>›</span></span> take_indices_def well_def_h<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span> 
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>row <span class="main">(</span>alt_matrix_A_R <span class="free">signs</span> <span class="main">(</span>take_indices <span class="free">subsets</span> <span class="free">S</span><span class="main">)</span> <span class="main">)</span> <span class="skolem">i</span> <span class="main">=</span> 
      row <span class="main">(</span>take_rows_from_matrix <span class="main">(</span>alt_matrix_A_R <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span> <span class="free">S</span><span class="main">)</span> <span class="skolem">i</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> h0 h1 <span class="keyword1"><span class="command">unfolding</span></span> take_indices_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>  <span class="keyword1"><span class="command">unfolding</span></span> alt_matrix_A_R_def take_rows_from_matrix_def <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span> 
    <span class="keyword1"><span class="command">using</span></span> eq_rowI
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> alt_matrix_A_R_def dim_col_mat<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> dim_row_mat<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> h0 h0a mat_of_rows_def take_rows_from_matrix_def<span class="main">)</span> 
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1" id="Renegar_Proofs-reduce_system_matrix_subsets_helper_R"><span class="command">lemma</span></span> reduce_system_matrix_subsets_helper_R<span class="main">:</span>  
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">p</span><span class="main">::</span> <span class="quoted"><span class="quoted">"real poly"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">qs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real poly list"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">subsets</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>nat list<span class="main">*</span>nat list<span class="main">)</span> list"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">signs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"rat list list"</span></span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">S</span><span class="main">::</span> <span class="quoted"><span class="quoted">"nat list"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> nonzero<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> inv<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">subsets</span> <span class="main">≥</span> length <span class="free">signs</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> well_def_h<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">.</span> List.member <span class="free">S</span> <span class="bound">x</span> <span class="main">⟶</span> <span class="bound">x</span> <span class="main">&lt;</span> length <span class="free">subsets</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"matrix_A_R <span class="free">signs</span> <span class="main">(</span>take_indices <span class="free">subsets</span> <span class="free">S</span><span class="main">)</span> <span class="main">=</span> take_rows_from_matrix <span class="main">(</span>matrix_A_R <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span> <span class="free">S</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms reduce_system_matrix_subsets_helper_aux_R alt_matrix_char_R
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Renegar_Proofs-reduce_system_matrix_match_R"><span class="command">lemma</span></span> reduce_system_matrix_match_R<span class="main">:</span>  
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">p</span><span class="main">::</span> <span class="quoted"><span class="quoted">"real poly"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">qs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real poly list"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">subsets</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>nat list<span class="main">*</span>nat list<span class="main">)</span> list"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">signs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"rat list list"</span></span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> nonzero<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> welldefined_signs1<span class="main">:</span> <span class="quoted"><span class="quoted">"well_def_signs <span class="main">(</span>length <span class="free">qs</span><span class="main">)</span> <span class="free">signs</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> distinct_signs<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="free">signs</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> all_info<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>characterize_consistent_signs_at_roots <span class="free">p</span> <span class="free">qs</span><span class="main">)</span> <span class="main">⊆</span> set<span class="main">(</span><span class="free">signs</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> match<span class="main">:</span> <span class="quoted"><span class="quoted">"satisfy_equation_R <span class="free">p</span> <span class="free">qs</span> <span class="free">subsets</span> <span class="free">signs</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> inv<span class="main">:</span> <span class="quoted"><span class="quoted">"invertible_mat <span class="main">(</span>matrix_A_R <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"matrix_A_R <span class="main">(</span>get_signs_R <span class="main">(</span>reduce_system_R <span class="free">p</span> <span class="main">(</span><span class="free">qs</span><span class="main">,</span> <span class="main">(</span><span class="main">(</span>matrix_A_R <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free">subsets</span><span class="main">,</span> <span class="free">signs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
  <span class="main">(</span>get_subsets_R <span class="main">(</span>reduce_system_R <span class="free">p</span> <span class="main">(</span><span class="free">qs</span><span class="main">,</span> <span class="main">(</span><span class="main">(</span>matrix_A_R <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free">subsets</span><span class="main">,</span> <span class="free">signs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
  <span class="main">(</span>get_matrix_R <span class="main">(</span>reduce_system_R <span class="free">p</span> <span class="main">(</span><span class="free">qs</span><span class="main">,</span> <span class="main">(</span><span class="main">(</span>matrix_A_R <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free">subsets</span><span class="main">,</span> <span class="free">signs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?A</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>matrix_A_R <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?lhs_vec</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>solve_for_lhs_R <span class="free">p</span> <span class="free">qs</span> <span class="free">subsets</span> <span class="main">(</span>matrix_A_R <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?red_mtx</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>take_rows_from_matrix <span class="main">(</span>reduce_mat_cols <span class="main">(</span>matrix_A_R <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span> <span class="var">?lhs_vec</span><span class="main">)</span> <span class="main">(</span>rows_to_keep <span class="main">(</span>reduce_mat_cols <span class="main">(</span>matrix_A_R <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span> <span class="var">?lhs_vec</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> h1<span class="main">:</span> <span class="quoted"><span class="quoted">"matrix_A_R <span class="main">(</span>get_signs_R <span class="main">(</span>reduce_system_R <span class="free">p</span> <span class="main">(</span><span class="free">qs</span><span class="main">,</span> <span class="main">(</span><span class="main">(</span>matrix_A_R <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free">subsets</span><span class="main">,</span> <span class="free">signs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
  <span class="main">(</span>get_subsets_R <span class="main">(</span>reduce_system_R <span class="free">p</span> <span class="main">(</span><span class="free">qs</span><span class="main">,</span> <span class="main">(</span><span class="main">(</span>matrix_A_R <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free">subsets</span><span class="main">,</span> <span class="free">signs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
   <span class="main">=</span> matrix_A_R <span class="main">(</span>reduction_signs_R <span class="free">p</span> <span class="free">qs</span> <span class="free">signs</span> <span class="free">subsets</span> <span class="main">(</span>matrix_A_R <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>reduction_subsets_R <span class="free">p</span> <span class="free">qs</span> <span class="free">signs</span> <span class="free">subsets</span> <span class="main">(</span>matrix_A_R <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> reduction_signs_is_get_signs_R reduction_subsets_is_get_subsets_R <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> h1_var<span class="main">:</span> <span class="quoted"><span class="quoted">"matrix_A_R <span class="main">(</span>get_signs_R <span class="main">(</span>reduce_system_R <span class="free">p</span> <span class="main">(</span><span class="free">qs</span><span class="main">,</span> <span class="main">(</span><span class="main">(</span>matrix_A_R <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free">subsets</span><span class="main">,</span> <span class="free">signs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
  <span class="main">(</span>get_subsets_R <span class="main">(</span>reduce_system_R <span class="free">p</span> <span class="main">(</span><span class="free">qs</span><span class="main">,</span> <span class="main">(</span><span class="main">(</span>matrix_A_R <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free">subsets</span><span class="main">,</span> <span class="free">signs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
   <span class="main">=</span> matrix_A_R <span class="main">(</span>take_indices <span class="free">signs</span> <span class="main">(</span>find_nonzeros_from_input_vec <span class="var">?lhs_vec</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>take_indices <span class="free">subsets</span> <span class="main">(</span>rows_to_keep <span class="main">(</span>reduce_mat_cols <span class="var">?A</span> <span class="var">?lhs_vec</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> h1 reduction_signs_R_def reduction_subsets_R_def  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
  <span class="keyword1"><span class="command">have</span></span> h2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?red_mtx</span> <span class="main">=</span> <span class="main">(</span>take_rows_from_matrix <span class="main">(</span>take_cols_from_matrix <span class="var">?A</span> <span class="main">(</span>find_nonzeros_from_input_vec <span class="var">?lhs_vec</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>rows_to_keep <span class="main">(</span>take_cols_from_matrix <span class="var">?A</span> <span class="main">(</span>find_nonzeros_from_input_vec <span class="var">?lhs_vec</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> h30<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>construct_lhs_vector_R <span class="free">p</span> <span class="free">qs</span> <span class="free">signs</span><span class="main">)</span> <span class="main">=</span> <span class="var">?lhs_vec</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms construct_lhs_matches_solve_for_lhs_R
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> 
  <span class="keyword1"><span class="command">have</span></span> h3a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">.</span> List.member <span class="main">(</span>find_nonzeros_from_input_vec <span class="var">?lhs_vec</span><span class="main">)</span> <span class="bound">x</span> <span class="main">⟶</span><span class="bound">x</span> <span class="main">&lt;</span> length <span class="main">(</span><span class="free">signs</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> h30 size_of_lhs_R<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">p</span></span> <span class="quoted"><span class="free">qs</span></span> <span class="quoted"><span class="free">signs</span></span><span class="main">]</span>  
    <span class="keyword1"><span class="command">unfolding</span></span> find_nonzeros_from_input_vec_def <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> in_set_member <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">have</span></span> h3b_a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">.</span> List.member <span class="main">(</span>find_nonzeros_from_input_vec <span class="var">?lhs_vec</span><span class="main">)</span> <span class="bound">x</span> <span class="main">⟶</span><span class="bound">x</span> <span class="main">&lt;</span> length <span class="main">(</span><span class="free">subsets</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> assms h30 size_of_lhs_R same_size_R <span class="keyword1"><span class="command">unfolding</span></span> find_nonzeros_from_input_vec_def <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> find_nonzeros_from_input_vec_def h3a<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> h3ba<span class="main">:</span> <span class="quoted"><span class="quoted">"length
     <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> solve_for_lhs_R <span class="free">p</span> <span class="free">qs</span> <span class="free">subsets</span> <span class="main">(</span>matrix_A_R <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span> <span class="main">$</span> <span class="bound">i</span> <span class="main">≠</span> <span class="main">0</span><span class="main">)</span>
       <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="free">subsets</span><span class="main">]</span><span class="main">)</span>
    <span class="main">≤</span> length <span class="free">subsets</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> length_filter_le<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> P <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> solve_for_lhs_R <span class="free">p</span> <span class="free">qs</span> <span class="free">subsets</span> <span class="main">(</span>matrix_A_R <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span> <span class="main">$</span> <span class="bound">i</span> <span class="main">≠</span> <span class="main">0</span><span class="main">)</span>"</span></span><span class="main">,</span>
    <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> xs <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="free">subsets</span><span class="main">]</span>"</span></span><span class="main">]</span> length_upto <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">" length <span class="free">subsets</span> <span class="main">=</span> dim_vec <span class="main">(</span>solve_for_lhs_R <span class="free">p</span> <span class="free">qs</span> <span class="free">subsets</span> <span class="main">(</span>matrix_A_R <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> h30 inv size_of_lhs_R same_size_R<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">signs</span></span> <span class="quoted"><span class="free">subsets</span></span><span class="main">]</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length
     <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> solve_for_lhs_R <span class="free">p</span> <span class="free">qs</span> <span class="free">subsets</span> <span class="main">(</span>matrix_A_R <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span> <span class="main">$</span> <span class="bound">i</span> <span class="main">≠</span> <span class="main">0</span><span class="main">)</span>
       <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>dim_vec <span class="main">(</span>solve_for_lhs_R <span class="free">p</span> <span class="free">qs</span> <span class="free">subsets</span> <span class="main">(</span>matrix_A_R <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span><span class="main">]</span><span class="main">)</span>
    <span class="main">≤</span> length <span class="free">subsets</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> h3ba
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> h3b<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">subsets</span> <span class="main">≥</span> length <span class="main">(</span>take_indices <span class="free">signs</span> <span class="main">(</span>find_nonzeros_from_input_vec <span class="var">?lhs_vec</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">unfolding</span></span> take_indices_def find_nonzeros_from_input_vec_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> h3c<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">.</span> List.member <span class="main">(</span>rows_to_keep <span class="main">(</span>reduce_mat_cols <span class="var">?A</span> <span class="var">?lhs_vec</span><span class="main">)</span><span class="main">)</span> <span class="bound">x</span> <span class="main">⟶</span> <span class="bound">x</span> <span class="main">&lt;</span> length <span class="main">(</span><span class="free">subsets</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">clarsimp</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
    <span class="keyword3"><span class="command">assume</span></span> x_mem<span class="main">:</span> <span class="quoted"><span class="quoted">"List.member <span class="main">(</span>rows_to_keep
            <span class="main">(</span>take_cols_from_matrix <span class="main">(</span>matrix_A_R <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span>
              <span class="main">(</span>find_nonzeros_from_input_vec <span class="main">(</span>solve_for_lhs_R <span class="free">p</span> <span class="free">qs</span> <span class="free">subsets</span> <span class="main">(</span>matrix_A_R <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">x</span>"</span></span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">nn</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"rat list list <span class="main">⇒</span> nat list <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x2</span> <span class="bound">x3</span><span class="main">.</span> <span class="main">(</span><span class="main">∃</span><span class="bound">v4</span><span class="main">.</span> <span class="bound">v4</span> <span class="main">∈</span> set <span class="bound">x3</span> <span class="main">∧</span> <span class="main">¬</span> <span class="bound">v4</span> <span class="main">&lt;</span> length <span class="bound">x2</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">nn</span> <span class="bound">x2</span> <span class="bound">x3</span> <span class="main">∈</span> set <span class="bound">x3</span> <span class="main">∧</span> <span class="main">¬</span> <span class="skolem">nn</span> <span class="bound">x2</span> <span class="bound">x3</span> <span class="main">&lt;</span> length <span class="bound">x2</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">moura</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> f4<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">nn</span> <span class="free">signs</span> <span class="main">(</span>find_nonzeros_from_input_vec <span class="main">(</span>solve_for_lhs_R <span class="free">p</span> <span class="free">qs</span> <span class="free">subsets</span> <span class="main">(</span>matrix_A_R <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>find_nonzeros_from_input_vec <span class="main">(</span>solve_for_lhs_R <span class="free">p</span> <span class="free">qs</span> <span class="free">subsets</span> <span class="main">(</span>matrix_A_R <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="main">¬</span> <span class="skolem">nn</span> <span class="free">signs</span> <span class="main">(</span>find_nonzeros_from_input_vec <span class="main">(</span>solve_for_lhs_R <span class="free">p</span> <span class="free">qs</span> <span class="free">subsets</span> <span class="main">(</span>matrix_A_R <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">&lt;</span> length <span class="free">signs</span> <span class="main">∨</span> matrix_A_R <span class="main">(</span>take_indices <span class="free">signs</span> <span class="main">(</span>find_nonzeros_from_input_vec <span class="main">(</span>solve_for_lhs_R <span class="free">p</span> <span class="free">qs</span> <span class="free">subsets</span> <span class="main">(</span>matrix_A_R <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">subsets</span> <span class="main">=</span> take_cols_from_matrix <span class="main">(</span>matrix_A_R <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span> <span class="main">(</span>find_nonzeros_from_input_vec <span class="main">(</span>solve_for_lhs_R <span class="free">p</span> <span class="free">qs</span> <span class="free">subsets</span> <span class="main">(</span>matrix_A_R <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> nonzero
      <span class="keyword1"><span class="command">using</span></span> h3a reduce_system_matrix_signs_helper_R <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"matrix_A_R <span class="main">(</span>take_indices <span class="free">signs</span> <span class="main">(</span>find_nonzeros_from_input_vec <span class="main">(</span>solve_for_lhs_R <span class="free">p</span> <span class="free">qs</span> <span class="free">subsets</span> <span class="main">(</span>matrix_A_R <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">subsets</span> <span class="main">=</span> take_cols_from_matrix <span class="main">(</span>matrix_A_R <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span> <span class="main">(</span>find_nonzeros_from_input_vec <span class="main">(</span>solve_for_lhs_R <span class="free">p</span> <span class="free">qs</span> <span class="free">subsets</span> <span class="main">(</span>matrix_A_R <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="skolem">x</span> <span class="main">∈</span> set <span class="main">(</span>map snd <span class="main">(</span>pivot_positions <span class="main">(</span>gauss_jordan_single <span class="main">(</span>take_cols_from_matrix <span class="main">(</span>matrix_A_R <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span> <span class="main">(</span>find_nonzeros_from_input_vec <span class="main">(</span>solve_for_lhs_R <span class="free">p</span> <span class="free">qs</span> <span class="free">subsets</span> <span class="main">(</span>matrix_A_R <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="keyword1"><span class="hidden">⇧</span><sup>T</sup></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> f4
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> h3a in_set_member rows_to_keep_def x_mem<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">&lt;</span> length <span class="main">(</span><span class="free">subsets</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> x_mem <span class="keyword1"><span class="command">unfolding</span></span> rows_to_keep_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> dim_row_matrix_A_R rows_to_keep_def rows_to_keep_lem<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">have</span></span> h3<span class="main">:</span> <span class="quoted"><span class="quoted">"matrix_A_R <span class="main">(</span>take_indices <span class="free">signs</span> <span class="main">(</span>find_nonzeros_from_input_vec <span class="var">?lhs_vec</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>take_indices <span class="free">subsets</span> <span class="main">(</span>rows_to_keep <span class="main">(</span>reduce_mat_cols <span class="var">?A</span> <span class="var">?lhs_vec</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
    <span class="main">(</span>take_rows_from_matrix <span class="main">(</span>take_cols_from_matrix <span class="var">?A</span> <span class="main">(</span>find_nonzeros_from_input_vec <span class="var">?lhs_vec</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>rows_to_keep <span class="main">(</span>take_cols_from_matrix <span class="var">?A</span> <span class="main">(</span>find_nonzeros_from_input_vec <span class="var">?lhs_vec</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> inv h3a h3b h3c reduce_system_matrix_subsets_helper_R reduce_system_matrix_signs_helper_R
      assms 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> h1 h2 h3 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> fst_conv get_matrix_R_def h1_var reduce_system_R.simps reduction_step_R.simps<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Showing invertibility preserved when reducing"</span></span>

<span class="comment1">(* gauss_jordan_single_rank is critically helpful in this subsection *)</span>
<span class="keyword1"><span class="command">thm</span></span> conjugatable_vec_space.gauss_jordan_single_rank

<span class="keyword1"><span class="command">thm</span></span> vec_space.full_rank_lin_indpt

<span class="comment1">(* Overall:
  Start with a matrix equation.
  Input a matrix, subsets, and signs.
  Drop columns of the matrix based on the 0's on the LHS---so extract a list of 0's. Reduce signs accordingly.
  Then find a list of rows to delete based on using rank (use the transpose result, pivot positions!),
   and delete those rows.  Reduce subsets accordingly.
  End with a reduced system! *)</span>
<span class="keyword1" id="Renegar_Proofs-well_def_find_zeros_from_lhs_vec_R"><span class="command">lemma</span></span> well_def_find_zeros_from_lhs_vec_R<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">p</span><span class="main">::</span> <span class="quoted"><span class="quoted">"real poly"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">qs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real poly list"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">subsets</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>nat list<span class="main">*</span>nat list<span class="main">)</span> list"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">signs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"rat list list"</span></span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> len_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">subsets</span> <span class="main">=</span> length <span class="free">signs</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> inv<span class="main">:</span> <span class="quoted"><span class="quoted">"invertible_mat <span class="main">(</span>matrix_A_R <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> nonzero<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> welldefined_signs1<span class="main">:</span> <span class="quoted"><span class="quoted">"well_def_signs <span class="main">(</span>length <span class="free">qs</span><span class="main">)</span> <span class="free">signs</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> distinct_signs<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="free">signs</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> all_info<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>characterize_consistent_signs_at_roots <span class="free">p</span> <span class="free">qs</span><span class="main">)</span> <span class="main">⊆</span> set<span class="main">(</span><span class="free">signs</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> match<span class="main">:</span> <span class="quoted"><span class="quoted">"satisfy_equation_R <span class="free">p</span> <span class="free">qs</span> <span class="free">subsets</span> <span class="free">signs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">j</span><span class="main">.</span> <span class="bound">j</span> <span class="main">∈</span> set <span class="main">(</span>find_nonzeros_from_input_vec
                    <span class="main">(</span>solve_for_lhs_R <span class="free">p</span> <span class="free">qs</span> <span class="free">subsets</span> <span class="main">(</span>matrix_A_R <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span>
          <span class="bound">j</span> <span class="main">&lt;</span> length <span class="main">(</span>cols <span class="main">(</span>matrix_A_R <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">j</span>
  <span class="keyword3"><span class="command">assume</span></span> j_in<span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="skolem">j</span> <span class="main">∈</span> set <span class="main">(</span>find_nonzeros_from_input_vec
                      <span class="main">(</span>solve_for_lhs_R <span class="free">p</span> <span class="free">qs</span> <span class="free">subsets</span> <span class="main">(</span>matrix_A_R <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> "</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?og_mat</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>matrix_A_R <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?lhs</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>solve_for_lhs_R <span class="free">p</span> <span class="free">qs</span> <span class="free">subsets</span> <span class="var">?og_mat</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?new_mat</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>take_rows_from_matrix <span class="main">(</span>reduce_mat_cols <span class="var">?og_mat</span> <span class="var">?lhs</span><span class="main">)</span> <span class="main">(</span>rows_to_keep <span class="main">(</span>reduce_mat_cols <span class="var">?og_mat</span> <span class="var">?lhs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"square_mat <span class="main">(</span>matrix_A_R <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> inv
    <span class="keyword1"><span class="command">using</span></span> invertible_mat_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> mat_size<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?og_mat</span> <span class="main">∈</span> carrier_mat <span class="main">(</span>length <span class="free">signs</span><span class="main">)</span> <span class="main">(</span>length <span class="free">signs</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> size_of_mat
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"dim_vec <span class="main">(</span>solve_for_lhs_R <span class="free">p</span> <span class="free">qs</span> <span class="free">subsets</span> <span class="main">(</span>matrix_A_R <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>length <span class="free">signs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> size_of_lhs_R construct_lhs_matches_solve_for_lhs_R assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> h<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> <span class="main">(</span>length <span class="free">signs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> j_in <span class="keyword1"><span class="command">unfolding</span></span> find_nonzeros_from_input_vec_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span>  length <span class="main">(</span>cols <span class="main">(</span>matrix_A_R <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> mat_size <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1" id="Renegar_Proofs-take_cols_subsets_og_cols_R"><span class="command">lemma</span></span> take_cols_subsets_og_cols_R<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">p</span><span class="main">::</span> <span class="quoted"><span class="quoted">"real poly"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">qs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real poly list"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">subsets</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>nat list<span class="main">*</span>nat list<span class="main">)</span> list"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">signs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"rat list list"</span></span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> len_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">subsets</span> <span class="main">=</span> length <span class="free">signs</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> inv<span class="main">:</span> <span class="quoted"><span class="quoted">"invertible_mat <span class="main">(</span>matrix_A_R <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> nonzero<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> welldefined_signs1<span class="main">:</span> <span class="quoted"><span class="quoted">"well_def_signs <span class="main">(</span>length <span class="free">qs</span><span class="main">)</span> <span class="free">signs</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> distinct_signs<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="free">signs</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> all_info<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>characterize_consistent_signs_at_roots <span class="free">p</span> <span class="free">qs</span><span class="main">)</span> <span class="main">⊆</span> set<span class="main">(</span><span class="free">signs</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> match<span class="main">:</span> <span class="quoted"><span class="quoted">"satisfy_equation_R <span class="free">p</span> <span class="free">qs</span> <span class="free">subsets</span> <span class="free">signs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>take_indices <span class="main">(</span>cols <span class="main">(</span>matrix_A_R <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span>
          <span class="main">(</span>find_nonzeros_from_input_vec <span class="main">(</span>solve_for_lhs_R <span class="free">p</span> <span class="free">qs</span> <span class="free">subsets</span> <span class="main">(</span>matrix_A_R <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
    <span class="main">⊆</span> set <span class="main">(</span>cols <span class="main">(</span>matrix_A_R <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> well_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">j</span><span class="main">.</span> <span class="bound">j</span> <span class="main">∈</span> set <span class="main">(</span>find_nonzeros_from_input_vec
                    <span class="main">(</span>solve_for_lhs_R <span class="free">p</span> <span class="free">qs</span> <span class="free">subsets</span> <span class="main">(</span>matrix_A_R <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span>
          <span class="bound">j</span> <span class="main">&lt;</span> length <span class="main">(</span>cols <span class="main">(</span>matrix_A_R <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms well_def_find_zeros_from_lhs_vec_R <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> set <span class="main">(</span>take_indices <span class="main">(</span>cols <span class="main">(</span>matrix_A_R <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span>
          <span class="main">(</span>find_nonzeros_from_input_vec <span class="main">(</span>solve_for_lhs_R <span class="free">p</span> <span class="free">qs</span> <span class="free">subsets</span> <span class="main">(</span>matrix_A_R <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> 
    <span class="main">⟶</span> <span class="bound">x</span> <span class="main">∈</span>  set <span class="main">(</span>cols <span class="main">(</span>matrix_A_R <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">clarsimp</span> 
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?og_list</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>cols <span class="main">(</span>matrix_A_R <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?ind_list</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>find_nonzeros_from_input_vec
                     <span class="main">(</span>solve_for_lhs_R <span class="free">p</span> <span class="free">qs</span> <span class="free">subsets</span> <span class="main">(</span>matrix_A_R <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> x_in<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> set <span class="main">(</span>take_indices <span class="var">?og_list</span> <span class="var">?ind_list</span><span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> set <span class="main">(</span>cols <span class="main">(</span>matrix_A_R <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> x_in <span class="keyword1"><span class="command">unfolding</span></span> take_indices_def <span class="keyword1"><span class="command">using</span></span> in_set_member <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> in_set_conv_nth well_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1" id="Renegar_Proofs-reduction_doesnt_break_things_invertibility_step1_R"><span class="command">lemma</span></span> reduction_doesnt_break_things_invertibility_step1_R<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">p</span><span class="main">::</span> <span class="quoted"><span class="quoted">"real poly"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">qs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real poly list"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">subsets</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>nat list<span class="main">*</span>nat list<span class="main">)</span> list"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">signs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"rat list list"</span></span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> len_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">subsets</span> <span class="main">=</span> length <span class="free">signs</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> inv<span class="main">:</span> <span class="quoted"><span class="quoted">"invertible_mat <span class="main">(</span>matrix_A_R <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> nonzero<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> welldefined_signs1<span class="main">:</span> <span class="quoted"><span class="quoted">"well_def_signs <span class="main">(</span>length <span class="free">qs</span><span class="main">)</span> <span class="free">signs</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> distinct_signs<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="free">signs</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> all_info<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>characterize_consistent_signs_at_roots <span class="free">p</span> <span class="free">qs</span><span class="main">)</span> <span class="main">⊆</span> set<span class="main">(</span><span class="free">signs</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> match<span class="main">:</span> <span class="quoted"><span class="quoted">"satisfy_equation_R <span class="free">p</span> <span class="free">qs</span> <span class="free">subsets</span> <span class="free">signs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"vec_space.rank <span class="main">(</span>length <span class="free">signs</span><span class="main">)</span> <span class="main">(</span>reduce_mat_cols <span class="main">(</span>matrix_A_R <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span> <span class="main">(</span>solve_for_lhs_R <span class="free">p</span> <span class="free">qs</span> <span class="free">subsets</span> <span class="main">(</span>matrix_A_R <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
    <span class="main">(</span>length <span class="main">(</span>find_nonzeros_from_input_vec <span class="main">(</span>solve_for_lhs_R <span class="free">p</span> <span class="free">qs</span> <span class="free">subsets</span> <span class="main">(</span>matrix_A_R <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?og_mat</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>matrix_A_R <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?lhs</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>solve_for_lhs_R <span class="free">p</span> <span class="free">qs</span> <span class="free">subsets</span> <span class="var">?og_mat</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?new_mat</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>take_rows_from_matrix <span class="main">(</span>reduce_mat_cols <span class="var">?og_mat</span> <span class="var">?lhs</span><span class="main">)</span> <span class="main">(</span>rows_to_keep <span class="main">(</span>reduce_mat_cols <span class="var">?og_mat</span> <span class="var">?lhs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"square_mat <span class="main">(</span>matrix_A_R <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> inv
    <span class="keyword1"><span class="command">using</span></span> invertible_mat_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> mat_size<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?og_mat</span> <span class="main">∈</span> carrier_mat <span class="main">(</span>length <span class="free">signs</span><span class="main">)</span> <span class="main">(</span>length <span class="free">signs</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> size_of_mat
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> mat_size_alt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?og_mat</span> <span class="main">∈</span> carrier_mat <span class="main">(</span>length <span class="free">subsets</span><span class="main">)</span> <span class="main">(</span>length <span class="free">subsets</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> size_of_mat same_size assms 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
  <span class="keyword1"><span class="command">have</span></span> det_h<span class="main">:</span> <span class="quoted"><span class="quoted">"det <span class="var">?og_mat</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> invertible_det<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> A <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"matrix_A_R <span class="free">signs</span> <span class="free">subsets</span>"</span></span><span class="main">]</span> mat_size
    <span class="keyword1"><span class="command">using</span></span> inv <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> rank_h<span class="main">:</span> <span class="quoted"><span class="quoted">"vec_space.rank <span class="main">(</span>length <span class="free">signs</span><span class="main">)</span> <span class="var">?og_mat</span> <span class="main">=</span> <span class="main">(</span>length <span class="free">signs</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> vec_space.det_rank_iff  mat_size
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> dist_cols<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>cols <span class="var">?og_mat</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> mat_size vec_space.non_distinct_low_rank<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> A <span class="main"><span class="main">=</span></span> <span class="var"><span class="quoted"><span class="var">?og_mat</span></span></span><span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> n <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"length <span class="free">signs</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> well_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">j</span><span class="main">.</span> <span class="bound">j</span> <span class="main">∈</span> set <span class="main">(</span>find_nonzeros_from_input_vec
                    <span class="main">(</span>solve_for_lhs_R <span class="free">p</span> <span class="free">qs</span> <span class="free">subsets</span> <span class="main">(</span>matrix_A_R <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span>
          <span class="bound">j</span> <span class="main">&lt;</span> length <span class="main">(</span>cols <span class="main">(</span>matrix_A_R <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms well_def_find_zeros_from_lhs_vec_R <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> dist1<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct
     <span class="main">(</span>find_nonzeros_from_input_vec <span class="main">(</span>solve_for_lhs_R <span class="free">p</span> <span class="free">qs</span> <span class="free">subsets</span> <span class="main">(</span>matrix_A_R <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> find_nonzeros_from_input_vec_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> clear<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>take_indices <span class="main">(</span>cols <span class="main">(</span>matrix_A_R <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span>
          <span class="main">(</span>find_nonzeros_from_input_vec <span class="main">(</span>solve_for_lhs_R <span class="free">p</span> <span class="free">qs</span> <span class="free">subsets</span> <span class="main">(</span>matrix_A_R <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
    <span class="main">⊆</span> set <span class="main">(</span>cols <span class="main">(</span>matrix_A_R <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms take_cols_subsets_og_cols_R <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>take_indices <span class="main">(</span>cols <span class="main">(</span>matrix_A_R <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span>
          <span class="main">(</span>find_nonzeros_from_input_vec <span class="main">(</span>solve_for_lhs_R <span class="free">p</span> <span class="free">qs</span> <span class="free">subsets</span> <span class="main">(</span>matrix_A_R <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> take_indices_def
    <span class="keyword1"><span class="command">using</span></span> dist1 dist_cols well_def conjugatable_vec_space.distinct_map_nth<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> ls <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"cols <span class="main">(</span>matrix_A_R <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span>"</span></span><span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> inds <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>find_nonzeros_from_input_vec <span class="main">(</span>solve_for_lhs_R <span class="free">p</span> <span class="free">qs</span> <span class="free">subsets</span> <span class="main">(</span>matrix_A_R <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> unfold_thesis<span class="main">:</span> <span class="quoted"><span class="quoted">"vec_space.rank <span class="main">(</span>length <span class="free">signs</span><span class="main">)</span> <span class="main">(</span>mat_of_cols <span class="main">(</span>dim_row <span class="var">?og_mat</span><span class="main">)</span> <span class="main">(</span>take_indices <span class="main">(</span>cols <span class="var">?og_mat</span><span class="main">)</span> <span class="main">(</span>find_nonzeros_from_input_vec <span class="var">?lhs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
<span class="main">=</span> <span class="main">(</span>length <span class="main">(</span>find_nonzeros_from_input_vec <span class="var">?lhs</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> clear inv conjugatable_vec_space.rank_invertible_subset_cols<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> A<span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"matrix_A_R <span class="free">signs</span> <span class="free">subsets</span>"</span></span><span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> B <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>take_indices <span class="main">(</span>cols <span class="main">(</span>matrix_A_R <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span>
         <span class="main">(</span>find_nonzeros_from_input_vec <span class="main">(</span>solve_for_lhs_R <span class="free">p</span> <span class="free">qs</span> <span class="free">subsets</span> <span class="main">(</span>matrix_A_R <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> len_eq mat_size take_indices_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> take_cols_from_matrix_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1" id="Renegar_Proofs-reduction_doesnt_break_things_invertibility_R"><span class="command">lemma</span></span> reduction_doesnt_break_things_invertibility_R<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">p</span><span class="main">::</span> <span class="quoted"><span class="quoted">"real poly"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">qs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real poly list"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">subsets</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>nat list<span class="main">*</span>nat list<span class="main">)</span> list"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">signs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"rat list list"</span></span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> len_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">subsets</span> <span class="main">=</span> length <span class="free">signs</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> inv<span class="main">:</span> <span class="quoted"><span class="quoted">"invertible_mat <span class="main">(</span>matrix_A_R <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> nonzero<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> welldefined_signs1<span class="main">:</span> <span class="quoted"><span class="quoted">"well_def_signs <span class="main">(</span>length <span class="free">qs</span><span class="main">)</span> <span class="free">signs</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> distinct_signs<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="free">signs</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> all_info<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>characterize_consistent_signs_at_roots <span class="free">p</span> <span class="free">qs</span><span class="main">)</span> <span class="main">⊆</span> set<span class="main">(</span><span class="free">signs</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> match<span class="main">:</span> <span class="quoted"><span class="quoted">"satisfy_equation_R <span class="free">p</span> <span class="free">qs</span> <span class="free">subsets</span> <span class="free">signs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"invertible_mat <span class="main">(</span>get_matrix_R <span class="main">(</span>reduce_system_R <span class="free">p</span> <span class="main">(</span><span class="free">qs</span><span class="main">,</span> <span class="main">(</span><span class="main">(</span>matrix_A_R <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free">subsets</span><span class="main">,</span> <span class="free">signs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?og_mat</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>matrix_A_R <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?lhs</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>solve_for_lhs_R <span class="free">p</span> <span class="free">qs</span> <span class="free">subsets</span> <span class="var">?og_mat</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?step1_mat</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>reduce_mat_cols <span class="var">?og_mat</span> <span class="var">?lhs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?new_mat</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"take_rows_from_matrix <span class="var">?step1_mat</span> <span class="main">(</span>rows_to_keep <span class="var">?step1_mat</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?ind_list</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>find_nonzeros_from_input_vec  <span class="var">?lhs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"square_mat <span class="main">(</span>matrix_A_R <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> inv
    <span class="keyword1"><span class="command">using</span></span> invertible_mat_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> og_mat_size<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?og_mat</span> <span class="main">∈</span> carrier_mat <span class="main">(</span>length <span class="free">signs</span><span class="main">)</span> <span class="main">(</span>length <span class="free">signs</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> size_of_mat
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"dim_col <span class="main">(</span>mat_of_cols <span class="main">(</span>dim_row <span class="var">?og_mat</span><span class="main">)</span> <span class="main">(</span>take_indices <span class="main">(</span>cols <span class="var">?og_mat</span><span class="main">)</span> <span class="var">?ind_list</span><span class="main">)</span><span class="main">)</span>
      <span class="main">=</span> <span class="main">(</span>length <span class="main">(</span>find_nonzeros_from_input_vec <span class="var">?lhs</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> take_indices_def<span class="main">)</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mat_of_cols <span class="main">(</span>dim_row <span class="var">?og_mat</span><span class="main">)</span> <span class="main">(</span>take_indices <span class="main">(</span>cols <span class="var">?og_mat</span><span class="main">)</span> <span class="var">?ind_list</span><span class="main">)</span>
      <span class="main">∈</span> carrier_mat <span class="main">(</span>length <span class="free">signs</span><span class="main">)</span> <span class="main">(</span>length <span class="main">(</span>find_nonzeros_from_input_vec <span class="var">?lhs</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> len_eq mat_of_cols_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> step1_mat_size<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?step1_mat</span> <span class="main">∈</span> carrier_mat <span class="main">(</span>length <span class="free">signs</span><span class="main">)</span> <span class="main">(</span>length <span class="main">(</span>find_nonzeros_from_input_vec <span class="var">?lhs</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> take_cols_from_matrix_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"dim_row <span class="var">?step1_mat</span> <span class="main">≥</span> dim_col <span class="var">?step1_mat</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> carrier_matD<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> carrier_matD<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> construct_lhs_matches_solve_for_lhs_R diff_zero find_nonzeros_from_input_vec_def inv length_filter_le length_upt match size_of_lhs_R<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> gt_eq_assm<span class="main">:</span> <span class="quoted"><span class="quoted">"dim_col <span class="var">?step1_mat</span><span class="keyword1"><span class="hidden">⇧</span><sup>T</sup></span>  <span class="main">≥</span> dim_row  <span class="var">?step1_mat</span><span class="keyword1"><span class="hidden">⇧</span><sup>T</sup></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> 
  <span class="keyword1"><span class="command">have</span></span> det_h<span class="main">:</span> <span class="quoted"><span class="quoted">"det <span class="var">?og_mat</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> invertible_det<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> A <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"matrix_A_R <span class="free">signs</span> <span class="free">subsets</span>"</span></span><span class="main">]</span> og_mat_size
    <span class="keyword1"><span class="command">using</span></span> inv <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> rank_h<span class="main">:</span> <span class="quoted"><span class="quoted">"vec_space.rank <span class="main">(</span>length <span class="free">signs</span><span class="main">)</span> <span class="var">?og_mat</span> <span class="main">=</span> <span class="main">(</span>length <span class="free">signs</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> vec_space.det_rank_iff  og_mat_size
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> rank_drop_cols<span class="main">:</span> <span class="quoted"><span class="quoted">"vec_space.rank <span class="main">(</span>length <span class="free">signs</span><span class="main">)</span> <span class="var">?step1_mat</span> <span class="main">=</span> <span class="main">(</span>dim_col <span class="var">?step1_mat</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms reduction_doesnt_break_things_invertibility_step1_R step1_mat_size 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?step1_T</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="var">?step1_mat</span><span class="keyword1"><span class="hidden">⇧</span><sup>T</sup></span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> rank_transpose<span class="main">:</span> <span class="quoted"><span class="quoted">"vec_space.rank <span class="main">(</span>length <span class="free">signs</span><span class="main">)</span> <span class="var">?step1_mat</span> <span class="main">=</span> vec_space.rank <span class="main">(</span>length <span class="main">(</span>find_nonzeros_from_input_vec <span class="var">?lhs</span><span class="main">)</span><span class="main">)</span> <span class="var">?step1_T</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> transpose_rank<span class="main">[</span><span class="operator">of</span> <span class="var"><span class="quoted"><span class="var">?step1_mat</span></span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">using</span></span> step1_mat_size <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>  
  <span class="keyword1"><span class="command">have</span></span> obv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?step1_T</span> <span class="main">∈</span> carrier_mat <span class="main">(</span>dim_row <span class="var">?step1_T</span><span class="main">)</span> <span class="main">(</span>dim_col <span class="var">?step1_T</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> should_have_this<span class="main">:</span><span class="quoted"><span class="quoted">"vec_space.rank <span class="main">(</span>length <span class="main">(</span>find_nonzeros_from_input_vec <span class="var">?lhs</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>take_cols <span class="var">?step1_T</span> <span class="main">(</span>map snd <span class="main">(</span>pivot_positions <span class="main">(</span>gauss_jordan_single <span class="main">(</span><span class="var">?step1_T</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> vec_space.rank <span class="main">(</span>length <span class="main">(</span>find_nonzeros_from_input_vec <span class="var">?lhs</span><span class="main">)</span><span class="main">)</span> <span class="var">?step1_T</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> obv gt_eq_assm conjugatable_vec_space.gauss_jordan_single_rank<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> A <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="var">?step1_T</span>"</span></span><span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> n <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"dim_row <span class="var">?step1_T</span>"</span></span><span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> nc <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"dim_col <span class="var">?step1_T</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> take_cols_from_matrix_def take_indices_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"vec_space.rank <span class="main">(</span>length <span class="main">(</span>find_nonzeros_from_input_vec <span class="var">?lhs</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>take_cols <span class="var">?step1_T</span> <span class="main">(</span>map snd <span class="main">(</span>pivot_positions <span class="main">(</span>gauss_jordan_single <span class="main">(</span><span class="var">?step1_T</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> dim_col <span class="var">?step1_mat</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> rank_drop_cols rank_transpose <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> with_take_cols_from_matrix<span class="main">:</span> <span class="quoted"><span class="quoted">"vec_space.rank <span class="main">(</span>length <span class="main">(</span>find_nonzeros_from_input_vec <span class="var">?lhs</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>take_cols_from_matrix <span class="var">?step1_T</span> <span class="main">(</span>map snd <span class="main">(</span>pivot_positions <span class="main">(</span>gauss_jordan_single <span class="main">(</span><span class="var">?step1_T</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> dim_col <span class="var">?step1_mat</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> rank_transpose rechar_take_cols conjugatable_vec_space.gjs_and_take_cols_var
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> conjugatable_vec_space.gjs_and_take_cols_var gt_eq_assm obv rechar_take_cols reduce_mat_cols.simps<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>take_rows_from_matrix <span class="var">?step1_mat</span> <span class="main">(</span>rows_to_keep <span class="var">?step1_mat</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>take_cols_from_matrix <span class="var">?step1_T</span>  <span class="main">(</span>rows_to_keep <span class="var">?step1_mat</span><span class="main">)</span><span class="main">)</span><span class="keyword1"><span class="hidden">⇧</span><sup>T</sup></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> take_rows_and_take_cols
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> rank_new_mat<span class="main">:</span> <span class="quoted"><span class="quoted">"vec_space.rank <span class="main">(</span>dim_row <span class="var">?new_mat</span><span class="main">)</span> <span class="var">?new_mat</span> <span class="main">=</span> dim_col <span class="var">?step1_mat</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> with_take_cols_from_matrix transpose_rank <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> <span class="main"><span class="main">(</span></span>verit<span class="main"><span class="main">,</span></span> ccfv_threshold<span class="main"><span class="main">)</span></span> carrier_matD<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> index_transpose_mat<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> mat_of_cols_carrier<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> reduce_mat_cols.simps rows_to_keep_def step1_mat_size take_cols_from_matrix_def transpose_rank<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>pivot_positions <span class="main">(</span>gauss_jordan_single <span class="main">(</span><span class="var">?step1_mat</span><span class="keyword1"><span class="hidden">⇧</span><sup>T</sup></span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> <span class="main">(</span>length <span class="main">(</span>find_nonzeros_from_input_vec <span class="var">?lhs</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> obv length_pivot_positions_dim_row<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> A <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>gauss_jordan_single <span class="main">(</span><span class="var">?step1_mat</span><span class="keyword1"><span class="hidden">⇧</span><sup>T</sup></span><span class="main">)</span><span class="main">)</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> carrier_matD<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> carrier_matD<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> gauss_jordan_single<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> gauss_jordan_single<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> index_transpose_mat<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> step1_mat_size<span class="main">)</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> len_lt_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>pivot_positions <span class="main">(</span>gauss_jordan_single <span class="main">(</span><span class="var">?step1_mat</span><span class="keyword1"><span class="hidden">⇧</span><sup>T</sup></span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> dim_col <span class="var">?step1_mat</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> step1_mat_size
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> 
  <span class="keyword1"><span class="command">have</span></span> len_gt_false<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>rows_to_keep <span class="var">?step1_mat</span><span class="main">)</span> <span class="main">&lt;</span> <span class="main">(</span>dim_col <span class="var">?step1_mat</span><span class="main">)</span> <span class="main">⟹</span> False"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
    <span class="keyword3"><span class="command">assume</span></span> length_lt<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>rows_to_keep <span class="var">?step1_mat</span><span class="main">)</span> <span class="main">&lt;</span> <span class="main">(</span>dim_col <span class="var">?step1_mat</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> h<span class="main">:</span> <span class="quoted"><span class="quoted">"dim_row <span class="var">?new_mat</span> <span class="main">&lt;</span> <span class="main">(</span>dim_col <span class="var">?step1_mat</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Matrix.transpose_transpose index_transpose_mat<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> length_lt length_map mat_of_cols_carrier<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> take_cols_from_matrix_def take_indices_def take_rows_and_take_cols<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"False"</span></span> <span class="keyword1"><span class="command">using</span></span> rank_new_mat
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Matrix.transpose_transpose carrier_matI index_transpose_mat<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> nat_less_le not_less_iff_gr_or_eq transpose_rank vec_space.rank_le_nc<span class="main">)</span>    
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> len_gt_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>rows_to_keep <span class="var">?step1_mat</span><span class="main">)</span> <span class="main">≥</span> <span class="main">(</span>dim_col <span class="var">?step1_mat</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> not_less <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> len_match<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>rows_to_keep <span class="var">?step1_mat</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>dim_col <span class="var">?step1_mat</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> len_lt_eq len_gt_eq
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rows_to_keep_def<span class="main">)</span> 
  <span class="keyword1"><span class="command">have</span></span> mat_match<span class="main">:</span> <span class="quoted"><span class="quoted">"matrix_A_R <span class="main">(</span>get_signs_R <span class="main">(</span>reduce_system_R <span class="free">p</span> <span class="main">(</span><span class="free">qs</span><span class="main">,</span> <span class="main">(</span><span class="main">(</span>matrix_A_R <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free">subsets</span><span class="main">,</span> <span class="free">signs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
  <span class="main">(</span>get_subsets_R <span class="main">(</span>reduce_system_R <span class="free">p</span> <span class="main">(</span><span class="free">qs</span><span class="main">,</span> <span class="main">(</span><span class="main">(</span>matrix_A_R <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free">subsets</span><span class="main">,</span> <span class="free">signs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
  <span class="main">(</span>get_matrix_R <span class="main">(</span>reduce_system_R <span class="free">p</span> <span class="main">(</span><span class="free">qs</span><span class="main">,</span> <span class="main">(</span><span class="main">(</span>matrix_A_R <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free">subsets</span><span class="main">,</span> <span class="free">signs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> reduce_system_matrix_match_R<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">p</span></span> <span class="quoted"><span class="free">qs</span></span> <span class="quoted"><span class="free">signs</span></span> <span class="quoted"><span class="free">subsets</span></span><span class="main">]</span>  assms
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
  <span class="keyword1"><span class="command">have</span></span> f2<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>get_subsets_R <span class="main">(</span>take_rows_from_matrix <span class="main">(</span>mat_of_cols <span class="main">(</span>dim_row <span class="main">(</span>matrix_A_R <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>map <span class="main">(</span><span class="main">(!)</span> <span class="main">(</span>cols <span class="main">(</span>matrix_A_R <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>find_nonzeros_from_input_vec <span class="main">(</span>solve_for_lhs_R <span class="free">p</span> <span class="free">qs</span> <span class="free">subsets</span> <span class="main">(</span>matrix_A_R <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>rows_to_keep <span class="main">(</span>mat_of_cols <span class="main">(</span>dim_row <span class="main">(</span>matrix_A_R <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>map <span class="main">(</span><span class="main">(!)</span> <span class="main">(</span>cols <span class="main">(</span>matrix_A_R <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>find_nonzeros_from_input_vec <span class="main">(</span>solve_for_lhs_R <span class="free">p</span> <span class="free">qs</span> <span class="free">subsets</span> <span class="main">(</span>matrix_A_R <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> map <span class="main">(</span><span class="main">(!)</span> <span class="free">subsets</span><span class="main">)</span> <span class="main">(</span>rows_to_keep <span class="main">(</span>mat_of_cols <span class="main">(</span>dim_row <span class="main">(</span>matrix_A_R <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>map <span class="main">(</span><span class="main">(!)</span> <span class="main">(</span>cols <span class="main">(</span>matrix_A_R <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>find_nonzeros_from_input_vec <span class="main">(</span>solve_for_lhs_R <span class="free">p</span> <span class="free">qs</span> <span class="free">subsets</span> <span class="main">(</span>matrix_A_R <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> map <span class="main">(</span><span class="main">(!)</span> <span class="free">signs</span><span class="main">)</span> <span class="main">(</span>find_nonzeros_from_input_vec <span class="main">(</span>solve_for_lhs_R <span class="free">p</span> <span class="free">qs</span> <span class="free">subsets</span> <span class="main">(</span>matrix_A_R <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> length <span class="main">(</span>find_nonzeros_from_input_vec <span class="main">(</span>solve_for_lhs_R <span class="free">p</span> <span class="free">qs</span> <span class="free">subsets</span> <span class="main">(</span>matrix_A_R <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> <span class="quoted"><span class="quoted">‹dim_col <span class="main">(</span>mat_of_cols <span class="main">(</span>dim_row <span class="main">(</span>matrix_A_R <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>take_indices <span class="main">(</span>cols <span class="main">(</span>matrix_A_R <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>find_nonzeros_from_input_vec <span class="main">(</span>solve_for_lhs_R <span class="free">p</span> <span class="free">qs</span> <span class="free">subsets</span> <span class="main">(</span>matrix_A_R <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> length <span class="main">(</span>find_nonzeros_from_input_vec <span class="main">(</span>solve_for_lhs_R <span class="free">p</span> <span class="free">qs</span> <span class="free">subsets</span> <span class="main">(</span>matrix_A_R <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹length <span class="main">(</span>rows_to_keep <span class="main">(</span>reduce_mat_cols <span class="main">(</span>matrix_A_R <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span> <span class="main">(</span>solve_for_lhs_R <span class="free">p</span> <span class="free">qs</span> <span class="free">subsets</span> <span class="main">(</span>matrix_A_R <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> dim_col <span class="main">(</span>reduce_mat_cols <span class="main">(</span>matrix_A_R <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span> <span class="main">(</span>solve_for_lhs_R <span class="free">p</span> <span class="free">qs</span> <span class="free">subsets</span> <span class="main">(</span>matrix_A_R <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>›</span></span> length_map reduce_mat_cols.simps reduce_system_R.simps reduction_step_R.simps reduction_subsets_R_def reduction_subsets_is_get_subsets_R take_cols_from_matrix_def take_indices_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> f3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span> <span class="bound">ps</span> <span class="bound">rss</span> <span class="bound">nss</span> <span class="bound">m</span><span class="main">.</span> map <span class="main">(</span><span class="main">(!)</span> <span class="bound">rss</span><span class="main">)</span> <span class="main">(</span>find_nonzeros_from_input_vec <span class="main">(</span>solve_for_lhs_R <span class="bound">p</span> <span class="bound">ps</span> <span class="bound">nss</span> <span class="bound">m</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> get_signs_R <span class="main">(</span>reduce_system_R <span class="bound">p</span> <span class="main">(</span><span class="bound">ps</span><span class="main">,</span> <span class="bound">m</span><span class="main">,</span> <span class="bound">nss</span><span class="main">,</span> <span class="bound">rss</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> reduction_signs_R_def reduction_signs_is_get_signs_R take_indices_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> square_final_mat<span class="main">:</span> <span class="quoted"><span class="quoted">"square_mat <span class="main">(</span>get_matrix_R <span class="main">(</span>reduce_system_R <span class="free">p</span> <span class="main">(</span><span class="free">qs</span><span class="main">,</span> <span class="main">(</span><span class="main">(</span>matrix_A_R <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free">subsets</span><span class="main">,</span> <span class="free">signs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> mat_match assms size_of_mat_R same_size_R
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> f2 f3
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> Matrix.transpose_transpose fst_conv get_matrix_R_def index_transpose_mat<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> len_match length_map mat_of_cols_carrier<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> mat_of_cols_carrier<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> reduce_mat_cols.simps take_cols_from_matrix_def take_indices_def take_rows_and_take_cols<span class="main">)</span> 
  <span class="keyword1"><span class="command">have</span></span> rank_match<span class="main">:</span> <span class="quoted"><span class="quoted">"vec_space.rank <span class="main">(</span>dim_row <span class="var">?new_mat</span><span class="main">)</span> <span class="var">?new_mat</span> <span class="main">=</span> dim_row <span class="var">?new_mat</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> len_match rank_new_mat
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> take_cols_from_matrix_def take_indices_def take_rows_and_take_cols<span class="main">)</span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"invertible_mat <span class="var">?new_mat</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> invertible_det og_mat_size
    <span class="keyword1"><span class="command">using</span></span> vec_space.det_rank_iff square_final_mat
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> dim_col_matrix_A_R dim_row_matrix_A_R fst_conv get_matrix_R_def mat_match rank_match reduce_system_R.simps reduction_step_R.simps size_of_mat_R square_mat.elims<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> fst_conv get_matrix_R_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Well def signs preserved when reducing"</span></span>

<span class="keyword1" id="Renegar_Proofs-reduction_doesnt_break_length_signs_R"><span class="command">lemma</span></span> reduction_doesnt_break_length_signs_R<span class="main">:</span>  
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">p</span><span class="main">::</span> <span class="quoted"><span class="quoted">"real poly"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">qs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real poly list"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">subsets</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>nat list<span class="main">*</span>nat list<span class="main">)</span> list"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">signs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"rat list list"</span></span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> length_init <span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">x</span><span class="main">∈</span> set<span class="main">(</span><span class="free">signs</span><span class="main">)</span><span class="main">.</span> length <span class="bound">x</span> <span class="main">=</span> length <span class="free">qs</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> sat_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"satisfy_equation_R <span class="free">p</span> <span class="free">qs</span> <span class="free">subsets</span> <span class="free">signs</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> inv_mat<span class="main">:</span> <span class="quoted"><span class="quoted">"invertible_mat <span class="main">(</span>matrix_A_R <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> set<span class="main">(</span>reduction_signs_R <span class="free">p</span> <span class="free">qs</span> <span class="free">signs</span> <span class="free">subsets</span> <span class="main">(</span>matrix_A_R <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> 
    length <span class="bound">x</span> <span class="main">=</span> length <span class="free">qs</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> reduction_signs_def <span class="keyword1"><span class="command">using</span></span> take_indices_lem
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> <span class="main"><span class="main">(</span></span>verit<span class="main"><span class="main">)</span></span> atLeastLessThan_iff construct_lhs_matches_solve_for_lhs_R filter_is_subset find_nonzeros_from_input_vec_def in_set_conv_nth in_set_member inv_mat length_init reduction_signs_R_def sat_eq set_upt size_of_lhs_R subset_code<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Distinct signs preserved when reducing"</span></span>

<span class="keyword1" id="Renegar_Proofs-reduction_signs_are_distinct_R"><span class="command">lemma</span></span> reduction_signs_are_distinct_R<span class="main">:</span>  
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">p</span><span class="main">::</span> <span class="quoted"><span class="quoted">"real poly"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">qs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real poly list"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">subsets</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>nat list<span class="main">*</span>nat list<span class="main">)</span> list"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">signs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"rat list list"</span></span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> sat_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"satisfy_equation_R <span class="free">p</span> <span class="free">qs</span> <span class="free">subsets</span> <span class="free">signs</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> inv_mat<span class="main">:</span> <span class="quoted"><span class="quoted">"invertible_mat <span class="main">(</span>matrix_A_R <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> distinct_init<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="free">signs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>reduction_signs_R <span class="free">p</span> <span class="free">qs</span> <span class="free">signs</span> <span class="free">subsets</span> <span class="main">(</span>matrix_A_R <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> solve_construct<span class="main">:</span> <span class="quoted"><span class="quoted">"construct_lhs_vector_R <span class="free">p</span> <span class="free">qs</span> <span class="free">signs</span> <span class="main">=</span>
  solve_for_lhs_R <span class="free">p</span> <span class="free">qs</span> <span class="free">subsets</span> <span class="main">(</span>matrix_A_R <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> construct_lhs_matches_solve_for_lhs_R assms
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> h1<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>find_nonzeros_from_input_vec <span class="main">(</span>solve_for_lhs_R <span class="free">p</span> <span class="free">qs</span> <span class="free">subsets</span> <span class="main">(</span>matrix_A_R <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> find_nonzeros_from_input_vec_def 
    <span class="keyword1"><span class="command">using</span></span> distinct_filter
    <span class="keyword1"><span class="command">using</span></span> distinct_upt <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
  <span class="keyword1"><span class="command">have</span></span> h2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">j</span><span class="main">.</span> <span class="bound">j</span> <span class="main">∈</span> set <span class="main">(</span>find_nonzeros_from_input_vec <span class="main">(</span>solve_for_lhs_R <span class="free">p</span> <span class="free">qs</span> <span class="free">subsets</span> <span class="main">(</span>matrix_A_R <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span>
          <span class="bound">j</span> <span class="main">&lt;</span> length <span class="free">signs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">j</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">∈</span> set <span class="main">(</span>find_nonzeros_from_input_vec <span class="main">(</span>solve_for_lhs_R <span class="free">p</span> <span class="free">qs</span> <span class="free">subsets</span> <span class="main">(</span>matrix_A_R <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> length <span class="free">signs</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> solve_construct size_of_lhs_R
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹<span class="skolem">j</span> <span class="main">∈</span> set <span class="main">(</span>find_nonzeros_from_input_vec <span class="main">(</span>solve_for_lhs_R <span class="free">p</span> <span class="free">qs</span> <span class="free">subsets</span> <span class="main">(</span>matrix_A_R <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>›</span></span> atLeastLessThan_iff filter_is_subset find_nonzeros_from_input_vec_def set_upt subset_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> reduction_signs_R_def <span class="keyword1"><span class="command">unfolding</span></span> take_indices_def
    <span class="keyword1"><span class="command">using</span></span> distinct_init h1 h2 conjugatable_vec_space.distinct_map_nth<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> ls <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="free">signs</span>"</span></span><span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> inds <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>find_nonzeros_from_input_vec <span class="main">(</span>solve_for_lhs_R <span class="free">p</span> <span class="free">qs</span> <span class="free">subsets</span> <span class="main">(</span>matrix_A_R <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Well def subsets preserved when reducing"</span></span>

<span class="keyword1" id="Renegar_Proofs-reduction_doesnt_break_subsets_R"><span class="command">lemma</span></span> reduction_doesnt_break_subsets_R<span class="main">:</span>  
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">p</span><span class="main">::</span> <span class="quoted"><span class="quoted">"real poly"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">qs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real poly list"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">subsets</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>nat list<span class="main">*</span> nat list<span class="main">)</span> list"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">signs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"rat list list"</span></span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> nonzero<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> length_init <span class="main">:</span> <span class="quoted"><span class="quoted">"all_list_constr_R <span class="free">subsets</span> <span class="main">(</span>length <span class="free">qs</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> sat_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"satisfy_equation_R <span class="free">p</span> <span class="free">qs</span> <span class="free">subsets</span> <span class="free">signs</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> inv_mat<span class="main">:</span> <span class="quoted"><span class="quoted">"invertible_mat <span class="main">(</span>matrix_A_R <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"all_list_constr_R <span class="main">(</span>reduction_subsets_R <span class="free">p</span> <span class="free">qs</span> <span class="free">signs</span> <span class="free">subsets</span> <span class="main">(</span>matrix_A_R <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>length <span class="free">qs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> all_list_constr_R_def 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">clarsimp</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span> <span class="skolem">b</span>
  <span class="keyword3"><span class="command">assume</span></span> in_red_subsets<span class="main">:</span> <span class="quoted"><span class="quoted">"List.member <span class="main">(</span>reduction_subsets_R <span class="free">p</span> <span class="free">qs</span> <span class="free">signs</span> <span class="free">subsets</span> <span class="main">(</span>matrix_A_R <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">a</span><span class="main">,</span> <span class="skolem">b</span><span class="main">)</span> "</span></span>
  <span class="keyword1"><span class="command">have</span></span> solve_construct<span class="main">:</span> <span class="quoted"><span class="quoted">"construct_lhs_vector_R <span class="free">p</span> <span class="free">qs</span> <span class="free">signs</span> <span class="main">=</span>
  solve_for_lhs_R <span class="free">p</span> <span class="free">qs</span> <span class="free">subsets</span> <span class="main">(</span>matrix_A_R <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> construct_lhs_matches_solve_for_lhs_R assms
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> rows_to_keep_hyp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> set <span class="main">(</span>rows_to_keep <span class="main">(</span>reduce_mat_cols <span class="main">(</span>matrix_A_R <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span> <span class="main">(</span>solve_for_lhs_R <span class="free">p</span> <span class="free">qs</span> <span class="free">subsets</span> <span class="main">(</span>matrix_A_R <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span> 
      <span class="bound">y</span> <span class="main">&lt;</span> length <span class="free">subsets</span>"</span></span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">clarsimp</span> 
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">y</span>
    <span class="keyword3"><span class="command">assume</span></span> in_set<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> set <span class="main">(</span>rows_to_keep
                   <span class="main">(</span>take_cols_from_matrix <span class="main">(</span>matrix_A_R <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span> <span class="main">(</span>find_nonzeros_from_input_vec <span class="main">(</span>solve_for_lhs_R <span class="free">p</span> <span class="free">qs</span> <span class="free">subsets</span> <span class="main">(</span>matrix_A_R <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> in_set_2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> set <span class="main">(</span>rows_to_keep
                   <span class="main">(</span>take_cols_from_matrix <span class="main">(</span>matrix_A_R <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span> <span class="main">(</span>find_nonzeros_from_input_vec <span class="main">(</span>construct_lhs_vector_R <span class="free">p</span> <span class="free">qs</span> <span class="free">signs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> in_set solve_construct <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?lhs_vec</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>solve_for_lhs_R <span class="free">p</span> <span class="free">qs</span> <span class="free">subsets</span> <span class="main">(</span>matrix_A_R <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> h30<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>construct_lhs_vector_R <span class="free">p</span> <span class="free">qs</span> <span class="free">signs</span><span class="main">)</span> <span class="main">=</span> <span class="var">?lhs_vec</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms construct_lhs_matches_solve_for_lhs_R
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> 
    <span class="keyword1"><span class="command">have</span></span> h3a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">.</span> List.member <span class="main">(</span>find_nonzeros_from_input_vec <span class="var">?lhs_vec</span><span class="main">)</span> <span class="bound">x</span> <span class="main">⟶</span><span class="bound">x</span> <span class="main">&lt;</span> length <span class="main">(</span><span class="free">signs</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> h30 size_of_lhs_R <span class="keyword1"><span class="command">unfolding</span></span> find_nonzeros_from_input_vec_def 
      <span class="keyword1"><span class="command">using</span></span> atLeastLessThan_iff filter_is_subset member_def set_upt subset_eq <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> <span class="main"><span class="main">(</span></span>verit<span class="main"><span class="main">,</span></span> best<span class="main"><span class="main">)</span></span> atLeastLessThan_iff in_set_member mem_Collect_eq set_filter set_upt<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> h3c<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">.</span> List.member <span class="main">(</span>rows_to_keep <span class="main">(</span>reduce_mat_cols <span class="main">(</span>matrix_A_R <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span> <span class="main">(</span>solve_for_lhs_R <span class="free">p</span> <span class="free">qs</span> <span class="free">subsets</span> <span class="main">(</span>matrix_A_R <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="bound">x</span> <span class="main">⟶</span> <span class="bound">x</span> <span class="main">&lt;</span> length <span class="main">(</span><span class="free">subsets</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">clarsimp</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
      <span class="keyword3"><span class="command">assume</span></span> x_mem<span class="main">:</span> <span class="quoted"><span class="quoted">"List.member <span class="main">(</span>rows_to_keep
            <span class="main">(</span>take_cols_from_matrix <span class="main">(</span>matrix_A_R <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span>
              <span class="main">(</span>find_nonzeros_from_input_vec <span class="main">(</span>solve_for_lhs_R <span class="free">p</span> <span class="free">qs</span> <span class="free">subsets</span> <span class="main">(</span>matrix_A_R <span class="free">signs</span> <span class="free">subsets</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">x</span>"</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">&lt;</span> length <span class="main">(</span><span class="free">subsets</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> x_mem <span class="keyword1"><span class="command">unfolding</span></span> rows_to_keep_def <span class="keyword1"><span class="command">using</span></span> pivot_positions
        <span class="keyword1"><span class="command">using</span></span>  dim_row_matrix_A h3a in_set_member nonzero reduce_system_matrix_signs_helper_R rows_to_keep_def rows_to_keep_lem
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> <span class="main"><span class="main">(</span></span>verit<span class="main"><span class="main">,</span></span> best<span class="main"><span class="main">)</span></span> List.member_def dim_row_matrix_A_R rows_to_keep_def rows_to_keep_lem<span class="main">)</span> 
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">&lt;</span> length <span class="free">subsets</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> in_set_member <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> in_set_2 solve_construct <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>  
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"list_constr <span class="skolem">a</span> <span class="main">(</span>length <span class="free">qs</span><span class="main">)</span> <span class="main">∧</span> list_constr <span class="skolem">b</span> <span class="main">(</span>length <span class="free">qs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> in_red_subsets  <span class="keyword1"><span class="command">unfolding</span></span>  reduction_subsets_def 
    <span class="keyword1"><span class="command">using</span></span> take_indices_lem_R<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="free">subsets</span></span><span class="main">]</span>  rows_to_keep_hyp 
    <span class="keyword1"><span class="command">using</span></span> all_list_constr_R_def in_set_conv_nth in_set_member length_init
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> fst_conv reduction_subsets_R_def snd_conv<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">"Overall Lemmas"</span></span>
<span class="keyword1" id="Renegar_Proofs-combining_to_smash_R"><span class="command">lemma</span></span> combining_to_smash_R<span class="main">:</span>  <span class="quoted"><span class="quoted">"combine_systems_R <span class="free">p</span> <span class="main">(</span><span class="free">qs1</span><span class="main">,</span> <span class="free">m1</span><span class="main">,</span> <span class="main">(</span><span class="free">sub1</span><span class="main">,</span> <span class="free">sgn1</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">qs2</span><span class="main">,</span> <span class="free">m2</span><span class="main">,</span> <span class="main">(</span><span class="free">sub2</span><span class="main">,</span> <span class="free">sgn2</span><span class="main">)</span><span class="main">)</span>
 <span class="main">=</span>  smash_systems_R <span class="free">p</span> <span class="free">qs1</span> <span class="free">qs2</span> <span class="free">sub1</span> <span class="free">sub2</span> <span class="free">sgn1</span> <span class="free">sgn2</span> <span class="free">m1</span> <span class="free">m2</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Renegar_Proofs-getter_functions_R"><span class="command">lemma</span></span> getter_functions_R<span class="main">:</span> <span class="quoted"><span class="quoted">"calculate_data_R <span class="free">p</span> <span class="free">qs</span> <span class="main">=</span> <span class="main">(</span>get_matrix_R <span class="main">(</span>calculate_data_R <span class="free">p</span> <span class="free">qs</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>get_subsets_R <span class="main">(</span>calculate_data_R <span class="free">p</span> <span class="free">qs</span><span class="main">)</span><span class="main">,</span> get_signs_R <span class="main">(</span>calculate_data_R <span class="free">p</span> <span class="free">qs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> "</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> get_matrix_R_def get_subsets_R_def get_signs_R_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Key properties preserved"</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">"Properties preserved when combining and reducing systems"</span></span>
<span class="keyword1" id="Renegar_Proofs-combining_sys_satisfies_properties_helper_R"><span class="command">lemma</span></span> combining_sys_satisfies_properties_helper_R<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">p</span><span class="main">::</span> <span class="quoted"><span class="quoted">"real poly"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">qs1</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real poly list"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">qs2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real poly list"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">subsets1</span> <span class="free">subsets2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>nat list <span class="main">*</span> nat list<span class="main">)</span> list"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">signs1</span> <span class="free">signs2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"rat list list"</span></span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">matrix1</span> <span class="free">matrix2</span><span class="main">::</span> <span class="quoted"><span class="quoted">"rat mat"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> nonzero<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> nontriv1<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">qs1</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> nontriv2<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">qs2</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> satisfies_properties_sys1<span class="main">:</span> <span class="quoted"><span class="quoted">"satisfies_properties_R <span class="free">p</span> <span class="free">qs1</span> <span class="free">subsets1</span> <span class="free">signs1</span> <span class="free">matrix1</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> satisfies_properties_sys2<span class="main">:</span> <span class="quoted"><span class="quoted">"satisfies_properties_R <span class="free">p</span> <span class="free">qs2</span> <span class="free">subsets2</span> <span class="free">signs2</span> <span class="free">matrix2</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>  <span class="quoted"><span class="quoted">"satisfies_properties_R <span class="free">p</span> <span class="main">(</span><span class="free">qs1</span><span class="main">@</span><span class="free">qs2</span><span class="main">)</span> <span class="main">(</span>get_subsets_R <span class="main">(</span>snd <span class="main">(</span><span class="main">(</span>combine_systems_R <span class="free">p</span> <span class="main">(</span><span class="free">qs1</span><span class="main">,</span><span class="main">(</span><span class="free">matrix1</span><span class="main">,</span> <span class="main">(</span><span class="free">subsets1</span><span class="main">,</span> <span class="free">signs1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">qs2</span><span class="main">,</span><span class="main">(</span><span class="free">matrix2</span><span class="main">,</span> <span class="main">(</span><span class="free">subsets2</span><span class="main">,</span> <span class="free">signs2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> 
  <span class="main">(</span>get_signs_R <span class="main">(</span>snd <span class="main">(</span><span class="main">(</span>combine_systems_R <span class="free">p</span> <span class="main">(</span><span class="free">qs1</span><span class="main">,</span><span class="main">(</span><span class="free">matrix1</span><span class="main">,</span> <span class="main">(</span><span class="free">subsets1</span><span class="main">,</span> <span class="free">signs1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">qs2</span><span class="main">,</span><span class="main">(</span><span class="free">matrix2</span><span class="main">,</span> <span class="main">(</span><span class="free">subsets2</span><span class="main">,</span> <span class="free">signs2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> 
  <span class="main">(</span>get_matrix_R <span class="main">(</span>snd <span class="main">(</span><span class="main">(</span>combine_systems_R <span class="free">p</span> <span class="main">(</span><span class="free">qs1</span><span class="main">,</span><span class="main">(</span><span class="free">matrix1</span><span class="main">,</span> <span class="main">(</span><span class="free">subsets1</span><span class="main">,</span> <span class="free">signs1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">qs2</span><span class="main">,</span><span class="main">(</span><span class="free">matrix2</span><span class="main">,</span> <span class="main">(</span><span class="free">subsets2</span><span class="main">,</span> <span class="free">signs2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>     
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?subsets</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>get_subsets_R <span class="main">(</span>snd <span class="main">(</span>combine_systems_R <span class="free">p</span> <span class="main">(</span><span class="free">qs1</span><span class="main">,</span> <span class="free">matrix1</span><span class="main">,</span> <span class="free">subsets1</span><span class="main">,</span> <span class="free">signs1</span><span class="main">)</span>
              <span class="main">(</span><span class="free">qs2</span><span class="main">,</span> <span class="free">matrix2</span><span class="main">,</span> <span class="free">subsets2</span><span class="main">,</span> <span class="free">signs2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?signs</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>get_signs_R <span class="main">(</span>snd <span class="main">(</span>combine_systems_R <span class="free">p</span> <span class="main">(</span><span class="free">qs1</span><span class="main">,</span> <span class="free">matrix1</span><span class="main">,</span> <span class="free">subsets1</span><span class="main">,</span> <span class="free">signs1</span><span class="main">)</span> <span class="main">(</span><span class="free">qs2</span><span class="main">,</span> <span class="free">matrix2</span><span class="main">,</span> <span class="free">subsets2</span><span class="main">,</span> <span class="free">signs2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?matrix</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>get_matrix_R <span class="main">(</span>snd <span class="main">(</span>combine_systems_R <span class="free">p</span> <span class="main">(</span><span class="free">qs1</span><span class="main">,</span> <span class="free">matrix1</span><span class="main">,</span> <span class="free">subsets1</span><span class="main">,</span> <span class="free">signs1</span><span class="main">)</span> <span class="main">(</span><span class="free">qs2</span><span class="main">,</span> <span class="free">matrix2</span><span class="main">,</span> <span class="free">subsets2</span><span class="main">,</span> <span class="free">signs2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> h1<span class="main">:</span> <span class="quoted"><span class="quoted">"all_list_constr_R <span class="var">?subsets</span> <span class="main">(</span>length <span class="main">(</span><span class="free">qs1</span> <span class="main">@</span> <span class="free">qs2</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> well_def_step_R<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">subsets1</span></span> <span class="quoted"><span class="free">qs1</span></span> <span class="quoted"><span class="free">subsets2</span></span> <span class="quoted"><span class="free">qs2</span></span><span class="main">]</span> assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nontriv2 get_subsets_R_def satisfies_properties_R_def smash_systems_R_def<span class="main">)</span> 
  <span class="keyword1"><span class="command">have</span></span> h2<span class="main">:</span> <span class="quoted"><span class="quoted">"well_def_signs <span class="main">(</span>length <span class="main">(</span><span class="free">qs1</span> <span class="main">@</span> <span class="free">qs2</span><span class="main">)</span><span class="main">)</span> <span class="var">?signs</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> well_def_signs_step<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">qs1</span></span> <span class="quoted"><span class="free">qs2</span></span> <span class="quoted"><span class="free">signs1</span></span> <span class="quoted"><span class="free">signs2</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">using</span></span> get_signs_R_def nontriv1 nontriv2 satisfies_properties_R_def satisfies_properties_sys1 satisfies_properties_sys2 smash_systems_R_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
  <span class="keyword1"><span class="command">have</span></span> h3<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="var">?signs</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> distinct_step<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="free">signs1</span></span> <span class="main">_</span> <span class="quoted"><span class="free">signs2</span></span><span class="main">]</span> assms
    <span class="keyword1"><span class="command">using</span></span> combine_systems.simps get_signs_R_def satisfies_properties_R_def smash_systems_R_def snd_conv <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> h4<span class="main">:</span> <span class="quoted"><span class="quoted">"satisfy_equation_R <span class="free">p</span> <span class="main">(</span><span class="free">qs1</span> <span class="main">@</span> <span class="free">qs2</span><span class="main">)</span> <span class="var">?subsets</span> <span class="var">?signs</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> assms inductive_step_R<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">p</span></span> <span class="quoted"><span class="free">qs1</span></span> <span class="quoted"><span class="free">qs2</span></span> <span class="quoted"><span class="free">signs1</span></span> <span class="quoted"><span class="free">signs2</span></span> <span class="quoted"><span class="free">subsets1</span></span> <span class="quoted"><span class="free">subsets2</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">using</span></span> get_signs_R_def get_subsets_R_def satisfies_properties_R_def smash_systems_R_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>  
  <span class="keyword1"><span class="command">have</span></span> h5<span class="main">:</span> <span class="quoted"><span class="quoted">" invertible_mat <span class="var">?matrix</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms inductive_step_R<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">p</span></span> <span class="quoted"><span class="free">qs1</span></span> <span class="quoted"><span class="free">qs2</span></span> <span class="quoted"><span class="free">signs1</span></span> <span class="quoted"><span class="free">signs2</span></span> <span class="quoted"><span class="free">subsets1</span></span> <span class="quoted"><span class="free">subsets2</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> combining_to_smash_R fst_conv get_matrix_R_def kronecker_invertible satisfies_properties_R_def smash_systems_R_def snd_conv<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> h6<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?matrix</span> <span class="main">=</span> matrix_A_R <span class="var">?signs</span> <span class="var">?subsets</span>"</span></span> 
    <span class="keyword1"><span class="command">unfolding</span></span> get_matrix_R_def combine_systems_R.simps smash_systems_R_def get_signs_R_def get_subsets_R_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> matrix_construction_is_kronecker_product_R<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">subsets1</span></span></span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">signs1</span></span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">signs2</span></span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">subsets2</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> Ball_set all_list_constr_R_def in_set_member list_constr_def satisfies_properties_R_def satisfies_properties_sys1<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> satisfies_properties_R_def satisfies_properties_sys1 well_def_signs_def <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">using</span></span> satisfies_properties_R_def satisfies_properties_sys1 satisfies_properties_sys2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> h7<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>characterize_consistent_signs_at_roots <span class="free">p</span> <span class="main">(</span><span class="free">qs1</span> <span class="main">@</span> <span class="free">qs2</span><span class="main">)</span><span class="main">)</span>
    <span class="main">⊆</span> set <span class="main">(</span><span class="var">?signs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> subset_step_R<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">p</span></span> <span class="quoted"><span class="free">qs1</span></span> <span class="quoted"><span class="free">signs1</span></span> <span class="quoted"><span class="free">qs2</span></span>  <span class="quoted"><span class="free">signs2</span></span><span class="main">]</span> assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nonzero get_signs_R_def satisfies_properties_R_def smash_systems_R_def<span class="main">)</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> satisfies_properties_R_def <span class="keyword1"><span class="command">using</span></span> h1 h2 h3 h4 h5 h6 h7 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Renegar_Proofs-combining_sys_satisfies_properties_R"><span class="command">lemma</span></span> combining_sys_satisfies_properties_R<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">p</span><span class="main">::</span> <span class="quoted"><span class="quoted">"real poly"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">qs1</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real poly list"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">qs2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real poly list"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> nonzero<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> nontriv1<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">qs1</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> nontriv2<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">qs2</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> satisfies_properties_sys1<span class="main">:</span> <span class="quoted"><span class="quoted">"satisfies_properties_R <span class="free">p</span> <span class="free">qs1</span> <span class="main">(</span>get_subsets_R <span class="main">(</span>calculate_data_R <span class="free">p</span> <span class="free">qs1</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>get_signs_R <span class="main">(</span>calculate_data_R <span class="free">p</span> <span class="free">qs1</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>get_matrix_R <span class="main">(</span>calculate_data_R <span class="free">p</span> <span class="free">qs1</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> satisfies_properties_sys2<span class="main">:</span> <span class="quoted"><span class="quoted">"satisfies_properties_R <span class="free">p</span> <span class="free">qs2</span> <span class="main">(</span>get_subsets_R <span class="main">(</span>calculate_data_R <span class="free">p</span> <span class="free">qs2</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>get_signs_R <span class="main">(</span>calculate_data_R <span class="free">p</span> <span class="free">qs2</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>get_matrix_R <span class="main">(</span>calculate_data_R <span class="free">p</span> <span class="free">qs2</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>  <span class="quoted"><span class="quoted">"satisfies_properties_R <span class="free">p</span> <span class="main">(</span><span class="free">qs1</span><span class="main">@</span><span class="free">qs2</span><span class="main">)</span> <span class="main">(</span>get_subsets_R <span class="main">(</span>snd <span class="main">(</span><span class="main">(</span>combine_systems_R <span class="free">p</span> <span class="main">(</span><span class="free">qs1</span><span class="main">,</span>calculate_data_R <span class="free">p</span> <span class="free">qs1</span><span class="main">)</span> <span class="main">(</span><span class="free">qs2</span><span class="main">,</span>calculate_data_R <span class="free">p</span> <span class="free">qs2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> 
  <span class="main">(</span>get_signs_R <span class="main">(</span>snd <span class="main">(</span><span class="main">(</span>combine_systems_R <span class="free">p</span> <span class="main">(</span><span class="free">qs1</span><span class="main">,</span>calculate_data_R <span class="free">p</span> <span class="free">qs1</span><span class="main">)</span> <span class="main">(</span><span class="free">qs2</span><span class="main">,</span>calculate_data_R <span class="free">p</span> <span class="free">qs2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> 
  <span class="main">(</span>get_matrix_R <span class="main">(</span>snd <span class="main">(</span><span class="main">(</span>combine_systems_R <span class="free">p</span> <span class="main">(</span><span class="free">qs1</span><span class="main">,</span>calculate_data_R <span class="free">p</span> <span class="free">qs1</span><span class="main">)</span> <span class="main">(</span><span class="free">qs2</span><span class="main">,</span>calculate_data_R <span class="free">p</span> <span class="free">qs2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> combining_sys_satisfies_properties_helper_R<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">p</span></span> <span class="quoted"><span class="free">qs1</span></span> <span class="quoted"><span class="free">qs2</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> getter_functions_R nontriv1 nontriv2 nonzero satisfies_properties_sys1 satisfies_properties_sys2<span class="main">)</span> 

<span class="keyword1" id="Renegar_Proofs-reducing_sys_satisfies_properties_R"><span class="command">lemma</span></span> reducing_sys_satisfies_properties_R<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">p</span><span class="main">::</span> <span class="quoted"><span class="quoted">"real poly"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">qs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real poly list"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">subsets</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>nat list<span class="main">*</span>nat list<span class="main">)</span> list"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">signs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"rat list list"</span></span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">matrix</span><span class="main">::</span> <span class="quoted"><span class="quoted">"rat mat"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> nonzero<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> nontriv<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">qs</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> satisfies_properties_sys<span class="main">:</span> <span class="quoted"><span class="quoted">"satisfies_properties_R <span class="free">p</span> <span class="free">qs</span> <span class="free">subsets</span> <span class="free">signs</span> <span class="free">matrix</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>  <span class="quoted"><span class="quoted">"satisfies_properties_R <span class="free">p</span> <span class="free">qs</span> <span class="main">(</span>get_subsets_R <span class="main">(</span>reduce_system_R <span class="free">p</span> <span class="main">(</span><span class="free">qs</span><span class="main">,</span><span class="free">matrix</span><span class="main">,</span><span class="free">subsets</span><span class="main">,</span><span class="free">signs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
  <span class="main">(</span>get_signs_R <span class="main">(</span>reduce_system_R <span class="free">p</span> <span class="main">(</span><span class="free">qs</span><span class="main">,</span><span class="free">matrix</span><span class="main">,</span><span class="free">subsets</span><span class="main">,</span><span class="free">signs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
  <span class="main">(</span>get_matrix_R <span class="main">(</span>reduce_system_R <span class="free">p</span> <span class="main">(</span><span class="free">qs</span><span class="main">,</span><span class="free">matrix</span><span class="main">,</span><span class="free">subsets</span><span class="main">,</span><span class="free">signs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> h1<span class="main">:</span> <span class="quoted"><span class="quoted">" all_list_constr_R <span class="main">(</span>get_subsets_R <span class="main">(</span>reduce_system_R <span class="free">p</span> <span class="main">(</span><span class="free">qs</span><span class="main">,</span> <span class="free">matrix</span><span class="main">,</span> <span class="free">subsets</span><span class="main">,</span> <span class="free">signs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>length <span class="free">qs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> reduction_doesnt_break_subsets_R assms reduction_subsets_is_get_subsets_R satisfies_properties_R_def satisfies_properties_sys <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> h2<span class="main">:</span> <span class="quoted"><span class="quoted">"well_def_signs <span class="main">(</span>length <span class="free">qs</span><span class="main">)</span> <span class="main">(</span>get_signs_R <span class="main">(</span>reduce_system_R <span class="free">p</span> <span class="main">(</span><span class="free">qs</span><span class="main">,</span> <span class="free">matrix</span><span class="main">,</span> <span class="free">subsets</span><span class="main">,</span> <span class="free">signs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> reduction_doesnt_break_length_signs_R<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">signs</span></span> <span class="quoted"><span class="free">qs</span></span> <span class="quoted"><span class="free">p</span></span> <span class="quoted"><span class="free">subsets</span></span><span class="main">]</span> assms reduction_signs_is_get_signs_R satisfies_properties_R_def well_def_signs_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> h3<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>get_signs_R <span class="main">(</span>reduce_system_R <span class="free">p</span> <span class="main">(</span><span class="free">qs</span><span class="main">,</span> <span class="free">matrix</span><span class="main">,</span> <span class="free">subsets</span><span class="main">,</span> <span class="free">signs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> reduction_signs_are_distinct_R<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">p</span></span> <span class="quoted"><span class="free">qs</span></span> <span class="quoted"><span class="free">subsets</span></span> <span class="quoted"><span class="free">signs</span></span><span class="main">]</span> assms reduction_signs_is_get_signs_R satisfies_properties_R_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
  <span class="keyword1"><span class="command">have</span></span> h4<span class="main">:</span> <span class="quoted"><span class="quoted">"satisfy_equation_R <span class="free">p</span> <span class="free">qs</span> <span class="main">(</span>get_subsets_R <span class="main">(</span>reduce_system_R <span class="free">p</span> <span class="main">(</span><span class="free">qs</span><span class="main">,</span> <span class="free">matrix</span><span class="main">,</span> <span class="free">subsets</span><span class="main">,</span> <span class="free">signs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
     <span class="main">(</span>get_signs_R <span class="main">(</span>reduce_system_R <span class="free">p</span> <span class="main">(</span><span class="free">qs</span><span class="main">,</span> <span class="free">matrix</span><span class="main">,</span> <span class="free">subsets</span><span class="main">,</span> <span class="free">signs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> reduce_system_matrix_equation_preserved_R<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">p</span></span> <span class="quoted"><span class="free">qs</span></span> <span class="quoted"><span class="free">signs</span></span> <span class="quoted"><span class="free">subsets</span></span><span class="main">]</span> assms satisfies_properties_R_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> h5<span class="main">:</span> <span class="quoted"><span class="quoted">"invertible_mat <span class="main">(</span>get_matrix_R <span class="main">(</span>reduce_system_R <span class="free">p</span> <span class="main">(</span><span class="free">qs</span><span class="main">,</span> <span class="free">matrix</span><span class="main">,</span> <span class="free">subsets</span><span class="main">,</span> <span class="free">signs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> reduction_doesnt_break_things_invertibility_R assms same_size_R satisfies_properties_R_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
  <span class="keyword1"><span class="command">have</span></span> h6<span class="main">:</span> <span class="quoted"><span class="quoted">"get_matrix_R <span class="main">(</span>reduce_system_R <span class="free">p</span> <span class="main">(</span><span class="free">qs</span><span class="main">,</span> <span class="free">matrix</span><span class="main">,</span> <span class="free">subsets</span><span class="main">,</span> <span class="free">signs</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
    matrix_A_R <span class="main">(</span>get_signs_R <span class="main">(</span>reduce_system_R <span class="free">p</span> <span class="main">(</span><span class="free">qs</span><span class="main">,</span> <span class="free">matrix</span><span class="main">,</span> <span class="free">subsets</span><span class="main">,</span> <span class="free">signs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
     <span class="main">(</span>get_subsets_R <span class="main">(</span>reduce_system_R <span class="free">p</span> <span class="main">(</span><span class="free">qs</span><span class="main">,</span> <span class="free">matrix</span><span class="main">,</span> <span class="free">subsets</span><span class="main">,</span> <span class="free">signs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> reduce_system_matrix_match_R<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">p</span></span> <span class="quoted"><span class="free">qs</span></span> <span class="quoted"><span class="free">signs</span></span> <span class="quoted"><span class="free">subsets</span></span><span class="main">]</span> assms satisfies_properties_R_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> h7<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>characterize_consistent_signs_at_roots <span class="free">p</span> <span class="free">qs</span><span class="main">)</span> <span class="main">⊆</span> set <span class="main">(</span>get_signs_R <span class="main">(</span>reduce_system_R <span class="free">p</span> <span class="main">(</span><span class="free">qs</span><span class="main">,</span> <span class="free">matrix</span><span class="main">,</span> <span class="free">subsets</span><span class="main">,</span> <span class="free">signs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> reduction_doesnt_break_things_signs_R<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">p</span></span> <span class="quoted"><span class="free">qs</span></span> <span class="quoted"><span class="free">signs</span></span> <span class="quoted"><span class="free">subsets</span></span><span class="main">]</span> assms reduction_signs_is_get_signs_R satisfies_properties_R_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> satisfies_properties_R_def <span class="keyword1"><span class="command">using</span></span> h1 h2 h3 h4 h5 h6 h7
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">"For length 1 qs"</span></span>

<span class="keyword1" id="Renegar_Proofs-length_1_calculate_data_satisfies_properties_R"><span class="command">lemma</span></span>  length_1_calculate_data_satisfies_properties_R<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">p</span><span class="main">::</span> <span class="quoted"><span class="quoted">"real poly"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">qs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real poly list"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">subsets</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>nat list<span class="main">*</span>nat list<span class="main">)</span> list"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">signs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"rat list list"</span></span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> nonzero<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> len1<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">qs</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"satisfies_properties_R <span class="free">p</span> <span class="free">qs</span> <span class="main">(</span>get_subsets_R <span class="main">(</span>calculate_data_R <span class="free">p</span> <span class="free">qs</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>get_signs_R <span class="main">(</span>calculate_data_R <span class="free">p</span> <span class="free">qs</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>get_matrix_R <span class="main">(</span>calculate_data_R <span class="free">p</span> <span class="free">qs</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
  <span class="keyword1"><span class="command">have</span></span> h1<span class="main">:</span> <span class="quoted"><span class="quoted">"all_list_constr_R  <span class="main">[</span><span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span><span class="main">,</span><span class="main">(</span><span class="main">[</span><span class="main">0</span><span class="main">]</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span><span class="main">,</span><span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="main">[</span><span class="main">0</span><span class="main">]</span><span class="main">)</span><span class="main">]</span> <span class="main">(</span>length <span class="free">qs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> len1 <span class="keyword1"><span class="command">unfolding</span></span> all_list_constr_R_def list_constr_def <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">smt</span> <span class="main"><span class="main">(</span></span>verit<span class="main"><span class="main">,</span></span> best<span class="main"><span class="main">)</span></span> Ball_set in_set_member member_rec<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> member_rec<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> prod.inject<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> <span class="main"><span class="main">(</span></span>verit<span class="main"><span class="main">,</span></span> ccfv_threshold<span class="main"><span class="main">)</span></span> Ball_set in_set_member member_rec<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> member_rec<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> prod.inject<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> h2<span class="main">:</span> <span class="quoted"><span class="quoted">"well_def_signs <span class="main">(</span>length <span class="free">qs</span><span class="main">)</span> <span class="main">[</span><span class="main">[</span><span class="main">1</span><span class="main">]</span><span class="main">,</span><span class="main">[</span><span class="main">-</span><span class="main">1</span><span class="main">]</span><span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> well_def_signs_def <span class="keyword1"><span class="command">using</span></span> len1 in_set_member 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> h3<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span><span class="main">[</span><span class="main">[</span><span class="main">1</span><span class="main">]</span><span class="main">,</span><span class="main">[</span><span class="main">0</span><span class="main">]</span><span class="main">,</span><span class="main">[</span><span class="main">-</span><span class="main">1</span><span class="main">]</span><span class="main">]</span><span class="main">::</span>rat list list<span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">unfolding</span></span> distinct_def <span class="keyword1"><span class="command">using</span></span> in_set_member <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> h4<span class="main">:</span> <span class="quoted"><span class="quoted">"satisfy_equation_R <span class="free">p</span> <span class="free">qs</span> <span class="main">[</span><span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span><span class="main">,</span><span class="main">(</span><span class="main">[</span><span class="main">0</span><span class="main">]</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span><span class="main">,</span><span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="main">[</span><span class="main">0</span><span class="main">]</span><span class="main">)</span><span class="main">]</span> <span class="main">[</span><span class="main">[</span><span class="main">1</span><span class="main">]</span><span class="main">,</span><span class="main">[</span><span class="main">0</span><span class="main">]</span><span class="main">,</span><span class="main">[</span><span class="main">-</span><span class="main">1</span><span class="main">]</span><span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms base_case_satisfy_equation_alt_R<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">qs</span></span> <span class="quoted"><span class="free">p</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> h6<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>mat_of_rows_list <span class="numeral">3</span> <span class="main">[</span><span class="main">[</span><span class="main">1</span><span class="main">,</span><span class="main">1</span><span class="main">,</span><span class="main">1</span><span class="main">]</span><span class="main">,</span> <span class="main">[</span><span class="main">0</span><span class="main">,</span><span class="main">1</span><span class="main">,</span><span class="main">0</span><span class="main">]</span><span class="main">,</span> <span class="main">[</span><span class="main">1</span><span class="main">,</span><span class="main">0</span><span class="main">,</span><span class="main">-</span><span class="main">1</span><span class="main">]</span><span class="main">]</span><span class="main">::</span>rat mat<span class="main">)</span> <span class="main">=</span> <span class="main">(</span>matrix_A_R <span class="main">(</span><span class="main">[</span><span class="main">[</span><span class="main">1</span><span class="main">]</span><span class="main">,</span><span class="main">[</span><span class="main">0</span><span class="main">]</span><span class="main">,</span><span class="main">[</span><span class="main">-</span><span class="main">1</span><span class="main">]</span><span class="main">]</span><span class="main">)</span> <span class="main">(</span><span class="main">[</span><span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span><span class="main">,</span><span class="main">(</span><span class="main">[</span><span class="main">0</span><span class="main">]</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span><span class="main">,</span><span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="main">[</span><span class="main">0</span><span class="main">]</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="main">::</span> rat mat<span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> mat_base_case_R <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> h5<span class="main">:</span> <span class="quoted"><span class="quoted">"invertible_mat <span class="main">(</span>mat_of_rows_list <span class="numeral">3</span> <span class="main">[</span><span class="main">[</span><span class="main">1</span><span class="main">,</span><span class="main">1</span><span class="main">,</span><span class="main">1</span><span class="main">]</span><span class="main">,</span> <span class="main">[</span><span class="main">0</span><span class="main">,</span><span class="main">1</span><span class="main">,</span><span class="main">0</span><span class="main">]</span><span class="main">,</span> <span class="main">[</span><span class="main">1</span><span class="main">,</span><span class="main">0</span><span class="main">,</span><span class="main">-</span><span class="main">1</span><span class="main">]</span><span class="main">]</span><span class="main">::</span>rat mat<span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> base_case_invertible_mat_R
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> h7<span class="main">:</span>  <span class="quoted"><span class="quoted">"set <span class="main">(</span>characterize_consistent_signs_at_roots <span class="free">p</span> <span class="free">qs</span><span class="main">)</span> <span class="main">⊆</span> set <span class="main">(</span><span class="main">[</span><span class="main">[</span><span class="main">1</span><span class="main">]</span><span class="main">,</span><span class="main">[</span><span class="main">0</span><span class="main">]</span><span class="main">,</span><span class="main">[</span><span class="main">-</span><span class="main">1</span><span class="main">]</span><span class="main">]</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms base_case_sgas_alt_R<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">qs</span></span> <span class="quoted"><span class="free">p</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>  
  <span class="keyword1"><span class="command">have</span></span> base_case_hyp<span class="main">:</span> <span class="quoted"><span class="quoted">"satisfies_properties_R <span class="free">p</span> <span class="free">qs</span> <span class="main">[</span><span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span><span class="main">,</span><span class="main">(</span><span class="main">[</span><span class="main">0</span><span class="main">]</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span><span class="main">,</span><span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="main">[</span><span class="main">0</span><span class="main">]</span><span class="main">)</span><span class="main">]</span> <span class="main">[</span><span class="main">[</span><span class="main">1</span><span class="main">]</span><span class="main">,</span><span class="main">[</span><span class="main">0</span><span class="main">]</span><span class="main">,</span><span class="main">[</span><span class="main">-</span><span class="main">1</span><span class="main">]</span><span class="main">]</span> <span class="main">(</span>mat_of_rows_list <span class="numeral">3</span> <span class="main">[</span><span class="main">[</span><span class="main">1</span><span class="main">,</span><span class="main">1</span><span class="main">,</span><span class="main">1</span><span class="main">]</span><span class="main">,</span> <span class="main">[</span><span class="main">0</span><span class="main">,</span><span class="main">1</span><span class="main">,</span><span class="main">0</span><span class="main">]</span><span class="main">,</span> <span class="main">[</span><span class="main">1</span><span class="main">,</span><span class="main">0</span><span class="main">,</span><span class="main">-</span><span class="main">1</span><span class="main">]</span><span class="main">]</span><span class="main">::</span>rat mat<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> h1 h2 h3 h4 h5 h6 h7
    <span class="keyword1"><span class="command">using</span></span> satisfies_properties_R_def <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> well_def_signs_def<span class="main">)</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> key_hyp<span class="main">:</span> <span class="quoted"><span class="quoted">"satisfies_properties_R <span class="free">p</span> <span class="free">qs</span> <span class="main">(</span>get_subsets_R <span class="main">(</span>reduce_system_R <span class="free">p</span> <span class="main">(</span><span class="free">qs</span><span class="main">,</span>base_case_info_R<span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>get_signs_R <span class="main">(</span>reduce_system_R <span class="free">p</span> <span class="main">(</span><span class="free">qs</span><span class="main">,</span>base_case_info_R<span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>get_matrix_R <span class="main">(</span>reduce_system_R <span class="free">p</span> <span class="main">(</span><span class="free">qs</span><span class="main">,</span>base_case_info_R<span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> reducing_sys_satisfies_properties_R
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> base_case_info_R_def len1 nonzero nonzero zero_less_one_class.zero_less_one<span class="main">)</span> 
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> key_hyp len1<span class="main">)</span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">"For arbitrary qs"</span></span>

<span class="keyword1" id="Renegar_Proofs-calculate_data_satisfies_properties_R"><span class="command">lemma</span></span>  calculate_data_satisfies_properties_R<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">p</span><span class="main">::</span> <span class="quoted"><span class="quoted">"real poly"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">qs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real poly list"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">subsets</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>nat list<span class="main">*</span>nat list<span class="main">)</span> list"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">signs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"rat list list"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">p</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">∧</span> <span class="main">(</span>length <span class="free">qs</span> <span class="main">&gt;</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span>
    <span class="main">⟶</span> satisfies_properties_R <span class="free">p</span> <span class="free">qs</span> <span class="main">(</span>get_subsets_R <span class="main">(</span>calculate_data_R <span class="free">p</span> <span class="free">qs</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>get_signs_R <span class="main">(</span>calculate_data_R <span class="free">p</span> <span class="free">qs</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>get_matrix_R <span class="main">(</span>calculate_data_R <span class="free">p</span> <span class="free">qs</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="quoted">"length <span class="free">qs</span>"</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">qs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> less_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> less
  <span class="keyword1"><span class="command">have</span></span> len1_h<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="skolem">qs</span> <span class="main">=</span> <span class="main">1</span> <span class="main">⟶</span> <span class="main">(</span> <span class="free">p</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">∧</span> <span class="main">(</span>length <span class="skolem">qs</span> <span class="main">&gt;</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span> satisfies_properties_R <span class="free">p</span> <span class="skolem">qs</span> <span class="main">(</span>get_subsets_R <span class="main">(</span>calculate_data_R <span class="free">p</span> <span class="skolem">qs</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>get_signs_R <span class="main">(</span>calculate_data_R <span class="free">p</span> <span class="skolem">qs</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>get_matrix_R <span class="main">(</span>calculate_data_R <span class="free">p</span> <span class="skolem">qs</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span>  length_1_calculate_data_satisfies_properties_R
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?len</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"length <span class="skolem">qs</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?q1</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"take <span class="main">(</span><span class="var">?len</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="skolem">qs</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?left</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"calculate_data_R <span class="free">p</span> <span class="var">?q1</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?q2</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"drop <span class="main">(</span><span class="var">?len</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="skolem">qs</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?right</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"calculate_data_R <span class="free">p</span> <span class="var">?q2</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?comb</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"combine_systems_R <span class="free">p</span> <span class="main">(</span><span class="var">?q1</span><span class="main">,</span><span class="var">?left</span><span class="main">)</span> <span class="main">(</span><span class="var">?q2</span><span class="main">,</span><span class="var">?right</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?red</span></span></span> <span class="main">=</span>  <span class="quoted"><span class="quoted">"reduce_system_R <span class="free">p</span> <span class="var">?comb</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> h_q1_len<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="skolem">qs</span> <span class="main">&gt;</span> <span class="main">1</span> <span class="main">⟶</span> <span class="main">(</span>length <span class="var">?q1</span> <span class="main">&gt;</span> <span class="main">0</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
  <span class="keyword1"><span class="command">have</span></span> h_q2_len<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="skolem">qs</span> <span class="main">&gt;</span> <span class="main">1</span> <span class="main">⟶</span> <span class="main">(</span>length <span class="var">?q2</span> <span class="main">&gt;</span> <span class="main">0</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> q1_sat_props<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="skolem">qs</span> <span class="main">&gt;</span> <span class="main">1</span> <span class="main">⟶</span> <span class="main">(</span><span class="free">p</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">∧</span> <span class="main">(</span>length <span class="skolem">qs</span> <span class="main">&gt;</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span> satisfies_properties_R <span class="free">p</span> <span class="var">?q1</span> <span class="main">(</span>get_subsets_R <span class="main">(</span>calculate_data_R <span class="free">p</span> <span class="var">?q1</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>get_signs_R <span class="main">(</span>calculate_data_R <span class="free">p</span> <span class="var">?q1</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>get_matrix_R <span class="main">(</span>calculate_data_R <span class="free">p</span> <span class="var">?q1</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> less.hyps<span class="main">[</span><span class="operator">of</span> <span class="var"><span class="quoted"><span class="var">?q1</span></span></span><span class="main">]</span> h_q1_len
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> div_le_dividend div_less_dividend length_take min.absorb2 one_less_numeral_iff semiring_norm<span class="main"><span class="main">(</span></span>76<span class="main"><span class="main">)</span></span><span class="main">)</span> 
  <span class="keyword1"><span class="command">have</span></span> q2_help<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="skolem">qs</span> <span class="main">&gt;</span> <span class="main">1</span> <span class="main">⟶</span> length <span class="main">(</span>drop <span class="main">(</span>length <span class="skolem">qs</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="skolem">qs</span><span class="main">)</span> <span class="main">&lt;</span> length <span class="skolem">qs</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> h_q1_len <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>  
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> q2_sat_props<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="skolem">qs</span> <span class="main">&gt;</span> <span class="main">1</span> <span class="main">⟶</span> <span class="main">(</span><span class="free">p</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">∧</span> <span class="main">(</span>length <span class="skolem">qs</span> <span class="main">&gt;</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span> satisfies_properties_R <span class="free">p</span> <span class="var">?q2</span> <span class="main">(</span>get_subsets_R <span class="main">(</span>calculate_data_R <span class="free">p</span> <span class="var">?q2</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>get_signs_R <span class="main">(</span>calculate_data_R <span class="free">p</span> <span class="var">?q2</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>get_matrix_R <span class="main">(</span>calculate_data_R <span class="free">p</span> <span class="var">?q2</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> less.hyps<span class="main">[</span><span class="operator">of</span> <span class="var"><span class="quoted"><span class="var">?q2</span></span></span><span class="main">]</span> h_q2_len
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> put_tog<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?q1</span><span class="main">@</span><span class="var">?q2</span> <span class="main">=</span> <span class="skolem">qs</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> append_take_drop_id <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> comb_sat_props<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="skolem">qs</span> <span class="main">&gt;</span> <span class="main">1</span> <span class="main">⟶</span> <span class="main">(</span><span class="free">p</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">∧</span> <span class="main">(</span>length <span class="skolem">qs</span> <span class="main">&gt;</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">(</span>satisfies_properties_R <span class="free">p</span> <span class="main">(</span><span class="skolem">qs</span><span class="main">)</span> <span class="main">(</span>get_subsets_R <span class="main">(</span>snd <span class="main">(</span><span class="main">(</span>combine_systems_R <span class="free">p</span> <span class="main">(</span><span class="var">?q1</span><span class="main">,</span>calculate_data_R <span class="free">p</span> <span class="var">?q1</span><span class="main">)</span> <span class="main">(</span><span class="var">?q2</span><span class="main">,</span>calculate_data_R <span class="free">p</span> <span class="var">?q2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> 
  <span class="main">(</span>get_signs_R <span class="main">(</span>snd <span class="main">(</span><span class="main">(</span>combine_systems_R <span class="free">p</span> <span class="main">(</span><span class="var">?q1</span><span class="main">,</span>calculate_data_R <span class="free">p</span> <span class="var">?q1</span><span class="main">)</span> <span class="main">(</span><span class="var">?q2</span><span class="main">,</span>calculate_data_R <span class="free">p</span> <span class="var">?q2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> 
  <span class="main">(</span>get_matrix_R <span class="main">(</span>snd <span class="main">(</span><span class="main">(</span>combine_systems_R <span class="free">p</span> <span class="main">(</span><span class="var">?q1</span><span class="main">,</span>calculate_data_R <span class="free">p</span> <span class="var">?q1</span><span class="main">)</span> <span class="main">(</span><span class="var">?q2</span><span class="main">,</span>calculate_data_R <span class="free">p</span> <span class="var">?q2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> q1_sat_props q2_sat_props  combining_sys_satisfies_properties_R
    <span class="keyword1"><span class="command">using</span></span> h_q1_len h_q2_len  put_tog
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> comb_sat<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="skolem">qs</span> <span class="main">&gt;</span> <span class="main">1</span> <span class="main">⟶</span> <span class="main">(</span><span class="free">p</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">∧</span> <span class="main">(</span>length <span class="skolem">qs</span> <span class="main">&gt;</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span> 
      <span class="main">(</span>satisfies_properties_R <span class="free">p</span> <span class="main">(</span><span class="skolem">qs</span><span class="main">)</span> <span class="main">(</span>get_subsets_R <span class="main">(</span>snd <span class="var">?comb</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>get_signs_R <span class="main">(</span>snd <span class="var">?comb</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>get_matrix_R <span class="main">(</span>snd <span class="var">?comb</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> red_char<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?red</span> <span class="main">=</span> <span class="main">(</span>reduce_system_R <span class="free">p</span> <span class="main">(</span><span class="skolem">qs</span><span class="main">,</span><span class="main">(</span>get_matrix_R <span class="main">(</span>snd <span class="var">?comb</span><span class="main">)</span><span class="main">)</span><span class="main">,</span><span class="main">(</span>get_subsets_R <span class="main">(</span>snd <span class="var">?comb</span><span class="main">)</span><span class="main">)</span><span class="main">,</span><span class="main">(</span>get_signs_R <span class="main">(</span>snd <span class="var">?comb</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> getter_functions
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> <span class="main"><span class="main">(</span></span>z3<span class="main"><span class="main">)</span></span> combine_systems_R.simps find_consistent_signs_at_roots_R_def find_consistent_signs_at_roots_thm_R fst_conv get_matrix_R_def get_signs_R_def get_subsets_R_def prod.collapse put_tog smash_systems_R_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">qs</span> <span class="main">&gt;</span> <span class="main">1</span> <span class="main">⟶</span> <span class="main">(</span><span class="free">p</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">∧</span> <span class="main">(</span>length <span class="skolem">qs</span> <span class="main">&gt;</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span>  <span class="main">⟶</span> <span class="main">(</span>satisfies_properties_R <span class="free">p</span> <span class="skolem">qs</span> <span class="main">(</span>get_subsets_R <span class="var">?red</span><span class="main">)</span> <span class="main">(</span>get_signs_R <span class="var">?red</span><span class="main">)</span> <span class="main">(</span>get_matrix_R <span class="var">?red</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> reducing_sys_satisfies_properties_R comb_sat
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> len_gt1<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="skolem">qs</span> <span class="main">&gt;</span> <span class="main">1</span> <span class="main">⟶</span> <span class="main">(</span><span class="free">p</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">∧</span> <span class="main">(</span>length <span class="skolem">qs</span> <span class="main">&gt;</span> <span class="main">0</span><span class="main">)</span> <span class="main">)</span> <span class="main">⟶</span> satisfies_properties_R <span class="free">p</span> <span class="skolem">qs</span> <span class="main">(</span>get_subsets_R <span class="main">(</span>calculate_data_R <span class="free">p</span> <span class="skolem">qs</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>get_signs_R <span class="main">(</span>calculate_data_R <span class="free">p</span> <span class="skolem">qs</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>get_matrix_R <span class="main">(</span>calculate_data_R <span class="free">p</span> <span class="skolem">qs</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> <span class="main"><span class="main">(</span></span>z3<span class="main"><span class="main">)</span></span> div_le_dividend min.absorb2<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> len1_h len_gt1
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> One_nat_def Suc_lessI<span class="main">)</span> 
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Some key results on consistent sign assignments"</span></span>

<span class="keyword1" id="Renegar_Proofs-find_consistent_signs_at_roots_len1_R"><span class="command">lemma</span></span> find_consistent_signs_at_roots_len1_R<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">p</span><span class="main">::</span> <span class="quoted"><span class="quoted">"real poly"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">qs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real poly list"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">subsets</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>nat list<span class="main">*</span>nat list<span class="main">)</span> list"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">signs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"rat list list"</span></span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> nonzero<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> len1<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">qs</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>find_consistent_signs_at_roots_R <span class="free">p</span> <span class="free">qs</span><span class="main">)</span> <span class="main">=</span> set <span class="main">(</span>characterize_consistent_signs_at_roots <span class="free">p</span> <span class="free">qs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?signs</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">[</span><span class="main">1</span><span class="main">]</span><span class="main">,</span><span class="main">[</span><span class="main">0</span><span class="main">]</span><span class="main">,</span><span class="main">[</span><span class="main">-</span><span class="main">1</span><span class="main">]</span><span class="main">]</span><span class="main">::</span>rat list list"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?subsets</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span><span class="main">,</span><span class="main">(</span><span class="main">[</span><span class="main">0</span><span class="main">]</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span><span class="main">,</span><span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="main">[</span><span class="main">0</span><span class="main">]</span><span class="main">)</span><span class="main">]</span><span class="main">::</span><span class="main">(</span>nat list<span class="main">*</span>nat list<span class="main">)</span> list"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?mat</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>mat_of_rows_list <span class="numeral">3</span> <span class="main">[</span><span class="main">[</span><span class="main">1</span><span class="main">,</span><span class="main">1</span><span class="main">,</span><span class="main">1</span><span class="main">]</span><span class="main">,</span> <span class="main">[</span><span class="main">0</span><span class="main">,</span><span class="main">1</span><span class="main">,</span><span class="main">0</span><span class="main">]</span><span class="main">,</span> <span class="main">[</span><span class="main">1</span><span class="main">,</span><span class="main">0</span><span class="main">,</span><span class="main">-</span><span class="main">1</span><span class="main">]</span><span class="main">]</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> mat_help<span class="main">:</span> <span class="quoted"><span class="quoted">"matrix_A_R <span class="var">?signs</span> <span class="var">?subsets</span> <span class="main">=</span> <span class="main">(</span>mat_of_rows_list <span class="numeral">3</span> <span class="main">[</span><span class="main">[</span><span class="main">1</span><span class="main">,</span><span class="main">1</span><span class="main">,</span><span class="main">1</span><span class="main">]</span><span class="main">,</span> <span class="main">[</span><span class="main">0</span><span class="main">,</span><span class="main">1</span><span class="main">,</span><span class="main">0</span><span class="main">]</span><span class="main">,</span> <span class="main">[</span><span class="main">1</span><span class="main">,</span><span class="main">0</span><span class="main">,</span><span class="main">-</span><span class="main">1</span><span class="main">]</span><span class="main">]</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> mat_base_case_R <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> well_def_signs<span class="main">:</span> <span class="quoted"><span class="quoted">"well_def_signs <span class="main">(</span>length <span class="free">qs</span><span class="main">)</span> <span class="var">?signs</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> well_def_signs_def 
    <span class="keyword1"><span class="command">using</span></span> len1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> distinct_signs<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="var">?signs</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> distinct_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> ex_q<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="main">(</span><span class="bound">q</span><span class="main">::</span>real poly<span class="main">)</span><span class="main">.</span> <span class="free">qs</span> <span class="main">=</span> <span class="main">[</span><span class="bound">q</span><span class="main">]</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> len1    
    <span class="keyword1"><span class="command">using</span></span> length_Suc_conv<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">qs</span></span> <span class="quoted"><span class="main">0</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> all_info<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>characterize_consistent_signs_at_roots <span class="free">p</span> <span class="free">qs</span><span class="main">)</span> <span class="main">⊆</span> set<span class="main">(</span><span class="var">?signs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms base_case_sgas_R <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> match<span class="main">:</span> <span class="quoted"><span class="quoted">"satisfy_equation_R <span class="free">p</span> <span class="free">qs</span> <span class="var">?subsets</span> <span class="var">?signs</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ex_q base_case_satisfy_equation_R nonzero
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> invertible_mat<span class="main">:</span> <span class="quoted"><span class="quoted">"invertible_mat <span class="main">(</span>matrix_A_R <span class="var">?signs</span> <span class="var">?subsets</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> inverse_mat_base_case_R inverse_mat_base_case_2_R <span class="keyword1"><span class="command">unfolding</span></span> invertible_mat_def <span class="keyword1"><span class="command">using</span></span> mat_base_case_R
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> h<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>get_signs_R <span class="main">(</span>reduce_system_R <span class="free">p</span> <span class="main">(</span><span class="free">qs</span><span class="main">,</span> <span class="main">(</span><span class="main">(</span>matrix_A_R <span class="var">?signs</span> <span class="var">?subsets</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="var">?subsets</span><span class="main">,</span> <span class="var">?signs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
    set <span class="main">(</span>characterize_consistent_signs_at_roots <span class="free">p</span> <span class="free">qs</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> nonzero nonzero well_def_signs distinct_signs all_info match invertible_mat
      reduce_system_sign_conditions_R<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> p <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span>"</span></span><span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> qs <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="free">qs</span>"</span></span><span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> signs <span class="main"><span class="main">=</span></span> <span class="var"><span class="quoted"><span class="var">?signs</span></span></span><span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> subsets <span class="main"><span class="main">=</span></span> <span class="var"><span class="quoted"><span class="var">?subsets</span></span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span>  <span class="quoted"><span class="quoted">"set <span class="main">(</span>snd <span class="main">(</span>snd <span class="main">(</span>reduce_system_R <span class="free">p</span> <span class="main">(</span><span class="free">qs</span><span class="main">,</span> <span class="main">(</span><span class="var">?mat</span><span class="main">,</span> <span class="main">(</span><span class="var">?subsets</span><span class="main">,</span> <span class="var">?signs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
    set <span class="main">(</span>characterize_consistent_signs_at_roots <span class="free">p</span> <span class="free">qs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> get_signs_R_def <span class="keyword1"><span class="command">using</span></span> mat_help <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>snd <span class="main">(</span>snd <span class="main">(</span>reduce_system_R <span class="free">p</span> <span class="main">(</span><span class="free">qs</span><span class="main">,</span> base_case_info_R<span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> set <span class="main">(</span>characterize_consistent_signs_at_roots <span class="free">p</span> <span class="free">qs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> base_case_info_R_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> len1 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> find_consistent_signs_at_roots_thm_R<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Renegar_Proofs-smaller_sys_are_good_R"><span class="command">lemma</span></span> smaller_sys_are_good_R<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">p</span><span class="main">::</span> <span class="quoted"><span class="quoted">"real poly"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">qs1</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real poly list"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">qs2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real poly list"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">subsets</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>nat list<span class="main">*</span>nat list<span class="main">)</span> list"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">signs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"rat list list"</span></span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> nonzero<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> nontriv1<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">qs1</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> nontriv2<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">qs2</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"set<span class="main">(</span>find_consistent_signs_at_roots_R <span class="free">p</span> <span class="free">qs1</span><span class="main">)</span> <span class="main">=</span> set<span class="main">(</span>characterize_consistent_signs_at_roots <span class="free">p</span> <span class="free">qs1</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"set<span class="main">(</span>find_consistent_signs_at_roots_R <span class="free">p</span> <span class="free">qs2</span><span class="main">)</span> <span class="main">=</span> set<span class="main">(</span>characterize_consistent_signs_at_roots <span class="free">p</span> <span class="free">qs2</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"set<span class="main">(</span>snd<span class="main">(</span>snd<span class="main">(</span>reduce_system_R <span class="free">p</span> <span class="main">(</span>combine_systems_R <span class="free">p</span> <span class="main">(</span><span class="free">qs1</span><span class="main">,</span>calculate_data_R <span class="free">p</span> <span class="free">qs1</span><span class="main">)</span> <span class="main">(</span><span class="free">qs2</span><span class="main">,</span>calculate_data_R <span class="free">p</span> <span class="free">qs2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
    <span class="main">=</span> set<span class="main">(</span>characterize_consistent_signs_at_roots <span class="free">p</span> <span class="main">(</span><span class="free">qs1</span><span class="main">@</span><span class="free">qs2</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?signs</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>get_signs_R <span class="main">(</span>snd <span class="main">(</span><span class="main">(</span>combine_systems_R <span class="free">p</span> <span class="main">(</span><span class="free">qs1</span><span class="main">,</span>calculate_data_R <span class="free">p</span> <span class="free">qs1</span><span class="main">)</span> <span class="main">(</span><span class="free">qs2</span><span class="main">,</span>calculate_data_R <span class="free">p</span> <span class="free">qs2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> "</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?subsets</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>get_subsets_R <span class="main">(</span>snd <span class="main">(</span><span class="main">(</span>combine_systems_R <span class="free">p</span> <span class="main">(</span><span class="free">qs1</span><span class="main">,</span>calculate_data_R <span class="free">p</span> <span class="free">qs1</span><span class="main">)</span> <span class="main">(</span><span class="free">qs2</span><span class="main">,</span>calculate_data_R <span class="free">p</span> <span class="free">qs2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> "</span></span>
  <span class="keyword1"><span class="command">have</span></span> h0<span class="main">:</span> <span class="quoted"><span class="quoted">"satisfies_properties_R <span class="free">p</span> <span class="main">(</span><span class="free">qs1</span><span class="main">@</span><span class="free">qs2</span><span class="main">)</span> <span class="var">?subsets</span> <span class="var">?signs</span>
    <span class="main">(</span>get_matrix_R <span class="main">(</span>snd <span class="main">(</span><span class="main">(</span>combine_systems_R <span class="free">p</span> <span class="main">(</span><span class="free">qs1</span><span class="main">,</span>calculate_data_R <span class="free">p</span> <span class="free">qs1</span><span class="main">)</span> <span class="main">(</span><span class="free">qs2</span><span class="main">,</span>calculate_data_R <span class="free">p</span> <span class="free">qs2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> calculate_data_satisfies_properties_R combining_sys_satisfies_properties_R
    <span class="keyword1"><span class="command">using</span></span> nontriv1 nontriv2 nonzero nonzero
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> h1<span class="main">:</span> <span class="quoted"><span class="quoted">"set<span class="main">(</span>characterize_consistent_signs_at_roots <span class="free">p</span> <span class="main">(</span><span class="free">qs1</span><span class="main">@</span><span class="free">qs2</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> set <span class="var">?signs</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> satisfies_properties_R_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span> 
  <span class="keyword1"><span class="command">have</span></span> h2<span class="main">:</span> <span class="quoted"><span class="quoted">"well_def_signs <span class="main">(</span>length <span class="main">(</span><span class="free">qs1</span><span class="main">@</span><span class="free">qs2</span><span class="main">)</span><span class="main">)</span> <span class="var">?signs</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> calculate_data_satisfies_properties_R
    <span class="keyword1"><span class="command">using</span></span> h0 satisfies_properties_R_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
  <span class="keyword1"><span class="command">have</span></span> h3<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="var">?signs</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> calculate_data_satisfies_properties_R
    <span class="keyword1"><span class="command">using</span></span> h0 satisfies_properties_R_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
  <span class="keyword1"><span class="command">have</span></span> h4<span class="main">:</span> <span class="quoted"><span class="quoted">"satisfy_equation_R <span class="free">p</span> <span class="main">(</span><span class="free">qs1</span><span class="main">@</span><span class="free">qs2</span><span class="main">)</span> <span class="var">?subsets</span> <span class="var">?signs</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> calculate_data_satisfies_properties_R
    <span class="keyword1"><span class="command">using</span></span> h0 satisfies_properties_R_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
  <span class="keyword1"><span class="command">have</span></span> h5<span class="main">:</span> <span class="quoted"><span class="quoted">"invertible_mat <span class="main">(</span>matrix_A_R <span class="var">?signs</span> <span class="var">?subsets</span><span class="main">)</span> "</span></span>
    <span class="keyword1"><span class="command">using</span></span> calculate_data_satisfies_properties_R 
    <span class="keyword1"><span class="command">using</span></span> h0 satisfies_properties_R_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> h<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>take_indices <span class="var">?signs</span> 
            <span class="main">(</span>find_nonzeros_from_input_vec <span class="main">(</span>solve_for_lhs_R <span class="free">p</span> <span class="main">(</span><span class="free">qs1</span><span class="main">@</span><span class="free">qs2</span><span class="main">)</span> <span class="var">?subsets</span>  <span class="main">(</span>matrix_A_R <span class="var">?signs</span> <span class="var">?subsets</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
        <span class="main">=</span>  set<span class="main">(</span>characterize_consistent_signs_at_roots <span class="free">p</span> <span class="main">(</span><span class="free">qs1</span><span class="main">@</span><span class="free">qs2</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> h1 h2 h3 h4 h5 reduction_deletes_bad_sign_conds_R
    <span class="keyword1"><span class="command">using</span></span> nonzero reduction_signs_R_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> h<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>characterize_consistent_signs_at_roots <span class="free">p</span> <span class="main">(</span><span class="free">qs1</span><span class="main">@</span><span class="free">qs2</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
    set <span class="main">(</span>reduction_signs_R <span class="free">p</span> <span class="main">(</span><span class="free">qs1</span><span class="main">@</span><span class="free">qs2</span><span class="main">)</span> <span class="var">?signs</span> <span class="var">?subsets</span>  <span class="main">(</span>matrix_A_R <span class="var">?signs</span> <span class="var">?subsets</span> <span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">unfolding</span></span> reduction_signs_R_def get_signs_R_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>  
  <span class="keyword1"><span class="command">have</span></span> help_h<span class="main">:</span> <span class="quoted"><span class="quoted">"reduction_signs_R <span class="free">p</span> <span class="main">(</span><span class="free">qs1</span><span class="main">@</span><span class="free">qs2</span><span class="main">)</span> <span class="var">?signs</span> <span class="var">?subsets</span>  <span class="main">(</span>matrix_A_R <span class="var">?signs</span> <span class="var">?subsets</span><span class="main">)</span> 
      <span class="main">=</span> <span class="main">(</span>take_indices <span class="var">?signs</span> <span class="main">(</span>find_nonzeros_from_input_vec <span class="main">(</span>solve_for_lhs_R <span class="free">p</span> <span class="main">(</span><span class="free">qs1</span><span class="main">@</span><span class="free">qs2</span><span class="main">)</span> <span class="var">?subsets</span>  <span class="main">(</span>matrix_A_R<span class="var">?signs</span> <span class="var">?subsets</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> reduction_signs_R_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> clear_signs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>signs_smash <span class="main">(</span>get_signs_R <span class="main">(</span>calculate_data_R <span class="free">p</span> <span class="free">qs1</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>get_signs_R <span class="main">(</span>calculate_data_R <span class="free">p</span> <span class="free">qs2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>get_signs_R <span class="main">(</span>snd <span class="main">(</span><span class="main">(</span>combine_systems_R <span class="free">p</span> <span class="main">(</span><span class="free">qs1</span><span class="main">,</span>calculate_data_R <span class="free">p</span> <span class="free">qs1</span><span class="main">)</span> <span class="main">(</span><span class="free">qs2</span><span class="main">,</span>calculate_data_R <span class="free">p</span> <span class="free">qs2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> combining_to_smash get_signs_R_def getter_functions_R smash_systems_R_def snd_conv
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"combine_systems_R <span class="free">p</span> <span class="main">(</span><span class="free">qs1</span><span class="main">,</span> calculate_data_R <span class="free">p</span> <span class="free">qs1</span><span class="main">)</span> <span class="main">(</span><span class="free">qs2</span><span class="main">,</span> calculate_data_R <span class="free">p</span> <span class="free">qs2</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">qs1</span> <span class="main">@</span> <span class="free">qs2</span><span class="main">,</span> kronecker_product <span class="main">(</span>get_matrix_R <span class="main">(</span>calculate_data_R <span class="free">p</span> <span class="free">qs1</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>get_matrix_R <span class="main">(</span>calculate_data_R <span class="free">p</span> <span class="free">qs2</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> subsets_smash_R <span class="main">(</span>length <span class="free">qs1</span><span class="main">)</span> <span class="main">(</span>get_subsets_R <span class="main">(</span>calculate_data_R <span class="free">p</span> <span class="free">qs1</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>get_subsets_R <span class="main">(</span>calculate_data_R <span class="free">p</span> <span class="free">qs2</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> signs_smash <span class="main">(</span>snd <span class="main">(</span>snd <span class="main">(</span>calculate_data_R <span class="free">p</span> <span class="free">qs1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>snd <span class="main">(</span>snd <span class="main">(</span>calculate_data_R <span class="free">p</span> <span class="free">qs2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> combine_systems_R.simps get_signs_R_def getter_functions_R smash_systems_R_def<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> get_signs_R_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">have</span></span> clear_subsets<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>subsets_smash_R <span class="main">(</span>length <span class="free">qs1</span><span class="main">)</span> <span class="main">(</span>get_subsets_R<span class="main">(</span>calculate_data_R <span class="free">p</span> <span class="free">qs1</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>get_subsets_R <span class="main">(</span>calculate_data_R <span class="free">p</span> <span class="free">qs2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>get_subsets_R <span class="main">(</span>snd <span class="main">(</span><span class="main">(</span>combine_systems_R <span class="free">p</span> <span class="main">(</span><span class="free">qs1</span><span class="main">,</span>calculate_data_R <span class="free">p</span> <span class="free">qs1</span><span class="main">)</span> <span class="main">(</span><span class="free">qs2</span><span class="main">,</span>calculate_data_R <span class="free">p</span> <span class="free">qs2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>  
    <span class="keyword1"><span class="command">using</span></span> Pair_inject combining_to_smash get_subsets_R_def prod.collapse smash_systems_R_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> <span class="main"><span class="main">(</span></span>z3<span class="main"><span class="main">)</span></span> combine_systems_R.simps<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"well_def_signs <span class="main">(</span>length <span class="free">qs1</span><span class="main">)</span> <span class="main">(</span>get_signs_R <span class="main">(</span>calculate_data_R <span class="free">p</span> <span class="free">qs1</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> calculate_data_satisfies_properties_R
    <span class="keyword1"><span class="command">using</span></span> nontriv1 nonzero nonzero satisfies_properties_R_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> well_def_signs1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">j</span><span class="main">.</span> <span class="bound">j</span> <span class="main">∈</span> set <span class="main">(</span>get_signs_R <span class="main">(</span>calculate_data_R <span class="free">p</span> <span class="free">qs1</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> length <span class="bound">j</span> <span class="main">=</span> <span class="main">(</span>length <span class="free">qs1</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> well_def_signs_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"all_list_constr_R <span class="main">(</span>get_subsets_R<span class="main">(</span>calculate_data_R <span class="free">p</span> <span class="free">qs1</span><span class="main">)</span><span class="main">)</span>  <span class="main">(</span>length <span class="free">qs1</span><span class="main">)</span> "</span></span>
    <span class="keyword1"><span class="command">using</span></span> calculate_data_satisfies_properties_R
    <span class="keyword1"><span class="command">using</span></span> nontriv1 nonzero nonzero satisfies_properties_R_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> well_def_subsets1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">l</span> <span class="bound">i</span><span class="main">.</span> <span class="bound">l</span> <span class="main">∈</span> set <span class="main">(</span>get_subsets_R<span class="main">(</span>calculate_data_R <span class="free">p</span> <span class="free">qs1</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">(</span><span class="bound">i</span> <span class="main">∈</span> set <span class="main">(</span>fst <span class="bound">l</span><span class="main">)</span> <span class="main">⟶</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="main">(</span>length <span class="free">qs1</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">i</span> <span class="main">∈</span> set <span class="main">(</span>snd <span class="bound">l</span><span class="main">)</span> <span class="main">⟶</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="main">(</span>length <span class="free">qs1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> all_list_constr_R_def list_constr_def 
    <span class="keyword1"><span class="command">using</span></span> in_set_member
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> in_set_conv_nth list_all_length<span class="main">)</span> 
  <span class="keyword1"><span class="command">have</span></span> extra_matrix_same<span class="main">:</span> <span class="quoted"><span class="quoted">"matrix_A_R <span class="main">(</span>signs_smash <span class="main">(</span>get_signs_R <span class="main">(</span>calculate_data_R <span class="free">p</span> <span class="free">qs1</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>get_signs_R <span class="main">(</span>calculate_data_R <span class="free">p</span> <span class="free">qs2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
         <span class="main">(</span>subsets_smash_R <span class="main">(</span>length <span class="free">qs1</span><span class="main">)</span> <span class="main">(</span>get_subsets_R<span class="main">(</span>calculate_data_R <span class="free">p</span> <span class="free">qs1</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>get_subsets_R <span class="main">(</span>calculate_data_R <span class="free">p</span> <span class="free">qs2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> 
        <span class="main">=</span> kronecker_product <span class="main">(</span>get_matrix_R <span class="main">(</span>calculate_data_R <span class="free">p</span> <span class="free">qs1</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>get_matrix_R <span class="main">(</span>calculate_data_R <span class="free">p</span> <span class="free">qs2</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span>  well_def_signs1 well_def_subsets1
    <span class="keyword1"><span class="command">using</span></span> matrix_construction_is_kronecker_product_R
    <span class="keyword1"><span class="command">using</span></span> calculate_data_satisfies_properties_R nontriv1 nontriv2 nonzero  nonzero satisfies_properties_R_def 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> matrix_same<span class="main">:</span> <span class="quoted"><span class="quoted">"matrix_A_R <span class="var">?signs</span> <span class="var">?subsets</span> <span class="main">=</span> kronecker_product <span class="main">(</span>get_matrix_R <span class="main">(</span>calculate_data_R <span class="free">p</span> <span class="free">qs1</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>get_matrix_R <span class="main">(</span>calculate_data_R <span class="free">p</span> <span class="free">qs2</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> clear_signs clear_subsets
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> comb_sys_h<span class="main">:</span> <span class="quoted"><span class="quoted">"snd<span class="main">(</span>snd<span class="main">(</span>reduce_system_R <span class="free">p</span> <span class="main">(</span>combine_systems_R <span class="free">p</span> <span class="main">(</span><span class="free">qs1</span><span class="main">,</span>calculate_data_R <span class="free">p</span> <span class="free">qs1</span><span class="main">)</span> <span class="main">(</span><span class="free">qs2</span><span class="main">,</span>calculate_data_R <span class="free">p</span> <span class="free">qs2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
      snd<span class="main">(</span>snd<span class="main">(</span>reduce_system_R <span class="free">p</span> <span class="main">(</span><span class="free">qs1</span><span class="main">@</span><span class="free">qs2</span><span class="main">,</span> <span class="main">(</span>matrix_A_R <span class="var">?signs</span> <span class="var">?subsets</span><span class="main">,</span> <span class="main">(</span><span class="var">?subsets</span><span class="main">,</span> <span class="var">?signs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> get_signs_R_def get_subsets_R_def <span class="keyword1"><span class="command">using</span></span> matrix_same
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> clear_signs clear_subsets combine_systems_R.simps get_signs_R_def get_subsets_R_def getter_functions_R smash_systems_R_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> extra_h<span class="main">:</span> <span class="quoted"><span class="quoted">" snd<span class="main">(</span>snd<span class="main">(</span>reduce_system_R <span class="free">p</span> <span class="main">(</span><span class="free">qs1</span><span class="main">@</span><span class="free">qs2</span><span class="main">,</span> <span class="main">(</span>matrix_A_R <span class="var">?signs</span> <span class="var">?subsets</span><span class="main">,</span> <span class="main">(</span><span class="var">?subsets</span><span class="main">,</span> <span class="var">?signs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
      snd<span class="main">(</span>snd<span class="main">(</span>reduction_step_R <span class="main">(</span>matrix_A_R <span class="var">?signs</span> <span class="var">?subsets</span><span class="main">)</span> <span class="var">?signs</span> <span class="var">?subsets</span> <span class="main">(</span>solve_for_lhs_R <span class="free">p</span> <span class="main">(</span><span class="free">qs1</span><span class="main">@</span><span class="free">qs2</span><span class="main">)</span> <span class="var">?subsets</span> <span class="main">(</span>matrix_A_R <span class="var">?signs</span> <span class="var">?subsets</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> "</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> same_h<span class="main">:</span> <span class="quoted"><span class="quoted">"set<span class="main">(</span>snd<span class="main">(</span>snd<span class="main">(</span>reduce_system_R <span class="free">p</span> <span class="main">(</span>combine_systems_R <span class="free">p</span> <span class="main">(</span><span class="free">qs1</span><span class="main">,</span>calculate_data_R <span class="free">p</span> <span class="free">qs1</span><span class="main">)</span> <span class="main">(</span><span class="free">qs2</span><span class="main">,</span>calculate_data_R <span class="free">p</span> <span class="free">qs2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> 
      <span class="main">=</span> set <span class="main">(</span>reduction_signs_R <span class="free">p</span> <span class="main">(</span><span class="free">qs1</span><span class="main">@</span><span class="free">qs2</span><span class="main">)</span> <span class="var">?signs</span> <span class="var">?subsets</span>  <span class="main">(</span>matrix_A_R <span class="var">?signs</span> <span class="var">?subsets</span> <span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> comb_sys_h <span class="keyword1"><span class="command">unfolding</span></span> reduction_signs_R_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> get_signs_R_def help_h reduction_signs_is_get_signs_R<span class="main">)</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> h
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Renegar_Proofs-find_consistent_signs_at_roots_1_R"><span class="command">lemma</span></span> find_consistent_signs_at_roots_1_R<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">p</span><span class="main">::</span> <span class="quoted"><span class="quoted">"real poly"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">qs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real poly list"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">p</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">∧</span> length <span class="free">qs</span> <span class="main">&gt;</span> <span class="main">0</span><span class="main">)</span> <span class="main">⟶</span> 
    set<span class="main">(</span>find_consistent_signs_at_roots_R <span class="free">p</span> <span class="free">qs</span><span class="main">)</span> <span class="main">=</span> set<span class="main">(</span>characterize_consistent_signs_at_roots <span class="free">p</span> <span class="free">qs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="quoted">"length <span class="free">qs</span>"</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">qs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> less_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> less 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">clarsimp</span>
    <span class="keyword3"><span class="command">assume</span></span> ind_hyp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">qsa</span><span class="main">.</span>
        length <span class="bound">qsa</span> <span class="main">&lt;</span> length <span class="skolem">qs</span> <span class="main">⟹</span> <span class="bound">qsa</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">⟶</span>
        set <span class="main">(</span>find_consistent_signs_at_roots_R <span class="free">p</span> <span class="bound">qsa</span><span class="main">)</span> <span class="main">=</span>
        set <span class="main">(</span>characterize_consistent_signs_at_roots <span class="free">p</span> <span class="bound">qsa</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> nonzero<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>  
    <span class="keyword3"><span class="command">assume</span></span> nontriv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">qs</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?len</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"length <span class="skolem">qs</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?q1</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"take <span class="main">(</span><span class="main">(</span><span class="var">?len</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="skolem">qs</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?left</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"calculate_data_R <span class="free">p</span> <span class="var">?q1</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?q2</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"drop <span class="main">(</span><span class="main">(</span><span class="var">?len</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="skolem">qs</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?right</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"calculate_data_R <span class="free">p</span> <span class="var">?q2</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> nontriv_q1<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="skolem">qs</span><span class="main">&gt;</span><span class="main">1</span> <span class="main">⟶</span> length <span class="var">?q1</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> qs_more_q1<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="skolem">qs</span><span class="main">&gt;</span><span class="main">1</span> <span class="main">⟶</span> length <span class="skolem">qs</span> <span class="main">&gt;</span> length <span class="var">?q1</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> nontriv_q2<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="skolem">qs</span><span class="main">&gt;</span><span class="main">1</span> <span class="main">⟶</span>length <span class="var">?q2</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> qs_more_q2<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="skolem">qs</span><span class="main">&gt;</span><span class="main">1</span> <span class="main">⟶</span> length <span class="skolem">qs</span> <span class="main">&gt;</span> length <span class="var">?q2</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> key_h<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>snd <span class="main">(</span>snd <span class="main">(</span><span class="keyword1">if</span> <span class="var">?len</span> <span class="main">≤</span> Suc <span class="main">0</span> <span class="keyword1">then</span> reduce_system_R <span class="free">p</span> <span class="main">(</span><span class="skolem">qs</span><span class="main">,</span> base_case_info_R<span class="main">)</span>
                        <span class="keyword1">else</span>   Let <span class="main">(</span>combine_systems_R <span class="free">p</span> <span class="main">(</span><span class="var">?q1</span><span class="main">,</span> <span class="var">?left</span><span class="main">)</span> <span class="main">(</span><span class="var">?q2</span><span class="main">,</span> <span class="var">?right</span><span class="main">)</span><span class="main">)</span>
                                  <span class="main">(</span>reduce_system_R <span class="free">p</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
       set <span class="main">(</span>characterize_consistent_signs_at_roots <span class="free">p</span> <span class="skolem">qs</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
      <span class="keyword1"><span class="command">have</span></span> h_len1 <span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?len</span> <span class="main">=</span> <span class="main">1</span> <span class="main">⟶</span> set <span class="main">(</span>snd <span class="main">(</span>snd <span class="main">(</span><span class="keyword1">if</span> <span class="var">?len</span> <span class="main">≤</span> Suc <span class="main">0</span> <span class="keyword1">then</span> reduce_system_R <span class="free">p</span> <span class="main">(</span><span class="skolem">qs</span><span class="main">,</span> base_case_info_R<span class="main">)</span>
                        <span class="keyword1">else</span>   Let <span class="main">(</span>combine_systems_R <span class="free">p</span> <span class="main">(</span><span class="var">?q1</span><span class="main">,</span> <span class="var">?left</span><span class="main">)</span> <span class="main">(</span><span class="var">?q2</span><span class="main">,</span> <span class="var">?right</span><span class="main">)</span><span class="main">)</span>
                                  <span class="main">(</span>reduce_system_R <span class="free">p</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
       set <span class="main">(</span>characterize_consistent_signs_at_roots <span class="free">p</span> <span class="skolem">qs</span><span class="main">)</span>"</span></span> 
        <span class="keyword1"><span class="command">using</span></span> find_consistent_signs_at_roots_len1_R<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">p</span></span> <span class="quoted"><span class="skolem">qs</span></span><span class="main">]</span> nonzero nontriv
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> find_consistent_signs_at_roots_thm_R<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> h_len_gt1 <span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?len</span> <span class="main">&gt;</span> <span class="main">1</span> <span class="main">⟶</span> set <span class="main">(</span>snd <span class="main">(</span>snd <span class="main">(</span><span class="keyword1">if</span> <span class="var">?len</span> <span class="main">≤</span> Suc <span class="main">0</span> <span class="keyword1">then</span> reduce_system_R <span class="free">p</span> <span class="main">(</span><span class="skolem">qs</span><span class="main">,</span> base_case_info_R<span class="main">)</span>
                        <span class="keyword1">else</span>   Let <span class="main">(</span>combine_systems_R <span class="free">p</span> <span class="main">(</span><span class="var">?q1</span><span class="main">,</span> <span class="var">?left</span><span class="main">)</span> <span class="main">(</span><span class="var">?q2</span><span class="main">,</span> <span class="var">?right</span><span class="main">)</span><span class="main">)</span>
                                  <span class="main">(</span>reduce_system_R <span class="free">p</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
       set <span class="main">(</span>characterize_consistent_signs_at_roots <span class="free">p</span> <span class="skolem">qs</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
        <span class="keyword1"><span class="command">have</span></span> h_imp_a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?len</span> <span class="main">&gt;</span> <span class="main">1</span> <span class="main">⟶</span> set <span class="main">(</span>snd <span class="main">(</span>snd <span class="main">(</span>reduce_system_R <span class="free">p</span> <span class="main">(</span>combine_systems_R <span class="free">p</span> <span class="main">(</span><span class="var">?q1</span><span class="main">,</span> <span class="var">?left</span><span class="main">)</span> <span class="main">(</span><span class="var">?q2</span><span class="main">,</span> <span class="var">?right</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
              set <span class="main">(</span>characterize_consistent_signs_at_roots <span class="free">p</span> <span class="skolem">qs</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
          <span class="keyword1"><span class="command">have</span></span> h1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?len</span> <span class="main">&gt;</span> <span class="main">1</span> <span class="main">⟶</span> set<span class="main">(</span>snd<span class="main">(</span>snd<span class="main">(</span><span class="var">?left</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> set <span class="main">(</span>characterize_consistent_signs_at_roots <span class="free">p</span> <span class="var">?q1</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> nontriv_q1 ind_hyp<span class="main">[</span><span class="operator">of</span> <span class="var"><span class="quoted"><span class="var">?q1</span></span></span><span class="main">]</span> qs_more_q1             
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> find_consistent_signs_at_roots_thm_R less_numeral_extra<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> list.size<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command">have</span></span> h2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?len</span> <span class="main">&gt;</span> <span class="main">1</span> <span class="main">⟶</span> set<span class="main">(</span>snd<span class="main">(</span>snd<span class="main">(</span><span class="var">?right</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> set <span class="main">(</span>characterize_consistent_signs_at_roots <span class="free">p</span> <span class="var">?q2</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> nontriv_q2 ind_hyp<span class="main">[</span><span class="operator">of</span> <span class="var"><span class="quoted"><span class="var">?q2</span></span></span><span class="main">]</span> qs_more_q2
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> find_consistent_signs_at_roots_thm_R list.size<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> not_less_zero<span class="main">)</span>
          <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> nonzero nontriv_q1 nontriv_q2 h1 h2 smaller_sys_are_good_R             
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> append_take_drop_id find_consistent_signs_at_roots_thm_R<span class="main">)</span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> h_imp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?len</span> <span class="main">&gt;</span> <span class="main">1</span> <span class="main">⟶</span> set <span class="main">(</span>snd <span class="main">(</span>snd <span class="main">(</span>Let <span class="main">(</span>combine_systems_R <span class="free">p</span> <span class="main">(</span><span class="var">?q1</span><span class="main">,</span> <span class="var">?left</span><span class="main">)</span> <span class="main">(</span><span class="var">?q2</span><span class="main">,</span> <span class="var">?right</span><span class="main">)</span><span class="main">)</span>
                                  <span class="main">(</span>reduce_system_R <span class="free">p</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
       set <span class="main">(</span>characterize_consistent_signs_at_roots <span class="free">p</span> <span class="skolem">qs</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> h_len1 h_len_gt1
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> <span class="quoted"><span class="quoted">‹<span class="skolem">qs</span> <span class="main">≠</span> <span class="main">[]</span>›</span></span> length_0_conv less_one nat_neq_iff<span class="main">)</span> 
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>find_consistent_signs_at_roots_R <span class="free">p</span> <span class="skolem">qs</span><span class="main">)</span> <span class="main">=</span> set <span class="main">(</span>characterize_consistent_signs_at_roots <span class="free">p</span> <span class="skolem">qs</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> One_nat_def calculate_data.simps find_consistent_signs_at_roots_thm length_0_conv nontriv
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> <span class="main"><span class="main">(</span></span>z3<span class="main"><span class="main">)</span></span> calculate_data_R.simps find_consistent_signs_at_roots_thm_R<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Renegar_Proofs-find_consistent_signs_at_roots_0_R"><span class="command">lemma</span></span> find_consistent_signs_at_roots_0_R<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">p</span><span class="main">::</span> <span class="quoted"><span class="quoted">"real poly"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"set<span class="main">(</span>find_consistent_signs_at_roots_R <span class="free">p</span> <span class="main">[]</span><span class="main">)</span> <span class="main">=</span>
         set<span class="main">(</span>characterize_consistent_signs_at_roots <span class="free">p</span> <span class="main">[]</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="skolem"><span class="skolem">b</span></span> <span class="skolem"><span class="skolem">c</span></span> <span class="keyword2"><span class="keyword">where</span></span> abc<span class="main">:</span> <span class="quoted"><span class="quoted">"reduce_system_R <span class="free">p</span> <span class="main">(</span><span class="main">[</span><span class="main">1</span><span class="main">]</span><span class="main">,</span> base_case_info_R<span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">a</span><span class="main">,</span><span class="skolem">b</span><span class="main">,</span><span class="skolem">c</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> prod_cases3 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"find_consistent_signs_at_roots_R <span class="free">p</span> <span class="main">[</span><span class="main">1</span><span class="main">]</span> <span class="main">=</span> <span class="skolem">c</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> abc
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> find_consistent_signs_at_roots_thm_R<span class="main">)</span> 
  <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>find_consistent_signs_at_roots_R <span class="free">p</span> <span class="main">[</span><span class="main">1</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> set <span class="main">(</span>characterize_consistent_signs_at_roots <span class="free">p</span> <span class="main">[</span><span class="main">1</span><span class="main">]</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> find_consistent_signs_at_roots_1_R<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set<span class="main">(</span>characterize_consistent_signs_at_roots <span class="free">p</span> <span class="main">[]</span><span class="main">)</span> <span class="main">=</span> drop <span class="main">1</span> <span class="main">`</span> set<span class="main">(</span>characterize_consistent_signs_at_roots <span class="free">p</span> <span class="main">[</span><span class="main">1</span><span class="main">]</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> characterize_consistent_signs_at_roots_def consistent_sign_vec_def signs_at_def squash_def <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">using</span></span> drop0 drop_Suc_Cons image_cong image_image 
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">r</span><span class="main">.</span> <span class="main">[]</span><span class="main">)</span> <span class="main">`</span> set <span class="main">(</span>characterize_root_list_p <span class="free">p</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">r</span><span class="main">.</span> drop <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span> <span class="main">[</span><span class="main">1</span><span class="main">::</span>rat<span class="main">]</span><span class="main">)</span> <span class="main">`</span> set <span class="main">(</span>characterize_root_list_p <span class="free">p</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">r</span><span class="main">.</span> <span class="main">[]</span><span class="main">)</span> <span class="main">`</span> set <span class="main">(</span>characterize_root_list_p <span class="free">p</span><span class="main">)</span> <span class="main">=</span> drop <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span> <span class="main">`</span> <span class="main">(</span><span class="main">λ</span><span class="bound">r</span><span class="main">.</span> <span class="main">[</span><span class="main">1</span><span class="main">::</span>rat<span class="main">]</span><span class="main">)</span> <span class="main">`</span> set <span class="main">(</span>characterize_root_list_p <span class="free">p</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span> 
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> abc *
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> find_consistent_signs_at_roots_thm_R<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> find_consistent_signs_at_roots_thm_R<span class="main">)</span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Renegar_Proofs-find_consistent_signs_at_roots_R"><span class="command">lemma</span></span> find_consistent_signs_at_roots_R<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">p</span><span class="main">::</span> <span class="quoted"><span class="quoted">"real poly"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">qs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real poly list"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"set<span class="main">(</span>find_consistent_signs_at_roots_R <span class="free">p</span> <span class="free">qs</span><span class="main">)</span> <span class="main">=</span> set<span class="main">(</span>characterize_consistent_signs_at_roots <span class="free">p</span> <span class="free">qs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms find_consistent_signs_at_roots_0_R find_consistent_signs_at_roots_1_R length_greater_0_conv<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="Renegar_Decision">
<div class="head">
<h1>Theory Renegar_Decision</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> Renegar_Decision
  <span class="keyword2"><span class="keyword">imports</span></span> <span class="quoted">"<a href="#Renegar_Proofs">Renegar_Proofs</a>"</span>
    <span class="quoted">"<a href="#BKR_Decision">BKR_Decision</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="comment1">(* Note that there is significant overlap between Renegar and BKR in general, so there is some
  similarity between this file and BKR_Decision.thy.  However, there are also notable differences
  as Renegar and BKR use different auxiliary polynomials in their decision procedures.

  In general, the _R's on definition and lemma names in this file are to emphasize that we are 
  working with Renegar style.

*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">"Algorithm"</span></span>

<span class="comment1">(* The set of all rational sign vectors for qs wrt the set S
  When S = UNIV, then this quantifies over all reals *)</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">consistent_sign_vectors_R</span><span class="main">::</span><span class="quoted"><span class="quoted">"real poly list <span class="main">⇒</span> real set <span class="main">⇒</span> rat list set"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">consistent_sign_vectors_R</span> <span class="free"><span class="bound"><span class="entity">qs</span></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">=</span> <span class="main">(</span>consistent_sign_vec <span class="free"><span class="bound"><span class="entity">qs</span></span></span><span class="main">)</span> <span class="main">`</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span>"</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">prod_list_var</span><span class="main">::</span> <span class="quoted"><span class="quoted">"real poly list <span class="main">⇒</span> real poly"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">prod_list_var</span>  <span class="main">[]</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">prod_list_var</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="main">(</span><span class="free">prod_list_var</span> <span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main">)</span> <span class="keyword1">else</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">*</span> <span class="free">prod_list_var</span> <span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">check_all_const_deg</span><span class="main">::</span> <span class="quoted"><span class="quoted">"real poly list <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">check_all_const_deg</span>  <span class="main">[]</span> <span class="main">=</span> True"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">check_all_const_deg</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> degree <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="main">(</span><span class="free">check_all_const_deg</span> <span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main">)</span> <span class="keyword1">else</span> False<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">poly_f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real poly list <span class="main">⇒</span> real poly"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">poly_f</span> <span class="free"><span class="bound"><span class="entity">ps</span></span></span> <span class="main">=</span> 
  <span class="main">(</span><span class="keyword1">if</span> <span class="main">(</span>check_all_const_deg <span class="free"><span class="bound"><span class="entity">ps</span></span></span> <span class="main">=</span> True<span class="main">)</span> <span class="keyword1">then</span>  <span class="main">[:</span><span class="main">0</span><span class="main">,</span> <span class="main">1</span><span class="main">:]</span> <span class="keyword1">else</span> 
  <span class="main">(</span>pderiv <span class="main">(</span>prod_list_var <span class="free"><span class="bound"><span class="entity">ps</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span>prod_list_var <span class="free"><span class="bound"><span class="entity">ps</span></span></span><span class="main">)</span><span class="main">*</span> <span class="main">(</span><span class="main">[:</span><span class="main">-</span><span class="main">(</span>crb <span class="main">(</span>prod_list_var <span class="free"><span class="bound"><span class="entity">ps</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">,</span><span class="main">1</span><span class="main">:]</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">[:</span><span class="main">(</span>crb <span class="main">(</span>prod_list_var <span class="free"><span class="bound"><span class="entity">ps</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">,</span><span class="main">1</span><span class="main">:]</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">find_consistent_signs_R</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real poly list <span class="main">⇒</span> rat list list"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">find_consistent_signs_R</span> <span class="free"><span class="bound"><span class="entity">ps</span></span></span> <span class="main">=</span> find_consistent_signs_at_roots_R <span class="main">(</span>poly_f <span class="free"><span class="bound"><span class="entity">ps</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ps</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">decide_universal_R</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real poly fml <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="free">decide_universal_R</span> <span class="free"><span class="bound"><span class="entity">fml</span></span></span> <span class="main">=</span> <span class="main">(</span>
    <span class="keyword1">let</span> <span class="main">(</span><span class="bound">fml_struct</span><span class="main">,</span><span class="bound">polys</span><span class="main">)</span> <span class="main">=</span> convert <span class="free"><span class="bound"><span class="entity">fml</span></span></span><span class="main">;</span>
        <span class="bound">conds</span> <span class="main">=</span> find_consistent_signs_R <span class="bound">polys</span>
    <span class="keyword1">in</span>
     list_all <span class="main">(</span>lookup_sem <span class="bound">fml_struct</span><span class="main">)</span> <span class="bound">conds</span>
  <span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">decide_existential_R</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real poly fml <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="free">decide_existential_R</span> <span class="free"><span class="bound"><span class="entity">fml</span></span></span> <span class="main">=</span> <span class="main">(</span>
    <span class="keyword1">let</span> <span class="main">(</span><span class="bound">fml_struct</span><span class="main">,</span><span class="bound">polys</span><span class="main">)</span> <span class="main">=</span> convert <span class="free"><span class="bound"><span class="entity">fml</span></span></span><span class="main">;</span>
        <span class="bound">conds</span> <span class="main">=</span> find_consistent_signs_R <span class="bound">polys</span>
    <span class="keyword1">in</span>
      find <span class="main">(</span>lookup_sem <span class="bound">fml_struct</span><span class="main">)</span> <span class="bound">conds</span> <span class="main">≠</span> None
  <span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Proofs"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">roots_of_poly_f</span><span class="main">::</span> <span class="quoted"><span class="quoted">"real poly list <span class="main">⇒</span> real set"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">roots_of_poly_f</span> <span class="free"><span class="bound"><span class="entity">qs</span></span></span> <span class="main">=</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="main">(</span>poly_f <span class="free"><span class="bound"><span class="entity">qs</span></span></span><span class="main">)</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span>"</span></span>

<span class="keyword1" id="Renegar_Decision-prod_list_var_nonzero"><span class="command">lemma</span></span> prod_list_var_nonzero<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"prod_list_var <span class="free">qs</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">qs</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">qs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Renegar_Decision-q_dvd_prod_list_var_prop"><span class="command">lemma</span></span> q_dvd_prod_list_var_prop<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">∈</span> set <span class="free">qs</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="keyword1">dvd</span> prod_list_var <span class="free">qs</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">qs</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">qs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> eo<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">=</span> <span class="skolem">a</span> <span class="main">∨</span><span class="free">q</span> <span class="main">∈</span> set <span class="skolem">qs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> c1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">=</span> <span class="skolem">a</span> <span class="main">⟹</span> <span class="free">q</span> <span class="keyword1">dvd</span> prod_list_var <span class="main">(</span><span class="skolem">a</span><span class="main">#</span><span class="skolem">qs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">=</span> <span class="skolem">a</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"prod_list_var <span class="main">(</span><span class="skolem">a</span><span class="main">#</span><span class="skolem">qs</span><span class="main">)</span> <span class="main">=</span> <span class="free">q</span><span class="main">*</span><span class="main">(</span>prod_list_var <span class="skolem">qs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Cons.prems
      <span class="keyword1"><span class="command">unfolding</span></span> prod_list_var_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> prod_list_var_nonzero<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">qs</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">have</span></span> c2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">∈</span> set <span class="skolem">qs</span> <span class="main">⟶</span> <span class="free">q</span> <span class="keyword1">dvd</span> prod_list_var <span class="skolem">qs</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Cons.prems Cons.hyps <span class="keyword1"><span class="command">unfolding</span></span> prod_list_var_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> eo c1 c2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1" id="Renegar_Decision-check_all_const_deg_prop"><span class="command">lemma</span></span> check_all_const_deg_prop<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"check_all_const_deg <span class="free">l</span> <span class="main">=</span> True <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">p</span> <span class="main">∈</span> set<span class="main">(</span><span class="free">l</span><span class="main">)</span><span class="main">.</span> degree <span class="bound">p</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">l</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">l</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(* lemma prod_zero shows that the product of the polynomial list is 0 at x iff there is a polynomial 
  in the list that is 0 at x *)</span>
<span class="keyword1" id="Renegar_Decision-poly_f_nonzero"><span class="command">lemma</span></span> poly_f_nonzero<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">qs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real poly list"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>poly_f <span class="free">qs</span><span class="main">)</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
  <span class="keyword1"><span class="command">have</span></span> eo<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">p</span> <span class="main">∈</span> set <span class="free">qs</span><span class="main">.</span> degree <span class="bound">p</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound">p</span> <span class="main">∈</span> set <span class="free">qs</span><span class="main">.</span> degree <span class="bound">p</span> <span class="main">&gt;</span> <span class="main">0</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> c1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">p</span> <span class="main">∈</span> set <span class="free">qs</span><span class="main">.</span> degree <span class="bound">p</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">(</span>poly_f <span class="free">qs</span><span class="main">)</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> poly_f_def <span class="keyword1"><span class="command">using</span></span> check_all_const_deg_prop <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> c2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound">p</span> <span class="main">∈</span> set <span class="free">qs</span><span class="main">.</span> degree <span class="bound">p</span> <span class="main">&gt;</span> <span class="main">0</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">(</span>poly_f <span class="free">qs</span><span class="main">)</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">clarsimp</span> 
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">q</span>
    <span class="keyword3"><span class="command">assume</span></span> q_in<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">∈</span> set <span class="free">qs</span>"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> deg_q<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> degree <span class="skolem">q</span>"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> contrad<span class="main">:</span> <span class="quoted"><span class="quoted">"poly_f <span class="free">qs</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> nonconst<span class="main">:</span> <span class="quoted"><span class="quoted">"check_all_const_deg <span class="free">qs</span> <span class="main">=</span> False"</span></span> <span class="keyword1"><span class="command">using</span></span> deg_q check_all_const_deg_prop
        q_in <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> h1<span class="main">:</span> <span class="quoted"><span class="quoted">"prod_list_var <span class="free">qs</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> prod_list_var_nonzero <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"degree <span class="main">(</span>prod_list_var <span class="free">qs</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> q_in deg_q h1
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">qs</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> Nil
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">qs</span><span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> q_nonz<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Cons.prems <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> q_ins<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">∈</span> set <span class="main">(</span><span class="skolem">a</span> <span class="main">#</span> <span class="skolem">qs</span><span class="main">)</span> "</span></span> <span class="keyword1"><span class="command">using</span></span> Cons.prems <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">=</span> <span class="skolem">a</span> <span class="main">∨</span> <span class="skolem">q</span> <span class="main">∈</span> set <span class="skolem">qs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> eo<span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="skolem">q</span> <span class="main">=</span> <span class="skolem">a</span> <span class="main">∨</span> List.member <span class="skolem">qs</span> <span class="skolem">q</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> in_set_member<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">q</span></span> <span class="quoted"><span class="skolem">qs</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> degq<span class="main">:</span> <span class="quoted"><span class="quoted">"degree <span class="skolem">q</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Cons.prems <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> h2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>prod_list <span class="main">(</span><span class="skolem">a</span> <span class="main">#</span> <span class="skolem">qs</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">a</span><span class="main">*</span> <span class="main">(</span>prod_list <span class="skolem">qs</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> isa<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">=</span> <span class="skolem">a</span> <span class="main">⟶</span> <span class="main">0</span> <span class="main">&lt;</span> degree <span class="main">(</span>prod_list_var <span class="main">(</span><span class="skolem">a</span> <span class="main">#</span> <span class="skolem">qs</span><span class="main">)</span><span class="main">)</span>"</span></span> 
        <span class="keyword1"><span class="command">using</span></span> h2 degree_mult_eq_0<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> p <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span>"</span></span><span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> q <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"prod_list_var <span class="skolem">qs</span>"</span></span><span class="main">]</span>
          Cons.prems <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> inl<span class="main">:</span> <span class="quoted"><span class="quoted">"List.member <span class="skolem">qs</span> <span class="skolem">q</span> <span class="main">⟶</span> <span class="main">0</span> <span class="main">&lt;</span> degree <span class="main">(</span>prod_list_var <span class="main">(</span><span class="skolem">a</span> <span class="main">#</span> <span class="skolem">qs</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
        <span class="keyword1"><span class="command">have</span></span> nonzprod<span class="main">:</span> <span class="quoted"><span class="quoted">"prod_list_var <span class="main">(</span><span class="skolem">a</span> <span class="main">#</span> <span class="skolem">qs</span><span class="main">)</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> prod_list_var_nonzero <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="keyword1">dvd</span> prod_list_var <span class="main">(</span><span class="skolem">a</span> <span class="main">#</span> <span class="skolem">qs</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> q_dvd_prod_list_var_prop<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> q <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span>"</span></span><span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> qs <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">a</span><span class="main">#</span><span class="skolem">qs</span><span class="main">)</span>"</span></span><span class="main">]</span> q_nonz q_ins
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> divides_degree<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> p <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span>"</span></span><span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> q <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"prod_list_var <span class="main">(</span><span class="skolem">a</span> <span class="main">#</span> <span class="skolem">qs</span><span class="main">)</span>"</span></span><span class="main">]</span> nonzprod degq
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> eo isa <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> h2<span class="main">:</span> <span class="quoted"><span class="quoted">"pderiv <span class="main">(</span>prod_list_var <span class="free">qs</span><span class="main">)</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> pderiv_eq_0_iff<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> p <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"prod_list_var <span class="free">qs</span>"</span></span><span class="main">]</span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"pderiv <span class="main">(</span>prod_list_var <span class="free">qs</span><span class="main">)</span> <span class="main">*</span> prod_list_var <span class="free">qs</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> prod_list_var_nonzero h2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"False"</span></span> <span class="keyword1"><span class="command">using</span></span> contrad nonconst <span class="keyword1"><span class="command">unfolding</span></span> poly_f_def deg_q
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> <span class="main"><span class="main">(</span></span>z3<span class="main"><span class="main">)</span></span> mult_eq_0_iff pCons_eq_0_iff<span class="main">)</span> 
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> eo c1 c2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Renegar_Decision-poly_f_roots_prop_1"><span class="command">lemma</span></span> poly_f_roots_prop_1<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">qs</span><span class="main">::</span> <span class="quoted"><span class="quoted">"real poly list"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> non_const<span class="main">:</span> <span class="quoted"><span class="quoted">"check_all_const_deg <span class="free">qs</span> <span class="main">=</span> False"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x1</span><span class="main">.</span> <span class="main">∀</span><span class="bound">x2</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="bound">x1</span> <span class="main">&lt;</span> <span class="bound">x2</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span><span class="bound">q1</span> <span class="main">∈</span> set <span class="main">(</span><span class="free">qs</span><span class="main">)</span><span class="main">.</span> <span class="bound">q1</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">∧</span> <span class="main">(</span>poly <span class="bound">q1</span> <span class="bound">x1</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span><span class="bound">q2</span><span class="main">∈</span> set<span class="main">(</span><span class="free">qs</span><span class="main">)</span><span class="main">.</span> <span class="bound">q2</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">∧</span> <span class="main">(</span>poly <span class="bound">q2</span> <span class="bound">x2</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">q</span><span class="main">.</span> <span class="bound">x1</span> <span class="main">&lt;</span> <span class="bound">q</span> <span class="main">∧</span> <span class="bound">q</span> <span class="main">&lt;</span> <span class="bound">x2</span> <span class="main">∧</span> poly <span class="main">(</span>poly_f <span class="free">qs</span><span class="main">)</span> <span class="bound">q</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">clarsimp</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x1</span><span class="main">::</span> <span class="quoted"><span class="quoted">"real"</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x2</span><span class="main">::</span> <span class="quoted"><span class="quoted">"real"</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">q1</span><span class="main">::</span> <span class="quoted"><span class="quoted">"real poly"</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">q2</span><span class="main">::</span> <span class="quoted"><span class="quoted">"real poly"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x1</span> <span class="main">&lt;</span> <span class="skolem">x2</span>"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> q1_in<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">q1</span> <span class="main">∈</span> set <span class="free">qs</span>"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> q1_0<span class="main">:</span> <span class="quoted"><span class="quoted">"poly <span class="skolem">q1</span> <span class="skolem">x1</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> q1_nonz<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">q1</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> q2_in<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">q2</span> <span class="main">∈</span> set <span class="free">qs</span>"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> q2_0<span class="main">:</span> <span class="quoted"><span class="quoted">"poly <span class="skolem">q2</span> <span class="skolem">x2</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> q2_nonz<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">q2</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> prod_z_x1<span class="main">:</span> <span class="quoted"><span class="quoted">"poly <span class="main">(</span>prod_list_var <span class="free">qs</span><span class="main">)</span> <span class="skolem">x1</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> q1_in q1_0
    <span class="keyword1"><span class="command">using</span></span> q1_nonz q_dvd_prod_list_var_prop<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">q1</span></span> <span class="quoted"><span class="free">qs</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> prod_z_x2<span class="main">:</span> <span class="quoted"><span class="quoted">"poly <span class="main">(</span>prod_list_var <span class="free">qs</span><span class="main">)</span> <span class="skolem">x2</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> q2_in q2_0 
    <span class="keyword1"><span class="command">using</span></span> q2_nonz q_dvd_prod_list_var_prop<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">q2</span></span> <span class="quoted"><span class="free">qs</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">w</span></span><span class="main">&gt;</span><span class="skolem">x1</span><span class="main">.</span> <span class="bound">w</span> <span class="main">&lt;</span> <span class="skolem">x2</span> <span class="main">∧</span> poly <span class="main">(</span>pderiv <span class="main">(</span>prod_list_var <span class="free">qs</span><span class="main">)</span><span class="main">)</span> <span class="bound">w</span> <span class="main">=</span> <span class="main">0</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> Rolle_pderiv<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> q <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"prod_list_var <span class="free">qs</span>"</span></span><span class="main">]</span> prod_z_x1 prod_z_x2
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x1</span> <span class="main">&lt;</span> <span class="skolem">x2</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">w</span></span> <span class="keyword2"><span class="keyword">where</span></span> w_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="main">&gt;</span> <span class="skolem">x1</span> <span class="main">∧</span><span class="skolem">w</span> <span class="main">&lt;</span> <span class="skolem">x2</span> <span class="main">∧</span> poly <span class="main">(</span>pderiv <span class="main">(</span>prod_list_var <span class="free">qs</span><span class="main">)</span><span class="main">)</span> <span class="skolem">w</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"poly <span class="main">(</span>poly_f <span class="free">qs</span><span class="main">)</span> <span class="skolem">w</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> poly_f_def <span class="keyword1"><span class="command">using</span></span> non_const
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">q</span></span><span class="main">&gt;</span><span class="skolem">x1</span><span class="main">.</span> <span class="bound">q</span> <span class="main">&lt;</span> <span class="skolem">x2</span> <span class="main">∧</span> poly <span class="main">(</span>poly_f <span class="free">qs</span><span class="main">)</span> <span class="bound">q</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> w_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
<span class="keyword1"><span class="command">qed</span></span> 

<span class="keyword1" id="Renegar_Decision-main_step_aux1_R"><span class="command">lemma</span></span> main_step_aux1_R<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">qs</span><span class="main">::</span> <span class="quoted"><span class="quoted">"real poly list"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> non_const<span class="main">:</span> <span class="quoted"><span class="quoted">"check_all_const_deg <span class="free">qs</span> <span class="main">=</span> True"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>find_consistent_signs_R <span class="free">qs</span><span class="main">)</span> <span class="main">=</span>  consistent_sign_vectors_R <span class="free">qs</span> UNIV"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
  <span class="keyword1"><span class="command">have</span></span> poly_f_is<span class="main">:</span> <span class="quoted"><span class="quoted">"poly_f <span class="free">qs</span> <span class="main">=</span> <span class="main">[:</span><span class="main">0</span><span class="main">,</span> <span class="main">1</span><span class="main">:]</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> poly_f_def <span class="keyword1"><span class="command">using</span></span> assms 

    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> same<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>find_consistent_signs_at_roots_R <span class="main">[:</span><span class="main">0</span><span class="main">,</span> <span class="main">1</span><span class="main">:]</span> <span class="free">qs</span><span class="main">)</span> <span class="main">=</span>
  set <span class="main">(</span>characterize_consistent_signs_at_roots <span class="main">[:</span><span class="main">0</span><span class="main">,</span> <span class="main">1</span><span class="main">:]</span> <span class="free">qs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> find_consistent_signs_at_roots_R<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">[:</span><span class="main">0</span><span class="main">,</span> <span class="main">1</span><span class="main">:]</span>"</span></span> <span class="quoted"><span class="free">qs</span></span><span class="main">]</span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
  <span class="keyword1"><span class="command">have</span></span> rech<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>sorted_list_of_set <span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="main">(</span><span class="main">[:</span><span class="main">0</span><span class="main">,</span> <span class="main">1</span><span class="main">:]</span><span class="main">::</span>real poly<span class="main">)</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> <span class="main">[</span><span class="main">0</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> alldeg0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">p</span> <span class="main">∈</span> set <span class="free">qs</span><span class="main">.</span> degree <span class="bound">p</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> non_const check_all_const_deg_prop
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> allconst<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span> <span class="main">∈</span> set <span class="free">qs</span><span class="main">.</span> <span class="main">(</span><span class="main">∃</span><span class="main">(</span><span class="bound">k</span><span class="main">::</span>real<span class="main">)</span><span class="main">.</span> <span class="bound">p</span> <span class="main">=</span> <span class="main">[:</span><span class="bound">k</span><span class="main">:]</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> degree_eq_zeroE<span class="main">)</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> allconstvar<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span> <span class="main">∈</span> set <span class="free">qs</span><span class="main">.</span> <span class="main">∀</span><span class="main">(</span><span class="bound">x</span><span class="main">::</span>real<span class="main">)</span><span class="main">.</span> <span class="main">∀</span><span class="main">(</span><span class="bound">y</span><span class="main">::</span>real<span class="main">)</span><span class="main">.</span> poly <span class="bound">p</span> <span class="bound">x</span> <span class="main">=</span> poly <span class="bound">p</span> <span class="bound">y</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">have</span></span> e1<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>remdups <span class="main">(</span>map <span class="main">(</span>signs_at <span class="free">qs</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span>
    consistent_sign_vectors_R <span class="free">qs</span> UNIV"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> signs_at_def squash_def consistent_sign_vectors_R_def consistent_sign_vec_def <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> <span class="main"><span class="main">(</span></span>verit<span class="main"><span class="main">,</span></span> best<span class="main"><span class="main">)</span></span> class_ring.ring_simprules<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> comp_def image_iff length_map map_nth_eq_conv<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> e2<span class="main">:</span> <span class="quoted"><span class="quoted">"consistent_sign_vectors_R <span class="free">qs</span> UNIV <span class="main">⊆</span> set <span class="main">(</span>remdups <span class="main">(</span>map <span class="main">(</span>signs_at <span class="free">qs</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> "</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> signs_at_def squash_def consistent_sign_vectors_R_def consistent_sign_vec_def <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> allconstvar
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> <span class="main"><span class="main">(</span></span>verit<span class="main"><span class="main">,</span></span> best<span class="main"><span class="main">)</span></span> comp_apply image_iff insert_iff map_eq_conv subsetI<span class="main">)</span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>remdups <span class="main">(</span>map <span class="main">(</span>signs_at <span class="free">qs</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
    consistent_sign_vectors_R <span class="free">qs</span> UNIV"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> e1 e2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>characterize_consistent_signs_at_roots <span class="main">[:</span><span class="main">0</span><span class="main">,</span> <span class="main">1</span><span class="main">:]</span> <span class="free">qs</span><span class="main">)</span> <span class="main">=</span> consistent_sign_vectors_R <span class="free">qs</span> UNIV"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> characterize_consistent_signs_at_roots_def characterize_root_list_p_def 
    <span class="keyword1"><span class="command">using</span></span> rech <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> same poly_f_is <span class="keyword1"><span class="command">unfolding</span></span> find_consistent_signs_R_def 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Renegar_Decision-sorted_list_lemma_var"><span class="command">lemma</span></span> sorted_list_lemma_var<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">l</span><span class="main">::</span> <span class="quoted"><span class="quoted">"real list"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">x</span><span class="main">::</span> <span class="quoted"><span class="quoted">"real"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"length <span class="free">l</span> <span class="main">&gt;</span> <span class="main">1</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> strict_sort<span class="main">:</span> <span class="quoted"><span class="quoted">"strict_sorted <span class="free">l</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> x_not_in<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span>List.member <span class="free">l</span> <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> lt_a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">&gt;</span> <span class="main">(</span><span class="free">l</span> <span class="main">!</span> <span class="main">0</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> b_lt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">&lt;</span> <span class="main">(</span><span class="free">l</span> <span class="main">!</span> <span class="main">(</span>length <span class="free">l</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">&lt;</span> length <span class="free">l</span> <span class="main">-</span> <span class="main">1</span> <span class="main">∧</span> <span class="free">x</span> <span class="main">&gt;</span> <span class="free">l</span> <span class="main">!</span> <span class="bound">n</span> <span class="main">∧</span> <span class="free">x</span> <span class="main">&lt;</span> <span class="free">l</span> <span class="main">!</span><span class="main">(</span><span class="bound">n</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms 
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">l</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">l</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> len_gteq<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="skolem">l</span> <span class="main">≥</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Cons.prems<span class="main">(</span>1<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> One_nat_def Suc_eq_plus1 list.size<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> not_le not_less_eq<span class="main">)</span> 
  <span class="keyword1"><span class="command">have</span></span> len_one<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="skolem">l</span> <span class="main">=</span> <span class="main">1</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">∃</span><span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">&lt;</span> length <span class="main">(</span><span class="skolem">a</span><span class="main">#</span><span class="skolem">l</span><span class="main">)</span> <span class="main">-</span> <span class="main">1</span> <span class="main">∧</span> <span class="free">x</span> <span class="main">&gt;</span> <span class="main">(</span><span class="skolem">a</span><span class="main">#</span><span class="skolem">l</span><span class="main">)</span> <span class="main">!</span> <span class="bound">n</span> <span class="main">∧</span> <span class="free">x</span> <span class="main">&lt;</span> <span class="main">(</span><span class="skolem">a</span><span class="main">#</span><span class="skolem">l</span><span class="main">)</span> <span class="main">!</span><span class="main">(</span><span class="bound">n</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">assume</span></span> len_is<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="skolem">l</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">&gt;</span> <span class="main">(</span><span class="skolem">a</span><span class="main">#</span><span class="skolem">l</span><span class="main">)</span> <span class="main">!</span> <span class="main">0</span> <span class="main">∧</span> <span class="free">x</span> <span class="main">&lt;</span> <span class="main">(</span><span class="skolem">a</span><span class="main">#</span><span class="skolem">l</span><span class="main">)</span> <span class="main">!</span><span class="main">1</span> "</span></span> <span class="keyword1"><span class="command">using</span></span> Cons.prems<span class="main">(</span>4<span class="main">)</span> Cons.prems<span class="main">(</span>5<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">&lt;</span> length <span class="main">(</span><span class="skolem">a</span><span class="main">#</span><span class="skolem">l</span><span class="main">)</span> <span class="main">-</span> <span class="main">1</span> <span class="main">∧</span> <span class="free">x</span> <span class="main">&gt;</span> <span class="main">(</span><span class="skolem">a</span><span class="main">#</span><span class="skolem">l</span><span class="main">)</span> <span class="main">!</span> <span class="bound">n</span> <span class="main">∧</span> <span class="free">x</span> <span class="main">&lt;</span> <span class="main">(</span><span class="skolem">a</span><span class="main">#</span><span class="skolem">l</span><span class="main">)</span> <span class="main">!</span><span class="main">(</span><span class="bound">n</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>  
      <span class="keyword1"><span class="command">using</span></span> len_is <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">have</span></span> len_gt<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="skolem">l</span> <span class="main">&gt;</span> <span class="main">1</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">∃</span><span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">&lt;</span> length <span class="main">(</span><span class="skolem">a</span><span class="main">#</span><span class="skolem">l</span><span class="main">)</span> <span class="main">-</span> <span class="main">1</span> <span class="main">∧</span> <span class="free">x</span> <span class="main">&gt;</span> <span class="main">(</span><span class="skolem">a</span><span class="main">#</span><span class="skolem">l</span><span class="main">)</span> <span class="main">!</span> <span class="bound">n</span> <span class="main">∧</span> <span class="free">x</span> <span class="main">&lt;</span> <span class="main">(</span><span class="skolem">a</span><span class="main">#</span><span class="skolem">l</span><span class="main">)</span> <span class="main">!</span><span class="main">(</span><span class="bound">n</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
    <span class="keyword3"><span class="command">assume</span></span> len_gt_one<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="skolem">l</span> <span class="main">&gt;</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> eo<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≠</span> <span class="skolem">l</span> <span class="main">!</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Cons.prems<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> One_nat_def Suc_lessD in_set_member len_gt_one member_rec<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> nth_mem<span class="main">)</span> 
    <span class="keyword1"><span class="command">have</span></span> c1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">&lt;</span> <span class="skolem">l</span> <span class="main">!</span> <span class="main">0</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">∃</span><span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">&lt;</span> length <span class="main">(</span><span class="skolem">a</span><span class="main">#</span><span class="skolem">l</span><span class="main">)</span> <span class="main">-</span> <span class="main">1</span> <span class="main">∧</span> <span class="free">x</span> <span class="main">&gt;</span> <span class="main">(</span><span class="skolem">a</span><span class="main">#</span><span class="skolem">l</span><span class="main">)</span> <span class="main">!</span> <span class="bound">n</span> <span class="main">∧</span> <span class="free">x</span> <span class="main">&lt;</span> <span class="main">(</span><span class="skolem">a</span><span class="main">#</span><span class="skolem">l</span><span class="main">)</span> <span class="main">!</span><span class="main">(</span><span class="bound">n</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> "</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
      <span class="keyword3"><span class="command">assume</span></span> xlt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">&lt;</span> <span class="skolem">l</span> <span class="main">!</span><span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">&lt;</span> <span class="main">(</span><span class="skolem">a</span><span class="main">#</span><span class="skolem">l</span><span class="main">)</span> <span class="main">!</span> <span class="main">1</span> "</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>  <span class="keyword1"><span class="command">using</span></span>  Cons.prems<span class="main">(</span>4<span class="main">)</span> len_gt_one <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
        <span class="keyword1"><span class="command">using</span></span> Cons.prems<span class="main">(</span>4<span class="main">)</span> Suc_lessD <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">have</span></span> c2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">&gt;</span> <span class="skolem">l</span> <span class="main">!</span> <span class="main">0</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">∃</span><span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">&lt;</span> length <span class="main">(</span><span class="skolem">a</span><span class="main">#</span><span class="skolem">l</span><span class="main">)</span> <span class="main">-</span> <span class="main">1</span> <span class="main">∧</span> <span class="free">x</span> <span class="main">&gt;</span> <span class="main">(</span><span class="skolem">a</span><span class="main">#</span><span class="skolem">l</span><span class="main">)</span> <span class="main">!</span> <span class="bound">n</span> <span class="main">∧</span> <span class="free">x</span> <span class="main">&lt;</span> <span class="main">(</span><span class="skolem">a</span><span class="main">#</span><span class="skolem">l</span><span class="main">)</span> <span class="main">!</span><span class="main">(</span><span class="bound">n</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> "</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
      <span class="keyword3"><span class="command">assume</span></span> asm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">&gt;</span> <span class="skolem">l</span> <span class="main">!</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> xlt_1<span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="free">x</span> <span class="main">&lt;</span> <span class="skolem">l</span> <span class="main">!</span> <span class="main">(</span>length <span class="skolem">l</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> Cons.prems<span class="main">(</span>5<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Cons.prems<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> One_nat_def add_diff_cancel_right' list.size<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> nth_Cons_pos zero_less_diff<span class="main">)</span> 
      <span class="keyword1"><span class="command">have</span></span> ssl<span class="main">:</span> <span class="quoted"><span class="quoted">"strict_sorted <span class="skolem">l</span> "</span></span> <span class="keyword1"><span class="command">using</span></span> Cons.prems<span class="main">(</span>2<span class="main">)</span>
        <span class="keyword1"><span class="command">using</span></span> strict_sorted.simps<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>  
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">" <span class="main">¬</span> List.member <span class="skolem">l</span> <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Cons.prems<span class="main">(</span>3<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> member_rec<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span> 
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">" <span class="main">∃</span><span class="bound"><span class="bound">n</span></span><span class="main">&lt;</span>length <span class="skolem">l</span> <span class="main">-</span> <span class="main">1</span><span class="main">.</span> <span class="skolem">l</span> <span class="main">!</span> <span class="bound">n</span> <span class="main">&lt;</span> <span class="free">x</span> <span class="main">∧</span> <span class="free">x</span> <span class="main">&lt;</span> <span class="skolem">l</span> <span class="main">!</span> <span class="main">(</span><span class="bound">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> asm xlt_1 len_gt_one ssl Cons.hyps 
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> One_nat_def Suc_eq_plus1 diff_Suc_1 less_diff_conv list.size<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> nth_Cons_Suc<span class="main">)</span> 
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">&lt;</span> length <span class="main">(</span><span class="skolem">a</span><span class="main">#</span><span class="skolem">l</span><span class="main">)</span> <span class="main">-</span> <span class="main">1</span> <span class="main">∧</span> <span class="free">x</span> <span class="main">&gt;</span> <span class="main">(</span><span class="skolem">a</span><span class="main">#</span><span class="skolem">l</span><span class="main">)</span> <span class="main">!</span> <span class="bound">n</span> <span class="main">∧</span> <span class="free">x</span> <span class="main">&lt;</span> <span class="main">(</span><span class="skolem">a</span><span class="main">#</span><span class="skolem">l</span><span class="main">)</span> <span class="main">!</span><span class="main">(</span><span class="bound">n</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> eo c1 c2
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> linorder_neqE_linordered_idom<span class="main">)</span> 
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
    <span class="keyword1"><span class="command">using</span></span> len_gteq len_one len_gt 
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> One_nat_def less_numeral_extra<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> linorder_neqE_nat not_less nth_Cons_0<span class="main">)</span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(* We want to show that our auxiliary polynomial has roots in all relevant intervals:
 so it captures all of the zeros, and also it captures all of the points in between! *)</span>
<span class="keyword1" id="Renegar_Decision-all_sample_points_prop"><span class="command">lemma</span></span> all_sample_points_prop<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> is_not_const<span class="main">:</span> <span class="quoted"><span class="quoted">"check_all_const_deg <span class="free">qs</span> <span class="main">=</span> False"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> s_is<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">=</span> <span class="main">(</span>characterize_root_list_p <span class="main">(</span>pderiv <span class="main">(</span>prod_list_var <span class="free">qs</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span>prod_list_var <span class="free">qs</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">[:</span><span class="main">-</span><span class="main">(</span>crb <span class="main">(</span>prod_list_var <span class="free">qs</span><span class="main">)</span><span class="main">)</span><span class="main">,</span><span class="main">1</span><span class="main">:]</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">[:</span><span class="main">(</span>crb <span class="main">(</span>prod_list_var <span class="free">qs</span><span class="main">)</span><span class="main">)</span><span class="main">,</span><span class="main">1</span><span class="main">:]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span><span class="comment1">(* properties about S*)</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"consistent_sign_vectors_R <span class="free">qs</span> UNIV <span class="main">=</span> consistent_sign_vectors_R <span class="free">qs</span> <span class="main">(</span>set <span class="free">S</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?zer_list</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"sorted_list_of_set <span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">::</span>real<span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="main">∃</span><span class="bound">q</span> <span class="main">∈</span> set<span class="main">(</span><span class="free">qs</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">q</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">∧</span> poly <span class="bound">q</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span><span class="main">}</span> <span class="main">::</span> real list"</span></span>
  <span class="keyword1"><span class="command">have</span></span> strict_sorted_h<span class="main">:</span> <span class="quoted"><span class="quoted">"strict_sorted <span class="var">?zer_list</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> sorted_sorted_list_of_set
      strict_sorted_iff <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> poly_f_is<span class="main">:</span> <span class="quoted"><span class="quoted">"poly_f <span class="free">qs</span>  <span class="main">=</span> <span class="main">(</span>pderiv <span class="main">(</span>prod_list_var <span class="free">qs</span><span class="main">)</span> <span class="main">*</span> prod_list_var <span class="free">qs</span><span class="main">)</span><span class="main">*</span> <span class="main">(</span><span class="main">[:</span><span class="main">-</span><span class="main">(</span>crb <span class="main">(</span>prod_list_var <span class="free">qs</span><span class="main">)</span><span class="main">)</span><span class="main">,</span><span class="main">1</span><span class="main">:]</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">[:</span><span class="main">(</span>crb <span class="main">(</span>prod_list_var <span class="free">qs</span><span class="main">)</span><span class="main">)</span><span class="main">,</span><span class="main">1</span><span class="main">:]</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> poly_f_def <span class="keyword1"><span class="command">using</span></span> is_not_const <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> set_S_char<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="free">S</span> <span class="main">=</span> <span class="main">(</span><span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="main">(</span>poly_f <span class="free">qs</span><span class="main">)</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span><span class="main">::</span>real set<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> poly_roots_finite<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"poly_f <span class="free">qs</span>"</span></span><span class="main">]</span> set_sorted_list_of_set poly_f_nonzero<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">qs</span></span><span class="main">]</span> 
    <span class="keyword1"><span class="command">using</span></span> s_is <span class="keyword1"><span class="command">unfolding</span></span> characterize_root_list_p_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> difficult_direction<span class="main">:</span> <span class="quoted"><span class="quoted">"consistent_sign_vectors_R <span class="free">qs</span> UNIV <span class="main">⊆</span> consistent_sign_vectors_R <span class="free">qs</span> <span class="main">(</span>set <span class="free">S</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">clarsimp</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> consistent_sign_vectors_R <span class="free">qs</span> UNIV "</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">y</span><span class="main">.</span> <span class="skolem">x</span>  <span class="main">=</span> <span class="main">(</span>consistent_sign_vec <span class="free">qs</span> <span class="bound">y</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> consistent_sign_vectors_R_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="keyword2"><span class="keyword">where</span></span> y_prop<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> consistent_sign_vec <span class="free">qs</span> <span class="skolem">y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">k</span> <span class="main">∈</span> <span class="main">(</span>set <span class="free">S</span><span class="main">)</span><span class="main">.</span> consistent_sign_vec <span class="free">qs</span> <span class="bound">k</span> <span class="main">=</span> consistent_sign_vec <span class="free">qs</span> <span class="skolem">y</span>"</span></span> 
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
      <span class="keyword1"><span class="command">have</span></span> c1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound">q</span> <span class="main">∈</span> <span class="main">(</span>set <span class="free">qs</span><span class="main">)</span><span class="main">.</span> <span class="bound">q</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">∧</span> poly <span class="bound">q</span> <span class="skolem">y</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">k</span> <span class="main">∈</span> <span class="main">(</span>set <span class="free">S</span><span class="main">)</span><span class="main">.</span> consistent_sign_vec <span class="free">qs</span> <span class="bound">k</span> <span class="main">=</span> consistent_sign_vec <span class="free">qs</span> <span class="skolem">y</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound">q</span> <span class="main">∈</span> <span class="main">(</span>set <span class="free">qs</span><span class="main">)</span><span class="main">.</span> <span class="bound">q</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">∧</span> poly <span class="bound">q</span> <span class="skolem">y</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">q</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">∈</span> <span class="main">(</span>set <span class="free">qs</span><span class="main">)</span> <span class="main">∧</span> <span class="skolem">q</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">∧</span> poly <span class="skolem">q</span> <span class="skolem">y</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"poly <span class="main">(</span>prod_list_var <span class="free">qs</span><span class="main">)</span> <span class="skolem">y</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> q_dvd_prod_list_var_prop<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">q</span></span> <span class="quoted"><span class="free">qs</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"poly <span class="main">(</span>pderiv <span class="main">(</span>prod_list_var <span class="free">qs</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span>prod_list_var <span class="free">qs</span><span class="main">)</span><span class="main">*</span><span class="main">(</span><span class="main">[:</span><span class="main">-</span><span class="main">(</span>crb <span class="main">(</span>prod_list_var <span class="free">qs</span><span class="main">)</span><span class="main">)</span><span class="main">,</span><span class="main">1</span><span class="main">:]</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">[:</span><span class="main">(</span>crb <span class="main">(</span>prod_list_var <span class="free">qs</span><span class="main">)</span><span class="main">)</span><span class="main">,</span><span class="main">1</span><span class="main">:]</span><span class="main">)</span><span class="main">)</span> <span class="skolem">y</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> <span class="main">(</span>set <span class="free">S</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> s_is <span class="keyword1"><span class="command">unfolding</span></span> characterize_root_list_p_def
        <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">r</span><span class="main">.</span> poly <span class="main">(</span>pderiv <span class="main">(</span>prod_list_var <span class="free">qs</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span>prod_list_var <span class="free">qs</span><span class="main">)</span><span class="main">*</span><span class="main">(</span><span class="main">[:</span><span class="main">-</span><span class="main">(</span>crb <span class="main">(</span>prod_list_var <span class="free">qs</span><span class="main">)</span><span class="main">)</span><span class="main">,</span><span class="main">1</span><span class="main">:]</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">[:</span><span class="main">(</span>crb <span class="main">(</span>prod_list_var <span class="free">qs</span><span class="main">)</span><span class="main">)</span><span class="main">,</span><span class="main">1</span><span class="main">:]</span><span class="main">)</span><span class="main">)</span> <span class="bound">r</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹poly <span class="main">(</span>pderiv <span class="main">(</span>prod_list_var <span class="free">qs</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span>prod_list_var <span class="free">qs</span><span class="main">)</span><span class="main">*</span><span class="main">(</span><span class="main">[:</span><span class="main">-</span><span class="main">(</span>crb <span class="main">(</span>prod_list_var <span class="free">qs</span><span class="main">)</span><span class="main">)</span><span class="main">,</span><span class="main">1</span><span class="main">:]</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">[:</span><span class="main">(</span>crb <span class="main">(</span>prod_list_var <span class="free">qs</span><span class="main">)</span><span class="main">)</span><span class="main">,</span><span class="main">1</span><span class="main">:]</span><span class="main">)</span><span class="main">)</span> <span class="skolem">y</span> <span class="main">=</span> <span class="main">0</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> characterize_root_list_p_def is_not_const poly_f_def poly_f_nonzero poly_roots_finite s_is set_sorted_list_of_set<span class="main">)</span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">k</span> <span class="main">∈</span> <span class="main">(</span>set <span class="free">S</span><span class="main">)</span><span class="main">.</span> consistent_sign_vec <span class="free">qs</span> <span class="bound">k</span> <span class="main">=</span> consistent_sign_vec <span class="free">qs</span> <span class="skolem">y</span>"</span></span> 
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">have</span></span> len_gtz_prop<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="var">?zer_list</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">⟶</span>
            <span class="main">(</span><span class="main">(</span><span class="main">∃</span><span class="bound">w</span><span class="main">.</span> <span class="bound">w</span> <span class="main">&lt;</span> length <span class="var">?zer_list</span> <span class="main">∧</span> <span class="skolem">y</span> <span class="main">=</span> <span class="var">?zer_list</span> <span class="main">!</span> <span class="bound">w</span><span class="main">)</span> <span class="main">∨</span>
             <span class="main">(</span><span class="skolem">y</span> <span class="main">&lt;</span> <span class="var">?zer_list</span> <span class="main">!</span> <span class="main">0</span><span class="main">)</span> <span class="main">∨</span> 
             <span class="main">(</span><span class="skolem">y</span> <span class="main">&gt;</span> <span class="var">?zer_list</span> <span class="main">!</span> <span class="main">(</span>length <span class="var">?zer_list</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">∨</span> 
             <span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">k</span></span> <span class="main">&lt;</span> <span class="main">(</span>length <span class="var">?zer_list</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">.</span> <span class="skolem">y</span> <span class="main">&gt;</span> <span class="var">?zer_list</span> <span class="main">!</span> <span class="bound">k</span>  <span class="main">∧</span> <span class="skolem">y</span> <span class="main">&lt;</span> <span class="var">?zer_list</span> <span class="main">!</span> <span class="main">(</span><span class="bound">k</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
        <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?c</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound">w</span><span class="main">.</span> <span class="bound">w</span> <span class="main">&lt;</span> length <span class="var">?zer_list</span> <span class="main">∧</span> <span class="skolem">y</span> <span class="main">=</span> <span class="var">?zer_list</span> <span class="main">!</span> <span class="bound">w</span><span class="main">)</span> <span class="main">∨</span>
             <span class="main">(</span><span class="skolem">y</span> <span class="main">&lt;</span> <span class="var">?zer_list</span> <span class="main">!</span> <span class="main">0</span><span class="main">)</span> <span class="main">∨</span> 
             <span class="main">(</span><span class="skolem">y</span> <span class="main">&gt;</span> <span class="var">?zer_list</span> <span class="main">!</span> <span class="main">(</span>length <span class="var">?zer_list</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">∨</span> 
             <span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">k</span></span> <span class="main">&lt;</span> <span class="main">(</span>length <span class="var">?zer_list</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">.</span> <span class="skolem">y</span> <span class="main">&gt;</span> <span class="var">?zer_list</span> <span class="main">!</span> <span class="bound">k</span>  <span class="main">∧</span> <span class="skolem">y</span> <span class="main">&lt;</span> <span class="var">?zer_list</span> <span class="main">!</span> <span class="main">(</span><span class="bound">k</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">have</span></span> lis1<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="var">?zer_list</span> <span class="main">=</span> <span class="main">1</span> <span class="main">⟹</span> <span class="var">?c</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">have</span></span> h1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="main">(</span><span class="main">∃</span><span class="bound">w</span><span class="main">.</span> <span class="bound">w</span> <span class="main">&lt;</span> length <span class="var">?zer_list</span> <span class="main">∧</span> <span class="skolem">y</span> <span class="main">=</span> <span class="var">?zer_list</span> <span class="main">!</span> <span class="bound">w</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">¬</span> <span class="main">(</span>List.member <span class="var">?zer_list</span> <span class="skolem">y</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> in_set_conv_nth in_set_member<span class="main">)</span>
        <span class="keyword1"><span class="command">have</span></span> h2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>length <span class="var">?zer_list</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">∧</span> <span class="main">¬</span><span class="main">(</span><span class="main">∃</span><span class="bound">w</span><span class="main">.</span> <span class="bound">w</span> <span class="main">&lt;</span> length <span class="var">?zer_list</span> <span class="main">∧</span> <span class="skolem">y</span> <span class="main">=</span> <span class="var">?zer_list</span> <span class="main">!</span> <span class="bound">w</span><span class="main">)</span> <span class="main">∧</span> <span class="main">¬</span> <span class="main">(</span><span class="skolem">y</span> <span class="main">&lt;</span> <span class="var">?zer_list</span> <span class="main">!</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> <span class="skolem">y</span> <span class="main">&gt;</span> <span class="var">?zer_list</span> <span class="main">!</span> <span class="main">0</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">have</span></span> h3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>length <span class="var">?zer_list</span> <span class="main">&gt;</span> <span class="main">1</span> <span class="main">∧</span> <span class="main">¬</span><span class="main">(</span><span class="main">∃</span><span class="bound">w</span><span class="main">.</span> <span class="bound">w</span> <span class="main">&lt;</span> length <span class="var">?zer_list</span> <span class="main">∧</span> <span class="skolem">y</span> <span class="main">=</span> <span class="var">?zer_list</span> <span class="main">!</span> <span class="bound">w</span><span class="main">)</span> <span class="main">∧</span>  <span class="main">¬</span> <span class="main">(</span><span class="skolem">y</span> <span class="main">&gt;</span> <span class="var">?zer_list</span> <span class="main">!</span> <span class="main">(</span>length <span class="var">?zer_list</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span>
          <span class="skolem">y</span> <span class="main">&lt;</span> <span class="var">?zer_list</span> <span class="main">!</span> <span class="main">(</span>length <span class="var">?zer_list</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> <span class="main"><span class="main">(</span></span>z3<span class="main"><span class="main">)</span></span> diff_Suc_less gr_implies_not0 not_gr_zero<span class="main">)</span> 
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="var">?zer_list</span> <span class="main">&gt;</span> <span class="main">1</span> <span class="main">∧</span> <span class="main">¬</span><span class="main">(</span><span class="main">∃</span><span class="bound">w</span><span class="main">.</span> <span class="bound">w</span> <span class="main">&lt;</span> length <span class="var">?zer_list</span> <span class="main">∧</span> <span class="skolem">y</span> <span class="main">=</span> <span class="var">?zer_list</span> <span class="main">!</span> <span class="bound">w</span><span class="main">)</span> <span class="main">∧</span> <span class="main">¬</span> <span class="main">(</span><span class="skolem">y</span> <span class="main">&lt;</span> <span class="var">?zer_list</span> <span class="main">!</span> <span class="main">0</span><span class="main">)</span> <span class="main">∧</span> <span class="main">¬</span> <span class="main">(</span><span class="skolem">y</span> <span class="main">&gt;</span> <span class="var">?zer_list</span> <span class="main">!</span> <span class="main">(</span>length <span class="var">?zer_list</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>
              <span class="main">⟹</span>  <span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">k</span></span> <span class="main">&lt;</span> <span class="main">(</span>length <span class="var">?zer_list</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">.</span> <span class="skolem">y</span> <span class="main">&gt;</span> <span class="var">?zer_list</span> <span class="main">!</span> <span class="bound">k</span>  <span class="main">∧</span> <span class="skolem">y</span> <span class="main">&lt;</span> <span class="var">?zer_list</span> <span class="main">!</span> <span class="main">(</span><span class="bound">k</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> h1 h2 h3 strict_sorted_h sorted_list_lemma_var<span class="main">[</span><span class="operator">of</span> <span class="var"><span class="quoted"><span class="var">?zer_list</span></span></span> <span class="quoted"><span class="skolem">y</span></span><span class="main">]</span>
          <span class="keyword1"><span class="command">using</span></span> One_nat_def Suc_lessD <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> lgt1<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="var">?zer_list</span> <span class="main">&gt;</span> <span class="main">1</span> <span class="main">⟹</span> <span class="var">?c</span>"</span></span> 
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> lis1 lgt1
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> <span class="main"><span class="main">(</span></span>z3<span class="main"><span class="main">)</span></span> diff_is_0_eq' not_less<span class="main">)</span> 
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">have</span></span> neg_crb_in<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">-</span> crb <span class="main">(</span>prod_list_var <span class="free">qs</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">S</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> set_S_char poly_f_is <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> pos_crb_in<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>crb <span class="main">(</span>prod_list_var <span class="free">qs</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">S</span>"</span></span> 
        <span class="keyword1"><span class="command">using</span></span> set_S_char poly_f_is <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> set_S_nonempty<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="free">S</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> neg_crb_in <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> finset<span class="main">:</span> <span class="quoted"><span class="quoted">"finite  <span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="main">∃</span><span class="bound">q</span><span class="main">∈</span>set <span class="free">qs</span><span class="main">.</span> <span class="bound">q</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">∧</span> poly <span class="bound">q</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span>"</span></span> 
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">q</span> <span class="main">∈</span> set <span class="free">qs</span><span class="main">.</span>  <span class="bound">q</span><span class="main">≠</span> <span class="main">0</span> <span class="main">⟶</span> finite <span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="bound">q</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span> "</span></span>
          <span class="keyword1"><span class="command">using</span></span> poly_roots_finite <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">have</span></span> c2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="main">(</span><span class="main">∃</span><span class="bound">q</span> <span class="main">∈</span> <span class="main">(</span>set <span class="free">qs</span><span class="main">)</span><span class="main">.</span> <span class="bound">q</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">∧</span> poly <span class="bound">q</span> <span class="skolem">y</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">∃</span> <span class="bound">k</span> <span class="main">∈</span> <span class="main">(</span>set <span class="free">S</span><span class="main">)</span><span class="main">.</span> consistent_sign_vec <span class="free">qs</span> <span class="bound">k</span> <span class="main">=</span> consistent_sign_vec <span class="free">qs</span> <span class="skolem">y</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>  
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="main">(</span><span class="main">∃</span><span class="bound">q</span> <span class="main">∈</span> <span class="main">(</span>set <span class="free">qs</span><span class="main">)</span><span class="main">.</span> <span class="bound">q</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">∧</span> poly <span class="bound">q</span> <span class="skolem">y</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">have</span></span> c_c1<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="var">?zer_list</span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟹</span>  <span class="main">∃</span> <span class="bound">k</span> <span class="main">∈</span> <span class="main">(</span>set <span class="free">S</span><span class="main">)</span><span class="main">.</span> consistent_sign_vec <span class="free">qs</span> <span class="bound">k</span> <span class="main">=</span> consistent_sign_vec <span class="free">qs</span> <span class="skolem">y</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"length <span class="var">?zer_list</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">q</span> <span class="main">∈</span> set <span class="main">(</span><span class="free">qs</span><span class="main">)</span><span class="main">.</span> <span class="main">∀</span> <span class="main">(</span><span class="bound">x</span><span class="main">::</span> real<span class="main">)</span><span class="main">.</span> <span class="main">∀</span><span class="main">(</span><span class="bound">y</span><span class="main">::</span>real<span class="main">)</span><span class="main">.</span> squash <span class="main">(</span>poly <span class="bound">q</span> <span class="bound">x</span><span class="main">)</span> <span class="main">=</span> squash <span class="main">(</span>poly <span class="bound">q</span> <span class="bound">y</span><span class="main">)</span>"</span></span>          
          <span class="keyword1"><span class="command">proof</span></span> <span class="operator">clarsimp</span>
            <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">q</span> <span class="skolem">x</span> <span class="skolem">y</span>
            <span class="keyword3"><span class="command">assume</span></span> czer<span class="main">:</span> <span class="quoted"><span class="quoted">"card <span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="main">∃</span><span class="bound">q</span><span class="main">∈</span>set <span class="free">qs</span><span class="main">.</span> <span class="bound">q</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">∧</span> poly <span class="bound">q</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
            <span class="keyword3"><span class="command">assume</span></span> qin<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">∈</span> set <span class="free">qs</span>"</span></span>
            <span class="keyword1"><span class="command">have</span></span> fin_means_empty<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="main">∃</span><span class="bound">q</span><span class="main">∈</span>set <span class="free">qs</span><span class="main">.</span> <span class="bound">q</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">∧</span> poly <span class="bound">q</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> finset czer
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">have</span></span> qzer<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟹</span> squash <span class="main">(</span>poly <span class="skolem">q</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">=</span> squash <span class="main">(</span>poly <span class="skolem">q</span> <span class="skolem">y</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">have</span></span> qnonz<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">⟹</span> squash <span class="main">(</span>poly <span class="skolem">q</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">=</span> squash <span class="main">(</span>poly <span class="skolem">q</span> <span class="skolem">y</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
              <span class="keyword3"><span class="command">assume</span></span> qnonz<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
              <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> noroots<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="skolem">q</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> qin finset
                <span class="keyword1"><span class="command">using</span></span> Collect_empty_eq fin_means_empty <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
              <span class="keyword1"><span class="command">have</span></span> nonzsq1<span class="main">:</span> <span class="quoted"><span class="quoted">"squash <span class="main">(</span>poly <span class="skolem">q</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> fin_means_empty qnonz czer qin
                <span class="keyword1"><span class="command">unfolding</span></span> squash_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
              <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span>  eo<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>poly <span class="skolem">q</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">∨</span> <span class="main">(</span>poly <span class="skolem">q</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">&lt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> squash_def 
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
                <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span> 
              <span class="keyword1"><span class="command">have</span></span> eo1<span class="main">:</span> <span class="quoted"><span class="quoted">"poly <span class="skolem">q</span> <span class="skolem">x</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">⟹</span> poly <span class="skolem">q</span> <span class="skolem">y</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> 
                <span class="keyword1"><span class="command">using</span></span> noroots poly_IVT_pos<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">y</span></span> <span class="quoted"><span class="skolem">x</span></span> <span class="quoted"><span class="skolem">q</span></span><span class="main">]</span> poly_IVT_neg<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">x</span></span> <span class="quoted"><span class="skolem">y</span></span> <span class="quoted"><span class="skolem">q</span></span><span class="main">]</span>
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> linorder_neqE_linordered_idom<span class="main">)</span> 
              <span class="keyword1"><span class="command">have</span></span> eo2<span class="main">:</span> <span class="quoted"><span class="quoted">"poly <span class="skolem">q</span> <span class="skolem">x</span> <span class="main">&lt;</span> <span class="main">0</span> <span class="main">⟹</span> poly <span class="skolem">q</span> <span class="skolem">y</span> <span class="main">&lt;</span> <span class="main">0</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> noroots poly_IVT_pos<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">x</span></span> <span class="quoted"><span class="skolem">y</span></span> <span class="quoted"><span class="skolem">q</span></span><span class="main">]</span> poly_IVT_neg<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">y</span></span> <span class="quoted"><span class="skolem">x</span></span> <span class="quoted"><span class="skolem">q</span></span><span class="main">]</span>
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> linorder_neqE_linordered_idom<span class="main">)</span> 
              <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"squash <span class="main">(</span>poly <span class="skolem">q</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">=</span> squash <span class="main">(</span>poly <span class="skolem">q</span> <span class="skolem">y</span><span class="main">)</span>"</span></span> 
                <span class="keyword1"><span class="command">using</span></span> eo eo1 eo2 <span class="keyword1"><span class="command">unfolding</span></span> squash_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">qed</span></span>
            <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"squash <span class="main">(</span>poly <span class="skolem">q</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">=</span> squash <span class="main">(</span>poly <span class="skolem">q</span> <span class="skolem">y</span><span class="main">)</span>"</span></span> 
              <span class="keyword1"><span class="command">using</span></span> qzer qnonz
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
          <span class="keyword1"><span class="command">qed</span></span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">q</span> <span class="main">∈</span> set <span class="main">(</span><span class="free">qs</span><span class="main">)</span><span class="main">.</span> squash <span class="main">(</span>poly <span class="bound">q</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">=</span> squash <span class="main">(</span>poly <span class="bound">q</span> <span class="main">(</span><span class="main">-</span> crb <span class="main">(</span>prod_list_var <span class="free">qs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">k</span> <span class="main">∈</span> <span class="main">(</span>set <span class="free">S</span><span class="main">)</span><span class="main">.</span> consistent_sign_vec <span class="free">qs</span> <span class="bound">k</span> <span class="main">=</span> consistent_sign_vec <span class="free">qs</span> <span class="skolem">y</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> neg_crb_in <span class="keyword1"><span class="command">unfolding</span></span> consistent_sign_vec_def squash_def  
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> hide_lams<span class="main"><span class="main">)</span></span> antisym_conv3 class_field.neg_1_not_0 equal_neg_zero less_irrefl of_int_minus<span class="main">)</span> 
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">have</span></span> c_c2<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="var">?zer_list</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">⟹</span>  <span class="main">∃</span> <span class="bound">k</span> <span class="main">∈</span> <span class="main">(</span>set <span class="free">S</span><span class="main">)</span><span class="main">.</span> consistent_sign_vec <span class="free">qs</span> <span class="bound">k</span> <span class="main">=</span> consistent_sign_vec <span class="free">qs</span> <span class="skolem">y</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
          <span class="keyword3"><span class="command">assume</span></span> lengt<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="var">?zer_list</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
          <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?t</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">" <span class="main">∃</span> <span class="bound">k</span> <span class="main">∈</span> <span class="main">(</span>set <span class="free">S</span><span class="main">)</span><span class="main">.</span> consistent_sign_vec <span class="free">qs</span> <span class="bound">k</span> <span class="main">=</span> consistent_sign_vec <span class="free">qs</span> <span class="skolem">y</span>"</span></span>
          <span class="keyword1"><span class="command">have</span></span> sg1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound">w</span><span class="main">.</span> <span class="bound">w</span> <span class="main">&lt;</span> length <span class="var">?zer_list</span> <span class="main">∧</span> <span class="skolem">y</span> <span class="main">=</span> <span class="var">?zer_list</span> <span class="main">!</span> <span class="bound">w</span><span class="main">)</span> <span class="main">⟹</span> <span class="var">?t</span>"</span></span>
          <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
            <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound">w</span><span class="main">.</span> <span class="bound">w</span> <span class="main">&lt;</span> length <span class="var">?zer_list</span> <span class="main">∧</span> <span class="skolem">y</span> <span class="main">=</span> <span class="var">?zer_list</span> <span class="main">!</span> <span class="bound">w</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">w</span></span> <span class="keyword2"><span class="keyword">where</span></span> w_prop<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="main">&lt;</span> length <span class="var">?zer_list</span> <span class="main">∧</span> <span class="skolem">y</span> <span class="main">=</span> <span class="var">?zer_list</span> <span class="main">!</span> <span class="skolem">w</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">" <span class="skolem">y</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="main">∃</span><span class="bound">q</span><span class="main">∈</span>set <span class="free">qs</span><span class="main">.</span> <span class="bound">q</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">∧</span> poly <span class="bound">q</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> finset set_sorted_list_of_set<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="main">∃</span><span class="bound">q</span><span class="main">∈</span>set <span class="free">qs</span><span class="main">.</span> <span class="bound">q</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">∧</span> poly <span class="bound">q</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span>"</span></span><span class="main">]</span>
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> <span class="main"><span class="main">(</span></span>verit<span class="main"><span class="main">,</span></span> best<span class="main"><span class="main">)</span></span> nth_mem<span class="main">)</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="main">(</span>poly_f <span class="free">qs</span><span class="main">)</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> poly_f_is
              <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="main">(</span><span class="main">∃</span><span class="bound">q</span><span class="main">∈</span>set <span class="free">qs</span><span class="main">.</span> <span class="bound">q</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">∧</span> poly <span class="bound">q</span> <span class="skolem">y</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> set_S_char
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>  
          <span class="keyword1"><span class="command">qed</span></span>
          <span class="keyword1"><span class="command">have</span></span> sg2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">y</span> <span class="main">&lt;</span> <span class="var">?zer_list</span> <span class="main">!</span> <span class="main">0</span><span class="main">)</span> <span class="main">⟹</span> <span class="var">?t</span>"</span></span> 
          <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
            <span class="keyword3"><span class="command">assume</span></span> ylt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">&lt;</span> <span class="var">?zer_list</span> <span class="main">!</span> <span class="main">0</span>"</span></span>
            <span class="keyword1"><span class="command">have</span></span> ynonzat_some_qs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">q</span> <span class="main">∈</span> <span class="main">(</span>set <span class="free">qs</span><span class="main">)</span><span class="main">.</span> <span class="bound">q</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">⟶</span> poly <span class="bound">q</span> <span class="skolem">y</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> 
            <span class="keyword1"><span class="command">proof</span></span> <span class="operator">clarsimp</span> 
              <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">q</span>
              <span class="keyword3"><span class="command">assume</span></span> q_in<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">∈</span> set <span class="free">qs</span>"</span></span>
              <span class="keyword3"><span class="command">assume</span></span> qnonz<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
              <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"poly <span class="skolem">q</span> <span class="skolem">y</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
              <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="main">∃</span><span class="bound">q</span><span class="main">∈</span>set <span class="free">qs</span><span class="main">.</span> <span class="bound">q</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">∧</span> poly <span class="bound">q</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span>"</span></span> 
                <span class="keyword1"><span class="command">using</span></span> q_in qnonz <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
              <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"List.member <span class="var">?zer_list</span> <span class="skolem">y</span>"</span></span>
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> <span class="main"><span class="main">(</span></span>verit<span class="main"><span class="main">,</span></span> best<span class="main"><span class="main">)</span></span> finset in_set_member mem_Collect_eq set_sorted_list_of_set<span class="main">)</span> 
              <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">≥</span> <span class="var">?zer_list</span> <span class="main">!</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> strict_sorted_h
                <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="main">(</span><span class="main">∃</span><span class="bound">q</span><span class="main">∈</span>set <span class="free">qs</span><span class="main">.</span> <span class="bound">q</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">∧</span> poly <span class="bound">q</span> <span class="skolem">y</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹poly <span class="skolem">q</span> <span class="skolem">y</span> <span class="main">=</span> <span class="main">0</span>›</span></span> q_in qnonz <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
              <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"False"</span></span> <span class="keyword1"><span class="command">using</span></span> ylt 
                <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">qed</span></span>
            <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?ncrb</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">-</span> crb <span class="main">(</span>prod_list_var <span class="free">qs</span><span class="main">)</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="main">∃</span><span class="bound">q</span><span class="main">∈</span>set <span class="free">qs</span><span class="main">.</span> <span class="bound">q</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">∧</span> poly <span class="bound">q</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span><span class="main">.</span> poly <span class="main">(</span>prod_list_var <span class="free">qs</span><span class="main">)</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> q_dvd_prod_list_var_prop
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span> 
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"poly <span class="main">(</span>prod_list_var <span class="free">qs</span><span class="main">)</span> <span class="main">(</span>sorted_list_of_set <span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="main">∃</span><span class="bound">q</span><span class="main">∈</span>set <span class="free">qs</span><span class="main">.</span> <span class="bound">q</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">∧</span> poly <span class="bound">q</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span> <span class="main">!</span> <span class="main">0</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> finset set_sorted_list_of_set
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> lengt nth_mem<span class="main">)</span> 
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> ncrblt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?ncrb</span> <span class="main">&lt;</span> <span class="var">?zer_list</span> <span class="main">!</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> prod_list_var_nonzero crb_lem_neg<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"prod_list_var <span class="free">qs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="var">?zer_list</span> <span class="main">!</span> <span class="main">0</span>"</span></span><span class="main">]</span> 
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">have</span></span> qzerh<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">q</span> <span class="main">∈</span> <span class="main">(</span>set <span class="free">qs</span><span class="main">)</span><span class="main">.</span> <span class="bound">q</span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟶</span> squash <span class="main">(</span>poly <span class="bound">q</span> <span class="var">?ncrb</span><span class="main">)</span> <span class="main">=</span> squash <span class="main">(</span>poly <span class="bound">q</span> <span class="skolem">y</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">q</span> <span class="main">∈</span> <span class="main">(</span>set <span class="free">qs</span><span class="main">)</span><span class="main">.</span> <span class="bound">q</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">⟶</span> squash <span class="main">(</span>poly <span class="bound">q</span> <span class="var">?ncrb</span><span class="main">)</span> <span class="main">=</span> squash <span class="main">(</span>poly <span class="bound">q</span> <span class="skolem">y</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">proof</span></span> <span class="operator">clarsimp</span> 
              <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">q</span>
              <span class="keyword3"><span class="command">assume</span></span> q_in<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">∈</span> set <span class="free">qs</span>"</span></span>
              <span class="keyword3"><span class="command">assume</span></span> qnonz<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
              <span class="keyword1"><span class="command">have</span></span> nonzylt<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">x</span></span> <span class="main">≤</span> <span class="skolem">y</span><span class="main">.</span> poly <span class="skolem">q</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span>"</span></span> 
              <span class="keyword1"><span class="command">proof</span></span> <span class="operator">clarsimp</span> 
                <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
                <span class="keyword3"><span class="command">assume</span></span> xlt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≤</span> <span class="skolem">y</span>"</span></span> 
                <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"poly <span class="skolem">q</span> <span class="skolem">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
                <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="main">∃</span><span class="bound">q</span><span class="main">∈</span>set <span class="free">qs</span><span class="main">.</span> <span class="bound">q</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">∧</span> poly <span class="bound">q</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span>"</span></span> 
                  <span class="keyword1"><span class="command">using</span></span> q_in qnonz <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"List.member <span class="var">?zer_list</span> <span class="skolem">x</span>"</span></span>
                  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> <span class="main"><span class="main">(</span></span>verit<span class="main"><span class="main">,</span></span> best<span class="main"><span class="main">)</span></span> finset in_set_member mem_Collect_eq set_sorted_list_of_set<span class="main">)</span> 
                <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≥</span> <span class="var">?zer_list</span> <span class="main">!</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> strict_sorted_h
                  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> gr_implies_not0 in_set_conv_nth in_set_member not_less sorted_iff_nth_mono sorted_list_of_set<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>     
                <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"False"</span></span> <span class="keyword1"><span class="command">using</span></span> xlt ylt
                  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
              <span class="keyword1"><span class="command">qed</span></span>
              <span class="keyword1"><span class="command">have</span></span> nonzncrb<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">x</span></span> <span class="main">≤</span> <span class="main">(</span>real_of_int <span class="var">?ncrb</span><span class="main">)</span><span class="main">.</span> poly <span class="skolem">q</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span>"</span></span> 
              <span class="keyword1"><span class="command">proof</span></span> <span class="operator">clarsimp</span> 
                <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
                <span class="keyword3"><span class="command">assume</span></span> xlt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≤</span> <span class="main">-</span> real_of_int <span class="main">(</span>crb <span class="main">(</span>prod_list_var <span class="free">qs</span><span class="main">)</span><span class="main">)</span>"</span></span> 
                <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"poly <span class="skolem">q</span> <span class="skolem">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
                <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="main">∃</span><span class="bound">q</span><span class="main">∈</span>set <span class="free">qs</span><span class="main">.</span> <span class="bound">q</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">∧</span> poly <span class="bound">q</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span>"</span></span> 
                  <span class="keyword1"><span class="command">using</span></span> q_in qnonz <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"List.member <span class="var">?zer_list</span> <span class="skolem">x</span>"</span></span>
                  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> <span class="main"><span class="main">(</span></span>verit<span class="main"><span class="main">,</span></span> best<span class="main"><span class="main">)</span></span> finset in_set_member mem_Collect_eq set_sorted_list_of_set<span class="main">)</span> 
                <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≥</span> <span class="var">?zer_list</span> <span class="main">!</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> strict_sorted_h
                  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> gr_implies_not0 in_set_conv_nth in_set_member not_less sorted_iff_nth_mono sorted_list_of_set<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
                <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"False"</span></span> <span class="keyword1"><span class="command">using</span></span> xlt ncrblt 
                  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
              <span class="keyword1"><span class="command">qed</span></span>
              <span class="keyword1"><span class="command">have</span></span> c1<span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="main">(</span>poly <span class="skolem">q</span> <span class="var">?ncrb</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">⟹</span> <span class="main">(</span>poly <span class="skolem">q</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
              <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
                <span class="keyword3"><span class="command">assume</span></span> qncrbgt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>poly <span class="skolem">q</span> <span class="var">?ncrb</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
                <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?ncrb</span> <span class="main">=</span> <span class="skolem">y</span> <span class="main">⟹</span> poly <span class="skolem">q</span> <span class="skolem">y</span> <span class="main">&gt;</span> <span class="main">0</span> "</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                <span class="keyword1"><span class="command">have</span></span> gt<span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="var">?ncrb</span> <span class="main">&gt;</span> <span class="skolem">y</span> <span class="main">⟹</span> poly <span class="skolem">q</span> <span class="skolem">y</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> qncrbgt qnonz poly_IVT_pos<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">y</span></span> <span class="var"><span class="quoted"><span class="var">?ncrb</span></span></span> <span class="quoted"><span class="skolem">q</span></span><span class="main">]</span> poly_IVT_neg<span class="main">[</span><span class="operator">of</span> <span class="var"><span class="quoted"><span class="var">?ncrb</span></span></span> <span class="quoted"><span class="skolem">y</span></span> <span class="quoted"><span class="skolem">q</span></span><span class="main">]</span> nonzncrb nonzylt
                  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
                  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> less_eq_real_def linorder_neqE_linordered_idom<span class="main">)</span> 
                <span class="keyword1"><span class="command">have</span></span> lt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?ncrb</span> <span class="main">&lt;</span> <span class="skolem">y</span> <span class="main">⟹</span> poly <span class="skolem">q</span> <span class="skolem">y</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> qncrbgt
                  <span class="keyword1"><span class="command">using</span></span> qnonz poly_IVT_pos<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">y</span></span> <span class="var"><span class="quoted"><span class="var">?ncrb</span></span></span> <span class="quoted"><span class="skolem">q</span></span><span class="main">]</span> poly_IVT_neg<span class="main">[</span><span class="operator">of</span> <span class="var"><span class="quoted"><span class="var">?ncrb</span></span></span> <span class="quoted"><span class="skolem">y</span></span> <span class="quoted"><span class="skolem">q</span></span><span class="main">]</span> nonzncrb nonzylt
                  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
                  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> less_eq_real_def linorder_neqE_linordered_idom<span class="main">)</span> 
                <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> eq gt lt <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
                  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> linorder_neqE_linordered_idom<span class="main">)</span> 
              <span class="keyword1"><span class="command">qed</span></span>
              <span class="keyword1"><span class="command">have</span></span> c2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>poly <span class="skolem">q</span> <span class="var">?ncrb</span><span class="main">)</span> <span class="main">&lt;</span> <span class="main">0</span> <span class="main">⟹</span>  <span class="main">(</span>poly <span class="skolem">q</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">&lt;</span> <span class="main">0</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> poly_IVT_pos<span class="main">[</span><span class="operator">of</span> <span class="var"><span class="quoted"><span class="var">?ncrb</span></span></span> <span class="quoted"><span class="skolem">y</span></span> <span class="quoted"><span class="skolem">q</span></span><span class="main">]</span> poly_IVT_neg<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">y</span></span> <span class="var"><span class="quoted"><span class="var">?ncrb</span></span></span> <span class="quoted"><span class="skolem">q</span></span><span class="main">]</span> nonzncrb nonzylt
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> less_eq_real_def linorder_neqE_linordered_idom<span class="main">)</span> 
              <span class="keyword1"><span class="command">have</span></span> eo<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>poly <span class="skolem">q</span> <span class="var">?ncrb</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">∨</span>  <span class="main">(</span>poly <span class="skolem">q</span> <span class="var">?ncrb</span><span class="main">)</span> <span class="main">&lt;</span> <span class="main">0</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> nonzncrb
                <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
              <span class="keyword1"><span class="command">then</span></span>  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"squash <span class="main">(</span>poly <span class="skolem">q</span> <span class="main">(</span><span class="main">-</span> real_of_int <span class="main">(</span>crb <span class="main">(</span>prod_list_var <span class="free">qs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> squash <span class="main">(</span>poly <span class="skolem">q</span> <span class="skolem">y</span><span class="main">)</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span>   c1 c2
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> <span class="main"><span class="main">(</span></span>verit<span class="main"><span class="main">,</span></span> ccfv_SIG<span class="main"><span class="main">)</span></span> of_int_minus squash_def<span class="main">)</span>  
            <span class="keyword1"><span class="command">qed</span></span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">q</span> <span class="main">∈</span> <span class="main">(</span>set <span class="free">qs</span><span class="main">)</span><span class="main">.</span> squash <span class="main">(</span>poly <span class="bound">q</span> <span class="var">?ncrb</span><span class="main">)</span> <span class="main">=</span> squash <span class="main">(</span>poly <span class="bound">q</span> <span class="skolem">y</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> qzerh <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"consistent_sign_vec <span class="free">qs</span> <span class="var">?ncrb</span> <span class="main">=</span> consistent_sign_vec <span class="free">qs</span> <span class="skolem">y</span>"</span></span>
              <span class="keyword1"><span class="command">unfolding</span></span> consistent_sign_vec_def squash_def
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> <span class="main"><span class="main">(</span></span>z3<span class="main"><span class="main">)</span></span> map_eq_conv<span class="main">)</span> 
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> neg_crb_in <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">qed</span></span>
          <span class="keyword1"><span class="command">have</span></span> sg3<span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="main">(</span><span class="skolem">y</span> <span class="main">&gt;</span> <span class="var">?zer_list</span> <span class="main">!</span> <span class="main">(</span>length <span class="var">?zer_list</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> <span class="var">?t</span>"</span></span> 
          <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
            <span class="keyword3"><span class="command">assume</span></span> ygt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span>  <span class="main">&gt;</span> <span class="var">?zer_list</span> <span class="main">!</span> <span class="main">(</span>length <span class="var">?zer_list</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">have</span></span> ynonzat_some_qs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">q</span> <span class="main">∈</span> <span class="main">(</span>set <span class="free">qs</span><span class="main">)</span><span class="main">.</span> <span class="bound">q</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">⟶</span> poly <span class="bound">q</span> <span class="skolem">y</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> 
            <span class="keyword1"><span class="command">proof</span></span> <span class="operator">clarsimp</span> 
              <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">q</span>
              <span class="keyword3"><span class="command">assume</span></span> q_in<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">∈</span> set <span class="free">qs</span>"</span></span>
              <span class="keyword3"><span class="command">assume</span></span> qnonz<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
              <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"poly <span class="skolem">q</span> <span class="skolem">y</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
              <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="main">∃</span><span class="bound">q</span><span class="main">∈</span>set <span class="free">qs</span><span class="main">.</span> <span class="bound">q</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">∧</span> poly <span class="bound">q</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span>"</span></span> 
                <span class="keyword1"><span class="command">using</span></span> q_in qnonz <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
              <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"List.member <span class="var">?zer_list</span> <span class="skolem">y</span>"</span></span>
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> <span class="main"><span class="main">(</span></span>verit<span class="main"><span class="main">,</span></span> best<span class="main"><span class="main">)</span></span> finset in_set_member mem_Collect_eq set_sorted_list_of_set<span class="main">)</span> 
              <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">≤</span> <span class="var">?zer_list</span> <span class="main">!</span> <span class="main">(</span>length <span class="var">?zer_list</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> strict_sorted_h
                <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="main">(</span><span class="main">∃</span><span class="bound">q</span><span class="main">∈</span>set <span class="free">qs</span><span class="main">.</span> <span class="bound">q</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">∧</span> poly <span class="bound">q</span> <span class="skolem">y</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹poly <span class="skolem">q</span> <span class="skolem">y</span> <span class="main">=</span> <span class="main">0</span>›</span></span> q_in qnonz <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
              <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"False"</span></span> <span class="keyword1"><span class="command">using</span></span> ygt 
                <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">qed</span></span>
            <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?crb</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"crb <span class="main">(</span>prod_list_var <span class="free">qs</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="main">∃</span><span class="bound">q</span><span class="main">∈</span>set <span class="free">qs</span><span class="main">.</span> <span class="bound">q</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">∧</span> poly <span class="bound">q</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span><span class="main">.</span> poly <span class="main">(</span>prod_list_var <span class="free">qs</span><span class="main">)</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> q_dvd_prod_list_var_prop
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span> 
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"poly <span class="main">(</span>prod_list_var <span class="free">qs</span><span class="main">)</span> <span class="main">(</span>sorted_list_of_set <span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="main">∃</span><span class="bound">q</span><span class="main">∈</span>set <span class="free">qs</span><span class="main">.</span> <span class="bound">q</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">∧</span> poly <span class="bound">q</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span> <span class="main">!</span> <span class="main">0</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> finset set_sorted_list_of_set
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> lengt nth_mem<span class="main">)</span> 
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> crbgt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?crb</span> <span class="main">&gt;</span> <span class="var">?zer_list</span> <span class="main">!</span> <span class="main">(</span>length <span class="var">?zer_list</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> prod_list_var_nonzero crb_lem_pos<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"prod_list_var <span class="free">qs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="var">?zer_list</span> <span class="main">!</span> <span class="main">(</span>length <span class="var">?zer_list</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span><span class="main">]</span>
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span><span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="main">∃</span><span class="bound">q</span><span class="main">∈</span>set <span class="free">qs</span><span class="main">.</span> <span class="bound">q</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">∧</span> poly <span class="bound">q</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span><span class="main">.</span> poly <span class="main">(</span>prod_list_var <span class="free">qs</span><span class="main">)</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span>›</span></span> diff_less finset lengt less_numeral_extra<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> nth_mem set_sorted_list_of_set<span class="main">)</span> 
            <span class="keyword1"><span class="command">have</span></span> qzerh<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">q</span> <span class="main">∈</span> <span class="main">(</span>set <span class="free">qs</span><span class="main">)</span><span class="main">.</span> <span class="bound">q</span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟶</span> squash <span class="main">(</span>poly <span class="bound">q</span> <span class="var">?crb</span><span class="main">)</span> <span class="main">=</span> squash <span class="main">(</span>poly <span class="bound">q</span> <span class="skolem">y</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">q</span> <span class="main">∈</span> <span class="main">(</span>set <span class="free">qs</span><span class="main">)</span><span class="main">.</span> <span class="bound">q</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">⟶</span> squash <span class="main">(</span>poly <span class="bound">q</span> <span class="var">?crb</span><span class="main">)</span> <span class="main">=</span> squash <span class="main">(</span>poly <span class="bound">q</span> <span class="skolem">y</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">proof</span></span> <span class="operator">clarsimp</span> 
              <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">q</span>
              <span class="keyword3"><span class="command">assume</span></span> q_in<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">∈</span> set <span class="free">qs</span>"</span></span>
              <span class="keyword3"><span class="command">assume</span></span> qnonz<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
              <span class="keyword1"><span class="command">have</span></span> nonzylt<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">x</span></span> <span class="main">≥</span> <span class="skolem">y</span><span class="main">.</span> poly <span class="skolem">q</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span>"</span></span> 
              <span class="keyword1"><span class="command">proof</span></span> <span class="operator">clarsimp</span> 
                <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
                <span class="keyword3"><span class="command">assume</span></span> xgt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≥</span> <span class="skolem">y</span>"</span></span> 
                <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"poly <span class="skolem">q</span> <span class="skolem">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
                <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="main">∃</span><span class="bound">q</span><span class="main">∈</span>set <span class="free">qs</span><span class="main">.</span> <span class="bound">q</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">∧</span> poly <span class="bound">q</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span>"</span></span> 
                  <span class="keyword1"><span class="command">using</span></span> q_in qnonz <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"List.member <span class="var">?zer_list</span> <span class="skolem">x</span>"</span></span>
                  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> <span class="main"><span class="main">(</span></span>verit<span class="main"><span class="main">,</span></span> best<span class="main"><span class="main">)</span></span> finset in_set_member mem_Collect_eq set_sorted_list_of_set<span class="main">)</span> 
                <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≤</span> <span class="var">?zer_list</span> <span class="main">!</span> <span class="main">(</span>length <span class="var">?zer_list</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> strict_sorted_h
                  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> One_nat_def Suc_leI Suc_pred diff_Suc_less in_set_conv_nth in_set_member lengt not_less sorted_iff_nth_mono sorted_list_of_set<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>      
                <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"False"</span></span> <span class="keyword1"><span class="command">using</span></span> xgt ygt
                  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
              <span class="keyword1"><span class="command">qed</span></span>
              <span class="keyword1"><span class="command">have</span></span> nonzcrb<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">x</span></span> <span class="main">≥</span> <span class="main">(</span>real_of_int <span class="var">?crb</span><span class="main">)</span><span class="main">.</span> poly <span class="skolem">q</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span>"</span></span> 
              <span class="keyword1"><span class="command">proof</span></span> <span class="operator">clarsimp</span> 
                <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
                <span class="keyword3"><span class="command">assume</span></span> xgt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≥</span> real_of_int <span class="main">(</span>crb <span class="main">(</span>prod_list_var <span class="free">qs</span><span class="main">)</span><span class="main">)</span>"</span></span> 
                <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"poly <span class="skolem">q</span> <span class="skolem">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
                <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="main">∃</span><span class="bound">q</span><span class="main">∈</span>set <span class="free">qs</span><span class="main">.</span> <span class="bound">q</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">∧</span> poly <span class="bound">q</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span>"</span></span> 
                  <span class="keyword1"><span class="command">using</span></span> q_in qnonz <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"List.member <span class="var">?zer_list</span> <span class="skolem">x</span>"</span></span>
                  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> <span class="main"><span class="main">(</span></span>verit<span class="main"><span class="main">,</span></span> best<span class="main"><span class="main">)</span></span> finset in_set_member mem_Collect_eq set_sorted_list_of_set<span class="main">)</span> 
                <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≤</span> <span class="var">?zer_list</span> <span class="main">!</span> <span class="main">(</span>length <span class="var">?zer_list</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> strict_sorted_h
                  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span><span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="main">∃</span><span class="bound">q</span><span class="main">∈</span>set <span class="free">qs</span><span class="main">.</span> <span class="bound">q</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">∧</span> poly <span class="bound">q</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span><span class="main">.</span> poly <span class="main">(</span>prod_list_var <span class="free">qs</span><span class="main">)</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="main">∃</span><span class="bound">q</span><span class="main">∈</span>set <span class="free">qs</span><span class="main">.</span> <span class="bound">q</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">∧</span> poly <span class="bound">q</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span>›</span></span> crb_lem_pos not_less prod_list_var_nonzero xgt<span class="main">)</span>           
                <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"False"</span></span> <span class="keyword1"><span class="command">using</span></span> xgt crbgt 
                  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
              <span class="keyword1"><span class="command">qed</span></span>
              <span class="keyword1"><span class="command">have</span></span> c1<span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="main">(</span>poly <span class="skolem">q</span> <span class="var">?crb</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">⟹</span> <span class="main">(</span>poly <span class="skolem">q</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
              <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
                <span class="keyword3"><span class="command">assume</span></span> qcrbgt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>poly <span class="skolem">q</span> <span class="var">?crb</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
                <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?crb</span> <span class="main">=</span> <span class="skolem">y</span> <span class="main">⟹</span> poly <span class="skolem">q</span> <span class="skolem">y</span> <span class="main">&gt;</span> <span class="main">0</span> "</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                <span class="keyword1"><span class="command">have</span></span> gt<span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="var">?crb</span> <span class="main">&gt;</span> <span class="skolem">y</span> <span class="main">⟹</span> poly <span class="skolem">q</span> <span class="skolem">y</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> qcrbgt qnonz poly_IVT_pos<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">y</span></span> <span class="var"><span class="quoted"><span class="var">?crb</span></span></span> <span class="quoted"><span class="skolem">q</span></span><span class="main">]</span> poly_IVT_neg<span class="main">[</span><span class="operator">of</span> <span class="var"><span class="quoted"><span class="var">?crb</span></span></span> <span class="quoted"><span class="skolem">y</span></span> <span class="quoted"><span class="skolem">q</span></span><span class="main">]</span> nonzcrb nonzylt
                  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
                  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> less_eq_real_def linorder_neqE_linordered_idom<span class="main">)</span> 
                <span class="keyword1"><span class="command">have</span></span> lt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?crb</span> <span class="main">&lt;</span> <span class="skolem">y</span> <span class="main">⟹</span> poly <span class="skolem">q</span> <span class="skolem">y</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> qcrbgt
                  <span class="keyword1"><span class="command">using</span></span> qnonz poly_IVT_pos<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">y</span></span> <span class="var"><span class="quoted"><span class="var">?crb</span></span></span> <span class="quoted"><span class="skolem">q</span></span><span class="main">]</span> poly_IVT_neg<span class="main">[</span><span class="operator">of</span> <span class="var"><span class="quoted"><span class="var">?crb</span></span></span> <span class="quoted"><span class="skolem">y</span></span> <span class="quoted"><span class="skolem">q</span></span><span class="main">]</span> nonzcrb nonzylt
                  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
                  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> less_eq_real_def linorder_neqE_linordered_idom<span class="main">)</span> 
                <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> eq gt lt <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
                  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> linorder_neqE_linordered_idom<span class="main">)</span> 
              <span class="keyword1"><span class="command">qed</span></span>
              <span class="keyword1"><span class="command">have</span></span> c2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>poly <span class="skolem">q</span> <span class="var">?crb</span><span class="main">)</span> <span class="main">&lt;</span> <span class="main">0</span> <span class="main">⟹</span>  <span class="main">(</span>poly <span class="skolem">q</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">&lt;</span> <span class="main">0</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> poly_IVT_pos<span class="main">[</span><span class="operator">of</span> <span class="var"><span class="quoted"><span class="var">?crb</span></span></span> <span class="quoted"><span class="skolem">y</span></span> <span class="quoted"><span class="skolem">q</span></span><span class="main">]</span> poly_IVT_neg<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">y</span></span> <span class="var"><span class="quoted"><span class="var">?crb</span></span></span> <span class="quoted"><span class="skolem">q</span></span><span class="main">]</span> nonzcrb nonzylt
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> less_eq_real_def linorder_neqE_linordered_idom<span class="main">)</span> 
              <span class="keyword1"><span class="command">have</span></span> eo<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>poly <span class="skolem">q</span> <span class="var">?crb</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">∨</span>  <span class="main">(</span>poly <span class="skolem">q</span> <span class="var">?crb</span><span class="main">)</span> <span class="main">&lt;</span> <span class="main">0</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> nonzcrb
                <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
              <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"squash <span class="main">(</span>poly <span class="skolem">q</span> <span class="main">(</span>real_of_int <span class="main">(</span>crb <span class="main">(</span>prod_list_var <span class="free">qs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> squash <span class="main">(</span>poly <span class="skolem">q</span> <span class="skolem">y</span><span class="main">)</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span>   c1 c2
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> <span class="main"><span class="main">(</span></span>verit<span class="main"><span class="main">,</span></span> ccfv_SIG<span class="main"><span class="main">)</span></span> of_int_minus squash_def<span class="main">)</span>  
            <span class="keyword1"><span class="command">qed</span></span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">q</span> <span class="main">∈</span> <span class="main">(</span>set <span class="free">qs</span><span class="main">)</span><span class="main">.</span> squash <span class="main">(</span>poly <span class="bound">q</span> <span class="var">?crb</span><span class="main">)</span> <span class="main">=</span> squash <span class="main">(</span>poly <span class="bound">q</span> <span class="skolem">y</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> qzerh <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"consistent_sign_vec <span class="free">qs</span> <span class="var">?crb</span> <span class="main">=</span> consistent_sign_vec <span class="free">qs</span> <span class="skolem">y</span>"</span></span>
              <span class="keyword1"><span class="command">unfolding</span></span> consistent_sign_vec_def squash_def
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> <span class="main"><span class="main">(</span></span>z3<span class="main"><span class="main">)</span></span> map_eq_conv<span class="main">)</span> 
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> pos_crb_in <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">qed</span></span>
          <span class="keyword1"><span class="command">have</span></span> sg4<span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">k</span></span> <span class="main">&lt;</span> <span class="main">(</span>length <span class="var">?zer_list</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">.</span> <span class="skolem">y</span> <span class="main">&gt;</span> <span class="var">?zer_list</span> <span class="main">!</span> <span class="bound">k</span>  <span class="main">∧</span> <span class="skolem">y</span> <span class="main">&lt;</span> <span class="var">?zer_list</span> <span class="main">!</span> <span class="main">(</span><span class="bound">k</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> <span class="var">?t</span>"</span></span>
          <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
            <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">" <span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">k</span></span> <span class="main">&lt;</span> <span class="main">(</span>length <span class="var">?zer_list</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">.</span> <span class="skolem">y</span> <span class="main">&gt;</span> <span class="var">?zer_list</span> <span class="main">!</span> <span class="bound">k</span>  <span class="main">∧</span> <span class="skolem">y</span> <span class="main">&lt;</span> <span class="var">?zer_list</span> <span class="main">!</span> <span class="main">(</span><span class="bound">k</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> k_prop<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">&lt;</span> <span class="main">(</span>length <span class="var">?zer_list</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">∧</span> <span class="skolem">y</span> <span class="main">&gt;</span> <span class="var">?zer_list</span> <span class="main">!</span> <span class="skolem">k</span>  <span class="main">∧</span> <span class="skolem">y</span> <span class="main">&lt;</span> <span class="var">?zer_list</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">k</span><span class="main">+</span><span class="main">1</span><span class="main">)</span>"</span></span> 
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">have</span></span> ltk<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?zer_list</span> <span class="main">!</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">&lt;</span> <span class="main">(</span><span class="var">?zer_list</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">k</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> "</span></span>
              <span class="keyword1"><span class="command">using</span></span> strict_sorted_h
              <span class="keyword1"><span class="command">using</span></span> k_prop <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span> 
            <span class="keyword1"><span class="command">have</span></span> q1e<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound">q1</span><span class="main">∈</span>set <span class="free">qs</span><span class="main">.</span> <span class="bound">q1</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">∧</span> poly <span class="bound">q1</span> <span class="main">(</span><span class="var">?zer_list</span> <span class="main">!</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> <span class="main"><span class="main">(</span></span>z3<span class="main"><span class="main">)</span></span> One_nat_def Suc_lessD add.right_neutral add_Suc_right finset k_prop less_diff_conv mem_Collect_eq nth_mem set_sorted_list_of_set<span class="main">)</span> 
            <span class="keyword1"><span class="command">have</span></span> q2e<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound">q2</span><span class="main">∈</span>set <span class="free">qs</span><span class="main">.</span> <span class="bound">q2</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">∧</span> poly <span class="bound">q2</span> <span class="main">(</span><span class="var">?zer_list</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">k</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> <span class="main"><span class="main">(</span></span>verit<span class="main"><span class="main">,</span></span> del_insts<span class="main"><span class="main">)</span></span> finset k_prop less_diff_conv mem_Collect_eq nth_mem set_sorted_list_of_set<span class="main">)</span> 
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">q</span></span><span class="main">&gt;</span><span class="main">(</span><span class="var">?zer_list</span> <span class="main">!</span> <span class="skolem">k</span><span class="main">)</span><span class="main">.</span> <span class="bound">q</span> <span class="main">&lt;</span> <span class="main">(</span><span class="var">?zer_list</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">k</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> poly <span class="main">(</span>poly_f <span class="free">qs</span><span class="main">)</span> <span class="bound">q</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> poly_f_roots_prop_1<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">qs</span></span><span class="main">]</span> q1e q2e ltk is_not_const 
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">s</span> <span class="main">∈</span> set <span class="free">S</span><span class="main">.</span> <span class="bound">s</span> <span class="main">&gt;</span> <span class="var">?zer_list</span> <span class="main">!</span> <span class="skolem">k</span>  <span class="main">∧</span> <span class="bound">s</span> <span class="main">&lt;</span> <span class="var">?zer_list</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">k</span><span class="main">+</span><span class="main">1</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> poly_f_is
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> <span class="main"><span class="main">(</span></span>z3<span class="main"><span class="main">)</span></span> k_prop mem_Collect_eq set_S_char<span class="main">)</span> 
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="keyword2"><span class="keyword">where</span></span> s_prop<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> set <span class="free">S</span> <span class="main">∧</span> <span class="skolem">s</span> <span class="main">&gt;</span> <span class="var">?zer_list</span> <span class="main">!</span> <span class="skolem">k</span>  <span class="main">∧</span> <span class="skolem">s</span> <span class="main">&lt;</span> <span class="var">?zer_list</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">k</span><span class="main">+</span><span class="main">1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">have</span></span> qnon<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">q</span> <span class="main">∈</span> set <span class="free">qs</span><span class="main">.</span> <span class="bound">q</span><span class="main">≠</span> <span class="main">0</span> <span class="main">⟶</span> squash <span class="main">(</span>poly <span class="bound">q</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">=</span> squash <span class="main">(</span>poly <span class="bound">q</span> <span class="skolem">y</span><span class="main">)</span>"</span></span> 
            <span class="keyword1"><span class="command">proof</span></span> <span class="operator">clarsimp</span> 
              <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">q</span>
              <span class="keyword3"><span class="command">assume</span></span> q_in<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">∈</span> set <span class="free">qs</span>"</span></span>
              <span class="keyword3"><span class="command">assume</span></span> qnonz<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
              <span class="keyword1"><span class="command">have</span></span> sgt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">&gt;</span> <span class="skolem">y</span> <span class="main">⟹</span> squash <span class="main">(</span>poly <span class="skolem">q</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">=</span> squash <span class="main">(</span>poly <span class="skolem">q</span> <span class="skolem">y</span><span class="main">)</span>"</span></span> 
              <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
                <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">&gt;</span> <span class="skolem">y</span>"</span></span>
                <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∄</span><span class="bound">x</span><span class="main">.</span> List.member <span class="var">?zer_list</span> <span class="bound">x</span> <span class="main">∧</span> <span class="skolem">y</span> <span class="main">≤</span> <span class="bound">x</span> <span class="main">∧</span> <span class="bound">x</span> <span class="main">≤</span> <span class="skolem">s</span>"</span></span>   
                  <span class="keyword1"><span class="command">using</span></span> sorted_list_lemma<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">y</span></span> <span class="quoted"><span class="skolem">s</span></span> <span class="quoted"><span class="skolem">k</span></span> <span class="var"><span class="quoted"><span class="var">?zer_list</span></span></span><span class="main">]</span> k_prop strict_sorted_h s_prop y_prop
                  <span class="keyword1"><span class="command">using</span></span> less_diff_conv <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
                <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> nox<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∄</span><span class="bound">x</span><span class="main">.</span> poly <span class="skolem">q</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> <span class="skolem">y</span> <span class="main">≤</span> <span class="bound">x</span> <span class="main">∧</span> <span class="bound">x</span> <span class="main">≤</span> <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> q_in qnonz
                  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> finset in_set_member mem_Collect_eq set_sorted_list_of_set<span class="main">)</span> 
                <span class="keyword1"><span class="command">then</span></span>  <span class="keyword1"><span class="command">have</span></span> c1<span class="main">:</span> <span class="quoted"><span class="quoted">"poly <span class="skolem">q</span> <span class="skolem">s</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> s_prop q_in qnonz
                  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">y</span> <span class="main">&lt;</span> <span class="skolem">s</span>›</span></span> less_eq_real_def <span class="main">)</span>
                <span class="keyword1"><span class="command">have</span></span> c2<span class="main">:</span> <span class="quoted"><span class="quoted">"poly <span class="skolem">q</span> <span class="skolem">s</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">⟹</span> poly <span class="skolem">q</span> <span class="skolem">y</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
                  <span class="keyword1"><span class="command">using</span></span> poly_IVT_pos poly_IVT_neg nox
                  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> <span class="quoted"><span class="quoted">‹<span class="skolem">y</span> <span class="main">&lt;</span> <span class="skolem">s</span>›</span></span> less_eq_real_def linorder_neqE_linordered_idom<span class="main">)</span> 
                <span class="keyword1"><span class="command">have</span></span> c3<span class="main">:</span> <span class="quoted"><span class="quoted">"poly <span class="skolem">q</span> <span class="skolem">s</span> <span class="main">&lt;</span> <span class="main">0</span> <span class="main">⟹</span> poly <span class="skolem">q</span> <span class="skolem">y</span> <span class="main">&lt;</span> <span class="main">0</span>"</span></span>  <span class="keyword1"><span class="command">using</span></span> poly_IVT_pos poly_IVT_neg nox
                  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> <span class="quoted"><span class="quoted">‹<span class="skolem">y</span> <span class="main">&lt;</span> <span class="skolem">s</span>›</span></span> less_eq_real_def linorder_neqE_linordered_idom<span class="main">)</span> 
                <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> c1 c2 c3 <span class="keyword1"><span class="command">unfolding</span></span> squash_def
                  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
              <span class="keyword1"><span class="command">qed</span></span>
              <span class="keyword1"><span class="command">have</span></span> slt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">&lt;</span> <span class="skolem">y</span> <span class="main">⟹</span> squash <span class="main">(</span>poly <span class="skolem">q</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">=</span> squash <span class="main">(</span>poly <span class="skolem">q</span> <span class="skolem">y</span><span class="main">)</span>"</span></span>              
              <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
                <span class="keyword3"><span class="command">assume</span></span> slt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">&lt;</span> <span class="skolem">y</span>"</span></span>
                <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∄</span><span class="bound">x</span><span class="main">.</span> List.member <span class="var">?zer_list</span> <span class="bound">x</span> <span class="main">∧</span> <span class="skolem">s</span> <span class="main">≤</span> <span class="bound">x</span> <span class="main">∧</span> <span class="bound">x</span> <span class="main">≤</span> <span class="skolem">y</span>"</span></span>   
                  <span class="keyword1"><span class="command">using</span></span> sorted_list_lemma<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">s</span></span> <span class="quoted"><span class="skolem">y</span></span> <span class="quoted"><span class="skolem">k</span></span> <span class="var"><span class="quoted"><span class="var">?zer_list</span></span></span><span class="main">]</span> k_prop strict_sorted_h s_prop y_prop
                  <span class="keyword1"><span class="command">using</span></span> less_diff_conv <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
                <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> nox<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∄</span><span class="bound">x</span><span class="main">.</span> poly <span class="skolem">q</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> <span class="skolem">s</span> <span class="main">≤</span> <span class="bound">x</span> <span class="main">∧</span> <span class="bound">x</span> <span class="main">≤</span> <span class="skolem">y</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> q_in qnonz
                  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> finset in_set_member mem_Collect_eq set_sorted_list_of_set<span class="main">)</span> 
                <span class="keyword1"><span class="command">then</span></span>  <span class="keyword1"><span class="command">have</span></span> c1<span class="main">:</span> <span class="quoted"><span class="quoted">"poly <span class="skolem">q</span> <span class="skolem">s</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> s_prop q_in qnonz
                  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">s</span> <span class="main">&lt;</span> <span class="skolem">y</span>›</span></span> less_eq_real_def <span class="main">)</span>
                <span class="keyword1"><span class="command">have</span></span> c2<span class="main">:</span> <span class="quoted"><span class="quoted">"poly <span class="skolem">q</span> <span class="skolem">s</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">⟹</span> poly <span class="skolem">q</span> <span class="skolem">y</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
                  <span class="keyword1"><span class="command">using</span></span> poly_IVT_pos poly_IVT_neg nox
                  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> <span class="quoted"><span class="quoted">‹<span class="skolem">s</span> <span class="main">&lt;</span> <span class="skolem">y</span>›</span></span> less_eq_real_def linorder_neqE_linordered_idom<span class="main">)</span> 
                <span class="keyword1"><span class="command">have</span></span> c3<span class="main">:</span> <span class="quoted"><span class="quoted">"poly <span class="skolem">q</span> <span class="skolem">s</span> <span class="main">&lt;</span> <span class="main">0</span> <span class="main">⟹</span> poly <span class="skolem">q</span> <span class="skolem">y</span> <span class="main">&lt;</span> <span class="main">0</span>"</span></span>  <span class="keyword1"><span class="command">using</span></span> poly_IVT_pos poly_IVT_neg nox
                  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> <span class="quoted"><span class="quoted">‹<span class="skolem">s</span> <span class="main">&lt;</span> <span class="skolem">y</span>›</span></span> less_eq_real_def linorder_neqE_linordered_idom<span class="main">)</span> 
                <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> c1 c2 c3 <span class="keyword1"><span class="command">unfolding</span></span> squash_def
                  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
              <span class="keyword1"><span class="command">qed</span></span>
              <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">=</span> <span class="skolem">y</span> <span class="main">⟹</span> squash <span class="main">(</span>poly <span class="skolem">q</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">=</span> squash <span class="main">(</span>poly <span class="skolem">q</span> <span class="skolem">y</span><span class="main">)</span>"</span></span> 
                <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
              <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"squash <span class="main">(</span>poly <span class="skolem">q</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">=</span> squash <span class="main">(</span>poly <span class="skolem">q</span> <span class="skolem">y</span><span class="main">)</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> sgt slt
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> linorder_neqE_linordered_idom<span class="main">)</span> 
            <span class="keyword1"><span class="command">qed</span></span>
            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">q</span> <span class="main">∈</span> set <span class="free">qs</span><span class="main">.</span> <span class="bound">q</span><span class="main">=</span> <span class="main">0</span> <span class="main">⟶</span> squash <span class="main">(</span>poly <span class="bound">q</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">=</span> squash <span class="main">(</span>poly <span class="bound">q</span> <span class="skolem">y</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">q</span> <span class="main">∈</span> set <span class="free">qs</span><span class="main">.</span> squash <span class="main">(</span>poly <span class="bound">q</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">=</span> squash <span class="main">(</span>poly <span class="bound">q</span> <span class="skolem">y</span><span class="main">)</span>"</span></span> 
              <span class="keyword1"><span class="command">using</span></span> qnon
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span> 
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
              <span class="keyword1"><span class="command">using</span></span> s_prop <span class="keyword1"><span class="command">unfolding</span></span> squash_def consistent_sign_vec_def <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> hide_lams<span class="main"><span class="main">)</span></span> class_field.neg_1_not_0 equal_neg_zero less_irrefl linorder_neqE_linordered_idom<span class="main">)</span> 
          <span class="keyword1"><span class="command">qed</span></span>
          <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
            <span class="keyword1"><span class="command">using</span></span> lengt sg1 sg2 sg3 sg4 len_gtz_prop is_not_const
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span> 
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">k</span> <span class="main">∈</span> <span class="main">(</span>set <span class="free">S</span><span class="main">)</span><span class="main">.</span> consistent_sign_vec <span class="free">qs</span> <span class="bound">k</span> <span class="main">=</span> consistent_sign_vec <span class="free">qs</span> <span class="skolem">y</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> c_c1 c_c2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> c1 c2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> consistent_sign_vectors_R <span class="free">qs</span> <span class="main">(</span>set <span class="free">S</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> y_prop <span class="keyword1"><span class="command">unfolding</span></span> consistent_sign_vectors_R_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> imageI<span class="main">)</span> 
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">have</span></span> easy_direction<span class="main">:</span> <span class="quoted"><span class="quoted">"consistent_sign_vectors_R <span class="free">qs</span> <span class="main">(</span>set <span class="free">S</span><span class="main">)</span> <span class="main">⊆</span> consistent_sign_vectors_R <span class="free">qs</span> UNIV "</span></span>
    <span class="keyword1"><span class="command">using</span></span> consistent_sign_vectors_R_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> difficult_direction easy_direction <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Renegar_Decision-main_step_aux2_R"><span class="command">lemma</span></span> main_step_aux2_R<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">qs</span><span class="main">::</span> <span class="quoted"><span class="quoted">"real poly list"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> is_not_const<span class="main">:</span> <span class="quoted"><span class="quoted">"check_all_const_deg <span class="free">qs</span> <span class="main">=</span> False"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>find_consistent_signs_R <span class="free">qs</span><span class="main">)</span> <span class="main">=</span>  consistent_sign_vectors_R <span class="free">qs</span> UNIV"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
  <span class="keyword1"><span class="command">have</span></span> poly_f_is<span class="main">:</span> <span class="quoted"><span class="quoted">"poly_f <span class="free">qs</span> <span class="main">=</span> <span class="main">(</span>pderiv <span class="main">(</span>prod_list_var <span class="free">qs</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span>prod_list_var <span class="free">qs</span><span class="main">)</span><span class="main">*</span> <span class="main">(</span><span class="main">[:</span><span class="main">-</span><span class="main">(</span>crb <span class="main">(</span>prod_list_var <span class="free">qs</span><span class="main">)</span><span class="main">)</span><span class="main">,</span><span class="main">1</span><span class="main">:]</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">[:</span><span class="main">(</span>crb <span class="main">(</span>prod_list_var <span class="free">qs</span><span class="main">)</span><span class="main">)</span><span class="main">,</span><span class="main">1</span><span class="main">:]</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> is_not_const <span class="keyword1"><span class="command">unfolding</span></span> poly_f_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?p</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>pderiv <span class="main">(</span>prod_list_var <span class="free">qs</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span>prod_list_var <span class="free">qs</span><span class="main">)</span><span class="main">*</span>  <span class="main">(</span><span class="main">[:</span><span class="main">-</span><span class="main">(</span>crb <span class="main">(</span>prod_list_var <span class="free">qs</span><span class="main">)</span><span class="main">)</span><span class="main">,</span><span class="main">1</span><span class="main">:]</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">[:</span><span class="main">(</span>crb <span class="main">(</span>prod_list_var <span class="free">qs</span><span class="main">)</span><span class="main">)</span><span class="main">,</span><span class="main">1</span><span class="main">:]</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?S</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"characterize_root_list_p <span class="main">(</span>pderiv <span class="main">(</span>prod_list_var <span class="free">qs</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span>prod_list_var <span class="free">qs</span><span class="main">)</span> <span class="main">*</span>  <span class="main">(</span><span class="main">[:</span><span class="main">-</span><span class="main">(</span>crb <span class="main">(</span>prod_list_var <span class="free">qs</span><span class="main">)</span><span class="main">)</span><span class="main">,</span><span class="main">1</span><span class="main">:]</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">[:</span><span class="main">(</span>crb <span class="main">(</span>prod_list_var <span class="free">qs</span><span class="main">)</span><span class="main">)</span><span class="main">,</span><span class="main">1</span><span class="main">:]</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>remdups
          <span class="main">(</span>map <span class="main">(</span>signs_at <span class="free">qs</span><span class="main">)</span> <span class="var">?S</span><span class="main">)</span><span class="main">)</span> 
      <span class="main">=</span> consistent_sign_vectors_R <span class="free">qs</span> <span class="main">(</span>set <span class="var">?S</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> signs_at_def squash_def consistent_sign_vectors_R_def consistent_sign_vec_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> <span class="main"><span class="main">(</span></span>verit<span class="main"><span class="main">,</span></span> best<span class="main"><span class="main">)</span></span> comp_apply map_eq_conv set_map set_remdups<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>characterize_consistent_signs_at_roots <span class="var">?p</span> <span class="free">qs</span><span class="main">)</span> <span class="main">=</span> consistent_sign_vectors_R <span class="free">qs</span> UNIV"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> characterize_consistent_signs_at_roots_def <span class="keyword1"><span class="command">using</span></span> assms all_sample_points_prop<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">qs</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> find_consistent_signs_R_def <span class="keyword1"><span class="command">using</span></span> find_consistent_signs_at_roots_R poly_f_is poly_f_nonzero<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">qs</span></span><span class="main">]</span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Renegar_Decision-main_step_R"><span class="command">lemma</span></span> main_step_R<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">qs</span><span class="main">::</span> <span class="quoted"><span class="quoted">"real poly list"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>find_consistent_signs_R <span class="free">qs</span><span class="main">)</span> <span class="main">=</span>  consistent_sign_vectors_R <span class="free">qs</span> UNIV"</span></span>
  <span class="keyword1"><span class="command">using</span></span> main_step_aux1_R main_step_aux2_R <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="comment1">(* The universal and existential decision procedure for real polys are easy 
   if we know the consistent sign vectors *)</span>
<span class="keyword1" id="Renegar_Decision-consistent_sign_vec_semantics_R"><span class="command">lemma</span></span> consistent_sign_vec_semantics_R<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∈</span> set_fml <span class="free">fml</span> <span class="main">⟹</span> <span class="bound">i</span> <span class="main">&lt;</span> length <span class="free">ls</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"lookup_sem <span class="free">fml</span> <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> poly <span class="bound">p</span> <span class="free">x</span><span class="main">)</span> <span class="free">ls</span><span class="main">)</span> <span class="main">=</span> lookup_sem <span class="free">fml</span> <span class="main">(</span>consistent_sign_vec <span class="free">ls</span> <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induction</span><span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> consistent_sign_vec_def<span class="main">)</span>

<span class="keyword1" id="Renegar_Decision-universal_lookup_sem_R"><span class="command">lemma</span></span> universal_lookup_sem_R<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∈</span> set_fml <span class="free">fml</span> <span class="main">⟹</span> <span class="bound">i</span> <span class="main">&lt;</span> length <span class="free">qs</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"set <span class="free">signs</span> <span class="main">=</span> consistent_sign_vectors_R <span class="free">qs</span> UNIV"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">::</span>real<span class="main">.</span> lookup_sem <span class="free">fml</span> <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> poly <span class="bound">p</span> <span class="bound">x</span><span class="main">)</span> <span class="free">qs</span><span class="main">)</span><span class="main">)</span> <span class="main">⟷</span>
    list_all <span class="main">(</span>lookup_sem <span class="free">fml</span><span class="main">)</span> <span class="free">signs</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> consistent_sign_vectors_R_def list_all_iff
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> consistent_sign_vec_semantics_R<span class="main">)</span>

<span class="keyword1" id="Renegar_Decision-existential_lookup_sem_R"><span class="command">lemma</span></span> existential_lookup_sem_R<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∈</span> set_fml <span class="free">fml</span> <span class="main">⟹</span> <span class="bound">i</span> <span class="main">&lt;</span> length <span class="free">qs</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"set <span class="free">signs</span> <span class="main">=</span> consistent_sign_vectors_R <span class="free">qs</span> UNIV"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound">x</span><span class="main">::</span>real<span class="main">.</span> lookup_sem <span class="free">fml</span> <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> poly <span class="bound">p</span> <span class="bound">x</span><span class="main">)</span> <span class="free">qs</span><span class="main">)</span><span class="main">)</span> <span class="main">⟷</span>
    find <span class="main">(</span>lookup_sem <span class="free">fml</span><span class="main">)</span> <span class="free">signs</span> <span class="main">≠</span> None"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> consistent_sign_vectors_R_def find_None_iff
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> consistent_sign_vec_semantics_R<span class="main">)</span>

<span class="keyword1" id="Renegar_Decision-decide_univ_lem_helper_R"><span class="command">lemma</span></span> decide_univ_lem_helper_R<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">fml</span><span class="main">::</span> <span class="quoted"><span class="quoted">"real poly fml"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">fml_struct</span><span class="main">,</span><span class="free">polys</span><span class="main">)</span> <span class="main">=</span> convert <span class="free">fml</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">::</span>real<span class="main">.</span> lookup_sem <span class="free">fml_struct</span> <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> poly <span class="bound">p</span> <span class="bound">x</span><span class="main">)</span> <span class="free">polys</span><span class="main">)</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span>decide_universal_R <span class="free">fml</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms universal_lookup_sem_R main_step_R <span class="keyword1"><span class="command">unfolding</span></span> decide_universal_R_def <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> assms convert_closed fst_conv snd_conv<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> assms convert_closed fst_conv snd_conv<span class="main">)</span>

<span class="keyword1" id="Renegar_Decision-decide_exis_lem_helper_R"><span class="command">lemma</span></span> decide_exis_lem_helper_R<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">fml</span><span class="main">::</span> <span class="quoted"><span class="quoted">"real poly fml"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">fml_struct</span><span class="main">,</span><span class="free">polys</span><span class="main">)</span> <span class="main">=</span> convert <span class="free">fml</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound">x</span><span class="main">::</span>real<span class="main">.</span> lookup_sem <span class="free">fml_struct</span> <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> poly <span class="bound">p</span> <span class="bound">x</span><span class="main">)</span> <span class="free">polys</span><span class="main">)</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span>decide_existential_R <span class="free">fml</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms existential_lookup_sem_R main_step_R <span class="keyword1"><span class="command">unfolding</span></span> decide_existential_R_def <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> assms convert_closed fst_conv snd_conv<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> assms convert_closed fst_conv snd_conv<span class="main">)</span>

<span class="keyword1" id="Renegar_Decision-convert_semantics_lem_R"><span class="command">lemma</span></span> convert_semantics_lem_R<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">p</span><span class="main">.</span> <span class="bound">p</span> <span class="main">∈</span> set <span class="main">(</span>poly_list <span class="free">fml</span><span class="main">)</span> <span class="main">⟹</span>
    <span class="free">ls</span> <span class="main">!</span> <span class="main">(</span>index_of <span class="free">ps</span> <span class="bound">p</span><span class="main">)</span> <span class="main">=</span> poly <span class="bound">p</span> <span class="free">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"real_sem <span class="free">fml</span> <span class="free">x</span> <span class="main">=</span> lookup_sem <span class="main">(</span>map_fml <span class="main">(</span>index_of <span class="free">ps</span><span class="main">)</span> <span class="free">fml</span><span class="main">)</span> <span class="free">ls</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">fml</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Renegar_Decision-convert_semantics_R"><span class="command">lemma</span></span> convert_semantics_R<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"real_sem <span class="free">fml</span> <span class="free">x</span> <span class="main">=</span> lookup_sem <span class="main">(</span>fst <span class="main">(</span>convert <span class="free">fml</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> poly <span class="bound">p</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span>snd <span class="main">(</span>convert <span class="free">fml</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> convert_def Let_def <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> convert_semantics_lem_R<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> index_of_lookup<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> index_of_lookup<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="comment1">(* Main result *)</span>
<span class="keyword1"><span class="command">theorem</span></span> decision_procedure_R<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">::</span>real<span class="main">.</span> real_sem <span class="free">fml</span> <span class="bound">x</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span>decide_universal_R <span class="free">fml</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">x</span><span class="main">::</span>real<span class="main">.</span> real_sem <span class="free">fml</span> <span class="bound">x</span> <span class="main">⟷</span> <span class="main">(</span>decide_existential_R <span class="free">fml</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span>  convert_semantics_lem_R decide_univ_lem_helper_R <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> convert_semantics_R<span class="main">)</span>   
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> convert_def convert_semantics_R fst_conv snd_conv<span class="main">)</span>  
  <span class="keyword1"><span class="command">using</span></span> convert_semantics_lem_R
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> convert_def convert_semantics_R decide_exis_lem_helper_R fst_conv snd_conv<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div>