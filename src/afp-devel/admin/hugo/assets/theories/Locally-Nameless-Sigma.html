<div id="ListPre">
<div class="head">
<h1>Theory ListPre</h1>
</div>
<pre class="source"><span class="comment1">(*  Title:      ListPre.thy
    Author:     Ludovic Henrio and Florian Kammuller, 2006

List lemmata and other general stuff as preparation for ASP.
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹List features›</span></span>

<span class="keyword1"><span class="command">theory</span></span> ListPre
<span class="keyword2"><span class="keyword">imports</span></span> <a href="https://www.cl.cam.ac.uk/research/hvg/Isabelle/dist/library/HOL/HOL/Main.html">Main</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="ListPre-drop_lem"><span class="command">lemma</span></span> drop_lem<span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span><span class="main">:</span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">n</span> <span class="main">::</span> <span class="quoted">nat</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">l</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">g</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"drop <span class="free">n</span> <span class="free">l</span> <span class="main">=</span> drop <span class="free">n</span> <span class="free">g</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"length <span class="free">l</span> <span class="main">=</span> length <span class="free">g</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&lt;</span> length <span class="free">g</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">l</span><span class="main">!</span><span class="free">n</span> <span class="main">=</span> <span class="free">g</span><span class="main">!</span><span class="free">n</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>2-3<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&lt;</span> length <span class="free">l</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> Cons_nth_drop_Suc<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> Cons_nth_drop_Suc<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">]</span> assms<span class="main">(</span>1<span class="main">)</span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">l</span><span class="main">!</span><span class="free">n</span> <span class="main">#</span> drop <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="free">l</span> <span class="main">=</span> <span class="free">g</span><span class="main">!</span><span class="free">n</span> <span class="main">#</span> drop <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="free">g</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="ListPre-mem_append_lem'"><span class="command">lemma</span></span> mem_append_lem'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> set <span class="main">(</span><span class="free">l</span> <span class="main">@</span> <span class="main">[</span><span class="free">y</span><span class="main">]</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">∈</span> set <span class="free">l</span> <span class="main">∨</span> <span class="free">x</span> <span class="main">=</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="ListPre-nth_last"><span class="command">lemma</span></span> nth_last<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">l</span> <span class="main">=</span> <span class="free">n</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">l</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">)</span><span class="main">!</span><span class="free">n</span> <span class="main">=</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="ListPre-take_n"><span class="command">lemma</span></span> take_n<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">n</span> <span class="main">::</span> <span class="quoted">nat</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">l</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">g</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"take <span class="free">n</span> <span class="free">l</span> <span class="main">=</span> take <span class="free">n</span> <span class="free">g</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"Suc <span class="free">n</span> <span class="main">≤</span> length <span class="free">g</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"length <span class="free">l</span> <span class="main">=</span> length <span class="free">g</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"take <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="main">(</span><span class="free">l</span><span class="main">[</span><span class="free">n</span> <span class="main">:=</span> <span class="free">g</span><span class="main">!</span><span class="free">n</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> take <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="free">g</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> ng<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&lt;</span> length <span class="free">g</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">with</span></span> assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> nlupd<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&lt;</span> length <span class="main">(</span><span class="free">l</span><span class="main">[</span><span class="free">n</span> <span class="main">:=</span> <span class="free">g</span><span class="main">!</span><span class="free">n</span><span class="main">]</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">hence</span></span> nl<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&lt;</span> length <span class="free">l</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> 
    sym<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> id_take_nth_drop<span class="main">[</span><span class="operator">OF</span> ng<span class="main">]</span> take_Suc_conv_app_nth<span class="main">[</span><span class="operator">OF</span> nlupd<span class="main">]</span>
    nth_list_update_eq<span class="main">[</span><span class="operator">OF</span> nl<span class="main">]</span> take_Suc_conv_app_nth<span class="main">[</span><span class="operator">OF</span> ng<span class="main">]</span>
    upd_conv_take_nth_drop<span class="main">[</span><span class="operator">OF</span> nl<span class="main">]</span> assms<span class="main">(</span>2-3<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="ListPre-drop_n_lem"><span class="command">lemma</span></span> drop_n_lem<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">n</span> <span class="main">::</span> <span class="quoted">nat</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">l</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"Suc <span class="free">n</span> <span class="main">≤</span> length <span class="free">l</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"drop <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="main">(</span><span class="free">l</span><span class="main">[</span><span class="free">n</span> <span class="main">:=</span> <span class="free">x</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> drop <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="free">l</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&lt;</span> length <span class="free">l</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> 
    upd_conv_take_nth_drop<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> drop_Suc<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="quoted">"<span class="free">l</span><span class="main">[</span><span class="free">n</span> <span class="main">:=</span> <span class="free">x</span><span class="main">]</span>"</span></span><span class="main">]</span> 
    drop_Suc<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="free">l</span></span><span class="main">]</span> assms
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span><span class="main">(</span><span class="operator">subst</span> drop_tl<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="ListPre-drop_n"><span class="command">lemma</span></span> drop_n<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">n</span> <span class="main">::</span> <span class="quoted">nat</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">l</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">g</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"drop <span class="free">n</span> <span class="free">l</span> <span class="main">=</span> drop <span class="free">n</span> <span class="free">g</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"Suc <span class="free">n</span> <span class="main">≤</span> length <span class="free">g</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"length <span class="free">l</span> <span class="main">=</span> length <span class="free">g</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"drop <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="main">(</span><span class="free">l</span><span class="main">[</span><span class="free">n</span> <span class="main">:=</span> <span class="free">g</span><span class="main">!</span><span class="free">n</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> drop <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="free">g</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>2-3<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Suc <span class="free">n</span> <span class="main">≤</span> length <span class="free">l</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> drop_n_lem<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">subst</span> drop_Suc<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">subst</span> drop_tl<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="ListPre-nth_fst"><span class="command">lemma</span></span> nth_fst<span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">l</span> <span class="main">=</span> <span class="free">n</span> <span class="main">+</span> <span class="main">1</span> <span class="main">⟶</span> <span class="main">(</span><span class="free">l</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">)</span><span class="main">!</span><span class="main">0</span> <span class="main">=</span> <span class="free">l</span><span class="main">!</span><span class="main">0</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">l</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>

<span class="keyword1" id="ListPre-nth_zero_app"><span class="command">lemma</span></span> nth_zero_app<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">l</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">x</span> <span class="main">::</span> <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">y</span> <span class="main">::</span> <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">l</span><span class="main">!</span><span class="main">0</span> <span class="main">=</span> <span class="free">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">l</span> <span class="main">@</span> <span class="main">[</span><span class="free">y</span><span class="main">]</span><span class="main">)</span><span class="main">!</span><span class="main">0</span> <span class="main">=</span> <span class="free">x</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">∧</span> <span class="free">l</span><span class="main">!</span><span class="main">0</span> <span class="main">=</span> <span class="free">x</span> <span class="main">⟶</span> <span class="main">(</span><span class="free">l</span> <span class="main">@</span> <span class="main">[</span><span class="free">y</span><span class="main">]</span><span class="main">)</span><span class="main">!</span><span class="main">0</span> <span class="main">=</span> <span class="free">x</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">l</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="ListPre-rev_induct2"><span class="command">lemma</span></span> rev_induct2<span class="main">[</span><span class="operator">consumes</span> 1<span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">xs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">ys</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">P</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> 
  <span class="quoted"><span class="quoted">"length <span class="free">xs</span> <span class="main">=</span> length <span class="free">ys</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">[]</span> <span class="main">[]</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">xs</span> <span class="bound">y</span> <span class="bound">ys</span><span class="main">.</span> <span class="main">⟦</span> length <span class="bound">xs</span> <span class="main">=</span> length <span class="bound">ys</span><span class="main">;</span> <span class="free">P</span> <span class="bound">xs</span> <span class="bound">ys</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span><span class="bound">xs</span> <span class="main">@</span> <span class="main">[</span><span class="bound">x</span><span class="main">]</span><span class="main">)</span> <span class="main">(</span><span class="bound">ys</span> <span class="main">@</span> <span class="main">[</span><span class="bound">y</span><span class="main">]</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">xs</span> <span class="free">ys</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">simplesubst</span> rev_rev_ident<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> lrev<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>rev <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> length <span class="main">(</span>rev <span class="free">ys</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">(</span>rev <span class="main">(</span>rev <span class="free">xs</span><span class="main">)</span><span class="main">)</span><span class="main">(</span>rev <span class="main">(</span>rev <span class="free">ys</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list_induct2<span class="main"><span class="main">[</span></span><span class="operator">OF</span> lrev<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">xs</span> <span class="main">(</span>rev <span class="main">(</span>rev <span class="free">ys</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="ListPre-list_induct3"><span class="command">lemma</span></span> list_induct3<span class="main">:</span> <span class="comment1">(* Similar to induction for 2: see ML "thm \"list_induct2\""; *)</span>
  <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">ys</span> <span class="bound">zs</span><span class="main">.</span> <span class="main">⟦</span> length <span class="free">xs</span> <span class="main">=</span> length <span class="bound">ys</span><span class="main">;</span> length <span class="bound">zs</span> <span class="main">=</span> length <span class="free">xs</span><span class="main">;</span> <span class="free">P</span> <span class="main">[]</span> <span class="main">[]</span> <span class="main">[]</span><span class="main">;</span>
              <span class="main">⋀</span><span class="bound">x</span> <span class="bound">xs</span> <span class="bound">y</span> <span class="bound">ys</span> <span class="bound">z</span> <span class="bound">zs</span><span class="main">.</span> <span class="main">⟦</span> length <span class="bound">xs</span> <span class="main">=</span> length <span class="bound">ys</span><span class="main">;</span> 
                                    length <span class="bound">zs</span> <span class="main">=</span> length <span class="bound">xs</span><span class="main">;</span> <span class="free">P</span> <span class="bound">xs</span> <span class="bound">ys</span> <span class="bound">zs</span> <span class="main">⟧</span>
                                 <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span><span class="bound">x</span> <span class="main">#</span> <span class="bound">xs</span><span class="main">)</span><span class="main">(</span><span class="bound">y</span> <span class="main">#</span> <span class="bound">ys</span><span class="main">)</span><span class="main">(</span><span class="bound">z</span> <span class="main">#</span> <span class="bound">zs</span><span class="main">)</span> 
  <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span> <span class="free">xs</span> <span class="bound">ys</span> <span class="bound">zs</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">xs</span> <span class="skolem">ys</span> <span class="skolem">zs</span><span class="main">)</span> 
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹length <span class="main">(</span><span class="skolem">a</span><span class="main">#</span><span class="skolem">xs</span><span class="main">)</span> <span class="main">=</span> length <span class="skolem">ys</span>›</span></span> <span class="quoted"><span class="quoted">‹length <span class="skolem">zs</span> <span class="main">=</span> length <span class="main">(</span><span class="skolem">a</span><span class="main">#</span><span class="skolem">xs</span><span class="main">)</span>›</span></span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ys</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">∧</span> <span class="skolem">zs</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">b</span></span> <span class="skolem"><span class="skolem">ly</span></span> <span class="skolem"><span class="skolem">c</span></span> <span class="skolem"><span class="skolem">lz</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ys</span> <span class="main">=</span> <span class="skolem">b</span><span class="main">#</span><span class="skolem">ly</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">zs</span> <span class="main">=</span> <span class="skolem">c</span><span class="main">#</span><span class="skolem">lz</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> neq_Nil_conv<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹length <span class="main">(</span><span class="skolem">a</span><span class="main">#</span><span class="skolem">xs</span><span class="main">)</span> <span class="main">=</span> length <span class="skolem">ys</span>›</span></span> <span class="quoted"><span class="quoted">‹length <span class="skolem">zs</span> <span class="main">=</span> length <span class="main">(</span><span class="skolem">a</span><span class="main">#</span><span class="skolem">xs</span><span class="main">)</span>›</span></span> 
  <span class="keyword3"><span class="command">obtain</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">xs</span> <span class="main">=</span> length <span class="skolem">ly</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">lz</span> <span class="main">=</span> length <span class="skolem">xs</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> 
    Cons<span class="main">(</span>5<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> this Cons<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">OF</span> this <span class="quoted"><span class="quoted">‹<span class="free">P</span> <span class="main">[]</span> <span class="main">[]</span> <span class="main">[]</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span> 
    Cons<span class="main">(</span>5<span class="main">)</span> <span class="quoted"><span class="quoted">‹<span class="skolem">ys</span> <span class="main">=</span> <span class="skolem">b</span><span class="main">#</span><span class="skolem">ly</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">zs</span> <span class="main">=</span> <span class="skolem">c</span><span class="main">#</span><span class="skolem">lz</span>›</span></span> 
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">list_insert</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list <span class="main">⇒</span> nat <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">list_insert</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">ah</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">as</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">=</span> 
  <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="keyword1">of</span> 
        <span class="main">0</span>      <span class="main">⇒</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">ah</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">as</span></span></span>
       <span class="main">|</span>Suc <span class="bound">j</span>  <span class="main">⇒</span> <span class="free"><span class="bound"><span class="entity">ah</span></span></span><span class="main">#</span><span class="main">(</span><span class="free">list_insert</span> <span class="free"><span class="bound"><span class="entity">as</span></span></span> <span class="bound">j</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">|</span>

  <span class="quoted"><span class="quoted">"<span class="free">list_insert</span> <span class="main">[]</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">=</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">]</span>"</span></span>

<span class="keyword1" id="ListPre-insert_eq"><span class="command">lemma</span></span> insert_eq<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">i</span></span><span class="main">≤</span>length <span class="free">l</span><span class="main">.</span> <span class="main">(</span>list_insert <span class="free">l</span> <span class="bound">i</span> <span class="free">a</span><span class="main">)</span><span class="main">!</span><span class="bound">i</span> <span class="main">=</span> <span class="free">a</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">l</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> strip<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> nat.split<span class="main">)</span>

<span class="keyword1" id="ListPre-insert_gt"><span class="command">lemma</span></span> insert_gt<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">i</span></span><span class="main">≤</span>length <span class="free">l</span><span class="main">.</span> <span class="main">∀</span><span class="bound"><span class="bound">j</span></span><span class="main">&lt;</span><span class="bound">i</span><span class="main">.</span> <span class="main">(</span>list_insert  <span class="free">l</span> <span class="bound">i</span> <span class="free">a</span><span class="main">)</span><span class="main">!</span><span class="bound">j</span> <span class="main">=</span> <span class="free">l</span><span class="main">!</span><span class="bound">j</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">l</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">x</span> <span class="skolem">l</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> nat.split<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">n</span> <span class="skolem">j</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">≤</span> length <span class="skolem">l</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> Suc <span class="skolem">n</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> Cons<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x</span><span class="main">#</span><span class="main">(</span>list_insert <span class="skolem">l</span> <span class="skolem">n</span> <span class="free">a</span><span class="main">)</span><span class="main">)</span><span class="main">!</span><span class="skolem">j</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">x</span><span class="main">#</span><span class="skolem">l</span><span class="main">)</span><span class="main">!</span><span class="skolem">j</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">j</span></span><span class="main">)</span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="ListPre-insert_lt"><span class="command">lemma</span></span> insert_lt<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">j</span></span><span class="main">≤</span>length <span class="free">l</span><span class="main">.</span> <span class="main">∀</span><span class="bound"><span class="bound">i</span></span><span class="main">≤</span><span class="bound">j</span><span class="main">.</span> <span class="main">(</span>list_insert <span class="free">l</span> <span class="bound">i</span> <span class="free">a</span><span class="main">)</span><span class="main">!</span>Suc <span class="bound">j</span> <span class="main">=</span> <span class="free">l</span><span class="main">!</span><span class="bound">j</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">l</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">x</span> <span class="skolem">l</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> nat.split<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">n</span> <span class="skolem">j</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">≤</span> Suc <span class="main">(</span>length <span class="skolem">l</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">n</span> <span class="main">≤</span> <span class="skolem">j</span>"</span></span> 
    <span class="keyword1"><span class="command">with</span></span> Cons<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>list_insert <span class="skolem">l</span> <span class="skolem">n</span> <span class="free">a</span><span class="main">)</span><span class="main">!</span><span class="skolem">j</span> <span class="main">=</span> <span class="skolem">l</span><span class="main">!</span><span class="main">(</span><span class="skolem">j</span> <span class="main">-</span> Suc <span class="main">0</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">j</span></span><span class="main">)</span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="ListPre-insert_first"><span class="command">lemma</span></span> insert_first<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"list_insert <span class="free">l</span> <span class="main">0</span> <span class="free">b</span> <span class="main">=</span> <span class="free">b</span><span class="main">#</span><span class="free">l</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">l</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>

<span class="keyword1" id="ListPre-insert_prepend"><span class="command">lemma</span></span> insert_prepend<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">=</span> Suc <span class="free">j</span> <span class="main">⟹</span> list_insert <span class="main">(</span><span class="free">a</span><span class="main">#</span><span class="free">l</span><span class="main">)</span> <span class="free">i</span> <span class="free">b</span> <span class="main">=</span> <span class="free">a</span> <span class="main">#</span> list_insert <span class="free">l</span> <span class="free">j</span> <span class="free">b</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="ListPre-insert_lt2"><span class="command">lemma</span></span> insert_lt2<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">j</span><span class="main">.</span> <span class="main">∀</span><span class="bound"><span class="bound">i</span></span><span class="main">≤</span><span class="bound">j</span><span class="main">.</span> <span class="main">(</span>list_insert  <span class="free">l</span> <span class="bound">i</span> <span class="free">a</span><span class="main">)</span><span class="main">!</span>Suc <span class="bound">j</span> <span class="main">=</span> <span class="free">l</span><span class="main">!</span><span class="bound">j</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">l</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">x</span> <span class="skolem">l</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> nat.split<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">n</span> <span class="skolem">j</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">n</span> <span class="main">≤</span> <span class="skolem">j</span>"</span></span> 
    <span class="keyword1"><span class="command">with</span></span> Cons<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>list_insert <span class="skolem">l</span> <span class="skolem">n</span> <span class="free">a</span><span class="main">)</span><span class="main">!</span><span class="skolem">j</span> <span class="main">=</span> <span class="skolem">l</span><span class="main">!</span><span class="main">(</span><span class="skolem">j</span> <span class="main">-</span> Suc <span class="main">0</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">j</span></span><span class="main">)</span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="ListPre-insert_commute"><span class="command">lemma</span></span> insert_commute<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">i</span></span><span class="main">≤</span>length <span class="free">l</span><span class="main">.</span> <span class="main">(</span>list_insert <span class="main">(</span>list_insert <span class="free">l</span> <span class="bound">i</span> <span class="free">b</span><span class="main">)</span> <span class="main">0</span> <span class="free">a</span><span class="main">)</span> <span class="main">=</span>
                 <span class="main">(</span>list_insert <span class="main">(</span>list_insert <span class="free">l</span> <span class="main">0</span> <span class="free">a</span> <span class="main">)</span> <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span> <span class="free">b</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">l</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> nat.split<span class="main">)</span>

<span class="keyword1" id="ListPre-insert_length'"><span class="command">lemma</span></span> insert_length'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span> <span class="bound">x</span><span class="main">.</span> length <span class="main">(</span>list_insert <span class="free">l</span> <span class="bound">i</span> <span class="bound">x</span><span class="main">)</span> <span class="main">=</span> length <span class="main">(</span><span class="bound">x</span><span class="main">#</span><span class="free">l</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">l</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> nat.split<span class="main">)</span>

<span class="keyword1" id="ListPre-insert_length"><span class="command">lemma</span></span> insert_length<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>list_insert <span class="free">l</span> <span class="free">i</span> <span class="free">b</span><span class="main">)</span> <span class="main">=</span> length <span class="main">(</span>list_insert <span class="free">l</span> <span class="free">j</span> <span class="free">c</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> insert_length'<span class="main">)</span>

<span class="keyword1" id="ListPre-insert_select"><span class="command">lemma</span></span> insert_select<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"the <span class="main">(</span><span class="main">(</span><span class="free">f</span><span class="main">(</span><span class="free">l</span> <span class="main">↦</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span> <span class="free">l</span><span class="main">)</span> <span class="main">=</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="ListPre-dom_insert"><span class="command">lemma</span></span> dom_insert<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">∈</span> dom <span class="free">f</span> <span class="main">⟹</span> dom <span class="main">(</span><span class="free">f</span><span class="main">(</span><span class="free">l</span> <span class="main">↦</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> dom <span class="free">f</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="ListPre-insert_select2"><span class="command">lemma</span></span> insert_select2<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">l1</span> <span class="main">≠</span> <span class="free">l2</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">(</span><span class="free">f</span><span class="main">(</span><span class="free">l1</span> <span class="main">↦</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span> <span class="free">l2</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">f</span> <span class="free">l2</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="ListPre-the_insert_select"><span class="command">lemma</span></span> the_insert_select<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">l2</span> <span class="main">∈</span> dom <span class="free">f</span><span class="main">;</span> <span class="free">l1</span> <span class="main">≠</span> <span class="free">l2</span> <span class="main">⟧</span> <span class="main">⟹</span>  the <span class="main">(</span><span class="main">(</span><span class="free">f</span><span class="main">(</span><span class="free">l1</span> <span class="main">↦</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span> <span class="free">l2</span><span class="main">)</span> <span class="main">=</span>  the <span class="main">(</span><span class="free">f</span> <span class="free">l2</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="ListPre-insert_dom_eq"><span class="command">lemma</span></span> insert_dom_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"dom <span class="free">f</span> <span class="main">=</span> dom <span class="free">f'</span> <span class="main">⟹</span> dom <span class="main">(</span><span class="free">f</span><span class="main">(</span><span class="free">l</span> <span class="main">↦</span> <span class="free">x</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> dom <span class="main">(</span><span class="free">f'</span><span class="main">(</span><span class="free">l</span> <span class="main">↦</span> <span class="free">x'</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="ListPre-insert_dom_less_eq"><span class="command">lemma</span></span> insert_dom_less_eq<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">x</span> <span class="main">∉</span> dom <span class="free">f</span><span class="main">;</span> <span class="free">x</span> <span class="main">∉</span> dom <span class="free">f'</span><span class="main">;</span> dom <span class="main">(</span><span class="free">f</span><span class="main">(</span><span class="free">x</span> <span class="main">↦</span> <span class="free">y</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> dom <span class="main">(</span><span class="free">f'</span><span class="main">(</span><span class="free">x</span> <span class="main">↦</span> <span class="free">y'</span><span class="main">)</span><span class="main">)</span> <span class="main">⟧</span> 
  <span class="main">⟹</span> dom <span class="free">f</span> <span class="main">=</span> dom <span class="free">f'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="ListPre-one_more_dom"><span class="command">lemma</span></span> one_more_dom<span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">l</span><span class="main">∈</span>dom <span class="free">f</span> <span class="main">.</span> <span class="main">∃</span><span class="bound">f'</span><span class="main">.</span> <span class="free">f</span> <span class="main">=</span> <span class="bound">f'</span><span class="main">(</span><span class="bound">l</span> <span class="main">↦</span> the<span class="main">(</span><span class="free">f</span> <span class="bound">l</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">l</span> <span class="main">∉</span> dom <span class="bound">f'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">l</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">∈</span> dom <span class="free">f</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">la</span><span class="main">.</span> <span class="free">f</span> <span class="bound">la</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">la</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">la</span> <span class="main">=</span> <span class="skolem">l</span> <span class="keyword1">then</span> None <span class="keyword1">else</span> <span class="free">f</span> <span class="bound">la</span><span class="main">)</span><span class="main">(</span><span class="skolem">l</span> <span class="main">↦</span> the <span class="main">(</span><span class="free">f</span> <span class="skolem">l</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="bound">la</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">la</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">la</span> <span class="main">=</span> <span class="skolem">l</span> <span class="keyword1">then</span> None <span class="keyword1">else</span> <span class="free">f</span> <span class="bound">la</span><span class="main">)</span><span class="main">(</span><span class="skolem">l</span> <span class="main">↦</span> the <span class="main">(</span><span class="free">f</span> <span class="skolem">l</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">f'</span><span class="main">.</span> <span class="free">f</span> <span class="main">=</span> <span class="bound">f'</span><span class="main">(</span><span class="skolem">l</span> <span class="main">↦</span> the<span class="main">(</span><span class="free">f</span> <span class="skolem">l</span><span class="main">)</span> <span class="main">)</span> <span class="main">∧</span> <span class="skolem">l</span> <span class="main">∉</span> dom <span class="bound">f'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>
 
<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="FMap">
<div class="head">
<h1>Theory FMap</h1>
</div>
<pre class="source"><span class="comment1">(*  Title:      FMap.thy
    Author:     Ludovic Henrio and Florian Kammuller, 2006

Finite maps for Sigma-calculus
Idea use axiomatic type classes to preserve
usability of datatype afterwards, i.e. definition
of an object as a finite map of labels to fields in
a datatype.
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Finite maps with axclasses›</span></span>

<span class="keyword1"><span class="command">theory</span></span> FMap <span class="keyword2"><span class="keyword">imports</span></span> <a href="#ListPre">ListPre</a> <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> fmap <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">::</span> finite<span class="main">)</span> <span class="main">⇀</span> <span class="tfree">'b</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">-~&gt;</span>"</span> 50<span class="main">)</span>

<span class="keyword1"><span class="command">class</span></span> inftype <span class="main">=</span>
<span class="keyword2"><span class="keyword">assumes</span></span> infinite<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>finite UNIV"</span></span>

<span class="keyword1"><span class="command">theorem</span></span> fset_induct<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">{}</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">⋀</span><span class="bound">x</span> <span class="main">(</span><span class="bound">F</span><span class="main">::</span><span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>finite<span class="main">)</span>set<span class="main">)</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∉</span> <span class="bound">F</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">F</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span>insert <span class="bound">x</span> <span class="bound">F</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">P</span> <span class="free">F</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule_tac</span> P<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">P</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> F<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">F</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> finite_induct<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> finite_subset<span class="main">[</span><span class="operator">OF</span> subset_UNIV<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">F</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">{}</span>"</span></span> <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">F</span> 
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">F</span><span class="main">.</span> <span class="main">⟦</span> <span class="bound">x</span> <span class="main">∉</span> <span class="bound">F</span><span class="main">;</span> <span class="free">P</span> <span class="bound">F</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span>insert <span class="bound">x</span> <span class="bound">F</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> <span class="skolem">F</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="skolem">F</span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">(</span>insert <span class="skolem">x</span> <span class="skolem">F</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">theorem</span></span> fmap_unique<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> <span class="free">y</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">f</span><span class="main">::</span><span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'b</span><span class="main">)</span>fmap<span class="main">)</span> <span class="free">x</span> <span class="main">=</span> <span class="free">f</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule</span> ssubst<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> refl<span class="main">)</span>

<span class="keyword1"><span class="command">theorem</span></span> fmap_case<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">F</span><span class="main">::</span><span class="main">(</span><span class="tfree">'a</span> <span class="main">-~&gt;</span> <span class="tfree">'b</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Map.empty <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound">x</span> <span class="bound">y</span> <span class="main">(</span><span class="bound">F'</span><span class="main">::</span><span class="main">(</span><span class="tfree">'a</span> <span class="main">-~&gt;</span> <span class="tfree">'b</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> <span class="free">F</span> <span class="main">=</span> <span class="bound">F'</span><span class="main">(</span><span class="bound">x</span> <span class="main">↦</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">F</span> <span class="main">=</span> Map.empty"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> disjI1<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="free">F</span> <span class="main">≠</span> Map.empty›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">x</span><span class="main">.</span> <span class="free">F</span> <span class="bound">x</span> <span class="main">≠</span> None"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> contrapos_np<span class="main">)</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="main">∃</span><span class="bound">x</span><span class="main">.</span> <span class="free">F</span> <span class="bound">x</span> <span class="main">≠</span> None<span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="free">F</span> <span class="bound">x</span> <span class="main">=</span> None"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="free">F</span> <span class="bound">x</span> <span class="main">=</span> None"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">F</span> <span class="main">=</span> Map.empty"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">x</span> <span class="bound">y</span> <span class="bound">F'</span><span class="main">.</span> <span class="free">F</span> <span class="main">=</span> <span class="bound">F'</span><span class="main">(</span><span class="bound">x</span> <span class="main">↦</span> <span class="bound">y</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">F</span> <span class="skolem">x</span> <span class="main">≠</span> None"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">y</span><span class="main">.</span> <span class="free">F</span> <span class="bound">y</span> <span class="main">=</span> <span class="main">(</span><span class="free">F</span><span class="main">(</span><span class="skolem">x</span> <span class="main">↦</span> the <span class="main">(</span><span class="free">F</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="bound">y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">F</span> <span class="main">=</span> <span class="free">F</span><span class="main">(</span><span class="skolem">x</span> <span class="main">↦</span> the <span class="main">(</span><span class="free">F</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(* define the witness as a constant function so it may be used in the proof of
the induction scheme below *)</span>
<span class="keyword1"><span class="command">definition</span></span>  
  <span class="entity">set_fmap</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">-~&gt;</span> <span class="tfree">'b</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">*</span> <span class="tfree">'b</span><span class="main">)</span>set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">set_fmap</span> <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="main">=</span> <span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> dom <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="bound">x</span> <span class="main">=</span> Some <span class="bound">y</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">pred_set_fmap</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="tfree">'a</span> <span class="main">-~&gt;</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="main">(</span><span class="tfree">'a</span> <span class="main">*</span> <span class="tfree">'b</span><span class="main">)</span>set<span class="main">)</span> <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">pred_set_fmap</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">S</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">x</span> <span class="main">∈</span> fst <span class="main">`</span> <span class="bound">S</span> 
                                  <span class="keyword1">then</span> <span class="main">(</span><span class="keyword1">THE</span> <span class="bound">y</span><span class="main">.</span> <span class="main">(</span><span class="main">∃</span><span class="bound">z</span><span class="main">.</span> <span class="bound">y</span> <span class="main">=</span> Some <span class="bound">z</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">z</span><span class="main">)</span> <span class="main">∈</span> <span class="bound">S</span><span class="main">)</span><span class="main">)</span> 
                                  <span class="keyword1">else</span> None<span class="main">)</span><span class="main">)</span>"</span></span> 

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">fmap_minus_direct</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">(</span><span class="tfree">'a</span> <span class="main">-~&gt;</span> <span class="tfree">'b</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">*</span> <span class="tfree">'b</span><span class="main">)</span><span class="main">]</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">-~&gt;</span> <span class="tfree">'b</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">--</span>"</span> 50<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="main"><span class="free">--</span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">z</span><span class="main">.</span> <span class="keyword1">if</span> <span class="main">(</span>fst <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="bound">z</span> <span class="main">∧</span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="main">(</span>fst <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span>snd <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span> 
                   <span class="keyword1">then</span> None 
                   <span class="keyword1">else</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="bound">z</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="FMap-insert_lem"><span class="command">lemma</span></span> insert_lem <span class="main">:</span> <span class="quoted"><span class="quoted">"insert <span class="free">x</span> <span class="free">A</span> <span class="main">=</span> <span class="free">B</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">∈</span> <span class="free">B</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="FMap-fmap_minus_fmap"><span class="command">lemma</span></span> fmap_minus_fmap<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">F</span> <span class="free">x</span> <span class="free">a</span> <span class="free">b</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">F</span> <span class="main">--</span> <span class="free">x</span><span class="main">)</span> <span class="free">a</span> <span class="main">=</span> Some <span class="free">b</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">F</span> <span class="free">a</span> <span class="main">=</span> Some <span class="free">b</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">F</span> <span class="free">a</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> None <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∉</span> dom <span class="free">F</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">F</span> <span class="main">--</span> <span class="free">x</span><span class="main">)</span> <span class="free">a</span> <span class="main">=</span> None"</span></span> 
    <span class="keyword1"><span class="command">unfolding</span></span> fmap_minus_direct_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="free">F</span> <span class="main">--</span> <span class="free">x</span><span class="main">)</span> <span class="free">a</span> <span class="main">=</span> Some <span class="free">b</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">F</span> <span class="free">a</span> <span class="main">≠</span> Some <span class="free">b</span>"</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Some <span class="skolem">y</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="quoted">False</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"fst <span class="free">x</span> <span class="main">=</span> <span class="free">a</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True <span class="keyword3"><span class="command">thus</span></span> <span class="quoted">False</span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"snd <span class="free">x</span> <span class="main">=</span> <span class="skolem">y</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="free">F</span> <span class="free">a</span> <span class="main">=</span> Some <span class="skolem">y</span>›</span></span> <span class="quoted"><span class="quoted">‹fst <span class="free">x</span> <span class="main">=</span> <span class="free">a</span>›</span></span> 
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">F</span> <span class="main">--</span> <span class="free">x</span><span class="main">)</span> <span class="free">a</span> <span class="main">=</span> None"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> fmap_minus_direct_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="free">F</span> <span class="main">--</span> <span class="free">x</span><span class="main">)</span> <span class="free">a</span> <span class="main">=</span> Some <span class="free">b</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="free">F</span> <span class="free">a</span> <span class="main">=</span> Some <span class="skolem">y</span>›</span></span> <span class="quoted"><span class="quoted">‹fst <span class="free">x</span> <span class="main">=</span> <span class="free">a</span>›</span></span> 
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">F</span> <span class="main">(</span>fst <span class="free">x</span><span class="main">)</span> <span class="main">≠</span> Some <span class="main">(</span>snd <span class="free">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="free">F</span> <span class="main">--</span> <span class="free">x</span><span class="main">)</span> <span class="free">a</span> <span class="main">=</span> Some <span class="free">b</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">F</span> <span class="free">a</span> <span class="main">=</span> Some <span class="free">b</span>"</span></span> 
        <span class="keyword1"><span class="command">unfolding</span></span> fmap_minus_direct_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="free">F</span> <span class="free">a</span> <span class="main">≠</span> Some <span class="free">b</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="free">F</span> <span class="main">--</span> <span class="free">x</span><span class="main">)</span> <span class="free">a</span> <span class="main">=</span> Some <span class="free">b</span>›</span></span> 
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">F</span> <span class="free">a</span> <span class="main">=</span> Some <span class="free">b</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> fmap_minus_direct_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="free">F</span> <span class="free">a</span> <span class="main">≠</span> Some <span class="free">b</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="FMap-set_fmap_minus_iff"><span class="command">lemma</span></span> set_fmap_minus_iff<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"set_fmap <span class="main">(</span><span class="main">(</span><span class="free">F</span><span class="main">::</span><span class="main">(</span><span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>finite<span class="main">)</span> <span class="main">-~&gt;</span> <span class="tfree">'b</span><span class="main">)</span><span class="main">)</span> <span class="main">--</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> set_fmap <span class="free">F</span> <span class="main">-</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> set_fmap_def 
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span> <span class="skolem">b</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">F</span> <span class="main">--</span> <span class="free">x</span><span class="main">)</span> <span class="skolem">a</span> <span class="main">=</span> Some <span class="skolem">b</span>"</span></span> <span class="keyword1"><span class="command">from</span></span> fmap_minus_fmap<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">y</span><span class="main">.</span> <span class="free">F</span> <span class="skolem">a</span> <span class="main">=</span> Some <span class="bound">y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span> <span class="skolem">b</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">F</span> <span class="main">--</span> <span class="free">x</span><span class="main">)</span> <span class="skolem">a</span> <span class="main">=</span> Some <span class="skolem">b</span>"</span></span> <span class="keyword1"><span class="command">from</span></span> fmap_minus_fmap<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">F</span> <span class="skolem">a</span> <span class="main">=</span> Some <span class="skolem">b</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">assumption</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span> <span class="skolem">b</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">F</span> <span class="main">--</span> <span class="main">(</span><span class="skolem">a</span><span class="main">,</span> <span class="skolem">b</span><span class="main">)</span><span class="main">)</span> <span class="skolem">a</span> <span class="main">=</span> Some <span class="skolem">b</span>"</span></span> 
  <span class="keyword1"><span class="command">with</span></span> fmap_minus_fmap<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> 
    <span class="keyword1"><span class="command">unfolding</span></span> fmap_minus_direct_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span> <span class="skolem">b</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">a</span><span class="main">,</span><span class="skolem">b</span><span class="main">)</span> <span class="main">≠</span> <span class="free">x</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">F</span> <span class="skolem">a</span> <span class="main">=</span> Some <span class="skolem">b</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"fst <span class="free">x</span> <span class="main">≠</span> <span class="skolem">a</span> <span class="main">∨</span> <span class="free">F</span> <span class="main">(</span>fst <span class="free">x</span><span class="main">)</span> <span class="main">≠</span> Some <span class="main">(</span>snd <span class="free">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="free">F</span> <span class="skolem">a</span> <span class="main">=</span> Some <span class="skolem">b</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">y</span><span class="main">.</span> <span class="main">(</span><span class="free">F</span> <span class="main">--</span> <span class="free">x</span><span class="main">)</span> <span class="skolem">a</span> <span class="main">=</span> Some <span class="bound">y</span>"</span></span> 
    <span class="keyword1"><span class="command">unfolding</span></span> fmap_minus_direct_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="skolem">b</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span> <span class="skolem">b</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">a</span><span class="main">,</span><span class="skolem">b</span><span class="main">)</span> <span class="main">≠</span> <span class="free">x</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">F</span> <span class="skolem">a</span> <span class="main">=</span> Some <span class="skolem">b</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"fst <span class="free">x</span> <span class="main">≠</span> <span class="skolem">a</span> <span class="main">∨</span> <span class="free">F</span> <span class="main">(</span>fst <span class="free">x</span><span class="main">)</span> <span class="main">≠</span> Some <span class="main">(</span>snd <span class="free">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="free">F</span> <span class="skolem">a</span> <span class="main">=</span> Some <span class="skolem">b</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">F</span> <span class="main">--</span> <span class="free">x</span><span class="main">)</span> <span class="skolem">a</span> <span class="main">=</span> Some <span class="skolem">b</span>"</span></span> 
    <span class="keyword1"><span class="command">unfolding</span></span> fmap_minus_direct_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>  
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="FMap-set_fmap_minus_insert"><span class="command">lemma</span></span> set_fmap_minus_insert<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">F</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>finite <span class="main">*</span> <span class="tfree">'b</span><span class="main">)</span>set"</span></span> <span class="keyword2"><span class="keyword">and</span></span>  <span class="free">F'</span><span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>finite<span class="main">)</span> <span class="main">-~&gt;</span> <span class="tfree">'b</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">x</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> <span class="free">F</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"insert <span class="free">x</span> <span class="free">F</span> <span class="main">=</span> set_fmap <span class="free">F'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">F</span> <span class="main">=</span> set_fmap <span class="main">(</span><span class="free">F'</span> <span class="main">--</span> <span class="free">x</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="free">x</span> <span class="main">∉</span> <span class="free">F</span>›</span></span> sym<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹insert <span class="free">x</span> <span class="free">F</span> <span class="main">=</span> set_fmap <span class="free">F'</span>›</span></span><span class="main">]</span> set_fmap_minus_iff<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">F'</span></span> <span class="quoted"><span class="free">x</span></span><span class="main">]</span> 
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="FMap-notin_fmap_minus"><span class="command">lemma</span></span> notin_fmap_minus<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> set_fmap <span class="main">(</span><span class="main">(</span><span class="free">F</span><span class="main">::</span><span class="main">(</span><span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>finite<span class="main">)</span> <span class="main">-~&gt;</span> <span class="tfree">'b</span><span class="main">)</span><span class="main">)</span> <span class="main">--</span> <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> set_fmap_minus_iff<span class="main">)</span>

<span class="keyword1" id="FMap-fst_notin_fmap_minus_dom"><span class="command">lemma</span></span> fst_notin_fmap_minus_dom<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">F</span> <span class="free">x</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">F'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>finite<span class="main">)</span> <span class="main">-~&gt;</span> <span class="tfree">'b</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"insert <span class="free">x</span> <span class="free">F</span> <span class="main">=</span> set_fmap <span class="free">F'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"fst <span class="free">x</span> <span class="main">∉</span> dom <span class="main">(</span><span class="free">F'</span> <span class="main">--</span> <span class="free">x</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">y</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">F'</span> <span class="main">--</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span>fst <span class="free">x</span><span class="main">)</span> <span class="main">=</span> Some <span class="skolem">y</span>"</span></span>
  <span class="keyword1"><span class="command">with</span></span> notin_fmap_minus<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">F'</span></span><span class="main">]</span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">≠</span> snd <span class="free">x</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> set_fmap_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">from</span></span> insert_lem<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹insert <span class="free">x</span> <span class="free">F</span> <span class="main">=</span> set_fmap <span class="free">F'</span>›</span></span><span class="main">]</span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">F'</span> <span class="main">(</span>fst <span class="free">x</span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span>snd <span class="free">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> set_fmap_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> 
    <span class="keyword1"><span class="command">using</span></span> fmap_minus_fmap<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="free">F'</span> <span class="main">--</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span>fst <span class="free">x</span><span class="main">)</span> <span class="main">=</span> Some <span class="skolem">y</span>›</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="FMap-set_fmap_pair"><span class="command">lemma</span></span>  set_fmap_pair<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> set_fmap <span class="free">F</span> <span class="main">⟹</span> <span class="main">(</span>fst <span class="free">x</span> <span class="main">∈</span> dom <span class="free">F</span> <span class="main">∧</span> snd <span class="free">x</span> <span class="main">=</span> the <span class="main">(</span><span class="free">F</span> <span class="main">(</span>fst <span class="free">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> set_fmap_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="FMap-set_fmap_inv1"><span class="command">lemma</span></span>  set_fmap_inv1<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> fst <span class="free">x</span> <span class="main">∈</span> dom <span class="free">F</span><span class="main">;</span> snd <span class="free">x</span> <span class="main">=</span> the <span class="main">(</span><span class="free">F</span> <span class="main">(</span>fst <span class="free">x</span><span class="main">)</span><span class="main">)</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">F</span> <span class="main">--</span> <span class="free">x</span><span class="main">)</span><span class="main">(</span>fst <span class="free">x</span> <span class="main">↦</span> snd <span class="free">x</span><span class="main">)</span> <span class="main">=</span> <span class="free">F</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">xa</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"fst <span class="free">x</span> <span class="main">∈</span> dom <span class="free">F</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"snd <span class="free">x</span> <span class="main">=</span> the <span class="main">(</span><span class="free">F</span> <span class="main">(</span>fst <span class="free">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free">F</span> <span class="main">--</span> <span class="free">x</span><span class="main">)</span><span class="main">(</span>fst <span class="free">x</span> <span class="main">↦</span> snd <span class="free">x</span><span class="main">)</span><span class="main">)</span> <span class="skolem">xa</span> <span class="main">=</span> <span class="free">F</span> <span class="skolem">xa</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> fmap_minus_direct_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="skolem">xa</span> <span class="main">=</span> fst <span class="free">x</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="FMap-set_fmap_inv2"><span class="command">lemma</span></span> set_fmap_inv2<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"fst <span class="free">x</span> <span class="main">∉</span> dom <span class="free">F</span> <span class="main">⟹</span> insert <span class="free">x</span> <span class="main">(</span>set_fmap <span class="free">F</span><span class="main">)</span> <span class="main">=</span> set_fmap <span class="main">(</span><span class="free">F</span><span class="main">(</span>fst <span class="free">x</span> <span class="main">↦</span> snd <span class="free">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> set_fmap_def
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"fst <span class="free">x</span> <span class="main">∉</span> dom <span class="free">F</span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span>
    <span class="quoted"><span class="quoted">"insert <span class="free">x</span> <span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> dom <span class="free">F</span> <span class="main">∧</span> <span class="free">F</span> <span class="bound">x</span> <span class="main">=</span> Some <span class="bound">y</span><span class="main">}</span> <span class="main">⊆</span> 
    <span class="main">{</span><span class="main">(</span><span class="bound">xa</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="bound">xa</span> <span class="main">∈</span> dom <span class="main">(</span><span class="free">F</span><span class="main">(</span>fst <span class="free">x</span> <span class="main">↦</span> snd <span class="free">x</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="free">F</span><span class="main">(</span>fst <span class="free">x</span> <span class="main">↦</span> snd <span class="free">x</span><span class="main">)</span><span class="main">)</span> <span class="bound">xa</span> <span class="main">=</span> Some <span class="bound">y</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword1"><span class="command">have</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">z</span><span class="main">.</span> <span class="bound">z</span> <span class="main">∈</span> <span class="main">{</span><span class="main">(</span><span class="bound">xa</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="bound">xa</span> <span class="main">∈</span> dom <span class="main">(</span><span class="free">F</span><span class="main">(</span>fst <span class="free">x</span> <span class="main">↦</span> snd <span class="free">x</span><span class="main">)</span><span class="main">)</span> 
                     <span class="main">∧</span> <span class="main">(</span><span class="free">F</span><span class="main">(</span>fst <span class="free">x</span> <span class="main">↦</span> snd <span class="free">x</span><span class="main">)</span><span class="main">)</span> <span class="bound">xa</span> <span class="main">=</span> Some <span class="bound">y</span><span class="main">}</span>
    <span class="main">⟹</span> <span class="bound">z</span> <span class="main">∈</span> insert <span class="free">x</span> <span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> dom <span class="free">F</span> <span class="main">∧</span> <span class="free">F</span> <span class="bound">x</span> <span class="main">=</span> Some <span class="bound">y</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">z</span>
      <span class="keyword3"><span class="command">assume</span></span> 
        z<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">∈</span> <span class="main">{</span><span class="main">(</span><span class="bound">xa</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="bound">xa</span> <span class="main">∈</span> dom <span class="main">(</span><span class="free">F</span><span class="main">(</span>fst <span class="free">x</span> <span class="main">↦</span> snd <span class="free">x</span><span class="main">)</span><span class="main">)</span> 
                     <span class="main">∧</span> <span class="main">(</span><span class="free">F</span><span class="main">(</span>fst <span class="free">x</span> <span class="main">↦</span> snd <span class="free">x</span><span class="main">)</span><span class="main">)</span> <span class="bound">xa</span> <span class="main">=</span> Some <span class="bound">y</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">=</span> <span class="free">x</span> <span class="main">∨</span> <span class="main">(</span><span class="main">(</span>fst <span class="skolem">z</span><span class="main">)</span> <span class="main">∈</span> dom <span class="free">F</span> <span class="main">∧</span> <span class="free">F</span> <span class="main">(</span>fst <span class="skolem">z</span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span>snd <span class="skolem">z</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"fst <span class="free">x</span> <span class="main">=</span> fst <span class="skolem">z</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> True <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> z <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> False <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> z <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">∈</span> insert <span class="free">x</span> <span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> dom <span class="free">F</span> <span class="main">∧</span> <span class="free">F</span> <span class="bound">x</span> <span class="main">=</span> Some <span class="bound">y</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">thus</span></span> 
    <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">(</span><span class="bound">xa</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="bound">xa</span> <span class="main">∈</span> dom <span class="main">(</span><span class="free">F</span><span class="main">(</span>fst <span class="free">x</span> <span class="main">↦</span> snd <span class="free">x</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="free">F</span><span class="main">(</span>fst <span class="free">x</span> <span class="main">↦</span> snd <span class="free">x</span><span class="main">)</span><span class="main">)</span> <span class="bound">xa</span> <span class="main">=</span> Some <span class="bound">y</span><span class="main">}</span> <span class="main">⊆</span> 
    insert <span class="free">x</span> <span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> dom <span class="free">F</span> <span class="main">∧</span> <span class="free">F</span> <span class="bound">x</span> <span class="main">=</span> Some <span class="bound">y</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="FMap-rep_fmap_base"><span class="command">lemma</span></span> rep_fmap_base<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">(</span><span class="free">F</span><span class="main">::</span><span class="main">(</span><span class="tfree">'a</span>  <span class="main">-~&gt;</span> <span class="tfree">'b</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>pred_set_fmap <span class="free">P</span><span class="main">)</span><span class="main">(</span>set_fmap <span class="free">F</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> pred_set_fmap_def set_fmap_def
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule_tac</span> f <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="free">P</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> arg_cong<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> 
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="free">F</span> <span class="bound">x</span> <span class="main">=</span> 
         <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">x</span> <span class="main">∈</span> fst <span class="main">`</span> <span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> dom <span class="free">F</span> <span class="main">∧</span> <span class="free">F</span> <span class="bound">x</span> <span class="main">=</span> Some <span class="bound">y</span><span class="main">}</span>
               <span class="keyword1">then</span> <span class="keyword1">THE</span> <span class="bound">y</span><span class="main">.</span> <span class="main">∃</span><span class="bound">z</span><span class="main">.</span> <span class="bound">y</span> <span class="main">=</span> Some <span class="bound">z</span> 
                             <span class="main">∧</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">z</span><span class="main">)</span> <span class="main">∈</span> <span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> dom <span class="free">F</span> <span class="main">∧</span> <span class="free">F</span> <span class="bound">x</span> <span class="main">=</span> Some <span class="bound">y</span><span class="main">}</span>
               <span class="keyword1">else</span> None<span class="main">)</span> <span class="bound">x</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span> <span class="skolem">b</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">F</span> <span class="skolem">a</span> <span class="main">=</span> Some <span class="skolem">b</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃!</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">=</span> Some <span class="skolem">b</span> <span class="main">∧</span> <span class="skolem">a</span> <span class="main">∈</span> dom <span class="free">F</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule_tac</span> a <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="free">F</span> <span class="skolem">a</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> ex1I<span class="main">)</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">F</span> <span class="skolem">a</span> <span class="main">=</span> Some <span class="skolem">b</span>"</span></span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">F</span> <span class="skolem">a</span> <span class="main">=</span> Some <span class="skolem">b</span> <span class="main">∧</span> <span class="skolem">a</span> <span class="main">∈</span> dom <span class="free">F</span>"</span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dom_def<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">F</span> <span class="skolem">a</span> <span class="main">=</span> Some <span class="skolem">b</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> Some <span class="skolem">b</span> <span class="main">∧</span> <span class="skolem">a</span> <span class="main">∈</span> dom <span class="free">F</span>"</span></span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="free">F</span> <span class="skolem">a</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">THE</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">=</span> Some <span class="skolem">b</span> <span class="main">∧</span> <span class="skolem">a</span> <span class="main">∈</span> dom <span class="free">F</span><span class="main">)</span> <span class="main">=</span> Some <span class="skolem">b</span> <span class="main">∧</span> <span class="skolem">a</span> <span class="main">∈</span> dom <span class="free">F</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> theI'<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"Some <span class="skolem">b</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">THE</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">=</span> Some <span class="skolem">b</span> <span class="main">∧</span> <span class="skolem">a</span> <span class="main">∈</span> dom <span class="free">F</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> nin_x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> fst <span class="main">`</span> <span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> dom <span class="free">F</span> <span class="main">∧</span> <span class="free">F</span> <span class="bound">x</span> <span class="main">=</span> Some <span class="bound">y</span><span class="main">}</span>"</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">F</span> <span class="skolem">x</span> <span class="main">=</span> None"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">F</span> <span class="skolem">x</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> None <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">assumption</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Some <span class="skolem">a</span><span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> fst <span class="main">`</span> <span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> dom <span class="free">F</span> <span class="main">∧</span> <span class="free">F</span> <span class="bound">x</span> <span class="main">=</span> Some <span class="bound">y</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> image_def dom_def<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> nin_x <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">thus</span></span> 
    <span class="quoted"><span class="quoted">"<span class="free">F</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">x</span> <span class="main">∈</span> fst <span class="main">`</span> <span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> dom <span class="free">F</span> <span class="main">∧</span> <span class="free">F</span> <span class="bound">x</span> <span class="main">=</span> Some <span class="bound">y</span><span class="main">}</span>
               <span class="keyword1">then</span> <span class="keyword1">THE</span> <span class="bound">y</span><span class="main">.</span> <span class="main">∃</span><span class="bound">z</span><span class="main">.</span> <span class="bound">y</span> <span class="main">=</span> Some <span class="bound">z</span> 
                             <span class="main">∧</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">z</span><span class="main">)</span> <span class="main">∈</span> <span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> dom <span class="free">F</span> <span class="main">∧</span> <span class="free">F</span> <span class="bound">x</span> <span class="main">=</span> Some <span class="bound">y</span><span class="main">}</span>
               <span class="keyword1">else</span> None<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="FMap-rep_fmap"><span class="command">lemma</span></span> rep_fmap<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="main">(</span><span class="bound">Fp</span> <span class="main">::</span><span class="main">(</span><span class="tfree">'a</span> <span class="main">*</span> <span class="tfree">'b</span><span class="main">)</span>set<span class="main">)</span> <span class="main">(</span><span class="bound">P'</span><span class="main">::</span><span class="main">(</span><span class="tfree">'a</span> <span class="main">*</span> <span class="tfree">'b</span><span class="main">)</span>set <span class="main">⇒</span> bool<span class="main">)</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span><span class="free">F</span><span class="main">::</span><span class="main">(</span><span class="tfree">'a</span> <span class="main">-~&gt;</span> <span class="tfree">'b</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="bound">P'</span> <span class="bound">Fp</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> rep_fmap_base <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">theorem</span></span> finite_fsets<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="free">F</span><span class="main">::</span><span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>finite<span class="main">)</span>set<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> finite_subset<span class="main">[</span><span class="operator">OF</span> subset_UNIV<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">F</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="FMap-finite_dom_fmap"><span class="command">lemma</span></span> finite_dom_fmap<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>dom <span class="main">(</span><span class="free">F</span><span class="main">::</span><span class="main">(</span><span class="tfree">'a</span> <span class="main">-~&gt;</span> <span class="tfree">'b</span><span class="main">)</span><span class="main">)</span><span class="main">::</span><span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>finite<span class="main">)</span>set<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> finite_fsets<span class="main">)</span>

<span class="keyword1" id="FMap-finite_fmap_ran"><span class="command">lemma</span></span> finite_fmap_ran<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>ran <span class="main">(</span><span class="free">F</span><span class="main">::</span><span class="main">(</span><span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>finite<span class="main">)</span> <span class="main">-~&gt;</span> <span class="tfree">'b</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> ran_def
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> finite_dom_fmap finite_imageI 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> the <span class="main">(</span><span class="free">F</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> <span class="main">(</span>dom <span class="free">F</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">b</span><span class="main">.</span> <span class="main">∃</span><span class="bound">a</span><span class="main">.</span> <span class="free">F</span> <span class="bound">a</span> <span class="main">=</span> Some <span class="bound">b</span><span class="main">}</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> the <span class="main">(</span><span class="free">F</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> <span class="main">(</span>dom <span class="free">F</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> image_def dom_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="bound">b</span><span class="main">.</span> <span class="main">∃</span><span class="bound">a</span><span class="main">.</span> <span class="free">F</span> <span class="bound">a</span> <span class="main">=</span> Some <span class="bound">b</span><span class="main">}</span>"</span></span>  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="FMap-finite_fset_map"><span class="command">lemma</span></span> finite_fset_map<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>set_fmap <span class="main">(</span><span class="free">F</span><span class="main">::</span><span class="main">(</span><span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>finite<span class="main">)</span> <span class="main">-~&gt;</span> <span class="tfree">'b</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> finite_cartesian_product<span class="main">[</span><span class="operator">OF</span> finite_dom_fmap finite_fmap_ran<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>dom <span class="free">F</span> <span class="main">×</span> ran <span class="free">F</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set_fmap <span class="free">F</span> <span class="main">⊆</span> dom <span class="free">F</span> <span class="main">×</span> ran <span class="free">F</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> set_fmap_def dom_def ran_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> finite_subset <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="FMap-rep_fmap_imp"><span class="command">lemma</span></span> rep_fmap_imp<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">F</span> <span class="bound">x</span> <span class="bound">z</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∉</span> dom <span class="main">(</span><span class="bound">F</span><span class="main">::</span><span class="main">(</span><span class="tfree">'a</span> <span class="main">-~&gt;</span> <span class="tfree">'b</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span> <span class="free">P</span> <span class="bound">F</span> <span class="main">⟶</span> <span class="free">P</span> <span class="main">(</span><span class="bound">F</span><span class="main">(</span><span class="bound">x</span> <span class="main">↦</span> <span class="bound">z</span><span class="main">)</span><span class="main">)</span>
  <span class="main">⟹</span> <span class="main">(</span><span class="main">∀</span><span class="bound">F</span> <span class="bound">x</span> <span class="bound">z</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∉</span> fst <span class="main">`</span> <span class="main">(</span>set_fmap <span class="bound">F</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">(</span>pred_set_fmap <span class="free">P</span><span class="main">)</span><span class="main">(</span>set_fmap <span class="bound">F</span><span class="main">)</span> 
        <span class="main">⟶</span> <span class="main">(</span>pred_set_fmap <span class="free">P</span><span class="main">)</span> <span class="main">(</span>insert <span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">z</span><span class="main">)</span> <span class="main">(</span>set_fmap <span class="bound">F</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">clarify</span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">P</span> <span class="skolem">F</span> <span class="skolem">x</span> <span class="skolem">z</span>
  <span class="keyword3"><span class="command">assume</span></span> 
    <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">F</span> <span class="bound">x</span> <span class="bound">z</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∉</span> dom <span class="main">(</span><span class="bound">F</span><span class="main">::</span><span class="main">(</span><span class="tfree">'a</span> <span class="main">-~&gt;</span> <span class="tfree">'b</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span> <span class="skolem">P</span> <span class="bound">F</span> <span class="main">⟶</span> <span class="skolem">P</span> <span class="main">(</span><span class="bound">F</span><span class="main">(</span><span class="bound">x</span> <span class="main">↦</span> <span class="bound">z</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> fst <span class="main">`</span> set_fmap <span class="skolem">F</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>pred_set_fmap <span class="skolem">P</span><span class="main">)</span><span class="main">(</span>set_fmap <span class="skolem">F</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> notin<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> dom <span class="skolem">F</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> set_fmap_def image_def dom_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹pred_set_fmap <span class="skolem">P</span> <span class="main">(</span>set_fmap <span class="skolem">F</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="skolem">F</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rep_fmap_base<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main">(</span><span class="skolem">F</span><span class="main">(</span><span class="skolem">x</span> <span class="main">↦</span> <span class="skolem">z</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span><span class="bound">F</span> <span class="bound">x</span> <span class="bound">z</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∉</span> dom <span class="bound">F</span> <span class="main">⟶</span> <span class="skolem">P</span> <span class="bound">F</span> <span class="main">⟶</span> <span class="skolem">P</span> <span class="main">(</span><span class="bound">F</span><span class="main">(</span><span class="bound">x</span> <span class="main">↦</span> <span class="bound">z</span><span class="main">)</span><span class="main">)</span>›</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>pred_set_fmap <span class="skolem">P</span><span class="main">)</span> <span class="main">(</span>set_fmap <span class="main">(</span><span class="skolem">F</span><span class="main">(</span><span class="skolem">x</span> <span class="main">↦</span> <span class="skolem">z</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rep_fmap_base<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">from</span></span> notin 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>insert <span class="main">(</span><span class="skolem">x</span><span class="main">,</span><span class="skolem">z</span><span class="main">)</span> <span class="main">(</span>set_fmap <span class="skolem">F</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>set_fmap <span class="main">(</span><span class="skolem">F</span><span class="main">(</span>fst <span class="main">(</span><span class="skolem">x</span><span class="main">,</span><span class="skolem">z</span><span class="main">)</span> <span class="main">↦</span> snd <span class="main">(</span><span class="skolem">x</span><span class="main">,</span><span class="skolem">z</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> set_fmap_inv2<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>pred_set_fmap <span class="skolem">P</span><span class="main">)</span> <span class="main">(</span>insert <span class="main">(</span><span class="skolem">x</span><span class="main">,</span><span class="skolem">z</span><span class="main">)</span> <span class="main">(</span>set_fmap <span class="skolem">F</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="FMap-empty_dom"><span class="command">lemma</span></span> empty_dom<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">g</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">{}</span> <span class="main">=</span> dom <span class="free">g</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="main">=</span> Map.empty"</span></span>
<span class="keyword1"><span class="command">proof</span></span> 
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="skolem">x</span> <span class="main">=</span> None"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">theorem</span></span> fmap_induct<span class="main">[</span><span class="operator">rule_format</span><span class="main">,</span> <span class="operator">case_names</span> empty insert<span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span>  <span class="free">P</span>  <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="tfree">'a</span> <span class="main">::</span> finite<span class="main">)</span> <span class="main">-~&gt;</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">and</span></span>  <span class="free">F'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span>  <span class="main">-~&gt;</span> <span class="tfree">'b</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">P</span> Map.empty"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="main">(</span><span class="bound">F</span><span class="main">::</span><span class="main">(</span><span class="tfree">'a</span> <span class="main">-~&gt;</span> <span class="tfree">'b</span><span class="main">)</span><span class="main">)</span> <span class="bound">x</span> <span class="bound">z</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∉</span> dom <span class="bound">F</span> <span class="main">⟶</span> <span class="free">P</span> <span class="bound">F</span> <span class="main">⟶</span> <span class="free">P</span> <span class="main">(</span><span class="bound">F</span><span class="main">(</span><span class="bound">x</span> <span class="main">↦</span> <span class="bound">z</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">F'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">F</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'b</span><span class="main">)</span> set"</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"finite <span class="skolem">F</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">F'</span><span class="main">.</span> <span class="skolem">F</span> <span class="main">=</span> set_fmap <span class="bound">F'</span> <span class="main">⟶</span> pred_set_fmap <span class="free">P</span> <span class="main">(</span>set_fmap <span class="bound">F'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">F</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> empty <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> strip<span class="main">)</span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">F'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">-~&gt;</span> <span class="tfree">'b</span>"</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">{}</span> <span class="main">=</span> set_fmap <span class="skolem">F'</span>"</span></span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">a</span><span class="main">.</span> <span class="skolem">F'</span> <span class="bound">a</span> <span class="main">=</span> None"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> set_fmap_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">F'</span> <span class="main">=</span> Map.empty"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main">)</span>
        <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="free">P</span> Map.empty›</span></span> rep_fmap_base<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">P</span></span> <span class="quoted">Map.empty</span><span class="main">]</span> 
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"pred_set_fmap <span class="free">P</span> <span class="main">(</span>set_fmap <span class="skolem">F'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>insert <span class="skolem">x</span> <span class="skolem">Fa</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> strip<span class="main">)</span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">Fb</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">-~&gt;</span> <span class="tfree">'b</span>"</span></span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"insert <span class="skolem">x</span> <span class="skolem">Fa</span> <span class="main">=</span> set_fmap <span class="skolem">Fb</span>"</span></span>
        <span class="keyword1"><span class="command">from</span></span> 
          set_fmap_minus_insert<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∉</span> <span class="skolem">Fa</span>›</span></span> this<span class="main">]</span>
          <span class="quoted"><span class="quoted">‹<span class="main">∀</span><span class="bound">F'</span><span class="main">.</span> <span class="skolem">Fa</span> <span class="main">=</span> set_fmap <span class="bound">F'</span> <span class="main">⟶</span> pred_set_fmap <span class="free">P</span> <span class="main">(</span>set_fmap <span class="bound">F'</span><span class="main">)</span>›</span></span> 
          rep_fmap_base<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">P</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Fb</span> <span class="main">--</span> <span class="skolem">x</span>"</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">(</span><span class="skolem">Fb</span> <span class="main">--</span> <span class="skolem">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">with</span></span> 
          <span class="quoted"><span class="quoted">‹<span class="main">∀</span><span class="bound">F</span> <span class="bound">x</span> <span class="bound">z</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∉</span> dom <span class="bound">F</span> <span class="main">⟶</span> <span class="free">P</span> <span class="bound">F</span> <span class="main">⟶</span> <span class="free">P</span> <span class="main">(</span><span class="bound">F</span><span class="main">(</span><span class="bound">x</span> <span class="main">↦</span> <span class="bound">z</span><span class="main">)</span><span class="main">)</span>›</span></span> 
          fst_notin_fmap_minus_dom<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹insert <span class="skolem">x</span> <span class="skolem">Fa</span> <span class="main">=</span> set_fmap <span class="skolem">Fb</span>›</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">(</span><span class="main">(</span><span class="skolem">Fb</span> <span class="main">--</span> <span class="skolem">x</span><span class="main">)</span><span class="main">(</span>fst <span class="skolem">x</span> <span class="main">↦</span> snd <span class="skolem">x</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">moreover</span></span>
        <span class="keyword1"><span class="command">from</span></span> 
          insert_absorb<span class="main">[</span><span class="operator">OF</span> insert_lem<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹insert <span class="skolem">x</span> <span class="skolem">Fa</span> <span class="main">=</span> set_fmap <span class="skolem">Fb</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span>
          set_fmap_minus_iff<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">Fb</span></span> <span class="quoted"><span class="skolem">x</span></span><span class="main">]</span>
          set_fmap_inv2<span class="main">[</span><span class="operator">OF</span> 
           fst_notin_fmap_minus_dom<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹insert <span class="skolem">x</span> <span class="skolem">Fa</span> <span class="main">=</span> set_fmap <span class="skolem">Fb</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span> 
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set_fmap <span class="skolem">Fb</span> <span class="main">=</span> set_fmap <span class="main">(</span><span class="main">(</span><span class="skolem">Fb</span> <span class="main">--</span> <span class="skolem">x</span><span class="main">)</span><span class="main">(</span>fst <span class="skolem">x</span> <span class="main">↦</span> snd <span class="skolem">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">ultimately</span></span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"pred_set_fmap <span class="free">P</span> <span class="main">(</span>set_fmap <span class="skolem">Fb</span><span class="main">)</span>"</span></span> 
          <span class="keyword1"><span class="command">using</span></span> rep_fmap_base<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">P</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Fb</span> <span class="main">--</span> <span class="skolem">x</span><span class="main">)</span><span class="main">(</span>fst <span class="skolem">x</span> <span class="main">↦</span> snd <span class="skolem">x</span><span class="main">)</span>"</span></span><span class="main">]</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">}</span></span> 
  <span class="keyword1"><span class="command">from</span></span> this<span class="main">[</span><span class="operator">OF</span> finite_fset_map<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free">F'</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span>
       rep_fmap_base<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">P</span></span> <span class="quoted"><span class="free">F'</span></span><span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">F'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="FMap-fmap_induct3"><span class="command">lemma</span></span> fmap_induct3<span class="main">[</span><span class="operator">consumes</span> 2<span class="main">,</span> <span class="operator">case_names</span> empty insert<span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="main">(</span><span class="bound">F2</span><span class="main">::</span><span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>finite<span class="main">)</span> <span class="main">-~&gt;</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">(</span><span class="bound">F3</span><span class="main">::</span><span class="main">(</span><span class="tfree">'a</span> <span class="main">-~&gt;</span> <span class="tfree">'b</span><span class="main">)</span><span class="main">)</span><span class="main">.</span>
   <span class="main">⟦</span> dom <span class="main">(</span><span class="free">F1</span><span class="main">::</span><span class="main">(</span><span class="tfree">'a</span> <span class="main">-~&gt;</span> <span class="tfree">'b</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> dom <span class="bound">F2</span><span class="main">;</span> dom <span class="bound">F3</span> <span class="main">=</span> dom <span class="free">F1</span><span class="main">;</span> 
     <span class="free">P</span> Map.empty Map.empty Map.empty<span class="main">;</span>
     <span class="main">⋀</span><span class="bound">x</span> <span class="bound">a</span> <span class="bound">b</span> <span class="bound">c</span> <span class="main">(</span><span class="bound">F1</span><span class="main">::</span><span class="main">(</span><span class="tfree">'a</span> <span class="main">-~&gt;</span> <span class="tfree">'b</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="bound">F2</span><span class="main">::</span><span class="main">(</span><span class="tfree">'a</span> <span class="main">-~&gt;</span> <span class="tfree">'b</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="bound">F3</span><span class="main">::</span><span class="main">(</span><span class="tfree">'a</span> <span class="main">-~&gt;</span> <span class="tfree">'b</span><span class="main">)</span><span class="main">)</span><span class="main">.</span>
     <span class="main">⟦</span> <span class="free">P</span> <span class="bound">F1</span> <span class="bound">F2</span> <span class="bound">F3</span><span class="main">;</span> dom <span class="bound">F1</span> <span class="main">=</span> dom <span class="bound">F2</span><span class="main">;</span> dom <span class="bound">F3</span> <span class="main">=</span> dom <span class="bound">F1</span><span class="main">;</span> <span class="bound">x</span> <span class="main">∉</span> dom <span class="bound">F1</span> <span class="main">⟧</span>
     <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span><span class="bound">F1</span><span class="main">(</span><span class="bound">x</span> <span class="main">↦</span> <span class="bound">a</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="bound">F2</span><span class="main">(</span><span class="bound">x</span> <span class="main">↦</span> <span class="bound">b</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="bound">F3</span><span class="main">(</span><span class="bound">x</span> <span class="main">↦</span> <span class="bound">c</span><span class="main">)</span><span class="main">)</span> <span class="main">⟧</span>
  <span class="main">⟹</span> <span class="free">P</span> <span class="free">F1</span> <span class="bound">F2</span> <span class="bound">F3</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">F1</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> fmap_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> empty
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹dom Map.empty <span class="main">=</span> dom <span class="skolem">F2</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">F2</span> <span class="main">=</span> Map.empty"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> empty_dom<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹dom <span class="skolem">F3</span> <span class="main">=</span> dom Map.empty›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">F3</span> <span class="main">=</span> Map.empty"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> empty_dom<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">P</span> Map.empty Map.empty Map.empty›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>insert <span class="skolem">F</span> <span class="skolem">x</span> <span class="skolem">y</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">F2</span> <span class="main">=</span> Map.empty"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹dom <span class="main">(</span><span class="skolem">F</span><span class="main">(</span><span class="skolem">x</span> <span class="main">↦</span> <span class="skolem">y</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> dom <span class="skolem">F2</span>›</span></span> 
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"dom <span class="main">(</span><span class="skolem">F</span><span class="main">(</span><span class="skolem">x</span> <span class="main">↦</span> <span class="skolem">y</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">F3</span> <span class="main">=</span> Map.empty"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹dom <span class="skolem">F3</span> <span class="main">=</span> dom <span class="main">(</span><span class="skolem">F</span><span class="main">(</span><span class="skolem">x</span> <span class="main">↦</span> <span class="skolem">y</span><span class="main">)</span><span class="main">)</span>›</span></span> 
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"dom <span class="main">(</span><span class="skolem">F</span><span class="main">(</span><span class="skolem">x</span> <span class="main">↦</span> <span class="skolem">y</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">F2</span> <span class="main">≠</span> Map.empty›</span></span> 
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">l</span><span class="main">∈</span>dom <span class="skolem">F2</span><span class="main">.</span> <span class="main">∃</span><span class="bound">f'</span><span class="main">.</span> <span class="skolem">F2</span> <span class="main">=</span> <span class="bound">f'</span><span class="main">(</span><span class="bound">l</span> <span class="main">↦</span> the <span class="main">(</span><span class="skolem">F2</span> <span class="bound">l</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">l</span> <span class="main">∉</span> dom <span class="bound">f'</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> one_more_dom<span class="main">)</span>
        <span class="keyword1"><span class="command">moreover</span></span>
        <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹dom <span class="main">(</span><span class="skolem">F</span><span class="main">(</span><span class="skolem">x</span> <span class="main">↦</span> <span class="skolem">y</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> dom <span class="skolem">F2</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> dom <span class="skolem">F2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">f'</span><span class="main">.</span> <span class="skolem">F2</span> <span class="main">=</span> <span class="bound">f'</span><span class="main">(</span><span class="skolem">x</span> <span class="main">↦</span> the <span class="main">(</span><span class="skolem">F2</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="skolem">x</span> <span class="main">∉</span> dom <span class="bound">f'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">F2'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">F2</span> <span class="main">=</span> <span class="skolem">F2'</span><span class="main">(</span><span class="skolem">x</span> <span class="main">↦</span> the <span class="main">(</span><span class="skolem">F2</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> dom <span class="skolem">F2'</span>"</span></span> 
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

        <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">F3</span> <span class="main">≠</span> Map.empty›</span></span> 
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">l</span><span class="main">∈</span>dom <span class="skolem">F3</span><span class="main">.</span> <span class="main">∃</span><span class="bound">f'</span><span class="main">.</span> <span class="skolem">F3</span> <span class="main">=</span> <span class="bound">f'</span><span class="main">(</span><span class="bound">l</span> <span class="main">↦</span> the <span class="main">(</span><span class="skolem">F3</span> <span class="bound">l</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">l</span> <span class="main">∉</span> dom <span class="bound">f'</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> one_more_dom<span class="main">)</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹dom <span class="skolem">F3</span> <span class="main">=</span> dom <span class="main">(</span><span class="skolem">F</span><span class="main">(</span><span class="skolem">x</span> <span class="main">↦</span> <span class="skolem">y</span><span class="main">)</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> dom <span class="skolem">F3</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">f'</span><span class="main">.</span> <span class="skolem">F3</span> <span class="main">=</span> <span class="bound">f'</span><span class="main">(</span><span class="skolem">x</span> <span class="main">↦</span> the <span class="main">(</span><span class="skolem">F3</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="skolem">x</span> <span class="main">∉</span> dom <span class="bound">f'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">F3'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">F3</span> <span class="main">=</span> <span class="skolem">F3'</span><span class="main">(</span><span class="skolem">x</span> <span class="main">↦</span> the <span class="main">(</span><span class="skolem">F3</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> dom <span class="skolem">F3'</span>"</span></span> 
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
          <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹dom <span class="main">(</span><span class="skolem">F</span><span class="main">(</span><span class="skolem">x</span> <span class="main">↦</span> <span class="skolem">y</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> dom <span class="skolem">F2</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">F2</span> <span class="main">=</span> <span class="skolem">F2'</span><span class="main">(</span><span class="skolem">x</span> <span class="main">↦</span> the <span class="main">(</span><span class="skolem">F2</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span>›</span></span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"dom <span class="main">(</span><span class="skolem">F</span><span class="main">(</span><span class="skolem">x</span> <span class="main">↦</span> <span class="skolem">y</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> dom <span class="main">(</span><span class="skolem">F2'</span><span class="main">(</span><span class="skolem">x</span> <span class="main">↦</span> the <span class="main">(</span><span class="skolem">F2</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∉</span> dom <span class="skolem">F</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∉</span> dom <span class="skolem">F2'</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"dom <span class="skolem">F</span> <span class="main">=</span> dom <span class="skolem">F2'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          
          <span class="keyword1"><span class="command">moreover</span></span>
          <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹dom <span class="skolem">F3</span> <span class="main">=</span> dom <span class="main">(</span><span class="skolem">F</span><span class="main">(</span><span class="skolem">x</span> <span class="main">↦</span> <span class="skolem">y</span><span class="main">)</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">F3</span> <span class="main">=</span> <span class="skolem">F3'</span><span class="main">(</span><span class="skolem">x</span> <span class="main">↦</span> the <span class="main">(</span><span class="skolem">F3</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span>›</span></span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"dom <span class="main">(</span><span class="skolem">F</span><span class="main">(</span><span class="skolem">x</span> <span class="main">↦</span> <span class="skolem">y</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> dom <span class="main">(</span><span class="skolem">F3'</span><span class="main">(</span><span class="skolem">x</span> <span class="main">↦</span> the <span class="main">(</span><span class="skolem">F3</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∉</span> dom <span class="skolem">F</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∉</span> dom <span class="skolem">F3'</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"dom <span class="skolem">F3'</span> <span class="main">=</span> dom <span class="skolem">F</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

          <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="skolem">F</span> <span class="skolem">F2'</span> <span class="skolem">F3'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> insert <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

          <span class="keyword1"><span class="command">with</span></span> 
            <span class="quoted"><span class="quoted">‹<span class="main">⋀</span><span class="bound">F1</span> <span class="bound">F2</span> <span class="bound">F3</span> <span class="bound">x</span> <span class="bound">a</span> <span class="bound">b</span> <span class="bound">c</span><span class="main">.</span>
              <span class="main">⟦</span> <span class="free">P</span> <span class="bound">F1</span> <span class="bound">F2</span> <span class="bound">F3</span><span class="main">;</span> dom <span class="bound">F1</span> <span class="main">=</span> dom <span class="bound">F2</span><span class="main">;</span> dom <span class="bound">F3</span> <span class="main">=</span> dom <span class="bound">F1</span><span class="main">;</span> <span class="bound">x</span> <span class="main">∉</span> dom <span class="bound">F1</span> <span class="main">⟧</span>
              <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span><span class="bound">F1</span><span class="main">(</span><span class="bound">x</span> <span class="main">↦</span> <span class="bound">a</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="bound">F2</span><span class="main">(</span><span class="bound">x</span> <span class="main">↦</span> <span class="bound">b</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="bound">F3</span><span class="main">(</span><span class="bound">x</span> <span class="main">↦</span> <span class="bound">c</span><span class="main">)</span><span class="main">)</span>›</span></span>
            <span class="quoted"><span class="quoted">‹dom <span class="skolem">F</span> <span class="main">=</span> dom <span class="skolem">F2'</span>›</span></span>
            <span class="quoted"><span class="quoted">‹dom <span class="skolem">F3'</span> <span class="main">=</span> dom <span class="skolem">F</span>›</span></span>
            <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∉</span> dom <span class="skolem">F</span>›</span></span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">(</span><span class="skolem">F</span><span class="main">(</span><span class="skolem">x</span> <span class="main">↦</span> <span class="skolem">y</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">F2'</span><span class="main">(</span><span class="skolem">x</span> <span class="main">↦</span> the <span class="main">(</span><span class="skolem">F2</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">F3'</span><span class="main">(</span><span class="skolem">x</span> <span class="main">↦</span> the <span class="main">(</span><span class="skolem">F3</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> 
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">F2</span> <span class="main">=</span> <span class="skolem">F2'</span><span class="main">(</span><span class="skolem">x</span> <span class="main">↦</span> the <span class="main">(</span><span class="skolem">F2</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">F3</span> <span class="main">=</span> <span class="skolem">F3'</span><span class="main">(</span><span class="skolem">x</span> <span class="main">↦</span> the <span class="main">(</span><span class="skolem">F3</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span>›</span></span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">(</span><span class="skolem">F</span><span class="main">(</span><span class="skolem">x</span> <span class="main">↦</span> <span class="skolem">y</span><span class="main">)</span><span class="main">)</span> <span class="skolem">F2</span> <span class="skolem">F3</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="FMap-fmap_ex_cof2"><span class="command">lemma</span></span> fmap_ex_cof2<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="main">(</span><span class="bound">P</span><span class="main">::</span><span class="tfree">'c</span> <span class="main">⇒</span> <span class="tfree">'c</span> <span class="main">⇒</span> <span class="tfree">'b</span> option <span class="main">⇒</span> <span class="tfree">'b</span> option <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> bool<span class="main">)</span>
     <span class="main">(</span><span class="bound">f'</span><span class="main">::</span><span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>finite<span class="main">)</span> <span class="main">-~&gt;</span> <span class="tfree">'b</span><span class="main">)</span><span class="main">.</span>
  <span class="main">⟦</span> dom <span class="bound">f'</span> <span class="main">=</span> dom <span class="main">(</span><span class="free">f</span><span class="main">::</span><span class="main">(</span><span class="tfree">'a</span> <span class="main">-~&gt;</span> <span class="tfree">'b</span><span class="main">)</span><span class="main">)</span><span class="main">;</span> 
    <span class="main">∀</span><span class="bound">l</span><span class="main">∈</span>dom <span class="free">f</span><span class="main">.</span> <span class="main">(</span><span class="main">∃</span><span class="bound">L</span><span class="main">.</span> finite <span class="bound">L</span> 
                  <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">s</span> <span class="bound">p</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∉</span> <span class="bound">L</span> <span class="main">∧</span> <span class="bound">p</span> <span class="main">∉</span> <span class="bound">L</span> <span class="main">∧</span> <span class="bound">s</span> <span class="main">≠</span> <span class="bound">p</span>
                      <span class="main">⟶</span> <span class="bound">P</span> <span class="bound">s</span> <span class="bound">p</span> <span class="main">(</span><span class="free">f</span> <span class="bound">l</span><span class="main">)</span> <span class="main">(</span><span class="bound">f'</span> <span class="bound">l</span><span class="main">)</span> <span class="bound">l</span><span class="main">)</span><span class="main">)</span> <span class="main">⟧</span>
  <span class="main">⟹</span> <span class="main">∃</span><span class="bound">L</span><span class="main">.</span> finite <span class="bound">L</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">l</span><span class="main">∈</span>dom <span class="free">f</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound">s</span> <span class="bound">p</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∉</span> <span class="bound">L</span> <span class="main">∧</span> <span class="bound">p</span> <span class="main">∉</span> <span class="bound">L</span> <span class="main">∧</span> <span class="bound">s</span> <span class="main">≠</span> <span class="bound">p</span> 
                                   <span class="main">⟶</span> <span class="bound">P</span> <span class="bound">s</span> <span class="bound">p</span> <span class="main">(</span><span class="free">f</span> <span class="bound">l</span><span class="main">)</span> <span class="main">(</span><span class="bound">f'</span> <span class="bound">l</span><span class="main">)</span> <span class="bound">l</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">f</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> fmap_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> empty <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>insert <span class="skolem">f</span> <span class="skolem">l</span> <span class="skolem">t</span> <span class="skolem">P</span> <span class="skolem">f'</span><span class="main">)</span> <span class="keyword1"><span class="command">note</span></span> imp <span class="main">=</span> this<span class="main">(</span>2<span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span> pred <span class="main">=</span> this<span class="main">(</span>4<span class="main">)</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">pred_cof</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">pred_cof</span> <span class="skolem">L</span> <span class="skolem">b</span> <span class="skolem">b'</span> <span class="skolem">l</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">s</span> <span class="bound">p</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∉</span> <span class="skolem">L</span> <span class="main">∧</span> <span class="bound">p</span> <span class="main">∉</span> <span class="skolem">L</span> <span class="main">∧</span> <span class="bound">s</span> <span class="main">≠</span> <span class="bound">p</span> <span class="main">⟶</span> <span class="skolem">P</span> <span class="bound">s</span> <span class="bound">p</span> <span class="skolem">b</span> <span class="skolem">b'</span> <span class="skolem">l</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">L</span> <span class="skolem">b</span> <span class="skolem">b'</span> <span class="skolem">l</span>
  <span class="keyword1"><span class="command">from</span></span> 
    map_upd_nonempty<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">f</span></span> <span class="quoted"><span class="skolem">l</span></span> <span class="quoted"><span class="skolem">t</span></span><span class="main">]</span> <span class="quoted"><span class="quoted">‹dom <span class="skolem">f'</span> <span class="main">=</span> dom <span class="main">(</span><span class="skolem">f</span><span class="main">(</span><span class="skolem">l</span> <span class="main">↦</span> <span class="skolem">t</span><span class="main">)</span><span class="main">)</span>›</span></span>
    one_more_dom<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">l</span></span> <span class="quoted"><span class="skolem">f'</span></span><span class="main">]</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">f'a</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
    <span class="quoted"><span class="quoted">"<span class="skolem">f'</span> <span class="main">=</span> <span class="skolem">f'a</span><span class="main">(</span><span class="skolem">l</span> <span class="main">↦</span> the<span class="main">(</span><span class="skolem">f'</span> <span class="skolem">l</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">∉</span> dom <span class="skolem">f'a</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"dom <span class="main">(</span><span class="skolem">f'a</span><span class="main">(</span><span class="skolem">l</span> <span class="main">↦</span> the<span class="main">(</span><span class="skolem">f'</span> <span class="skolem">l</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> dom <span class="main">(</span><span class="skolem">f</span><span class="main">(</span><span class="skolem">l</span> <span class="main">↦</span> <span class="skolem">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">l</span> <span class="main">∉</span> dom <span class="skolem">f</span>›</span></span>
  <span class="keyword1"><span class="command">have</span></span>
    fla<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">la</span><span class="main">∈</span>dom <span class="skolem">f</span><span class="main">.</span> <span class="skolem">f</span> <span class="bound">la</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">f</span><span class="main">(</span><span class="skolem">l</span> <span class="main">↦</span> <span class="skolem">t</span><span class="main">)</span><span class="main">)</span> <span class="bound">la</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">la</span><span class="main">∈</span>dom <span class="skolem">f</span><span class="main">.</span> <span class="skolem">f'a</span> <span class="bound">la</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">f'a</span><span class="main">(</span><span class="skolem">l</span> <span class="main">↦</span> the<span class="main">(</span><span class="skolem">f'</span> <span class="skolem">l</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="bound">la</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">f'</span> <span class="main">=</span> <span class="skolem">f'a</span><span class="main">(</span><span class="skolem">l</span> <span class="main">↦</span> the<span class="main">(</span><span class="skolem">f'</span> <span class="skolem">l</span><span class="main">)</span><span class="main">)</span>›</span></span> 
  <span class="keyword1"><span class="command">have</span></span> f'ala<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">la</span><span class="main">∈</span>dom <span class="skolem">f</span><span class="main">.</span> <span class="skolem">f'a</span> <span class="bound">la</span> <span class="main">=</span> <span class="skolem">f'</span> <span class="bound">la</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">L</span><span class="main">.</span> finite <span class="bound">L</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">la</span><span class="main">∈</span>dom <span class="skolem">f</span><span class="main">.</span> <span class="skolem">pred_cof</span> <span class="bound">L</span> <span class="main">(</span><span class="skolem">f</span> <span class="bound">la</span><span class="main">)</span> <span class="main">(</span><span class="skolem">f'a</span> <span class="bound">la</span><span class="main">)</span> <span class="bound">la</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> pred_cof_def
  <span class="keyword1"><span class="command">proof</span></span> 
    <span class="main">(</span><span class="operator">intro</span> imp<span class="main"><span class="main">[</span></span><span class="operator">OF</span> insert_dom_less_eq<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">l</span> <span class="main">∉</span> dom <span class="skolem">f'a</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">l</span> <span class="main">∉</span> dom <span class="skolem">f</span>›</span></span> 
                                        <span class="quoted"><span class="quoted">‹dom <span class="main">(</span><span class="skolem">f'a</span><span class="main">(</span><span class="skolem">l</span> <span class="main">↦</span> the<span class="main">(</span><span class="skolem">f'</span> <span class="skolem">l</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> dom <span class="main">(</span><span class="skolem">f</span><span class="main">(</span><span class="skolem">l</span> <span class="main">↦</span> <span class="skolem">t</span><span class="main">)</span><span class="main">)</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span>
      <span class="operator">intro</span> strip<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">la</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">la</span> <span class="main">∈</span> dom <span class="skolem">f</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> fla f'ala 
    <span class="keyword1"><span class="command">have</span></span> 
      <span class="quoted"><span class="quoted">"<span class="skolem">la</span> <span class="main">∈</span> dom <span class="main">(</span><span class="skolem">f</span><span class="main">(</span><span class="skolem">l</span> <span class="main">↦</span> <span class="skolem">t</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 
      <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="skolem">la</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">f</span><span class="main">(</span><span class="skolem">l</span> <span class="main">↦</span> <span class="skolem">t</span><span class="main">)</span><span class="main">)</span> <span class="skolem">la</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f'a</span> <span class="skolem">la</span> <span class="main">=</span> <span class="skolem">f'</span> <span class="skolem">la</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> pred
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">L</span><span class="main">.</span> finite <span class="bound">L</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">s</span> <span class="bound">p</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∉</span> <span class="bound">L</span> <span class="main">∧</span> <span class="bound">p</span> <span class="main">∉</span> <span class="bound">L</span> <span class="main">∧</span> <span class="bound">s</span> <span class="main">≠</span> <span class="bound">p</span> <span class="main">⟶</span> <span class="skolem">P</span> <span class="bound">s</span> <span class="bound">p</span> <span class="main">(</span><span class="skolem">f</span> <span class="skolem">la</span><span class="main">)</span> <span class="main">(</span><span class="skolem">f'a</span> <span class="skolem">la</span><span class="main">)</span> <span class="skolem">la</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">elim</span> ssubst<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">with</span></span> fla f'ala <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">L</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
    <span class="quoted"><span class="quoted">"finite <span class="skolem">L</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> predf<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">la</span><span class="main">∈</span>dom <span class="skolem">f</span><span class="main">.</span> <span class="skolem">pred_cof</span> <span class="skolem">L</span> <span class="main">(</span><span class="main">(</span><span class="skolem">f</span><span class="main">(</span><span class="skolem">l</span> <span class="main">↦</span> <span class="skolem">t</span><span class="main">)</span><span class="main">)</span> <span class="bound">la</span><span class="main">)</span> <span class="main">(</span><span class="skolem">f'</span> <span class="bound">la</span><span class="main">)</span> <span class="bound">la</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">∈</span> dom <span class="main">(</span><span class="skolem">f</span><span class="main">(</span><span class="skolem">l</span> <span class="main">↦</span> <span class="skolem">t</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">with</span></span> pred <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">L'</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"finite <span class="skolem">L'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> predfl<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">pred_cof</span> <span class="skolem">L'</span> <span class="main">(</span><span class="main">(</span><span class="skolem">f</span><span class="main">(</span><span class="skolem">l</span> <span class="main">↦</span> <span class="skolem">t</span><span class="main">)</span><span class="main">)</span> <span class="skolem">l</span><span class="main">)</span> <span class="main">(</span><span class="skolem">f'</span> <span class="skolem">l</span><span class="main">)</span> <span class="skolem">l</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> pred_cof_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">L</span> <span class="main">∪</span> <span class="skolem">L'</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main"><span class="keyword3">,</span></span> 
      <span class="operator">intro</span> conjI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> strip<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span> <span class="skolem">p</span> <span class="skolem">la</span> <span class="keyword3"><span class="command">assume</span></span> 
      sp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∉</span> <span class="skolem">L</span> <span class="main">∪</span> <span class="skolem">L'</span> <span class="main">∧</span> <span class="skolem">p</span> <span class="main">∉</span> <span class="skolem">L</span> <span class="main">∪</span> <span class="skolem">L'</span> <span class="main">∧</span> <span class="skolem">s</span> <span class="main">≠</span> <span class="skolem">p</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> indom<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">la</span> <span class="main">∈</span> dom <span class="main">(</span><span class="skolem">f</span><span class="main">(</span><span class="skolem">l</span> <span class="main">↦</span> <span class="skolem">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="skolem">s</span> <span class="skolem">p</span> <span class="main">(</span><span class="main">(</span><span class="skolem">f</span><span class="main">(</span><span class="skolem">l</span> <span class="main">↦</span> <span class="skolem">t</span><span class="main">)</span><span class="main">)</span> <span class="skolem">la</span><span class="main">)</span> <span class="main">(</span><span class="skolem">f'</span> <span class="skolem">la</span><span class="main">)</span> <span class="skolem">la</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">la</span> <span class="main">=</span> <span class="skolem">l</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True <span class="keyword1"><span class="command">with</span></span> sp predfl <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
        <span class="keyword1"><span class="command">unfolding</span></span> pred_cof_def
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False <span class="keyword1"><span class="command">with</span></span> indom sp predf <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
        <span class="keyword1"><span class="command">unfolding</span></span> pred_cof_def
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="FMap-fmap_ex_cof"><span class="command">lemma</span></span> fmap_ex_cof<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span>
  <span class="free">P</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'c</span> <span class="main">⇒</span> <span class="tfree">'c</span> <span class="main">⇒</span> <span class="tfree">'b</span> option <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>finite<span class="main">)</span> <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">l</span><span class="main">∈</span>dom <span class="main">(</span><span class="free">f</span><span class="main">::</span><span class="main">(</span><span class="tfree">'a</span> <span class="main">-~&gt;</span> <span class="tfree">'b</span><span class="main">)</span><span class="main">)</span><span class="main">.</span>
  <span class="main">(</span><span class="main">∃</span><span class="bound">L</span><span class="main">.</span> finite <span class="bound">L</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">s</span> <span class="bound">p</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∉</span> <span class="bound">L</span> <span class="main">∧</span> <span class="bound">p</span> <span class="main">∉</span> <span class="bound">L</span> <span class="main">∧</span> <span class="bound">s</span> <span class="main">≠</span> <span class="bound">p</span> <span class="main">⟶</span> <span class="free">P</span> <span class="bound">s</span> <span class="bound">p</span> <span class="main">(</span><span class="free">f</span> <span class="bound">l</span><span class="main">)</span> <span class="bound">l</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">L</span><span class="main">.</span> finite <span class="bound">L</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">l</span><span class="main">∈</span>dom <span class="free">f</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound">s</span> <span class="bound">p</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∉</span> <span class="bound">L</span> <span class="main">∧</span> <span class="bound">p</span> <span class="main">∉</span> <span class="bound">L</span> <span class="main">∧</span> <span class="bound">s</span> <span class="main">≠</span> <span class="bound">p</span> <span class="main">⟶</span> <span class="free">P</span> <span class="bound">s</span> <span class="bound">p</span> <span class="main">(</span><span class="free">f</span> <span class="bound">l</span><span class="main">)</span> <span class="bound">l</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms fmap_ex_cof2<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="free">f</span></span>  <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">s</span> <span class="bound">p</span> <span class="bound">b</span> <span class="bound">b'</span> <span class="bound">l</span><span class="main">.</span> <span class="free">P</span> <span class="bound">s</span> <span class="bound">p</span> <span class="bound">b</span> <span class="bound">l</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="FMap-fmap_ball_all2"><span class="command">lemma</span></span> fmap_ball_all2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> 
  <span class="free">Px</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'c</span> <span class="main">⇒</span> <span class="tfree">'d</span> <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 
  <span class="free">P</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'c</span> <span class="main">⇒</span> <span class="tfree">'d</span> <span class="main">⇒</span> <span class="tfree">'b</span> option <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">l</span><span class="main">∈</span>dom <span class="main">(</span><span class="free">f</span><span class="main">::</span><span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>finite<span class="main">)</span> <span class="main">-~&gt;</span> <span class="tfree">'b</span><span class="main">)</span><span class="main">.</span> <span class="main">∀</span><span class="main">(</span><span class="bound">x</span><span class="main">::</span><span class="tfree">'c</span><span class="main">)</span> <span class="main">(</span><span class="bound">y</span><span class="main">::</span><span class="tfree">'d</span><span class="main">)</span><span class="main">.</span> <span class="free">Px</span> <span class="bound">x</span> <span class="bound">y</span> <span class="main">⟶</span> <span class="free">P</span> <span class="bound">x</span> <span class="bound">y</span> <span class="main">(</span><span class="free">f</span> <span class="bound">l</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="free">Px</span> <span class="bound">x</span> <span class="bound">y</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∀</span><span class="bound">l</span><span class="main">∈</span>dom <span class="free">f</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span> <span class="bound">y</span> <span class="main">(</span><span class="free">f</span> <span class="bound">l</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> strip<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">y</span> <span class="skolem">l</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">Px</span> <span class="skolem">x</span> <span class="skolem">y</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">∈</span> dom <span class="free">f</span>"</span></span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="skolem">x</span> <span class="skolem">y</span> <span class="main">(</span><span class="free">f</span> <span class="skolem">l</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="FMap-fmap_ball_all2'"><span class="command">lemma</span></span> fmap_ball_all2'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> 
  <span class="free">Px</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'c</span> <span class="main">⇒</span> <span class="tfree">'d</span> <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 
  <span class="free">P</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'c</span> <span class="main">⇒</span> <span class="tfree">'d</span> <span class="main">⇒</span> <span class="tfree">'b</span> option <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>finite<span class="main">)</span> <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">l</span><span class="main">∈</span>dom <span class="main">(</span><span class="free">f</span><span class="main">::</span><span class="main">(</span><span class="tfree">'a</span> <span class="main">-~&gt;</span> <span class="tfree">'b</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> <span class="main">∀</span><span class="main">(</span><span class="bound">x</span><span class="main">::</span><span class="tfree">'c</span><span class="main">)</span> <span class="main">(</span><span class="bound">y</span><span class="main">::</span><span class="tfree">'d</span><span class="main">)</span><span class="main">.</span> <span class="free">Px</span> <span class="bound">x</span> <span class="bound">y</span> <span class="main">⟶</span> <span class="free">P</span> <span class="bound">x</span> <span class="bound">y</span> <span class="main">(</span><span class="free">f</span> <span class="bound">l</span><span class="main">)</span> <span class="bound">l</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="free">Px</span> <span class="bound">x</span> <span class="bound">y</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∀</span><span class="bound">l</span><span class="main">∈</span>dom <span class="free">f</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span> <span class="bound">y</span> <span class="main">(</span><span class="free">f</span> <span class="bound">l</span><span class="main">)</span> <span class="bound">l</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> strip<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">y</span> <span class="skolem">l</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">Px</span> <span class="skolem">x</span> <span class="skolem">y</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">∈</span> dom <span class="free">f</span>"</span></span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="skolem">x</span> <span class="skolem">y</span> <span class="main">(</span><span class="free">f</span> <span class="skolem">l</span><span class="main">)</span> <span class="skolem">l</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="FMap-fmap_ball_all3"><span class="command">lemma</span></span> fmap_ball_all3<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> 
  <span class="free">Px</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'c</span> <span class="main">⇒</span> <span class="tfree">'d</span> <span class="main">⇒</span> <span class="tfree">'e</span> <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 
  <span class="free">P</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'c</span> <span class="main">⇒</span> <span class="tfree">'d</span> <span class="main">⇒</span> <span class="tfree">'e</span> <span class="main">⇒</span> <span class="tfree">'b</span> option <span class="main">⇒</span> <span class="tfree">'b</span> option <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>finite<span class="main">)</span> <span class="main">-~&gt;</span> <span class="tfree">'b</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">f'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">-~&gt;</span> <span class="tfree">'b</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
  <span class="quoted"><span class="quoted">"dom <span class="free">f'</span> <span class="main">=</span> dom <span class="free">f</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">l</span><span class="main">∈</span>dom <span class="free">f</span><span class="main">.</span>
     <span class="main">∀</span><span class="main">(</span><span class="bound">x</span><span class="main">::</span><span class="tfree">'c</span><span class="main">)</span> <span class="main">(</span><span class="bound">y</span><span class="main">::</span><span class="tfree">'d</span><span class="main">)</span> <span class="main">(</span><span class="bound">z</span><span class="main">::</span><span class="tfree">'e</span><span class="main">)</span><span class="main">.</span> <span class="free">Px</span> <span class="bound">x</span> <span class="bound">y</span> <span class="bound">z</span> <span class="main">⟶</span> <span class="free">P</span> <span class="bound">x</span> <span class="bound">y</span> <span class="bound">z</span> <span class="main">(</span><span class="free">f</span> <span class="bound">l</span><span class="main">)</span> <span class="main">(</span><span class="free">f'</span> <span class="bound">l</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span> <span class="bound">y</span> <span class="bound">z</span><span class="main">.</span> <span class="free">Px</span> <span class="bound">x</span> <span class="bound">y</span> <span class="bound">z</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∀</span><span class="bound">l</span><span class="main">∈</span>dom <span class="free">f</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span> <span class="bound">y</span> <span class="bound">z</span> <span class="main">(</span><span class="free">f</span> <span class="bound">l</span><span class="main">)</span> <span class="main">(</span><span class="free">f'</span> <span class="bound">l</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> strip<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">y</span> <span class="skolem">z</span> <span class="skolem">l</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">Px</span> <span class="skolem">x</span> <span class="skolem">y</span> <span class="skolem">z</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">∈</span> dom <span class="free">f</span>"</span></span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="skolem">x</span> <span class="skolem">y</span> <span class="skolem">z</span> <span class="main">(</span><span class="free">f</span> <span class="skolem">l</span><span class="main">)</span> <span class="main">(</span><span class="free">f'</span> <span class="skolem">l</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="FMap-fmap_ball_all4'"><span class="command">lemma</span></span> fmap_ball_all4'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> 
  <span class="free">Px</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'c</span> <span class="main">⇒</span> <span class="tfree">'d</span> <span class="main">⇒</span> <span class="tfree">'e</span> <span class="main">⇒</span> <span class="tfree">'f</span> <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 
  <span class="free">P</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'c</span> <span class="main">⇒</span> <span class="tfree">'d</span> <span class="main">⇒</span> <span class="tfree">'e</span> <span class="main">⇒</span> <span class="tfree">'f</span> <span class="main">⇒</span> <span class="tfree">'b</span> option <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>finite<span class="main">)</span> <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">l</span><span class="main">∈</span>dom <span class="main">(</span><span class="free">f</span><span class="main">::</span><span class="main">(</span><span class="tfree">'a</span> <span class="main">-~&gt;</span> <span class="tfree">'b</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> 
    <span class="main">∀</span><span class="main">(</span><span class="bound">x</span><span class="main">::</span><span class="tfree">'c</span><span class="main">)</span> <span class="main">(</span><span class="bound">y</span><span class="main">::</span><span class="tfree">'d</span><span class="main">)</span> <span class="main">(</span><span class="bound">z</span><span class="main">::</span><span class="tfree">'e</span><span class="main">)</span> <span class="main">(</span><span class="bound">a</span><span class="main">::</span><span class="tfree">'f</span><span class="main">)</span><span class="main">.</span> <span class="free">Px</span> <span class="bound">x</span> <span class="bound">y</span> <span class="bound">z</span> <span class="bound">a</span> <span class="main">⟶</span> <span class="free">P</span> <span class="bound">x</span> <span class="bound">y</span> <span class="bound">z</span> <span class="bound">a</span> <span class="main">(</span><span class="free">f</span> <span class="bound">l</span><span class="main">)</span> <span class="bound">l</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span> <span class="bound">y</span> <span class="bound">z</span> <span class="bound">a</span><span class="main">.</span> <span class="free">Px</span> <span class="bound">x</span> <span class="bound">y</span> <span class="bound">z</span> <span class="bound">a</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∀</span><span class="bound">l</span><span class="main">∈</span>dom <span class="free">f</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span> <span class="bound">y</span> <span class="bound">z</span> <span class="bound">a</span> <span class="main">(</span><span class="free">f</span> <span class="bound">l</span><span class="main">)</span> <span class="bound">l</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> strip<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">y</span> <span class="skolem">z</span> <span class="skolem">a</span> <span class="skolem">l</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">Px</span> <span class="skolem">x</span> <span class="skolem">y</span> <span class="skolem">z</span> <span class="skolem">a</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">∈</span> dom <span class="free">f</span>"</span></span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="skolem">x</span> <span class="skolem">y</span> <span class="skolem">z</span> <span class="skolem">a</span> <span class="main">(</span><span class="free">f</span> <span class="skolem">l</span><span class="main">)</span> <span class="skolem">l</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Sigma">
<div class="head">
<h1>Theory Sigma</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Locally Nameless representation of basic Sigma calculus enriched with formal parameter›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Sigma
<span class="keyword2"><span class="keyword">imports</span></span> <span class="quoted">"<a href="#FMap">../preliminary/FMap</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Infrastructure for the finite maps›</span></span>

<span class="keyword1"><span class="command">axiomatization</span></span> <span class="free">max_label</span> <span class="main">::</span> <span class="quoted">nat</span> <span class="keyword2"><span class="keyword">where</span></span>
  LabelAvail<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">max_label</span> <span class="main">&gt;</span> <span class="numeral">10</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">Label</span> <span class="main">=</span> <span class="main">{</span><span class="bound">n</span> <span class="main">::</span> nat<span class="main">.</span> <span class="bound">n</span> <span class="main">≤</span> max_label<span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">typedef</span></span> Label <span class="main">=</span> <span class="quoted">Label</span>
  <span class="keyword1"><span class="command">unfolding</span></span> Label_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemmas</span></span> finite_Label_set <span class="main">=</span> Finite_Set.finite_Collect_le_nat<span class="main">[</span><span class="operator">of</span> <span class="quoted">max_label</span><span class="main">]</span>

<span class="keyword1" id="Sigma-Univ_abs_label"><span class="command">lemma</span></span> Univ_abs_label<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">(</span>UNIV <span class="main">::</span> <span class="main">(</span>Label set<span class="main">)</span><span class="main">)</span> <span class="main">=</span> Abs_Label <span class="main">`</span> <span class="main">{</span><span class="bound">n</span> <span class="main">::</span> nat<span class="main">.</span> <span class="bound">n</span> <span class="main">≤</span> max_label<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span> <span class="main">::</span> Label<span class="main">.</span> <span class="bound">x</span> <span class="main">:</span> Abs_Label <span class="main">`</span> <span class="main">{</span><span class="bound">n</span> <span class="main">::</span> nat<span class="main">.</span> <span class="bound">n</span> <span class="main">≤</span> max_label<span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="main">::</span> <span class="quoted">Label</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Rep_Label <span class="skolem">x</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">≤</span> max_label<span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fold</span> Label_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> Rep_Label<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"Abs_Label <span class="main">(</span>Rep_Label <span class="skolem">x</span><span class="main">)</span> <span class="main">∈</span> Abs_Label <span class="main">`</span> <span class="main">{</span><span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">≤</span> max_label<span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> imageI<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> Abs_Label <span class="main">`</span> <span class="main">{</span><span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">≤</span> max_label<span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Rep_Label_inverse<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Sigma-finite_Label"><span class="command">lemma</span></span> finite_Label<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>UNIV <span class="main">::</span> <span class="main">(</span>Label set<span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Univ_abs_label finite_Label_set<span class="main">)</span>

<span class="keyword1"><span class="command">instance</span></span> Label <span class="main">::</span> <span class="quoted">finite</span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>UNIV <span class="main">::</span> <span class="main">(</span>Label set<span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> finite_Label<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">consts</span></span>
Lsuc <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Label set<span class="main">)</span> <span class="main">⇒</span> Label <span class="main">⇒</span> Label"</span></span>
Lmin <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Label set<span class="main">)</span> <span class="main">⇒</span> Label"</span></span>
Lmax <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Label set<span class="main">)</span> <span class="main">⇒</span> Label"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">Llt</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>Label<span class="main">,</span> Label<span class="main">]</span> <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">&lt;</span>"</span> 50<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">Llt</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">==</span> Rep_Label <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">&lt;</span> Rep_Label <span class="free"><span class="bound"><span class="entity">b</span></span></span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">Lle</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>Label<span class="main">,</span> Label<span class="main">]</span> <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">≤</span>"</span> 50<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">Lle</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">==</span> Rep_Label <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">≤</span> Rep_Label <span class="free"><span class="bound"><span class="entity">b</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">Ltake_eq</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>Label set<span class="main">,</span> <span class="main">(</span>Label <span class="main">⇀</span> <span class="tfree">'a</span><span class="main">)</span><span class="main">,</span>  <span class="main">(</span>Label <span class="main">⇀</span> <span class="tfree">'a</span><span class="main">)</span><span class="main">]</span> <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>  <span class="quoted"><span class="quoted">"<span class="free">Ltake_eq</span> <span class="free"><span class="bound"><span class="entity">L</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span>  <span class="main">==</span> <span class="main">∀</span><span class="bound">l</span><span class="main">∈</span><span class="free"><span class="bound"><span class="entity">L</span></span></span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">l</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="bound">l</span>"</span></span>

<span class="keyword1" id="Sigma-Ltake_eq_all"><span class="command">lemma</span></span> Ltake_eq_all<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="free">g</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"dom <span class="free">f</span> <span class="main">=</span> dom <span class="free">g</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"Ltake_eq <span class="main">(</span>dom <span class="free">f</span><span class="main">)</span> <span class="free">f</span> <span class="free">g</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">=</span> <span class="free">g</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="skolem">x</span> <span class="main">=</span> <span class="free">g</span> <span class="skolem">x</span>"</span></span> 
    <span class="keyword1"><span class="command">unfolding</span></span> Ltake_eq_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> dom <span class="free">f</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Sigma-Ltake_eq_dom"><span class="command">lemma</span></span> Ltake_eq_dom<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">L</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"Label set"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"Label <span class="main">-~&gt;</span> <span class="tfree">'a</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">L</span> <span class="main">⊆</span> dom <span class="free">f</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"card <span class="free">L</span> <span class="main">=</span> card <span class="main">(</span>dom <span class="free">f</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">L</span> <span class="main">=</span> <span class="main">(</span>dom <span class="free">f</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="main">::</span> <span class="quoted">Label</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">L</span>"</span></span>
  <span class="keyword1"><span class="command">with</span></span> in_mono<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">y</span><span class="main">.</span> <span class="free">f</span> <span class="skolem">x</span> <span class="main">=</span> Some <span class="bound">y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">y</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="skolem">x</span> <span class="main">=</span> Some <span class="skolem">y</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> card_seteq<span class="main">[</span><span class="operator">OF</span> finite_dom_fmap<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free">f</span></span><span class="main"><span class="main">]</span></span> <span class="quoted"><span class="quoted">‹<span class="free">L</span> <span class="main">⊆</span> dom <span class="free">f</span>›</span></span><span class="main">]</span> <span class="quoted"><span class="quoted">‹card <span class="free">L</span> <span class="main">=</span> card <span class="main">(</span>dom <span class="free">f</span><span class="main">)</span>›</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">L</span> <span class="main">=</span> dom <span class="free">f</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="free">f</span> <span class="skolem">x</span> <span class="main">=</span> Some <span class="skolem">y</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">L</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Object-terms in Locally Nameless representation notation, beta-reduction and substitution›</span></span>

<span class="keyword1"><span class="command">datatype</span></span> type <span class="main">=</span> Object <span class="quoted"><span class="quoted">"Label <span class="main">-~&gt;</span> <span class="main">(</span>type <span class="main">×</span> type<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">datatype</span></span> bVariable <span class="main">=</span> Self <span class="quoted">nat</span> <span class="main">|</span> Param <span class="quoted">nat</span>
<span class="keyword1"><span class="command">type_synonym</span></span> fVariable <span class="main">=</span> <span class="quoted">string</span>
<span class="comment1">(* each binder introduces 2 variables: self and parameter *)</span>
<span class="comment1">(* thus to each deBruijn index (nat) correspond 2 variables of the same depth *)</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Enriched Sigma datatype of objects›</span></span>
<span class="keyword1"><span class="command">datatype</span></span> sterm <span class="main">=</span>
  Bvar <span class="quoted">bVariable</span>             <span class="comment1">(* bound variable -- as deBruijn index *)</span>
<span class="main">|</span> Fvar <span class="quoted">fVariable</span>             <span class="comment1">(* free variable *)</span>
<span class="main">|</span> Obj <span class="quoted"><span class="quoted">"Label <span class="main">-~&gt;</span> sterm"</span></span> <span class="quoted">type</span> <span class="comment1">(* An object maps labels to terms and has a type *)</span>
<span class="main">|</span> Call <span class="quoted">sterm</span> <span class="quoted">Label</span> <span class="quoted">sterm</span>     <span class="comment1">(* Call a l b calls method l on object a with param b *)</span>
<span class="main">|</span> Upd <span class="quoted">sterm</span> <span class="quoted">Label</span> <span class="quoted">sterm</span>      <span class="comment1">(* Upd a l b updates method l of object a with body b *)</span>

<span class="keyword1"><span class="command">datatype_compat</span></span> sterm

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">applyPropOnOption</span><span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>sterm <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> sterm option <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
f1<span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="free">applyPropOnOption</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> None  <span class="main">=</span> True"</span></span> <span class="main">|</span>
f2<span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="free">applyPropOnOption</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span>"</span></span>

<span class="keyword1" id="Sigma-sterm_induct"><span class="command">lemma</span></span> sterm_induct<span class="main">[</span><span class="operator">case_names</span> Bvar Fvar Obj Call Upd empty insert<span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> 
  <span class="free">t</span> <span class="main">::</span> <span class="quoted">sterm</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">P1</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"sterm <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 
  <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"Label <span class="main">-~&gt;</span> sterm"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">P3</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Label <span class="main">-~&gt;</span> sterm<span class="main">)</span> <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> 
  <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">b</span><span class="main">.</span> <span class="free">P1</span> <span class="main">(</span>Bvar <span class="bound">b</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="free">P1</span> <span class="main">(</span>Fvar <span class="bound">x</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
   a_obj<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">f</span> <span class="bound">T</span><span class="main">.</span> <span class="free">P3</span> <span class="bound">f</span> <span class="main">⟹</span> <span class="free">P1</span> <span class="main">(</span>Obj <span class="bound">f</span> <span class="bound">T</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">t1</span> <span class="bound">l</span> <span class="bound">t2</span><span class="main">.</span> <span class="main">⟦</span> <span class="free">P1</span> <span class="bound">t1</span><span class="main">;</span> <span class="free">P1</span> <span class="bound">t2</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P1</span> <span class="main">(</span>Call <span class="bound">t1</span> <span class="bound">l</span> <span class="bound">t2</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">t1</span> <span class="bound">l</span> <span class="bound">t2</span><span class="main">.</span> <span class="main">⟦</span> <span class="free">P1</span> <span class="bound">t1</span><span class="main">;</span> <span class="free">P1</span> <span class="bound">t2</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P1</span> <span class="main">(</span>Upd <span class="bound">t1</span> <span class="bound">l</span> <span class="bound">t2</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">P3</span> Map.empty"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  a_f<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">t1</span> <span class="bound">f</span> <span class="bound">l</span> <span class="main">.</span> <span class="main">⟦</span> <span class="bound">l</span> <span class="main">∉</span> dom <span class="bound">f</span><span class="main">;</span> <span class="free">P1</span> <span class="bound">t1</span><span class="main">;</span> <span class="free">P3</span> <span class="bound">f</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">P3</span> <span class="main">(</span><span class="bound">f</span><span class="main">(</span><span class="bound">l</span> <span class="main">↦</span> <span class="bound">t1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P1</span> <span class="free">t</span> <span class="main">∧</span> <span class="free">P3</span> <span class="free">f</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">t</span> <span class="main">(</span><span class="bound">f</span><span class="main">::</span>Label <span class="main">-~&gt;</span> sterm<span class="main">)</span> <span class="bound">l</span><span class="main">.</span>  <span class="free">P1</span> <span class="bound">t</span> <span class="main">∧</span> <span class="main">(</span>applyPropOnOption <span class="free">P1</span><span class="main">)</span> <span class="main">(</span><span class="bound">f</span> <span class="bound">l</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> strip<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">t</span> <span class="main">::</span> <span class="quoted">sterm</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">f'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"Label <span class="main">-~&gt;</span> sterm"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">l</span> <span class="main">::</span> <span class="quoted">Label</span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">foobar</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">foobar</span> <span class="main">=</span> <span class="skolem">f'</span> <span class="skolem">l</span>"</span></span> 
    <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">P1</span> <span class="skolem">t</span> <span class="main">∧</span> applyPropOnOption <span class="free">P1</span> <span class="skolem">foobar</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct_tac</span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">t</span></span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">foobar</span></span></span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> compat_sterm.induct compat_sterm_option.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"Label <span class="main">-~&gt;</span> sterm"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">T</span> <span class="main">::</span> <span class="quoted">type</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> applyPropOnOption <span class="free">P1</span> <span class="main">(</span><span class="skolem">f</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">with</span></span> a_f <span class="quoted"><span class="quoted">‹<span class="free">P3</span> Map.empty›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">P3</span> <span class="skolem">f</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">f</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> fmap_induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>insert <span class="skolem">F</span> <span class="skolem">x</span> <span class="skolem">z</span><span class="main">)</span>
        <span class="keyword1"><span class="command">note</span></span> 
          P1F'   <span class="main">=</span> <span class="quoted"><span class="quoted">‹<span class="main">⋀</span><span class="bound">xa</span><span class="main">.</span> applyPropOnOption <span class="free">P1</span> <span class="main">(</span><span class="main">(</span><span class="skolem">F</span><span class="main">(</span><span class="skolem">x</span> <span class="main">↦</span> <span class="skolem">z</span><span class="main">)</span><span class="main">)</span> <span class="bound">xa</span><span class="main">)</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span>
          predP3 <span class="main">=</span> <span class="quoted"><span class="quoted">‹<span class="main">⟦</span> <span class="main">⋀</span><span class="bound">l</span> <span class="bound">f</span> <span class="bound">t1</span><span class="main">.</span> <span class="main">⟦</span><span class="bound">l</span> <span class="main">∉</span> dom <span class="bound">f</span><span class="main">;</span> <span class="free">P1</span> <span class="bound">t1</span><span class="main">;</span> <span class="free">P3</span> <span class="bound">f</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P3</span> <span class="main">(</span><span class="bound">f</span><span class="main">(</span><span class="bound">l</span> <span class="main">↦</span> <span class="bound">t1</span><span class="main">)</span><span class="main">)</span><span class="main">;</span> 
                      <span class="free">P3</span> Map.empty<span class="main">;</span> <span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> applyPropOnOption <span class="free">P1</span> <span class="main">(</span><span class="skolem">F</span> <span class="bound">x</span><span class="main">)</span><span class="main">⟧</span>
                    <span class="main">⟹</span> <span class="free">P3</span> <span class="skolem">F</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span>
          P3F'   <span class="main">=</span> <span class="quoted"><span class="quoted">‹<span class="main">⋀</span><span class="bound">l</span> <span class="bound">f</span> <span class="bound">t</span> <span class="bound">f</span><span class="main">.</span> <span class="main">⟦</span> <span class="bound">l</span> <span class="main">∉</span> dom <span class="bound">f</span><span class="main">;</span> <span class="free">P1</span> <span class="bound">t</span><span class="main">;</span> <span class="free">P3</span> <span class="bound">f</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P3</span> <span class="main">(</span><span class="bound">f</span><span class="main">(</span><span class="bound">l</span> <span class="main">↦</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span>›</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">xa</span><span class="main">.</span> applyPropOnOption <span class="free">P1</span> <span class="main">(</span><span class="skolem">F</span> <span class="bound">xa</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
          <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">xa</span> <span class="main">::</span> <span class="quoted">Label</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"applyPropOnOption <span class="free">P1</span> <span class="main">(</span><span class="skolem">F</span> <span class="skolem">xa</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">xa</span> <span class="main">=</span> <span class="skolem">x</span>"</span></span><span class="main">)</span>
            <span class="keyword3"><span class="command">case</span></span> True <span class="keyword1"><span class="command">with</span></span> P1F' <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∉</span> dom <span class="skolem">F</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">F</span> <span class="skolem">xa</span> <span class="main">=</span> None"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
            <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">next</span></span>
            <span class="keyword3"><span class="command">case</span></span> False <span class="keyword1"><span class="command">hence</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">F</span> <span class="skolem">xa</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">F</span><span class="main">(</span><span class="skolem">x</span> <span class="main">↦</span> <span class="skolem">z</span><span class="main">)</span><span class="main">)</span> <span class="skolem">xa</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">from</span></span> P1F'<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">xa</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"applyPropOnOption <span class="free">P1</span> <span class="main">(</span><span class="skolem">F</span> <span class="skolem">xa</span><span class="main">)</span>"</span></span> 
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> ssubst<span class="main"><span class="main">[</span></span><span class="operator">OF</span> eq<span class="main"><span class="main">]</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">from</span></span> a_f predP3<span class="main">[</span><span class="operator">OF</span> _ <span class="quoted"><span class="quoted">‹<span class="free">P3</span> Map.empty›</span></span> this<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> P3F<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P3</span> <span class="skolem">F</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">from</span></span> P1F'<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">x</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"applyPropOnOption <span class="free">P1</span> <span class="main">(</span>Some <span class="skolem">z</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">P1</span> <span class="skolem">z</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">from</span></span> a_f<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∉</span> dom <span class="skolem">F</span>›</span></span> this P3F<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">assumption</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">with</span></span> a_obj <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">P1</span> <span class="main">(</span>Obj <span class="skolem">f</span> <span class="skolem">T</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">l</span> <span class="bound">f</span> <span class="bound">t1</span><span class="main">.</span> <span class="main">⟦</span><span class="bound">l</span> <span class="main">∉</span> dom <span class="bound">f</span><span class="main">;</span> <span class="free">P3</span> <span class="bound">f</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P3</span> <span class="main">(</span><span class="bound">f</span><span class="main">(</span><span class="bound">l</span> <span class="main">↦</span> <span class="bound">t1</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="free">P3</span> Map.empty›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">P3</span> <span class="free">f</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> fmap_induct<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Sigma-ball_tsp_P3"><span class="command">lemma</span></span> ball_tsp_P3<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> 
  <span class="free">P1</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"sterm <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 
  <span class="free">P2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"sterm <span class="main">⇒</span> fVariable <span class="main">⇒</span> fVariable <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 
  <span class="free">P3</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"sterm <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"Label <span class="main">-~&gt;</span> sterm"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> 
  <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">t</span><span class="main">.</span> <span class="main">⟦</span> <span class="free">P1</span> <span class="bound">t</span><span class="main">;</span> <span class="main">∀</span><span class="bound">s</span> <span class="bound">p</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∉</span> <span class="free">L</span> <span class="main">∧</span> <span class="bound">p</span> <span class="main">∉</span> <span class="free">L</span> <span class="main">∧</span> <span class="bound">s</span> <span class="main">≠</span> <span class="bound">p</span> <span class="main">⟶</span> <span class="free">P2</span> <span class="bound">t</span> <span class="bound">s</span> <span class="bound">p</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P3</span> <span class="bound">t</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">l</span><span class="main">∈</span>dom <span class="free">f</span><span class="main">.</span> <span class="free">P1</span> <span class="main">(</span>the<span class="main">(</span><span class="free">f</span> <span class="bound">l</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">l</span><span class="main">∈</span>dom <span class="free">f</span><span class="main">.</span> <span class="main">∀</span><span class="bound">s</span> <span class="bound">p</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∉</span> <span class="free">L</span> <span class="main">∧</span> <span class="bound">p</span> <span class="main">∉</span> <span class="free">L</span> <span class="main">∧</span> <span class="bound">s</span> <span class="main">≠</span> <span class="bound">p</span> <span class="main">⟶</span> <span class="free">P2</span> <span class="main">(</span>the<span class="main">(</span><span class="free">f</span> <span class="bound">l</span><span class="main">)</span><span class="main">)</span> <span class="bound">s</span> <span class="bound">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">l</span><span class="main">∈</span>dom <span class="free">f</span><span class="main">.</span> <span class="free">P3</span> <span class="main">(</span>the<span class="main">(</span><span class="free">f</span> <span class="bound">l</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> strip<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">l</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">∈</span> dom <span class="free">f</span>"</span></span> <span class="keyword1"><span class="command">with</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">P1</span> <span class="main">(</span>the<span class="main">(</span><span class="free">f</span> <span class="skolem">l</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>3<span class="main">)</span> <span class="quoted"><span class="quoted">‹<span class="skolem">l</span> <span class="main">∈</span> dom <span class="free">f</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">s</span> <span class="bound">p</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∉</span> <span class="free">L</span> <span class="main">∧</span> <span class="bound">p</span> <span class="main">∉</span> <span class="free">L</span> <span class="main">∧</span> <span class="bound">s</span> <span class="main">≠</span> <span class="bound">p</span> <span class="main">⟶</span> <span class="free">P2</span> <span class="main">(</span>the<span class="main">(</span><span class="free">f</span> <span class="skolem">l</span><span class="main">)</span><span class="main">)</span> <span class="bound">s</span> <span class="bound">p</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">P3</span> <span class="main">(</span>the<span class="main">(</span><span class="free">f</span> <span class="skolem">l</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Sigma-ball_tt'sp_P3"><span class="command">lemma</span></span> ball_tt'sp_P3<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> 
  <span class="free">P1</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"sterm <span class="main">⇒</span> sterm <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 
  <span class="free">P2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"sterm <span class="main">⇒</span> sterm <span class="main">⇒</span> fVariable <span class="main">⇒</span> fVariable <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 
  <span class="free">P3</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"sterm <span class="main">⇒</span> sterm <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 
  <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"Label <span class="main">-~&gt;</span> sterm"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">f'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"Label <span class="main">-~&gt;</span> sterm"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> 
  <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">t</span> <span class="bound">t'</span><span class="main">.</span> <span class="main">⟦</span> <span class="free">P1</span> <span class="bound">t</span> <span class="bound">t'</span><span class="main">;</span> <span class="main">∀</span><span class="bound">s</span> <span class="bound">p</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∉</span> <span class="free">L</span> <span class="main">∧</span> <span class="bound">p</span> <span class="main">∉</span> <span class="free">L</span> <span class="main">∧</span> <span class="bound">s</span> <span class="main">≠</span> <span class="bound">p</span> <span class="main">⟶</span> <span class="free">P2</span> <span class="bound">t</span> <span class="bound">t'</span> <span class="bound">s</span> <span class="bound">p</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P3</span> <span class="bound">t</span> <span class="bound">t'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  <span class="quoted"><span class="quoted">"dom <span class="free">f</span> <span class="main">=</span> dom <span class="free">f'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">l</span><span class="main">∈</span>dom <span class="free">f</span><span class="main">.</span> <span class="free">P1</span> <span class="main">(</span>the<span class="main">(</span><span class="free">f</span> <span class="bound">l</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>the<span class="main">(</span><span class="free">f'</span> <span class="bound">l</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">l</span><span class="main">∈</span>dom <span class="free">f</span><span class="main">.</span> <span class="main">∀</span><span class="bound">s</span> <span class="bound">p</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∉</span> <span class="free">L</span> <span class="main">∧</span> <span class="bound">p</span> <span class="main">∉</span> <span class="free">L</span> <span class="main">∧</span> <span class="bound">s</span> <span class="main">≠</span> <span class="bound">p</span> <span class="main">⟶</span> <span class="free">P2</span> <span class="main">(</span>the<span class="main">(</span><span class="free">f</span> <span class="bound">l</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>the<span class="main">(</span><span class="free">f'</span> <span class="bound">l</span><span class="main">)</span><span class="main">)</span> <span class="bound">s</span> <span class="bound">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">l</span><span class="main">∈</span>dom <span class="free">f'</span><span class="main">.</span> <span class="free">P3</span> <span class="main">(</span>the<span class="main">(</span><span class="free">f</span> <span class="bound">l</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>the<span class="main">(</span><span class="free">f'</span> <span class="bound">l</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> strip<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">l</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">∈</span> dom <span class="free">f'</span>"</span></span> <span class="keyword1"><span class="command">with</span></span> assms<span class="main">(</span>2-3<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">P1</span> <span class="main">(</span>the<span class="main">(</span><span class="free">f</span> <span class="skolem">l</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>the<span class="main">(</span><span class="free">f'</span> <span class="skolem">l</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">moreover</span></span> 
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>2<span class="main">,</span>4<span class="main">)</span> <span class="quoted"><span class="quoted">‹<span class="skolem">l</span> <span class="main">∈</span> dom <span class="free">f'</span>›</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">s</span> <span class="bound">p</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∉</span> <span class="free">L</span> <span class="main">∧</span> <span class="bound">p</span> <span class="main">∉</span> <span class="free">L</span> <span class="main">∧</span> <span class="bound">s</span> <span class="main">≠</span> <span class="bound">p</span> <span class="main">⟶</span> <span class="free">P2</span> <span class="main">(</span>the <span class="main">(</span><span class="free">f</span> <span class="skolem">l</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>the<span class="main">(</span><span class="free">f'</span> <span class="skolem">l</span><span class="main">)</span><span class="main">)</span> <span class="bound">s</span> <span class="bound">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">P3</span> <span class="main">(</span>the<span class="main">(</span><span class="free">f</span> <span class="skolem">l</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>the<span class="main">(</span><span class="free">f'</span> <span class="skolem">l</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"the<span class="main">(</span><span class="free">f</span> <span class="skolem">l</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"the<span class="main">(</span><span class="free">f'</span> <span class="skolem">l</span><span class="main">)</span>"</span></span><span class="main">]</span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Free variables›</span></span>
<span class="keyword1"><span class="command">primrec</span></span>
 <span class="entity">FV</span>       <span class="main">::</span> <span class="quoted"><span class="quoted">"sterm <span class="main">⇒</span> fVariable set"</span></span>
<span class="keyword2"><span class="keyword">and</span></span>
 <span class="entity">FVoption</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"sterm option <span class="main">⇒</span> fVariable set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  FV_Bvar <span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">FV</span><span class="main">(</span>Bvar <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
<span class="main">|</span> FV_Fvar <span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">FV</span><span class="main">(</span>Fvar <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">}</span>"</span></span>
<span class="main">|</span> FV_Call <span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">FV</span><span class="main">(</span>Call <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">FV</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">∪</span> <span class="free">FV</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span>"</span></span>
<span class="main">|</span> FV_Upd  <span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">FV</span><span class="main">(</span>Upd <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">FV</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">∪</span> <span class="free">FV</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span>"</span></span>
<span class="main">|</span> FV_Obj  <span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">FV</span><span class="main">(</span>Obj <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span> <span class="bound">l</span> <span class="main">∈</span> dom <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">.</span> <span class="free">FVoption</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">l</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> FV_None <span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">FVoption</span> None <span class="main">=</span> <span class="main">{}</span>"</span></span>
<span class="main">|</span> FV_Some <span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">FVoption</span> <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">FV</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">closed</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"sterm <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
 <span class="quoted"><span class="quoted">"<span class="free">closed</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">⟷</span> FV <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> <span class="main">{}</span>"</span></span>

<span class="comment1">(* finiteness of FV *)</span>
<span class="keyword1" id="Sigma-finite_FV_FVoption"><span class="command">lemma</span></span> finite_FV_FVoption<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>FV <span class="free">t</span><span class="main">)</span> <span class="main">∧</span> finite <span class="main">(</span>FVoption <span class="free">s</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induct</span> <span class="main">_</span> <span class="quoted"><span class="free">t</span></span> <span class="main">_</span> <span class="quoted"><span class="free">s</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> compat_sterm_sterm_option.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>

<span class="comment1">(* for infiniteness of string sets see
    List.infinite_UNIV_listI *)</span>

<span class="comment1">(* NOTE: ex_new_if_finite, infinite_UNIV_listI and finite_FV offer an easy way to proof exists-fresh-statements *)</span>
<span class="keyword1" id="Sigma-finite_FV"><span class="command">lemma</span></span> finite_FV<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>FV <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> finite_FV_FVoption<span class="main">)</span>

<span class="keyword1" id="Sigma-FV_and_cofinite"><span class="command">lemma</span></span> FV_and_cofinite<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∉</span> <span class="free">L</span> <span class="main">⟶</span> <span class="free">P</span> <span class="bound">x</span><span class="main">;</span> finite <span class="free">L</span> <span class="main">⟧</span> 
  <span class="main">⟹</span> <span class="main">∃</span><span class="bound">L'</span><span class="main">.</span> <span class="main">(</span>finite <span class="bound">L'</span> <span class="main">∧</span> FV <span class="free">t</span> <span class="main">⊆</span> <span class="bound">L'</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∉</span> <span class="bound">L'</span> <span class="main">⟶</span> <span class="free">P</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="free">L</span> <span class="main">∪</span> FV <span class="free">t</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="Sigma-exFresh_s_p_cof"><span class="command">lemma</span></span> exFresh_s_p_cof<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">L</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"fVariable set"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">L</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">s</span> <span class="bound">p</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∉</span> <span class="free">L</span> <span class="main">∧</span> <span class="bound">p</span> <span class="main">∉</span> <span class="free">L</span> <span class="main">∧</span> <span class="bound">s</span> <span class="main">≠</span> <span class="bound">p</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∉</span> <span class="free">L</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> ex_new_if_finite<span class="main"><span class="main">[</span></span><span class="operator">OF</span> infinite_UNIV_listI<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∉</span> <span class="free">L</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹finite <span class="free">L</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="free">L</span> <span class="main">∪</span> <span class="main">{</span><span class="skolem">s</span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">p</span><span class="main">.</span> <span class="bound">p</span> <span class="main">∉</span> <span class="free">L</span> <span class="main">∪</span> <span class="main">{</span><span class="skolem">s</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> ex_new_if_finite<span class="main"><span class="main">[</span></span><span class="operator">OF</span> infinite_UNIV_listI<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∉</span> <span class="free">L</span> <span class="main">∪</span> <span class="main">{</span><span class="skolem">s</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Sigma-FV_option_lem"><span class="command">lemma</span></span> FV_option_lem<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">l</span><span class="main">∈</span>dom <span class="free">f</span><span class="main">.</span> FV <span class="main">(</span>the<span class="main">(</span><span class="free">f</span> <span class="bound">l</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> FVoption <span class="main">(</span><span class="free">f</span> <span class="bound">l</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Term opening›</span></span>
<span class="keyword1"><span class="command">primrec</span></span>
  <span class="entity">sopen</span>        <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>nat<span class="main">,</span> sterm<span class="main">,</span> sterm<span class="main">,</span> sterm<span class="main">]</span> <span class="main">⇒</span> sterm"</span></span> 
  <span class="main">(</span><span class="quoted">"<span class="keyword1">{</span>_ <span class="keyword1">→</span> <span class="keyword1">[</span>_<span class="keyword1">,</span>_<span class="keyword1">]}</span> _"</span> <span class="main">[</span>0<span class="main">,</span> 0<span class="main">,</span> 0<span class="main">,</span> 300<span class="main">]</span> 300<span class="main">)</span>
<span class="keyword2"><span class="keyword">and</span></span>
  <span class="entity">sopen_option</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>nat<span class="main">,</span> sterm<span class="main">,</span> sterm<span class="main">,</span> sterm option<span class="main">]</span> <span class="main">⇒</span> sterm option"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  sopen_Bvar<span class="main">:</span> 
    <span class="quoted"><span class="quoted">"<span class="main"><span class="free">{</span></span><span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main"><span class="free">→</span></span> <span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main"><span class="free">,</span></span><span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main"><span class="free">]}</span></span><span class="main">(</span>Bvar <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="keyword1">of</span> <span class="main">(</span>Self <span class="bound">i</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="keyword1">if</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">=</span> <span class="bound">i</span><span class="main">)</span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="keyword1">else</span> <span class="main">(</span>Bvar <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span><span class="main">)</span> 
                                    <span class="main">|</span> <span class="main">(</span>Param <span class="bound">i</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="keyword1">if</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">=</span> <span class="bound">i</span><span class="main">)</span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="keyword1">else</span> <span class="main">(</span>Bvar <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> sopen_Fvar<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main"><span class="free">{</span></span><span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main"><span class="free">→</span></span> <span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main"><span class="free">,</span></span><span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main"><span class="free">]}</span></span><span class="main">(</span>Fvar <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">=</span> Fvar <span class="free"><span class="bound"><span class="entity">x</span></span></span>"</span></span>
<span class="main">|</span> sopen_Call<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main"><span class="free">{</span></span><span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main"><span class="free">→</span></span> <span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main"><span class="free">,</span></span><span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main"><span class="free">]}</span></span><span class="main">(</span>Call <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="main">=</span> Call <span class="main">(</span><span class="main"><span class="free">{</span></span><span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main"><span class="free">→</span></span> <span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main"><span class="free">,</span></span><span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main"><span class="free">]}</span></span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">(</span><span class="main"><span class="free">{</span></span><span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main"><span class="free">→</span></span> <span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main"><span class="free">,</span></span><span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main"><span class="free">]}</span></span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> sopen_Upd <span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main"><span class="free">{</span></span><span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main"><span class="free">→</span></span> <span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main"><span class="free">,</span></span><span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main"><span class="free">]}</span></span><span class="main">(</span>Upd <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">)</span> <span class="main">=</span> Upd <span class="main">(</span><span class="main"><span class="free">{</span></span><span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main"><span class="free">→</span></span> <span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main"><span class="free">,</span></span><span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main"><span class="free">]}</span></span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">(</span><span class="main"><span class="free">{</span></span><span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">)</span> <span class="main"><span class="free">→</span></span> <span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main"><span class="free">,</span></span><span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main"><span class="free">]}</span></span><span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> sopen_Obj <span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main"><span class="free">{</span></span><span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main"><span class="free">→</span></span> <span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main"><span class="free">,</span></span><span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main"><span class="free">]}</span></span><span class="main">(</span>Obj <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main">)</span> <span class="main">=</span> Obj <span class="main">(</span><span class="main">λ</span><span class="bound">l</span><span class="main">.</span> <span class="free">sopen_option</span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">l</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">T</span></span></span>"</span></span>
<span class="main">|</span> sopen_None<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">sopen_option</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> None <span class="main">=</span> None"</span></span>
<span class="main">|</span> sopen_Some<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">sopen_option</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span><span class="main"><span class="free">{</span></span><span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main"><span class="free">→</span></span> <span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main"><span class="free">,</span></span><span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main"><span class="free">]}</span></span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">openz</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>sterm<span class="main">,</span> sterm<span class="main">,</span> sterm<span class="main">]</span> <span class="main">⇒</span> sterm"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword3">(</span>_<span class="keyword3">)</span><span class="keyword1">⇗[</span>_<span class="keyword1">,</span>_<span class="keyword1">]⇖</span>"</span> <span class="main">[</span>50<span class="main">,</span> 0<span class="main">,</span> 0<span class="main">]</span> 50<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
 <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="hidden">⇗</span><sup>[<span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main"><span class="free">,</span></span><span class="free"><span class="bound"><span class="entity">p</span></span></span>]</sup><span class="hidden">⇖</span> <span class="main">=</span> <span class="main">{</span><span class="main">0</span> <span class="main">→</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">]}</span><span class="free"><span class="bound"><span class="entity">t</span></span></span>"</span></span>

<span class="keyword1" id="Sigma-sopen_eq_Fvar"><span class="command">lemma</span></span> sopen_eq_Fvar<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">n</span> <span class="free">s</span> <span class="free">p</span> <span class="free">t</span> <span class="free">x</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">n</span> <span class="main">→</span> <span class="main">[</span>Fvar <span class="free">s</span><span class="main">,</span>Fvar <span class="free">p</span><span class="main">]}</span> <span class="free">t</span> <span class="main">=</span> Fvar <span class="free">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> 
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">t</span> <span class="main">=</span> Fvar <span class="free">x</span><span class="main">)</span> <span class="main">∨</span> <span class="main">(</span><span class="free">x</span> <span class="main">=</span> <span class="free">s</span> <span class="main">∧</span> <span class="free">t</span> <span class="main">=</span> <span class="main">(</span>Bvar <span class="main">(</span>Self <span class="free">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> 
  <span class="main">∨</span> <span class="main">(</span><span class="free">x</span> <span class="main">=</span> <span class="free">p</span> <span class="main">∧</span> <span class="free">t</span> <span class="main">=</span> <span class="main">(</span>Bvar <span class="main">(</span>Param <span class="free">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Obj <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> Call <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> Upd <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Fvar <span class="skolem">y</span><span class="main">)</span> <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">=</span> <span class="free">x</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Bvar <span class="skolem">b</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">b</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Self <span class="skolem">k</span><span class="main">)</span> <span class="keyword1"><span class="command">with</span></span> assms Bvar <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">=</span> <span class="free">n</span>"</span></span><span class="main">)</span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Param <span class="skolem">k</span><span class="main">)</span> <span class="keyword1"><span class="command">with</span></span> assms Bvar <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">=</span> <span class="free">n</span>"</span></span><span class="main">)</span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Sigma-sopen_eq_Fvar'"><span class="command">lemma</span></span> sopen_eq_Fvar'<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">n</span> <span class="main">→</span> <span class="main">[</span>Fvar <span class="free">s</span><span class="main">,</span>Fvar <span class="free">p</span><span class="main">]}</span> <span class="free">t</span> <span class="main">=</span> Fvar <span class="free">x</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≠</span> <span class="free">s</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≠</span> <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">=</span> Fvar <span class="free">x</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> sopen_eq_Fvar<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="quoted"><span class="quoted">‹<span class="free">x</span> <span class="main">≠</span> <span class="free">s</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">x</span> <span class="main">≠</span> <span class="free">p</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Sigma-sopen_eq_Bvar"><span class="command">lemma</span></span> sopen_eq_Bvar<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">n</span> <span class="free">s</span> <span class="free">p</span> <span class="free">t</span> <span class="free">b</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">n</span> <span class="main">→</span> <span class="main">[</span>Fvar <span class="free">s</span><span class="main">,</span>Fvar <span class="free">p</span><span class="main">]}</span> <span class="free">t</span> <span class="main">=</span> Bvar <span class="free">b</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">=</span> Bvar <span class="free">b</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Fvar <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> openz_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> Obj <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> openz_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> Call <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> openz_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> Upd <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> openz_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Bvar <span class="skolem">b'</span><span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">b'</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Self <span class="skolem">k</span><span class="main">)</span> <span class="keyword1"><span class="command">with</span></span> assms Bvar <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">=</span> <span class="free">n</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> openz_def<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Param <span class="skolem">k</span><span class="main">)</span> <span class="keyword1"><span class="command">with</span></span> assms Bvar <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">=</span> <span class="free">n</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> openz_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Sigma-sopen_eq_Obj"><span class="command">lemma</span></span> sopen_eq_Obj<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">n</span> <span class="free">s</span> <span class="free">p</span> <span class="free">t</span> <span class="free">f</span> <span class="free">T</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">n</span> <span class="main">→</span> <span class="main">[</span>Fvar <span class="free">s</span><span class="main">,</span>Fvar <span class="free">p</span><span class="main">]}</span> <span class="free">t</span> <span class="main">=</span> Obj <span class="free">f</span> <span class="free">T</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> 
  <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">f'</span><span class="main">.</span> <span class="main">{</span><span class="free">n</span> <span class="main">→</span> <span class="main">[</span>Fvar <span class="free">s</span><span class="main">,</span> Fvar <span class="free">p</span><span class="main">]}</span> Obj <span class="bound">f'</span> <span class="free">T</span> <span class="main">=</span> Obj <span class="free">f</span> <span class="free">T</span>  
      <span class="main">∧</span>  <span class="free">t</span> <span class="main">=</span> Obj <span class="bound">f'</span> <span class="free">T</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Fvar <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> Obj <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> Call <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> Upd <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Bvar <span class="skolem">b</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">b</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Self <span class="skolem">k</span><span class="main">)</span> <span class="keyword1"><span class="command">with</span></span> assms Bvar <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">=</span> <span class="free">n</span>"</span></span><span class="main">)</span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Param <span class="skolem">k</span><span class="main">)</span> <span class="keyword1"><span class="command">with</span></span> assms Bvar <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">=</span> <span class="free">n</span>"</span></span><span class="main">)</span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Sigma-sopen_eq_Upd"><span class="command">lemma</span></span> sopen_eq_Upd<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">n</span> <span class="free">s</span> <span class="free">p</span> <span class="free">t</span> <span class="free">t1</span> <span class="free">l</span> <span class="free">t2</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">n</span> <span class="main">→</span> <span class="main">[</span>Fvar <span class="free">s</span><span class="main">,</span>Fvar <span class="free">p</span><span class="main">]}</span> <span class="free">t</span> <span class="main">=</span> Upd <span class="free">t1</span> <span class="free">l</span> <span class="free">t2</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> 
  <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">t1'</span> <span class="bound">t2'</span><span class="main">.</span> <span class="main">{</span><span class="free">n</span> <span class="main">→</span> <span class="main">[</span>Fvar <span class="free">s</span><span class="main">,</span>Fvar <span class="free">p</span><span class="main">]}</span> <span class="bound">t1'</span> <span class="main">=</span> <span class="free">t1</span> 
           <span class="main">∧</span> <span class="main">{</span><span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="main">→</span> <span class="main">[</span>Fvar <span class="free">s</span><span class="main">,</span>Fvar <span class="free">p</span><span class="main">]}</span> <span class="bound">t2'</span> <span class="main">=</span> <span class="free">t2</span> <span class="main">∧</span> <span class="free">t</span> <span class="main">=</span> Upd <span class="bound">t1'</span> <span class="free">l</span> <span class="bound">t2'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Fvar <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> Obj <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> Call <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> Upd <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Bvar <span class="skolem">b</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">b</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Self <span class="skolem">k</span><span class="main">)</span> <span class="keyword1"><span class="command">with</span></span> assms Bvar <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">=</span> <span class="free">n</span>"</span></span><span class="main">)</span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Param <span class="skolem">k</span><span class="main">)</span> <span class="keyword1"><span class="command">with</span></span> assms Bvar <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">=</span> <span class="free">n</span>"</span></span><span class="main">)</span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Sigma-sopen_eq_Call"><span class="command">lemma</span></span> sopen_eq_Call<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">n</span> <span class="free">s</span> <span class="free">p</span> <span class="free">t</span> <span class="free">t1</span> <span class="free">l</span> <span class="free">t2</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">n</span> <span class="main">→</span> <span class="main">[</span>Fvar <span class="free">s</span><span class="main">,</span>Fvar <span class="free">p</span><span class="main">]}</span> <span class="free">t</span> <span class="main">=</span> Call <span class="free">t1</span> <span class="free">l</span> <span class="free">t2</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> 
  <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">t1'</span> <span class="bound">t2'</span><span class="main">.</span> <span class="main">{</span><span class="free">n</span> <span class="main">→</span> <span class="main">[</span>Fvar <span class="free">s</span><span class="main">,</span>Fvar <span class="free">p</span><span class="main">]}</span> <span class="bound">t1'</span> <span class="main">=</span> <span class="free">t1</span> 
           <span class="main">∧</span> <span class="main">{</span><span class="free">n</span> <span class="main">→</span> <span class="main">[</span>Fvar <span class="free">s</span><span class="main">,</span>Fvar <span class="free">p</span><span class="main">]}</span> <span class="bound">t2'</span> <span class="main">=</span> <span class="free">t2</span> <span class="main">∧</span> <span class="free">t</span> <span class="main">=</span> Call <span class="bound">t1'</span> <span class="free">l</span> <span class="bound">t2'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Fvar <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> Obj <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> Call <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> Upd <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Bvar <span class="skolem">b</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">b</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Self <span class="skolem">k</span><span class="main">)</span> <span class="keyword1"><span class="command">with</span></span> assms Bvar <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">=</span> <span class="free">n</span>"</span></span><span class="main">)</span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Param <span class="skolem">k</span><span class="main">)</span> <span class="keyword1"><span class="command">with</span></span> assms Bvar <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">=</span> <span class="free">n</span>"</span></span><span class="main">)</span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Sigma-dom_sopenoption_lem"><span class="command">lemma</span></span> dom_sopenoption_lem<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"dom <span class="main">(</span><span class="main">λ</span><span class="bound">l</span><span class="main">.</span> sopen_option <span class="free">k</span> <span class="free">s</span> <span class="free">t</span> <span class="main">(</span><span class="free">f</span> <span class="bound">l</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> dom <span class="free">f</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="improper">x</span> <span class="main">∈</span> dom <span class="free">f</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="Sigma-sopen_option_lem"><span class="command">lemma</span></span> sopen_option_lem<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">l</span><span class="main">∈</span>dom <span class="free">f</span><span class="main">.</span> <span class="main">{</span><span class="free">n</span> <span class="main">→</span> <span class="main">[</span><span class="free">s</span><span class="main">,</span><span class="free">p</span><span class="main">]}</span> the<span class="main">(</span><span class="free">f</span> <span class="bound">l</span><span class="main">)</span> <span class="main">=</span> the <span class="main">(</span>sopen_option <span class="free">n</span> <span class="free">s</span> <span class="free">p</span> <span class="main">(</span><span class="free">f</span> <span class="bound">l</span><span class="main">)</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Sigma-pred_sopenoption_lem"><span class="command">lemma</span></span> pred_sopenoption_lem<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">l</span><span class="main">∈</span>dom <span class="main">(</span><span class="main">λ</span><span class="bound">l</span><span class="main">.</span> sopen_option <span class="free">n</span> <span class="free">s</span> <span class="free">p</span> <span class="main">(</span><span class="free">f</span> <span class="bound">l</span><span class="main">)</span><span class="main">)</span><span class="main">.</span>
     <span class="main">(</span><span class="free">P</span><span class="main">::</span>sterm <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">(</span>the <span class="main">(</span>sopen_option <span class="free">n</span> <span class="free">s</span> <span class="free">p</span> <span class="main">(</span><span class="free">f</span> <span class="bound">l</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
   <span class="main">(</span><span class="main">∀</span><span class="bound">l</span><span class="main">∈</span>dom <span class="free">f</span><span class="main">.</span> <span class="main">(</span><span class="free">P</span><span class="main">::</span>sterm <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">(</span><span class="main">{</span><span class="free">n</span> <span class="main">→</span> <span class="main">[</span><span class="free">s</span><span class="main">,</span><span class="free">p</span><span class="main">]}</span> the <span class="main">(</span><span class="free">f</span> <span class="bound">l</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">force</span><span class="main">)</span>

<span class="keyword1" id="Sigma-sopen_FV"><span class="command">lemma</span></span> sopen_FV<span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">n</span> <span class="bound">s</span> <span class="bound">p</span><span class="main">.</span> FV <span class="main">(</span><span class="main">{</span><span class="bound">n</span> <span class="main">→</span> <span class="main">[</span><span class="bound">s</span><span class="main">,</span><span class="bound">p</span><span class="main">]}</span> <span class="free">t</span><span class="main">)</span> <span class="main">⊆</span> FV <span class="free">t</span> <span class="main">∪</span> FV <span class="bound">s</span> <span class="main">∪</span> FV <span class="bound">p</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">u</span>
  <span class="keyword1"><span class="command">have</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">n</span> <span class="bound">s</span> <span class="bound">p</span><span class="main">.</span> FV <span class="main">(</span><span class="main">{</span><span class="bound">n</span> <span class="main">→</span> <span class="main">[</span><span class="bound">s</span><span class="main">,</span><span class="bound">p</span><span class="main">]}</span> <span class="free">t</span><span class="main">)</span> <span class="main">⊆</span> FV <span class="free">t</span> <span class="main">∪</span> FV <span class="bound">s</span> <span class="main">∪</span> FV <span class="bound">p</span><span class="main">)</span>
    <span class="main">&amp;</span><span class="main">(</span><span class="main">∀</span><span class="bound">n</span> <span class="bound">s</span> <span class="bound">p</span><span class="main">.</span> FVoption <span class="main">(</span>sopen_option <span class="bound">n</span> <span class="bound">s</span> <span class="bound">p</span> <span class="skolem">u</span><span class="main">)</span> <span class="main">⊆</span> FVoption <span class="skolem">u</span> <span class="main">∪</span> FV <span class="bound">s</span> <span class="main">∪</span> FV <span class="bound">p</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">u</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> compat_sterm_sterm_option.induct<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> bVariable.split<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> FV_Some UnE domI sopen_Some subsetCE<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">from</span></span> conjunct1<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">assumption</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Sigma-sopen_commute"><span class="command">lemma</span></span> sopen_commute<span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">n</span> <span class="bound">k</span> <span class="bound">s</span> <span class="bound">p</span> <span class="bound">s'</span> <span class="bound">p'</span><span class="main">.</span> <span class="bound">n</span> <span class="main">≠</span> <span class="bound">k</span>
     <span class="main">⟶</span> <span class="main">{</span><span class="bound">n</span> <span class="main">→</span> <span class="main">[</span>Fvar <span class="bound">s'</span><span class="main">,</span> Fvar <span class="bound">p'</span><span class="main">]}</span> <span class="main">{</span><span class="bound">k</span> <span class="main">→</span> <span class="main">[</span>Fvar <span class="bound">s</span><span class="main">,</span> Fvar <span class="bound">p</span><span class="main">]}</span> <span class="free">t</span> 
         <span class="main">=</span> <span class="main">{</span><span class="bound">k</span> <span class="main">→</span> <span class="main">[</span>Fvar <span class="bound">s</span><span class="main">,</span> Fvar <span class="bound">p</span><span class="main">]}</span> <span class="main">{</span><span class="bound">n</span> <span class="main">→</span> <span class="main">[</span>Fvar <span class="bound">s'</span><span class="main">,</span> Fvar <span class="bound">p'</span><span class="main">]}</span> <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">u</span>
  <span class="keyword1"><span class="command">have</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">n</span> <span class="bound">k</span> <span class="bound">s</span> <span class="bound">p</span> <span class="bound">s'</span> <span class="bound">p'</span><span class="main">.</span> <span class="bound">n</span> <span class="main">≠</span> <span class="bound">k</span>
      <span class="main">⟶</span> <span class="main">{</span><span class="bound">n</span> <span class="main">→</span> <span class="main">[</span>Fvar <span class="bound">s'</span><span class="main">,</span> Fvar <span class="bound">p'</span><span class="main">]}</span> <span class="main">{</span><span class="bound">k</span> <span class="main">→</span> <span class="main">[</span>Fvar <span class="bound">s</span><span class="main">,</span> Fvar <span class="bound">p</span><span class="main">]}</span> <span class="free">t</span> 
          <span class="main">=</span> <span class="main">{</span><span class="bound">k</span> <span class="main">→</span> <span class="main">[</span>Fvar <span class="bound">s</span><span class="main">,</span> Fvar <span class="bound">p</span><span class="main">]}</span> <span class="main">{</span><span class="bound">n</span> <span class="main">→</span> <span class="main">[</span>Fvar <span class="bound">s'</span><span class="main">,</span> Fvar <span class="bound">p'</span><span class="main">]}</span> <span class="free">t</span><span class="main">)</span>
    <span class="main">&amp;</span><span class="main">(</span><span class="main">∀</span><span class="bound">n</span> <span class="bound">k</span> <span class="bound">s</span> <span class="bound">p</span> <span class="bound">s'</span> <span class="bound">p'</span><span class="main">.</span> <span class="bound">n</span> <span class="main">≠</span> <span class="bound">k</span>
      <span class="main">⟶</span> sopen_option <span class="bound">n</span> <span class="main">(</span>Fvar <span class="bound">s'</span><span class="main">)</span> <span class="main">(</span>Fvar <span class="bound">p'</span><span class="main">)</span> <span class="main">(</span>sopen_option <span class="bound">k</span> <span class="main">(</span>Fvar <span class="bound">s</span><span class="main">)</span> <span class="main">(</span>Fvar <span class="bound">p</span><span class="main">)</span> <span class="skolem">u</span><span class="main">)</span> 
          <span class="main">=</span> sopen_option <span class="bound">k</span> <span class="main">(</span>Fvar <span class="bound">s</span><span class="main">)</span> <span class="main">(</span>Fvar <span class="bound">p</span><span class="main">)</span>
             <span class="main">(</span>sopen_option <span class="bound">n</span> <span class="main">(</span>Fvar <span class="bound">s'</span><span class="main">)</span> <span class="main">(</span>Fvar <span class="bound">p'</span><span class="main">)</span> <span class="skolem">u</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> compat_sterm_sterm_option.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> bVariable.split<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> conjunct1<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">assumption</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Sigma-sopen_fresh_inj"><span class="command">lemma</span></span> sopen_fresh_inj<span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">n</span> <span class="bound">s</span> <span class="bound">p</span> <span class="bound">t'</span><span class="main">.</span> <span class="main">{</span><span class="bound">n</span> <span class="main">→</span> <span class="main">[</span>Fvar <span class="bound">s</span><span class="main">,</span> Fvar <span class="bound">p</span><span class="main">]}</span> <span class="free">t</span> <span class="main">=</span> <span class="main">{</span><span class="bound">n</span> <span class="main">→</span> <span class="main">[</span>Fvar <span class="bound">s</span><span class="main">,</span> Fvar <span class="bound">p</span><span class="main">]}</span> <span class="bound">t'</span>
     <span class="main">⟶</span> <span class="bound">s</span> <span class="main">∉</span> FV <span class="free">t</span> <span class="main">⟶</span> <span class="bound">s</span> <span class="main">∉</span> FV <span class="bound">t'</span> <span class="main">⟶</span> <span class="bound">p</span> <span class="main">∉</span> FV <span class="free">t</span> <span class="main">⟶</span> <span class="bound">p</span> <span class="main">∉</span> FV <span class="bound">t'</span> <span class="main">⟶</span> <span class="bound">s</span> <span class="main">≠</span> <span class="bound">p</span>
     <span class="main">⟶</span> <span class="free">t</span> <span class="main">=</span> <span class="bound">t'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> 
      <span class="skolem">b</span> <span class="skolem">s</span> <span class="skolem">p</span> <span class="skolem">n</span> <span class="skolem">t</span>
    <span class="keyword3"><span class="command">assume</span></span> 
      <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">case</span> <span class="skolem">b</span> <span class="keyword1">of</span> Self <span class="bound">i</span> <span class="main">⇒</span> <span class="keyword1">if</span> <span class="skolem">n</span> <span class="main">=</span> <span class="bound">i</span> <span class="keyword1">then</span> Fvar <span class="skolem">s</span> <span class="keyword1">else</span> Bvar <span class="skolem">b</span>
               <span class="main">|</span> Param <span class="bound">i</span> <span class="main">⇒</span> <span class="keyword1">if</span> <span class="skolem">n</span> <span class="main">=</span> <span class="bound">i</span> <span class="keyword1">then</span> Fvar <span class="skolem">p</span> <span class="keyword1">else</span> Bvar <span class="skolem">b</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">t</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"Fvar <span class="skolem">s</span> <span class="main">=</span> <span class="skolem">t</span> <span class="main">∨</span> Fvar <span class="skolem">p</span> <span class="main">=</span> <span class="skolem">t</span> <span class="main">∨</span> Bvar <span class="skolem">b</span> <span class="main">=</span> <span class="skolem">t</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">b</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">rename_tac</span> nat<span class="main"><span class="keyword3">,</span></span> <span class="operator">case_tac</span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="skolem"><span class="skolem">n</span></span> <span class="main"><span class="main">=</span></span> <span class="improper"><span class="improper">nat</span></span>"</span></span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">note</span></span> cT <span class="main">=</span> this

<span class="comment1">(* induction *)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">u</span>
  <span class="keyword1"><span class="command">have</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">n</span> <span class="bound">s</span> <span class="bound">p</span> <span class="bound">t'</span><span class="main">.</span> <span class="main">{</span><span class="bound">n</span> <span class="main">→</span> <span class="main">[</span>Fvar <span class="bound">s</span><span class="main">,</span> Fvar <span class="bound">p</span><span class="main">]}</span> <span class="free">t</span> <span class="main">=</span> <span class="main">{</span><span class="bound">n</span> <span class="main">→</span> <span class="main">[</span>Fvar <span class="bound">s</span><span class="main">,</span> Fvar <span class="bound">p</span><span class="main">]}</span> <span class="bound">t'</span>
      <span class="main">⟶</span> <span class="bound">s</span> <span class="main">∉</span> FV <span class="free">t</span> <span class="main">⟶</span> <span class="bound">s</span> <span class="main">∉</span> FV <span class="bound">t'</span> <span class="main">⟶</span> <span class="bound">p</span> <span class="main">∉</span> FV <span class="free">t</span> <span class="main">⟶</span> <span class="bound">p</span> <span class="main">∉</span> FV <span class="bound">t'</span> <span class="main">⟶</span> <span class="bound">s</span> <span class="main">≠</span> <span class="bound">p</span>
      <span class="main">⟶</span> <span class="free">t</span> <span class="main">=</span> <span class="bound">t'</span><span class="main">)</span>
    <span class="main">&amp;</span><span class="main">(</span><span class="main">∀</span><span class="bound">n</span> <span class="bound">s</span> <span class="bound">p</span> <span class="bound">u'</span><span class="main">.</span> sopen_option <span class="bound">n</span> <span class="main">(</span>Fvar <span class="bound">s</span><span class="main">)</span> <span class="main">(</span>Fvar <span class="bound">p</span><span class="main">)</span> <span class="skolem">u</span> 
                  <span class="main">=</span> sopen_option <span class="bound">n</span> <span class="main">(</span>Fvar <span class="bound">s</span><span class="main">)</span> <span class="main">(</span>Fvar <span class="bound">p</span><span class="main">)</span> <span class="bound">u'</span>
      <span class="main">⟶</span> <span class="bound">s</span> <span class="main">∉</span> FVoption <span class="skolem">u</span> <span class="main">⟶</span> <span class="bound">s</span> <span class="main">∉</span> FVoption <span class="bound">u'</span> 
      <span class="main">⟶</span> <span class="bound">p</span> <span class="main">∉</span> FVoption <span class="skolem">u</span> <span class="main">⟶</span> <span class="bound">p</span> <span class="main">∉</span> FVoption <span class="bound">u'</span> <span class="main">⟶</span> <span class="bound">s</span> <span class="main">≠</span> <span class="bound">p</span>
      <span class="main">⟶</span> <span class="skolem">u</span> <span class="main">=</span> <span class="bound">u'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="main">_</span> <span class="quoted"><span class="free">t</span></span> <span class="main">_</span> <span class="quoted"><span class="skolem">u</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> compat_sterm_sterm_option.induct<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Bvar <span class="skolem">b</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span> <span class="skolem">p</span> <span class="skolem">n</span> <span class="skolem">t</span>
      <span class="keyword3"><span class="command">assume</span></span> 
        a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">case</span> <span class="skolem">b</span> <span class="keyword1">of</span> Self <span class="bound">i</span> <span class="main">⇒</span> <span class="keyword1">if</span> <span class="skolem">n</span> <span class="main">=</span> <span class="bound">i</span> <span class="keyword1">then</span> Fvar <span class="skolem">s</span> <span class="keyword1">else</span> Bvar <span class="skolem">b</span>
                 <span class="main">|</span> Param <span class="bound">i</span> <span class="main">⇒</span> <span class="keyword1">if</span> <span class="skolem">n</span> <span class="main">=</span> <span class="bound">i</span> <span class="keyword1">then</span> Fvar <span class="skolem">p</span> <span class="keyword1">else</span> Bvar <span class="skolem">b</span><span class="main">)</span> 
         <span class="main">=</span> <span class="main">{</span><span class="skolem">n</span> <span class="main">→</span> <span class="main">[</span>Fvar <span class="skolem">s</span><span class="main">,</span>Fvar <span class="skolem">p</span><span class="main">]}</span> <span class="skolem">t</span>"</span></span>
      <span class="keyword1"><span class="command">note</span></span> cT<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∉</span> FV <span class="skolem">t</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∉</span> FV <span class="skolem">t</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">≠</span> <span class="skolem">p</span>"</span></span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Bvar <span class="skolem">b</span> <span class="main">=</span> <span class="skolem">t</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
        <span class="keyword1"><span class="command">{</span></span>
          <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">b'</span>
          <span class="keyword3"><span class="command">assume</span></span> 
            <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">case</span> <span class="skolem">b'</span> <span class="keyword1">of</span> Self <span class="bound">i</span> <span class="main">⇒</span> <span class="keyword1">if</span> <span class="skolem">n</span> <span class="main">=</span> <span class="bound">i</span> <span class="keyword1">then</span> Fvar <span class="skolem">s</span> <span class="keyword1">else</span> Bvar <span class="skolem">b'</span>
                      <span class="main">|</span> Param <span class="bound">i</span> <span class="main">⇒</span> <span class="keyword1">if</span> <span class="skolem">n</span> <span class="main">=</span> <span class="bound">i</span> <span class="keyword1">then</span> Fvar <span class="skolem">p</span> <span class="keyword1">else</span> Bvar <span class="skolem">b'</span><span class="main">)</span> <span class="main">=</span> Fvar <span class="skolem">s</span>"</span></span>
          <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">s</span> <span class="main">≠</span> <span class="skolem">p</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b'</span> <span class="main">=</span> Self <span class="skolem">n</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">b'</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">rename_tac</span> nat<span class="main"><span class="keyword3">,</span></span> <span class="operator">case_tac</span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="skolem"><span class="skolem">n</span></span> <span class="main"><span class="main">=</span></span> <span class="improper"><span class="improper">nat</span></span>"</span></span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">}</span></span><span class="keyword1"><span class="command">note</span></span> fvS <span class="main">=</span> this
        <span class="keyword3"><span class="command">assume</span></span> eq_s<span class="main">:</span> <span class="quoted"><span class="quoted">"Fvar <span class="skolem">s</span> <span class="main">=</span> <span class="main">{</span><span class="skolem">n</span> <span class="main">→</span> <span class="main">[</span>Fvar <span class="skolem">s</span><span class="main">,</span>Fvar <span class="skolem">p</span><span class="main">]}</span> <span class="skolem">t</span>"</span></span>
        <span class="keyword1"><span class="command">with</span></span> sym<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> <span class="quoted"><span class="quoted">‹<span class="skolem">s</span> <span class="main">∉</span> FV <span class="skolem">t</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">s</span> <span class="main">≠</span> <span class="skolem">p</span>›</span></span> fvS
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">=</span> Bvar <span class="main">(</span>Self <span class="skolem">n</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">t</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
        <span class="keyword1"><span class="command">moreover</span></span>
        <span class="keyword1"><span class="command">from</span></span> a sym<span class="main">[</span><span class="operator">OF</span> eq_s<span class="main">]</span> <span class="quoted"><span class="quoted">‹<span class="skolem">s</span> <span class="main">≠</span> <span class="skolem">p</span>›</span></span> fvS<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">b</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Self <span class="skolem">n</span> <span class="main">=</span> <span class="skolem">b</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Bvar <span class="skolem">b</span> <span class="main">=</span> <span class="skolem">t</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword1"><span class="command">{</span></span>
          <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">b'</span>
          <span class="keyword3"><span class="command">assume</span></span> 
            <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">case</span> <span class="skolem">b'</span> <span class="keyword1">of</span> Self <span class="bound">i</span> <span class="main">⇒</span> <span class="keyword1">if</span> <span class="skolem">n</span> <span class="main">=</span> <span class="bound">i</span> <span class="keyword1">then</span> Fvar <span class="skolem">s</span> <span class="keyword1">else</span> Bvar <span class="skolem">b'</span>
                      <span class="main">|</span> Param <span class="bound">i</span> <span class="main">⇒</span> <span class="keyword1">if</span> <span class="skolem">n</span> <span class="main">=</span> <span class="bound">i</span> <span class="keyword1">then</span> Fvar <span class="skolem">p</span> <span class="keyword1">else</span> Bvar <span class="skolem">b'</span><span class="main">)</span> <span class="main">=</span> Fvar <span class="skolem">p</span>"</span></span>
          <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">s</span> <span class="main">≠</span> <span class="skolem">p</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b'</span> <span class="main">=</span> Param <span class="skolem">n</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">b'</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">rename_tac</span> nat<span class="main"><span class="keyword3">,</span></span> <span class="operator">case_tac</span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="skolem"><span class="skolem">n</span></span> <span class="main"><span class="main">=</span></span> <span class="improper"><span class="improper">nat</span></span>"</span></span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">}</span></span><span class="keyword1"><span class="command">note</span></span> fvP <span class="main">=</span> this
        <span class="keyword3"><span class="command">assume</span></span> eq_p<span class="main">:</span> <span class="quoted"><span class="quoted">"Fvar <span class="skolem">p</span> <span class="main">=</span> <span class="main">{</span><span class="skolem">n</span> <span class="main">→</span> <span class="main">[</span>Fvar <span class="skolem">s</span><span class="main">,</span>Fvar <span class="skolem">p</span><span class="main">]}</span> <span class="skolem">t</span>"</span></span>
        <span class="keyword1"><span class="command">with</span></span> sym<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="main">∉</span> FV <span class="skolem">t</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">s</span> <span class="main">≠</span> <span class="skolem">p</span>›</span></span> fvP
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">=</span> Bvar <span class="main">(</span>Param <span class="skolem">n</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">t</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
        <span class="keyword1"><span class="command">moreover</span></span>
        <span class="keyword1"><span class="command">from</span></span> a sym<span class="main">[</span><span class="operator">OF</span> eq_p<span class="main">]</span> <span class="quoted"><span class="quoted">‹<span class="skolem">s</span> <span class="main">≠</span> <span class="skolem">p</span>›</span></span> fvP<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">b</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Param <span class="skolem">n</span> <span class="main">=</span> <span class="skolem">b</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Bvar <span class="skolem">b</span> <span class="main">=</span> <span class="skolem">t</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"Bvar <span class="skolem">b</span> <span class="main">=</span> <span class="main">{</span><span class="skolem">n</span> <span class="main">→</span> <span class="main">[</span>Fvar <span class="skolem">s</span><span class="main">,</span> Fvar <span class="skolem">p</span><span class="main">]}</span> <span class="skolem">t</span>"</span></span>
        <span class="keyword1"><span class="command">from</span></span> sym<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="skolem">n</span> <span class="main">→</span> <span class="main">[</span>Fvar <span class="skolem">s</span><span class="main">,</span>Fvar <span class="skolem">p</span><span class="main">]}</span> <span class="skolem">t</span> <span class="main">=</span> <span class="skolem">t</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">t</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
          <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">b'</span>
          <span class="keyword3"><span class="command">assume</span></span> 
            <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">case</span> <span class="skolem">b'</span> <span class="keyword1">of</span> Self <span class="bound">i</span> <span class="main">⇒</span> <span class="keyword1">if</span> <span class="skolem">n</span> <span class="main">=</span> <span class="bound">i</span> <span class="keyword1">then</span> Fvar <span class="skolem">s</span> <span class="keyword1">else</span> Bvar <span class="skolem">b'</span>
                      <span class="main">|</span> Param <span class="bound">i</span> <span class="main">⇒</span> <span class="keyword1">if</span> <span class="skolem">n</span> <span class="main">=</span> <span class="bound">i</span> <span class="keyword1">then</span> Fvar <span class="skolem">p</span> <span class="keyword1">else</span> Bvar <span class="skolem">b'</span><span class="main">)</span> <span class="main">=</span> Bvar <span class="skolem">b</span>"</span></span>
          <span class="keyword1"><span class="command">from</span></span> cT<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Bvar <span class="skolem">b</span> <span class="main">=</span> Bvar <span class="skolem">b'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">=</span> <span class="skolem">b'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Fvar <span class="skolem">x</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">n</span> <span class="skolem">s</span> <span class="skolem">p</span> <span class="skolem">t</span>
      <span class="keyword3"><span class="command">assume</span></span> 
        a<span class="main">:</span> <span class="quoted"><span class="quoted">"Fvar <span class="skolem">x</span> <span class="main">=</span> <span class="main">{</span><span class="skolem">n</span> <span class="main">→</span> <span class="main">[</span>Fvar <span class="skolem">s</span><span class="main">,</span>Fvar <span class="skolem">p</span><span class="main">]}</span> <span class="skolem">t</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
        <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∉</span> FV <span class="main">(</span><span class="main">{</span><span class="skolem">n</span> <span class="main">→</span> <span class="main">[</span>Fvar <span class="skolem">s</span><span class="main">,</span>Fvar <span class="skolem">p</span><span class="main">]}</span> <span class="skolem">t</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">≠</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∉</span> FV <span class="main">(</span><span class="main">{</span><span class="skolem">n</span> <span class="main">→</span> <span class="main">[</span>Fvar <span class="skolem">s</span><span class="main">,</span>Fvar <span class="skolem">p</span><span class="main">]}</span> <span class="skolem">t</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">with</span></span> a <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">≠</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
      <span class="keyword1"><span class="command">ultimately</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="skolem">n</span> <span class="main">→</span> <span class="main">[</span>Fvar <span class="skolem">s</span><span class="main">,</span>Fvar <span class="skolem">p</span><span class="main">]}</span> <span class="skolem">t</span> <span class="main">=</span> <span class="skolem">t</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> a
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">t</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">b</span>
        <span class="keyword3"><span class="command">assume</span></span> 
          <span class="quoted"><span class="quoted">"Fvar <span class="skolem">x</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="skolem">b</span> <span class="keyword1">of</span> Self <span class="bound">i</span> <span class="main">⇒</span> <span class="keyword1">if</span> <span class="skolem">n</span> <span class="main">=</span> <span class="bound">i</span> <span class="keyword1">then</span> Fvar <span class="skolem">s</span> <span class="keyword1">else</span> Bvar <span class="skolem">b</span>
                            <span class="main">|</span> Param <span class="bound">i</span> <span class="main">⇒</span> <span class="keyword1">if</span> <span class="skolem">n</span> <span class="main">=</span> <span class="bound">i</span> <span class="keyword1">then</span> Fvar <span class="skolem">p</span> <span class="keyword1">else</span> Bvar <span class="skolem">b</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">from</span></span> cT<span class="main">[</span><span class="operator">OF</span> sym<span class="main"><span class="main">[</span></span><span class="operator">OF</span> this<span class="main"><span class="main">]</span></span><span class="main">]</span> <span class="quoted"><span class="quoted">‹<span class="skolem">s</span> <span class="main">≠</span> <span class="skolem">x</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="main">≠</span> <span class="skolem">x</span>›</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> 
          <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">case</span> <span class="skolem">b</span> <span class="keyword1">of</span> Self <span class="bound">i</span> <span class="main">⇒</span> <span class="keyword1">if</span> <span class="skolem">n</span> <span class="main">=</span> <span class="bound">i</span> <span class="keyword1">then</span> Fvar <span class="skolem">s</span> <span class="keyword1">else</span> Bvar <span class="skolem">b</span>
                   <span class="main">|</span> Param <span class="bound">i</span> <span class="main">⇒</span> <span class="keyword1">if</span> <span class="skolem">n</span> <span class="main">=</span> <span class="bound">i</span> <span class="keyword1">then</span> Fvar <span class="skolem">p</span> <span class="keyword1">else</span> Bvar <span class="skolem">b</span><span class="main">)</span> <span class="main">=</span> Bvar <span class="skolem">b</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Obj <span class="skolem">f</span> <span class="skolem">T</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">n</span> <span class="skolem">s</span> <span class="skolem">p</span> <span class="skolem">t</span>
      <span class="keyword3"><span class="command">assume</span></span> 
        <span class="quoted"><span class="quoted">"Obj <span class="main">(</span><span class="main">λ</span><span class="bound">l</span><span class="main">.</span> sopen_option <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="main">(</span>Fvar <span class="skolem">s</span><span class="main">)</span> <span class="main">(</span>Fvar <span class="skolem">p</span><span class="main">)</span> <span class="main">(</span><span class="skolem">f</span> <span class="bound">l</span><span class="main">)</span><span class="main">)</span> <span class="skolem">T</span> 
         <span class="main">=</span> <span class="main">{</span><span class="skolem">n</span> <span class="main">→</span> <span class="main">[</span>Fvar <span class="skolem">s</span><span class="main">,</span>Fvar <span class="skolem">p</span><span class="main">]}</span> <span class="skolem">t</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
        <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">l</span><span class="main">∈</span>dom <span class="skolem">f</span><span class="main">.</span> <span class="skolem">s</span> <span class="main">∉</span> FVoption <span class="main">(</span><span class="skolem">f</span> <span class="bound">l</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 
        <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">l</span><span class="main">∈</span>dom <span class="skolem">f</span><span class="main">.</span> <span class="skolem">p</span> <span class="main">∉</span> FVoption <span class="main">(</span><span class="skolem">f</span> <span class="bound">l</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
        <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∉</span> FV <span class="skolem">t</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∉</span> FV <span class="skolem">t</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">≠</span> <span class="skolem">p</span>"</span></span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"Obj <span class="skolem">f</span> <span class="skolem">T</span> <span class="main">=</span> <span class="skolem">t</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Obj
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">t</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
          <span class="comment1">(* case Bvar *)</span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">b</span>
        <span class="keyword3"><span class="command">assume</span></span> 
          <span class="quoted"><span class="quoted">"Obj <span class="main">(</span><span class="main">λ</span><span class="bound">l</span><span class="main">.</span> sopen_option <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="main">(</span>Fvar <span class="skolem">s</span><span class="main">)</span> <span class="main">(</span>Fvar <span class="skolem">p</span><span class="main">)</span> <span class="main">(</span><span class="skolem">f</span> <span class="bound">l</span><span class="main">)</span><span class="main">)</span> <span class="skolem">T</span> 
           <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="skolem">b</span> <span class="keyword1">of</span> Self <span class="bound">i</span> <span class="main">⇒</span> <span class="keyword1">if</span> <span class="skolem">n</span> <span class="main">=</span> <span class="bound">i</span> <span class="keyword1">then</span> Fvar <span class="skolem">s</span> <span class="keyword1">else</span> Bvar <span class="skolem">b</span>
                     <span class="main">|</span> Param <span class="bound">i</span> <span class="main">⇒</span> <span class="keyword1">if</span> <span class="skolem">n</span> <span class="main">=</span> <span class="bound">i</span> <span class="keyword1">then</span> Fvar <span class="skolem">p</span> <span class="keyword1">else</span> Bvar <span class="skolem">b</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">from</span></span> cT<span class="main">[</span><span class="operator">OF</span> sym<span class="main"><span class="main">[</span></span><span class="operator">OF</span> this<span class="main"><span class="main">]</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">next</span></span>
          <span class="comment1">(* case Obj *)</span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">f'</span>
        <span class="keyword3"><span class="command">assume</span></span> 
          nin_s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">l</span><span class="main">∈</span>dom <span class="skolem">f'</span><span class="main">.</span> <span class="skolem">s</span> <span class="main">∉</span> FVoption <span class="main">(</span><span class="skolem">f'</span> <span class="bound">l</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
          nin_p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">l</span><span class="main">∈</span>dom <span class="skolem">f'</span><span class="main">.</span> <span class="skolem">p</span> <span class="main">∉</span> FVoption <span class="main">(</span><span class="skolem">f'</span> <span class="bound">l</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
          ff'<span class="main">:</span>   <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">l</span><span class="main">.</span> sopen_option <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="main">(</span>Fvar <span class="skolem">s</span><span class="main">)</span> <span class="main">(</span>Fvar <span class="skolem">p</span><span class="main">)</span> <span class="main">(</span><span class="skolem">f</span> <span class="bound">l</span><span class="main">)</span><span class="main">)</span> 
                  <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">l</span><span class="main">.</span> sopen_option <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="main">(</span>Fvar <span class="skolem">s</span><span class="main">)</span> <span class="main">(</span>Fvar <span class="skolem">p</span><span class="main">)</span> <span class="main">(</span><span class="skolem">f'</span> <span class="bound">l</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">l</span><span class="main">.</span> <span class="skolem">f</span> <span class="bound">l</span> <span class="main">=</span> <span class="skolem">f'</span> <span class="bound">l</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
          <span class="keyword3"><span class="command">fix</span></span>  <span class="skolem">l</span>
          <span class="keyword1"><span class="command">from</span></span> ff'
          <span class="keyword1"><span class="command">have</span></span> 
            <span class="quoted"><span class="quoted">"sopen_option <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="main">(</span>Fvar <span class="skolem">s</span><span class="main">)</span> <span class="main">(</span>Fvar <span class="skolem">p</span><span class="main">)</span> <span class="main">(</span><span class="skolem">f</span> <span class="skolem">l</span><span class="main">)</span> 
             <span class="main">=</span> sopen_option <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="main">(</span>Fvar <span class="skolem">s</span><span class="main">)</span> <span class="main">(</span>Fvar <span class="skolem">p</span><span class="main">)</span> <span class="main">(</span><span class="skolem">f'</span> <span class="skolem">l</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> cong<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
          <span class="keyword1"><span class="command">moreover</span></span>
          <span class="keyword1"><span class="command">from</span></span> 
            <span class="quoted"><span class="quoted">‹<span class="main">∀</span><span class="bound">l</span><span class="main">∈</span>dom <span class="skolem">f</span><span class="main">.</span> <span class="skolem">s</span> <span class="main">∉</span> FVoption <span class="main">(</span><span class="skolem">f</span> <span class="bound">l</span><span class="main">)</span>›</span></span>
            <span class="quoted"><span class="quoted">‹<span class="main">∀</span><span class="bound">l</span><span class="main">∈</span>dom <span class="skolem">f</span><span class="main">.</span> <span class="skolem">p</span> <span class="main">∉</span> FVoption <span class="main">(</span><span class="skolem">f</span> <span class="bound">l</span><span class="main">)</span>›</span></span> 
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∉</span> FVoption <span class="main">(</span><span class="skolem">f</span> <span class="skolem">l</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∉</span> FVoption <span class="main">(</span><span class="skolem">f</span> <span class="skolem">l</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="skolem"><span class="skolem">l</span></span> <span class="main"><span class="main">∈</span></span> dom <span class="skolem"><span class="skolem">f</span></span>"</span></span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
          <span class="keyword1"><span class="command">moreover</span></span>
          <span class="keyword1"><span class="command">from</span></span> nin_s nin_p <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∉</span> FVoption <span class="main">(</span><span class="skolem">f'</span> <span class="skolem">l</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∉</span> FVoption <span class="main">(</span><span class="skolem">f'</span> <span class="skolem">l</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="skolem"><span class="skolem">l</span></span> <span class="main"><span class="main">∈</span></span> dom <span class="skolem"><span class="skolem">f'</span></span>"</span></span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
          <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="skolem">l</span> <span class="main">=</span> <span class="skolem">f'</span> <span class="skolem">l</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Obj<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">l</span></span><span class="main">]</span> <span class="quoted"><span class="quoted">‹<span class="skolem">s</span> <span class="main">≠</span> <span class="skolem">p</span>›</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">=</span> <span class="skolem">f'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Call <span class="skolem">t1</span> <span class="skolem">l</span> <span class="skolem">t2</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">n</span> <span class="skolem">s</span> <span class="skolem">p</span> <span class="skolem">t</span>
      <span class="keyword3"><span class="command">assume</span></span> 
        <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∉</span> FV <span class="skolem">t1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∉</span> FV <span class="skolem">t2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∉</span> FV <span class="skolem">t1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∉</span> FV <span class="skolem">t2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
        <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">≠</span> <span class="skolem">p</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∉</span> FV <span class="skolem">t</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∉</span> FV <span class="skolem">t</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 
        <span class="quoted"><span class="quoted">"Call <span class="main">(</span><span class="main">{</span><span class="skolem">n</span> <span class="main">→</span> <span class="main">[</span>Fvar <span class="skolem">s</span><span class="main">,</span>Fvar <span class="skolem">p</span><span class="main">]}</span> <span class="skolem">t1</span><span class="main">)</span> <span class="skolem">l</span> <span class="main">(</span><span class="main">{</span><span class="skolem">n</span> <span class="main">→</span> <span class="main">[</span>Fvar <span class="skolem">s</span><span class="main">,</span>Fvar <span class="skolem">p</span><span class="main">]}</span> <span class="skolem">t2</span><span class="main">)</span>
         <span class="main">=</span> <span class="main">{</span><span class="skolem">n</span> <span class="main">→</span> <span class="main">[</span>Fvar <span class="skolem">s</span><span class="main">,</span>Fvar <span class="skolem">p</span><span class="main">]}</span> <span class="skolem">t</span>"</span></span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"Call <span class="skolem">t1</span> <span class="skolem">l</span> <span class="skolem">t2</span> <span class="main">=</span> <span class="skolem">t</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Call
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">t</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
          <span class="comment1">(* case Bvar *)</span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">b</span>
        <span class="keyword3"><span class="command">assume</span></span> 
          <span class="quoted"><span class="quoted">"Call <span class="main">(</span><span class="main">{</span><span class="skolem">n</span> <span class="main">→</span> <span class="main">[</span>Fvar <span class="skolem">s</span><span class="main">,</span>Fvar <span class="skolem">p</span><span class="main">]}</span> <span class="skolem">t1</span><span class="main">)</span> <span class="skolem">l</span> <span class="main">(</span><span class="main">{</span><span class="skolem">n</span> <span class="main">→</span> <span class="main">[</span>Fvar <span class="skolem">s</span><span class="main">,</span>Fvar <span class="skolem">p</span><span class="main">]}</span> <span class="skolem">t2</span><span class="main">)</span> 
           <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="skolem">b</span> <span class="keyword1">of</span> Self <span class="bound">i</span> <span class="main">⇒</span> <span class="keyword1">if</span> <span class="skolem">n</span> <span class="main">=</span> <span class="bound">i</span> <span class="keyword1">then</span> Fvar <span class="skolem">s</span> <span class="keyword1">else</span> Bvar <span class="skolem">b</span>
                     <span class="main">|</span> Param <span class="bound">i</span> <span class="main">⇒</span> <span class="keyword1">if</span> <span class="skolem">n</span> <span class="main">=</span> <span class="bound">i</span> <span class="keyword1">then</span> Fvar <span class="skolem">p</span> <span class="keyword1">else</span> Bvar <span class="skolem">b</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">from</span></span> cT<span class="main">[</span><span class="operator">OF</span> sym<span class="main"><span class="main">[</span></span><span class="operator">OF</span> this<span class="main"><span class="main">]</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Upd <span class="skolem">t1</span> <span class="skolem">l</span> <span class="skolem">t2</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">n</span> <span class="skolem">s</span> <span class="skolem">p</span> <span class="skolem">t</span>
      <span class="keyword3"><span class="command">assume</span></span> 
        <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∉</span> FV <span class="skolem">t1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∉</span> FV <span class="skolem">t2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∉</span> FV <span class="skolem">t1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∉</span> FV <span class="skolem">t2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
        <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">≠</span> <span class="skolem">p</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∉</span> FV <span class="skolem">t</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∉</span> FV <span class="skolem">t</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
        <span class="quoted"><span class="quoted">"Upd <span class="main">(</span><span class="main">{</span><span class="skolem">n</span> <span class="main">→</span> <span class="main">[</span>Fvar <span class="skolem">s</span><span class="main">,</span>Fvar <span class="skolem">p</span><span class="main">]}</span> <span class="skolem">t1</span><span class="main">)</span> <span class="skolem">l</span> <span class="main">(</span><span class="main">{</span>Suc <span class="skolem">n</span> <span class="main">→</span> <span class="main">[</span>Fvar <span class="skolem">s</span><span class="main">,</span>Fvar <span class="skolem">p</span><span class="main">]}</span> <span class="skolem">t2</span><span class="main">)</span>
         <span class="main">=</span> <span class="main">{</span><span class="skolem">n</span> <span class="main">→</span> <span class="main">[</span>Fvar <span class="skolem">s</span><span class="main">,</span>Fvar <span class="skolem">p</span><span class="main">]}</span> <span class="skolem">t</span>"</span></span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"Upd <span class="skolem">t1</span> <span class="skolem">l</span> <span class="skolem">t2</span> <span class="main">=</span> <span class="skolem">t</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Upd
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">t</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
          <span class="comment1">(* case Bvar *)</span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">b</span>
        <span class="keyword3"><span class="command">assume</span></span> 
          <span class="quoted"><span class="quoted">"Upd <span class="main">(</span><span class="main">{</span><span class="skolem">n</span> <span class="main">→</span> <span class="main">[</span>Fvar <span class="skolem">s</span><span class="main">,</span>Fvar <span class="skolem">p</span><span class="main">]}</span> <span class="skolem">t1</span><span class="main">)</span> <span class="skolem">l</span> <span class="main">(</span><span class="main">{</span>Suc <span class="skolem">n</span> <span class="main">→</span> <span class="main">[</span>Fvar <span class="skolem">s</span><span class="main">,</span>Fvar <span class="skolem">p</span><span class="main">]}</span> <span class="skolem">t2</span><span class="main">)</span> 
           <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="skolem">b</span> <span class="keyword1">of</span> Self <span class="bound">i</span> <span class="main">⇒</span> <span class="keyword1">if</span> <span class="skolem">n</span> <span class="main">=</span> <span class="bound">i</span> <span class="keyword1">then</span> Fvar <span class="skolem">s</span> <span class="keyword1">else</span> Bvar <span class="skolem">b</span>
                     <span class="main">|</span> Param <span class="bound">i</span> <span class="main">⇒</span> <span class="keyword1">if</span> <span class="skolem">n</span> <span class="main">=</span> <span class="bound">i</span> <span class="keyword1">then</span> Fvar <span class="skolem">p</span> <span class="keyword1">else</span> Bvar <span class="skolem">b</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">from</span></span> cT<span class="main">[</span><span class="operator">OF</span> sym<span class="main"><span class="main">[</span></span><span class="operator">OF</span> this<span class="main"><span class="main">]</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> None_sterm <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">u</span> <span class="skolem">s</span> <span class="skolem">p</span> <span class="skolem">n</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"None <span class="main">=</span> sopen_option <span class="skolem">n</span> <span class="main">(</span>Fvar <span class="skolem">s</span><span class="main">)</span> <span class="main">(</span>Fvar <span class="skolem">p</span><span class="main">)</span> <span class="skolem">u</span>"</span></span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"None <span class="main">=</span> <span class="skolem">u</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">u</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Some_sterm <span class="skolem">t</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">u</span> <span class="skolem">s</span> <span class="skolem">p</span> <span class="skolem">n</span>
      <span class="keyword3"><span class="command">assume</span></span> 
        <span class="quoted"><span class="quoted">"Some <span class="main">(</span><span class="main">{</span><span class="skolem">n</span> <span class="main">→</span> <span class="main">[</span>Fvar <span class="skolem">s</span><span class="main">,</span>Fvar <span class="skolem">p</span><span class="main">]}</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">=</span> sopen_option <span class="skolem">n</span> <span class="main">(</span>Fvar <span class="skolem">s</span><span class="main">)</span> <span class="main">(</span>Fvar <span class="skolem">p</span><span class="main">)</span> <span class="skolem">u</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
        <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∉</span> FV <span class="skolem">t</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∉</span> FV <span class="skolem">t</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">≠</span> <span class="skolem">p</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 
        <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∉</span> FVoption <span class="skolem">u</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∉</span> FVoption <span class="skolem">u</span>"</span></span>
      <span class="keyword1"><span class="command">with</span></span> Some_sterm <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Some <span class="skolem">t</span> <span class="main">=</span> <span class="skolem">u</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">u</span></span><span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">from</span></span> conjunct1<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">assumption</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Variable closing›</span></span>
<span class="keyword1"><span class="command">primrec</span></span>
 <span class="entity">sclose</span>        <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>nat<span class="main">,</span> fVariable<span class="main">,</span> fVariable<span class="main">,</span> sterm<span class="main">]</span> <span class="main">⇒</span> sterm"</span></span> 
 <span class="main">(</span><span class="quoted">"<span class="keyword1">{</span>_ <span class="keyword1">←</span> <span class="keyword1">[</span>_<span class="keyword1">,</span>_<span class="keyword1">]}</span> _"</span> <span class="main">[</span>0<span class="main">,</span> 0<span class="main">,</span> 0<span class="main">,</span> 300<span class="main">]</span> 300<span class="main">)</span>
<span class="keyword2"><span class="keyword">and</span></span>
 <span class="entity">sclose_option</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>nat<span class="main">,</span> fVariable<span class="main">,</span> fVariable<span class="main">,</span> sterm option<span class="main">]</span> <span class="main">⇒</span> sterm option"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  sclose_Bvar<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main"><span class="free">{</span></span><span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main"><span class="free">←</span></span> <span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main"><span class="free">,</span></span><span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main"><span class="free">]}</span></span><span class="main">(</span>Bvar <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="main">=</span> Bvar <span class="free"><span class="bound"><span class="entity">b</span></span></span>"</span></span>
<span class="main">|</span> sclose_Fvar<span class="main">:</span> 
    <span class="quoted"><span class="quoted">"<span class="main"><span class="free">{</span></span><span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main"><span class="free">←</span></span> <span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main"><span class="free">,</span></span><span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main"><span class="free">]}</span></span><span class="main">(</span>Fvar <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="keyword1">then</span> <span class="main">(</span>Bvar <span class="main">(</span>Self <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">)</span><span class="main">)</span> 
                                      <span class="keyword1">else</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="keyword1">then</span> <span class="main">(</span>Bvar <span class="main">(</span>Param <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">)</span><span class="main">)</span>
                                                     <span class="keyword1">else</span> <span class="main">(</span>Fvar <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> sclose_Call<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main"><span class="free">{</span></span><span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main"><span class="free">←</span></span> <span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main"><span class="free">,</span></span><span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main"><span class="free">]}</span></span><span class="main">(</span>Call <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="main">=</span> Call <span class="main">(</span><span class="main"><span class="free">{</span></span><span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main"><span class="free">←</span></span> <span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main"><span class="free">,</span></span><span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main"><span class="free">]}</span></span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">(</span><span class="main"><span class="free">{</span></span><span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main"><span class="free">←</span></span> <span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main"><span class="free">,</span></span><span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main"><span class="free">]}</span></span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> sclose_Upd <span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main"><span class="free">{</span></span><span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main"><span class="free">←</span></span> <span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main"><span class="free">,</span></span><span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main"><span class="free">]}</span></span><span class="main">(</span>Upd <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">)</span> <span class="main">=</span> Upd <span class="main">(</span><span class="main"><span class="free">{</span></span><span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main"><span class="free">←</span></span> <span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main"><span class="free">,</span></span><span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main"><span class="free">]}</span></span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">(</span><span class="main"><span class="free">{</span></span><span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">)</span> <span class="main"><span class="free">←</span></span> <span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main"><span class="free">,</span></span><span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main"><span class="free">]}</span></span><span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> sclose_Obj <span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main"><span class="free">{</span></span><span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main"><span class="free">←</span></span> <span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main"><span class="free">,</span></span><span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main"><span class="free">]}</span></span><span class="main">(</span>Obj <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main">)</span> <span class="main">=</span> Obj <span class="main">(</span><span class="main">λ</span><span class="bound">l</span><span class="main">.</span> <span class="free">sclose_option</span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">l</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">T</span></span></span>"</span></span>
<span class="main">|</span> sclose_None<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">sclose_option</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> None <span class="main">=</span> None"</span></span>
<span class="main">|</span> sclose_Some<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">sclose_option</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span><span class="main"><span class="free">{</span></span><span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main"><span class="free">←</span></span> <span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main"><span class="free">,</span></span><span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main"><span class="free">]}</span></span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">closez</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>fVariable<span class="main">,</span> fVariable<span class="main">,</span> sterm<span class="main">]</span> <span class="main">⇒</span> sterm"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">σ[</span>_<span class="keyword1">,</span>_<span class="keyword1">]</span> _"</span> <span class="main">[</span>0<span class="main">,</span> 0<span class="main">,</span> 300<span class="main">]</span><span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
 <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">σ[</span></span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main"><span class="free">,</span></span><span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main"><span class="free">]</span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> <span class="main">{</span><span class="main">0</span> <span class="main">←</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">]}</span><span class="free"><span class="bound"><span class="entity">t</span></span></span>"</span></span>

<span class="keyword1" id="Sigma-dom_scloseoption_lem"><span class="command">lemma</span></span> dom_scloseoption_lem<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"dom <span class="main">(</span><span class="main">λ</span><span class="bound">l</span><span class="main">.</span> sclose_option <span class="free">k</span> <span class="free">s</span> <span class="free">t</span> <span class="main">(</span><span class="free">f</span> <span class="bound">l</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> dom <span class="free">f</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="improper">x</span> <span class="main">∈</span> dom <span class="free">f</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="Sigma-sclose_option_lem"><span class="command">lemma</span></span> sclose_option_lem<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">l</span><span class="main">∈</span>dom <span class="free">f</span><span class="main">.</span> <span class="main">{</span><span class="free">n</span> <span class="main">←</span> <span class="main">[</span><span class="free">s</span><span class="main">,</span><span class="free">p</span><span class="main">]}</span> the<span class="main">(</span><span class="free">f</span> <span class="bound">l</span><span class="main">)</span> <span class="main">=</span> the <span class="main">(</span>sclose_option <span class="free">n</span> <span class="free">s</span> <span class="free">p</span> <span class="main">(</span><span class="free">f</span> <span class="bound">l</span><span class="main">)</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Sigma-pred_scloseoption_lem"><span class="command">lemma</span></span> pred_scloseoption_lem<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">l</span><span class="main">∈</span>dom <span class="main">(</span><span class="main">λ</span><span class="bound">l</span><span class="main">.</span> sclose_option <span class="free">n</span> <span class="free">s</span> <span class="free">p</span> <span class="main">(</span><span class="free">f</span> <span class="bound">l</span><span class="main">)</span><span class="main">)</span><span class="main">.</span>
     <span class="main">(</span><span class="free">P</span><span class="main">::</span>sterm <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">(</span>the <span class="main">(</span>sclose_option <span class="free">n</span> <span class="free">s</span> <span class="free">p</span> <span class="main">(</span><span class="free">f</span> <span class="bound">l</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
   <span class="main">(</span><span class="main">∀</span><span class="bound">l</span><span class="main">∈</span>dom <span class="free">f</span><span class="main">.</span> <span class="main">(</span><span class="free">P</span><span class="main">::</span>sterm <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">(</span><span class="main">{</span><span class="free">n</span> <span class="main">←</span> <span class="main">[</span><span class="free">s</span><span class="main">,</span><span class="free">p</span><span class="main">]}</span> the <span class="main">(</span><span class="free">f</span> <span class="bound">l</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">force</span><span class="main">)</span>

<span class="keyword1" id="Sigma-sclose_fresh"><span class="command">lemma</span></span> sclose_fresh<span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">n</span> <span class="bound">s</span> <span class="bound">p</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∉</span> FV <span class="free">t</span> <span class="main">⟶</span> <span class="bound">p</span> <span class="main">∉</span> FV <span class="free">t</span> <span class="main">⟶</span> <span class="main">{</span><span class="bound">n</span> <span class="main">←</span> <span class="main">[</span><span class="bound">s</span><span class="main">,</span><span class="bound">p</span><span class="main">]}</span> <span class="free">t</span> <span class="main">=</span> <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> 
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">n</span> <span class="bound">s</span> <span class="bound">p</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∉</span> FV <span class="free">t</span> <span class="main">⟶</span> <span class="bound">p</span> <span class="main">∉</span> FV <span class="free">t</span> <span class="main">⟶</span> <span class="main">{</span><span class="bound">n</span> <span class="main">←</span> <span class="main">[</span><span class="bound">s</span><span class="main">,</span><span class="bound">p</span><span class="main">]}</span> <span class="free">t</span> <span class="main">=</span> <span class="free">t</span><span class="main">)</span>
    <span class="main">&amp;</span><span class="main">(</span><span class="main">∀</span><span class="bound">n</span> <span class="bound">s</span> <span class="bound">p</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∉</span> FVoption <span class="free">u</span> <span class="main">⟶</span> <span class="bound">p</span> <span class="main">∉</span> FVoption <span class="free">u</span> 
       <span class="main">⟶</span> sclose_option <span class="bound">n</span> <span class="bound">s</span> <span class="bound">p</span> <span class="free">u</span> <span class="main">=</span> <span class="free">u</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="main">_</span> <span class="quoted"><span class="free">t</span></span> <span class="main">_</span> <span class="quoted"><span class="free">u</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> compat_sterm_sterm_option.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> bVariable.split<span class="main">)</span>
    <span class="comment1">(* Obj *)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">f</span> <span class="skolem">n</span> <span class="skolem">s</span> <span class="skolem">p</span>
    <span class="keyword3"><span class="command">assume</span></span> 
      nin_s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">l</span><span class="main">∈</span>dom <span class="skolem">f</span><span class="main">.</span> <span class="skolem">s</span> <span class="main">∉</span> FVoption <span class="main">(</span><span class="skolem">f</span> <span class="bound">l</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 
      nin_p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">l</span><span class="main">∈</span>dom <span class="skolem">f</span><span class="main">.</span> <span class="skolem">p</span> <span class="main">∉</span> FVoption <span class="main">(</span><span class="skolem">f</span> <span class="bound">l</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">l</span> <span class="keyword1"><span class="command">from</span></span> nin_s <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∉</span> FVoption <span class="main">(</span><span class="skolem">f</span> <span class="skolem">l</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">∈</span> dom <span class="skolem">f</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">l</span> <span class="keyword1"><span class="command">from</span></span> nin_p <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∉</span> FVoption <span class="main">(</span><span class="skolem">f</span> <span class="skolem">l</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">∈</span> dom <span class="skolem">f</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> 
    <span class="keyword3"><span class="command">assume</span></span> 
      <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="main">∀</span><span class="bound">n</span> <span class="bound">s</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∉</span> FVoption <span class="main">(</span><span class="skolem">f</span> <span class="bound">x</span><span class="main">)</span> 
             <span class="main">⟶</span> <span class="main">(</span><span class="main">∀</span><span class="bound">p</span><span class="main">.</span> <span class="bound">p</span> <span class="main">∉</span> FVoption <span class="main">(</span><span class="skolem">f</span> <span class="bound">x</span><span class="main">)</span> 
                   <span class="main">⟶</span> sclose_option <span class="bound">n</span> <span class="bound">s</span> <span class="bound">p</span> <span class="main">(</span><span class="skolem">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">f</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">l</span><span class="main">.</span> sclose_option <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="skolem">s</span> <span class="skolem">p</span> <span class="main">(</span><span class="skolem">f</span> <span class="bound">l</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">f</span> <span class="bound">l</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> ext <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">l</span><span class="main">.</span> sclose_option <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="skolem">s</span> <span class="skolem">p</span> <span class="main">(</span><span class="skolem">f</span> <span class="bound">l</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">f</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">from</span></span> conjunct1<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">assumption</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Sigma-sclose_FV"><span class="command">lemma</span></span> sclose_FV<span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">n</span> <span class="bound">s</span> <span class="bound">p</span><span class="main">.</span> FV <span class="main">(</span><span class="main">{</span><span class="bound">n</span> <span class="main">←</span> <span class="main">[</span><span class="bound">s</span><span class="main">,</span><span class="bound">p</span><span class="main">]}</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> FV <span class="free">t</span> <span class="main">-</span> <span class="main">{</span><span class="bound">s</span><span class="main">}</span> <span class="main">-</span> <span class="main">{</span><span class="bound">p</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">n</span> <span class="bound">s</span> <span class="bound">p</span><span class="main">.</span> FV <span class="main">(</span><span class="main">{</span><span class="bound">n</span> <span class="main">←</span> <span class="main">[</span><span class="bound">s</span><span class="main">,</span><span class="bound">p</span><span class="main">]}</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> FV <span class="free">t</span> <span class="main">-</span> <span class="main">{</span><span class="bound">s</span><span class="main">}</span> <span class="main">-</span> <span class="main">{</span><span class="bound">p</span><span class="main">}</span><span class="main">)</span>
    <span class="main">&amp;</span><span class="main">(</span><span class="main">∀</span><span class="bound">n</span> <span class="bound">s</span> <span class="bound">p</span><span class="main">.</span> FVoption <span class="main">(</span>sclose_option <span class="bound">n</span> <span class="bound">s</span> <span class="bound">p</span> <span class="free">u</span><span class="main">)</span> <span class="main">=</span> FVoption <span class="free">u</span> <span class="main">-</span> <span class="main">{</span><span class="bound">s</span><span class="main">}</span> <span class="main">-</span> <span class="main">{</span><span class="bound">p</span><span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> compat_sterm_sterm_option.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> bVariable.split<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> conjunct1<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">assumption</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Sigma-sclose_subset_FV"><span class="command">lemma</span></span> sclose_subset_FV<span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"FV <span class="main">(</span><span class="main">{</span><span class="free">n</span> <span class="main">←</span> <span class="main">[</span><span class="free">s</span><span class="main">,</span><span class="free">p</span><span class="main">]}</span> <span class="free">t</span><span class="main">)</span> <span class="main">⊆</span> FV <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sclose_FV<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>

<span class="keyword1" id="Sigma-Self_not_in_closed"><span class="command">lemma</span></span> Self_not_in_closed<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">sa</span> <span class="main">∉</span> FV <span class="main">(</span><span class="main">{</span><span class="free">n</span> <span class="main">←</span> <span class="main">[</span><span class="free">sa</span><span class="main">,</span><span class="free">pa</span><span class="main">]}</span> <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sclose_FV<span class="main">)</span>

<span class="keyword1" id="Sigma-Param_not_in_closed"><span class="command">lemma</span></span> Param_not_in_closed<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">pa</span> <span class="main">∉</span> FV <span class="main">(</span><span class="main">{</span><span class="free">n</span> <span class="main">←</span> <span class="main">[</span><span class="free">sa</span><span class="main">,</span><span class="free">pa</span><span class="main">]}</span> <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sclose_FV<span class="main">)</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Substitution›</span></span>
<span class="keyword1"><span class="command">primrec</span></span>
 <span class="entity">ssubst</span>        <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>fVariable<span class="main">,</span> sterm<span class="main">,</span> sterm<span class="main">]</span> <span class="main">⇒</span> sterm"</span></span> 
 <span class="main">(</span><span class="quoted">"<span class="keyword1">[</span>_ <span class="keyword1">→</span> _<span class="keyword1">]</span> _"</span> <span class="main">[</span>0<span class="main">,</span> 0<span class="main">,</span> 300<span class="main">]</span> 300<span class="main">)</span>
<span class="keyword2"><span class="keyword">and</span></span>
 <span class="entity">ssubst_option</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>fVariable<span class="main">,</span> sterm<span class="main">,</span> sterm option<span class="main">]</span> <span class="main">⇒</span> sterm option"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  ssubst_Bvar<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">z</span></span></span> <span class="main"><span class="free">→</span></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main"><span class="free">]</span></span><span class="main">(</span>Bvar <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span> <span class="main">=</span> Bvar <span class="free"><span class="bound"><span class="entity">v</span></span></span>"</span></span>
<span class="main">|</span> ssubst_Fvar<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">z</span></span></span> <span class="main"><span class="free">→</span></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main"><span class="free">]</span></span><span class="main">(</span>Fvar <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">z</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="keyword1">else</span> <span class="main">(</span>Fvar <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> ssubst_Call<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">z</span></span></span> <span class="main"><span class="free">→</span></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main"><span class="free">]</span></span><span class="main">(</span>Call <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">=</span> Call <span class="main">(</span><span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">z</span></span></span> <span class="main"><span class="free">→</span></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main"><span class="free">]</span></span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">(</span><span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">z</span></span></span> <span class="main"><span class="free">→</span></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main"><span class="free">]</span></span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> ssubst_Upd <span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">z</span></span></span> <span class="main"><span class="free">→</span></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main"><span class="free">]</span></span><span class="main">(</span>Upd <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">=</span> Upd <span class="main">(</span><span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">z</span></span></span> <span class="main"><span class="free">→</span></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main"><span class="free">]</span></span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">(</span><span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">z</span></span></span> <span class="main"><span class="free">→</span></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main"><span class="free">]</span></span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> ssubst_Obj <span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">z</span></span></span> <span class="main"><span class="free">→</span></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main"><span class="free">]</span></span><span class="main">(</span>Obj <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main">)</span> <span class="main">=</span> Obj <span class="main">(</span><span class="main">λ</span><span class="bound">l</span><span class="main">.</span> <span class="free">ssubst_option</span> <span class="free"><span class="bound"><span class="entity">z</span></span></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">l</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">T</span></span></span>"</span></span>
<span class="main">|</span> ssubst_None<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ssubst_option</span> <span class="free"><span class="bound"><span class="entity">z</span></span></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> None <span class="main">=</span> None"</span></span>
<span class="main">|</span> ssubst_Some<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ssubst_option</span> <span class="free"><span class="bound"><span class="entity">z</span></span></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span><span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">z</span></span></span> <span class="main"><span class="free">→</span></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main"><span class="free">]</span></span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Sigma-dom_ssubstoption_lem"><span class="command">lemma</span></span> dom_ssubstoption_lem<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"dom <span class="main">(</span><span class="main">λ</span><span class="bound">l</span><span class="main">.</span> ssubst_option <span class="free">z</span> <span class="free">u</span> <span class="main">(</span><span class="free">f</span> <span class="bound">l</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> dom <span class="free">f</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="improper">x</span> <span class="main">∈</span> dom <span class="free">f</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="Sigma-ssubst_option_lem"><span class="command">lemma</span></span> ssubst_option_lem<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">l</span><span class="main">∈</span>dom <span class="free">f</span><span class="main">.</span> <span class="main">[</span><span class="free">z</span> <span class="main">→</span> <span class="free">u</span><span class="main">]</span> the<span class="main">(</span><span class="free">f</span> <span class="bound">l</span><span class="main">)</span> <span class="main">=</span> the <span class="main">(</span>ssubst_option <span class="free">z</span> <span class="free">u</span> <span class="main">(</span><span class="free">f</span> <span class="bound">l</span><span class="main">)</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Sigma-pred_ssubstoption_lem"><span class="command">lemma</span></span> pred_ssubstoption_lem<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">l</span><span class="main">∈</span>dom <span class="main">(</span><span class="main">λ</span><span class="bound">l</span><span class="main">.</span> ssubst_option <span class="free">x</span> <span class="free">t</span> <span class="main">(</span><span class="free">f</span> <span class="bound">l</span><span class="main">)</span><span class="main">)</span><span class="main">.</span>
     <span class="main">(</span><span class="free">P</span><span class="main">::</span>sterm <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">(</span>the <span class="main">(</span>ssubst_option <span class="free">x</span> <span class="free">t</span> <span class="main">(</span><span class="free">f</span> <span class="bound">l</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
   <span class="main">(</span><span class="main">∀</span><span class="bound">l</span><span class="main">∈</span>dom <span class="free">f</span><span class="main">.</span> <span class="main">(</span><span class="free">P</span><span class="main">::</span>sterm <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">(</span><span class="main">[</span><span class="free">x</span> <span class="main">→</span> <span class="free">t</span><span class="main">]</span> the <span class="main">(</span><span class="free">f</span> <span class="bound">l</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">force</span><span class="main">)</span>

<span class="keyword1" id="Sigma-ssubst_fresh"><span class="command">lemma</span></span> ssubst_fresh<span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">s</span> <span class="bound">sa</span><span class="main">.</span> <span class="bound">sa</span> <span class="main">∉</span> FV <span class="free">t</span> <span class="main">⟶</span> <span class="main">[</span><span class="bound">sa</span> <span class="main">→</span> <span class="bound">s</span><span class="main">]</span> <span class="free">t</span> <span class="main">=</span> <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> 
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">s</span> <span class="bound">sa</span><span class="main">.</span> <span class="bound">sa</span> <span class="main">∉</span> FV <span class="free">t</span> <span class="main">⟶</span> <span class="main">[</span><span class="bound">sa</span> <span class="main">→</span> <span class="bound">s</span><span class="main">]</span> <span class="free">t</span> <span class="main">=</span> <span class="free">t</span><span class="main">)</span>
    <span class="main">&amp;</span><span class="main">(</span><span class="main">∀</span><span class="bound">s</span> <span class="bound">sa</span><span class="main">.</span> <span class="bound">sa</span> <span class="main">∉</span> FVoption <span class="free">u</span> <span class="main">⟶</span> ssubst_option <span class="bound">sa</span> <span class="bound">s</span> <span class="free">u</span> <span class="main">=</span> <span class="free">u</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="main">_</span> <span class="quoted"><span class="free">t</span></span> <span class="main">_</span> <span class="quoted"><span class="free">u</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> compat_sterm_sterm_option.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span> <span class="skolem">sa</span> <span class="skolem">f</span>
    <span class="keyword3"><span class="command">assume</span></span> 
      sa<span class="main">:</span>     <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">l</span><span class="main">∈</span>dom <span class="skolem">f</span><span class="main">.</span> <span class="skolem">sa</span> <span class="main">∉</span> FVoption <span class="main">(</span><span class="skolem">f</span> <span class="bound">l</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      ssubst<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="main">∀</span><span class="bound">s</span> <span class="bound">sa</span><span class="main">.</span> <span class="bound">sa</span> <span class="main">∉</span> FVoption <span class="main">(</span><span class="skolem">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">⟶</span> ssubst_option <span class="bound">sa</span> <span class="bound">s</span> <span class="main">(</span><span class="skolem">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">f</span> <span class="bound">x</span>"</span></span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">l</span> <span class="keyword1"><span class="command">from</span></span> sa <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">sa</span> <span class="main">∉</span> FVoption <span class="main">(</span><span class="skolem">f</span> <span class="skolem">l</span><span class="main">)</span>"</span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">∈</span> dom <span class="skolem">f</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> ssubst <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ssubst_option <span class="skolem">sa</span> <span class="skolem">s</span> <span class="main">(</span><span class="skolem">f</span> <span class="skolem">l</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">f</span> <span class="skolem">l</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">with</span></span> ext <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">l</span><span class="main">.</span> ssubst_option <span class="skolem">sa</span> <span class="skolem">s</span> <span class="main">(</span><span class="skolem">f</span> <span class="bound">l</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">f</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">from</span></span> conjunct1<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">assumption</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Sigma-ssubst_commute"><span class="command">lemma</span></span> ssubst_commute<span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">s</span> <span class="bound">p</span> <span class="bound">sa</span> <span class="bound">pa</span><span class="main">.</span> <span class="bound">s</span> <span class="main">≠</span> <span class="bound">p</span> <span class="main">⟶</span> <span class="bound">s</span> <span class="main">∉</span> FV <span class="bound">pa</span> <span class="main">⟶</span> <span class="bound">p</span> <span class="main">∉</span> FV <span class="bound">sa</span> 
     <span class="main">⟶</span> <span class="main">[</span><span class="bound">s</span> <span class="main">→</span> <span class="bound">sa</span><span class="main">]</span> <span class="main">[</span><span class="bound">p</span> <span class="main">→</span> <span class="bound">pa</span><span class="main">]</span> <span class="free">t</span> <span class="main">=</span> <span class="main">[</span><span class="bound">p</span> <span class="main">→</span> <span class="bound">pa</span><span class="main">]</span> <span class="main">[</span><span class="bound">s</span> <span class="main">→</span> <span class="bound">sa</span><span class="main">]</span> <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">s</span> <span class="bound">p</span> <span class="bound">sa</span> <span class="bound">pa</span><span class="main">.</span> <span class="bound">s</span> <span class="main">≠</span> <span class="bound">p</span> <span class="main">⟶</span> <span class="bound">s</span> <span class="main">∉</span> FV <span class="bound">pa</span> <span class="main">⟶</span> <span class="bound">p</span> <span class="main">∉</span> FV <span class="bound">sa</span> 
       <span class="main">⟶</span> <span class="main">[</span><span class="bound">s</span> <span class="main">→</span> <span class="bound">sa</span><span class="main">]</span> <span class="main">[</span><span class="bound">p</span> <span class="main">→</span> <span class="bound">pa</span><span class="main">]</span> <span class="free">t</span> <span class="main">=</span> <span class="main">[</span><span class="bound">p</span> <span class="main">→</span> <span class="bound">pa</span><span class="main">]</span> <span class="main">[</span><span class="bound">s</span> <span class="main">→</span> <span class="bound">sa</span><span class="main">]</span> <span class="free">t</span><span class="main">)</span>
    <span class="main">&amp;</span><span class="main">(</span><span class="main">∀</span><span class="bound">s</span> <span class="bound">p</span> <span class="bound">sa</span> <span class="bound">pa</span><span class="main">.</span> <span class="bound">s</span> <span class="main">≠</span> <span class="bound">p</span> <span class="main">⟶</span> <span class="bound">s</span> <span class="main">∉</span> FV <span class="bound">pa</span> <span class="main">⟶</span> <span class="bound">p</span> <span class="main">∉</span> FV <span class="bound">sa</span> 
       <span class="main">⟶</span> ssubst_option <span class="bound">s</span> <span class="bound">sa</span> <span class="main">(</span>ssubst_option <span class="bound">p</span> <span class="bound">pa</span> <span class="free">u</span><span class="main">)</span> 
           <span class="main">=</span> ssubst_option <span class="bound">p</span> <span class="bound">pa</span> <span class="main">(</span>ssubst_option <span class="bound">s</span> <span class="bound">sa</span> <span class="free">u</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> compat_sterm_sterm_option.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> bVariable.split<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> conjunct1<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">assumption</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Sigma-ssubst_FV"><span class="command">lemma</span></span> ssubst_FV<span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span> <span class="bound">s</span><span class="main">.</span> FV <span class="main">(</span><span class="main">[</span><span class="bound">x</span> <span class="main">→</span> <span class="bound">s</span><span class="main">]</span> <span class="free">t</span><span class="main">)</span> <span class="main">⊆</span> FV <span class="bound">s</span> <span class="main">∪</span> <span class="main">(</span>FV <span class="free">t</span> <span class="main">-</span> <span class="main">{</span><span class="bound">x</span><span class="main">}</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">x</span> <span class="bound">s</span><span class="main">.</span> FV <span class="main">(</span><span class="main">[</span><span class="bound">x</span> <span class="main">→</span> <span class="bound">s</span><span class="main">]</span> <span class="free">t</span><span class="main">)</span> <span class="main">⊆</span> FV <span class="bound">s</span> <span class="main">∪</span> <span class="main">(</span>FV <span class="free">t</span> <span class="main">-</span> <span class="main">{</span><span class="bound">x</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>
    <span class="main">&amp;</span><span class="main">(</span><span class="main">∀</span><span class="bound">x</span> <span class="bound">s</span><span class="main">.</span> FVoption <span class="main">(</span>ssubst_option <span class="bound">x</span> <span class="bound">s</span> <span class="free">u</span><span class="main">)</span> <span class="main">⊆</span> FV <span class="bound">s</span> <span class="main">∪</span> <span class="main">(</span>FVoption <span class="free">u</span> <span class="main">-</span> <span class="main">{</span><span class="bound">x</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> compat_sterm_sterm_option.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> bVariable.split<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> conjunct1<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">assumption</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Sigma-ssubstoption_insert"><span class="command">lemma</span></span> ssubstoption_insert<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">∈</span> dom <span class="free">f</span> 
  <span class="main">⟹</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">la</span><span class="main">::</span>Label<span class="main">)</span><span class="main">.</span> ssubst_option <span class="free">x</span> <span class="free">t'</span> <span class="main">(</span><span class="keyword1">if</span> <span class="bound">la</span> <span class="main">=</span> <span class="free">l</span> <span class="keyword1">then</span> Some <span class="free">t</span> <span class="keyword1">else</span> <span class="free">f</span> <span class="bound">la</span><span class="main">)</span><span class="main">)</span>
      <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">la</span><span class="main">::</span>Label<span class="main">)</span><span class="main">.</span> ssubst_option <span class="free">x</span> <span class="free">t'</span> <span class="main">(</span><span class="free">f</span> <span class="bound">la</span><span class="main">)</span><span class="main">)</span><span class="main">(</span><span class="free">l</span> <span class="main">↦</span> <span class="main">[</span><span class="free">x</span> <span class="main">→</span> <span class="free">t'</span><span class="main">]</span> <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Ltake_eq_all<span class="main"><span class="keyword3">,</span></span> <span class="operator">force</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Ltake_eq_def<span class="main">)</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Local closure›</span></span>
<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">lc</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"sterm <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  lc_Fvar<span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">lc</span> <span class="main">(</span>Fvar <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> lc_Call<span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">lc</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">;</span> <span class="free">lc</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">lc</span> <span class="main">(</span>Call <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> lc_Upd<span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span> <span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">lc</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">;</span> finite <span class="free"><span class="bound"><span class="entity">L</span></span></span><span class="main">;</span> 
     <span class="main">∀</span><span class="bound">s</span> <span class="bound">p</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∉</span> <span class="free"><span class="bound"><span class="entity">L</span></span></span> <span class="main">∧</span> <span class="bound">p</span> <span class="main">∉</span> <span class="free"><span class="bound"><span class="entity">L</span></span></span> <span class="main">∧</span> <span class="bound">s</span> <span class="main">≠</span> <span class="bound">p</span> <span class="main">⟶</span> <span class="free">lc</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="hidden">⇗</span><sup>[Fvar <span class="bound">s</span><span class="main">,</span> Fvar <span class="bound">p</span>]</sup><span class="hidden">⇖</span><span class="main">)</span> <span class="main">⟧</span>
  <span class="main">⟹</span> <span class="free">lc</span> <span class="main">(</span>Upd <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> lc_Obj<span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span> <span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> finite <span class="free"><span class="bound"><span class="entity">L</span></span></span><span class="main">;</span> <span class="main">∀</span><span class="bound">l</span><span class="main">∈</span>dom <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">.</span> 
     <span class="main">∀</span><span class="bound">s</span> <span class="bound">p</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∉</span> <span class="free"><span class="bound"><span class="entity">L</span></span></span> <span class="main">∧</span> <span class="bound">p</span> <span class="main">∉</span> <span class="free"><span class="bound"><span class="entity">L</span></span></span> <span class="main">∧</span> <span class="bound">s</span> <span class="main">≠</span> <span class="bound">p</span> <span class="main">⟶</span> <span class="free">lc</span> <span class="main">(</span>the<span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">l</span><span class="main">)</span><span class="hidden">⇗</span><sup>[Fvar <span class="bound">s</span><span class="main">,</span> Fvar <span class="bound">p</span>]</sup><span class="hidden">⇖</span><span class="main">)</span> <span class="main">⟧</span>
  <span class="main">⟹</span> <span class="free">lc</span> <span class="main">(</span>Obj <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">body</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"sterm <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
 <span class="quoted"><span class="quoted">"<span class="free">body</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">L</span><span class="main">.</span> finite <span class="bound">L</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">s</span> <span class="bound">p</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∉</span> <span class="bound">L</span> <span class="main">∧</span> <span class="bound">p</span> <span class="main">∉</span> <span class="bound">L</span> <span class="main">∧</span> <span class="bound">s</span> <span class="main">≠</span> <span class="bound">p</span> <span class="main">⟶</span> lc <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="hidden">⇗</span><sup>[Fvar <span class="bound">s</span><span class="main">,</span> Fvar <span class="bound">p</span>]</sup><span class="hidden">⇖</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Sigma-lc_bvar"><span class="command">lemma</span></span> lc_bvar<span class="main">:</span> <span class="quoted"><span class="quoted">"lc <span class="main">(</span>Bvar <span class="free">b</span><span class="main">)</span> <span class="main">=</span> False"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> iffI<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> lc.cases<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>

<span class="keyword1" id="Sigma-lc_obj"><span class="command">lemma</span></span> lc_obj<span class="main">:</span>
  <span class="quoted"><span class="quoted">"lc <span class="main">(</span>Obj <span class="free">f</span> <span class="free">T</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">l</span><span class="main">∈</span>dom <span class="free">f</span><span class="main">.</span> body <span class="main">(</span>the<span class="main">(</span><span class="free">f</span> <span class="bound">l</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">f</span> <span class="skolem">T</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"lc <span class="main">(</span>Obj <span class="skolem">f</span> <span class="skolem">T</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">l</span><span class="main">∈</span>dom <span class="skolem">f</span><span class="main">.</span> body <span class="main">(</span>the<span class="main">(</span><span class="skolem">f</span> <span class="bound">l</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> body_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> lc.cases<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"Label <span class="main">-~&gt;</span> sterm"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">T</span> <span class="main">::</span> <span class="quoted">type</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">l</span><span class="main">∈</span>dom <span class="skolem">f</span><span class="main">.</span> body <span class="main">(</span>the <span class="main">(</span><span class="skolem">f</span> <span class="bound">l</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> 
    <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">L</span><span class="main">.</span> finite <span class="bound">L</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">l</span><span class="main">∈</span>dom <span class="skolem">f</span><span class="main">.</span> <span class="main">∀</span><span class="bound">s</span> <span class="bound">p</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∉</span> <span class="bound">L</span> <span class="main">∧</span> <span class="bound">p</span> <span class="main">∉</span> <span class="bound">L</span> <span class="main">∧</span> <span class="bound">s</span> <span class="main">≠</span> <span class="bound">p</span> 
                                 <span class="main">⟶</span> lc <span class="main">(</span>the <span class="main">(</span><span class="skolem">f</span> <span class="bound">l</span><span class="main">)</span><span class="hidden">⇗</span><sup>[Fvar <span class="bound">s</span><span class="main">,</span> Fvar <span class="bound">p</span>]</sup><span class="hidden">⇖</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">f</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> fmap_induct<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> empty <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>insert <span class="skolem">F</span> <span class="skolem">x</span> <span class="skolem">y</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> dom <span class="skolem">F</span>"</span></span> <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">l</span><span class="main">∈</span>dom <span class="skolem">F</span><span class="main">.</span> the<span class="main">(</span><span class="skolem">F</span> <span class="bound">l</span><span class="main">)</span> <span class="main">=</span> the <span class="main">(</span><span class="main">(</span><span class="skolem">F</span><span class="main">(</span><span class="skolem">x</span> <span class="main">↦</span> <span class="skolem">y</span><span class="main">)</span><span class="main">)</span> <span class="bound">l</span><span class="main">)</span>"</span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span><span class="bound">l</span><span class="main">∈</span>dom <span class="main">(</span><span class="skolem">F</span><span class="main">(</span><span class="skolem">x</span> <span class="main">↦</span> <span class="skolem">y</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> body <span class="main">(</span>the<span class="main">(</span><span class="main">(</span><span class="skolem">F</span><span class="main">(</span><span class="skolem">x</span> <span class="main">↦</span> <span class="skolem">y</span><span class="main">)</span><span class="main">)</span> <span class="bound">l</span><span class="main">)</span><span class="main">)</span>›</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">l</span><span class="main">∈</span>dom <span class="skolem">F</span><span class="main">.</span> body <span class="main">(</span>the <span class="main">(</span><span class="skolem">F</span> <span class="bound">l</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
      <span class="keyword1"><span class="command">from</span></span> insert<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">L</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
        <span class="quoted"><span class="quoted">"finite <span class="skolem">L</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
        <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">l</span><span class="main">∈</span>dom <span class="skolem">F</span><span class="main">.</span> <span class="main">∀</span><span class="bound">s</span> <span class="bound">p</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∉</span> <span class="skolem">L</span> <span class="main">∧</span> <span class="bound">p</span> <span class="main">∉</span> <span class="skolem">L</span> <span class="main">∧</span> <span class="bound">s</span> <span class="main">≠</span> <span class="bound">p</span>
                     <span class="main">⟶</span> lc <span class="main">(</span>the <span class="main">(</span><span class="skolem">F</span> <span class="bound">l</span><span class="main">)</span><span class="hidden">⇗</span><sup>[Fvar <span class="bound">s</span><span class="main">,</span> Fvar <span class="bound">p</span>]</sup><span class="hidden">⇖</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span><span class="bound">l</span><span class="main">∈</span>dom <span class="main">(</span><span class="skolem">F</span><span class="main">(</span><span class="skolem">x</span> <span class="main">↦</span> <span class="skolem">y</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> body <span class="main">(</span>the<span class="main">(</span><span class="main">(</span><span class="skolem">F</span><span class="main">(</span><span class="skolem">x</span> <span class="main">↦</span> <span class="skolem">y</span><span class="main">)</span><span class="main">)</span> <span class="bound">l</span><span class="main">)</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"body <span class="skolem">y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">L'</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
        <span class="quoted"><span class="quoted">"finite <span class="skolem">L'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
        <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">s</span> <span class="bound">p</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∉</span> <span class="skolem">L'</span> <span class="main">∧</span> <span class="bound">p</span> <span class="main">∉</span> <span class="skolem">L'</span> <span class="main">∧</span> <span class="bound">s</span> <span class="main">≠</span> <span class="bound">p</span>
          <span class="main">⟶</span> lc <span class="main">(</span><span class="skolem">y</span><span class="hidden">⇗</span><sup>[Fvar <span class="bound">s</span><span class="main">,</span> Fvar <span class="bound">p</span>]</sup><span class="hidden">⇖</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> body_def<span class="main">)</span>

      <span class="keyword1"><span class="command">ultimately</span></span>
      <span class="keyword3"><span class="command">show</span></span> 
        <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">L</span><span class="main">.</span> finite <span class="bound">L</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">l</span><span class="main">∈</span>dom <span class="main">(</span><span class="skolem">F</span><span class="main">(</span><span class="skolem">x</span> <span class="main">↦</span> <span class="skolem">y</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> <span class="main">∀</span><span class="bound">s</span> <span class="bound">p</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∉</span> <span class="bound">L</span> <span class="main">∧</span> <span class="bound">p</span> <span class="main">∉</span> <span class="bound">L</span> <span class="main">∧</span> <span class="bound">s</span> <span class="main">≠</span> <span class="bound">p</span> 
                                               <span class="main">⟶</span> lc <span class="main">(</span>the <span class="main">(</span><span class="main">(</span><span class="skolem">F</span><span class="main">(</span><span class="skolem">x</span> <span class="main">↦</span> <span class="skolem">y</span><span class="main">)</span><span class="main">)</span> <span class="bound">l</span><span class="main">)</span><span class="hidden">⇗</span><sup>[Fvar <span class="bound">s</span><span class="main">,</span>Fvar <span class="bound">p</span>]</sup><span class="hidden">⇖</span><span class="main">)</span><span class="main">)</span>"</span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">L</span> <span class="main">∪</span> <span class="skolem">L'</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"lc <span class="main">(</span>Obj <span class="skolem">f</span> <span class="skolem">T</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Sigma-lc_upd"><span class="command">lemma</span></span> lc_upd<span class="main">:</span> <span class="quoted"><span class="quoted">"lc <span class="main">(</span>Upd <span class="free">t</span> <span class="free">l</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>lc <span class="free">t</span> <span class="main">∧</span> body <span class="free">s</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold</span> body_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> iffI<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> lc.cases<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="Sigma-lc_call"><span class="command">lemma</span></span> lc_call<span class="main">:</span> <span class="quoted"><span class="quoted">"lc <span class="main">(</span>Call <span class="free">t</span> <span class="free">l</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>lc <span class="free">t</span> <span class="main">∧</span> lc <span class="free">s</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> iffI<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> lc.cases<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>

<span class="keyword1" id="Sigma-lc_induct"><span class="command">lemma</span></span> lc_induct<span class="main">[</span><span class="operator">consumes</span> 1<span class="main">,</span> <span class="operator">case_names</span> Fvar Call Upd Obj Bnd<span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">P1</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"sterm <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">P2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"sterm <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
  <span class="quoted"><span class="quoted">"lc <span class="free">t</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="free">P1</span> <span class="main">(</span>Fvar <span class="bound">x</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">t</span> <span class="bound">l</span> <span class="bound">a</span><span class="main">.</span> <span class="main">⟦</span> lc <span class="bound">t</span><span class="main">;</span> <span class="free">P1</span> <span class="bound">t</span><span class="main">;</span> lc <span class="bound">a</span><span class="main">;</span> <span class="free">P1</span> <span class="bound">a</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P1</span> <span class="main">(</span>Call <span class="bound">t</span> <span class="bound">l</span> <span class="bound">a</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">t</span> <span class="bound">l</span> <span class="bound">u</span><span class="main">.</span> <span class="main">⟦</span> lc <span class="bound">t</span><span class="main">;</span> <span class="free">P1</span> <span class="bound">t</span><span class="main">;</span> <span class="free">P2</span> <span class="bound">u</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P1</span> <span class="main">(</span>Upd <span class="bound">t</span> <span class="bound">l</span> <span class="bound">u</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">f</span> <span class="bound">T</span><span class="main">.</span> <span class="main">∀</span><span class="bound">l</span><span class="main">∈</span>dom <span class="bound">f</span><span class="main">.</span> <span class="free">P2</span> <span class="main">(</span>the<span class="main">(</span><span class="bound">f</span> <span class="bound">l</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">P1</span> <span class="main">(</span>Obj <span class="bound">f</span> <span class="bound">T</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">L</span> <span class="bound">t</span><span class="main">.</span> <span class="main">⟦</span> finite <span class="bound">L</span><span class="main">;</span> 
            <span class="main">∀</span><span class="bound">s</span> <span class="bound">p</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∉</span> <span class="bound">L</span> <span class="main">∧</span> <span class="bound">p</span> <span class="main">∉</span> <span class="bound">L</span> <span class="main">∧</span> <span class="bound">s</span> <span class="main">≠</span> <span class="bound">p</span> 
             <span class="main">⟶</span> lc <span class="main">(</span><span class="bound">t</span><span class="hidden">⇗</span><sup>[Fvar <span class="bound">s</span><span class="main">,</span> Fvar <span class="bound">p</span>]</sup><span class="hidden">⇖</span><span class="main">)</span> <span class="main">∧</span> <span class="free">P1</span> <span class="main">(</span><span class="bound">t</span><span class="hidden">⇗</span><sup>[Fvar <span class="bound">s</span><span class="main">,</span> Fvar <span class="bound">p</span>]</sup><span class="hidden">⇖</span><span class="main">)</span> <span class="main">⟧</span>
  <span class="main">⟹</span> <span class="free">P2</span> <span class="bound">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P1</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> lc.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Connections between sopen, sclose, ssubst, lc and body and resulting properties›</span></span>
<span class="keyword1" id="Sigma-ssubst_intro"><span class="command">lemma</span></span> ssubst_intro<span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">n</span> <span class="bound">s</span> <span class="bound">p</span> <span class="bound">sa</span> <span class="bound">pa</span><span class="main">.</span> <span class="bound">sa</span> <span class="main">∉</span> FV <span class="free">t</span> <span class="main">⟶</span> <span class="bound">pa</span> <span class="main">∉</span> FV <span class="free">t</span> <span class="main">⟶</span> <span class="bound">sa</span> <span class="main">≠</span> <span class="bound">pa</span>
     <span class="main">⟶</span> <span class="bound">sa</span> <span class="main">∉</span> FV <span class="bound">p</span>
     <span class="main">⟶</span> <span class="main">{</span><span class="bound">n</span> <span class="main">→</span> <span class="main">[</span><span class="bound">s</span><span class="main">,</span><span class="bound">p</span><span class="main">]}</span> <span class="free">t</span> <span class="main">=</span> <span class="main">[</span><span class="bound">sa</span> <span class="main">→</span> <span class="bound">s</span><span class="main">]</span> <span class="main">[</span><span class="bound">pa</span> <span class="main">→</span> <span class="bound">p</span><span class="main">]</span> <span class="main">{</span><span class="bound">n</span> <span class="main">→</span> <span class="main">[</span>Fvar <span class="bound">sa</span><span class="main">,</span> Fvar <span class="bound">pa</span><span class="main">]}</span> <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> 
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">n</span> <span class="bound">s</span> <span class="bound">p</span> <span class="bound">sa</span> <span class="bound">pa</span><span class="main">.</span> <span class="bound">sa</span> <span class="main">∉</span> FV <span class="free">t</span> <span class="main">⟶</span> <span class="bound">pa</span> <span class="main">∉</span> FV <span class="free">t</span> <span class="main">⟶</span> <span class="bound">sa</span> <span class="main">≠</span> <span class="bound">pa</span>
       <span class="main">⟶</span> <span class="bound">sa</span> <span class="main">∉</span> FV <span class="bound">p</span>
       <span class="main">⟶</span> <span class="main">{</span><span class="bound">n</span> <span class="main">→</span> <span class="main">[</span><span class="bound">s</span><span class="main">,</span><span class="bound">p</span><span class="main">]}</span> <span class="free">t</span> <span class="main">=</span> <span class="main">[</span><span class="bound">sa</span> <span class="main">→</span> <span class="bound">s</span><span class="main">]</span> <span class="main">[</span><span class="bound">pa</span> <span class="main">→</span> <span class="bound">p</span><span class="main">]</span> <span class="main">{</span><span class="bound">n</span> <span class="main">→</span> <span class="main">[</span>Fvar <span class="bound">sa</span><span class="main">,</span> Fvar <span class="bound">pa</span><span class="main">]}</span> <span class="free">t</span><span class="main">)</span>
    <span class="main">&amp;</span><span class="main">(</span><span class="main">∀</span><span class="bound">n</span> <span class="bound">s</span> <span class="bound">p</span> <span class="bound">sa</span> <span class="bound">pa</span><span class="main">.</span> <span class="bound">sa</span> <span class="main">∉</span> FVoption <span class="free">u</span> <span class="main">⟶</span> <span class="bound">pa</span> <span class="main">∉</span> FVoption <span class="free">u</span> <span class="main">⟶</span> <span class="bound">sa</span> <span class="main">≠</span> <span class="bound">pa</span>
       <span class="main">⟶</span> <span class="bound">sa</span> <span class="main">∉</span> FV <span class="bound">p</span>
       <span class="main">⟶</span> sopen_option <span class="bound">n</span> <span class="bound">s</span> <span class="bound">p</span> <span class="free">u</span> 
           <span class="main">=</span> ssubst_option <span class="bound">sa</span> <span class="bound">s</span> <span class="main">(</span>ssubst_option <span class="bound">pa</span> <span class="bound">p</span> 
              <span class="main">(</span>sopen_option <span class="bound">n</span> <span class="main">(</span>Fvar <span class="bound">sa</span><span class="main">)</span> <span class="main">(</span>Fvar <span class="bound">pa</span><span class="main">)</span> <span class="free">u</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="main">_</span> <span class="quoted"><span class="free">t</span></span> <span class="main">_</span> <span class="quoted"><span class="free">u</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> compat_sterm_sterm_option.induct<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> Bvar <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> bVariable.split<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> Fvar <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> Upd <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> Call <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> None_sterm <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Obj <span class="skolem">f</span> <span class="skolem">T</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">clarify</span><span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">n</span> <span class="skolem">s</span> <span class="skolem">p</span> <span class="skolem">sa</span> <span class="skolem">pa</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">sa</span> <span class="main">∉</span> FV <span class="main">(</span>Obj <span class="skolem">f</span> <span class="skolem">T</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">pa</span> <span class="main">∉</span> FV <span class="main">(</span>Obj <span class="skolem">f</span> <span class="skolem">T</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">{</span></span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">l</span> 
        <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">sa</span> <span class="main">∉</span> FV <span class="main">(</span>Obj <span class="skolem">f</span> <span class="skolem">T</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">sa</span> <span class="main">∉</span> FVoption <span class="main">(</span><span class="skolem">f</span> <span class="skolem">l</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">∈</span> dom <span class="skolem">f</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">{</span></span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">l</span>
        <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">pa</span> <span class="main">∉</span> FV <span class="main">(</span>Obj <span class="skolem">f</span> <span class="skolem">T</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> pa<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">pa</span> <span class="main">∉</span> FVoption <span class="main">(</span><span class="skolem">f</span> <span class="skolem">l</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">∈</span> dom <span class="skolem">f</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">sa</span> <span class="main">≠</span> <span class="skolem">pa</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">sa</span> <span class="main">∉</span> FV <span class="skolem">p</span>"</span></span>
      <span class="keyword1"><span class="command">ultimately</span></span>
      <span class="keyword1"><span class="command">have</span></span> 
        <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">l</span><span class="main">.</span> sopen_option <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="skolem">s</span> <span class="skolem">p</span> <span class="main">(</span><span class="skolem">f</span> <span class="bound">l</span><span class="main">)</span> 
              <span class="main">=</span> ssubst_option <span class="skolem">sa</span> <span class="skolem">s</span> <span class="main">(</span>ssubst_option <span class="skolem">pa</span> <span class="skolem">p</span>
                 <span class="main">(</span>sopen_option <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="main">(</span>Fvar <span class="skolem">sa</span><span class="main">)</span> <span class="main">(</span>Fvar <span class="skolem">pa</span><span class="main">)</span> <span class="main">(</span><span class="skolem">f</span> <span class="bound">l</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> Obj <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">with</span></span> ext 
      <span class="keyword3"><span class="command">show</span></span> 
        <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="skolem">n</span> <span class="main">→</span> <span class="main">[</span><span class="skolem">s</span><span class="main">,</span><span class="skolem">p</span><span class="main">]}</span> Obj <span class="skolem">f</span> <span class="skolem">T</span> 
         <span class="main">=</span> <span class="main">[</span><span class="skolem">sa</span> <span class="main">→</span> <span class="skolem">s</span><span class="main">]</span> <span class="main">[</span><span class="skolem">pa</span> <span class="main">→</span> <span class="skolem">p</span><span class="main">]</span> <span class="main">{</span><span class="skolem">n</span> <span class="main">→</span> <span class="main">[</span>Fvar <span class="skolem">sa</span><span class="main">,</span>Fvar <span class="skolem">pa</span><span class="main">]}</span> Obj <span class="skolem">f</span> <span class="skolem">T</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Some_sterm <span class="skolem">t</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">clarify</span><span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">n</span> <span class="skolem">s</span> <span class="skolem">p</span> <span class="skolem">sa</span> <span class="skolem">pa</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">sa</span> <span class="main">∉</span> FVoption <span class="main">(</span>Some <span class="skolem">t</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">sa</span> <span class="main">∉</span> FV <span class="skolem">t</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">pa</span> <span class="main">∉</span> FVoption <span class="main">(</span>Some <span class="skolem">t</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">pa</span> <span class="main">∉</span> FV <span class="skolem">t</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">sa</span> <span class="main">≠</span> <span class="skolem">pa</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">sa</span> <span class="main">∉</span> FV <span class="skolem">p</span>"</span></span>
      <span class="keyword1"><span class="command">ultimately</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="skolem">n</span> <span class="main">→</span> <span class="main">[</span><span class="skolem">s</span><span class="main">,</span><span class="skolem">p</span><span class="main">]}</span> <span class="skolem">t</span> <span class="main">=</span> <span class="main">[</span><span class="skolem">sa</span> <span class="main">→</span> <span class="skolem">s</span><span class="main">]</span> <span class="main">[</span><span class="skolem">pa</span> <span class="main">→</span> <span class="skolem">p</span><span class="main">]</span> <span class="main">{</span><span class="skolem">n</span> <span class="main">→</span> <span class="main">[</span>Fvar <span class="skolem">sa</span><span class="main">,</span>Fvar <span class="skolem">pa</span><span class="main">]}</span> <span class="skolem">t</span>"</span></span> 
        <span class="keyword1"><span class="command">using</span></span> Some_sterm <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword3"><span class="command">thus</span></span> 
        <span class="quoted"><span class="quoted">"sopen_option <span class="skolem">n</span> <span class="skolem">s</span> <span class="skolem">p</span> <span class="main">(</span>Some <span class="skolem">t</span><span class="main">)</span> 
         <span class="main">=</span> ssubst_option <span class="skolem">sa</span> <span class="skolem">s</span> <span class="main">(</span>ssubst_option <span class="skolem">pa</span> <span class="skolem">p</span> 
            <span class="main">(</span>sopen_option <span class="skolem">n</span> <span class="main">(</span>Fvar <span class="skolem">sa</span><span class="main">)</span> <span class="main">(</span>Fvar <span class="skolem">pa</span><span class="main">)</span> <span class="main">(</span>Some <span class="skolem">t</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">from</span></span> conjunct1<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">assumption</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Sigma-sopen_lc_FV"><span class="command">lemma</span></span> sopen_lc_FV<span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">t</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"lc <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">n</span> <span class="bound">s</span> <span class="bound">p</span><span class="main">.</span> <span class="main">{</span><span class="bound">n</span> <span class="main">→</span> <span class="main">[</span>Fvar <span class="bound">s</span><span class="main">,</span> Fvar <span class="bound">p</span><span class="main">]}</span> <span class="free">t</span> <span class="main">=</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> 
  <span class="main">(</span><span class="operator">induct</span>
    <span class="quasi_keyword">taking</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="main">∀</span><span class="bound">n</span> <span class="bound">s</span> <span class="bound">p</span><span class="main">.</span> <span class="main">{</span>Suc <span class="bound">n</span> <span class="main">→</span> <span class="main">[</span>Fvar <span class="bound">s</span><span class="main">,</span> Fvar <span class="bound">p</span><span class="main">]}</span> <span class="bound">t</span> <span class="main">=</span> <span class="bound">t</span>"</span></span>
    <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> lc_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Fvar <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> Call <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> Upd <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Obj <span class="skolem">f</span> <span class="skolem">T</span><span class="main">)</span> <span class="keyword1"><span class="command">note</span></span> pred <span class="main">=</span> this 
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> strip<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">n</span> <span class="skolem">s</span> <span class="skolem">p</span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">l</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sopen_option <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="main">(</span>Fvar <span class="skolem">s</span><span class="main">)</span> <span class="main">(</span>Fvar <span class="skolem">p</span><span class="main">)</span> <span class="main">(</span><span class="skolem">f</span> <span class="skolem">l</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">f</span> <span class="skolem">l</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">∈</span> dom <span class="skolem">f</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> False <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="skolem">l</span> <span class="main">=</span> None"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> True <span class="keyword1"><span class="command">with</span></span> pred <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">with</span></span> ext 
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">l</span><span class="main">.</span> sopen_option <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="main">(</span>Fvar <span class="skolem">s</span><span class="main">)</span> <span class="main">(</span>Fvar <span class="skolem">p</span><span class="main">)</span> <span class="main">(</span><span class="skolem">f</span> <span class="bound">l</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">f</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Bnd <span class="skolem">L</span> <span class="skolem">t</span><span class="main">)</span> <span class="keyword1"><span class="command">note</span></span> cof <span class="main">=</span> this<span class="main">(</span>2<span class="main">)</span>  
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> strip<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">n</span> <span class="skolem">s</span> <span class="skolem">p</span>
    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹finite <span class="skolem">L</span>›</span></span> exFresh_s_p_cof<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">L</span> <span class="main">∪</span> FV <span class="skolem">t</span> <span class="main">∪</span> <span class="main">{</span><span class="skolem">s</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="skolem">p</span><span class="main">}</span>"</span></span><span class="main">]</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">sa</span></span> <span class="skolem"><span class="skolem">pa</span></span> <span class="keyword2"><span class="keyword">where</span></span>
      sapa<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">sa</span> <span class="main">∉</span> <span class="skolem">L</span> <span class="main">∪</span> FV <span class="skolem">t</span> <span class="main">∪</span> <span class="main">{</span><span class="skolem">s</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="skolem">p</span><span class="main">}</span> <span class="main">∧</span> <span class="skolem">pa</span> <span class="main">∉</span> <span class="skolem">L</span> <span class="main">∪</span> FV <span class="skolem">t</span> <span class="main">∪</span> <span class="main">{</span><span class="skolem">s</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="skolem">p</span><span class="main">}</span> <span class="main">∧</span> <span class="skolem">sa</span> <span class="main">≠</span> <span class="skolem">pa</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> cof
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span>Suc <span class="skolem">n</span> <span class="main">→</span> <span class="main">[</span>Fvar <span class="skolem">s</span><span class="main">,</span>Fvar <span class="skolem">p</span><span class="main">]}</span> <span class="main">(</span><span class="skolem">t</span><span class="hidden">⇗</span><sup>[Fvar <span class="skolem">sa</span><span class="main">,</span> Fvar <span class="skolem">pa</span>]</sup><span class="hidden">⇖</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">t</span><span class="hidden">⇗</span><sup>[Fvar <span class="skolem">sa</span><span class="main">,</span> Fvar <span class="skolem">pa</span>]</sup><span class="hidden">⇖</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> sopen_commute<span class="main">[</span><span class="operator">OF</span> Suc_not_Zero<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem">n</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> 
      eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">0</span> <span class="main">→</span> <span class="main">[</span>Fvar <span class="skolem">sa</span><span class="main">,</span>Fvar <span class="skolem">pa</span><span class="main">]}</span> <span class="main">{</span>Suc <span class="skolem">n</span> <span class="main">→</span> <span class="main">[</span>Fvar <span class="skolem">s</span><span class="main">,</span>Fvar <span class="skolem">p</span><span class="main">]}</span> <span class="skolem">t</span>
           <span class="main">=</span> <span class="main">{</span><span class="main">0</span> <span class="main">→</span> <span class="main">[</span>Fvar <span class="skolem">sa</span><span class="main">,</span>Fvar <span class="skolem">pa</span><span class="main">]}</span> <span class="skolem">t</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> openz_def<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> sapa contra_subsetD<span class="main">[</span><span class="operator">OF</span> sopen_FV<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"Fvar <span class="skolem">s</span>"</span></span> <span class="quoted"><span class="quoted">"Fvar <span class="skolem">p</span>"</span></span> <span class="quoted"><span class="skolem">t</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> 
      <span class="quoted"><span class="quoted">"<span class="skolem">sa</span> <span class="main">∉</span> FV <span class="main">(</span><span class="main">{</span>Suc <span class="skolem">n</span> <span class="main">→</span> <span class="main">[</span>Fvar <span class="skolem">s</span><span class="main">,</span>Fvar <span class="skolem">p</span><span class="main">]}</span> <span class="skolem">t</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">sa</span> <span class="main">∉</span> FV <span class="skolem">t</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      <span class="quoted"><span class="quoted">"<span class="skolem">pa</span> <span class="main">∉</span> FV <span class="main">(</span><span class="main">{</span>Suc <span class="skolem">n</span> <span class="main">→</span> <span class="main">[</span>Fvar <span class="skolem">s</span><span class="main">,</span>Fvar <span class="skolem">p</span><span class="main">]}</span> <span class="skolem">t</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">pa</span> <span class="main">∉</span> FV <span class="skolem">t</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 
      <span class="quoted"><span class="quoted">"<span class="skolem">sa</span> <span class="main">≠</span> <span class="skolem">pa</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> sopen_fresh_inj<span class="main">[</span><span class="operator">OF</span> eq this<span class="main">]</span> 
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span>Suc <span class="skolem">n</span> <span class="main">→</span> <span class="main">[</span>Fvar <span class="skolem">s</span><span class="main">,</span>Fvar <span class="skolem">p</span><span class="main">]}</span> <span class="skolem">t</span> <span class="main">=</span> <span class="skolem">t</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">assumption</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>    

<span class="keyword1" id="Sigma-sopen_lc"><span class="command">lemma</span></span> sopen_lc<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">t</span> <span class="free">n</span> <span class="free">s</span> <span class="free">p</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"lc <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">n</span> <span class="main">→</span> <span class="main">[</span><span class="free">s</span><span class="main">,</span><span class="free">p</span><span class="main">]}</span> <span class="free">t</span> <span class="main">=</span> <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> exFresh_s_p_cof<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"FV <span class="free">t</span> <span class="main">∪</span> FV <span class="free">p</span>"</span></span><span class="main">]</span> 
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">sa</span></span> <span class="skolem"><span class="skolem">pa</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
    <span class="quoted"><span class="quoted">"<span class="skolem">sa</span> <span class="main">∉</span> FV <span class="free">t</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">pa</span> <span class="main">∉</span> FV <span class="free">t</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">sa</span> <span class="main">≠</span> <span class="skolem">pa</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 
    <span class="quoted"><span class="quoted">"<span class="skolem">sa</span> <span class="main">∉</span> FV <span class="free">p</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">pa</span> <span class="main">∉</span> FV <span class="free">p</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> ssubst_intro<span class="main">[</span><span class="operator">OF</span> this<span class="main"><span class="main">(</span></span>1-4<span class="main"><span class="main">)</span></span><span class="main">]</span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">n</span> <span class="main">→</span> <span class="main">[</span><span class="free">s</span><span class="main">,</span><span class="free">p</span><span class="main">]}</span> <span class="free">t</span> <span class="main">=</span> <span class="main">[</span><span class="skolem">sa</span> <span class="main">→</span> <span class="free">s</span><span class="main">]</span> <span class="main">[</span><span class="skolem">pa</span> <span class="main">→</span> <span class="free">p</span><span class="main">]</span> <span class="main">{</span><span class="free">n</span> <span class="main">→</span> <span class="main">[</span>Fvar <span class="skolem">sa</span><span class="main">,</span>Fvar <span class="skolem">pa</span><span class="main">]}</span> <span class="free">t</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">n</span> <span class="main">→</span> <span class="main">[</span><span class="free">s</span><span class="main">,</span><span class="free">p</span><span class="main">]}</span> <span class="free">t</span> <span class="main">=</span> <span class="main">[</span><span class="skolem">sa</span> <span class="main">→</span> <span class="free">s</span><span class="main">]</span> <span class="main">[</span><span class="skolem">pa</span> <span class="main">→</span> <span class="free">p</span><span class="main">]</span> <span class="free">t</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> sopen_lc_FV 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">with</span></span> ssubst_fresh<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">pa</span> <span class="main">∉</span> FV <span class="free">t</span>›</span></span><span class="main">]</span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">n</span> <span class="main">→</span> <span class="main">[</span><span class="free">s</span><span class="main">,</span><span class="free">p</span><span class="main">]}</span> <span class="free">t</span> <span class="main">=</span> <span class="main">[</span><span class="skolem">sa</span> <span class="main">→</span> <span class="free">s</span><span class="main">]</span> <span class="free">t</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">with</span></span> ssubst_fresh<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">sa</span> <span class="main">∉</span> FV <span class="free">t</span>›</span></span><span class="main">]</span> 
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">n</span> <span class="main">→</span> <span class="main">[</span><span class="free">s</span><span class="main">,</span><span class="free">p</span><span class="main">]}</span> <span class="free">t</span> <span class="main">=</span> <span class="free">t</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Sigma-sopen_twice"><span class="command">lemma</span></span> sopen_twice<span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">s</span> <span class="bound">p</span> <span class="bound">s'</span> <span class="bound">p'</span> <span class="bound">n</span><span class="main">.</span> lc <span class="bound">s</span> <span class="main">⟶</span> lc <span class="bound">p</span> 
     <span class="main">⟶</span> <span class="main">{</span><span class="bound">n</span> <span class="main">→</span> <span class="main">[</span><span class="bound">s'</span><span class="main">,</span><span class="bound">p'</span><span class="main">]}</span> <span class="main">{</span><span class="bound">n</span> <span class="main">→</span> <span class="main">[</span><span class="bound">s</span><span class="main">,</span><span class="bound">p</span><span class="main">]}</span> <span class="free">t</span> <span class="main">=</span> <span class="main">{</span><span class="bound">n</span> <span class="main">→</span> <span class="main">[</span><span class="bound">s</span><span class="main">,</span><span class="bound">p</span><span class="main">]}</span> <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">s</span> <span class="bound">p</span> <span class="bound">s'</span> <span class="bound">p'</span> <span class="bound">n</span><span class="main">.</span> lc <span class="bound">s</span> <span class="main">⟶</span> lc <span class="bound">p</span> 
      <span class="main">⟶</span> <span class="main">{</span><span class="bound">n</span> <span class="main">→</span> <span class="main">[</span><span class="bound">s'</span><span class="main">,</span><span class="bound">p'</span><span class="main">]}</span> <span class="main">{</span><span class="bound">n</span> <span class="main">→</span> <span class="main">[</span><span class="bound">s</span><span class="main">,</span><span class="bound">p</span><span class="main">]}</span> <span class="free">t</span> <span class="main">=</span> <span class="main">{</span><span class="bound">n</span> <span class="main">→</span> <span class="main">[</span><span class="bound">s</span><span class="main">,</span><span class="bound">p</span><span class="main">]}</span> <span class="free">t</span><span class="main">)</span>
    <span class="main">&amp;</span><span class="main">(</span><span class="main">∀</span><span class="bound">s</span> <span class="bound">p</span> <span class="bound">s'</span> <span class="bound">p'</span> <span class="bound">n</span><span class="main">.</span> lc <span class="bound">s</span> <span class="main">⟶</span> lc <span class="bound">p</span> 
      <span class="main">⟶</span> sopen_option <span class="bound">n</span> <span class="bound">s'</span> <span class="bound">p'</span> <span class="main">(</span>sopen_option <span class="bound">n</span> <span class="bound">s</span> <span class="bound">p</span> <span class="free">u</span><span class="main">)</span> <span class="main">=</span> sopen_option <span class="bound">n</span> <span class="bound">s</span> <span class="bound">p</span> <span class="free">u</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> compat_sterm_sterm_option.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> bVariable.split<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> conjunct1<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">assumption</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Sigma-sopen_sclose_commute"><span class="command">lemma</span></span> sopen_sclose_commute<span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">n</span> <span class="bound">k</span> <span class="bound">s</span> <span class="bound">p</span> <span class="bound">sa</span> <span class="bound">pa</span><span class="main">.</span> <span class="bound">n</span> <span class="main">≠</span> <span class="bound">k</span> <span class="main">⟶</span> <span class="bound">sa</span> <span class="main">∉</span> FV <span class="bound">s</span> <span class="main">⟶</span> <span class="bound">sa</span> <span class="main">∉</span> FV <span class="bound">p</span> 
     <span class="main">⟶</span> <span class="bound">pa</span> <span class="main">∉</span> FV <span class="bound">s</span> <span class="main">⟶</span> <span class="bound">pa</span> <span class="main">∉</span> FV <span class="bound">p</span>
     <span class="main">⟶</span> <span class="main">{</span><span class="bound">n</span> <span class="main">→</span> <span class="main">[</span><span class="bound">s</span><span class="main">,</span> <span class="bound">p</span><span class="main">]}</span> <span class="main">{</span><span class="bound">k</span> <span class="main">←</span> <span class="main">[</span><span class="bound">sa</span><span class="main">,</span><span class="bound">pa</span><span class="main">]}</span> <span class="free">t</span> <span class="main">=</span> <span class="main">{</span><span class="bound">k</span> <span class="main">←</span> <span class="main">[</span><span class="bound">sa</span><span class="main">,</span><span class="bound">pa</span><span class="main">]}</span> <span class="main">{</span><span class="bound">n</span> <span class="main">→</span> <span class="main">[</span><span class="bound">s</span><span class="main">,</span> <span class="bound">p</span><span class="main">]}</span> <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> 
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">n</span> <span class="bound">k</span> <span class="bound">s</span> <span class="bound">p</span> <span class="bound">sa</span> <span class="bound">pa</span><span class="main">.</span> <span class="bound">n</span> <span class="main">≠</span> <span class="bound">k</span> <span class="main">⟶</span> <span class="bound">sa</span> <span class="main">∉</span> FV <span class="bound">s</span> <span class="main">⟶</span> <span class="bound">sa</span> <span class="main">∉</span> FV <span class="bound">p</span> 
       <span class="main">⟶</span> <span class="bound">pa</span> <span class="main">∉</span> FV <span class="bound">s</span> <span class="main">⟶</span> <span class="bound">pa</span> <span class="main">∉</span> FV <span class="bound">p</span>
       <span class="main">⟶</span> <span class="main">{</span><span class="bound">n</span> <span class="main">→</span> <span class="main">[</span><span class="bound">s</span><span class="main">,</span> <span class="bound">p</span><span class="main">]}</span> <span class="main">{</span><span class="bound">k</span> <span class="main">←</span> <span class="main">[</span><span class="bound">sa</span><span class="main">,</span><span class="bound">pa</span><span class="main">]}</span> <span class="free">t</span> <span class="main">=</span> <span class="main">{</span><span class="bound">k</span> <span class="main">←</span> <span class="main">[</span><span class="bound">sa</span><span class="main">,</span><span class="bound">pa</span><span class="main">]}</span> <span class="main">{</span><span class="bound">n</span> <span class="main">→</span> <span class="main">[</span><span class="bound">s</span><span class="main">,</span> <span class="bound">p</span><span class="main">]}</span> <span class="free">t</span><span class="main">)</span>
    <span class="main">&amp;</span><span class="main">(</span><span class="main">∀</span><span class="bound">n</span> <span class="bound">k</span> <span class="bound">s</span> <span class="bound">p</span> <span class="bound">sa</span> <span class="bound">pa</span><span class="main">.</span> <span class="bound">n</span> <span class="main">≠</span> <span class="bound">k</span> <span class="main">⟶</span> <span class="bound">sa</span> <span class="main">∉</span> FV <span class="bound">s</span> <span class="main">⟶</span> <span class="bound">sa</span> <span class="main">∉</span> FV <span class="bound">p</span> 
       <span class="main">⟶</span> <span class="bound">pa</span> <span class="main">∉</span> FV <span class="bound">s</span> <span class="main">⟶</span> <span class="bound">pa</span> <span class="main">∉</span> FV <span class="bound">p</span>
       <span class="main">⟶</span> sopen_option <span class="bound">n</span> <span class="bound">s</span> <span class="bound">p</span> <span class="main">(</span>sclose_option <span class="bound">k</span> <span class="bound">sa</span> <span class="bound">pa</span> <span class="free">u</span><span class="main">)</span> 
           <span class="main">=</span> sclose_option <span class="bound">k</span> <span class="bound">sa</span> <span class="bound">pa</span> <span class="main">(</span>sopen_option <span class="bound">n</span> <span class="bound">s</span> <span class="bound">p</span> <span class="free">u</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> compat_sterm_sterm_option.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> bVariable.split<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> conjunct1<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">assumption</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Sigma-sclose_sopen_eq_t"><span class="command">lemma</span></span> sclose_sopen_eq_t<span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">n</span> <span class="bound">s</span> <span class="bound">p</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∉</span> FV <span class="free">t</span> <span class="main">⟶</span> <span class="bound">p</span> <span class="main">∉</span> FV <span class="free">t</span> <span class="main">⟶</span> <span class="bound">s</span> <span class="main">≠</span> <span class="bound">p</span>
     <span class="main">⟶</span> <span class="main">{</span><span class="bound">n</span> <span class="main">←</span> <span class="main">[</span><span class="bound">s</span><span class="main">,</span><span class="bound">p</span><span class="main">]}</span> <span class="main">{</span><span class="bound">n</span> <span class="main">→</span> <span class="main">[</span>Fvar <span class="bound">s</span><span class="main">,</span> Fvar <span class="bound">p</span><span class="main">]}</span> <span class="free">t</span> <span class="main">=</span> <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> 
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">n</span> <span class="bound">s</span> <span class="bound">p</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∉</span> FV <span class="free">t</span> <span class="main">⟶</span> <span class="bound">p</span> <span class="main">∉</span> FV <span class="free">t</span> <span class="main">⟶</span> <span class="bound">s</span> <span class="main">≠</span> <span class="bound">p</span>
       <span class="main">⟶</span> <span class="main">{</span><span class="bound">n</span> <span class="main">←</span> <span class="main">[</span><span class="bound">s</span><span class="main">,</span><span class="bound">p</span><span class="main">]}</span> <span class="main">{</span><span class="bound">n</span> <span class="main">→</span> <span class="main">[</span>Fvar <span class="bound">s</span><span class="main">,</span> Fvar <span class="bound">p</span><span class="main">]}</span> <span class="free">t</span> <span class="main">=</span> <span class="free">t</span><span class="main">)</span>
    <span class="main">&amp;</span><span class="main">(</span><span class="main">∀</span><span class="bound">n</span> <span class="bound">s</span> <span class="bound">p</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∉</span> FVoption <span class="free">u</span> <span class="main">⟶</span> <span class="bound">p</span> <span class="main">∉</span> FVoption <span class="free">u</span> <span class="main">⟶</span> <span class="bound">s</span> <span class="main">≠</span> <span class="bound">p</span>
       <span class="main">⟶</span> sclose_option <span class="bound">n</span> <span class="bound">s</span> <span class="bound">p</span> <span class="main">(</span>sopen_option <span class="bound">n</span> <span class="main">(</span>Fvar <span class="bound">s</span><span class="main">)</span> <span class="main">(</span>Fvar <span class="bound">p</span><span class="main">)</span> <span class="free">u</span><span class="main">)</span> <span class="main">=</span> <span class="free">u</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="main">_</span> <span class="quoted"><span class="free">t</span></span> <span class="main">_</span> <span class="quoted"><span class="free">u</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> compat_sterm_sterm_option.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> bVariable.split<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="comment1">(* Obj *)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">f</span> <span class="skolem">n</span> <span class="skolem">s</span> <span class="skolem">p</span>
    <span class="keyword3"><span class="command">assume</span></span> 
      nin_s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">l</span><span class="main">∈</span>dom <span class="skolem">f</span><span class="main">.</span> <span class="skolem">s</span> <span class="main">∉</span> FVoption <span class="main">(</span><span class="skolem">f</span> <span class="bound">l</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      nin_p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">l</span><span class="main">∈</span>dom <span class="skolem">f</span><span class="main">.</span> <span class="skolem">p</span> <span class="main">∉</span> FVoption <span class="main">(</span><span class="skolem">f</span> <span class="bound">l</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">l</span> <span class="keyword1"><span class="command">from</span></span> nin_s <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∉</span> FVoption <span class="main">(</span><span class="skolem">f</span> <span class="skolem">l</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">∈</span> dom <span class="skolem">f</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">l</span> <span class="keyword1"><span class="command">from</span></span> nin_p <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∉</span> FVoption <span class="main">(</span><span class="skolem">f</span> <span class="skolem">l</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">∈</span> dom <span class="skolem">f</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> 
    <span class="keyword3"><span class="command">assume</span></span> 
      <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">≠</span> <span class="skolem">p</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="main">∀</span><span class="bound">n</span> <span class="bound">s</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∉</span> FVoption <span class="main">(</span><span class="skolem">f</span> <span class="bound">x</span><span class="main">)</span> 
             <span class="main">⟶</span> <span class="main">(</span><span class="main">∀</span><span class="bound">p</span><span class="main">.</span> <span class="bound">p</span> <span class="main">∉</span> FVoption <span class="main">(</span><span class="skolem">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">⟶</span> <span class="bound">s</span> <span class="main">≠</span> <span class="bound">p</span> 
                   <span class="main">⟶</span> sclose_option <span class="bound">n</span> <span class="bound">s</span> <span class="bound">p</span> <span class="main">(</span>sopen_option <span class="bound">n</span> <span class="main">(</span>Fvar <span class="bound">s</span><span class="main">)</span> <span class="main">(</span>Fvar <span class="bound">p</span><span class="main">)</span> <span class="main">(</span><span class="skolem">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> 
                       <span class="main">=</span> <span class="skolem">f</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">l</span><span class="main">.</span> sclose_option <span class="skolem">n</span> <span class="skolem">s</span> <span class="skolem">p</span> <span class="main">(</span>sopen_option <span class="skolem">n</span> <span class="main">(</span>Fvar <span class="skolem">s</span><span class="main">)</span> <span class="main">(</span>Fvar <span class="skolem">p</span><span class="main">)</span> <span class="main">(</span><span class="skolem">f</span> <span class="bound">l</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">f</span> <span class="bound">l</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> ext 
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">l</span><span class="main">.</span> sclose_option <span class="skolem">n</span> <span class="skolem">s</span> <span class="skolem">p</span> <span class="main">(</span>sopen_option <span class="skolem">n</span> <span class="main">(</span>Fvar <span class="skolem">s</span><span class="main">)</span> <span class="main">(</span>Fvar <span class="skolem">p</span><span class="main">)</span> <span class="main">(</span><span class="skolem">f</span> <span class="bound">l</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">f</span> "</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">from</span></span> conjunct1<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">assumption</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Sigma-sopen_sclose_eq_t"><span class="command">lemma</span></span> sopen_sclose_eq_t<span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">t</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"lc <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">n</span> <span class="bound">s</span> <span class="bound">p</span><span class="main">.</span> <span class="main">{</span><span class="bound">n</span> <span class="main">→</span> <span class="main">[</span>Fvar <span class="bound">s</span><span class="main">,</span> Fvar <span class="bound">p</span><span class="main">]}</span> <span class="main">{</span><span class="bound">n</span> <span class="main">←</span> <span class="main">[</span><span class="bound">s</span><span class="main">,</span><span class="bound">p</span><span class="main">]}</span> <span class="free">t</span> <span class="main">=</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> 
  <span class="main">(</span><span class="operator">induct</span>
    <span class="quasi_keyword">taking</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="main">∀</span><span class="bound">n</span> <span class="bound">s</span> <span class="bound">p</span><span class="main">.</span> <span class="main">{</span>Suc <span class="bound">n</span> <span class="main">→</span> <span class="main">[</span>Fvar <span class="bound">s</span><span class="main">,</span> Fvar <span class="bound">p</span><span class="main">]}</span> <span class="main">{</span>Suc <span class="bound">n</span> <span class="main">←</span> <span class="main">[</span><span class="bound">s</span><span class="main">,</span><span class="bound">p</span><span class="main">]}</span> <span class="bound">t</span> <span class="main">=</span> <span class="bound">t</span>"</span></span>
    <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> lc_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Fvar <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> Call <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> Upd <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Obj <span class="skolem">f</span> <span class="skolem">T</span><span class="main">)</span> <span class="keyword1"><span class="command">note</span></span> pred <span class="main">=</span> this
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> strip<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">n</span> <span class="skolem">s</span> <span class="skolem">p</span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">l</span>
      <span class="keyword1"><span class="command">have</span></span> 
        <span class="quoted"><span class="quoted">"sopen_option <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="main">(</span>Fvar <span class="skolem">s</span><span class="main">)</span> <span class="main">(</span>Fvar <span class="skolem">p</span><span class="main">)</span> <span class="main">(</span>sclose_option <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="skolem">s</span> <span class="skolem">p</span> <span class="main">(</span><span class="skolem">f</span> <span class="skolem">l</span><span class="main">)</span><span class="main">)</span> 
         <span class="main">=</span> <span class="skolem">f</span> <span class="skolem">l</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">∈</span> dom <span class="skolem">f</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> False <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="skolem">l</span> <span class="main">=</span> None"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> True <span class="keyword1"><span class="command">with</span></span> pred
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">with</span></span> ext 
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">l</span><span class="main">.</span> sopen_option <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="main">(</span>Fvar <span class="skolem">s</span><span class="main">)</span> <span class="main">(</span>Fvar <span class="skolem">p</span><span class="main">)</span> 
                 <span class="main">(</span>sclose_option <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="skolem">s</span> <span class="skolem">p</span> <span class="main">(</span><span class="skolem">f</span> <span class="bound">l</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">f</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Bnd <span class="skolem">L</span> <span class="skolem">t</span><span class="main">)</span> <span class="keyword1"><span class="command">note</span></span> cof <span class="main">=</span> this<span class="main">(</span>2<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> strip<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">n</span> <span class="skolem">s</span> <span class="skolem">p</span>
    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹finite <span class="skolem">L</span>›</span></span> exFresh_s_p_cof<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">L</span> <span class="main">∪</span> FV <span class="skolem">t</span> <span class="main">∪</span> <span class="main">{</span><span class="skolem">s</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="skolem">p</span><span class="main">}</span>"</span></span><span class="main">]</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">sa</span></span> <span class="skolem"><span class="skolem">pa</span></span> <span class="keyword2"><span class="keyword">where</span></span>
      sapa<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">sa</span> <span class="main">∉</span> <span class="skolem">L</span> <span class="main">∪</span> FV <span class="skolem">t</span> <span class="main">∪</span> <span class="main">{</span><span class="skolem">s</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="skolem">p</span><span class="main">}</span> <span class="main">∧</span> <span class="skolem">pa</span> <span class="main">∉</span> <span class="skolem">L</span> <span class="main">∪</span> FV <span class="skolem">t</span> <span class="main">∪</span> <span class="main">{</span><span class="skolem">s</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="skolem">p</span><span class="main">}</span> 
             <span class="main">∧</span> <span class="skolem">sa</span> <span class="main">≠</span> <span class="skolem">pa</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> cof
    <span class="keyword1"><span class="command">have</span></span> 
      eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span>Suc <span class="skolem">n</span> <span class="main">→</span> <span class="main">[</span>Fvar <span class="skolem">s</span><span class="main">,</span>Fvar <span class="skolem">p</span><span class="main">]}</span> <span class="main">{</span>Suc <span class="skolem">n</span> <span class="main">←</span> <span class="main">[</span><span class="skolem">s</span><span class="main">,</span><span class="skolem">p</span><span class="main">]}</span> <span class="main">(</span><span class="skolem">t</span><span class="hidden">⇗</span><sup>[Fvar <span class="skolem">sa</span><span class="main">,</span> Fvar <span class="skolem">pa</span>]</sup><span class="hidden">⇖</span><span class="main">)</span> 
           <span class="main">=</span> <span class="main">(</span><span class="skolem">t</span><span class="hidden">⇗</span><sup>[Fvar <span class="skolem">sa</span><span class="main">,</span> Fvar <span class="skolem">pa</span>]</sup><span class="hidden">⇖</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> FV <span class="skolem">t</span>"</span></span>
      <span class="keyword1"><span class="command">from</span></span> contra_subsetD<span class="main">[</span><span class="operator">OF</span> sclose_subset_FV this<span class="main">]</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> FV <span class="main">(</span><span class="main">{</span>Suc <span class="skolem">n</span> <span class="main">←</span> <span class="main">[</span><span class="skolem">s</span><span class="main">,</span><span class="skolem">p</span><span class="main">]}</span> <span class="skolem">t</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≠</span> <span class="skolem">p</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≠</span> <span class="skolem">s</span>"</span></span>
      <span class="keyword1"><span class="command">ultimately</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> FV <span class="main">(</span><span class="main">{</span>Suc <span class="skolem">n</span> <span class="main">←</span> <span class="main">[</span><span class="skolem">s</span><span class="main">,</span><span class="skolem">p</span><span class="main">]}</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">∪</span> FV <span class="main">(</span>Fvar <span class="skolem">s</span><span class="main">)</span> <span class="main">∪</span> FV <span class="main">(</span>Fvar <span class="skolem">p</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">from</span></span> contra_subsetD<span class="main">[</span><span class="operator">OF</span> sopen_FV this<span class="main">]</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> FV <span class="main">(</span><span class="main">{</span>Suc <span class="skolem">n</span> <span class="main">→</span> <span class="main">[</span>Fvar <span class="skolem">s</span><span class="main">,</span>Fvar <span class="skolem">p</span><span class="main">]}</span> <span class="main">{</span>Suc <span class="skolem">n</span> <span class="main">←</span> <span class="main">[</span><span class="skolem">s</span><span class="main">,</span><span class="skolem">p</span><span class="main">]}</span> <span class="skolem">t</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">with</span></span> sapa
    <span class="keyword1"><span class="command">have</span></span> 
      <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∉</span> FV <span class="main">(</span>Fvar <span class="skolem">sa</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∉</span> FV <span class="main">(</span>Fvar <span class="skolem">pa</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∉</span> FV <span class="main">(</span>Fvar <span class="skolem">sa</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∉</span> FV <span class="main">(</span>Fvar <span class="skolem">pa</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      <span class="quoted"><span class="quoted">"<span class="skolem">sa</span> <span class="main">∉</span> FV <span class="main">(</span><span class="main">{</span>Suc <span class="skolem">n</span> <span class="main">→</span> <span class="main">[</span>Fvar <span class="skolem">s</span><span class="main">,</span>Fvar <span class="skolem">p</span><span class="main">]}</span> <span class="main">{</span>Suc <span class="skolem">n</span> <span class="main">←</span> <span class="main">[</span><span class="skolem">s</span><span class="main">,</span><span class="skolem">p</span><span class="main">]}</span> <span class="skolem">t</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      <span class="quoted"><span class="quoted">"<span class="skolem">sa</span> <span class="main">∉</span> FV <span class="skolem">t</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      <span class="quoted"><span class="quoted">"<span class="skolem">pa</span> <span class="main">∉</span> FV <span class="main">(</span><span class="main">{</span>Suc <span class="skolem">n</span> <span class="main">→</span> <span class="main">[</span>Fvar <span class="skolem">s</span><span class="main">,</span>Fvar <span class="skolem">p</span><span class="main">]}</span> <span class="main">{</span>Suc <span class="skolem">n</span> <span class="main">←</span> <span class="main">[</span><span class="skolem">s</span><span class="main">,</span><span class="skolem">p</span><span class="main">]}</span> <span class="skolem">t</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      <span class="quoted"><span class="quoted">"<span class="skolem">pa</span> <span class="main">∉</span> FV <span class="skolem">t</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">sa</span> <span class="main">≠</span> <span class="skolem">pa</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="comment1">(* proof:

{Suc n → [Fvar s,Fvar p]} {Suc n ← [s,p]} (t<span class="hidden">⇗</span><sup>[Fvar sa,Fvar pa]</sup><span class="hidden">⇖</span>) 
= {Suc n → [Fvar s,Fvar p]} {Suc n ← [s,p]} {0 → [Fvar sa,Fvar pa]} t
= {Suc n → [Fvar s,Fvar p]} {0 → [Fvar sa,Fvar pa]} {Suc n ← [s,p]} t
= {0 → [Fvar sa,Fvar pa]} {Suc n → [Fvar s,Fvar p]} {Suc n ← [s,p]} t
= {0 → [Fvar sa,Fvar pa]} t
= (t<span class="hidden">⇗</span><sup>[Fvar sa,Fvar pa]</sup><span class="hidden">⇖</span>)
*)</span>
    <span class="keyword1"><span class="command">from</span></span>
      eq
      sym<span class="main">[</span><span class="operator">OF</span> sopen_sclose_commute<span class="main"><span class="main">[</span></span><span class="operator">OF</span> not_sym<span class="main"><span class="main">[</span></span><span class="operator">OF</span> Suc_not_Zero<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem">n</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span> 
                                                this<span class="main"><span class="main">(</span></span>1-4<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span>
      sopen_commute<span class="main">[</span><span class="operator">OF</span> Suc_not_Zero<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem">n</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span>
      sopen_fresh_inj<span class="main">[</span><span class="operator">OF</span> _ this<span class="main"><span class="main">(</span></span>5-9<span class="main"><span class="main">)</span></span><span class="main">]</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span>Suc <span class="skolem">n</span> <span class="main">→</span> <span class="main">[</span>Fvar <span class="skolem">s</span><span class="main">,</span>Fvar <span class="skolem">p</span><span class="main">]}</span> <span class="main">{</span>Suc <span class="skolem">n</span> <span class="main">←</span> <span class="main">[</span><span class="skolem">s</span><span class="main">,</span><span class="skolem">p</span><span class="main">]}</span> <span class="skolem">t</span> <span class="main">=</span> <span class="skolem">t</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> openz_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Sigma-ssubst_sopen_distrib"><span class="command">lemma</span></span> ssubst_sopen_distrib<span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">n</span> <span class="bound">s</span> <span class="bound">p</span> <span class="bound">t'</span><span class="main">.</span> lc <span class="bound">t'</span> <span class="main">⟶</span> <span class="main">[</span><span class="free">x</span> <span class="main">→</span> <span class="bound">t'</span><span class="main">]</span> <span class="main">{</span><span class="bound">n</span> <span class="main">→</span> <span class="main">[</span><span class="bound">s</span><span class="main">,</span><span class="bound">p</span><span class="main">]}</span> <span class="free">t</span> 
   <span class="main">=</span> <span class="main">{</span><span class="bound">n</span> <span class="main">→</span> <span class="main">[</span><span class="main">[</span><span class="free">x</span> <span class="main">→</span> <span class="bound">t'</span><span class="main">]</span><span class="bound">s</span><span class="main">,</span> <span class="main">[</span><span class="free">x</span> <span class="main">→</span> <span class="bound">t'</span><span class="main">]</span><span class="bound">p</span><span class="main">]}</span> <span class="main">[</span><span class="free">x</span> <span class="main">→</span> <span class="bound">t'</span><span class="main">]</span> <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">n</span> <span class="bound">s</span> <span class="bound">p</span> <span class="bound">t'</span><span class="main">.</span> lc <span class="bound">t'</span> 
       <span class="main">⟶</span> <span class="main">[</span><span class="free">x</span> <span class="main">→</span> <span class="bound">t'</span><span class="main">]</span> <span class="main">{</span><span class="bound">n</span> <span class="main">→</span> <span class="main">[</span><span class="bound">s</span><span class="main">,</span><span class="bound">p</span><span class="main">]}</span> <span class="free">t</span> <span class="main">=</span> <span class="main">{</span><span class="bound">n</span> <span class="main">→</span> <span class="main">[</span><span class="main">[</span><span class="free">x</span> <span class="main">→</span> <span class="bound">t'</span><span class="main">]</span><span class="bound">s</span><span class="main">,</span> <span class="main">[</span><span class="free">x</span> <span class="main">→</span> <span class="bound">t'</span><span class="main">]</span><span class="bound">p</span><span class="main">]}</span> <span class="main">[</span><span class="free">x</span> <span class="main">→</span> <span class="bound">t'</span><span class="main">]</span> <span class="free">t</span><span class="main">)</span>
    <span class="main">&amp;</span><span class="main">(</span><span class="main">∀</span><span class="bound">n</span> <span class="bound">s</span> <span class="bound">p</span> <span class="bound">t'</span><span class="main">.</span> lc <span class="bound">t'</span> 
       <span class="main">⟶</span> ssubst_option <span class="free">x</span> <span class="bound">t'</span> <span class="main">(</span>sopen_option <span class="bound">n</span> <span class="bound">s</span> <span class="bound">p</span> <span class="free">u</span><span class="main">)</span> 
           <span class="main">=</span> sopen_option <span class="bound">n</span> <span class="main">(</span><span class="main">[</span><span class="free">x</span> <span class="main">→</span> <span class="bound">t'</span><span class="main">]</span><span class="bound">s</span><span class="main">)</span> <span class="main">(</span><span class="main">[</span><span class="free">x</span> <span class="main">→</span> <span class="bound">t'</span><span class="main">]</span><span class="bound">p</span><span class="main">)</span> <span class="main">(</span>ssubst_option <span class="free">x</span> <span class="bound">t'</span> <span class="free">u</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> compat_sterm_sterm_option.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> bVariable.split<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> conjunct1<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">assumption</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Sigma-ssubst_openz_distrib"><span class="command">lemma</span></span> ssubst_openz_distrib<span class="main">:</span>
  <span class="quoted"><span class="quoted">"lc <span class="free">t'</span> <span class="main">⟹</span> <span class="main">[</span><span class="free">x</span> <span class="main">→</span> <span class="free">t'</span><span class="main">]</span> <span class="main">(</span><span class="free">t</span><span class="hidden">⇗</span><sup>[<span class="free">s</span><span class="main">,</span><span class="free">p</span>]</sup><span class="hidden">⇖</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="main">[</span><span class="free">x</span> <span class="main">→</span> <span class="free">t'</span><span class="main">]</span> <span class="free">t</span><span class="main">)</span><span class="hidden">⇗</span><sup>[<span class="main">[</span><span class="free">x</span> <span class="main">→</span> <span class="free">t'</span><span class="main">]</span> <span class="free">s</span><span class="main">,</span> <span class="main">[</span><span class="free">x</span> <span class="main">→</span> <span class="free">t'</span><span class="main">]</span> <span class="free">p</span>]</sup><span class="hidden">⇖</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> openz_def ssubst_sopen_distrib<span class="main">)</span>

<span class="keyword1" id="Sigma-ssubst_sopen_commute"><span class="command">lemma</span></span> ssubst_sopen_commute<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> lc <span class="free">t'</span><span class="main">;</span> <span class="free">x</span> <span class="main">∉</span> FV <span class="free">s</span><span class="main">;</span> <span class="free">x</span> <span class="main">∉</span> FV <span class="free">p</span> <span class="main">⟧</span> 
  <span class="main">⟹</span> <span class="main">[</span><span class="free">x</span> <span class="main">→</span> <span class="free">t'</span><span class="main">]</span> <span class="main">{</span><span class="free">n</span> <span class="main">→</span> <span class="main">[</span><span class="free">s</span><span class="main">,</span><span class="free">p</span><span class="main">]}</span> <span class="free">t</span> <span class="main">=</span> <span class="main">{</span><span class="free">n</span> <span class="main">→</span> <span class="main">[</span><span class="free">s</span><span class="main">,</span><span class="free">p</span><span class="main">]}</span> <span class="main">[</span><span class="free">x</span> <span class="main">→</span> <span class="free">t'</span><span class="main">]</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">frule</span> ssubst_sopen_distrib<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">t'</span></span></span></span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">x</span></span></span></span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">n</span></span></span></span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">s</span></span></span></span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">p</span></span></span></span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">t</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>

<span class="keyword1" id="Sigma-sopen_commute_gen"><span class="command">lemma</span></span> sopen_commute_gen<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">s</span> <span class="free">p</span> <span class="free">s'</span> <span class="free">p'</span> <span class="free">n</span> <span class="free">k</span> <span class="free">t</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"lc <span class="free">s</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"lc <span class="free">p</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"lc <span class="free">s'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"lc <span class="free">p'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">≠</span> <span class="free">k</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">n</span> <span class="main">→</span> <span class="main">[</span><span class="free">s</span><span class="main">,</span><span class="free">p</span><span class="main">]}</span> <span class="main">{</span><span class="free">k</span> <span class="main">→</span> <span class="main">[</span><span class="free">s'</span><span class="main">,</span><span class="free">p'</span><span class="main">]}</span> <span class="free">t</span> <span class="main">=</span> <span class="main">{</span><span class="free">k</span> <span class="main">→</span> <span class="main">[</span><span class="free">s'</span><span class="main">,</span><span class="free">p'</span><span class="main">]}</span> <span class="main">{</span><span class="free">n</span> <span class="main">→</span> <span class="main">[</span><span class="free">s</span><span class="main">,</span><span class="free">p</span><span class="main">]}</span> <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>FV <span class="free">s</span> <span class="main">∪</span> FV <span class="free">p</span> <span class="main">∪</span> FV <span class="free">s'</span> <span class="main">∪</span> FV <span class="free">p'</span> <span class="main">∪</span> FV <span class="free">t</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> exFresh_s_p_cof<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">sa</span></span> <span class="skolem"><span class="skolem">pa</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
    <span class="quoted"><span class="quoted">"<span class="skolem">sa</span> <span class="main">∉</span> FV <span class="free">s</span> <span class="main">∪</span> FV <span class="free">p</span> <span class="main">∪</span> FV <span class="free">s'</span> <span class="main">∪</span> FV <span class="free">p'</span> <span class="main">∪</span> FV <span class="free">t</span> 
    <span class="main">∧</span> <span class="skolem">pa</span> <span class="main">∉</span> FV <span class="free">s</span> <span class="main">∪</span> FV <span class="free">p</span> <span class="main">∪</span> FV <span class="free">s'</span> <span class="main">∪</span> FV <span class="free">p'</span> <span class="main">∪</span> FV <span class="free">t</span> <span class="main">∧</span> <span class="skolem">sa</span> <span class="main">≠</span> <span class="skolem">pa</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> 
  <span class="keyword1"><span class="command"><span class="improper">hence</span></span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>FV <span class="free">s</span> <span class="main">∪</span> FV <span class="free">p</span> <span class="main">∪</span> FV <span class="free">s'</span> <span class="main">∪</span> FV <span class="free">p'</span> <span class="main">∪</span> FV <span class="free">t</span> <span class="main">∪</span> <span class="main">{</span><span class="skolem">sa</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="skolem">pa</span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> exFresh_s_p_cof<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">sb</span></span> <span class="skolem"><span class="skolem">pb</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
    <span class="quoted"><span class="quoted">"<span class="skolem">sb</span> <span class="main">∉</span> FV <span class="free">s</span> <span class="main">∪</span> FV <span class="free">p</span> <span class="main">∪</span> FV <span class="free">s'</span> <span class="main">∪</span> FV <span class="free">p'</span> <span class="main">∪</span> FV <span class="free">t</span> <span class="main">∪</span> <span class="main">{</span><span class="skolem">sa</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="skolem">pa</span><span class="main">}</span> 
    <span class="main">∧</span> <span class="skolem">pb</span> <span class="main">∉</span> FV <span class="free">s</span> <span class="main">∪</span> FV <span class="free">p</span> <span class="main">∪</span> FV <span class="free">s'</span> <span class="main">∪</span> FV <span class="free">p'</span> <span class="main">∪</span> FV <span class="free">t</span> <span class="main">∪</span> <span class="main">{</span><span class="skolem">sa</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="skolem">pa</span><span class="main">}</span> 
    <span class="main">∧</span> <span class="skolem">sb</span> <span class="main">≠</span> <span class="skolem">pb</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword1"><span class="command">have</span></span>
    <span class="quoted"><span class="quoted">"<span class="skolem">sa</span> <span class="main">∉</span> FV <span class="free">t</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">pa</span> <span class="main">∉</span> FV <span class="free">t</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">sb</span> <span class="main">∉</span> FV <span class="free">t</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">pb</span> <span class="main">∉</span> FV <span class="free">t</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="skolem">sa</span> <span class="main">∉</span> FV <span class="main">(</span><span class="main">{</span><span class="free">n</span> <span class="main">→</span> <span class="main">[</span><span class="free">s</span><span class="main">,</span><span class="free">p</span><span class="main">]}</span> <span class="free">t</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">pa</span> <span class="main">∉</span> FV <span class="main">(</span><span class="main">{</span><span class="free">n</span> <span class="main">→</span> <span class="main">[</span><span class="free">s</span><span class="main">,</span><span class="free">p</span><span class="main">]}</span> <span class="free">t</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="skolem">sb</span> <span class="main">∉</span> FV <span class="main">(</span><span class="main">{</span><span class="free">k</span> <span class="main">→</span> <span class="main">[</span><span class="free">s'</span><span class="main">,</span><span class="free">p'</span><span class="main">]}</span> <span class="free">t</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">pb</span> <span class="main">∉</span> FV <span class="main">(</span><span class="main">{</span><span class="free">k</span> <span class="main">→</span> <span class="main">[</span><span class="free">s'</span><span class="main">,</span><span class="free">p'</span><span class="main">]}</span> <span class="free">t</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>

    <span class="quoted"><span class="quoted">"<span class="skolem">sa</span> <span class="main">≠</span> <span class="skolem">pa</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">sb</span> <span class="main">≠</span> <span class="skolem">pb</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">sb</span> <span class="main">≠</span> <span class="skolem">sa</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">sb</span> <span class="main">≠</span> <span class="skolem">pa</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 
    <span class="quoted"><span class="quoted">"<span class="skolem">pb</span> <span class="main">≠</span> <span class="skolem">sa</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">pb</span> <span class="main">≠</span> <span class="skolem">pa</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>

    <span class="quoted"><span class="quoted">"<span class="skolem">sa</span> <span class="main">∉</span> FV <span class="free">s</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">sa</span> <span class="main">∉</span> FV <span class="free">p</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">pa</span> <span class="main">∉</span> FV <span class="free">s</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">pa</span> <span class="main">∉</span> FV <span class="free">p</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="skolem">sb</span> <span class="main">∉</span> FV <span class="free">s'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">sb</span> <span class="main">∉</span> FV <span class="free">p'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">pb</span> <span class="main">∉</span> FV <span class="free">s'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">pb</span> <span class="main">∉</span> FV <span class="free">p'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="skolem">sa</span> <span class="main">∉</span> FV <span class="free">p'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">sb</span> <span class="main">∉</span> FV <span class="free">p</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>

    <span class="quoted"><span class="quoted">"<span class="skolem">sa</span> <span class="main">∉</span> FV <span class="main">(</span>Fvar <span class="skolem">sb</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">sa</span> <span class="main">∉</span> FV <span class="main">(</span>Fvar <span class="skolem">pb</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="skolem">pa</span> <span class="main">∉</span> FV <span class="main">(</span>Fvar <span class="skolem">sb</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">pa</span> <span class="main">∉</span> FV <span class="main">(</span>Fvar <span class="skolem">pb</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="skolem">pb</span> <span class="main">∉</span> FV <span class="main">(</span>Fvar <span class="skolem">sa</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">pb</span> <span class="main">∉</span> FV <span class="main">(</span>Fvar <span class="skolem">pa</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="skolem">sb</span> <span class="main">∉</span> FV <span class="main">(</span>Fvar <span class="skolem">sa</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">sb</span> <span class="main">∉</span> FV <span class="main">(</span>Fvar <span class="skolem">pa</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>

    <span class="quoted"><span class="quoted">"lc <span class="free">s</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"lc <span class="free">p</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"lc <span class="free">s'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"lc <span class="free">p'</span>"</span></span>

    <span class="keyword1"><span class="command">using</span></span> contra_subsetD<span class="main">[</span><span class="operator">OF</span> sopen_FV<span class="main">]</span> assms<span class="main">(</span>1-4<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="comment1">(* proof:

{n → [s,p]} {k → [s',p']} t 
= {n → [s,p]} [sa → s'] [pa → p'] {k → [Fvar sa,Fvar pa]} t
= [sa → s'] [pa → p'] [pa → p'] {k → [Fvar sa,Fvar pa]} t
= [sb → s] [pb → p] {n → [Fvar sb,Fvar pb]} [sa → s'] [pa → p'] {k → [Fvar sa,Fvar pa]} t
= [sb → s] [pb → p] [sa → s'] {n → [Fvar sb,Fvar pb]} [pa → p'] {k → [Fvar sa,Fvar pa]} t
= [sb → s] [pb → p] [sa → s'] [pa → p'] {n → [Fvar sb,Fvar pb]} {k → [Fvar sa,Fvar pa]} t
= [sb → s] [pb → p] [sa → s'] [pa → p'] {k → [Fvar sa,Fvar pa]} {n → [Fvar sb,Fvar pb]} t
= [sb → s] [sa → s'] [pb → p] [pa → p'] {k → [Fvar sa,Fvar pa]} {n → [Fvar sb,Fvar pb]} t
= [sa → s'] [sb → s] [pb → p] [pa → p'] {k → [Fvar sa,Fvar pa]} {n → [Fvar sb,Fvar pb]} t
= [sa → s'] [sb → s] [pa → p'] [pb → p] {k → [Fvar sa,Fvar pa]} {n → [Fvar sb,Fvar pb]} t
= [sa → s'] [pa → p'] [sb → s] [pb → p] {k → [Fvar sa,Fvar pa]} {n → [Fvar sb,Fvar pb]} t
= [sa → s'] [pa → p'] [sb → s] {k → [Fvar sa,Fvar pa]} [pb → p] {n → [Fvar sb,Fvar pb]} t
= [sa → s'] [pa → p'] {k → [Fvar sa,Fvar pa]} [sb → s] [pb → p] {n → [Fvar sb,Fvar pb]} t
= [sa → s'] [pa → p'] {k → [Fvar sa,Fvar pa]} {n → [s,p]} t
= {k → [s',p']} {n → [s,p]} t 
*)</span>
  <span class="keyword1"><span class="command">from</span></span> 
    ssubst_intro<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">sa</span> <span class="main">∉</span> FV <span class="free">t</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">pa</span> <span class="main">∉</span> FV <span class="free">t</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">sa</span> <span class="main">≠</span> <span class="skolem">pa</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">sa</span> <span class="main">∉</span> FV <span class="free">p'</span>›</span></span><span class="main">]</span> 
    ssubst_intro<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">sb</span> <span class="main">∉</span> FV <span class="main">(</span><span class="main">{</span><span class="free">k</span> <span class="main">→</span> <span class="main">[</span><span class="free">s'</span><span class="main">,</span><span class="free">p'</span><span class="main">]}</span> <span class="free">t</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">pb</span> <span class="main">∉</span> FV <span class="main">(</span><span class="main">{</span><span class="free">k</span> <span class="main">→</span> <span class="main">[</span><span class="free">s'</span><span class="main">,</span><span class="free">p'</span><span class="main">]}</span> <span class="free">t</span><span class="main">)</span>›</span></span> 
                    <span class="quoted"><span class="quoted">‹<span class="skolem">sb</span> <span class="main">≠</span> <span class="skolem">pb</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">sb</span> <span class="main">∉</span> FV <span class="free">p</span>›</span></span><span class="main">]</span>
    sym<span class="main">[</span><span class="operator">OF</span> ssubst_sopen_commute<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹lc <span class="free">s'</span>›</span></span> 
                                   <span class="quoted"><span class="quoted">‹<span class="skolem">sa</span> <span class="main">∉</span> FV <span class="main">(</span>Fvar <span class="skolem">sb</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">sa</span> <span class="main">∉</span> FV <span class="main">(</span>Fvar <span class="skolem">pb</span><span class="main">)</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span>
    sym<span class="main">[</span><span class="operator">OF</span> ssubst_sopen_commute<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹lc <span class="free">p'</span>›</span></span> 
                                   <span class="quoted"><span class="quoted">‹<span class="skolem">pa</span> <span class="main">∉</span> FV <span class="main">(</span>Fvar <span class="skolem">sb</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">pa</span> <span class="main">∉</span> FV <span class="main">(</span>Fvar <span class="skolem">pb</span><span class="main">)</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span>
    sopen_commute<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">n</span> <span class="main">≠</span> <span class="free">k</span>›</span></span><span class="main">]</span>
    ssubst_commute<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">pb</span> <span class="main">≠</span> <span class="skolem">sa</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">pb</span> <span class="main">∉</span> FV <span class="free">s'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">sa</span> <span class="main">∉</span> FV <span class="free">p</span>›</span></span><span class="main">]</span>
    ssubst_commute<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">sb</span> <span class="main">≠</span> <span class="skolem">sa</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">sb</span> <span class="main">∉</span> FV <span class="free">s'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">sa</span> <span class="main">∉</span> FV <span class="free">s</span>›</span></span><span class="main">]</span>
    ssubst_commute<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">pb</span> <span class="main">≠</span> <span class="skolem">pa</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">pb</span> <span class="main">∉</span> FV <span class="free">p'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">pa</span> <span class="main">∉</span> FV <span class="free">p</span>›</span></span><span class="main">]</span>
    ssubst_commute<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">sb</span> <span class="main">≠</span> <span class="skolem">pa</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">sb</span> <span class="main">∉</span> FV <span class="free">p'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">pa</span> <span class="main">∉</span> FV <span class="free">s</span>›</span></span><span class="main">]</span>
    ssubst_sopen_commute<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹lc <span class="free">s</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">sb</span> <span class="main">∉</span> FV <span class="main">(</span>Fvar <span class="skolem">sa</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">sb</span> <span class="main">∉</span> FV <span class="main">(</span>Fvar <span class="skolem">pa</span><span class="main">)</span>›</span></span><span class="main">]</span> 
    ssubst_sopen_commute<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹lc <span class="free">p</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">pb</span> <span class="main">∉</span> FV <span class="main">(</span>Fvar <span class="skolem">sa</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">pb</span> <span class="main">∉</span> FV <span class="main">(</span>Fvar <span class="skolem">pa</span><span class="main">)</span>›</span></span><span class="main">]</span> 
    sym<span class="main">[</span><span class="operator">OF</span> ssubst_intro<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">sb</span> <span class="main">∉</span> FV <span class="free">t</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">pb</span> <span class="main">∉</span> FV <span class="free">t</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">sb</span> <span class="main">≠</span> <span class="skolem">pb</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">sb</span> <span class="main">∉</span> FV <span class="free">p</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span> 
    sym<span class="main">[</span><span class="operator">OF</span> ssubst_intro<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">sa</span> <span class="main">∉</span> FV <span class="main">(</span><span class="main">{</span><span class="free">n</span> <span class="main">→</span> <span class="main">[</span><span class="free">s</span><span class="main">,</span><span class="free">p</span><span class="main">]}</span> <span class="free">t</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">pa</span> <span class="main">∉</span> FV <span class="main">(</span><span class="main">{</span><span class="free">n</span> <span class="main">→</span> <span class="main">[</span><span class="free">s</span><span class="main">,</span><span class="free">p</span><span class="main">]}</span> <span class="free">t</span><span class="main">)</span>›</span></span>
                           <span class="quoted"><span class="quoted">‹<span class="skolem">sa</span> <span class="main">≠</span> <span class="skolem">pa</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">sa</span> <span class="main">∉</span> FV <span class="free">p'</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">n</span> <span class="main">→</span> <span class="main">[</span><span class="free">s</span><span class="main">,</span><span class="free">p</span><span class="main">]}</span> <span class="main">{</span><span class="free">k</span> <span class="main">→</span> <span class="main">[</span><span class="free">s'</span><span class="main">,</span><span class="free">p'</span><span class="main">]}</span> <span class="free">t</span> <span class="main">=</span> <span class="main">{</span><span class="free">k</span> <span class="main">→</span> <span class="main">[</span><span class="free">s'</span><span class="main">,</span><span class="free">p'</span><span class="main">]}</span> <span class="main">{</span><span class="free">n</span> <span class="main">→</span> <span class="main">[</span><span class="free">s</span><span class="main">,</span><span class="free">p</span><span class="main">]}</span> <span class="free">t</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Sigma-ssubst_preserves_lc"><span class="command">lemma</span></span> ssubst_preserves_lc<span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">t</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"lc <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span> <span class="bound">t'</span><span class="main">.</span> lc <span class="bound">t'</span> <span class="main">⟶</span> lc <span class="main">(</span><span class="main">[</span><span class="bound">x</span> <span class="main">→</span> <span class="bound">t'</span><span class="main">]</span> <span class="free">t</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">pred_cof</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">pred_cof</span> <span class="skolem">L</span> <span class="skolem">t</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">s</span> <span class="bound">p</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∉</span> <span class="skolem">L</span> <span class="main">∧</span> <span class="bound">p</span> <span class="main">∉</span> <span class="skolem">L</span> <span class="main">∧</span> <span class="bound">s</span> <span class="main">≠</span> <span class="bound">p</span> <span class="main">⟶</span> lc <span class="main">(</span><span class="skolem">t</span><span class="hidden">⇗</span><sup>[Fvar <span class="bound">s</span><span class="main">,</span> Fvar <span class="bound">p</span>]</sup><span class="hidden">⇖</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">L</span> <span class="skolem">t</span>

  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">v</span> <span class="skolem">t</span>
    <span class="keyword3"><span class="command">assume</span></span> 
      <span class="quoted"><span class="quoted">"lc <span class="skolem">v</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span> <span class="bound">v</span><span class="main">.</span> lc <span class="bound">v</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">L</span><span class="main">.</span> finite <span class="bound">L</span> <span class="main">∧</span> <span class="skolem">pred_cof</span> <span class="bound">L</span> <span class="main">(</span><span class="main">[</span><span class="bound">x</span> <span class="main">→</span> <span class="bound">v</span><span class="main">]</span> <span class="skolem">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">L</span><span class="main">.</span> finite <span class="bound">L</span> <span class="main">∧</span> <span class="skolem">pred_cof</span> <span class="bound">L</span> <span class="main">(</span><span class="main">[</span><span class="skolem">x</span> <span class="main">→</span> <span class="skolem">v</span><span class="main">]</span> <span class="skolem">t</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">}</span></span><span class="keyword1"><span class="command">note</span></span> Lex <span class="main">=</span> this

  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> 
    <span class="main">(</span><span class="operator">induct</span>
      <span class="quasi_keyword">taking</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="main">∀</span><span class="bound">x</span> <span class="bound">t'</span><span class="main">.</span> lc <span class="bound">t'</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">L</span><span class="main">.</span> finite <span class="bound">L</span> <span class="main">∧</span> <span class="skolem">pred_cof</span> <span class="bound">L</span> <span class="main">(</span><span class="main">[</span><span class="bound">x</span> <span class="main">→</span> <span class="bound">t'</span><span class="main">]</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> lc_induct<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> Fvar <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> Call <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Upd <span class="skolem">t</span> <span class="skolem">l</span> <span class="skolem">u</span><span class="main">)</span> <span class="keyword1"><span class="command">note</span></span> pred_t <span class="main">=</span> this<span class="main">(</span>2<span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span> pred_bnd <span class="main">=</span> this<span class="main">(</span>3<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> strip<span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">t'</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"lc <span class="skolem">t'</span>"</span></span>
      <span class="keyword1"><span class="command">note</span></span> Lex<span class="main">[</span><span class="operator">OF</span> this pred_bnd<span class="main">]</span> 
      <span class="keyword1"><span class="command">from</span></span> this<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">x</span></span><span class="main">]</span> 
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">L</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"finite <span class="skolem">L</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">pred_cof</span> <span class="skolem">L</span> <span class="main">(</span><span class="main">[</span><span class="skolem">x</span> <span class="main">→</span> <span class="skolem">t'</span><span class="main">]</span> <span class="skolem">u</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹lc <span class="skolem">t'</span>›</span></span> pred_t <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"lc <span class="main">(</span><span class="main">[</span><span class="skolem">x</span> <span class="main">→</span> <span class="skolem">t'</span><span class="main">]</span> Upd <span class="skolem">t</span> <span class="skolem">l</span> <span class="skolem">u</span><span class="main">)</span>"</span></span> 
        <span class="keyword1"><span class="command">unfolding</span></span> pred_cof_def
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Obj <span class="skolem">f</span> <span class="skolem">T</span><span class="main">)</span> <span class="keyword1"><span class="command">note</span></span> pred <span class="main">=</span> this
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> strip<span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">t'</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"lc <span class="skolem">t'</span>"</span></span>
      <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">pred_fl</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">pred_fl</span> <span class="skolem">s</span> <span class="skolem">p</span> <span class="skolem">b</span> <span class="skolem">l</span> <span class="main">=</span> lc <span class="main">(</span><span class="main">[</span><span class="skolem">x</span> <span class="main">→</span> <span class="skolem">t'</span><span class="main">]</span> the <span class="skolem">b</span><span class="hidden">⇗</span><sup>[Fvar <span class="skolem">s</span><span class="main">,</span> Fvar <span class="skolem">p</span>]</sup><span class="hidden">⇖</span><span class="main">)</span>"</span></span>
        <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">s</span> <span class="skolem">p</span> <span class="skolem">b</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">l</span><span class="main">::</span><span class="quoted">Label</span>

      <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹lc <span class="skolem">t'</span>›</span></span> fmap_ball_all2<span class="main">[</span><span class="operator">OF</span> pred<span class="main">]</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">l</span><span class="main">∈</span>dom <span class="skolem">f</span><span class="main">.</span> <span class="main">∃</span><span class="bound">L</span><span class="main">.</span> finite <span class="bound">L</span> <span class="main">∧</span> <span class="skolem">pred_cof</span> <span class="bound">L</span> <span class="main">(</span><span class="main">[</span><span class="skolem">x</span> <span class="main">→</span> <span class="skolem">t'</span><span class="main">]</span> the<span class="main">(</span><span class="skolem">f</span> <span class="bound">l</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> pred_cof_def
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">with</span></span> fmap_ex_cof<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">f</span></span> <span class="quoted"><span class="skolem">pred_fl</span></span><span class="main">]</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">L</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
        <span class="quoted"><span class="quoted">"finite <span class="skolem">L</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">l</span><span class="main">∈</span>dom <span class="skolem">f</span><span class="main">.</span> <span class="skolem">pred_cof</span> <span class="skolem">L</span> <span class="main">(</span><span class="main">[</span><span class="skolem">x</span> <span class="main">→</span> <span class="skolem">t'</span><span class="main">]</span> the<span class="main">(</span><span class="skolem">f</span> <span class="bound">l</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> pred_cof_def pred_fl_def
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">with</span></span> pred_ssubstoption_lem<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">x</span></span> <span class="quoted"><span class="skolem">t'</span></span> <span class="quoted"><span class="skolem">f</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">pred_cof</span> <span class="skolem">L</span>"</span></span><span class="main">]</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"lc <span class="main">(</span><span class="main">[</span><span class="skolem">x</span> <span class="main">→</span> <span class="skolem">t'</span><span class="main">]</span> Obj <span class="skolem">f</span> <span class="skolem">T</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> pred_cof_def
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Bnd <span class="skolem">L</span> <span class="skolem">t</span><span class="main">)</span> <span class="keyword1"><span class="command">note</span></span> pred <span class="main">=</span> this<span class="main">(</span>2<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> strip<span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">t'</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"lc <span class="skolem">t'</span>"</span></span>
      <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹finite <span class="skolem">L</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">L</span><span class="main">.</span> finite <span class="bound">L</span> <span class="main">∧</span> <span class="skolem">pred_cof</span> <span class="bound">L</span> <span class="main">(</span><span class="main">[</span><span class="skolem">x</span> <span class="main">→</span> <span class="skolem">t'</span><span class="main">]</span> <span class="skolem">t</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> pred_cof_def
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span>
          <span class="operator">rule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">L</span> <span class="main">∪</span> <span class="main">{</span><span class="skolem">x</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main"><span class="keyword3">,</span></span> 
          <span class="operator">intro</span> conjI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> strip<span class="main">)</span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span> <span class="skolem">p</span> <span class="keyword3"><span class="command">assume</span></span> sp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∉</span> <span class="skolem">L</span> <span class="main">∪</span> <span class="main">{</span><span class="skolem">x</span><span class="main">}</span> <span class="main">∧</span> <span class="skolem">p</span> <span class="main">∉</span> <span class="skolem">L</span> <span class="main">∪</span> <span class="main">{</span><span class="skolem">x</span><span class="main">}</span> <span class="main">∧</span> <span class="skolem">s</span> <span class="main">≠</span> <span class="skolem">p</span>"</span></span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> FV <span class="main">(</span>Fvar <span class="skolem">s</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> FV <span class="main">(</span>Fvar <span class="skolem">p</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">from</span></span> sp pred <span class="quoted"><span class="quoted">‹lc <span class="skolem">t'</span>›</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"lc <span class="main">(</span><span class="main">[</span><span class="skolem">x</span> <span class="main">→</span> <span class="skolem">t'</span><span class="main">]</span> <span class="main">(</span><span class="skolem">t</span><span class="hidden">⇗</span><sup>[Fvar <span class="skolem">s</span><span class="main">,</span>Fvar <span class="skolem">p</span>]</sup><span class="hidden">⇖</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">with</span></span> ssubst_sopen_commute<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹lc <span class="skolem">t'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∉</span> FV <span class="main">(</span>Fvar <span class="skolem">s</span><span class="main">)</span>›</span></span> 
                                     <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∉</span> FV <span class="main">(</span>Fvar <span class="skolem">p</span><span class="main">)</span>›</span></span><span class="main">]</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"lc <span class="main">(</span><span class="main">[</span><span class="skolem">x</span> <span class="main">→</span> <span class="skolem">t'</span><span class="main">]</span> <span class="skolem">t</span><span class="hidden">⇗</span><sup>[Fvar <span class="skolem">s</span><span class="main">,</span>Fvar <span class="skolem">p</span>]</sup><span class="hidden">⇖</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> openz_def<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Sigma-sopen_sclose_eq_ssubst"><span class="command">lemma</span></span> sopen_sclose_eq_ssubst<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">sa</span> <span class="main">≠</span> <span class="free">pa</span><span class="main">;</span> <span class="free">sa</span> <span class="main">∉</span> FV <span class="free">p</span><span class="main">;</span> lc <span class="free">t</span> <span class="main">⟧</span> 
  <span class="main">⟹</span> <span class="main">{</span><span class="free">n</span> <span class="main">→</span> <span class="main">[</span><span class="free">s</span><span class="main">,</span><span class="free">p</span><span class="main">]}</span> <span class="main">{</span><span class="free">n</span> <span class="main">←</span> <span class="main">[</span><span class="free">sa</span><span class="main">,</span><span class="free">pa</span><span class="main">]}</span> <span class="free">t</span> <span class="main">=</span> <span class="main">[</span><span class="free">sa</span> <span class="main">→</span> <span class="free">s</span><span class="main">]</span> <span class="main">[</span><span class="free">pa</span> <span class="main">→</span> <span class="free">p</span><span class="main">]</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> sa1 <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="free">sa</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> pa1 <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="free">pa</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> t1 <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">n</span> <span class="main">←</span> <span class="main">[</span><span class="free">sa</span><span class="main">,</span><span class="free">pa</span><span class="main">]}</span> <span class="free">t</span>"</span></span> 
    <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> ssubst<span class="main"><span class="main">[</span></span><span class="operator">OF</span> ssubst_intro<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>

<span class="keyword1" id="Sigma-ssubst_sclose_commute"><span class="command">lemma</span></span> ssubst_sclose_commute<span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span> <span class="bound">n</span> <span class="bound">s</span> <span class="bound">p</span> <span class="bound">t'</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∉</span> FV <span class="bound">t'</span> <span class="main">⟶</span> <span class="bound">p</span> <span class="main">∉</span> FV <span class="bound">t'</span> <span class="main">⟶</span> <span class="bound">x</span> <span class="main">≠</span> <span class="bound">s</span> <span class="main">⟶</span> <span class="bound">x</span> <span class="main">≠</span> <span class="bound">p</span> 
     <span class="main">⟶</span> <span class="main">[</span><span class="bound">x</span> <span class="main">→</span> <span class="bound">t'</span><span class="main">]</span> <span class="main">{</span><span class="bound">n</span> <span class="main">←</span> <span class="main">[</span><span class="bound">s</span><span class="main">,</span><span class="bound">p</span><span class="main">]}</span> <span class="free">t</span> <span class="main">=</span> <span class="main">{</span><span class="bound">n</span> <span class="main">←</span> <span class="main">[</span><span class="bound">s</span><span class="main">,</span><span class="bound">p</span><span class="main">]}</span> <span class="main">[</span><span class="bound">x</span> <span class="main">→</span> <span class="bound">t'</span><span class="main">]</span> <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">x</span> <span class="bound">n</span> <span class="bound">s</span> <span class="bound">p</span> <span class="bound">t'</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∉</span> FV <span class="bound">t'</span> <span class="main">⟶</span> <span class="bound">p</span> <span class="main">∉</span> FV <span class="bound">t'</span> <span class="main">⟶</span> <span class="bound">x</span> <span class="main">≠</span> <span class="bound">s</span> <span class="main">⟶</span> <span class="bound">x</span> <span class="main">≠</span> <span class="bound">p</span> 
       <span class="main">⟶</span> <span class="main">[</span><span class="bound">x</span> <span class="main">→</span> <span class="bound">t'</span><span class="main">]</span> <span class="main">{</span><span class="bound">n</span> <span class="main">←</span> <span class="main">[</span><span class="bound">s</span><span class="main">,</span><span class="bound">p</span><span class="main">]}</span> <span class="free">t</span> <span class="main">=</span> <span class="main">{</span><span class="bound">n</span> <span class="main">←</span> <span class="main">[</span><span class="bound">s</span><span class="main">,</span><span class="bound">p</span><span class="main">]}</span> <span class="main">[</span><span class="bound">x</span> <span class="main">→</span> <span class="bound">t'</span><span class="main">]</span> <span class="free">t</span><span class="main">)</span>
    <span class="main">&amp;</span><span class="main">(</span><span class="main">∀</span><span class="bound">x</span> <span class="bound">n</span> <span class="bound">s</span> <span class="bound">p</span> <span class="bound">t'</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∉</span> FV <span class="bound">t'</span> <span class="main">⟶</span> <span class="bound">p</span> <span class="main">∉</span> FV <span class="bound">t'</span> <span class="main">⟶</span> <span class="bound">x</span> <span class="main">≠</span> <span class="bound">s</span> <span class="main">⟶</span> <span class="bound">x</span> <span class="main">≠</span> <span class="bound">p</span> 
       <span class="main">⟶</span> ssubst_option <span class="bound">x</span> <span class="bound">t'</span> <span class="main">(</span>sclose_option <span class="bound">n</span> <span class="bound">s</span> <span class="bound">p</span> <span class="free">u</span><span class="main">)</span> 
           <span class="main">=</span> sclose_option <span class="bound">n</span> <span class="bound">s</span> <span class="bound">p</span> <span class="main">(</span>ssubst_option <span class="bound">x</span> <span class="bound">t'</span> <span class="free">u</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> compat_sterm_sterm_option.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> bVariable.split<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> conjunct1<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">assumption</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Sigma-body_lc_FV"><span class="command">lemma</span></span> body_lc_FV<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">t</span> <span class="free">s</span> <span class="free">p</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"body <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"lc <span class="main">(</span><span class="free">t</span><span class="hidden">⇗</span><sup>[Fvar <span class="free">s</span><span class="main">,</span> Fvar <span class="free">p</span>]</sup><span class="hidden">⇖</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms 
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">L</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
    <span class="quoted"><span class="quoted">"finite <span class="skolem">L</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> pred_sp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">s</span> <span class="bound">p</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∉</span> <span class="skolem">L</span> <span class="main">∧</span> <span class="bound">p</span> <span class="main">∉</span> <span class="skolem">L</span> <span class="main">∧</span> <span class="bound">s</span> <span class="main">≠</span> <span class="bound">p</span> <span class="main">⟶</span> lc <span class="main">(</span><span class="free">t</span><span class="hidden">⇗</span><sup>[Fvar <span class="bound">s</span><span class="main">,</span>Fvar <span class="bound">p</span>]</sup><span class="hidden">⇖</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> body_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="skolem">L</span> <span class="main">∪</span> FV <span class="free">t</span> <span class="main">∪</span> <span class="main">{</span><span class="free">s</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="free">p</span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> exFresh_s_p_cof<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">sa</span></span> <span class="skolem"><span class="skolem">pa</span></span> <span class="keyword2"><span class="keyword">where</span></span> sapa<span class="main">:</span> 
    <span class="quoted"><span class="quoted">"<span class="skolem">sa</span> <span class="main">∉</span> <span class="skolem">L</span> <span class="main">∪</span> FV <span class="free">t</span> <span class="main">∪</span> <span class="main">{</span><span class="free">s</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="free">p</span><span class="main">}</span> <span class="main">∧</span> <span class="skolem">pa</span> <span class="main">∉</span> <span class="skolem">L</span> <span class="main">∪</span> FV <span class="free">t</span> <span class="main">∪</span> <span class="main">{</span><span class="free">s</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="free">p</span><span class="main">}</span> <span class="main">∧</span> <span class="skolem">sa</span> <span class="main">≠</span> <span class="skolem">pa</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">sa</span> <span class="main">∉</span> FV <span class="free">t</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">pa</span> <span class="main">∉</span> FV <span class="free">t</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">sa</span> <span class="main">≠</span> <span class="skolem">pa</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">sa</span> <span class="main">∉</span> FV <span class="main">(</span>Fvar <span class="free">p</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> pred_sp sapa <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"lc <span class="main">(</span><span class="free">t</span><span class="hidden">⇗</span><sup>[Fvar <span class="skolem">sa</span><span class="main">,</span>Fvar <span class="skolem">pa</span>]</sup><span class="hidden">⇖</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword1"><span class="command">with</span></span> 
    ssubst_intro<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">sa</span> <span class="main">∉</span> FV <span class="free">t</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">pa</span> <span class="main">∉</span> FV <span class="free">t</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">sa</span> <span class="main">≠</span> <span class="skolem">pa</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">sa</span> <span class="main">∉</span> FV <span class="main">(</span>Fvar <span class="free">p</span><span class="main">)</span>›</span></span><span class="main">]</span> 
    ssubst_preserves_lc
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"lc <span class="main">(</span><span class="free">t</span><span class="hidden">⇗</span><sup>[Fvar <span class="free">s</span><span class="main">,</span>Fvar <span class="free">p</span>]</sup><span class="hidden">⇖</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> openz_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Sigma-body_lc"><span class="command">lemma</span></span> body_lc<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">t</span> <span class="free">s</span> <span class="free">p</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"body <span class="free">t</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"lc <span class="free">s</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"lc <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"lc <span class="main">(</span><span class="free">t</span><span class="hidden">⇗</span><sup>[<span class="free">s</span><span class="main">,</span> <span class="free">p</span>]</sup><span class="hidden">⇖</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>FV <span class="free">t</span> <span class="main">∪</span> FV <span class="free">p</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> exFresh_s_p_cof<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">sa</span></span> <span class="skolem"><span class="skolem">pa</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="skolem">sa</span> <span class="main">∉</span> FV <span class="free">t</span> <span class="main">∪</span> FV <span class="free">p</span> <span class="main">∧</span> <span class="skolem">pa</span> <span class="main">∉</span> FV <span class="free">t</span> <span class="main">∪</span> FV <span class="free">p</span> <span class="main">∧</span> <span class="skolem">sa</span> <span class="main">≠</span> <span class="skolem">pa</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">sa</span> <span class="main">∉</span> FV <span class="free">t</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">pa</span> <span class="main">∉</span> FV <span class="free">t</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">sa</span> <span class="main">≠</span> <span class="skolem">pa</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">sa</span> <span class="main">∉</span> FV <span class="free">p</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">from</span></span> body_lc_FV<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹body <span class="free">t</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> lc<span class="main">:</span> <span class="quoted"><span class="quoted">"lc <span class="main">(</span><span class="free">t</span><span class="hidden">⇗</span><sup>[Fvar <span class="skolem">sa</span><span class="main">,</span>Fvar <span class="skolem">pa</span>]</sup><span class="hidden">⇖</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">assumption</span>

  <span class="keyword1"><span class="command">from</span></span>
    ssubst_intro<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">sa</span> <span class="main">∉</span> FV <span class="free">t</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">pa</span> <span class="main">∉</span> FV <span class="free">t</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">sa</span> <span class="main">≠</span> <span class="skolem">pa</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">sa</span> <span class="main">∉</span> FV <span class="free">p</span>›</span></span><span class="main">]</span> 
    ssubst_preserves_lc<span class="main">[</span><span class="operator">OF</span> lc<span class="main">]</span> <span class="quoted"><span class="quoted">‹lc <span class="free">s</span>›</span></span> <span class="quoted"><span class="quoted">‹lc <span class="free">p</span>›</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"lc <span class="main">(</span><span class="free">t</span><span class="hidden">⇗</span><sup>[<span class="free">s</span><span class="main">,</span><span class="free">p</span>]</sup><span class="hidden">⇖</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> openz_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Sigma-lc_body"><span class="command">lemma</span></span> lc_body<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">t</span> <span class="free">s</span> <span class="free">p</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"lc <span class="free">t</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">≠</span> <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"body <span class="main">(</span><span class="keyword1">σ[</span><span class="free">s</span><span class="main">,</span><span class="free">p</span><span class="main">]</span> <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> body_def
<span class="keyword1"><span class="command">proof</span></span> 
  <span class="keyword1"><span class="command">have</span></span> 
    <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">sa</span> <span class="bound">pa</span><span class="main">.</span> <span class="bound">sa</span> <span class="main">∉</span> FV <span class="free">t</span> <span class="main">∪</span> <span class="main">{</span><span class="free">s</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="free">p</span><span class="main">}</span> <span class="main">∧</span> <span class="bound">pa</span> <span class="main">∉</span> FV <span class="free">t</span> <span class="main">∪</span> <span class="main">{</span><span class="free">s</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="free">p</span><span class="main">}</span> <span class="main">∧</span> <span class="bound">sa</span> <span class="main">≠</span> <span class="bound">pa</span>
      <span class="main">⟶</span> lc <span class="main">(</span><span class="keyword1">σ[</span><span class="free">s</span><span class="main">,</span><span class="free">p</span><span class="main">]</span> <span class="free">t</span><span class="hidden">⇗</span><sup>[Fvar <span class="bound">sa</span><span class="main">,</span>Fvar <span class="bound">pa</span>]</sup><span class="hidden">⇖</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> strip<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">sa</span> <span class="main">::</span> <span class="quoted">fVariable</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">pa</span> <span class="main">::</span> <span class="quoted">fVariable</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">sa</span> <span class="main">∉</span> FV <span class="free">t</span> <span class="main">∪</span> <span class="main">{</span><span class="free">s</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="free">p</span><span class="main">}</span> <span class="main">∧</span> <span class="skolem">pa</span> <span class="main">∉</span> FV <span class="free">t</span> <span class="main">∪</span> <span class="main">{</span><span class="free">s</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="free">p</span><span class="main">}</span> <span class="main">∧</span> <span class="skolem">sa</span> <span class="main">≠</span> <span class="skolem">pa</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">∉</span> FV <span class="main">(</span>Fvar <span class="skolem">pa</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> 
      sopen_sclose_eq_ssubst<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">s</span> <span class="main">≠</span> <span class="free">p</span>›</span></span> this <span class="quoted"><span class="quoted">‹lc <span class="free">t</span>›</span></span><span class="main">]</span> 
      ssubst_preserves_lc<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹lc <span class="free">t</span>›</span></span><span class="main">]</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"lc <span class="main">(</span><span class="keyword1">σ[</span><span class="free">s</span><span class="main">,</span><span class="free">p</span><span class="main">]</span> <span class="free">t</span><span class="hidden">⇗</span><sup>[Fvar <span class="skolem">sa</span><span class="main">,</span>Fvar <span class="skolem">pa</span>]</sup><span class="hidden">⇖</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> openz_def closez_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">thus</span></span> 
    <span class="quoted"><span class="quoted">"finite <span class="main">(</span>FV <span class="free">t</span> <span class="main">∪</span> <span class="main">{</span><span class="free">s</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="free">p</span><span class="main">}</span><span class="main">)</span> 
     <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">sa</span> <span class="bound">pa</span><span class="main">.</span> <span class="bound">sa</span> <span class="main">∉</span> FV <span class="free">t</span> <span class="main">∪</span> <span class="main">{</span><span class="free">s</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="free">p</span><span class="main">}</span> <span class="main">∧</span> <span class="bound">pa</span> <span class="main">∉</span> FV <span class="free">t</span> <span class="main">∪</span> <span class="main">{</span><span class="free">s</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="free">p</span><span class="main">}</span> <span class="main">∧</span> <span class="bound">sa</span> <span class="main">≠</span> <span class="bound">pa</span>
         <span class="main">⟶</span> lc <span class="main">(</span><span class="keyword1">σ[</span><span class="free">s</span><span class="main">,</span><span class="free">p</span><span class="main">]</span> <span class="free">t</span><span class="hidden">⇗</span><sup>[Fvar <span class="bound">sa</span><span class="main">,</span>Fvar <span class="bound">pa</span>]</sup><span class="hidden">⇖</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Sigma-ssubst_preserves_lcE_lem"><span class="command">lemma</span></span> ssubst_preserves_lcE_lem<span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">t</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"lc <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span> <span class="bound">u</span> <span class="bound">t'</span><span class="main">.</span> <span class="free">t</span> <span class="main">=</span> <span class="main">[</span><span class="bound">x</span> <span class="main">→</span> <span class="bound">u</span><span class="main">]</span> <span class="bound">t'</span> <span class="main">⟶</span> lc <span class="bound">u</span> <span class="main">⟶</span> lc <span class="bound">t'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> 
  <span class="main">(</span><span class="operator">induct</span>
    <span class="quasi_keyword">taking</span><span class="main"><span class="main">:</span></span> 
    <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="main">∀</span><span class="bound">x</span> <span class="bound">u</span> <span class="bound">t'</span><span class="main">.</span> <span class="bound">t</span> <span class="main">=</span> <span class="main">[</span><span class="bound">x</span> <span class="main">→</span> <span class="bound">u</span><span class="main">]</span> <span class="bound">t'</span> <span class="main">⟶</span> lc <span class="bound">u</span> <span class="main">⟶</span> body <span class="bound">t'</span>"</span></span> 
    <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> lc_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Fvar <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> strip<span class="main"><span class="keyword3">,</span></span> <span class="operator">case_tac</span> <span class="quoted"><span class="improper">t'</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> Call <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> strip<span class="main"><span class="keyword3">,</span></span> <span class="operator">case_tac</span> <span class="quoted"><span class="improper">t'</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Upd <span class="skolem">t</span> <span class="skolem">l</span> <span class="skolem">u</span><span class="main">)</span> <span class="keyword1"><span class="command">note</span></span> pred_t <span class="main">=</span> this<span class="main">(</span>2<span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span> pred_u <span class="main">=</span> this<span class="main">(</span>3<span class="main">)</span> 
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> strip<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">v</span> <span class="skolem">t''</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"Upd <span class="skolem">t</span> <span class="skolem">l</span> <span class="skolem">u</span> <span class="main">=</span> <span class="main">[</span><span class="skolem">x</span> <span class="main">→</span> <span class="skolem">v</span><span class="main">]</span> <span class="skolem">t''</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"lc <span class="skolem">v</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> this<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> t''<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound">t'</span> <span class="bound">u'</span><span class="main">.</span> <span class="skolem">t''</span> <span class="main">=</span> Upd <span class="bound">t'</span> <span class="skolem">l</span> <span class="bound">u'</span><span class="main">)</span> <span class="main">∨</span> <span class="main">(</span><span class="skolem">t''</span> <span class="main">=</span> Fvar <span class="skolem">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">t''</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">y</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"Upd <span class="skolem">t</span> <span class="skolem">l</span> <span class="skolem">u</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">y</span> <span class="keyword1">then</span> <span class="skolem">v</span> <span class="keyword1">else</span> Fvar <span class="skolem">y</span><span class="main">)</span>"</span></span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">=</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">=</span> <span class="skolem">x</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"lc <span class="skolem">t''</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">t''</span> <span class="main">=</span> Fvar <span class="skolem">x</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹Upd <span class="skolem">t</span> <span class="skolem">l</span> <span class="skolem">u</span> <span class="main">=</span> <span class="main">[</span><span class="skolem">x</span> <span class="main">→</span> <span class="skolem">v</span><span class="main">]</span> <span class="skolem">t''</span>›</span></span> t'' 
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">clarify</span><span class="main">)</span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">t'</span> <span class="skolem">u'</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"Upd <span class="skolem">t</span> <span class="skolem">l</span> <span class="skolem">u</span> <span class="main">=</span> <span class="main">[</span><span class="skolem">x</span> <span class="main">→</span> <span class="skolem">v</span><span class="main">]</span> Upd <span class="skolem">t'</span> <span class="skolem">l</span> <span class="skolem">u'</span>"</span></span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">=</span> <span class="main">[</span><span class="skolem">x</span> <span class="main">→</span> <span class="skolem">v</span><span class="main">]</span> <span class="skolem">t'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">=</span> <span class="main">[</span><span class="skolem">x</span> <span class="main">→</span> <span class="skolem">v</span><span class="main">]</span> <span class="skolem">u'</span>"</span></span> 
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹lc <span class="skolem">v</span>›</span></span> pred_t pred_u lc_upd<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">t'</span></span> <span class="quoted"><span class="skolem">l</span></span> <span class="quoted"><span class="skolem">u'</span></span><span class="main">]</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"lc <span class="main">(</span>Upd <span class="skolem">t'</span> <span class="skolem">l</span> <span class="skolem">u'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Obj <span class="skolem">f</span> <span class="skolem">T</span><span class="main">)</span> <span class="keyword1"><span class="command">note</span></span> pred <span class="main">=</span> this
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> strip<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">v</span> <span class="skolem">t'</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"Obj <span class="skolem">f</span> <span class="skolem">T</span> <span class="main">=</span> <span class="main">[</span><span class="skolem">x</span> <span class="main">→</span> <span class="skolem">v</span><span class="main">]</span> <span class="skolem">t'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"lc <span class="skolem">v</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> this<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> t'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound">f'</span><span class="main">.</span> <span class="skolem">t'</span> <span class="main">=</span> Obj <span class="bound">f'</span> <span class="skolem">T</span><span class="main">)</span> <span class="main">∨</span> <span class="main">(</span><span class="skolem">t'</span> <span class="main">=</span> Fvar <span class="skolem">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">t'</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">y</span> <span class="main">::</span> <span class="quoted">fVariable</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"Obj <span class="skolem">f</span> <span class="skolem">T</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">y</span> <span class="keyword1">then</span> <span class="skolem">v</span> <span class="keyword1">else</span> Fvar <span class="skolem">y</span><span class="main">)</span>"</span></span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">=</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">=</span> <span class="skolem">x</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"lc <span class="skolem">t'</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">t'</span> <span class="main">=</span> Fvar <span class="skolem">x</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹Obj <span class="skolem">f</span> <span class="skolem">T</span> <span class="main">=</span> <span class="main">[</span><span class="skolem">x</span> <span class="main">→</span> <span class="skolem">v</span><span class="main">]</span> <span class="skolem">t'</span>›</span></span> t'
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">clarify</span><span class="main">)</span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">f'</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"Obj <span class="skolem">f</span> <span class="skolem">T</span> <span class="main">=</span> <span class="main">[</span><span class="skolem">x</span> <span class="main">→</span> <span class="skolem">v</span><span class="main">]</span> Obj <span class="skolem">f'</span> <span class="skolem">T</span>"</span></span>
        <span class="keyword1"><span class="command">hence</span></span>
          ssubst<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">l</span><span class="main">∈</span>dom <span class="skolem">f</span><span class="main">.</span> the<span class="main">(</span><span class="skolem">f</span> <span class="bound">l</span><span class="main">)</span> <span class="main">=</span> <span class="main">[</span><span class="skolem">x</span> <span class="main">→</span> <span class="skolem">v</span><span class="main">]</span> the<span class="main">(</span><span class="skolem">f'</span> <span class="bound">l</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
          <span class="quoted"><span class="quoted">"dom <span class="skolem">f</span> <span class="main">=</span> dom <span class="skolem">f'</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">with</span></span> pred <span class="quoted"><span class="quoted">‹lc <span class="skolem">v</span>›</span></span> lc_obj<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">f'</span></span> <span class="quoted"><span class="skolem">T</span></span><span class="main">]</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"lc <span class="main">(</span>Obj <span class="skolem">f'</span> <span class="skolem">T</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Bnd <span class="skolem">L</span> <span class="skolem">t</span><span class="main">)</span> <span class="keyword1"><span class="command">note</span></span> pred <span class="main">=</span> this<span class="main">(</span>2<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> strip<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">v</span> <span class="skolem">t'</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">=</span> <span class="main">[</span><span class="skolem">x</span> <span class="main">→</span> <span class="skolem">v</span><span class="main">]</span> <span class="skolem">t'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"lc <span class="skolem">v</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹finite <span class="skolem">L</span>›</span></span> exFresh_s_p_cof<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">L</span> <span class="main">∪</span> <span class="main">{</span><span class="skolem">x</span><span class="main">}</span> <span class="main">∪</span> FV <span class="skolem">t'</span>"</span></span><span class="main">]</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
      <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∉</span> <span class="skolem">L</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∉</span> <span class="skolem">L</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">≠</span> <span class="skolem">p</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> FV <span class="main">(</span>Fvar <span class="skolem">s</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> FV <span class="main">(</span>Fvar <span class="skolem">p</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∉</span> FV <span class="skolem">t'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∉</span> FV <span class="skolem">t'</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> 
      <span class="quoted"><span class="quoted">‹<span class="skolem">t</span> <span class="main">=</span> <span class="main">[</span><span class="skolem">x</span> <span class="main">→</span> <span class="skolem">v</span><span class="main">]</span> <span class="skolem">t'</span>›</span></span>
      ssubst_sopen_commute<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹lc <span class="skolem">v</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∉</span> FV <span class="main">(</span>Fvar <span class="skolem">s</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∉</span> FV <span class="main">(</span>Fvar <span class="skolem">p</span><span class="main">)</span>›</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">t</span><span class="hidden">⇗</span><sup>[Fvar <span class="skolem">s</span><span class="main">,</span> Fvar <span class="skolem">p</span>]</sup><span class="hidden">⇖</span><span class="main">)</span> <span class="main">=</span> <span class="main">[</span><span class="skolem">x</span> <span class="main">→</span> <span class="skolem">v</span><span class="main">]</span> <span class="main">(</span><span class="skolem">t'</span><span class="hidden">⇗</span><sup>[Fvar <span class="skolem">s</span><span class="main">,</span> Fvar <span class="skolem">p</span>]</sup><span class="hidden">⇖</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> openz_def<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> 
      <span class="quoted"><span class="quoted">‹<span class="skolem">s</span> <span class="main">∉</span> <span class="skolem">L</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="main">∉</span> <span class="skolem">L</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">s</span> <span class="main">≠</span> <span class="skolem">p</span>›</span></span> <span class="quoted"><span class="quoted">‹lc <span class="skolem">v</span>›</span></span> pred
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"lc <span class="main">(</span><span class="skolem">t'</span><span class="hidden">⇗</span><sup>[Fvar <span class="skolem">s</span><span class="main">,</span> Fvar <span class="skolem">p</span>]</sup><span class="hidden">⇖</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">from</span></span> 
      lc_body<span class="main">[</span><span class="operator">OF</span> this <span class="quoted"><span class="quoted">‹<span class="skolem">s</span> <span class="main">≠</span> <span class="skolem">p</span>›</span></span><span class="main">]</span>
      sclose_sopen_eq_t<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">s</span> <span class="main">∉</span> FV <span class="skolem">t'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="main">∉</span> FV <span class="skolem">t'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">s</span> <span class="main">≠</span> <span class="skolem">p</span>›</span></span><span class="main">]</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"body <span class="skolem">t'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> openz_def closez_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Sigma-ssubst_preserves_lcE"><span class="command">lemma</span></span> ssubst_preserves_lcE<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> lc <span class="main">(</span><span class="main">[</span><span class="free">x</span> <span class="main">→</span> <span class="free">t'</span><span class="main">]</span> <span class="free">t</span><span class="main">)</span><span class="main">;</span> lc <span class="free">t'</span> <span class="main">⟧</span> <span class="main">⟹</span> lc <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">drule_tac</span> t <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">x</span> <span class="main">→</span> <span class="free">t'</span><span class="main">]</span> <span class="free">t</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="free">x</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> u <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="free">t'</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> t' <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="free">t</span></span> 
    <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> ssubst_preserves_lcE_lem<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>

<span class="keyword1" id="Sigma-obj_openz_lc"><span class="command">lemma</span></span> obj_openz_lc<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> lc <span class="main">(</span>Obj <span class="free">f</span> <span class="free">T</span><span class="main">)</span><span class="main">;</span> lc <span class="free">p</span><span class="main">;</span> <span class="free">l</span> <span class="main">∈</span> dom <span class="free">f</span> <span class="main">⟧</span> <span class="main">⟹</span> lc <span class="main">(</span>the<span class="main">(</span><span class="free">f</span> <span class="free">l</span><span class="main">)</span><span class="hidden">⇗</span><sup>[Obj <span class="free">f</span> <span class="free">T</span><span class="main">,</span> <span class="free">p</span>]</sup><span class="hidden">⇖</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> s <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"Obj <span class="free">f</span> <span class="free">T</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> p <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="free">p</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> body_lc<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lc_obj<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>

<span class="keyword1" id="Sigma-obj_insert_lc"><span class="command">lemma</span></span> obj_insert_lc<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="free">T</span> <span class="free">t</span> <span class="free">l</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"lc <span class="main">(</span>Obj <span class="free">f</span> <span class="free">T</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"body <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"lc <span class="main">(</span>Obj <span class="main">(</span><span class="free">f</span><span class="main">(</span><span class="free">l</span> <span class="main">↦</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span> <span class="free">T</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ssubst<span class="main"><span class="main">[</span></span><span class="operator">OF</span> lc_obj<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> ballI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">l'</span> <span class="main">::</span> <span class="quoted">Label</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l'</span> <span class="main">∈</span> dom <span class="main">(</span><span class="free">f</span><span class="main">(</span><span class="free">l</span> <span class="main">↦</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"body <span class="main">(</span>the <span class="main">(</span><span class="main">(</span><span class="free">f</span><span class="main">(</span><span class="free">l</span> <span class="main">↦</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span> <span class="skolem">l'</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">l'</span> <span class="main">=</span> <span class="free">l</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> lc_obj<span class="main">)</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Sigma-ssubst_preserves_body"><span class="command">lemma</span></span> ssubst_preserves_body<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">t</span> <span class="free">t'</span> <span class="free">x</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"body <span class="free">t</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"lc <span class="free">t'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"body <span class="main">(</span><span class="main">[</span><span class="free">x</span> <span class="main">→</span> <span class="free">t'</span><span class="main">]</span> <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> body_def
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> 
    <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">s</span> <span class="bound">p</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∉</span> FV <span class="free">t'</span> <span class="main">∪</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">∧</span> <span class="bound">p</span> <span class="main">∉</span> FV <span class="free">t'</span> <span class="main">∪</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">∧</span> <span class="bound">s</span> <span class="main">≠</span> <span class="bound">p</span>
      <span class="main">⟶</span> lc <span class="main">(</span><span class="main">[</span><span class="free">x</span> <span class="main">→</span> <span class="free">t'</span><span class="main">]</span> <span class="free">t</span><span class="hidden">⇗</span><sup>[Fvar <span class="bound">s</span><span class="main">,</span>Fvar <span class="bound">p</span>]</sup><span class="hidden">⇖</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> strip<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span> <span class="main">::</span> <span class="quoted">fVariable</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">p</span> <span class="main">::</span> <span class="quoted">fVariable</span>
    <span class="keyword1"><span class="command">from</span></span> body_lc_FV<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹body <span class="free">t</span>›</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"lc <span class="main">(</span><span class="main">{</span><span class="main">0</span> <span class="main">→</span> <span class="main">[</span>Fvar <span class="skolem">s</span><span class="main">,</span>Fvar <span class="skolem">p</span><span class="main">]}</span> <span class="free">t</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> openz_def<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> ssubst_preserves_lc<span class="main">[</span><span class="operator">OF</span> this <span class="quoted"><span class="quoted">‹lc <span class="free">t'</span>›</span></span><span class="main">]</span> 
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"lc <span class="main">(</span><span class="main">[</span><span class="free">x</span> <span class="main">→</span> <span class="free">t'</span><span class="main">]</span> <span class="main">(</span><span class="free">t</span><span class="hidden">⇗</span><sup>[Fvar <span class="skolem">s</span><span class="main">,</span>Fvar <span class="skolem">p</span>]</sup><span class="hidden">⇖</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> openz_def<span class="main">)</span>

    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∉</span> FV <span class="free">t'</span> <span class="main">∪</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">∧</span> <span class="skolem">p</span> <span class="main">∉</span> FV <span class="free">t'</span> <span class="main">∪</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">∧</span> <span class="skolem">s</span> <span class="main">≠</span> <span class="skolem">p</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> FV <span class="main">(</span>Fvar <span class="skolem">s</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> FV <span class="main">(</span>Fvar <span class="skolem">p</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">note</span></span> ssubst_sopen_commute<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹lc <span class="free">t'</span>›</span></span> this<span class="main">]</span>
    <span class="keyword1"><span class="command">ultimately</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"lc <span class="main">(</span><span class="main">[</span><span class="free">x</span> <span class="main">→</span> <span class="free">t'</span><span class="main">]</span> <span class="free">t</span><span class="hidden">⇗</span><sup>[Fvar <span class="skolem">s</span><span class="main">,</span>Fvar <span class="skolem">p</span>]</sup><span class="hidden">⇖</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> openz_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">thus</span></span> 
    <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">L</span><span class="main">.</span> finite <span class="bound">L</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">s</span> <span class="bound">p</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∉</span> <span class="bound">L</span> <span class="main">∧</span> <span class="bound">p</span> <span class="main">∉</span> <span class="bound">L</span> <span class="main">∧</span> <span class="bound">s</span> <span class="main">≠</span> <span class="bound">p</span> 
                      <span class="main">⟶</span> lc <span class="main">(</span><span class="main">[</span><span class="free">x</span> <span class="main">→</span> <span class="free">t'</span><span class="main">]</span> <span class="free">t</span><span class="hidden">⇗</span><sup>[Fvar <span class="bound">s</span><span class="main">,</span>Fvar <span class="bound">p</span>]</sup><span class="hidden">⇖</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"FV <span class="free">t'</span> <span class="main">∪</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Sigma-sopen_preserves_body"><span class="command">lemma</span></span> sopen_preserves_body<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">t</span> <span class="free">s</span> <span class="free">p</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"body <span class="free">t</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"lc <span class="free">s</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"lc <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"body <span class="main">(</span><span class="main">{</span><span class="free">n</span> <span class="main">→</span> <span class="main">[</span><span class="free">s</span><span class="main">,</span><span class="free">p</span><span class="main">]}</span> <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> body_def
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> 
    <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">sa</span> <span class="bound">pa</span><span class="main">.</span> <span class="bound">sa</span> <span class="main">∉</span> FV <span class="free">t</span> <span class="main">∪</span> FV <span class="free">s</span> <span class="main">∧</span> <span class="bound">pa</span> <span class="main">∉</span> FV <span class="free">p</span> <span class="main">∧</span> <span class="bound">sa</span> <span class="main">≠</span> <span class="bound">pa</span>
      <span class="main">⟶</span> lc <span class="main">(</span><span class="main">{</span><span class="free">n</span> <span class="main">→</span> <span class="main">[</span><span class="free">s</span><span class="main">,</span><span class="free">p</span><span class="main">]}</span> <span class="free">t</span><span class="hidden">⇗</span><sup>[Fvar <span class="bound">sa</span><span class="main">,</span>Fvar <span class="bound">pa</span>]</sup><span class="hidden">⇖</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> body_lc<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹body <span class="free">t</span>›</span></span> <span class="quoted"><span class="quoted">‹lc <span class="free">s</span>›</span></span> <span class="quoted"><span class="quoted">‹lc <span class="free">p</span>›</span></span><span class="main">]</span> sopen_twice<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹lc <span class="free">s</span>›</span></span> <span class="quoted"><span class="quoted">‹lc <span class="free">p</span>›</span></span><span class="main">]</span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> openz_def<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> strip<span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">sa</span> <span class="main">::</span> <span class="quoted">fVariable</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">pa</span> <span class="main">::</span> <span class="quoted">fVariable</span>
      <span class="keyword1"><span class="command">from</span></span> body_lc_FV<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹body <span class="free">t</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"lc <span class="main">(</span><span class="free">t</span><span class="hidden">⇗</span><sup>[Fvar <span class="skolem">sa</span><span class="main">,</span>Fvar <span class="skolem">pa</span>]</sup><span class="hidden">⇖</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">assumption</span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">from</span></span> sopen_commute_gen<span class="main">[</span><span class="operator">OF</span> _ _ <span class="quoted"><span class="quoted">‹lc <span class="free">s</span>›</span></span> <span class="quoted"><span class="quoted">‹lc <span class="free">p</span>›</span></span> not_sym<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">n</span> <span class="main">≠</span> <span class="main">0</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">n</span> <span class="main">→</span> <span class="main">[</span><span class="free">s</span><span class="main">,</span><span class="free">p</span><span class="main">]}</span> <span class="free">t</span><span class="hidden">⇗</span><sup>[Fvar <span class="skolem">sa</span><span class="main">,</span>Fvar <span class="skolem">pa</span>]</sup><span class="hidden">⇖</span> <span class="main">=</span> <span class="main">{</span><span class="free">n</span> <span class="main">→</span> <span class="main">[</span><span class="free">s</span><span class="main">,</span><span class="free">p</span><span class="main">]}</span> <span class="main">(</span><span class="free">t</span><span class="hidden">⇗</span><sup>[Fvar <span class="skolem">sa</span><span class="main">,</span>Fvar <span class="skolem">pa</span>]</sup><span class="hidden">⇖</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> openz_def<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"lc <span class="main">(</span><span class="main">{</span><span class="free">n</span> <span class="main">→</span> <span class="main">[</span><span class="free">s</span><span class="main">,</span><span class="free">p</span><span class="main">]}</span> <span class="free">t</span><span class="hidden">⇗</span><sup>[Fvar <span class="skolem">sa</span><span class="main">,</span>Fvar <span class="skolem">pa</span>]</sup><span class="hidden">⇖</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">L</span><span class="main">.</span> finite <span class="bound">L</span> 
          <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">sa</span> <span class="bound">pa</span><span class="main">.</span> <span class="bound">sa</span> <span class="main">∉</span> <span class="bound">L</span> <span class="main">∧</span> <span class="bound">pa</span> <span class="main">∉</span> <span class="bound">L</span> <span class="main">∧</span> <span class="bound">sa</span> <span class="main">≠</span> <span class="bound">pa</span> 
              <span class="main">⟶</span> lc <span class="main">(</span><span class="main">{</span><span class="free">n</span> <span class="main">→</span> <span class="main">[</span><span class="free">s</span><span class="main">,</span><span class="free">p</span><span class="main">]}</span> <span class="free">t</span><span class="hidden">⇗</span><sup>[Fvar <span class="bound">sa</span><span class="main">,</span>Fvar <span class="bound">pa</span>]</sup><span class="hidden">⇖</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"FV <span class="free">t</span> <span class="main">∪</span> FV <span class="free">s</span> <span class="main">∪</span> FV <span class="free">p</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Beta-reduction›</span></span>
<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">beta</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>sterm<span class="main">,</span> sterm<span class="main">]</span> <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">→<span class="hidden">⇩</span><sub>β</sub></span>"</span> 50<span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span>
  beta<span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span>      <span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">∈</span> dom <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">;</span> lc <span class="main">(</span>Obj <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main">)</span><span class="main">;</span> lc <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">⟧</span> <span class="main">⟹</span> Call <span class="main">(</span>Obj <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="keyword1"><span class="free">→<span class="hidden">⇩</span><sub>β</sub></span></span> <span class="main">(</span>the <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span><span class="hidden">⇗</span><sup>[<span class="main">(</span>Obj <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main">)</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span>]</sup><span class="hidden">⇖</span><span class="main">)</span>"</span></span>
<span class="main">|</span> beta_Upd<span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span>  <span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">∈</span> dom <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">;</span> lc <span class="main">(</span>Obj <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main">)</span><span class="main">;</span> body <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">⟧</span> <span class="main">⟹</span> Upd <span class="main">(</span>Obj <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1"><span class="free">→<span class="hidden">⇩</span><sub>β</sub></span></span> Obj <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">↦</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">T</span></span></span>"</span></span> 
<span class="main">|</span> beta_CallL<span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1"><span class="free">→<span class="hidden">⇩</span><sub>β</sub></span></span> <span class="free"><span class="bound"><span class="entity">t'</span></span></span><span class="main">;</span> lc <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="main">⟧</span> <span class="main">⟹</span> Call <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="keyword1"><span class="free">→<span class="hidden">⇩</span><sub>β</sub></span></span> Call <span class="free"><span class="bound"><span class="entity">t'</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span>"</span></span>
<span class="main">|</span> beta_CallR<span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1"><span class="free">→<span class="hidden">⇩</span><sub>β</sub></span></span> <span class="free"><span class="bound"><span class="entity">t'</span></span></span><span class="main">;</span> lc <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="main">⟧</span> <span class="main">⟹</span> Call <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1"><span class="free">→<span class="hidden">⇩</span><sub>β</sub></span></span> Call <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">t'</span></span></span>"</span></span>
<span class="main">|</span> beta_UpdL<span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span> <span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1"><span class="free">→<span class="hidden">⇩</span><sub>β</sub></span></span> <span class="free"><span class="bound"><span class="entity">t'</span></span></span><span class="main">;</span> body <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="main">⟧</span> <span class="main">⟹</span> Upd <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="keyword1"><span class="free">→<span class="hidden">⇩</span><sub>β</sub></span></span> Upd <span class="free"><span class="bound"><span class="entity">t'</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span>"</span></span>
<span class="main">|</span> beta_UpdR<span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span> <span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> finite <span class="free"><span class="bound"><span class="entity">L</span></span></span><span class="main">;</span> 
     <span class="main">∀</span><span class="bound">s</span> <span class="bound">p</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∉</span> <span class="free"><span class="bound"><span class="entity">L</span></span></span> <span class="main">∧</span> <span class="bound">p</span> <span class="main">∉</span> <span class="free"><span class="bound"><span class="entity">L</span></span></span> <span class="main">∧</span> <span class="bound">s</span> <span class="main">≠</span> <span class="bound">p</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">t''</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="hidden">⇗</span><sup>[Fvar <span class="bound">s</span><span class="main">,</span>Fvar <span class="bound">p</span>]</sup><span class="hidden">⇖</span> <span class="keyword1"><span class="free">→<span class="hidden">⇩</span><sub>β</sub></span></span> <span class="bound">t''</span><span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">t'</span></span></span><span class="main">=</span> <span class="keyword1">σ[</span><span class="bound">s</span><span class="main">,</span><span class="bound">p</span><span class="main">]</span><span class="bound">t''</span><span class="main">)</span><span class="main">;</span>
     lc <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="main">⟧</span> <span class="main">⟹</span> Upd <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1"><span class="free">→<span class="hidden">⇩</span><sub>β</sub></span></span> Upd <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">t'</span></span></span>"</span></span>
<span class="main">|</span> beta_Obj<span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span>  <span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">∈</span> dom <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">;</span> finite <span class="free"><span class="bound"><span class="entity">L</span></span></span><span class="main">;</span> 
     <span class="main">∀</span><span class="bound">s</span> <span class="bound">p</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∉</span> <span class="free"><span class="bound"><span class="entity">L</span></span></span> <span class="main">∧</span> <span class="bound">p</span> <span class="main">∉</span> <span class="free"><span class="bound"><span class="entity">L</span></span></span> <span class="main">∧</span> <span class="bound">s</span> <span class="main">≠</span> <span class="bound">p</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">t''</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="hidden">⇗</span><sup>[Fvar <span class="bound">s</span><span class="main">,</span>Fvar <span class="bound">p</span>]</sup><span class="hidden">⇖</span> <span class="keyword1"><span class="free">→<span class="hidden">⇩</span><sub>β</sub></span></span> <span class="bound">t''</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">t'</span></span></span><span class="main">=</span> <span class="keyword1">σ[</span><span class="bound">s</span><span class="main">,</span><span class="bound">p</span><span class="main">]</span><span class="bound">t''</span><span class="main">)</span><span class="main">;</span>
     <span class="main">∀</span><span class="bound">l</span><span class="main">∈</span>dom <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">.</span> body <span class="main">(</span>the <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">l</span><span class="main">)</span><span class="main">)</span> <span class="main">⟧</span> 
  <span class="main">⟹</span> Obj <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">↦</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="keyword1"><span class="free">→<span class="hidden">⇩</span><sub>β</sub></span></span> Obj <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">↦</span> <span class="free"><span class="bound"><span class="entity">t'</span></span></span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">T</span></span></span>"</span></span>

<span class="keyword1"><span class="command">inductive_cases</span></span> beta_cases <span class="main">[</span><span class="operator">elim</span><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span></span></span></span></span></span></span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"Call <span class="free">s</span> <span class="free">l</span> <span class="free">t</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>β</sub></span> <span class="free">u</span>"</span></span>
  <span class="quoted"><span class="quoted">"Upd <span class="free">s</span> <span class="free">l</span> <span class="free">t</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>β</sub></span> <span class="free">u</span>"</span></span>
  <span class="quoted"><span class="quoted">"Obj <span class="free">s</span> <span class="free">T</span>  <span class="keyword1">→<span class="hidden">⇩</span><sub>β</sub></span> <span class="free">t</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span>
  <span class="entity">beta_reds</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>sterm<span class="main">,</span> sterm<span class="main">]</span> <span class="main">=&gt;</span> bool"</span></span>  <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">-&gt;&gt;</span>"</span> 50<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main"><span class="free">-&gt;&gt;</span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">==</span> beta<span class="main">^**</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span>
  <span class="entity">beta_ascii</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>sterm<span class="main">,</span> sterm<span class="main">]</span> <span class="main">=&gt;</span> bool"</span></span>  <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">-&gt;</span>"</span> 50<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main"><span class="free">-&gt;</span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">==</span> beta <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span>"</span></span>

<span class="keyword1"><span class="command">notation</span></span> <span class="main">(</span>latex<span class="main">)</span>
  beta_reds <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">→<span class="hidden">⇩</span><sub>β</sub><span class="hidden">⇧</span><sup>*</sup></span>"</span> 50<span class="main">)</span>

<span class="keyword1" id="Sigma-beta_induct"><span class="command">lemma</span></span> beta_induct<span class="main">[</span><span class="operator">consumes</span> 1<span class="main">,</span> 
  <span class="operator">case_names</span> CallL CallR UpdL UpdR Upd Obj beta Bnd<span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> 
  <span class="free">t</span> <span class="main">::</span> <span class="quoted">sterm</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">t'</span> <span class="main">::</span> <span class="quoted">sterm</span> <span class="keyword2"><span class="keyword">and</span></span> 
  <span class="free">P1</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"sterm <span class="main">⇒</span> sterm <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">P2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"sterm <span class="main">⇒</span> sterm <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>β</sub></span> <span class="free">t'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">t</span> <span class="bound">t'</span> <span class="bound">u</span> <span class="bound">l</span><span class="main">.</span> <span class="main">⟦</span> <span class="bound">t</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>β</sub></span> <span class="bound">t'</span><span class="main">;</span> <span class="free">P1</span> <span class="bound">t</span> <span class="bound">t'</span><span class="main">;</span> lc <span class="bound">u</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P1</span> <span class="main">(</span>Call <span class="bound">t</span> <span class="bound">l</span> <span class="bound">u</span><span class="main">)</span> <span class="main">(</span>Call <span class="bound">t'</span> <span class="bound">l</span> <span class="bound">u</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">t</span> <span class="bound">t'</span> <span class="bound">u</span> <span class="bound">l</span><span class="main">.</span> <span class="main">⟦</span> <span class="bound">t</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>β</sub></span> <span class="bound">t'</span><span class="main">;</span> <span class="free">P1</span> <span class="bound">t</span> <span class="bound">t'</span><span class="main">;</span> lc <span class="bound">u</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P1</span> <span class="main">(</span>Call <span class="bound">u</span> <span class="bound">l</span> <span class="bound">t</span><span class="main">)</span> <span class="main">(</span>Call <span class="bound">u</span> <span class="bound">l</span> <span class="bound">t'</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">t</span> <span class="bound">t'</span> <span class="bound">u</span> <span class="bound">l</span><span class="main">.</span> <span class="main">⟦</span> <span class="bound">t</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>β</sub></span> <span class="bound">t'</span><span class="main">;</span> <span class="free">P1</span> <span class="bound">t</span> <span class="bound">t'</span><span class="main">;</span> body <span class="bound">u</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P1</span> <span class="main">(</span>Upd <span class="bound">t</span> <span class="bound">l</span> <span class="bound">u</span><span class="main">)</span> <span class="main">(</span>Upd <span class="bound">t'</span> <span class="bound">l</span> <span class="bound">u</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">t</span> <span class="bound">t'</span> <span class="bound">u</span> <span class="bound">l</span><span class="main">.</span> <span class="main">⟦</span> <span class="free">P2</span> <span class="bound">t</span> <span class="bound">t'</span><span class="main">;</span> lc <span class="bound">u</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P1</span> <span class="main">(</span>Upd <span class="bound">u</span> <span class="bound">l</span> <span class="bound">t</span><span class="main">)</span> <span class="main">(</span>Upd <span class="bound">u</span> <span class="bound">l</span> <span class="bound">t'</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">l</span> <span class="bound">f</span> <span class="bound">T</span> <span class="bound">t</span><span class="main">.</span> <span class="main">⟦</span> <span class="bound">l</span> <span class="main">∈</span> dom <span class="bound">f</span><span class="main">;</span> lc <span class="main">(</span>Obj <span class="bound">f</span> <span class="bound">T</span><span class="main">)</span><span class="main">;</span> body <span class="bound">t</span> <span class="main">⟧</span> 
      <span class="main">⟹</span> <span class="free">P1</span> <span class="main">(</span>Upd <span class="main">(</span>Obj <span class="bound">f</span> <span class="bound">T</span><span class="main">)</span> <span class="bound">l</span> <span class="bound">t</span><span class="main">)</span> <span class="main">(</span>Obj <span class="main">(</span><span class="bound">f</span><span class="main">(</span><span class="bound">l</span> <span class="main">↦</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="bound">T</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">l</span> <span class="bound">f</span> <span class="bound">t</span> <span class="bound">t'</span> <span class="bound">T</span><span class="main">.</span> <span class="main">⟦</span> <span class="bound">l</span> <span class="main">∈</span> dom <span class="bound">f</span><span class="main">;</span> <span class="free">P2</span> <span class="bound">t</span> <span class="bound">t'</span><span class="main">;</span> <span class="main">∀</span><span class="bound">l</span><span class="main">∈</span>dom <span class="bound">f</span><span class="main">.</span> body <span class="main">(</span>the <span class="main">(</span><span class="bound">f</span> <span class="bound">l</span><span class="main">)</span><span class="main">)</span> <span class="main">⟧</span>
      <span class="main">⟹</span> <span class="free">P1</span> <span class="main">(</span>Obj <span class="main">(</span><span class="bound">f</span><span class="main">(</span><span class="bound">l</span> <span class="main">↦</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="bound">T</span><span class="main">)</span> <span class="main">(</span>Obj <span class="main">(</span><span class="bound">f</span><span class="main">(</span><span class="bound">l</span> <span class="main">↦</span> <span class="bound">t'</span><span class="main">)</span><span class="main">)</span> <span class="bound">T</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">l</span> <span class="bound">f</span> <span class="bound">T</span> <span class="bound">a</span><span class="main">.</span> <span class="main">⟦</span> <span class="bound">l</span> <span class="main">∈</span> dom <span class="bound">f</span><span class="main">;</span> lc <span class="main">(</span>Obj <span class="bound">f</span> <span class="bound">T</span><span class="main">)</span><span class="main">;</span> lc <span class="bound">a</span> <span class="main">⟧</span> 
      <span class="main">⟹</span> <span class="free">P1</span> <span class="main">(</span>Call <span class="main">(</span>Obj <span class="bound">f</span> <span class="bound">T</span><span class="main">)</span> <span class="bound">l</span> <span class="bound">a</span><span class="main">)</span> <span class="main">(</span>the <span class="main">(</span><span class="bound">f</span> <span class="bound">l</span><span class="main">)</span><span class="hidden">⇗</span><sup>[Obj <span class="bound">f</span> <span class="bound">T</span><span class="main">,</span><span class="bound">a</span>]</sup><span class="hidden">⇖</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">L</span> <span class="bound">t</span> <span class="bound">t'</span><span class="main">.</span> 
      <span class="main">⟦</span> finite <span class="bound">L</span><span class="main">;</span> 
        <span class="main">∀</span><span class="bound">s</span> <span class="bound">p</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∉</span> <span class="bound">L</span> <span class="main">∧</span> <span class="bound">p</span> <span class="main">∉</span> <span class="bound">L</span> <span class="main">∧</span> <span class="bound">s</span> <span class="main">≠</span> <span class="bound">p</span> 
        <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">t''</span><span class="main">.</span> <span class="bound">t</span><span class="hidden">⇗</span><sup>[Fvar <span class="bound">s</span><span class="main">,</span>Fvar <span class="bound">p</span>]</sup><span class="hidden">⇖</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>β</sub></span> <span class="bound">t''</span> 
                 <span class="main">∧</span> <span class="free">P1</span> <span class="main">(</span><span class="bound">t</span><span class="hidden">⇗</span><sup>[Fvar <span class="bound">s</span><span class="main">,</span>Fvar <span class="bound">p</span>]</sup><span class="hidden">⇖</span><span class="main">)</span> <span class="bound">t''</span> <span class="main">∧</span> <span class="bound">t'</span> <span class="main">=</span> <span class="keyword1">σ[</span><span class="bound">s</span><span class="main">,</span><span class="bound">p</span><span class="main">]</span> <span class="bound">t''</span><span class="main">)</span> <span class="main">⟧</span>
      <span class="main">⟹</span> <span class="free">P2</span> <span class="bound">t</span> <span class="bound">t'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P1</span> <span class="free">t</span> <span class="free">t'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> beta.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="Sigma-Fvar_beta"><span class="command">lemma</span></span> Fvar_beta<span class="main">:</span> <span class="quoted"><span class="quoted">"Fvar <span class="free">x</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>β</sub></span> <span class="free">t</span> <span class="main">⟹</span> False"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule</span> beta.cases<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="Sigma-Obj_beta"><span class="command">lemma</span></span> Obj_beta<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"Obj <span class="free">f</span> <span class="free">T</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>β</sub></span> <span class="free">z</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">l</span> <span class="bound">f'</span> <span class="bound">t</span> <span class="bound">t'</span><span class="main">.</span> dom <span class="free">f</span> <span class="main">=</span> dom <span class="bound">f'</span> <span class="main">∧</span> <span class="free">f</span> <span class="main">=</span> <span class="main">(</span><span class="bound">f'</span><span class="main">(</span><span class="bound">l</span> <span class="main">↦</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">l</span> <span class="main">∈</span> dom <span class="bound">f'</span> 
             <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span><span class="bound">L</span><span class="main">.</span> finite <span class="bound">L</span> 
                  <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">s</span> <span class="bound">p</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∉</span> <span class="bound">L</span> <span class="main">∧</span> <span class="bound">p</span> <span class="main">∉</span> <span class="bound">L</span> <span class="main">∧</span> <span class="bound">s</span> <span class="main">≠</span> <span class="bound">p</span>
                      <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">t''</span><span class="main">.</span> <span class="bound">t</span><span class="hidden">⇗</span><sup>[Fvar <span class="bound">s</span><span class="main">,</span>Fvar <span class="bound">p</span>]</sup><span class="hidden">⇖</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>β</sub></span> <span class="bound">t''</span> <span class="main">∧</span> <span class="bound">t'</span><span class="main">=</span> <span class="keyword1">σ[</span><span class="bound">s</span><span class="main">,</span><span class="bound">p</span><span class="main">]</span><span class="bound">t''</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
             <span class="main">∧</span> <span class="free">z</span> <span class="main">=</span> Obj <span class="main">(</span><span class="bound">f'</span><span class="main">(</span><span class="bound">l</span> <span class="main">↦</span> <span class="bound">t'</span><span class="main">)</span><span class="main">)</span> <span class="free">T</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> beta_cases<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">l</span> <span class="skolem">fa</span> <span class="skolem">L</span> <span class="skolem">t</span> <span class="skolem">t'</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="skolem">l</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main"><span class="keyword3">,</span></span> 
        <span class="operator">rule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="skolem">fa</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main"><span class="keyword3">,</span></span>
        <span class="operator">rule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="skolem">t</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main"><span class="keyword3">,</span></span>
        <span class="operator">rule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="skolem">t'</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Sigma-Upd_beta"><span class="command">lemma</span></span> Upd_beta<span class="main">:</span> <span class="quoted"><span class="quoted">"Upd <span class="free">t</span> <span class="free">l</span> <span class="free">u</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>β</sub></span> <span class="free">z</span> <span class="main">⟹</span>
  <span class="main">(</span><span class="main">∃</span><span class="bound">t'</span><span class="main">.</span> <span class="free">t</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>β</sub></span> <span class="bound">t'</span> <span class="main">∧</span> <span class="free">z</span> <span class="main">=</span> Upd <span class="bound">t'</span> <span class="free">l</span> <span class="free">u</span><span class="main">)</span> 
  <span class="main">∨</span><span class="main">(</span><span class="main">∃</span><span class="bound">u'</span> <span class="bound">L</span><span class="main">.</span> finite <span class="bound">L</span> 
         <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">s</span> <span class="bound">p</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∉</span> <span class="bound">L</span> <span class="main">∧</span> <span class="bound">p</span> <span class="main">∉</span> <span class="bound">L</span> <span class="main">∧</span> <span class="bound">s</span> <span class="main">≠</span> <span class="bound">p</span> 
             <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">t''</span><span class="main">.</span> <span class="main">(</span><span class="free">u</span><span class="hidden">⇗</span><sup>[Fvar <span class="bound">s</span><span class="main">,</span> Fvar <span class="bound">p</span>]</sup><span class="hidden">⇖</span><span class="main">)</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>β</sub></span> <span class="bound">t''</span> <span class="main">∧</span> <span class="bound">u'</span> <span class="main">=</span> <span class="keyword1">σ[</span><span class="bound">s</span><span class="main">,</span><span class="bound">p</span><span class="main">]</span><span class="bound">t''</span><span class="main">)</span><span class="main">)</span> 
         <span class="main">∧</span> <span class="free">z</span> <span class="main">=</span> Upd <span class="free">t</span> <span class="free">l</span> <span class="bound">u'</span><span class="main">)</span>
  <span class="main">∨</span><span class="main">(</span><span class="main">∃</span><span class="bound">f</span> <span class="bound">T</span><span class="main">.</span> <span class="free">l</span> <span class="main">∈</span> dom <span class="bound">f</span> <span class="main">∧</span> Obj <span class="bound">f</span> <span class="bound">T</span> <span class="main">=</span> <span class="free">t</span> <span class="main">∧</span> <span class="free">z</span> <span class="main">=</span> Obj <span class="main">(</span><span class="bound">f</span><span class="main">(</span><span class="free">l</span> <span class="main">↦</span> <span class="free">u</span><span class="main">)</span><span class="main">)</span> <span class="bound">T</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule</span> beta_cases<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="Sigma-Call_beta"><span class="command">lemma</span></span> Call_beta<span class="main">:</span> <span class="quoted"><span class="quoted">"Call <span class="free">t</span> <span class="free">l</span> <span class="free">u</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>β</sub></span> <span class="free">z</span> <span class="main">⟹</span>
  <span class="main">(</span><span class="main">∃</span><span class="bound">t'</span><span class="main">.</span> <span class="free">t</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>β</sub></span> <span class="bound">t'</span> <span class="main">∧</span> <span class="free">z</span> <span class="main">=</span> Call <span class="bound">t'</span> <span class="free">l</span> <span class="free">u</span><span class="main">)</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound">u'</span><span class="main">.</span> <span class="free">u</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>β</sub></span> <span class="bound">u'</span> <span class="main">∧</span> <span class="free">z</span> <span class="main">=</span> Call <span class="free">t</span> <span class="free">l</span> <span class="bound">u'</span><span class="main">)</span>
  <span class="main">∨</span><span class="main">(</span><span class="main">∃</span><span class="bound">f</span> <span class="bound">T</span><span class="main">.</span> Obj <span class="bound">f</span> <span class="bound">T</span> <span class="main">=</span> <span class="free">t</span> <span class="main">∧</span> <span class="free">l</span> <span class="main">∈</span> dom <span class="bound">f</span> <span class="main">∧</span> <span class="free">z</span> <span class="main">=</span> <span class="main">(</span>the <span class="main">(</span><span class="bound">f</span> <span class="free">l</span><span class="main">)</span><span class="hidden">⇗</span><sup>[Obj <span class="bound">f</span> <span class="bound">T</span><span class="main">,</span> <span class="free">u</span>]</sup><span class="hidden">⇖</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule</span> beta_cases<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Properties›</span></span>
<span class="keyword1" id="Sigma-beta_lc"><span class="command">lemma</span></span> beta_lc<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">t</span> <span class="free">t'</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>β</sub></span> <span class="free">t'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"lc <span class="free">t</span> <span class="main">∧</span> lc <span class="free">t'</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> 
  <span class="main">(</span><span class="operator">induct</span>
    <span class="quasi_keyword">taking</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">t</span> <span class="bound">t'</span><span class="main">.</span> body <span class="bound">t</span> <span class="main">∧</span> body <span class="bound">t'</span>"</span></span>
    <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> beta_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> CallL <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> CallR <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> UpdR <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lc_upd<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> UpdL <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lc_upd<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> beta <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> obj_openz_lc<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> Upd <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lc_obj lc_upd<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> Obj <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lc_obj<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Bnd <span class="skolem">L</span> <span class="skolem">t</span> <span class="skolem">t'</span><span class="main">)</span> <span class="keyword1"><span class="command">note</span></span> cof <span class="main">=</span> this<span class="main">(</span>2<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹finite <span class="skolem">L</span>›</span></span> exFresh_s_p_cof<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">L</span> <span class="main">∪</span> FV <span class="skolem">t</span>"</span></span><span class="main">]</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
    <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∉</span> <span class="skolem">L</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∉</span> FV <span class="skolem">t</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∉</span> <span class="skolem">L</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∉</span> FV <span class="skolem">t</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">≠</span> <span class="skolem">p</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>  
  <span class="keyword1"><span class="command">with</span></span> cof <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t''</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"lc <span class="main">(</span><span class="skolem">t</span><span class="hidden">⇗</span><sup>[Fvar <span class="skolem">s</span><span class="main">,</span> Fvar <span class="skolem">p</span>]</sup><span class="hidden">⇖</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"lc <span class="skolem">t''</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="skolem">t'</span> <span class="main">=</span> <span class="keyword1">σ[</span><span class="skolem">s</span><span class="main">,</span><span class="skolem">p</span><span class="main">]</span> <span class="skolem">t''</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> 
    lc_body<span class="main">[</span><span class="operator">OF</span> this<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">s</span> <span class="main">≠</span> <span class="skolem">p</span>›</span></span><span class="main">]</span> 
    sclose_sopen_eq_t<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">s</span> <span class="main">∉</span> FV <span class="skolem">t</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="main">∉</span> FV <span class="skolem">t</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">s</span> <span class="main">≠</span> <span class="skolem">p</span>›</span></span><span class="main">]</span>
    this<span class="main">(</span>3<span class="main">)</span> lc_body<span class="main">[</span><span class="operator">OF</span> this<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">s</span> <span class="main">≠</span> <span class="skolem">p</span>›</span></span><span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> openz_def closez_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Sigma-beta_ssubst"><span class="command">lemma</span></span> beta_ssubst<span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">t</span> <span class="free">t'</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>β</sub></span> <span class="free">t'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span> <span class="bound">v</span><span class="main">.</span> lc <span class="bound">v</span> <span class="main">⟶</span> <span class="main">[</span><span class="bound">x</span> <span class="main">→</span> <span class="bound">v</span><span class="main">]</span> <span class="free">t</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>β</sub></span> <span class="main">[</span><span class="bound">x</span> <span class="main">→</span> <span class="bound">v</span><span class="main">]</span> <span class="free">t'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">pred_cof</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">pred_cof</span> <span class="skolem">L</span> <span class="skolem">t</span> <span class="skolem">t'</span> <span class="main">⟷</span>
      <span class="main">(</span><span class="main">∀</span><span class="bound">s</span> <span class="bound">p</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∉</span> <span class="skolem">L</span> <span class="main">∧</span> <span class="bound">p</span> <span class="main">∉</span> <span class="skolem">L</span> <span class="main">∧</span> <span class="bound">s</span> <span class="main">≠</span> <span class="bound">p</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">t''</span><span class="main">.</span> <span class="skolem">t</span><span class="hidden">⇗</span><sup>[Fvar <span class="bound">s</span><span class="main">,</span> Fvar <span class="bound">p</span>]</sup><span class="hidden">⇖</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>β</sub></span> <span class="bound">t''</span> <span class="main">∧</span> <span class="skolem">t'</span> <span class="main">=</span> <span class="keyword1">σ[</span><span class="bound">s</span><span class="main">,</span><span class="bound">p</span><span class="main">]</span> <span class="bound">t''</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">L</span> <span class="skolem">t</span> <span class="skolem">t'</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">v</span> <span class="skolem">t</span> <span class="skolem">t'</span>
    <span class="keyword3"><span class="command">assume</span></span> 
      <span class="quoted"><span class="quoted">"lc <span class="skolem">v</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span> <span class="bound">v</span><span class="main">.</span> lc <span class="bound">v</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">L</span><span class="main">.</span> finite <span class="bound">L</span> <span class="main">∧</span> <span class="skolem">pred_cof</span> <span class="bound">L</span> <span class="main">(</span><span class="main">[</span><span class="bound">x</span> <span class="main">→</span> <span class="bound">v</span><span class="main">]</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">(</span><span class="main">[</span><span class="bound">x</span> <span class="main">→</span> <span class="bound">v</span><span class="main">]</span> <span class="skolem">t'</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">L</span><span class="main">.</span> finite <span class="bound">L</span> <span class="main">∧</span> <span class="skolem">pred_cof</span> <span class="bound">L</span> <span class="main">(</span><span class="main">[</span><span class="skolem">x</span> <span class="main">→</span> <span class="skolem">v</span><span class="main">]</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">(</span><span class="main">[</span><span class="skolem">x</span> <span class="main">→</span> <span class="skolem">v</span><span class="main">]</span> <span class="skolem">t'</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">}</span></span><span class="keyword1"><span class="command">note</span></span> Lex <span class="main">=</span> this

  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">v</span> <span class="skolem">l</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"Label <span class="main">⇒</span> sterm option"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">∈</span> dom <span class="skolem">f</span>"</span></span> <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">∈</span> dom <span class="main">(</span><span class="main">λ</span><span class="bound">l</span><span class="main">.</span> ssubst_option <span class="skolem">x</span> <span class="skolem">v</span> <span class="main">(</span><span class="skolem">f</span> <span class="bound">l</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">}</span></span><span class="keyword1"><span class="command">note</span></span> domssubst <span class="main">=</span> this
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">v</span> <span class="skolem">l</span> <span class="skolem">T</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"Label <span class="main">⇒</span> sterm option"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"lc <span class="main">(</span>Obj <span class="skolem">f</span> <span class="skolem">T</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"lc <span class="skolem">v</span>"</span></span> <span class="keyword1"><span class="command">from</span></span> ssubst_preserves_lc<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> 
    <span class="keyword1"><span class="command">have</span></span> obj<span class="main">:</span> <span class="quoted"><span class="quoted">"lc <span class="main">(</span>Obj <span class="main">(</span><span class="main">λ</span><span class="bound">l</span><span class="main">.</span> ssubst_option <span class="skolem">x</span> <span class="skolem">v</span> <span class="main">(</span><span class="skolem">f</span> <span class="bound">l</span><span class="main">)</span><span class="main">)</span> <span class="skolem">T</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">}</span></span><span class="keyword1"><span class="command">note</span></span> lcobj <span class="main">=</span> this

  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> 
    <span class="main">(</span><span class="operator">induct</span>
      <span class="quasi_keyword">taking</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">t</span> <span class="bound">t'</span><span class="main">.</span> <span class="main">∀</span><span class="bound">x</span> <span class="bound">v</span><span class="main">.</span> lc <span class="bound">v</span> 
                       <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">L</span><span class="main">.</span> finite <span class="bound">L</span> 
                              <span class="main">∧</span> <span class="skolem">pred_cof</span> <span class="bound">L</span> <span class="main">(</span><span class="main">[</span><span class="bound">x</span> <span class="main">→</span> <span class="bound">v</span><span class="main">]</span> <span class="bound">t</span><span class="main">)</span> <span class="main">(</span><span class="main">[</span><span class="bound">x</span> <span class="main">→</span> <span class="bound">v</span><span class="main">]</span> <span class="bound">t'</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> beta_induct<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> CallL <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> CallR <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> UpdL <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>UpdR <span class="skolem">t</span> <span class="skolem">t'</span> <span class="skolem">u</span> <span class="skolem">l</span><span class="main">)</span> <span class="keyword1"><span class="command">note</span></span> pred <span class="main">=</span> this<span class="main">(</span>1<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> strip<span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">v</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"lc <span class="skolem">v</span>"</span></span>
      <span class="keyword1"><span class="command">from</span></span> Lex<span class="main">[</span><span class="operator">OF</span> this pred<span class="main">]</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">L</span></span> <span class="keyword2"><span class="keyword">where</span></span>
        <span class="quoted"><span class="quoted">"finite <span class="skolem">L</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">pred_cof</span> <span class="skolem">L</span> <span class="main">(</span><span class="main">[</span><span class="skolem">x</span> <span class="main">→</span> <span class="skolem">v</span><span class="main">]</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">(</span><span class="main">[</span><span class="skolem">x</span> <span class="main">→</span> <span class="skolem">v</span><span class="main">]</span> <span class="skolem">t'</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">with</span></span> ssubst_preserves_lc<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹lc <span class="skolem">u</span>›</span></span> <span class="quoted"><span class="quoted">‹lc <span class="skolem">v</span>›</span></span><span class="main">]</span> 
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">x</span> <span class="main">→</span> <span class="skolem">v</span><span class="main">]</span> Upd <span class="skolem">u</span> <span class="skolem">l</span> <span class="skolem">t</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>β</sub></span> <span class="main">[</span><span class="skolem">x</span> <span class="main">→</span> <span class="skolem">v</span><span class="main">]</span> Upd <span class="skolem">u</span> <span class="skolem">l</span> <span class="skolem">t'</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> pred_cof_def
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>beta <span class="skolem">l</span> <span class="skolem">f</span> <span class="skolem">T</span> <span class="skolem">t</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> strip<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">v</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"lc <span class="skolem">v</span>"</span></span>
      <span class="keyword1"><span class="command">from</span></span> ssubst_preserves_lc<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹lc <span class="skolem">t</span>›</span></span> this<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"lc <span class="main">(</span><span class="main">[</span><span class="skolem">x</span> <span class="main">→</span> <span class="skolem">v</span><span class="main">]</span> <span class="skolem">t</span><span class="main">)</span>"</span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">note</span></span> lem <span class="main">=</span>
        beta.beta<span class="main">[</span><span class="operator">OF</span> domssubst<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">l</span> <span class="main">∈</span> dom <span class="skolem">f</span>›</span></span><span class="main"><span class="main">]</span></span> 
        lcobj<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹lc <span class="main">(</span>Obj <span class="skolem">f</span> <span class="skolem">T</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹lc <span class="skolem">v</span>›</span></span><span class="main"><span class="main">]</span></span> this<span class="main">]</span>

      <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">l</span> <span class="main">∈</span> dom <span class="skolem">f</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"the <span class="main">(</span>ssubst_option <span class="skolem">x</span> <span class="skolem">v</span> <span class="main">(</span><span class="skolem">f</span> <span class="skolem">l</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">[</span><span class="skolem">x</span> <span class="main">→</span> <span class="skolem">v</span><span class="main">]</span> the <span class="main">(</span><span class="skolem">f</span> <span class="skolem">l</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">with</span></span> lem<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">x</span></span><span class="main">]</span> ssubst_openz_distrib<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹lc <span class="skolem">v</span>›</span></span><span class="main">]</span>
      <span class="keyword3"><span class="command">show</span></span>
        <span class="quoted"><span class="quoted">"Call <span class="main">(</span>Obj <span class="main">(</span><span class="main">λ</span><span class="bound">l</span><span class="main">.</span> ssubst_option <span class="skolem">x</span> <span class="skolem">v</span> <span class="main">(</span><span class="skolem">f</span> <span class="bound">l</span><span class="main">)</span><span class="main">)</span> <span class="skolem">T</span><span class="main">)</span> <span class="skolem">l</span> <span class="main">(</span><span class="main">[</span><span class="skolem">x</span> <span class="main">→</span> <span class="skolem">v</span><span class="main">]</span> <span class="skolem">t</span><span class="main">)</span>
         <span class="keyword1">→<span class="hidden">⇩</span><sub>β</sub></span> <span class="main">[</span><span class="skolem">x</span> <span class="main">→</span> <span class="skolem">v</span><span class="main">]</span> <span class="main">(</span>the <span class="main">(</span><span class="skolem">f</span> <span class="skolem">l</span><span class="main">)</span><span class="hidden">⇗</span><sup>[Obj <span class="skolem">f</span> <span class="skolem">T</span><span class="main">,</span> <span class="skolem">t</span>]</sup><span class="hidden">⇖</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Upd <span class="skolem">l</span> <span class="skolem">f</span> <span class="skolem">T</span> <span class="skolem">t</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> strip<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">v</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"lc <span class="skolem">v</span>"</span></span>
      <span class="keyword1"><span class="command">from</span></span> ssubst_preserves_body<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹body <span class="skolem">t</span>›</span></span> <span class="quoted"><span class="quoted">‹lc <span class="skolem">v</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"body <span class="main">(</span><span class="main">[</span><span class="skolem">x</span> <span class="main">→</span> <span class="skolem">v</span><span class="main">]</span> <span class="skolem">t</span><span class="main">)</span>"</span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">from</span></span>
        beta.beta_Upd<span class="main">[</span><span class="operator">OF</span> domssubst<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">l</span> <span class="main">∈</span> dom <span class="skolem">f</span>›</span></span><span class="main"><span class="main">]</span></span> 
                         lcobj<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹lc <span class="main">(</span>Obj <span class="skolem">f</span> <span class="skolem">T</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹lc <span class="skolem">v</span>›</span></span><span class="main"><span class="main">]</span></span> this<span class="main">]</span>
        ssubstoption_insert<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">l</span> <span class="main">∈</span> dom <span class="skolem">f</span>›</span></span><span class="main">]</span> 
      <span class="keyword3"><span class="command">show</span></span>
        <span class="quoted"><span class="quoted">"Upd <span class="main">(</span>Obj <span class="main">(</span><span class="main">λ</span><span class="bound">l</span><span class="main">.</span> ssubst_option <span class="skolem">x</span> <span class="skolem">v</span> <span class="main">(</span><span class="skolem">f</span> <span class="bound">l</span><span class="main">)</span><span class="main">)</span> <span class="skolem">T</span><span class="main">)</span> <span class="skolem">l</span> <span class="main">(</span><span class="main">[</span><span class="skolem">x</span> <span class="main">→</span> <span class="skolem">v</span><span class="main">]</span> <span class="skolem">t</span><span class="main">)</span>
         <span class="keyword1">→<span class="hidden">⇩</span><sub>β</sub></span> Obj <span class="main">(</span><span class="main">λ</span><span class="bound">la</span><span class="main">.</span> ssubst_option <span class="skolem">x</span> <span class="skolem">v</span> <span class="main">(</span><span class="keyword1">if</span> <span class="bound">la</span> <span class="main">=</span> <span class="skolem">l</span> <span class="keyword1">then</span> Some <span class="skolem">t</span> <span class="keyword1">else</span> <span class="skolem">f</span> <span class="bound">la</span><span class="main">)</span><span class="main">)</span> <span class="skolem">T</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Obj <span class="skolem">l</span> <span class="skolem">f</span> <span class="skolem">t</span> <span class="skolem">t'</span> <span class="skolem">T</span><span class="main">)</span> <span class="keyword1"><span class="command">note</span></span> pred <span class="main">=</span> this<span class="main">(</span>2<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> strip<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">v</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"lc <span class="skolem">v</span>"</span></span>
      <span class="keyword1"><span class="command">note</span></span> Lex<span class="main">[</span><span class="operator">OF</span> this pred<span class="main">]</span>
      <span class="keyword1"><span class="command">from</span></span> this<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">x</span></span><span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">L</span></span> <span class="keyword2"><span class="keyword">where</span></span>
        <span class="quoted"><span class="quoted">"finite <span class="skolem">L</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">pred_cof</span> <span class="skolem">L</span> <span class="main">(</span><span class="main">[</span><span class="skolem">x</span> <span class="main">→</span> <span class="skolem">v</span><span class="main">]</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">(</span><span class="main">[</span><span class="skolem">x</span> <span class="main">→</span> <span class="skolem">v</span><span class="main">]</span> <span class="skolem">t'</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">l</span><span class="main">∈</span>dom <span class="main">(</span><span class="main">λ</span><span class="bound">l</span><span class="main">.</span> ssubst_option <span class="skolem">x</span> <span class="skolem">v</span> <span class="main">(</span><span class="skolem">f</span> <span class="bound">l</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> body <span class="main">(</span>the <span class="main">(</span>ssubst_option <span class="skolem">x</span> <span class="skolem">v</span> <span class="main">(</span><span class="skolem">f</span> <span class="bound">l</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> strip<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">l'</span> <span class="main">::</span> <span class="quoted">Label</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l'</span> <span class="main">∈</span> dom <span class="skolem">f</span>"</span></span>
        <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span><span class="bound">l</span><span class="main">∈</span>dom <span class="skolem">f</span><span class="main">.</span> body <span class="main">(</span>the<span class="main">(</span><span class="skolem">f</span> <span class="bound">l</span><span class="main">)</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"body <span class="main">(</span>the <span class="main">(</span><span class="skolem">f</span> <span class="skolem">l'</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">note</span></span> ssubst_preserves_body<span class="main">[</span><span class="operator">OF</span> this <span class="quoted"><span class="quoted">‹lc <span class="skolem">v</span>›</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">l'</span> <span class="main">∈</span> dom <span class="skolem">f</span>›</span></span> ssubst_option_lem
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"body <span class="main">(</span>the <span class="main">(</span>ssubst_option <span class="skolem">x</span> <span class="skolem">v</span> <span class="main">(</span><span class="skolem">f</span> <span class="skolem">l'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">from</span></span>
        beta.beta_Obj<span class="main">[</span><span class="operator">OF</span> domssubst<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">l</span> <span class="main">∈</span> dom <span class="skolem">f</span>›</span></span><span class="main"><span class="main">]</span></span> <span class="quoted"><span class="quoted">‹finite <span class="skolem">L</span>›</span></span> _ this<span class="main">]</span> 
        ssubstoption_insert<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">l</span> <span class="main">∈</span> dom <span class="skolem">f</span>›</span></span><span class="main">]</span> <span class="quoted"><span class="quoted">‹<span class="skolem">pred_cof</span> <span class="skolem">L</span> <span class="main">(</span><span class="main">[</span><span class="skolem">x</span> <span class="main">→</span> <span class="skolem">v</span><span class="main">]</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">(</span><span class="main">[</span><span class="skolem">x</span> <span class="main">→</span> <span class="skolem">v</span><span class="main">]</span> <span class="skolem">t'</span><span class="main">)</span>›</span></span>
      <span class="keyword3"><span class="command">show</span></span> 
        <span class="quoted"><span class="quoted">"Obj <span class="main">(</span><span class="main">λ</span><span class="bound">la</span><span class="main">.</span> ssubst_option <span class="skolem">x</span> <span class="skolem">v</span> <span class="main">(</span><span class="keyword1">if</span> <span class="bound">la</span> <span class="main">=</span> <span class="skolem">l</span> <span class="keyword1">then</span> Some <span class="skolem">t</span> <span class="keyword1">else</span> <span class="skolem">f</span> <span class="bound">la</span><span class="main">)</span><span class="main">)</span> <span class="skolem">T</span>
         <span class="keyword1">→<span class="hidden">⇩</span><sub>β</sub></span> Obj <span class="main">(</span><span class="main">λ</span><span class="bound">la</span><span class="main">.</span> ssubst_option <span class="skolem">x</span> <span class="skolem">v</span> <span class="main">(</span><span class="keyword1">if</span> <span class="bound">la</span> <span class="main">=</span> <span class="skolem">l</span> <span class="keyword1">then</span> Some <span class="skolem">t'</span> <span class="keyword1">else</span> <span class="skolem">f</span> <span class="bound">la</span><span class="main">)</span><span class="main">)</span> <span class="skolem">T</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> pred_cof_def
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Bnd <span class="skolem">L</span> <span class="skolem">t</span> <span class="skolem">t'</span><span class="main">)</span> <span class="keyword1"><span class="command">note</span></span> pred <span class="main">=</span> this<span class="main">(</span>2<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> strip<span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">v</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"lc <span class="skolem">v</span>"</span></span>
      <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹finite <span class="skolem">L</span>›</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">L</span><span class="main">.</span> finite <span class="bound">L</span> <span class="main">∧</span> <span class="skolem">pred_cof</span> <span class="bound">L</span> <span class="main">(</span><span class="main">[</span><span class="skolem">x</span> <span class="main">→</span> <span class="skolem">v</span><span class="main">]</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">(</span><span class="main">[</span><span class="skolem">x</span> <span class="main">→</span> <span class="skolem">v</span><span class="main">]</span> <span class="skolem">t'</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">L</span> <span class="main">∪</span> <span class="main">{</span><span class="skolem">x</span><span class="main">}</span> <span class="main">∪</span> FV <span class="skolem">v</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main"><span class="keyword3">,</span></span> 
          <span class="operator">unfold</span> pred_cof_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span> <span class="skolem">p</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∉</span> <span class="skolem">L</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∉</span> <span class="skolem">L</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">≠</span> <span class="skolem">p</span>"</span></span>
        <span class="keyword1"><span class="command">with</span></span> pred <span class="quoted"><span class="quoted">‹lc <span class="skolem">v</span>›</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t''</span></span> <span class="keyword2"><span class="keyword">where</span></span>
          <span class="quoted"><span class="quoted">"<span class="skolem">t</span><span class="hidden">⇗</span><sup>[Fvar <span class="skolem">s</span><span class="main">,</span>Fvar <span class="skolem">p</span>]</sup><span class="hidden">⇖</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>β</sub></span> <span class="skolem">t''</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
          ssubst_beta<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">x</span> <span class="main">→</span> <span class="skolem">v</span><span class="main">]</span> <span class="main">(</span><span class="skolem">t</span><span class="hidden">⇗</span><sup>[Fvar <span class="skolem">s</span><span class="main">,</span>Fvar <span class="skolem">p</span>]</sup><span class="hidden">⇖</span><span class="main">)</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>β</sub></span> <span class="main">[</span><span class="skolem">x</span> <span class="main">→</span> <span class="skolem">v</span><span class="main">]</span> <span class="skolem">t''</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
          <span class="quoted"><span class="quoted">"<span class="skolem">t'</span> <span class="main">=</span> <span class="keyword1">σ[</span><span class="skolem">s</span><span class="main">,</span><span class="skolem">p</span><span class="main">]</span> <span class="skolem">t''</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">≠</span> <span class="skolem">x</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">≠</span> <span class="skolem">x</span>"</span></span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> FV <span class="main">(</span>Fvar <span class="skolem">s</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> FV <span class="main">(</span>Fvar <span class="skolem">p</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">from</span></span> ssubst_sopen_commute<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹lc <span class="skolem">v</span>›</span></span> this<span class="main">]</span> ssubst_beta
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">x</span> <span class="main">→</span> <span class="skolem">v</span><span class="main">]</span> <span class="skolem">t</span><span class="hidden">⇗</span><sup>[Fvar <span class="skolem">s</span><span class="main">,</span>Fvar <span class="skolem">p</span>]</sup><span class="hidden">⇖</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>β</sub></span> <span class="main">[</span><span class="skolem">x</span> <span class="main">→</span> <span class="skolem">v</span><span class="main">]</span> <span class="skolem">t''</span>"</span></span> 
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> openz_def<span class="main">)</span>
        <span class="keyword1"><span class="command">moreover</span></span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∉</span> FV <span class="skolem">v</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∉</span> FV <span class="skolem">v</span>"</span></span>
        <span class="keyword1"><span class="command">from</span></span> 
          ssubst_sclose_commute<span class="main">[</span><span class="operator">OF</span> this not_sym<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">s</span> <span class="main">≠</span> <span class="skolem">x</span>›</span></span><span class="main"><span class="main">]</span></span> 
                                        not_sym<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="main">≠</span> <span class="skolem">x</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span> 
          <span class="quoted"><span class="quoted">‹<span class="skolem">t'</span> <span class="main">=</span> <span class="keyword1">σ[</span><span class="skolem">s</span><span class="main">,</span><span class="skolem">p</span><span class="main">]</span> <span class="skolem">t''</span>›</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">x</span> <span class="main">→</span> <span class="skolem">v</span><span class="main">]</span> <span class="skolem">t'</span> <span class="main">=</span> <span class="keyword1">σ[</span><span class="skolem">s</span><span class="main">,</span><span class="skolem">p</span><span class="main">]</span> <span class="main">[</span><span class="skolem">x</span> <span class="main">→</span> <span class="skolem">v</span><span class="main">]</span> <span class="skolem">t''</span>"</span></span> 
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> closez_def<span class="main">)</span>
        <span class="keyword1"><span class="command">ultimately</span></span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">t''</span><span class="main">.</span> <span class="main">[</span><span class="skolem">x</span> <span class="main">→</span> <span class="skolem">v</span><span class="main">]</span> <span class="skolem">t</span><span class="hidden">⇗</span><sup>[Fvar <span class="skolem">s</span><span class="main">,</span>Fvar <span class="skolem">p</span>]</sup><span class="hidden">⇖</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>β</sub></span> <span class="bound">t''</span> <span class="main">∧</span> <span class="main">[</span><span class="skolem">x</span> <span class="main">→</span> <span class="skolem">v</span><span class="main">]</span> <span class="skolem">t'</span> <span class="main">=</span> <span class="keyword1">σ[</span><span class="skolem">s</span><span class="main">,</span><span class="skolem">p</span><span class="main">]</span> <span class="bound">t''</span>"</span></span> 
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">x</span> <span class="main">→</span> <span class="skolem">v</span><span class="main">]</span> <span class="skolem">t''</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">declare</span></span> if_not_P <span class="main">[</span><span class="operator">simp</span><span class="main">]</span> not_less_eq <span class="main">[</span><span class="operator">simp</span><span class="main">]</span>
  <span class="comment1">― ‹don't add <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">text</span> <span class="raw_text">"r_into_rtrancl[intro!]"</span><span class="antiquote">}</span></span>›</span>

<span class="keyword1" id="Sigma-beta_preserves_FV"><span class="command">lemma</span></span> beta_preserves_FV<span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">t</span> <span class="free">t'</span> <span class="free">x</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>β</sub></span> <span class="free">t'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> FV <span class="free">t</span> <span class="main">⟶</span> <span class="free">x</span> <span class="main">∉</span> FV <span class="free">t'</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> 
  <span class="main">(</span><span class="operator">induct</span>
    <span class="quasi_keyword">taking</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">t</span> <span class="bound">t'</span><span class="main">.</span> <span class="free">x</span> <span class="main">∉</span> FV <span class="bound">t</span> <span class="main">⟶</span> <span class="free">x</span> <span class="main">∉</span> FV <span class="bound">t'</span>"</span></span>
    <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> beta_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> CallL <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> CallR <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> UpdL <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> UpdR <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> Upd <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> Obj <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>beta <span class="skolem">l</span> <span class="skolem">f</span> <span class="skolem">T</span> <span class="skolem">t</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> strip<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> FV <span class="main">(</span>Call <span class="main">(</span>Obj <span class="skolem">f</span> <span class="skolem">T</span><span class="main">)</span> <span class="skolem">l</span> <span class="skolem">t</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">l</span> <span class="main">∈</span> dom <span class="skolem">f</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> FV <span class="main">(</span>the <span class="main">(</span><span class="skolem">f</span> <span class="skolem">l</span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span> FV <span class="main">(</span>Obj <span class="skolem">f</span> <span class="skolem">T</span><span class="main">)</span> <span class="main">∪</span> FV <span class="skolem">t</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">y</span> <span class="main">::</span> <span class="quoted">sterm</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> FV <span class="skolem">y</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="skolem">l</span> <span class="main">=</span> Some <span class="skolem">y</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> FVoption <span class="main">(</span><span class="skolem">f</span> <span class="skolem">l</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">l</span><span class="main">∈</span>dom <span class="skolem">f</span><span class="main">.</span> <span class="free">x</span> <span class="main">∉</span> FVoption <span class="main">(</span><span class="skolem">f</span> <span class="bound">l</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">l</span> <span class="main">∈</span> dom <span class="skolem">f</span>›</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">from</span></span> contra_subsetD<span class="main">[</span><span class="operator">OF</span> sopen_FV this<span class="main">]</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> FV <span class="main">(</span>the <span class="main">(</span><span class="skolem">f</span> <span class="skolem">l</span><span class="main">)</span><span class="hidden">⇗</span><sup>[Obj <span class="skolem">f</span> <span class="skolem">T</span><span class="main">,</span><span class="skolem">t</span>]</sup><span class="hidden">⇖</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> openz_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Bnd <span class="skolem">L</span> <span class="skolem">t</span> <span class="skolem">t'</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> strip<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> FV <span class="skolem">t</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹finite <span class="skolem">L</span>›</span></span> exFresh_s_p_cof<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">L</span> <span class="main">∪</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span>"</span></span><span class="main">]</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="keyword2"><span class="keyword">where</span></span> sp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∉</span> <span class="skolem">L</span> <span class="main">∪</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">∧</span> <span class="skolem">p</span> <span class="main">∉</span> <span class="skolem">L</span> <span class="main">∪</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">∧</span> <span class="skolem">s</span> <span class="main">≠</span> <span class="skolem">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="free">x</span> <span class="main">∉</span> FV <span class="skolem">t</span>›</span></span> sopen_FV<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="main">0</span></span> <span class="quoted"><span class="quoted">"Fvar <span class="skolem">s</span>"</span></span> <span class="quoted"><span class="quoted">"Fvar <span class="skolem">p</span>"</span></span> <span class="quoted"><span class="skolem">t</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> FV <span class="main">(</span><span class="skolem">t</span><span class="hidden">⇗</span><sup>[Fvar <span class="skolem">s</span><span class="main">,</span> Fvar <span class="skolem">p</span>]</sup><span class="hidden">⇖</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> openz_def<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> sp Bnd<span class="main">(</span>2<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t''</span></span> <span class="keyword2"><span class="keyword">where</span></span>
      <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> FV <span class="skolem">t''</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t'</span> <span class="main">=</span> <span class="keyword1">σ[</span><span class="skolem">s</span><span class="main">,</span><span class="skolem">p</span><span class="main">]</span> <span class="skolem">t''</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> sclose_subset_FV<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="main">0</span></span> <span class="quoted"><span class="skolem">s</span></span> <span class="quoted"><span class="skolem">p</span></span> <span class="quoted"><span class="skolem">t''</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> FV <span class="skolem">t'</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> closez_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Sigma-rtrancl_beta_lc"><span class="command">lemma</span></span> rtrancl_beta_lc<span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>β</sub><span class="hidden">⇧</span><sup>*</sup></span> <span class="free">t'</span> <span class="main">⟹</span> <span class="free">t</span> <span class="main">≠</span> <span class="free">t'</span> <span class="main">⟶</span> lc <span class="free">t</span> <span class="main">∧</span> lc <span class="free">t'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule</span> rtranclp.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> 
      <span class="operator">drule</span> beta_lc<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>

<span class="keyword1" id="Sigma-rtrancl_beta_lc2"><span class="command">lemma</span></span> rtrancl_beta_lc2<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">t</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>β</sub><span class="hidden">⇧</span><sup>*</sup></span> <span class="free">t'</span><span class="main">;</span> lc <span class="free">t</span> <span class="main">⟧</span> <span class="main">⟹</span> lc <span class="free">t'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">=</span> <span class="free">t'</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>

<span class="keyword1" id="Sigma-rtrancl_beta_body"><span class="command">lemma</span></span> rtrancl_beta_body<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">L</span> <span class="free">t</span> <span class="free">t'</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> 
  <span class="quoted"><span class="quoted">"finite <span class="free">L</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">s</span> <span class="bound">p</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∉</span> <span class="free">L</span> <span class="main">∧</span> <span class="bound">p</span> <span class="main">∉</span> <span class="free">L</span> <span class="main">∧</span> <span class="bound">s</span> <span class="main">≠</span> <span class="bound">p</span> 
    <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">t''</span><span class="main">.</span> <span class="free">t</span><span class="hidden">⇗</span><sup>[Fvar <span class="bound">s</span><span class="main">,</span>Fvar <span class="bound">p</span>]</sup><span class="hidden">⇖</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>β</sub><span class="hidden">⇧</span><sup>*</sup></span> <span class="bound">t''</span> <span class="main">∧</span> <span class="free">t'</span> <span class="main">=</span> <span class="keyword1">σ[</span><span class="bound">s</span><span class="main">,</span><span class="bound">p</span><span class="main">]</span> <span class="bound">t''</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  <span class="quoted"><span class="quoted">"body <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"body <span class="free">t'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">=</span> <span class="free">t'</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True <span class="keyword1"><span class="command">with</span></span> assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword1"><span class="command">from</span></span> exFresh_s_p_cof<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹finite <span class="free">L</span>›</span></span><span class="main">]</span> 
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="keyword2"><span class="keyword">where</span></span> sp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∉</span> <span class="free">L</span> <span class="main">∧</span> <span class="skolem">p</span> <span class="main">∉</span> <span class="free">L</span> <span class="main">∧</span> <span class="skolem">s</span> <span class="main">≠</span> <span class="skolem">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">≠</span> <span class="skolem">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>2<span class="main">)</span> sp
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t''</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span><span class="hidden">⇗</span><sup>[Fvar <span class="skolem">s</span><span class="main">,</span>Fvar <span class="skolem">p</span>]</sup><span class="hidden">⇖</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>β</sub><span class="hidden">⇧</span><sup>*</sup></span> <span class="skolem">t''</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">t'</span> <span class="main">=</span> <span class="keyword1">σ[</span><span class="skolem">s</span><span class="main">,</span><span class="skolem">p</span><span class="main">]</span> <span class="skolem">t''</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹body <span class="free">t</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"lc <span class="skolem">t''</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">t</span><span class="hidden">⇗</span><sup>[Fvar <span class="skolem">s</span><span class="main">,</span>Fvar <span class="skolem">p</span>]</sup><span class="hidden">⇖</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">t''</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True <span class="keyword1"><span class="command">with</span></span> body_lc<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹body <span class="free">t</span>›</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"lc <span class="skolem">t''</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False <span class="keyword1"><span class="command">with</span></span> rtrancl_beta_lc<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">t</span><span class="hidden">⇗</span><sup>[Fvar <span class="skolem">s</span><span class="main">,</span>Fvar <span class="skolem">p</span>]</sup><span class="hidden">⇖</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>β</sub><span class="hidden">⇧</span><sup>*</sup></span> <span class="skolem">t''</span>›</span></span><span class="main">]</span> 
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"lc <span class="skolem">t''</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">from</span></span> lc_body<span class="main">[</span><span class="operator">OF</span> this <span class="quoted"><span class="quoted">‹<span class="skolem">s</span> <span class="main">≠</span> <span class="skolem">p</span>›</span></span><span class="main">]</span> <span class="quoted"><span class="quoted">‹<span class="free">t'</span> <span class="main">=</span> <span class="keyword1">σ[</span><span class="skolem">s</span><span class="main">,</span><span class="skolem">p</span><span class="main">]</span> <span class="skolem">t''</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"body <span class="free">t'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Sigma-rtrancl_beta_preserves_FV"><span class="command">lemma</span></span> rtrancl_beta_preserves_FV<span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>β</sub><span class="hidden">⇧</span><sup>*</sup></span> <span class="free">t'</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">∉</span> FV <span class="free">t</span> <span class="main">⟶</span> <span class="free">x</span> <span class="main">∉</span> FV <span class="free">t'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">t</span></span> <span class="quoted"><span class="free">t'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rtranclp.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>rtrancl_into_rtrancl <span class="skolem">a</span> <span class="skolem">b</span> <span class="skolem">c</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">clarify</span><span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> FV <span class="skolem">b</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> FV <span class="skolem">c</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> beta_preserves_FV<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">b</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>β</sub></span> <span class="skolem">c</span>›</span></span> this<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> this<span class="main">(</span>2<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Congruence rules›</span></span>
<span class="keyword1" id="Sigma-rtrancl_beta_CallL"><span class="command">lemma</span></span> rtrancl_beta_CallL <span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">t</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>β</sub><span class="hidden">⇧</span><sup>*</sup></span> <span class="free">t'</span><span class="main">;</span> lc <span class="free">u</span> <span class="main">⟧</span> <span class="main">⟹</span> Call <span class="free">t</span> <span class="free">l</span> <span class="free">u</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>β</sub><span class="hidden">⇧</span><sup>*</sup></span> Call <span class="free">t'</span> <span class="free">l</span> <span class="free">u</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">t</span></span> <span class="quoted"><span class="free">t'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rtranclp.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>rtrancl_into_rtrancl <span class="skolem">a</span> <span class="skolem">b</span> <span class="skolem">c</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">b</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>β</sub></span> <span class="skolem">c</span>›</span></span> <span class="quoted"><span class="quoted">‹lc <span class="free">u</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Call <span class="skolem">b</span> <span class="free">l</span> <span class="free">u</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>β</sub></span> Call <span class="skolem">c</span> <span class="free">l</span> <span class="free">u</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">with</span></span> rtrancl_into_rtrancl<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹lc <span class="free">u</span>›</span></span><span class="main">]</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Call <span class="skolem">a</span> <span class="free">l</span> <span class="free">u</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>β</sub><span class="hidden">⇧</span><sup>*</sup></span> Call <span class="skolem">c</span> <span class="free">l</span> <span class="free">u</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Sigma-rtrancl_beta_CallR"><span class="command">lemma</span></span> rtrancl_beta_CallR <span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">t</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>β</sub><span class="hidden">⇧</span><sup>*</sup></span> <span class="free">t'</span><span class="main">;</span> lc <span class="free">u</span> <span class="main">⟧</span> <span class="main">⟹</span> Call <span class="free">u</span> <span class="free">l</span> <span class="free">t</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>β</sub><span class="hidden">⇧</span><sup>*</sup></span> Call <span class="free">u</span> <span class="free">l</span> <span class="free">t'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">t</span></span> <span class="quoted"><span class="free">t'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rtranclp.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>rtrancl_into_rtrancl <span class="skolem">a</span> <span class="skolem">b</span> <span class="skolem">c</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">b</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>β</sub></span> <span class="skolem">c</span>›</span></span> <span class="quoted"><span class="quoted">‹lc <span class="free">u</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Call <span class="free">u</span> <span class="free">l</span> <span class="skolem">b</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>β</sub></span> Call <span class="free">u</span> <span class="free">l</span> <span class="skolem">c</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">with</span></span> rtrancl_into_rtrancl<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹lc <span class="free">u</span>›</span></span><span class="main">]</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Call <span class="free">u</span> <span class="free">l</span> <span class="skolem">a</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>β</sub><span class="hidden">⇧</span><sup>*</sup></span> Call <span class="free">u</span> <span class="free">l</span> <span class="skolem">c</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Sigma-rtrancl_beta_Call"><span class="command">lemma</span></span> rtrancl_beta_Call <span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">t</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>β</sub><span class="hidden">⇧</span><sup>*</sup></span> <span class="free">t'</span><span class="main">;</span> lc <span class="free">t</span><span class="main">;</span> <span class="free">u</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>β</sub><span class="hidden">⇧</span><sup>*</sup></span> <span class="free">u'</span><span class="main">;</span> lc <span class="free">u</span> <span class="main">⟧</span> 
  <span class="main">⟹</span> Call <span class="free">t</span> <span class="free">l</span> <span class="free">u</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>β</sub><span class="hidden">⇧</span><sup>*</sup></span> Call <span class="free">t'</span> <span class="free">l</span> <span class="free">u'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">t</span></span> <span class="quoted"><span class="free">t'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rtranclp.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>rtrancl_into_rtrancl <span class="skolem">a</span> <span class="skolem">b</span> <span class="skolem">c</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="free">u</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>β</sub><span class="hidden">⇧</span><sup>*</sup></span> <span class="free">u'</span>›</span></span> <span class="quoted"><span class="quoted">‹lc <span class="free">u</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"lc <span class="free">u'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">b</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>β</sub></span> <span class="skolem">c</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Call <span class="skolem">b</span> <span class="free">l</span> <span class="free">u'</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>β</sub></span> Call <span class="skolem">c</span> <span class="free">l</span> <span class="free">u'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">with</span></span> rtrancl_into_rtrancl<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹lc <span class="skolem">a</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">u</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>β</sub><span class="hidden">⇧</span><sup>*</sup></span> <span class="free">u'</span>›</span></span> <span class="quoted"><span class="quoted">‹lc <span class="free">u</span>›</span></span><span class="main">]</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Call <span class="skolem">a</span> <span class="free">l</span> <span class="free">u</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>β</sub><span class="hidden">⇧</span><sup>*</sup></span> Call <span class="skolem">c</span> <span class="free">l</span> <span class="free">u'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Sigma-rtrancl_beta_UpdL"><span class="command">lemma</span></span> rtrancl_beta_UpdL<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">t</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>β</sub><span class="hidden">⇧</span><sup>*</sup></span> <span class="free">t'</span><span class="main">;</span> body <span class="free">u</span> <span class="main">⟧</span> <span class="main">⟹</span> Upd <span class="free">t</span> <span class="free">l</span> <span class="free">u</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>β</sub><span class="hidden">⇧</span><sup>*</sup></span> Upd <span class="free">t'</span> <span class="free">l</span> <span class="free">u</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">t</span></span> <span class="quoted"><span class="free">t'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rtranclp.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>rtrancl_into_rtrancl <span class="skolem">a</span> <span class="skolem">b</span> <span class="skolem">c</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">b</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>β</sub></span> <span class="skolem">c</span>›</span></span> <span class="quoted"><span class="quoted">‹body <span class="free">u</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Upd <span class="skolem">b</span> <span class="free">l</span> <span class="free">u</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>β</sub></span> Upd <span class="skolem">c</span> <span class="free">l</span> <span class="free">u</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">with</span></span> rtrancl_into_rtrancl<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹body <span class="free">u</span>›</span></span><span class="main">]</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Upd <span class="skolem">a</span> <span class="free">l</span> <span class="free">u</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>β</sub><span class="hidden">⇧</span><sup>*</sup></span> Upd <span class="skolem">c</span> <span class="free">l</span> <span class="free">u</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Sigma-beta_binder"><span class="command">lemma</span></span> beta_binder<span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">t</span> <span class="free">t'</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>β</sub></span> <span class="free">t'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> 
  <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">L</span> <span class="bound">s</span> <span class="bound">p</span><span class="main">.</span> finite <span class="bound">L</span> <span class="main">⟶</span> <span class="bound">s</span> <span class="main">∉</span> <span class="bound">L</span> <span class="main">⟶</span> <span class="bound">p</span> <span class="main">∉</span> <span class="bound">L</span> <span class="main">⟶</span> <span class="bound">s</span> <span class="main">≠</span> <span class="bound">p</span> 
    <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">L'</span><span class="main">.</span> finite <span class="bound">L'</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">sa</span> <span class="bound">pa</span><span class="main">.</span> <span class="bound">sa</span> <span class="main">∉</span> <span class="bound">L'</span> <span class="main">∧</span> <span class="bound">pa</span> <span class="main">∉</span> <span class="bound">L'</span> <span class="main">∧</span> <span class="bound">sa</span> <span class="main">≠</span> <span class="bound">pa</span>
                            <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">t''</span><span class="main">.</span> <span class="main">(</span><span class="keyword1">σ[</span><span class="bound">s</span><span class="main">,</span><span class="bound">p</span><span class="main">]</span> <span class="free">t</span><span class="main">)</span><span class="hidden">⇗</span><sup>[Fvar <span class="bound">sa</span><span class="main">,</span>Fvar <span class="bound">pa</span>]</sup><span class="hidden">⇖</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>β</sub></span> <span class="bound">t''</span> 
                                     <span class="main">∧</span> <span class="keyword1">σ[</span><span class="bound">s</span><span class="main">,</span><span class="bound">p</span><span class="main">]</span> <span class="free">t'</span> <span class="main">=</span> <span class="keyword1">σ[</span><span class="bound">sa</span><span class="main">,</span><span class="bound">pa</span><span class="main">]</span> <span class="bound">t''</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> strip<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">L</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"fVariable set"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">s</span> <span class="main">::</span> <span class="quoted">fVariable</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">p</span> <span class="main">::</span> <span class="quoted">fVariable</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">≠</span> <span class="skolem">p</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> 
    <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">sa</span> <span class="bound">pa</span><span class="main">.</span> <span class="bound">sa</span> <span class="main">∉</span> <span class="skolem">L</span> <span class="main">∪</span> FV <span class="free">t</span> <span class="main">∪</span> <span class="main">{</span><span class="skolem">s</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="skolem">p</span><span class="main">}</span> <span class="main">∧</span> <span class="bound">pa</span> <span class="main">∉</span> <span class="skolem">L</span> <span class="main">∪</span> FV <span class="free">t</span> <span class="main">∪</span> <span class="main">{</span><span class="skolem">s</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="skolem">p</span><span class="main">}</span> <span class="main">∧</span> <span class="bound">sa</span> <span class="main">≠</span> <span class="bound">pa</span>
      <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">t''</span><span class="main">.</span> <span class="main">(</span><span class="keyword1">σ[</span><span class="skolem">s</span><span class="main">,</span><span class="skolem">p</span><span class="main">]</span> <span class="free">t</span><span class="main">)</span><span class="hidden">⇗</span><sup>[Fvar <span class="bound">sa</span><span class="main">,</span>Fvar <span class="bound">pa</span>]</sup><span class="hidden">⇖</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>β</sub></span> <span class="bound">t''</span> <span class="main">∧</span> <span class="keyword1">σ[</span><span class="skolem">s</span><span class="main">,</span><span class="skolem">p</span><span class="main">]</span> <span class="free">t'</span> <span class="main">=</span> <span class="keyword1">σ[</span><span class="bound">sa</span><span class="main">,</span><span class="bound">pa</span><span class="main">]</span> <span class="bound">t''</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> strip<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">sa</span> <span class="main">::</span> <span class="quoted">fVariable</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">pa</span> <span class="main">::</span> <span class="quoted">fVariable</span>
    <span class="keyword1"><span class="command">from</span></span> beta_ssubst<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">t</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>β</sub></span> <span class="free">t'</span>›</span></span><span class="main">]</span> 
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">p</span> <span class="main">→</span> Fvar <span class="skolem">pa</span><span class="main">]</span> <span class="free">t</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>β</sub></span> <span class="main">[</span><span class="skolem">p</span> <span class="main">→</span> Fvar <span class="skolem">pa</span><span class="main">]</span> <span class="free">t'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">from</span></span> beta_ssubst<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> 
    <span class="keyword1"><span class="command">have</span></span> 
      betasubst<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">s</span> <span class="main">→</span> Fvar <span class="skolem">sa</span><span class="main">]</span> <span class="main">[</span><span class="skolem">p</span> <span class="main">→</span> Fvar <span class="skolem">pa</span><span class="main">]</span> <span class="free">t</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>β</sub></span> <span class="main">[</span><span class="skolem">s</span> <span class="main">→</span> Fvar <span class="skolem">sa</span><span class="main">]</span> <span class="main">[</span><span class="skolem">p</span> <span class="main">→</span> Fvar <span class="skolem">pa</span><span class="main">]</span> <span class="free">t'</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

    <span class="keyword1"><span class="command">from</span></span> beta_lc<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">t</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>β</sub></span> <span class="free">t'</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"lc <span class="free">t</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"lc <span class="free">t'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword3"><span class="command">assume</span></span> 
      sapa<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">sa</span> <span class="main">∉</span> <span class="skolem">L</span> <span class="main">∪</span> FV <span class="free">t</span> <span class="main">∪</span> <span class="main">{</span><span class="skolem">s</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="skolem">p</span><span class="main">}</span> <span class="main">∧</span> <span class="skolem">pa</span> <span class="main">∉</span> <span class="skolem">L</span> <span class="main">∪</span> FV <span class="free">t</span> <span class="main">∪</span> <span class="main">{</span><span class="skolem">s</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="skolem">p</span><span class="main">}</span> <span class="main">∧</span> <span class="skolem">sa</span> <span class="main">≠</span> <span class="skolem">pa</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∉</span> FV <span class="main">(</span>Fvar <span class="skolem">pa</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> 
      sopen_sclose_eq_ssubst<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">s</span> <span class="main">≠</span> <span class="skolem">p</span>›</span></span> this <span class="quoted"><span class="quoted">‹lc <span class="free">t</span>›</span></span><span class="main">]</span> 
      sopen_sclose_eq_ssubst<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">s</span> <span class="main">≠</span> <span class="skolem">p</span>›</span></span> this <span class="quoted"><span class="quoted">‹lc <span class="free">t'</span>›</span></span><span class="main">]</span>
      betasubst
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">σ[</span><span class="skolem">s</span><span class="main">,</span><span class="skolem">p</span><span class="main">]</span> <span class="free">t</span><span class="hidden">⇗</span><sup>[Fvar <span class="skolem">sa</span><span class="main">,</span> Fvar <span class="skolem">pa</span>]</sup><span class="hidden">⇖</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>β</sub></span> <span class="main">(</span><span class="keyword1">σ[</span><span class="skolem">s</span><span class="main">,</span><span class="skolem">p</span><span class="main">]</span> <span class="free">t'</span><span class="hidden">⇗</span><sup>[Fvar <span class="skolem">sa</span><span class="main">,</span> Fvar <span class="skolem">pa</span>]</sup><span class="hidden">⇖</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> openz_def closez_def<span class="main">)</span>

    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword1"><span class="command">from</span></span> sapa <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">sa</span> <span class="main">∉</span> FV <span class="free">t</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">from</span></span> 
        contra_subsetD<span class="main">[</span><span class="operator">OF</span> sclose_subset_FV 
                          beta_preserves_FV<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">t</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>β</sub></span> <span class="free">t'</span>›</span></span> this<span class="main"><span class="main">]</span></span><span class="main">]</span> 
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">sa</span> <span class="main">∉</span> FV <span class="main">(</span><span class="keyword1">σ[</span><span class="skolem">s</span><span class="main">,</span><span class="skolem">p</span><span class="main">]</span> <span class="free">t'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> closez_def<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">from</span></span> sapa <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">pa</span> <span class="main">∉</span> FV <span class="free">t</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">from</span></span> 
        contra_subsetD<span class="main">[</span><span class="operator">OF</span> sclose_subset_FV 
                          beta_preserves_FV<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">t</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>β</sub></span> <span class="free">t'</span>›</span></span> this<span class="main"><span class="main">]</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">pa</span> <span class="main">∉</span> FV <span class="main">(</span><span class="keyword1">σ[</span><span class="skolem">s</span><span class="main">,</span><span class="skolem">p</span><span class="main">]</span> <span class="free">t'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> closez_def<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">sa</span> <span class="main">∉</span> FV <span class="main">(</span><span class="keyword1">σ[</span><span class="skolem">s</span><span class="main">,</span><span class="skolem">p</span><span class="main">]</span> <span class="free">t'</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">pa</span> <span class="main">∉</span> FV <span class="main">(</span><span class="keyword1">σ[</span><span class="skolem">s</span><span class="main">,</span><span class="skolem">p</span><span class="main">]</span> <span class="free">t'</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">sa</span> <span class="main">≠</span> <span class="skolem">pa</span>"</span></span> 
        <span class="keyword1"><span class="command">using</span></span> sapa
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">note</span></span> sym<span class="main">[</span><span class="operator">OF</span> sclose_sopen_eq_t<span class="main"><span class="main">[</span></span><span class="operator">OF</span> this<span class="main"><span class="main">]</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span>
    <span class="keyword3"><span class="command">show</span></span> 
      <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">t''</span><span class="main">.</span> <span class="keyword1">σ[</span><span class="skolem">s</span><span class="main">,</span><span class="skolem">p</span><span class="main">]</span> <span class="free">t</span><span class="hidden">⇗</span><sup>[Fvar <span class="skolem">sa</span><span class="main">,</span>Fvar <span class="skolem">pa</span>]</sup><span class="hidden">⇖</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>β</sub></span> <span class="bound">t''</span> <span class="main">∧</span> <span class="keyword1">σ[</span><span class="skolem">s</span><span class="main">,</span><span class="skolem">p</span><span class="main">]</span> <span class="free">t'</span> <span class="main">=</span> <span class="keyword1">σ[</span><span class="skolem">sa</span><span class="main">,</span><span class="skolem">pa</span><span class="main">]</span> <span class="bound">t''</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> openz_def closez_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"finite <span class="skolem">L</span>"</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword3"><span class="command">show</span></span> 
    <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">L'</span><span class="main">.</span> finite <span class="bound">L'</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">sa</span> <span class="bound">pa</span><span class="main">.</span> <span class="bound">sa</span> <span class="main">∉</span> <span class="bound">L'</span> <span class="main">∧</span> <span class="bound">pa</span> <span class="main">∉</span> <span class="bound">L'</span> <span class="main">∧</span> <span class="bound">sa</span> <span class="main">≠</span> <span class="bound">pa</span> 
                        <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">t''</span><span class="main">.</span> <span class="keyword1">σ[</span><span class="skolem">s</span><span class="main">,</span><span class="skolem">p</span><span class="main">]</span> <span class="free">t</span><span class="hidden">⇗</span><sup>[Fvar <span class="bound">sa</span><span class="main">,</span>Fvar <span class="bound">pa</span>]</sup><span class="hidden">⇖</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>β</sub></span> <span class="bound">t''</span> 
                                 <span class="main">∧</span> <span class="keyword1">σ[</span><span class="skolem">s</span><span class="main">,</span><span class="skolem">p</span><span class="main">]</span> <span class="free">t'</span> <span class="main">=</span> <span class="keyword1">σ[</span><span class="bound">sa</span><span class="main">,</span><span class="bound">pa</span><span class="main">]</span> <span class="bound">t''</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">L</span> <span class="main">∪</span> FV <span class="free">t</span> <span class="main">∪</span> <span class="main">{</span><span class="skolem">s</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="skolem">p</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Sigma-rtrancl_beta_UpdR"><span class="command">lemma</span></span> rtrancl_beta_UpdR<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">L</span> <span class="free">t</span> <span class="free">t'</span> <span class="free">u</span> <span class="free">l</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> 
  <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">s</span> <span class="bound">p</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∉</span> <span class="free">L</span> <span class="main">∧</span> <span class="bound">p</span> <span class="main">∉</span> <span class="free">L</span> <span class="main">∧</span> <span class="bound">s</span> <span class="main">≠</span> <span class="bound">p</span> 
    <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">t''</span><span class="main">.</span> <span class="main">(</span><span class="free">t</span><span class="hidden">⇗</span><sup>[Fvar <span class="bound">s</span><span class="main">,</span> Fvar <span class="bound">p</span>]</sup><span class="hidden">⇖</span><span class="main">)</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>β</sub><span class="hidden">⇧</span><sup>*</sup></span> <span class="bound">t''</span> <span class="main">∧</span> <span class="free">t'</span> <span class="main">=</span> <span class="keyword1">σ[</span><span class="bound">s</span><span class="main">,</span><span class="bound">p</span><span class="main">]</span><span class="bound">t''</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  <span class="quoted"><span class="quoted">"finite <span class="free">L</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"lc <span class="free">u</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Upd <span class="free">u</span> <span class="free">l</span> <span class="free">t</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>β</sub><span class="hidden">⇧</span><sup>*</sup></span> Upd <span class="free">u</span> <span class="free">l</span> <span class="free">t'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹finite <span class="free">L</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="free">L</span> <span class="main">∪</span> FV <span class="free">t</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> exFresh_s_p_cof<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="keyword2"><span class="keyword">where</span></span> sp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∉</span> <span class="free">L</span> <span class="main">∪</span> FV <span class="free">t</span> <span class="main">∧</span> <span class="skolem">p</span> <span class="main">∉</span> <span class="free">L</span> <span class="main">∪</span> FV <span class="free">t</span> <span class="main">∧</span> <span class="skolem">s</span> <span class="main">≠</span> <span class="skolem">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t''</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span><span class="hidden">⇗</span><sup>[Fvar <span class="skolem">s</span><span class="main">,</span>Fvar <span class="skolem">p</span>]</sup><span class="hidden">⇖</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>β</sub><span class="hidden">⇧</span><sup>*</sup></span> <span class="skolem">t''</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> t'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t'</span> <span class="main">=</span> <span class="keyword1">σ[</span><span class="skolem">s</span><span class="main">,</span><span class="skolem">p</span><span class="main">]</span> <span class="skolem">t''</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹lc <span class="free">u</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Upd <span class="free">u</span> <span class="free">l</span> <span class="free">t</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>β</sub><span class="hidden">⇧</span><sup>*</sup></span> Upd <span class="free">u</span> <span class="free">l</span> <span class="keyword1">σ[</span><span class="skolem">s</span><span class="main">,</span><span class="skolem">p</span><span class="main">]</span> <span class="skolem">t''</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">erule_tac</span> rtranclp_induct<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> sp <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∉</span> FV <span class="free">t</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∉</span> FV <span class="free">t</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">≠</span> <span class="skolem">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> sclose_sopen_eq_t<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> 
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Upd <span class="free">u</span> <span class="free">l</span> <span class="free">t</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>β</sub><span class="hidden">⇧</span><sup>*</sup></span> Upd <span class="free">u</span> <span class="free">l</span> <span class="main">(</span><span class="keyword1">σ[</span><span class="skolem">s</span><span class="main">,</span><span class="skolem">p</span><span class="main">]</span><span class="main">(</span><span class="free">t</span><span class="hidden">⇗</span><sup>[Fvar <span class="skolem">s</span><span class="main">,</span>Fvar <span class="skolem">p</span>]</sup><span class="hidden">⇖</span><span class="main">)</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> openz_def closez_def<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">y</span> <span class="main">::</span> <span class="quoted">sterm</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">z</span> <span class="main">::</span> <span class="quoted">sterm</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>β</sub></span> <span class="skolem">z</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> sp <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∉</span> <span class="free">L</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∉</span> <span class="free">L</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">≠</span> <span class="skolem">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> beta_binder<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">y</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>β</sub></span> <span class="skolem">z</span>›</span></span> <span class="quoted"><span class="quoted">‹finite <span class="free">L</span>›</span></span> this<span class="main">]</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">L'</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
      <span class="quoted"><span class="quoted">"finite <span class="skolem">L'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">sa</span> <span class="bound">pa</span><span class="main">.</span> <span class="bound">sa</span> <span class="main">∉</span> <span class="skolem">L'</span> <span class="main">∧</span> <span class="bound">pa</span> <span class="main">∉</span> <span class="skolem">L'</span> <span class="main">∧</span> <span class="bound">sa</span> <span class="main">≠</span> <span class="bound">pa</span>
        <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">t''</span><span class="main">.</span> <span class="keyword1">σ[</span><span class="skolem">s</span><span class="main">,</span><span class="skolem">p</span><span class="main">]</span> <span class="skolem">y</span><span class="hidden">⇗</span><sup>[Fvar <span class="bound">sa</span><span class="main">,</span>Fvar <span class="bound">pa</span>]</sup><span class="hidden">⇖</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>β</sub></span> <span class="bound">t''</span> <span class="main">∧</span> <span class="keyword1">σ[</span><span class="skolem">s</span><span class="main">,</span><span class="skolem">p</span><span class="main">]</span> <span class="skolem">z</span> <span class="main">=</span> <span class="keyword1">σ[</span><span class="bound">sa</span><span class="main">,</span><span class="bound">pa</span><span class="main">]</span> <span class="bound">t''</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> beta.beta_UpdR<span class="main">[</span><span class="operator">OF</span> this <span class="quoted"><span class="quoted">‹lc <span class="free">u</span>›</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Upd <span class="free">u</span> <span class="free">l</span> <span class="main">(</span><span class="keyword1">σ[</span><span class="skolem">s</span><span class="main">,</span><span class="skolem">p</span><span class="main">]</span> <span class="skolem">y</span><span class="main">)</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>β</sub></span> Upd <span class="free">u</span> <span class="free">l</span> <span class="main">(</span><span class="keyword1">σ[</span><span class="skolem">s</span><span class="main">,</span><span class="skolem">p</span><span class="main">]</span> <span class="skolem">z</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">assumption</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"Upd <span class="free">u</span> <span class="free">l</span> <span class="free">t</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>β</sub><span class="hidden">⇧</span><sup>*</sup></span> Upd <span class="free">u</span> <span class="free">l</span> <span class="main">(</span><span class="keyword1">σ[</span><span class="skolem">s</span><span class="main">,</span><span class="skolem">p</span><span class="main">]</span> <span class="skolem">y</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Upd <span class="free">u</span> <span class="free">l</span> <span class="free">t</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>β</sub><span class="hidden">⇧</span><sup>*</sup></span> Upd <span class="free">u</span> <span class="free">l</span> <span class="main">(</span><span class="keyword1">σ[</span><span class="skolem">s</span><span class="main">,</span><span class="skolem">p</span><span class="main">]</span> <span class="skolem">z</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">with</span></span> t' <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Upd <span class="free">u</span> <span class="free">l</span> <span class="free">t</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>β</sub><span class="hidden">⇧</span><sup>*</sup></span> Upd <span class="free">u</span> <span class="free">l</span> <span class="free">t'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Sigma-rtrancl_beta_Upd"><span class="command">lemma</span></span> rtrancl_beta_Upd<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">u</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>β</sub><span class="hidden">⇧</span><sup>*</sup></span> <span class="free">u'</span><span class="main">;</span> finite <span class="free">L</span><span class="main">;</span> 
     <span class="main">∀</span><span class="bound">s</span> <span class="bound">p</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∉</span> <span class="free">L</span> <span class="main">∧</span> <span class="bound">p</span> <span class="main">∉</span> <span class="free">L</span> <span class="main">∧</span> <span class="bound">s</span> <span class="main">≠</span> <span class="bound">p</span> 
      <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">t''</span><span class="main">.</span> <span class="free">t</span><span class="hidden">⇗</span><sup>[Fvar <span class="bound">s</span><span class="main">,</span>Fvar <span class="bound">p</span>]</sup><span class="hidden">⇖</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>β</sub><span class="hidden">⇧</span><sup>*</sup></span> <span class="bound">t''</span> <span class="main">∧</span> <span class="free">t'</span> <span class="main">=</span> <span class="keyword1">σ[</span><span class="bound">s</span><span class="main">,</span><span class="bound">p</span><span class="main">]</span><span class="bound">t''</span><span class="main">)</span><span class="main">;</span>
     lc <span class="free">u</span><span class="main">;</span> body <span class="free">t</span> <span class="main">⟧</span>
  <span class="main">⟹</span> Upd <span class="free">u</span> <span class="free">l</span> <span class="free">t</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>β</sub><span class="hidden">⇧</span><sup>*</sup></span> Upd <span class="free">u'</span> <span class="free">l</span> <span class="free">t'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">u</span></span> <span class="quoted"><span class="free">u'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rtranclp.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> rtrancl_refl <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rtrancl_beta_UpdR<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>rtrancl_into_rtrancl <span class="skolem">a</span> <span class="skolem">b</span> <span class="skolem">c</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> rtrancl_beta_body<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹finite <span class="free">L</span>›</span></span> rtrancl_into_rtrancl<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> <span class="quoted"><span class="quoted">‹body <span class="free">t</span>›</span></span><span class="main">]</span> <span class="quoted"><span class="quoted">‹<span class="skolem">b</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>β</sub></span> <span class="skolem">c</span>›</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Upd <span class="skolem">b</span> <span class="free">l</span> <span class="free">t'</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>β</sub></span> Upd <span class="skolem">c</span> <span class="free">l</span> <span class="free">t'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">with</span></span> rtrancl_into_rtrancl<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹finite <span class="free">L</span>›</span></span> rtrancl_into_rtrancl<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> <span class="quoted"><span class="quoted">‹lc <span class="skolem">a</span>›</span></span> <span class="quoted"><span class="quoted">‹body <span class="free">t</span>›</span></span><span class="main">]</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Upd <span class="skolem">a</span> <span class="free">l</span> <span class="free">t</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>β</sub><span class="hidden">⇧</span><sup>*</sup></span> Upd <span class="skolem">c</span> <span class="free">l</span> <span class="free">t'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Sigma-rtrancl_beta_obj"><span class="command">lemma</span></span> rtrancl_beta_obj<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">l</span> <span class="free">f</span> <span class="free">L</span> <span class="free">T</span> <span class="free">t</span> <span class="free">t'</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">∈</span> dom <span class="free">f</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">L</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">s</span> <span class="bound">p</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∉</span> <span class="free">L</span> <span class="main">∧</span> <span class="bound">p</span> <span class="main">∉</span> <span class="free">L</span> <span class="main">∧</span> <span class="bound">s</span> <span class="main">≠</span> <span class="bound">p</span> 
    <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">t''</span><span class="main">.</span> <span class="free">t</span><span class="hidden">⇗</span><sup>[Fvar <span class="bound">s</span><span class="main">,</span>Fvar <span class="bound">p</span>]</sup><span class="hidden">⇖</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>β</sub><span class="hidden">⇧</span><sup>*</sup></span> <span class="bound">t''</span> <span class="main">∧</span> <span class="free">t'</span> <span class="main">=</span> <span class="keyword1">σ[</span><span class="bound">s</span><span class="main">,</span><span class="bound">p</span><span class="main">]</span><span class="bound">t''</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">l</span><span class="main">∈</span>dom <span class="free">f</span><span class="main">.</span> body <span class="main">(</span>the<span class="main">(</span><span class="free">f</span> <span class="bound">l</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"body <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Obj <span class="main">(</span><span class="free">f</span> <span class="main">(</span><span class="free">l</span> <span class="main">↦</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span> <span class="free">T</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>β</sub><span class="hidden">⇧</span><sup>*</sup></span> Obj <span class="main">(</span><span class="free">f</span> <span class="main">(</span><span class="free">l</span> <span class="main">↦</span> <span class="free">t'</span><span class="main">)</span><span class="main">)</span> <span class="free">T</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹finite <span class="free">L</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="free">L</span> <span class="main">∪</span> FV <span class="free">t</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> exFresh_s_p_cof<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="keyword2"><span class="keyword">where</span></span> sp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∉</span> <span class="free">L</span> <span class="main">∪</span> FV <span class="free">t</span> <span class="main">∧</span> <span class="skolem">p</span> <span class="main">∉</span> <span class="free">L</span> <span class="main">∪</span> FV <span class="free">t</span> <span class="main">∧</span> <span class="skolem">s</span> <span class="main">≠</span> <span class="skolem">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t''</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span><span class="hidden">⇗</span><sup>[Fvar <span class="skolem">s</span><span class="main">,</span>Fvar <span class="skolem">p</span>]</sup><span class="hidden">⇖</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>β</sub><span class="hidden">⇧</span><sup>*</sup></span> <span class="skolem">t''</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">t'</span> <span class="main">=</span> <span class="keyword1">σ[</span><span class="skolem">s</span><span class="main">,</span><span class="skolem">p</span><span class="main">]</span> <span class="skolem">t''</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="free">l</span> <span class="main">∈</span> dom <span class="free">f</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span><span class="bound">l</span><span class="main">∈</span>dom <span class="free">f</span><span class="main">.</span> body <span class="main">(</span>the<span class="main">(</span><span class="free">f</span> <span class="bound">l</span><span class="main">)</span><span class="main">)</span>›</span></span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Obj <span class="main">(</span><span class="free">f</span><span class="main">(</span><span class="free">l</span> <span class="main">↦</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span> <span class="free">T</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>β</sub><span class="hidden">⇧</span><sup>*</sup></span> Obj <span class="main">(</span><span class="free">f</span><span class="main">(</span><span class="free">l</span> <span class="main">↦</span> <span class="keyword1">σ[</span><span class="skolem">s</span><span class="main">,</span><span class="skolem">p</span><span class="main">]</span> <span class="skolem">t''</span><span class="main">)</span><span class="main">)</span> <span class="free">T</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">erule_tac</span> rtranclp_induct<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> sp <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∉</span> FV <span class="free">t</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∉</span> FV <span class="free">t</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">≠</span> <span class="skolem">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> sclose_sopen_eq_t<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> 
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Obj <span class="main">(</span><span class="free">f</span><span class="main">(</span><span class="free">l</span> <span class="main">↦</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span> <span class="free">T</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>β</sub><span class="hidden">⇧</span><sup>*</sup></span> Obj <span class="main">(</span><span class="free">f</span><span class="main">(</span><span class="free">l</span> <span class="main">↦</span> <span class="keyword1">σ[</span><span class="skolem">s</span><span class="main">,</span><span class="skolem">p</span><span class="main">]</span> <span class="main">(</span><span class="free">t</span><span class="hidden">⇗</span><sup>[Fvar <span class="skolem">s</span><span class="main">,</span>Fvar <span class="skolem">p</span>]</sup><span class="hidden">⇖</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">T</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> openz_def closez_def<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">y</span> <span class="main">::</span> <span class="quoted">sterm</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">z</span> <span class="main">::</span> <span class="quoted">sterm</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>β</sub></span> <span class="skolem">z</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> sp <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∉</span> <span class="free">L</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∉</span> <span class="free">L</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">≠</span> <span class="skolem">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> beta_binder<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">y</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>β</sub></span> <span class="skolem">z</span>›</span></span> <span class="quoted"><span class="quoted">‹finite <span class="free">L</span>›</span></span> this<span class="main">]</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">L'</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
      <span class="quoted"><span class="quoted">"finite <span class="skolem">L'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">sa</span> <span class="bound">pa</span><span class="main">.</span> <span class="bound">sa</span> <span class="main">∉</span> <span class="skolem">L'</span> <span class="main">∧</span> <span class="bound">pa</span> <span class="main">∉</span> <span class="skolem">L'</span> <span class="main">∧</span> <span class="bound">sa</span> <span class="main">≠</span> <span class="bound">pa</span>
        <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">t''</span><span class="main">.</span> <span class="keyword1">σ[</span><span class="skolem">s</span><span class="main">,</span><span class="skolem">p</span><span class="main">]</span> <span class="skolem">y</span><span class="hidden">⇗</span><sup>[Fvar <span class="bound">sa</span><span class="main">,</span>Fvar <span class="bound">pa</span>]</sup><span class="hidden">⇖</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>β</sub></span> <span class="bound">t''</span> <span class="main">∧</span> <span class="keyword1">σ[</span><span class="skolem">s</span><span class="main">,</span><span class="skolem">p</span><span class="main">]</span> <span class="skolem">z</span> <span class="main">=</span> <span class="keyword1">σ[</span><span class="bound">sa</span><span class="main">,</span><span class="bound">pa</span><span class="main">]</span> <span class="bound">t''</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> beta.beta_Obj<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">l</span> <span class="main">∈</span> dom <span class="free">f</span>›</span></span> this <span class="quoted"><span class="quoted">‹<span class="main">∀</span><span class="bound">l</span><span class="main">∈</span>dom <span class="free">f</span><span class="main">.</span> body <span class="main">(</span>the<span class="main">(</span><span class="free">f</span> <span class="bound">l</span><span class="main">)</span><span class="main">)</span>›</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Obj <span class="main">(</span><span class="free">f</span><span class="main">(</span><span class="free">l</span> <span class="main">↦</span> <span class="keyword1">σ[</span><span class="skolem">s</span><span class="main">,</span><span class="skolem">p</span><span class="main">]</span> <span class="skolem">y</span><span class="main">)</span><span class="main">)</span> <span class="free">T</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>β</sub></span> Obj <span class="main">(</span><span class="free">f</span><span class="main">(</span><span class="free">l</span> <span class="main">↦</span> <span class="keyword1">σ[</span><span class="skolem">s</span><span class="main">,</span><span class="skolem">p</span><span class="main">]</span> <span class="skolem">z</span><span class="main">)</span><span class="main">)</span> <span class="free">T</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">assumption</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"Obj <span class="main">(</span><span class="free">f</span><span class="main">(</span><span class="free">l</span> <span class="main">↦</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span> <span class="free">T</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>β</sub><span class="hidden">⇧</span><sup>*</sup></span> Obj <span class="main">(</span><span class="free">f</span><span class="main">(</span><span class="free">l</span> <span class="main">↦</span> <span class="keyword1">σ[</span><span class="skolem">s</span><span class="main">,</span><span class="skolem">p</span><span class="main">]</span> <span class="skolem">y</span><span class="main">)</span><span class="main">)</span> <span class="free">T</span>"</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Obj <span class="main">(</span><span class="free">f</span><span class="main">(</span><span class="free">l</span> <span class="main">↦</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span> <span class="free">T</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>β</sub><span class="hidden">⇧</span><sup>*</sup></span> Obj <span class="main">(</span><span class="free">f</span><span class="main">(</span><span class="free">l</span> <span class="main">↦</span> <span class="keyword1">σ[</span><span class="skolem">s</span><span class="main">,</span><span class="skolem">p</span><span class="main">]</span> <span class="skolem">z</span><span class="main">)</span><span class="main">)</span> <span class="free">T</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="free">t'</span> <span class="main">=</span> <span class="keyword1">σ[</span><span class="skolem">s</span><span class="main">,</span><span class="skolem">p</span><span class="main">]</span> <span class="skolem">t''</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Obj <span class="main">(</span><span class="free">f</span><span class="main">(</span><span class="free">l</span> <span class="main">↦</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span> <span class="free">T</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>β</sub><span class="hidden">⇧</span><sup>*</sup></span> Obj <span class="main">(</span><span class="free">f</span><span class="main">(</span><span class="free">l</span> <span class="main">↦</span> <span class="free">t'</span><span class="main">)</span><span class="main">)</span> <span class="free">T</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Sigma-obj_lem"><span class="command">lemma</span></span> obj_lem<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">l</span> <span class="free">f</span> <span class="free">T</span> <span class="free">L</span> <span class="free">t'</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">∈</span> dom <span class="free">f</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">L</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">s</span> <span class="bound">p</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∉</span> <span class="free">L</span> <span class="main">∧</span> <span class="bound">p</span> <span class="main">∉</span> <span class="free">L</span> <span class="main">∧</span> <span class="bound">s</span> <span class="main">≠</span> <span class="bound">p</span> 
    <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">t''</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span>the<span class="main">(</span><span class="free">f</span> <span class="free">l</span><span class="main">)</span><span class="main">)</span><span class="hidden">⇗</span><sup>[Fvar <span class="bound">s</span><span class="main">,</span>Fvar <span class="bound">p</span>]</sup><span class="hidden">⇖</span><span class="main">)</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>β</sub><span class="hidden">⇧</span><sup>*</sup></span> <span class="bound">t''</span> <span class="main">∧</span> <span class="free">t'</span> <span class="main">=</span> <span class="keyword1">σ[</span><span class="bound">s</span><span class="main">,</span><span class="bound">p</span><span class="main">]</span><span class="bound">t''</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">l</span><span class="main">∈</span>dom <span class="free">f</span><span class="main">.</span> body <span class="main">(</span>the<span class="main">(</span><span class="free">f</span> <span class="bound">l</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Obj <span class="free">f</span> <span class="free">T</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>β</sub><span class="hidden">⇧</span><sup>*</sup></span> Obj <span class="main">(</span><span class="free">f</span><span class="main">(</span><span class="free">l</span> <span class="main">↦</span> <span class="free">t'</span><span class="main">)</span><span class="main">)</span> <span class="free">T</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> 
  <span class="main">(</span><span class="operator">rule_tac</span> P <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">y</span><span class="main">.</span> Obj <span class="bound">y</span> <span class="free">T</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>β</sub><span class="hidden">⇧</span><sup>*</sup></span> Obj <span class="main">(</span><span class="free">f</span><span class="main">(</span><span class="free">l</span> <span class="main">↦</span> <span class="free">t'</span><span class="main">)</span><span class="main">)</span> <span class="free">T</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> s <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span><span class="main">(</span><span class="free">l</span> <span class="main">↦</span> the<span class="main">(</span><span class="free">f</span> <span class="free">l</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> subst<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="free">l</span> <span class="main">∈</span> dom <span class="free">f</span>›</span></span> fun_upd_idem <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span><span class="main">(</span><span class="free">l</span> <span class="main">↦</span> the <span class="main">(</span><span class="free">f</span> <span class="free">l</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">f</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="free">l</span> <span class="main">∈</span> dom <span class="free">f</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span><span class="bound">l</span><span class="main">∈</span>dom <span class="free">f</span><span class="main">.</span> body <span class="main">(</span>the<span class="main">(</span><span class="free">f</span> <span class="bound">l</span><span class="main">)</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"body <span class="main">(</span>the <span class="main">(</span><span class="free">f</span> <span class="free">l</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">with</span></span> 
    rtrancl_beta_obj<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">l</span> <span class="main">∈</span> dom <span class="free">f</span>›</span></span> <span class="quoted"><span class="quoted">‹finite <span class="free">L</span>›</span></span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span><span class="bound">l</span><span class="main">∈</span>dom <span class="free">f</span><span class="main">.</span> body <span class="main">(</span>the<span class="main">(</span><span class="free">f</span> <span class="bound">l</span><span class="main">)</span><span class="main">)</span>›</span></span><span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Obj <span class="main">(</span><span class="free">f</span><span class="main">(</span><span class="free">l</span> <span class="main">↦</span> the <span class="main">(</span><span class="free">f</span> <span class="free">l</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">T</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>β</sub><span class="hidden">⇧</span><sup>*</sup></span> Obj <span class="main">(</span><span class="free">f</span><span class="main">(</span><span class="free">l</span> <span class="main">↦</span> <span class="free">t'</span><span class="main">)</span><span class="main">)</span> <span class="free">T</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Sigma-rtrancl_beta_obj_lem00"><span class="command">lemma</span></span> rtrancl_beta_obj_lem00<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">L</span> <span class="free">f</span> <span class="free">g</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> 
  <span class="quoted"><span class="quoted">"finite <span class="free">L</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">l</span><span class="main">∈</span>dom <span class="free">f</span><span class="main">.</span> <span class="main">∀</span><span class="bound">s</span> <span class="bound">p</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∉</span> <span class="free">L</span> <span class="main">∧</span> <span class="bound">p</span> <span class="main">∉</span> <span class="free">L</span> <span class="main">∧</span> <span class="bound">s</span> <span class="main">≠</span> <span class="bound">p</span> 
               <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">t''</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span>the<span class="main">(</span><span class="free">f</span> <span class="bound">l</span><span class="main">)</span><span class="main">)</span><span class="hidden">⇗</span><sup>[Fvar <span class="bound">s</span><span class="main">,</span> Fvar <span class="bound">p</span>]</sup><span class="hidden">⇖</span><span class="main">)</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>β</sub><span class="hidden">⇧</span><sup>*</sup></span> <span class="bound">t''</span> 
                        <span class="main">∧</span> the<span class="main">(</span><span class="free">g</span> <span class="bound">l</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">σ[</span><span class="bound">s</span><span class="main">,</span><span class="bound">p</span><span class="main">]</span><span class="bound">t''</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  <span class="quoted"><span class="quoted">"dom <span class="free">f</span> <span class="main">=</span> dom <span class="free">g</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">l</span><span class="main">∈</span>dom <span class="free">f</span><span class="main">.</span> body <span class="main">(</span>the <span class="main">(</span><span class="free">f</span> <span class="bound">l</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> 
  <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">k</span></span> <span class="main">≤</span> <span class="main">(</span>card <span class="main">(</span>dom <span class="free">f</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> 
    <span class="main">(</span><span class="main">∃</span><span class="bound">ob</span><span class="main">.</span> length <span class="bound">ob</span> <span class="main">=</span> <span class="main">(</span><span class="bound">k</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>
        <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">obi</span><span class="main">.</span> <span class="bound">obi</span> <span class="main">∈</span> set <span class="bound">ob</span> <span class="main">⟶</span> dom <span class="main">(</span>fst<span class="main">(</span><span class="bound">obi</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> dom <span class="free">f</span> <span class="main">∧</span> <span class="main">(</span><span class="main">(</span>snd <span class="bound">obi</span><span class="main">)</span> <span class="main">⊆</span> dom <span class="free">f</span><span class="main">)</span><span class="main">)</span> 
        <span class="main">∧</span> <span class="main">(</span>fst <span class="main">(</span><span class="bound">ob</span><span class="main">!</span><span class="main">0</span><span class="main">)</span> <span class="main">=</span> <span class="free">f</span><span class="main">)</span>
        <span class="main">∧</span> <span class="main">(</span>card <span class="main">(</span>snd <span class="main">(</span><span class="bound">ob</span><span class="main">!</span><span class="bound">k</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="bound">k</span><span class="main">)</span>
        <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> <span class="bound">k</span><span class="main">.</span> snd <span class="main">(</span><span class="bound">ob</span><span class="main">!</span><span class="bound">i</span><span class="main">)</span> <span class="main">⊂</span> snd <span class="main">(</span><span class="bound">ob</span><span class="main">!</span><span class="bound">k</span><span class="main">)</span><span class="main">)</span>
        <span class="main">∧</span> <span class="main">(</span>Obj <span class="main">(</span>fst <span class="main">(</span><span class="bound">ob</span><span class="main">!</span><span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="free">T</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>β</sub><span class="hidden">⇧</span><sup>*</sup></span> Obj <span class="main">(</span>fst <span class="main">(</span><span class="bound">ob</span><span class="main">!</span><span class="bound">k</span><span class="main">)</span><span class="main">)</span> <span class="free">T</span><span class="main">)</span>
        <span class="main">∧</span> <span class="main">(</span>card <span class="main">(</span>snd <span class="main">(</span><span class="bound">ob</span><span class="main">!</span><span class="bound">k</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="bound">k</span> 
           <span class="main">⟶</span> <span class="main">(</span>Ltake_eq <span class="main">(</span>snd <span class="main">(</span><span class="bound">ob</span><span class="main">!</span><span class="bound">k</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>fst <span class="main">(</span><span class="bound">ob</span><span class="main">!</span><span class="bound">k</span><span class="main">)</span><span class="main">)</span> <span class="free">g</span><span class="main">)</span>
                <span class="main">∧</span> <span class="main">(</span>Ltake_eq <span class="main">(</span><span class="main">(</span>dom <span class="free">f</span><span class="main">)</span> <span class="main">-</span> <span class="main">(</span>snd <span class="main">(</span><span class="bound">ob</span><span class="main">!</span><span class="bound">k</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>fst <span class="main">(</span><span class="bound">ob</span><span class="main">!</span><span class="bound">k</span><span class="main">)</span><span class="main">)</span> <span class="free">f</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">k</span> <span class="main">::</span> <span class="quoted">nat</span>
  <span class="keyword3"><span class="command">show</span></span> 
    <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">≤</span> card <span class="main">(</span>dom <span class="free">f</span><span class="main">)</span> 
    <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">ob</span><span class="main">.</span> length <span class="bound">ob</span> <span class="main">=</span> <span class="skolem">k</span> <span class="main">+</span> <span class="main">1</span> 
            <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">obi</span><span class="main">.</span> <span class="bound">obi</span> <span class="main">∈</span> set <span class="bound">ob</span> <span class="main">⟶</span> dom <span class="main">(</span>fst <span class="bound">obi</span><span class="main">)</span> <span class="main">=</span> dom <span class="free">f</span> <span class="main">∧</span> snd <span class="bound">obi</span> <span class="main">⊆</span> dom <span class="free">f</span><span class="main">)</span> 
            <span class="main">∧</span> fst <span class="main">(</span><span class="bound">ob</span> <span class="main">!</span> <span class="main">0</span><span class="main">)</span> <span class="main">=</span> <span class="free">f</span> 
            <span class="main">∧</span> card <span class="main">(</span>snd <span class="main">(</span><span class="bound">ob</span> <span class="main">!</span> <span class="skolem">k</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">k</span> 
            <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">i</span></span><span class="main">&lt;</span><span class="skolem">k</span><span class="main">.</span> snd <span class="main">(</span><span class="bound">ob</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">⊂</span> snd <span class="main">(</span><span class="bound">ob</span> <span class="main">!</span> <span class="skolem">k</span><span class="main">)</span><span class="main">)</span> 
            <span class="main">∧</span> Obj <span class="main">(</span>fst <span class="main">(</span><span class="bound">ob</span> <span class="main">!</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="free">T</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>β</sub><span class="hidden">⇧</span><sup>*</sup></span> Obj <span class="main">(</span>fst <span class="main">(</span><span class="bound">ob</span> <span class="main">!</span> <span class="skolem">k</span><span class="main">)</span><span class="main">)</span> <span class="free">T</span> 
            <span class="main">∧</span> <span class="main">(</span>card <span class="main">(</span>snd <span class="main">(</span><span class="bound">ob</span> <span class="main">!</span> <span class="skolem">k</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">k</span> 
               <span class="main">⟶</span> Ltake_eq <span class="main">(</span>snd <span class="main">(</span><span class="bound">ob</span> <span class="main">!</span> <span class="skolem">k</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>fst <span class="main">(</span><span class="bound">ob</span> <span class="main">!</span> <span class="skolem">k</span><span class="main">)</span><span class="main">)</span> <span class="free">g</span> 
                   <span class="main">∧</span> Ltake_eq <span class="main">(</span>dom <span class="free">f</span> <span class="main">-</span> snd <span class="main">(</span><span class="bound">ob</span> <span class="main">!</span> <span class="skolem">k</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>fst <span class="main">(</span><span class="bound">ob</span> <span class="main">!</span> <span class="skolem">k</span><span class="main">)</span><span class="main">)</span> <span class="free">f</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">k</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> 0 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">(</span><span class="free">f</span><span class="main">,</span><span class="main">{}</span><span class="main">)</span><span class="main">]</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Ltake_eq_def<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">clarify</span><span class="main">)</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">k</span> <span class="main">≤</span> card <span class="main">(</span>dom <span class="free">f</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">&lt;</span> card <span class="main">(</span>dom <span class="free">f</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">arith</span>
      <span class="keyword1"><span class="command">with</span></span> Suc.hyps
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ob</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
        <span class="quoted"><span class="quoted">"length <span class="skolem">ob</span> <span class="main">=</span> <span class="skolem">k</span> <span class="main">+</span> <span class="main">1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
        mem_ob<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">obi</span><span class="main">.</span> <span class="bound">obi</span> <span class="main">∈</span> set <span class="skolem">ob</span> 
                  <span class="main">⟶</span> dom <span class="main">(</span>fst <span class="bound">obi</span><span class="main">)</span> <span class="main">=</span> dom <span class="free">f</span> <span class="main">∧</span> snd <span class="bound">obi</span> <span class="main">⊆</span> dom <span class="free">f</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
        <span class="quoted"><span class="quoted">"fst <span class="main">(</span><span class="skolem">ob</span> <span class="main">!</span> <span class="main">0</span><span class="main">)</span> <span class="main">=</span> <span class="free">f</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
        <span class="quoted"><span class="quoted">"card <span class="main">(</span>snd <span class="main">(</span><span class="skolem">ob</span> <span class="main">!</span> <span class="skolem">k</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">k</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
        <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">i</span></span><span class="main">&lt;</span><span class="skolem">k</span><span class="main">.</span> snd <span class="main">(</span><span class="skolem">ob</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">⊂</span> snd <span class="main">(</span><span class="skolem">ob</span> <span class="main">!</span> <span class="skolem">k</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
        <span class="quoted"><span class="quoted">"Obj <span class="main">(</span>fst <span class="main">(</span><span class="skolem">ob</span> <span class="main">!</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="free">T</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>β</sub><span class="hidden">⇧</span><sup>*</sup></span> Obj <span class="main">(</span>fst <span class="main">(</span><span class="skolem">ob</span> <span class="main">!</span> <span class="skolem">k</span><span class="main">)</span><span class="main">)</span> <span class="free">T</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
        card_k<span class="main">:</span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>snd <span class="main">(</span><span class="skolem">ob</span> <span class="main">!</span> <span class="skolem">k</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">k</span> 
                 <span class="main">⟶</span> Ltake_eq <span class="main">(</span>snd <span class="main">(</span><span class="skolem">ob</span> <span class="main">!</span> <span class="skolem">k</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>fst <span class="main">(</span><span class="skolem">ob</span> <span class="main">!</span> <span class="skolem">k</span><span class="main">)</span><span class="main">)</span> <span class="free">g</span> 
                     <span class="main">∧</span> Ltake_eq <span class="main">(</span>dom <span class="free">f</span> <span class="main">-</span> snd <span class="main">(</span><span class="skolem">ob</span> <span class="main">!</span> <span class="skolem">k</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>fst <span class="main">(</span><span class="skolem">ob</span> <span class="main">!</span> <span class="skolem">k</span><span class="main">)</span><span class="main">)</span> <span class="free">f</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹length <span class="skolem">ob</span> <span class="main">=</span> <span class="skolem">k</span> <span class="main">+</span> <span class="main">1</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> obkmem<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">ob</span><span class="main">!</span><span class="skolem">k</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">ob</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

      <span class="keyword1"><span class="command">with</span></span> mem_ob <span class="keyword1"><span class="command">have</span></span> obksnd<span class="main">:</span> <span class="quoted"><span class="quoted">"snd<span class="main">(</span><span class="skolem">ob</span><span class="main">!</span><span class="skolem">k</span><span class="main">)</span> <span class="main">⊆</span> dom <span class="free">f</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">from</span></span> 
        card_psubset<span class="main">[</span><span class="operator">OF</span> finite_dom_fmap this<span class="main">]</span> <span class="quoted"><span class="quoted">‹card <span class="main">(</span>snd<span class="main">(</span><span class="skolem">ob</span><span class="main">!</span><span class="skolem">k</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">k</span>›</span></span> 
        <span class="quoted"><span class="quoted">‹<span class="skolem">k</span> <span class="main">&lt;</span> card <span class="main">(</span>dom <span class="free">f</span><span class="main">)</span>›</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span><span class="skolem">ob</span><span class="main">!</span><span class="skolem">k</span><span class="main">)</span> <span class="main">⊂</span> dom <span class="free">f</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">l'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l'</span> <span class="main">∈</span> dom <span class="free">f</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l'</span> <span class="main">∉</span> snd <span class="main">(</span><span class="skolem">ob</span><span class="main">!</span><span class="skolem">k</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

      <span class="keyword1"><span class="command">from</span></span> obkmem mem_ob <span class="keyword1"><span class="command">have</span></span> obkfst<span class="main">:</span> <span class="quoted"><span class="quoted">"dom <span class="main">(</span>fst<span class="main">(</span><span class="skolem">ob</span><span class="main">!</span><span class="skolem">k</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> dom <span class="free">f</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 

        <span class="comment1">(* get witness *)</span>
      <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">ob'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ob'</span> <span class="main">=</span> <span class="skolem">ob</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span>fst<span class="main">(</span><span class="skolem">ob</span><span class="main">!</span><span class="skolem">k</span><span class="main">)</span><span class="main">(</span><span class="skolem">l'</span> <span class="main">↦</span> the <span class="main">(</span><span class="free">g</span> <span class="skolem">l'</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> insert <span class="skolem">l'</span> <span class="main">(</span>snd<span class="main">(</span><span class="skolem">ob</span><span class="main">!</span><span class="skolem">k</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">]</span>"</span></span>

      <span class="keyword1"><span class="command">from</span></span> nth_fst<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹length <span class="skolem">ob</span> <span class="main">=</span> <span class="skolem">k</span> <span class="main">+</span> <span class="main">1</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> first<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ob'</span><span class="main">!</span><span class="main">0</span> <span class="main">=</span> <span class="skolem">ob</span><span class="main">!</span><span class="main">0</span>"</span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ob'_def<span class="main">)</span>

      <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹length <span class="skolem">ob</span> <span class="main">=</span> <span class="skolem">k</span> <span class="main">+</span> <span class="main">1</span>›</span></span> nth_last<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">ob</span></span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">k</span>"</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">have</span></span> last<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ob'</span><span class="main">!</span>Suc <span class="skolem">k</span> <span class="main">=</span> <span class="main">(</span>fst<span class="main">(</span><span class="skolem">ob</span><span class="main">!</span><span class="skolem">k</span><span class="main">)</span><span class="main">(</span><span class="skolem">l'</span> <span class="main">↦</span> the <span class="main">(</span><span class="free">g</span> <span class="skolem">l'</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> insert <span class="skolem">l'</span> <span class="main">(</span>snd<span class="main">(</span><span class="skolem">ob</span><span class="main">!</span><span class="skolem">k</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ob'_def<span class="main">)</span>

      <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹length <span class="skolem">ob</span> <span class="main">=</span> <span class="skolem">k</span> <span class="main">+</span> <span class="main">1</span>›</span></span> nth_append<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">ob</span></span> <span class="main">_</span> <span class="quoted"><span class="skolem">k</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> kth<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ob'</span><span class="main">!</span><span class="skolem">k</span> <span class="main">=</span> <span class="skolem">ob</span><span class="main">!</span><span class="skolem">k</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ob'_def<span class="main">)</span>

      <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹card <span class="main">(</span>snd<span class="main">(</span><span class="skolem">ob</span><span class="main">!</span><span class="skolem">k</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">k</span>›</span></span> card_k
      <span class="keyword1"><span class="command">have</span></span> ass<span class="main">:</span>
        <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">l</span><span class="main">∈</span><span class="main">(</span>snd<span class="main">(</span><span class="skolem">ob</span><span class="main">!</span><span class="skolem">k</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> fst<span class="main">(</span><span class="skolem">ob</span><span class="main">!</span><span class="skolem">k</span><span class="main">)</span> <span class="bound">l</span> <span class="main">=</span> <span class="free">g</span> <span class="bound">l</span>"</span></span>
        <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">l</span><span class="main">∈</span><span class="main">(</span>dom <span class="free">f</span> <span class="main">-</span> snd<span class="main">(</span><span class="skolem">ob</span><span class="main">!</span><span class="skolem">k</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> fst<span class="main">(</span><span class="skolem">ob</span><span class="main">!</span><span class="skolem">k</span><span class="main">)</span> <span class="bound">l</span> <span class="main">=</span> <span class="free">f</span> <span class="bound">l</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Ltake_eq_def<span class="main">)</span>


        <span class="comment1">(* prop#1 *)</span>
      <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹length <span class="skolem">ob</span> <span class="main">=</span> <span class="skolem">k</span> <span class="main">+</span> <span class="main">1</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">ob'</span> <span class="main">=</span> Suc <span class="skolem">k</span> <span class="main">+</span> <span class="main">1</span>"</span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ob'_def<span class="main">)</span>

        <span class="comment1">(* prop#2 *)</span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">obi</span><span class="main">.</span> <span class="bound">obi</span> <span class="main">∈</span> set <span class="skolem">ob'</span> <span class="main">⟶</span> dom <span class="main">(</span>fst <span class="bound">obi</span><span class="main">)</span> <span class="main">=</span> dom <span class="free">f</span> <span class="main">∧</span> snd <span class="bound">obi</span> <span class="main">⊆</span> dom <span class="free">f</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> ob'_def
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> strip<span class="main">)</span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">obi</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Label <span class="main">-~&gt;</span> sterm<span class="main">)</span> <span class="main">×</span> <span class="main">(</span>Label set<span class="main">)</span>"</span></span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">obi</span> <span class="main">∈</span> set <span class="main">(</span><span class="skolem">ob</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span>fst<span class="main">(</span><span class="skolem">ob</span><span class="main">!</span><span class="skolem">k</span><span class="main">)</span><span class="main">(</span><span class="skolem">l'</span> <span class="main">↦</span> the <span class="main">(</span><span class="free">g</span> <span class="skolem">l'</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> insert <span class="skolem">l'</span> <span class="main">(</span>snd <span class="main">(</span><span class="skolem">ob</span><span class="main">!</span><span class="skolem">k</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">]</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">note</span></span> mem_append_lem'<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"dom <span class="main">(</span>fst <span class="skolem">obi</span><span class="main">)</span> <span class="main">=</span> dom <span class="free">f</span> <span class="main">∧</span> snd <span class="skolem">obi</span> <span class="main">⊆</span> dom <span class="free">f</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> disjE<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">obi</span> <span class="main">∈</span> set <span class="skolem">ob</span>"</span></span> 
          <span class="keyword1"><span class="command">with</span></span> mem_ob <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"dom <span class="main">(</span>fst <span class="skolem">obi</span><span class="main">)</span> <span class="main">=</span> dom <span class="free">f</span> <span class="main">∧</span> snd <span class="skolem">obi</span> <span class="main">⊆</span> dom <span class="free">f</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword1"><span class="command">from</span></span> obkfst obksnd <span class="quoted"><span class="quoted">‹<span class="skolem">l'</span> <span class="main">∈</span> dom <span class="free">f</span>›</span></span>
          <span class="keyword3"><span class="command">show</span></span> 
            <span class="quoted"><span class="quoted">"insert <span class="skolem">l'</span> <span class="main">(</span>dom <span class="main">(</span>fst <span class="main">(</span><span class="skolem">ob</span><span class="main">!</span><span class="skolem">k</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> dom <span class="free">f</span> 
             <span class="main">∧</span> <span class="skolem">l'</span> <span class="main">∈</span> dom <span class="free">f</span> <span class="main">∧</span> snd<span class="main">(</span><span class="skolem">ob</span><span class="main">!</span><span class="skolem">k</span><span class="main">)</span> <span class="main">⊆</span> dom <span class="free">f</span>"</span></span> 
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">qed</span></span>

        <span class="comment1">(* prop#3 *)</span>
      <span class="keyword1"><span class="command">moreover</span></span> 
      <span class="keyword1"><span class="command">from</span></span> first <span class="quoted"><span class="quoted">‹fst<span class="main">(</span><span class="skolem">ob</span><span class="main">!</span><span class="main">0</span><span class="main">)</span> <span class="main">=</span> <span class="free">f</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fst<span class="main">(</span><span class="skolem">ob'</span><span class="main">!</span><span class="main">0</span><span class="main">)</span> <span class="main">=</span> <span class="free">f</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

        <span class="comment1">(* prop#4 *)</span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">from</span></span> obksnd finite_dom_fmap finite_subset 
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>snd <span class="main">(</span><span class="skolem">ob</span><span class="main">!</span><span class="skolem">k</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">from</span></span> card.insert_remove<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>insert <span class="skolem">l'</span> <span class="main">(</span>snd <span class="main">(</span><span class="skolem">ob</span><span class="main">!</span><span class="skolem">k</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Suc <span class="main">(</span>card <span class="main">(</span>snd<span class="main">(</span><span class="skolem">ob</span><span class="main">!</span><span class="skolem">k</span><span class="main">)</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">l'</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">l'</span> <span class="main">∉</span> snd <span class="main">(</span><span class="skolem">ob</span><span class="main">!</span><span class="skolem">k</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹card <span class="main">(</span>snd<span class="main">(</span><span class="skolem">ob</span><span class="main">!</span><span class="skolem">k</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">k</span>›</span></span> last
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card<span class="main">(</span>snd<span class="main">(</span><span class="skolem">ob'</span><span class="main">!</span>Suc <span class="skolem">k</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Suc <span class="skolem">k</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

        <span class="comment1">(* prop#5 *)</span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">i</span></span><span class="main">&lt;</span>Suc <span class="skolem">k</span><span class="main">.</span> snd <span class="main">(</span><span class="skolem">ob'</span><span class="main">!</span><span class="bound">i</span><span class="main">)</span> <span class="main">⊂</span> snd <span class="main">(</span><span class="skolem">ob'</span><span class="main">!</span>Suc <span class="skolem">k</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> strip<span class="main">)</span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="main">::</span> <span class="quoted">nat</span>
        <span class="keyword1"><span class="command">from</span></span> last <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"snd<span class="main">(</span><span class="skolem">ob'</span><span class="main">!</span>Suc <span class="skolem">k</span><span class="main">)</span> <span class="main">=</span> insert <span class="skolem">l'</span> <span class="main">(</span>snd <span class="main">(</span><span class="skolem">ob</span><span class="main">!</span><span class="skolem">k</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">l'</span> <span class="main">∉</span> snd <span class="main">(</span><span class="skolem">ob</span><span class="main">!</span><span class="skolem">k</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"snd<span class="main">(</span><span class="skolem">ob</span><span class="main">!</span><span class="skolem">k</span><span class="main">)</span> <span class="main">⊂</span> snd<span class="main">(</span><span class="skolem">ob'</span><span class="main">!</span>Suc <span class="skolem">k</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">moreover</span></span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> Suc <span class="skolem">k</span>"</span></span>
        <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹length <span class="skolem">ob</span> <span class="main">=</span> <span class="skolem">k</span> <span class="main">+</span> <span class="main">1</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="skolem">ob</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">with</span></span> nth_append<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">ob</span></span> <span class="main">_</span> <span class="quoted"><span class="skolem">i</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ob'</span><span class="main">!</span><span class="skolem">i</span> <span class="main">=</span> <span class="skolem">ob</span><span class="main">!</span><span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ob'_def<span class="main">)</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"snd<span class="main">(</span><span class="skolem">ob'</span><span class="main">!</span><span class="skolem">i</span><span class="main">)</span> <span class="main">⊂</span> snd<span class="main">(</span><span class="skolem">ob'</span><span class="main">!</span>Suc <span class="skolem">k</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> <span class="skolem">k</span>"</span></span><span class="main">)</span>
          <span class="keyword3"><span class="command">case</span></span> True 
          <span class="keyword1"><span class="command">with</span></span> 
            <span class="quoted"><span class="quoted">‹<span class="main">∀</span><span class="bound"><span class="bound">i</span></span><span class="main">&lt;</span><span class="skolem">k</span><span class="main">.</span> snd<span class="main">(</span><span class="skolem">ob</span><span class="main">!</span><span class="bound">i</span><span class="main">)</span> <span class="main">⊂</span> snd<span class="main">(</span><span class="skolem">ob</span><span class="main">!</span><span class="skolem">k</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">ob'</span><span class="main">!</span><span class="skolem">i</span> <span class="main">=</span> <span class="skolem">ob</span><span class="main">!</span><span class="skolem">i</span>›</span></span> 
            <span class="quoted"><span class="quoted">‹snd<span class="main">(</span><span class="skolem">ob</span><span class="main">!</span><span class="skolem">k</span><span class="main">)</span> <span class="main">⊂</span> snd<span class="main">(</span><span class="skolem">ob'</span><span class="main">!</span>Suc <span class="skolem">k</span><span class="main">)</span>›</span></span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span><span class="skolem">ob'</span><span class="main">!</span><span class="skolem">i</span><span class="main">)</span> <span class="main">⊂</span> snd <span class="main">(</span><span class="skolem">ob'</span><span class="main">!</span>Suc <span class="skolem">k</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> False <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">&lt;</span> Suc <span class="skolem">k</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">=</span> <span class="skolem">k</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">arith</span>
          <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">ob'</span><span class="main">!</span><span class="skolem">i</span> <span class="main">=</span> <span class="skolem">ob</span><span class="main">!</span><span class="skolem">i</span>›</span></span> <span class="quoted"><span class="quoted">‹snd<span class="main">(</span><span class="skolem">ob</span><span class="main">!</span><span class="skolem">k</span><span class="main">)</span> <span class="main">⊂</span> snd<span class="main">(</span><span class="skolem">ob'</span><span class="main">!</span>Suc <span class="skolem">k</span><span class="main">)</span>›</span></span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span><span class="skolem">ob'</span><span class="main">!</span><span class="skolem">i</span><span class="main">)</span> <span class="main">⊂</span> snd <span class="main">(</span><span class="skolem">ob'</span><span class="main">!</span>Suc <span class="skolem">k</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">qed</span></span>

        <span class="comment1">(* prop#6 -- the main statement *)</span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">{</span></span>
        <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">l'</span> <span class="main">∈</span> dom <span class="free">f</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">l'</span> <span class="main">∉</span> snd<span class="main">(</span><span class="skolem">ob</span><span class="main">!</span><span class="skolem">k</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l'</span> <span class="main">∈</span> <span class="main">(</span>dom <span class="free">f</span> <span class="main">-</span> snd<span class="main">(</span><span class="skolem">ob</span><span class="main">!</span><span class="skolem">k</span><span class="main">)</span><span class="main">)</span>"</span></span> 
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">with</span></span> ass <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"the<span class="main">(</span>fst<span class="main">(</span><span class="skolem">ob</span><span class="main">!</span><span class="skolem">k</span><span class="main">)</span> <span class="skolem">l'</span><span class="main">)</span> <span class="main">=</span> the<span class="main">(</span><span class="free">f</span> <span class="skolem">l'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
        <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">l'</span> <span class="main">∈</span> dom <span class="free">f</span>›</span></span> assms<span class="main">(</span>2<span class="main">)</span>
        <span class="keyword1"><span class="command">have</span></span> 
          sp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">s</span> <span class="bound">p</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∉</span> <span class="free">L</span> <span class="main">∧</span> <span class="bound">p</span> <span class="main">∉</span> <span class="free">L</span> <span class="main">∧</span> <span class="bound">s</span> <span class="main">≠</span> <span class="bound">p</span> 
                <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">t''</span><span class="main">.</span> the<span class="main">(</span>fst<span class="main">(</span><span class="skolem">ob</span><span class="main">!</span><span class="skolem">k</span><span class="main">)</span> <span class="skolem">l'</span><span class="main">)</span><span class="hidden">⇗</span><sup>[Fvar <span class="bound">s</span><span class="main">,</span>Fvar <span class="bound">p</span>]</sup><span class="hidden">⇖</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>β</sub><span class="hidden">⇧</span><sup>*</sup></span> <span class="bound">t''</span> 
                         <span class="main">∧</span> the <span class="main">(</span><span class="free">g</span> <span class="skolem">l'</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">σ[</span><span class="bound">s</span><span class="main">,</span><span class="bound">p</span><span class="main">]</span> <span class="bound">t''</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

        <span class="keyword1"><span class="command">moreover</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">l</span><span class="main">∈</span>dom <span class="main">(</span>fst<span class="main">(</span><span class="skolem">ob</span><span class="main">!</span><span class="skolem">k</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> body <span class="main">(</span>the<span class="main">(</span>fst<span class="main">(</span><span class="skolem">ob</span><span class="main">!</span><span class="skolem">k</span><span class="main">)</span> <span class="bound">l</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> strip<span class="main">)</span>
          <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">la</span> <span class="main">::</span> <span class="quoted">Label</span>
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">la</span> <span class="main">∈</span> dom <span class="main">(</span>fst<span class="main">(</span><span class="skolem">ob</span><span class="main">!</span><span class="skolem">k</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">with</span></span> obkfst <span class="keyword1"><span class="command">have</span></span> inf<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">la</span> <span class="main">∈</span> dom <span class="free">f</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">with</span></span> assms<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> bodyf<span class="main">:</span> <span class="quoted"><span class="quoted">"body <span class="main">(</span>the<span class="main">(</span><span class="free">f</span> <span class="skolem">la</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"body <span class="main">(</span>the<span class="main">(</span>fst<span class="main">(</span><span class="skolem">ob</span><span class="main">!</span><span class="skolem">k</span><span class="main">)</span> <span class="skolem">la</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">la</span> <span class="main">∈</span> snd<span class="main">(</span><span class="skolem">ob</span><span class="main">!</span><span class="skolem">k</span><span class="main">)</span>"</span></span><span class="main">)</span>
            <span class="keyword3"><span class="command">case</span></span> False <span class="keyword1"><span class="command">with</span></span> inf <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">la</span> <span class="main">∈</span> <span class="main">(</span>dom <span class="free">f</span> <span class="main">-</span> snd<span class="main">(</span><span class="skolem">ob</span><span class="main">!</span><span class="skolem">k</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">with</span></span> ass <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fst<span class="main">(</span><span class="skolem">ob</span><span class="main">!</span><span class="skolem">k</span><span class="main">)</span> <span class="skolem">la</span> <span class="main">=</span> <span class="free">f</span> <span class="skolem">la</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
            <span class="keyword1"><span class="command">with</span></span> bodyf <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"body <span class="main">(</span>the <span class="main">(</span>fst<span class="main">(</span><span class="skolem">ob</span><span class="main">!</span><span class="skolem">k</span><span class="main">)</span> <span class="skolem">la</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">next</span></span>
            <span class="keyword1"><span class="command">from</span></span> exFresh_s_p_cof<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹finite <span class="free">L</span>›</span></span><span class="main">]</span>
            <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∉</span> <span class="free">L</span> <span class="main">∧</span> <span class="skolem">p</span> <span class="main">∉</span> <span class="free">L</span> <span class="main">∧</span> <span class="skolem">s</span> <span class="main">≠</span> <span class="skolem">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">with</span></span> assms<span class="main">(</span>2<span class="main">)</span> inf
            <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t'</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
              <span class="quoted"><span class="quoted">"the <span class="main">(</span><span class="free">f</span> <span class="skolem">la</span><span class="main">)</span><span class="hidden">⇗</span><sup>[Fvar <span class="skolem">s</span><span class="main">,</span>Fvar <span class="skolem">p</span>]</sup><span class="hidden">⇖</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>β</sub><span class="hidden">⇧</span><sup>*</sup></span> <span class="skolem">t'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
              <span class="quoted"><span class="quoted">"the <span class="main">(</span><span class="free">g</span> <span class="skolem">la</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">σ[</span><span class="skolem">s</span><span class="main">,</span><span class="skolem">p</span><span class="main">]</span> <span class="skolem">t'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
            <span class="keyword1"><span class="command">from</span></span> body_lc<span class="main">[</span><span class="operator">OF</span> bodyf<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> lcf<span class="main">:</span> <span class="quoted"><span class="quoted">"lc <span class="main">(</span>the <span class="main">(</span><span class="free">f</span> <span class="skolem">la</span><span class="main">)</span><span class="hidden">⇗</span><sup>[Fvar <span class="skolem">s</span><span class="main">,</span>Fvar <span class="skolem">p</span>]</sup><span class="hidden">⇖</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">hence</span></span> bodyg<span class="main">:</span> <span class="quoted"><span class="quoted">"body <span class="main">(</span>the<span class="main">(</span><span class="free">g</span> <span class="skolem">la</span><span class="main">)</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>the <span class="main">(</span><span class="free">f</span> <span class="skolem">la</span><span class="main">)</span><span class="hidden">⇗</span><sup>[Fvar <span class="skolem">s</span><span class="main">,</span>Fvar <span class="skolem">p</span>]</sup><span class="hidden">⇖</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">t'</span>"</span></span><span class="main">)</span>
              <span class="keyword3"><span class="command">case</span></span> True 
              <span class="keyword1"><span class="command">with</span></span> 
                lcf lc_body <span class="quoted"><span class="quoted">‹<span class="skolem">s</span> <span class="main">∉</span> <span class="free">L</span> <span class="main">∧</span> <span class="skolem">p</span> <span class="main">∉</span> <span class="free">L</span> <span class="main">∧</span> <span class="skolem">s</span> <span class="main">≠</span> <span class="skolem">p</span>›</span></span> 
                <span class="quoted"><span class="quoted">‹the<span class="main">(</span><span class="free">g</span> <span class="skolem">la</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">σ[</span><span class="skolem">s</span><span class="main">,</span><span class="skolem">p</span><span class="main">]</span> <span class="skolem">t'</span>›</span></span>
              <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"body <span class="main">(</span>the<span class="main">(</span><span class="free">g</span> <span class="skolem">la</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">next</span></span>
              <span class="keyword3"><span class="command">case</span></span> False 
              <span class="keyword1"><span class="command">with</span></span> 
                rtrancl_beta_lc<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹the <span class="main">(</span><span class="free">f</span> <span class="skolem">la</span><span class="main">)</span><span class="hidden">⇗</span><sup>[Fvar <span class="skolem">s</span><span class="main">,</span>Fvar <span class="skolem">p</span>]</sup><span class="hidden">⇖</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>β</sub><span class="hidden">⇧</span><sup>*</sup></span> <span class="skolem">t'</span>›</span></span><span class="main">]</span> 
                lc_body <span class="quoted"><span class="quoted">‹<span class="skolem">s</span> <span class="main">∉</span> <span class="free">L</span> <span class="main">∧</span> <span class="skolem">p</span> <span class="main">∉</span> <span class="free">L</span> <span class="main">∧</span> <span class="skolem">s</span> <span class="main">≠</span> <span class="skolem">p</span>›</span></span> <span class="quoted"><span class="quoted">‹the<span class="main">(</span><span class="free">g</span> <span class="skolem">la</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">σ[</span><span class="skolem">s</span><span class="main">,</span><span class="skolem">p</span><span class="main">]</span> <span class="skolem">t'</span>›</span></span>
              <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"body <span class="main">(</span>the<span class="main">(</span><span class="free">g</span> <span class="skolem">la</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">qed</span></span>
            <span class="keyword3"><span class="command">case</span></span> True <span class="keyword1"><span class="command">with</span></span> ass bodyg <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"body <span class="main">(</span>the<span class="main">(</span>fst<span class="main">(</span><span class="skolem">ob</span><span class="main">!</span><span class="skolem">k</span><span class="main">)</span> <span class="skolem">la</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">qed</span></span>

        <span class="keyword1"><span class="command">moreover</span></span>
        <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">l'</span> <span class="main">∈</span> dom <span class="free">f</span>›</span></span> obkfst <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l'</span> <span class="main">∈</span> dom<span class="main">(</span>fst<span class="main">(</span><span class="skolem">ob</span><span class="main">!</span><span class="skolem">k</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">note</span></span> obj_lem<span class="main">[</span><span class="operator">OF</span> this <span class="quoted"><span class="quoted">‹finite <span class="free">L</span>›</span></span><span class="main">]</span>

        <span class="keyword1"><span class="command">ultimately</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Obj <span class="main">(</span>fst<span class="main">(</span><span class="skolem">ob</span><span class="main">!</span><span class="skolem">k</span><span class="main">)</span><span class="main">)</span> <span class="free">T</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>β</sub><span class="hidden">⇧</span><sup>*</sup></span> Obj <span class="main">(</span>fst<span class="main">(</span><span class="skolem">ob</span><span class="main">!</span><span class="skolem">k</span><span class="main">)</span><span class="main">(</span><span class="skolem">l'</span> <span class="main">↦</span> the <span class="main">(</span><span class="free">g</span> <span class="skolem">l'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">T</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

        <span class="keyword1"><span class="command">moreover</span></span>
        <span class="keyword1"><span class="command">from</span></span> last <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fst<span class="main">(</span><span class="skolem">ob'</span><span class="main">!</span>Suc <span class="skolem">k</span><span class="main">)</span> <span class="main">=</span> fst<span class="main">(</span><span class="skolem">ob</span><span class="main">!</span><span class="skolem">k</span><span class="main">)</span><span class="main">(</span><span class="skolem">l'</span> <span class="main">↦</span> the <span class="main">(</span><span class="free">g</span> <span class="skolem">l'</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

        <span class="keyword1"><span class="command">ultimately</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Obj <span class="main">(</span>fst<span class="main">(</span><span class="skolem">ob'</span><span class="main">!</span><span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="free">T</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>β</sub><span class="hidden">⇧</span><sup>*</sup></span> Obj <span class="main">(</span>fst<span class="main">(</span><span class="skolem">ob'</span><span class="main">!</span>Suc <span class="skolem">k</span><span class="main">)</span><span class="main">)</span> <span class="free">T</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> 
            rtranclp_trans<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹Obj <span class="main">(</span>fst <span class="main">(</span><span class="skolem">ob</span><span class="main">!</span><span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="free">T</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>β</sub><span class="hidden">⇧</span><sup>*</sup></span> Obj <span class="main">(</span>fst <span class="main">(</span><span class="skolem">ob</span><span class="main">!</span><span class="skolem">k</span><span class="main">)</span><span class="main">)</span> <span class="free">T</span>›</span></span><span class="main">]</span> first kth
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">}</span></span>

        <span class="comment1">(* prop#7 *)</span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">l'</span> <span class="main">∈</span> dom <span class="free">f</span>›</span></span> <span class="quoted"><span class="quoted">‹dom <span class="free">f</span> <span class="main">=</span> dom <span class="free">g</span>›</span></span>
      <span class="keyword1"><span class="command">have</span></span> 
        <span class="quoted"><span class="quoted">"card <span class="main">(</span>snd<span class="main">(</span><span class="skolem">ob'</span><span class="main">!</span>Suc <span class="skolem">k</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Suc <span class="skolem">k</span> 
         <span class="main">⟶</span> Ltake_eq <span class="main">(</span>snd <span class="main">(</span><span class="skolem">ob'</span><span class="main">!</span>Suc <span class="skolem">k</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>fst <span class="main">(</span><span class="skolem">ob'</span><span class="main">!</span>Suc <span class="skolem">k</span><span class="main">)</span><span class="main">)</span> <span class="free">g</span> 
             <span class="main">∧</span> Ltake_eq <span class="main">(</span>dom <span class="free">f</span> <span class="main">-</span> snd<span class="main">(</span><span class="skolem">ob'</span><span class="main">!</span>Suc <span class="skolem">k</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>fst<span class="main">(</span><span class="skolem">ob'</span><span class="main">!</span>Suc <span class="skolem">k</span><span class="main">)</span><span class="main">)</span> <span class="free">f</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Ltake_eq_def last ass<span class="main">)</span>
      
      <span class="keyword1"><span class="command">ultimately</span></span>
      <span class="keyword3"><span class="command">show</span></span> 
        <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">ob</span><span class="main">.</span> length <span class="bound">ob</span> <span class="main">=</span> Suc <span class="skolem">k</span> <span class="main">+</span> <span class="main">1</span> 
            <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">obi</span><span class="main">.</span> <span class="bound">obi</span> <span class="main">∈</span> set <span class="bound">ob</span> <span class="main">⟶</span> dom <span class="main">(</span>fst <span class="bound">obi</span><span class="main">)</span> <span class="main">=</span> dom <span class="free">f</span> <span class="main">∧</span> snd <span class="bound">obi</span> <span class="main">⊆</span> dom <span class="free">f</span><span class="main">)</span> 
            <span class="main">∧</span> fst <span class="main">(</span><span class="bound">ob</span> <span class="main">!</span> <span class="main">0</span><span class="main">)</span> <span class="main">=</span> <span class="free">f</span> 
            <span class="main">∧</span> card <span class="main">(</span>snd <span class="main">(</span><span class="bound">ob</span> <span class="main">!</span> Suc <span class="skolem">k</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Suc <span class="skolem">k</span> 
            <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">i</span></span><span class="main">&lt;</span>Suc <span class="skolem">k</span><span class="main">.</span> snd <span class="main">(</span><span class="bound">ob</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">⊂</span> snd <span class="main">(</span><span class="bound">ob</span> <span class="main">!</span> Suc <span class="skolem">k</span><span class="main">)</span><span class="main">)</span> 
            <span class="main">∧</span> Obj <span class="main">(</span>fst <span class="main">(</span><span class="bound">ob</span> <span class="main">!</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="free">T</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>β</sub><span class="hidden">⇧</span><sup>*</sup></span> Obj <span class="main">(</span>fst <span class="main">(</span><span class="bound">ob</span> <span class="main">!</span> Suc <span class="skolem">k</span><span class="main">)</span><span class="main">)</span> <span class="free">T</span> 
            <span class="main">∧</span> <span class="main">(</span>card <span class="main">(</span>snd <span class="main">(</span><span class="bound">ob</span> <span class="main">!</span> Suc <span class="skolem">k</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Suc <span class="skolem">k</span> 
               <span class="main">⟶</span> Ltake_eq <span class="main">(</span>snd <span class="main">(</span><span class="bound">ob</span> <span class="main">!</span> Suc <span class="skolem">k</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>fst <span class="main">(</span><span class="bound">ob</span> <span class="main">!</span> Suc <span class="skolem">k</span><span class="main">)</span><span class="main">)</span> <span class="free">g</span> 
                   <span class="main">∧</span> Ltake_eq <span class="main">(</span>dom <span class="free">f</span> <span class="main">-</span> snd <span class="main">(</span><span class="bound">ob</span> <span class="main">!</span> Suc <span class="skolem">k</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>fst <span class="main">(</span><span class="bound">ob</span> <span class="main">!</span> Suc <span class="skolem">k</span><span class="main">)</span><span class="main">)</span> <span class="free">f</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="skolem">ob'</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Sigma-rtrancl_beta_obj_n"><span class="command">lemma</span></span> rtrancl_beta_obj_n<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="free">g</span> <span class="free">L</span> <span class="free">T</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> 
  <span class="quoted"><span class="quoted">"finite <span class="free">L</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">l</span><span class="main">∈</span>dom <span class="free">f</span><span class="main">.</span> <span class="main">∀</span><span class="bound">s</span> <span class="bound">p</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∉</span> <span class="free">L</span> <span class="main">∧</span> <span class="bound">p</span> <span class="main">∉</span> <span class="free">L</span> <span class="main">∧</span> <span class="bound">s</span> <span class="main">≠</span> <span class="bound">p</span>
               <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">t''</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span>the<span class="main">(</span><span class="free">f</span> <span class="bound">l</span><span class="main">)</span><span class="main">)</span><span class="hidden">⇗</span><sup>[Fvar <span class="bound">s</span><span class="main">,</span> Fvar <span class="bound">p</span>]</sup><span class="hidden">⇖</span><span class="main">)</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>β</sub><span class="hidden">⇧</span><sup>*</sup></span> <span class="bound">t''</span> 
                        <span class="main">∧</span> the<span class="main">(</span><span class="free">g</span> <span class="bound">l</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">σ[</span><span class="bound">s</span><span class="main">,</span><span class="bound">p</span><span class="main">]</span><span class="bound">t''</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  <span class="quoted"><span class="quoted">"dom <span class="free">f</span> <span class="main">=</span> dom <span class="free">g</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">l</span><span class="main">∈</span>dom <span class="free">f</span><span class="main">.</span> body <span class="main">(</span>the<span class="main">(</span><span class="free">f</span> <span class="bound">l</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Obj <span class="free">f</span> <span class="free">T</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>β</sub><span class="hidden">⇧</span><sup>*</sup></span> Obj <span class="free">g</span> <span class="free">T</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">=</span> Map.empty"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹dom <span class="free">f</span> <span class="main">=</span> dom <span class="free">g</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{}</span> <span class="main">=</span> dom <span class="free">g</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="free">f</span> <span class="main">=</span> Map.empty›</span></span> empty_dom<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword1"><span class="command">from</span></span> rtrancl_beta_obj_lem00<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ob</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span>Label <span class="main">-~&gt;</span> sterm<span class="main">)</span> <span class="main">×</span> <span class="main">(</span>Label set<span class="main">)</span><span class="main">)</span> list"</span></span> 
    <span class="keyword2"><span class="keyword">where</span></span> 
    <span class="quoted"><span class="quoted">"length <span class="skolem">ob</span> <span class="main">=</span> card<span class="main">(</span>dom <span class="free">f</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">obi</span><span class="main">.</span> <span class="bound">obi</span> <span class="main">∈</span> set <span class="skolem">ob</span> <span class="main">⟶</span> dom <span class="main">(</span>fst <span class="bound">obi</span><span class="main">)</span> <span class="main">=</span> dom <span class="free">f</span> <span class="main">∧</span> snd <span class="bound">obi</span> <span class="main">⊆</span> dom <span class="free">f</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"fst<span class="main">(</span><span class="skolem">ob</span><span class="main">!</span><span class="main">0</span><span class="main">)</span> <span class="main">=</span> <span class="free">f</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"card <span class="main">(</span>snd<span class="main">(</span><span class="skolem">ob</span><span class="main">!</span>card<span class="main">(</span>dom <span class="free">f</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> card<span class="main">(</span>dom <span class="free">f</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"Obj <span class="main">(</span>fst<span class="main">(</span><span class="skolem">ob</span><span class="main">!</span><span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="free">T</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>β</sub><span class="hidden">⇧</span><sup>*</sup></span> Obj <span class="main">(</span>fst<span class="main">(</span><span class="skolem">ob</span><span class="main">!</span>card<span class="main">(</span>dom <span class="free">f</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">T</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"Ltake_eq <span class="main">(</span>snd<span class="main">(</span><span class="skolem">ob</span><span class="main">!</span>card<span class="main">(</span>dom <span class="free">f</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>fst<span class="main">(</span><span class="skolem">ob</span><span class="main">!</span>card<span class="main">(</span>dom <span class="free">f</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">g</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹length <span class="skolem">ob</span> <span class="main">=</span> card <span class="main">(</span>dom <span class="free">f</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">ob</span><span class="main">!</span>card<span class="main">(</span>dom <span class="free">f</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">ob</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span><span class="bound">obi</span><span class="main">.</span> <span class="bound">obi</span> <span class="main">∈</span> set <span class="skolem">ob</span> <span class="main">⟶</span> dom <span class="main">(</span>fst <span class="bound">obi</span><span class="main">)</span> <span class="main">=</span> dom <span class="free">f</span> <span class="main">∧</span> snd <span class="bound">obi</span> <span class="main">⊆</span> dom <span class="free">f</span>›</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"dom <span class="main">(</span>fst<span class="main">(</span><span class="skolem">ob</span><span class="main">!</span>card<span class="main">(</span>dom <span class="free">f</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> dom <span class="free">f</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"snd<span class="main">(</span><span class="skolem">ob</span><span class="main">!</span>card<span class="main">(</span>dom <span class="free">f</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> dom <span class="free">f</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>

  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">l</span> <span class="main">::</span> <span class="quoted">Label</span>
    <span class="keyword1"><span class="command">from</span></span> 
      <span class="quoted"><span class="quoted">‹snd<span class="main">(</span><span class="skolem">ob</span><span class="main">!</span>card<span class="main">(</span>dom <span class="free">f</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> dom <span class="free">f</span>›</span></span> <span class="quoted"><span class="quoted">‹card <span class="main">(</span>snd<span class="main">(</span><span class="skolem">ob</span><span class="main">!</span>card<span class="main">(</span>dom <span class="free">f</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> card<span class="main">(</span>dom <span class="free">f</span><span class="main">)</span>›</span></span>
      Ltake_eq_dom
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"snd<span class="main">(</span><span class="skolem">ob</span><span class="main">!</span>card<span class="main">(</span>dom <span class="free">f</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> dom <span class="free">f</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹Ltake_eq <span class="main">(</span>snd<span class="main">(</span><span class="skolem">ob</span><span class="main">!</span>card <span class="main">(</span>dom <span class="free">f</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>fst<span class="main">(</span><span class="skolem">ob</span><span class="main">!</span>card <span class="main">(</span>dom <span class="free">f</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">g</span>›</span></span> 
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fst<span class="main">(</span><span class="skolem">ob</span><span class="main">!</span>card<span class="main">(</span>dom <span class="free">f</span><span class="main">)</span><span class="main">)</span> <span class="skolem">l</span> <span class="main">=</span> <span class="free">g</span> <span class="skolem">l</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">∈</span> dom <span class="free">f</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Ltake_eq_def<span class="main">)</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">∉</span> dom <span class="free">f</span>"</span></span> 
      <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹dom <span class="free">f</span> <span class="main">=</span> dom <span class="free">g</span>›</span></span> <span class="quoted"><span class="quoted">‹dom <span class="main">(</span>fst<span class="main">(</span><span class="skolem">ob</span><span class="main">!</span>card<span class="main">(</span>dom <span class="free">f</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> dom <span class="free">f</span>›</span></span> 
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"fst<span class="main">(</span><span class="skolem">ob</span><span class="main">!</span>card<span class="main">(</span>dom <span class="free">f</span><span class="main">)</span><span class="main">)</span> <span class="skolem">l</span> <span class="main">=</span> <span class="free">g</span> <span class="skolem">l</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">with</span></span> ext <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fst<span class="main">(</span><span class="skolem">ob</span><span class="main">!</span>card<span class="main">(</span>dom <span class="free">f</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">g</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹fst<span class="main">(</span><span class="skolem">ob</span><span class="main">!</span><span class="main">0</span><span class="main">)</span> <span class="main">=</span> <span class="free">f</span>›</span></span> <span class="quoted"><span class="quoted">‹Obj <span class="main">(</span>fst<span class="main">(</span><span class="skolem">ob</span><span class="main">!</span><span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="free">T</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>β</sub><span class="hidden">⇧</span><sup>*</sup></span> Obj <span class="main">(</span>fst<span class="main">(</span><span class="skolem">ob</span><span class="main">!</span>card <span class="main">(</span>dom <span class="free">f</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">T</span>›</span></span> 
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Obj <span class="free">f</span> <span class="free">T</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>β</sub><span class="hidden">⇧</span><sup>*</sup></span> Obj <span class="free">g</span> <span class="free">T</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Size of sterms›</span></span>

<span class="comment1">(* this section defines the size of sterms 
compared to size, the size of an object is the sum of the size of its fields +1 *)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">fsize0</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Label <span class="main">-~&gt;</span> sterm<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span>sterm <span class="main">⇒</span> nat<span class="main">)</span> <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">fsize0</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">sts</span></span></span> <span class="main">=</span>
    foldl <span class="main">(+)</span> <span class="main">0</span> <span class="main">(</span>map <span class="free"><span class="bound"><span class="entity">sts</span></span></span> <span class="main">(</span>Finite_Set.fold <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">z</span><span class="main">.</span> <span class="bound">z</span><span class="main">@</span><span class="main">[</span><span class="keyword1">THE</span> <span class="bound">y</span><span class="main">.</span> Some <span class="bound">y</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">x</span><span class="main">]</span><span class="main">)</span> <span class="main">[]</span> <span class="main">(</span>dom <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">primrec</span></span>
 <span class="entity">ssize</span>        <span class="main">::</span> <span class="quoted"><span class="quoted">"sterm <span class="main">⇒</span> nat"</span></span> 
<span class="keyword2"><span class="keyword">and</span></span>
 <span class="entity">ssize_option</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"sterm option <span class="main">⇒</span> nat"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  ssize_Bvar <span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ssize</span> <span class="main">(</span>Bvar <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
<span class="main">|</span> ssize_Fvar <span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ssize</span> <span class="main">(</span>Fvar <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
<span class="main">|</span> ssize_Call <span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ssize</span> <span class="main">(</span>Call <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">ssize</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="free">ssize</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="main">+</span> Suc <span class="main">0</span>"</span></span>
<span class="main">|</span> ssize_Upd  <span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ssize</span> <span class="main">(</span>Upd <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">ssize</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="free">ssize</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="main">+</span> Suc <span class="main">0</span>"</span></span> 
<span class="main">|</span> ssize_Obj  <span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ssize</span> <span class="main">(</span>Obj <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main">)</span> <span class="main">=</span> Finite_Set.fold <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">+</span> <span class="free">ssize_option</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span> <span class="main">(</span>dom <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> ssize_None <span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ssize_option</span> <span class="main">(</span>None<span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
<span class="main">|</span> ssize_Some <span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ssize_option</span> <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">ssize</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">+</span> Suc <span class="main">0</span>"</span></span>

<span class="comment1">(* We need this locale, as all the handy functions are there now *)</span>
<span class="keyword1"><span class="command">interpretation</span></span> comp_fun_commute <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">y</span><span class="main">::</span>nat<span class="main">.</span> <span class="bound">y</span> <span class="main">+</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold</span> comp_fun_commute_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">force</span><span class="main">)</span>

<span class="keyword1" id="Sigma-SizeOfObjectPos"><span class="command">lemma</span></span> SizeOfObjectPos<span class="main">:</span> <span class="quoted"><span class="quoted">"ssize <span class="main">(</span>Obj <span class="main">(</span><span class="free">f</span><span class="main">::</span>Label <span class="main">-~&gt;</span> sterm<span class="main">)</span> <span class="free">T</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> finite_dom_fmap <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>dom <span class="free">f</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> Finite_Set.fold <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">+</span> ssize_option <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span> <span class="main">(</span>dom <span class="free">f</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> empty <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>insert <span class="skolem">A</span> <span class="skolem">a</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="ParRed">
<div class="head">
<h1>Theory ParRed</h1>
</div>
<pre class="source"><span class="comment1">(*  Title:      Sigma/ParRed.thy
    Author:     Ludovic Henrio and Florian Kammuller
    Copyright   2006

Confluence of beta for ASP, based on the equally named file in HOL/Proofs/Lambda.
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Parallel reduction›</span></span>

<span class="keyword1"><span class="command">theory</span></span> ParRed <span class="keyword2"><span class="keyword">imports</span></span> <span class="quoted">"<a href="https://www.cl.cam.ac.uk/research/hvg/Isabelle/dist/library/HOL/HOL-Proofs-Lambda/Commutation.html">HOL-Proofs-Lambda.Commutation</a>"</span> <a href="#Sigma">Sigma</a> <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Parallel reduction›</span></span>
<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">par_beta</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>sterm<span class="main">,</span>sterm<span class="main">]</span> <span class="main">⇒</span> bool"</span></span>  <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span>"</span> 50<span class="main">)</span>
  <span class="keyword2"><span class="keyword">where</span></span>
  pbeta_Fvar<span class="main">[</span><span class="operator">simp</span><span class="main">,</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Fvar <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="keyword1"><span class="free">⇒<span class="hidden">⇩</span><sub>β</sub></span></span> Fvar <span class="free"><span class="bound"><span class="entity">x</span></span></span>"</span></span>
<span class="main">|</span> pbeta_Obj<span class="main">[</span><span class="operator">simp</span><span class="main">,</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span> <span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> dom <span class="free"><span class="bound"><span class="entity">f'</span></span></span> <span class="main">=</span> dom <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">;</span> finite <span class="free"><span class="bound"><span class="entity">L</span></span></span><span class="main">;</span>
     <span class="main">∀</span><span class="bound">l</span><span class="main">∈</span>dom <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">.</span> <span class="main">∀</span><span class="bound">s</span> <span class="bound">p</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∉</span> <span class="free"><span class="bound"><span class="entity">L</span></span></span> <span class="main">∧</span> <span class="bound">p</span> <span class="main">∉</span> <span class="free"><span class="bound"><span class="entity">L</span></span></span> <span class="main">∧</span> <span class="bound">s</span> <span class="main">≠</span> <span class="bound">p</span> 
                 <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">t</span><span class="main">.</span> <span class="main">(</span>the<span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">l</span><span class="main">)</span><span class="hidden">⇗</span><sup>[Fvar <span class="bound">s</span><span class="main">,</span> Fvar <span class="bound">p</span>]</sup><span class="hidden">⇖</span><span class="main">)</span> <span class="keyword1"><span class="free">⇒<span class="hidden">⇩</span><sub>β</sub></span></span> <span class="bound">t</span> 
                        <span class="main">∧</span> the<span class="main">(</span><span class="free"><span class="bound"><span class="entity">f'</span></span></span> <span class="bound">l</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">σ[</span><span class="bound">s</span><span class="main">,</span><span class="bound">p</span><span class="main">]</span> <span class="bound">t</span><span class="main">)</span><span class="main">;</span>
     <span class="main">∀</span><span class="bound">l</span><span class="main">∈</span>dom <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">.</span> body <span class="main">(</span>the<span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">l</span><span class="main">)</span><span class="main">)</span> <span class="main">⟧</span> <span class="main">⟹</span> Obj <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="keyword1"><span class="free">⇒<span class="hidden">⇩</span><sub>β</sub></span></span> Obj <span class="free"><span class="bound"><span class="entity">f'</span></span></span> <span class="free"><span class="bound"><span class="entity">T</span></span></span>"</span></span>
<span class="main">|</span> pbeta_Upd<span class="main">[</span><span class="operator">simp</span><span class="main">,</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span> <span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1"><span class="free">⇒<span class="hidden">⇩</span><sub>β</sub></span></span> <span class="free"><span class="bound"><span class="entity">t'</span></span></span><span class="main">;</span> lc <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">;</span> finite <span class="free"><span class="bound"><span class="entity">L</span></span></span><span class="main">;</span> 
     <span class="main">∀</span><span class="bound">s</span> <span class="bound">p</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∉</span> <span class="free"><span class="bound"><span class="entity">L</span></span></span> <span class="main">∧</span> <span class="bound">p</span> <span class="main">∉</span> <span class="free"><span class="bound"><span class="entity">L</span></span></span> <span class="main">∧</span> <span class="bound">s</span> <span class="main">≠</span> <span class="bound">p</span>
      <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">t''</span><span class="main">.</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="hidden">⇗</span><sup>[Fvar <span class="bound">s</span><span class="main">,</span> Fvar <span class="bound">p</span>]</sup><span class="hidden">⇖</span><span class="main">)</span> <span class="keyword1"><span class="free">⇒<span class="hidden">⇩</span><sub>β</sub></span></span> <span class="bound">t''</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">u'</span></span></span> <span class="main">=</span> <span class="keyword1">σ[</span><span class="bound">s</span><span class="main">,</span><span class="bound">p</span><span class="main">]</span> <span class="bound">t''</span><span class="main">)</span><span class="main">;</span>
     body <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="main">⟧</span> <span class="main">⟹</span> Upd <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="keyword1"><span class="free">⇒<span class="hidden">⇩</span><sub>β</sub></span></span> Upd <span class="free"><span class="bound"><span class="entity">t'</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">u'</span></span></span>"</span></span>
<span class="main">|</span> pbeta_Upd'<span class="main">[</span><span class="operator">simp</span><span class="main">,</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> Obj <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="keyword1"><span class="free">⇒<span class="hidden">⇩</span><sub>β</sub></span></span> Obj <span class="free"><span class="bound"><span class="entity">f'</span></span></span> <span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main">;</span> finite <span class="free"><span class="bound"><span class="entity">L</span></span></span><span class="main">;</span>
     <span class="main">∀</span><span class="bound">s</span> <span class="bound">p</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∉</span> <span class="free"><span class="bound"><span class="entity">L</span></span></span> <span class="main">∧</span> <span class="bound">p</span> <span class="main">∉</span> <span class="free"><span class="bound"><span class="entity">L</span></span></span> <span class="main">∧</span> <span class="bound">s</span> <span class="main">≠</span> <span class="bound">p</span>
       <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">t''</span><span class="main">.</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="hidden">⇗</span><sup>[Fvar <span class="bound">s</span><span class="main">,</span> Fvar <span class="bound">p</span>]</sup><span class="hidden">⇖</span><span class="main">)</span> <span class="keyword1"><span class="free">⇒<span class="hidden">⇩</span><sub>β</sub></span></span> <span class="bound">t''</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">t'</span></span></span> <span class="main">=</span> <span class="keyword1">σ[</span><span class="bound">s</span><span class="main">,</span><span class="bound">p</span><span class="main">]</span> <span class="bound">t''</span><span class="main">)</span><span class="main">;</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">∈</span> dom <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">;</span>
     lc <span class="main">(</span>Obj <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main">)</span><span class="main">;</span> body <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span>Upd <span class="main">(</span>Obj <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span>  <span class="keyword1"><span class="free">⇒<span class="hidden">⇩</span><sub>β</sub></span></span> <span class="main">(</span>Obj <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f'</span></span></span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">↦</span> <span class="free"><span class="bound"><span class="entity">t'</span></span></span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> pbeta_Call<span class="main">[</span><span class="operator">simp</span><span class="main">,</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1"><span class="free">⇒<span class="hidden">⇩</span><sub>β</sub></span></span> <span class="free"><span class="bound"><span class="entity">t'</span></span></span><span class="main">;</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="keyword1"><span class="free">⇒<span class="hidden">⇩</span><sub>β</sub></span></span> <span class="free"><span class="bound"><span class="entity">u'</span></span></span><span class="main">;</span> lc <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">;</span> lc <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="main">⟧</span>
  <span class="main">⟹</span> Call <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="keyword1"><span class="free">⇒<span class="hidden">⇩</span><sub>β</sub></span></span> Call <span class="free"><span class="bound"><span class="entity">t'</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">u'</span></span></span>"</span></span>
<span class="main">|</span> pbeta_beta<span class="main">[</span><span class="operator">simp</span><span class="main">,</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> Obj <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="keyword1"><span class="free">⇒<span class="hidden">⇩</span><sub>β</sub></span></span> Obj <span class="free"><span class="bound"><span class="entity">f'</span></span></span> <span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main">;</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">∈</span> dom <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">;</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="keyword1"><span class="free">⇒<span class="hidden">⇩</span><sub>β</sub></span></span> <span class="free"><span class="bound"><span class="entity">p'</span></span></span><span class="main">;</span> lc <span class="main">(</span>Obj <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main">)</span><span class="main">;</span> lc <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">⟧</span>
  <span class="main">⟹</span> Call <span class="main">(</span>Obj <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="keyword1"><span class="free">⇒<span class="hidden">⇩</span><sub>β</sub></span></span> <span class="main">(</span>the<span class="main">(</span><span class="free"><span class="bound"><span class="entity">f'</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span><span class="hidden">⇗</span><sup>[<span class="main">(</span>Obj <span class="free"><span class="bound"><span class="entity">f'</span></span></span> <span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main">)</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">p'</span></span></span>]</sup><span class="hidden">⇖</span><span class="main">)</span>"</span></span>

<span class="comment1">(* These are rule formats for inversions rules *)</span>

<span class="keyword1"><span class="command">inductive_cases</span></span> par_beta_cases <span class="main">[</span><span class="operator">elim</span><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span></span></span></span></span></span></span></span></span></span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"Fvar <span class="free">x</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> <span class="free">t</span>"</span></span>
  <span class="quoted"><span class="quoted">"Obj <span class="free">f</span> <span class="free">T</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> <span class="free">t</span>"</span></span>
  <span class="quoted"><span class="quoted">"Call <span class="free">f</span> <span class="free">l</span> <span class="free">p</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> <span class="free">t</span>"</span></span>
  <span class="quoted"><span class="quoted">"Upd <span class="free">f</span> <span class="free">l</span> <span class="free">t</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> <span class="free">u</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span>
  <span class="entity">par_beta_ascii</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>sterm<span class="main">,</span> sterm<span class="main">]</span> <span class="main">=&gt;</span> bool"</span></span>  <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">=&gt;</span>"</span> 50<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main"><span class="free">=&gt;</span></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="main">==</span> par_beta <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span>"</span></span>

<span class="keyword1" id="ParRed-Obj_par_red"><span class="command">lemma</span></span> Obj_par_red<span class="main">[</span><span class="operator">consumes</span> 1<span class="main">,</span> <span class="operator">case_names</span> obj<span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> Obj <span class="free">f</span> <span class="free">T</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> <span class="free">z</span><span class="main">;</span> 
     <span class="main">⋀</span><span class="bound">lz</span><span class="main">.</span> <span class="main">⟦</span> dom <span class="bound">lz</span> <span class="main">=</span> dom <span class="free">f</span><span class="main">;</span> <span class="free">z</span> <span class="main">=</span> Obj <span class="bound">lz</span> <span class="free">T</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">Q</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">Q</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> par_beta_cases<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">assumption</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="ParRed-Upd_par_red"><span class="command">lemma</span></span> Upd_par_red<span class="main">[</span><span class="operator">consumes</span> 1<span class="main">,</span> <span class="operator">case_names</span> upd obj<span class="main">]</span><span class="main">:</span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">t</span> <span class="free">l</span> <span class="free">u</span> <span class="free">z</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> 
  <span class="quoted"><span class="quoted">"Upd <span class="free">t</span> <span class="free">l</span> <span class="free">u</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> <span class="free">z</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">t'</span> <span class="bound">u'</span> <span class="bound">L</span><span class="main">.</span> <span class="main">⟦</span> <span class="free">t</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> <span class="bound">t'</span><span class="main">;</span> finite <span class="bound">L</span><span class="main">;</span>
                <span class="main">∀</span><span class="bound">s</span> <span class="bound">p</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∉</span> <span class="bound">L</span> <span class="main">∧</span> <span class="bound">p</span> <span class="main">∉</span> <span class="bound">L</span> <span class="main">∧</span> <span class="bound">s</span> <span class="main">≠</span> <span class="bound">p</span> 
                 <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">t''</span><span class="main">.</span> <span class="main">(</span><span class="free">u</span><span class="hidden">⇗</span><sup>[Fvar <span class="bound">s</span><span class="main">,</span> Fvar <span class="bound">p</span>]</sup><span class="hidden">⇖</span><span class="main">)</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> <span class="bound">t''</span> 
                          <span class="main">∧</span> <span class="bound">u'</span> <span class="main">=</span> <span class="keyword1">σ[</span><span class="bound">s</span><span class="main">,</span><span class="bound">p</span><span class="main">]</span><span class="bound">t''</span><span class="main">)</span><span class="main">;</span>
                <span class="free">z</span> <span class="main">=</span> Upd <span class="bound">t'</span> <span class="free">l</span> <span class="bound">u'</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">Q</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">f</span> <span class="bound">f'</span> <span class="bound">T</span> <span class="bound">u'</span> <span class="bound">L</span><span class="main">.</span> <span class="main">⟦</span> <span class="free">l</span> <span class="main">∈</span> dom <span class="bound">f</span><span class="main">;</span> Obj <span class="bound">f</span> <span class="bound">T</span> <span class="main">=</span> <span class="free">t</span><span class="main">;</span> Obj <span class="bound">f</span> <span class="bound">T</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> Obj <span class="bound">f'</span> <span class="bound">T</span><span class="main">;</span>
                    finite <span class="bound">L</span><span class="main">;</span>
                    <span class="main">∀</span><span class="bound">s</span> <span class="bound">p</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∉</span> <span class="bound">L</span> <span class="main">∧</span> <span class="bound">p</span> <span class="main">∉</span> <span class="bound">L</span> <span class="main">∧</span> <span class="bound">s</span> <span class="main">≠</span> <span class="bound">p</span> 
                     <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">t''</span><span class="main">.</span> <span class="main">(</span><span class="free">u</span><span class="hidden">⇗</span><sup>[Fvar <span class="bound">s</span><span class="main">,</span> Fvar <span class="bound">p</span>]</sup><span class="hidden">⇖</span><span class="main">)</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> <span class="bound">t''</span> 
                              <span class="main">∧</span> <span class="bound">u'</span> <span class="main">=</span> <span class="keyword1">σ[</span><span class="bound">s</span><span class="main">,</span><span class="bound">p</span><span class="main">]</span><span class="bound">t''</span><span class="main">)</span><span class="main">;</span>
                <span class="free">z</span> <span class="main">=</span> Obj <span class="main">(</span><span class="bound">f'</span><span class="main">(</span><span class="free">l</span> <span class="main">↦</span> <span class="bound">u'</span><span class="main">)</span><span class="main">)</span> <span class="bound">T</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">Q</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="free">Q</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> par_beta.cases<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> pbeta_Upd <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> pbeta_Upd'
  <span class="keyword1"><span class="command">from</span></span> this<span class="main">(</span>1-2<span class="main">)</span> this<span class="main">(</span>5-6<span class="main">)</span> assms<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> _ _ this<span class="main"><span class="main">(</span></span>3-4<span class="main"><span class="main">)</span></span><span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="ParRed-Call_par_red"><span class="command">lemma</span></span> Call_par_red<span class="main">[</span><span class="operator">consumes</span> 1<span class="main">,</span> <span class="operator">case_names</span> call beta<span class="main">]</span><span class="main">:</span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">s</span> <span class="free">l</span> <span class="free">u</span> <span class="free">z</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> 
  <span class="quoted"><span class="quoted">"Call <span class="free">s</span> <span class="free">l</span> <span class="free">u</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> <span class="free">z</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">t</span> <span class="bound">u'</span><span class="main">.</span> <span class="main">⟦</span> <span class="free">s</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> <span class="bound">t</span><span class="main">;</span> <span class="free">u</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> <span class="bound">u'</span><span class="main">;</span> <span class="free">z</span> <span class="main">=</span> Call <span class="bound">t</span> <span class="free">l</span> <span class="bound">u'</span> <span class="main">⟧</span>
  <span class="main">⟹</span> <span class="free">Q</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">f</span> <span class="bound">f'</span> <span class="bound">T</span> <span class="bound">u'</span><span class="main">.</span> <span class="main">⟦</span> Obj <span class="bound">f</span> <span class="bound">T</span> <span class="main">=</span> <span class="free">s</span><span class="main">;</span> Obj <span class="bound">f</span> <span class="bound">T</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> Obj <span class="bound">f'</span> <span class="bound">T</span><span class="main">;</span>
                  <span class="free">l</span> <span class="main">∈</span> dom <span class="bound">f'</span><span class="main">;</span> <span class="free">u</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> <span class="bound">u'</span><span class="main">;</span>
                  <span class="free">z</span> <span class="main">=</span> <span class="main">(</span>the <span class="main">(</span><span class="bound">f'</span> <span class="free">l</span><span class="main">)</span><span class="hidden">⇗</span><sup>[Obj <span class="bound">f'</span> <span class="bound">T</span><span class="main">,</span> <span class="bound">u'</span>]</sup><span class="hidden">⇖</span><span class="main">)</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">Q</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="free">Q</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> par_beta.cases<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> pbeta_Call <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> pbeta_beta
  <span class="keyword1"><span class="command">from</span></span> this<span class="main">(</span>1-5<span class="main">)</span> assms<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> _ this<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="ParRed-pbeta_induct"><span class="command">lemma</span></span> pbeta_induct<span class="main">[</span><span class="operator">consumes</span> 1<span class="main">,</span> <span class="operator">case_names</span> Fvar Call Upd Upd' Obj beta Bnd<span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> 
  <span class="free">t</span> <span class="main">::</span> <span class="quoted">sterm</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">t'</span> <span class="main">::</span> <span class="quoted">sterm</span> <span class="keyword2"><span class="keyword">and</span></span> 
  <span class="free">P1</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"sterm <span class="main">⇒</span> sterm <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">P2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"sterm <span class="main">⇒</span> sterm <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> <span class="free">t'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="free">P1</span> <span class="main">(</span>Fvar <span class="bound">x</span><span class="main">)</span> <span class="main">(</span>Fvar <span class="bound">x</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">t</span> <span class="bound">t'</span> <span class="bound">l</span> <span class="bound">u</span> <span class="bound">u'</span><span class="main">.</span> <span class="main">⟦</span> <span class="bound">t</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> <span class="bound">t'</span><span class="main">;</span> <span class="free">P1</span> <span class="bound">t</span> <span class="bound">t'</span><span class="main">;</span> lc <span class="bound">t</span><span class="main">;</span> <span class="bound">u</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> <span class="bound">u'</span><span class="main">;</span> <span class="free">P1</span> <span class="bound">u</span> <span class="bound">u'</span><span class="main">;</span> lc <span class="bound">u</span> <span class="main">⟧</span> 
      <span class="main">⟹</span> <span class="free">P1</span> <span class="main">(</span>Call <span class="bound">t</span> <span class="bound">l</span> <span class="bound">u</span><span class="main">)</span> <span class="main">(</span>Call <span class="bound">t'</span> <span class="bound">l</span> <span class="bound">u'</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">t</span> <span class="bound">t'</span> <span class="bound">l</span> <span class="bound">u</span> <span class="bound">u'</span><span class="main">.</span> <span class="main">⟦</span> <span class="bound">t</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> <span class="bound">t'</span><span class="main">;</span> <span class="free">P1</span> <span class="bound">t</span> <span class="bound">t'</span><span class="main">;</span> lc <span class="bound">t</span><span class="main">;</span> <span class="free">P2</span> <span class="bound">u</span> <span class="bound">u'</span><span class="main">;</span> body <span class="bound">u</span> <span class="main">⟧</span>
      <span class="main">⟹</span> <span class="free">P1</span> <span class="main">(</span>Upd <span class="bound">t</span> <span class="bound">l</span> <span class="bound">u</span><span class="main">)</span> <span class="main">(</span>Upd <span class="bound">t'</span> <span class="bound">l</span> <span class="bound">u'</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">f</span> <span class="bound">f'</span> <span class="bound">T</span> <span class="bound">t</span> <span class="bound">t'</span> <span class="bound">l</span><span class="main">.</span> <span class="main">⟦</span> Obj <span class="bound">f</span> <span class="bound">T</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> Obj <span class="bound">f'</span> <span class="bound">T</span><span class="main">;</span> <span class="free">P1</span> <span class="main">(</span>Obj <span class="bound">f</span> <span class="bound">T</span><span class="main">)</span> <span class="main">(</span>Obj <span class="bound">f'</span> <span class="bound">T</span><span class="main">)</span><span class="main">;</span>
                      <span class="free">P2</span> <span class="bound">t</span> <span class="bound">t'</span><span class="main">;</span> <span class="bound">l</span> <span class="main">∈</span> dom <span class="bound">f</span><span class="main">;</span> lc <span class="main">(</span>Obj <span class="bound">f</span> <span class="bound">T</span><span class="main">)</span><span class="main">;</span> body <span class="bound">t</span> <span class="main">⟧</span>
      <span class="main">⟹</span> <span class="free">P1</span> <span class="main">(</span>Upd <span class="main">(</span>Obj <span class="bound">f</span> <span class="bound">T</span><span class="main">)</span> <span class="bound">l</span> <span class="bound">t</span><span class="main">)</span> <span class="main">(</span>Obj <span class="main">(</span><span class="bound">f'</span><span class="main">(</span><span class="bound">l</span> <span class="main">↦</span> <span class="bound">t'</span><span class="main">)</span><span class="main">)</span> <span class="bound">T</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">f</span> <span class="bound">f'</span> <span class="bound">T</span><span class="main">.</span> <span class="main">⟦</span> dom <span class="bound">f'</span> <span class="main">=</span> dom <span class="bound">f</span><span class="main">;</span> <span class="main">∀</span><span class="bound">l</span><span class="main">∈</span>dom <span class="bound">f</span><span class="main">.</span> body <span class="main">(</span>the<span class="main">(</span><span class="bound">f</span> <span class="bound">l</span><span class="main">)</span><span class="main">)</span><span class="main">;</span> 
               <span class="main">∀</span><span class="bound">l</span><span class="main">∈</span>dom <span class="bound">f</span><span class="main">.</span> <span class="free">P2</span> <span class="main">(</span>the<span class="main">(</span><span class="bound">f</span> <span class="bound">l</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>the<span class="main">(</span><span class="bound">f'</span> <span class="bound">l</span><span class="main">)</span><span class="main">)</span> <span class="main">⟧</span>
      <span class="main">⟹</span> <span class="free">P1</span> <span class="main">(</span>Obj <span class="bound">f</span> <span class="bound">T</span><span class="main">)</span> <span class="main">(</span>Obj <span class="bound">f'</span> <span class="bound">T</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">f</span> <span class="bound">f'</span> <span class="bound">T</span> <span class="bound">l</span> <span class="bound">p</span> <span class="bound">p'</span><span class="main">.</span> <span class="main">⟦</span> Obj <span class="bound">f</span> <span class="bound">T</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> Obj <span class="bound">f'</span> <span class="bound">T</span><span class="main">;</span> <span class="free">P1</span> <span class="main">(</span>Obj <span class="bound">f</span> <span class="bound">T</span><span class="main">)</span> <span class="main">(</span>Obj <span class="bound">f'</span> <span class="bound">T</span><span class="main">)</span><span class="main">;</span> lc <span class="main">(</span>Obj <span class="bound">f</span> <span class="bound">T</span><span class="main">)</span><span class="main">;</span>
                      <span class="bound">l</span> <span class="main">∈</span> dom <span class="bound">f</span><span class="main">;</span> <span class="bound">p</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> <span class="bound">p'</span><span class="main">;</span> <span class="free">P1</span> <span class="bound">p</span> <span class="bound">p'</span><span class="main">;</span> lc <span class="bound">p</span> <span class="main">⟧</span>
      <span class="main">⟹</span> <span class="free">P1</span> <span class="main">(</span>Call <span class="main">(</span>Obj <span class="bound">f</span> <span class="bound">T</span><span class="main">)</span> <span class="bound">l</span> <span class="bound">p</span><span class="main">)</span> <span class="main">(</span>the<span class="main">(</span><span class="bound">f'</span> <span class="bound">l</span><span class="main">)</span><span class="hidden">⇗</span><sup>[Obj <span class="bound">f'</span> <span class="bound">T</span><span class="main">,</span> <span class="bound">p'</span>]</sup><span class="hidden">⇖</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">L</span> <span class="bound">t</span> <span class="bound">t'</span><span class="main">.</span> 
      <span class="main">⟦</span> finite <span class="bound">L</span><span class="main">;</span> 
        <span class="main">∀</span><span class="bound">s</span> <span class="bound">p</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∉</span> <span class="bound">L</span> <span class="main">∧</span> <span class="bound">p</span> <span class="main">∉</span> <span class="bound">L</span> <span class="main">∧</span> <span class="bound">s</span> <span class="main">≠</span> <span class="bound">p</span> 
        <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">t''</span><span class="main">.</span> <span class="bound">t</span><span class="hidden">⇗</span><sup>[Fvar <span class="bound">s</span><span class="main">,</span>Fvar <span class="bound">p</span>]</sup><span class="hidden">⇖</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> <span class="bound">t''</span> 
                 <span class="main">∧</span> <span class="free">P1</span> <span class="main">(</span><span class="bound">t</span><span class="hidden">⇗</span><sup>[Fvar <span class="bound">s</span><span class="main">,</span>Fvar <span class="bound">p</span>]</sup><span class="hidden">⇖</span><span class="main">)</span> <span class="bound">t''</span> <span class="main">∧</span> <span class="bound">t'</span> <span class="main">=</span> <span class="keyword1">σ[</span><span class="bound">s</span><span class="main">,</span><span class="bound">p</span><span class="main">]</span> <span class="bound">t''</span><span class="main">)</span> <span class="main">⟧</span>
      <span class="main">⟹</span> <span class="free">P2</span> <span class="bound">t</span> <span class="bound">t'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P1</span> <span class="free">t</span> <span class="free">t'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> par_beta.induct<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> assms<span class="main">)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Preservation›</span></span>
<span class="keyword1" id="ParRed-par_beta_lc"><span class="command">lemma</span></span> par_beta_lc<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">t</span> <span class="free">t'</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> <span class="free">t'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"lc <span class="free">t</span> <span class="main">∧</span> lc <span class="free">t'</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> 
  <span class="main">(</span><span class="operator">induct</span>
    <span class="quasi_keyword">taking</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">t</span> <span class="bound">t'</span><span class="main">.</span> body <span class="bound">t'</span>"</span></span>
    <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> pbeta_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Fvar <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> Call <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> Upd <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lc_upd<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> Upd' <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lc_upd lc_obj<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> Obj <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lc_obj<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>beta <span class="skolem">f</span> <span class="skolem">f'</span> <span class="skolem">T</span> <span class="skolem">l</span> <span class="skolem">p</span> <span class="skolem">p'</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">clarify</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lc_obj body_lc<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">"the<span class="main">(</span><span class="skolem">f'</span> <span class="skolem">l</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"Obj <span class="skolem">f'</span> <span class="skolem">T</span>"</span></span> <span class="quoted"><span class="skolem">p'</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Bnd <span class="skolem">L</span> <span class="skolem">t</span> <span class="skolem">t'</span><span class="main">)</span> <span class="keyword1"><span class="command">note</span></span> cof <span class="main">=</span> this<span class="main">(</span>2<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> exFresh_s_p_cof<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹finite <span class="skolem">L</span>›</span></span><span class="main">]</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="keyword2"><span class="keyword">where</span></span> sp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∉</span> <span class="skolem">L</span> <span class="main">∧</span> <span class="skolem">p</span> <span class="main">∉</span> <span class="skolem">L</span> <span class="main">∧</span> <span class="skolem">s</span> <span class="main">≠</span> <span class="skolem">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> cof <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t''</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"lc <span class="skolem">t''</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t'</span> <span class="main">=</span> <span class="keyword1">σ[</span><span class="skolem">s</span><span class="main">,</span><span class="skolem">p</span><span class="main">]</span> <span class="skolem">t''</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">with</span></span> lc_body<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">t''</span></span> <span class="quoted"><span class="skolem">s</span></span> <span class="quoted"><span class="skolem">p</span></span><span class="main">]</span> sp <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"body <span class="skolem">t'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="ParRed-par_beta_preserves_FV"><span class="command">lemma</span></span> par_beta_preserves_FV<span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span><span class="main">:</span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">t</span> <span class="free">t'</span> <span class="free">x</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> <span class="free">t'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> FV <span class="free">t</span> <span class="main">⟶</span> <span class="free">x</span> <span class="main">∉</span> FV <span class="free">t'</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> 
  <span class="main">(</span><span class="operator">induct</span>
    <span class="quasi_keyword">taking</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">t</span> <span class="bound">t'</span><span class="main">.</span> <span class="free">x</span> <span class="main">∉</span> FV <span class="bound">t</span> <span class="main">⟶</span> <span class="free">x</span> <span class="main">∉</span> FV <span class="bound">t'</span>"</span></span>
    <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> pbeta_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Fvar <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> Call <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> Upd <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> Upd' <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> Obj <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> FV_option_lem<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>beta <span class="skolem">f</span> <span class="skolem">f'</span> <span class="skolem">T</span> <span class="skolem">l</span> <span class="skolem">p</span> <span class="skolem">p'</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> strip<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> FV <span class="main">(</span>Call <span class="main">(</span>Obj <span class="skolem">f</span> <span class="skolem">T</span><span class="main">)</span> <span class="skolem">l</span> <span class="skolem">p</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span>
      <span class="quoted"><span class="quoted">‹<span class="free">x</span> <span class="main">∉</span> FV <span class="main">(</span>Obj <span class="skolem">f</span> <span class="skolem">T</span><span class="main">)</span> <span class="main">⟶</span> <span class="free">x</span> <span class="main">∉</span> FV <span class="main">(</span>Obj <span class="skolem">f'</span> <span class="skolem">T</span><span class="main">)</span>›</span></span>
      <span class="quoted"><span class="quoted">‹<span class="free">x</span> <span class="main">∉</span> FV <span class="skolem">p</span> <span class="main">⟶</span> <span class="free">x</span> <span class="main">∉</span> FV <span class="skolem">p'</span>›</span></span>
    <span class="keyword1"><span class="command">have</span></span> obj'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> FV <span class="main">(</span>Obj <span class="skolem">f'</span> <span class="skolem">T</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> p'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> FV <span class="skolem">p'</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">l</span> <span class="main">∈</span> dom <span class="skolem">f</span>›</span></span> <span class="quoted"><span class="quoted">‹Obj <span class="skolem">f</span> <span class="skolem">T</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> Obj <span class="skolem">f'</span> <span class="skolem">T</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">∈</span> dom <span class="skolem">f'</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> 
      obj' p' FV_option_lem<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">f'</span></span><span class="main">]</span>
      contra_subsetD<span class="main">[</span><span class="operator">OF</span> sopen_FV<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="main">0</span></span> <span class="quoted"><span class="quoted">"Obj <span class="skolem">f'</span> <span class="skolem">T</span>"</span></span> <span class="quoted"><span class="skolem">p'</span></span> <span class="quoted"><span class="quoted">"the<span class="main">(</span><span class="skolem">f'</span> <span class="skolem">l</span><span class="main">)</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> FV <span class="main">(</span>the <span class="main">(</span><span class="skolem">f'</span> <span class="skolem">l</span><span class="main">)</span><span class="hidden">⇗</span><sup>[Obj <span class="skolem">f'</span> <span class="skolem">T</span><span class="main">,</span><span class="skolem">p'</span>]</sup><span class="hidden">⇖</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> openz_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Bnd <span class="skolem">L</span> <span class="skolem">t</span> <span class="skolem">t'</span><span class="main">)</span> <span class="keyword1"><span class="command">note</span></span> cof <span class="main">=</span> this<span class="main">(</span>2<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹finite <span class="skolem">L</span>›</span></span> exFresh_s_p_cof<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">L</span> <span class="main">∪</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span>"</span></span><span class="main">]</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
    <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∉</span> <span class="skolem">L</span>"</span></span><span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∉</span> <span class="skolem">L</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">≠</span> <span class="skolem">p</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 
    <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> FV <span class="main">(</span>Fvar <span class="skolem">s</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> FV <span class="main">(</span>Fvar <span class="skolem">p</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> cof <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t''</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    tt''<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> FV <span class="main">(</span><span class="skolem">t</span><span class="hidden">⇗</span><sup>[Fvar <span class="skolem">s</span><span class="main">,</span> Fvar <span class="skolem">p</span>]</sup><span class="hidden">⇖</span><span class="main">)</span> <span class="main">⟶</span> <span class="free">x</span> <span class="main">∉</span> FV <span class="skolem">t''</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="skolem">t'</span> <span class="main">=</span> <span class="keyword1">σ[</span><span class="skolem">s</span><span class="main">,</span><span class="skolem">p</span><span class="main">]</span> <span class="skolem">t''</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> strip<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> FV <span class="skolem">t</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> 
      tt'' <span class="quoted"><span class="quoted">‹<span class="free">x</span> <span class="main">∉</span> FV <span class="main">(</span>Fvar <span class="skolem">s</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">x</span> <span class="main">∉</span> FV <span class="main">(</span>Fvar <span class="skolem">p</span><span class="main">)</span>›</span></span>
      contra_subsetD<span class="main">[</span><span class="operator">OF</span> sopen_FV<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="main">0</span></span> <span class="quoted"><span class="quoted">"Fvar <span class="skolem">s</span>"</span></span> <span class="quoted"><span class="quoted">"Fvar <span class="skolem">p</span>"</span></span> <span class="quoted"><span class="skolem">t</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span>
      sclose_subset_FV<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="main">0</span></span> <span class="quoted"><span class="skolem">s</span></span> <span class="quoted"><span class="skolem">p</span></span> <span class="quoted"><span class="skolem">t''</span></span><span class="main">]</span> <span class="quoted"><span class="quoted">‹<span class="skolem">t'</span> <span class="main">=</span> <span class="keyword1">σ[</span><span class="skolem">s</span><span class="main">,</span><span class="skolem">p</span><span class="main">]</span> <span class="skolem">t''</span>›</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> FV <span class="skolem">t'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> openz_def closez_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="ParRed-par_beta_body"><span class="command">lemma</span></span> par_beta_body<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> finite <span class="free">L</span><span class="main">;</span> 
     <span class="main">∀</span><span class="bound">s</span> <span class="bound">p</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∉</span> <span class="free">L</span> <span class="main">∧</span> <span class="bound">p</span> <span class="main">∉</span> <span class="free">L</span> <span class="main">∧</span> <span class="bound">s</span> <span class="main">≠</span> <span class="bound">p</span> 
      <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">t''</span><span class="main">.</span> <span class="free">t</span><span class="hidden">⇗</span><sup>[Fvar <span class="bound">s</span><span class="main">,</span>Fvar <span class="bound">p</span>]</sup><span class="hidden">⇖</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> <span class="bound">t''</span> <span class="main">∧</span> <span class="free">t'</span> <span class="main">=</span> <span class="keyword1">σ[</span><span class="bound">s</span><span class="main">,</span><span class="bound">p</span><span class="main">]</span> <span class="bound">t''</span><span class="main">)</span> <span class="main">⟧</span>
  <span class="main">⟹</span> body <span class="free">t</span> <span class="main">∧</span> body <span class="free">t'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> conjI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">L</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"fVariable set"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">t</span> <span class="main">::</span> <span class="quoted">sterm</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">t'</span> <span class="main">::</span> <span class="quoted">sterm</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"finite <span class="skolem">L</span>"</span></span> <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="skolem">L</span> <span class="main">∪</span> FV <span class="skolem">t</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> exFresh_s_p_cof<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> 
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="keyword2"><span class="keyword">where</span></span> sp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∉</span> <span class="skolem">L</span> <span class="main">∪</span> FV <span class="skolem">t</span> <span class="main">∧</span> <span class="skolem">p</span> <span class="main">∉</span> <span class="skolem">L</span> <span class="main">∪</span> FV <span class="skolem">t</span> <span class="main">∧</span> <span class="skolem">s</span> <span class="main">≠</span> <span class="skolem">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∉</span> FV <span class="skolem">t</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∉</span> FV <span class="skolem">t</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">≠</span> <span class="skolem">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword3"><span class="command">assume</span></span> 
    <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">s</span> <span class="bound">p</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∉</span> <span class="skolem">L</span> <span class="main">∧</span> <span class="bound">p</span> <span class="main">∉</span> <span class="skolem">L</span> <span class="main">∧</span> <span class="bound">s</span> <span class="main">≠</span> <span class="bound">p</span>
      <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">t''</span><span class="main">.</span> <span class="skolem">t</span><span class="hidden">⇗</span><sup>[Fvar <span class="bound">s</span><span class="main">,</span>Fvar <span class="bound">p</span>]</sup><span class="hidden">⇖</span> <span class="main">=&gt;</span> <span class="bound">t''</span> <span class="main">∧</span> <span class="skolem">t'</span> <span class="main">=</span> <span class="keyword1">σ[</span><span class="bound">s</span><span class="main">,</span><span class="bound">p</span><span class="main">]</span> <span class="bound">t''</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">with</span></span> sp <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t''</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span><span class="hidden">⇗</span><sup>[Fvar <span class="skolem">s</span><span class="main">,</span>Fvar <span class="skolem">p</span>]</sup><span class="hidden">⇖</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> <span class="skolem">t''</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t'</span> <span class="main">=</span> <span class="keyword1">σ[</span><span class="skolem">s</span><span class="main">,</span><span class="skolem">p</span><span class="main">]</span> <span class="skolem">t''</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword1"><span class="command">from</span></span> par_beta_lc<span class="main">[</span><span class="operator">OF</span> this<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"lc <span class="main">(</span><span class="skolem">t</span><span class="hidden">⇗</span><sup>[Fvar <span class="skolem">s</span><span class="main">,</span>Fvar <span class="skolem">p</span>]</sup><span class="hidden">⇖</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"lc <span class="skolem">t''</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">from</span></span> 
    lc_body<span class="main">[</span><span class="operator">OF</span> this<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">s</span> <span class="main">≠</span> <span class="skolem">p</span>›</span></span><span class="main">]</span> 
    sclose_sopen_eq_t<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">s</span> <span class="main">∉</span> FV <span class="skolem">t</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="main">∉</span> FV <span class="skolem">t</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">s</span> <span class="main">≠</span> <span class="skolem">p</span>›</span></span><span class="main">]</span> 
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"body <span class="skolem">t</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> closez_def openz_def<span class="main">)</span>

  <span class="keyword1"><span class="command">from</span></span> lc_body<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹lc <span class="skolem">t''</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">s</span> <span class="main">≠</span> <span class="skolem">p</span>›</span></span><span class="main">]</span> <span class="quoted"><span class="quoted">‹<span class="skolem">t'</span> <span class="main">=</span> <span class="keyword1">σ[</span><span class="skolem">s</span><span class="main">,</span><span class="skolem">p</span><span class="main">]</span> <span class="skolem">t''</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"body <span class="skolem">t'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Miscellaneous properties of par\_beta›</span></span>
<span class="keyword1" id="ParRed-Fvar_pbeta"><span class="command">lemma</span></span> Fvar_pbeta <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Fvar <span class="free">x</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">t</span> <span class="main">=</span> Fvar <span class="free">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1" id="ParRed-Obj_pbeta"><span class="command">lemma</span></span> Obj_pbeta<span class="main">:</span> <span class="quoted"><span class="quoted">"Obj <span class="free">f</span> <span class="free">T</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> Obj <span class="free">f'</span> <span class="free">T</span>
  <span class="main">⟹</span> dom <span class="free">f'</span> <span class="main">=</span> dom <span class="free">f</span> 
      <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span><span class="bound">L</span><span class="main">.</span> finite <span class="bound">L</span> 
           <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">l</span><span class="main">∈</span>dom <span class="free">f</span><span class="main">.</span> <span class="main">∀</span><span class="bound">s</span> <span class="bound">p</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∉</span> <span class="bound">L</span> <span class="main">∧</span> <span class="bound">p</span> <span class="main">∉</span> <span class="bound">L</span> <span class="main">∧</span> <span class="bound">s</span> <span class="main">≠</span> <span class="bound">p</span>
               <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">t</span><span class="main">.</span> <span class="main">(</span>the<span class="main">(</span><span class="free">f</span> <span class="bound">l</span><span class="main">)</span><span class="hidden">⇗</span><sup>[Fvar <span class="bound">s</span><span class="main">,</span> Fvar <span class="bound">p</span>]</sup><span class="hidden">⇖</span><span class="main">)</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> <span class="bound">t</span> 
                      <span class="main">∧</span> the<span class="main">(</span><span class="free">f'</span> <span class="bound">l</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">σ[</span><span class="bound">s</span><span class="main">,</span><span class="bound">p</span><span class="main">]</span><span class="bound">t</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
      <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">l</span><span class="main">∈</span>dom <span class="free">f</span><span class="main">.</span> body <span class="main">(</span>the<span class="main">(</span><span class="free">f</span> <span class="bound">l</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> par_beta_cases<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">assumption</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="ParRed-Obj_pbeta_subst"><span class="command">lemma</span></span> Obj_pbeta_subst<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> finite <span class="free">L</span><span class="main">;</span> 
     <span class="main">∀</span><span class="bound">s</span> <span class="bound">p</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∉</span> <span class="free">L</span> <span class="main">∧</span> <span class="bound">p</span> <span class="main">∉</span> <span class="free">L</span> <span class="main">∧</span> <span class="bound">s</span> <span class="main">≠</span> <span class="bound">p</span> 
      <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">t''</span><span class="main">.</span> <span class="main">(</span><span class="free">t</span><span class="hidden">⇗</span><sup>[Fvar <span class="bound">s</span><span class="main">,</span> Fvar <span class="bound">p</span>]</sup><span class="hidden">⇖</span><span class="main">)</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> <span class="bound">t''</span> <span class="main">∧</span> <span class="free">t'</span> <span class="main">=</span> <span class="keyword1">σ[</span><span class="bound">s</span><span class="main">,</span><span class="bound">p</span><span class="main">]</span> <span class="bound">t''</span><span class="main">)</span><span class="main">;</span> 
     Obj <span class="free">f</span> <span class="free">T</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> Obj <span class="free">f'</span> <span class="free">T</span><span class="main">;</span> lc <span class="main">(</span>Obj <span class="free">f</span> <span class="free">T</span><span class="main">)</span><span class="main">;</span> body <span class="free">t</span> <span class="main">⟧</span>
  <span class="main">⟹</span> Obj <span class="main">(</span><span class="free">f</span><span class="main">(</span><span class="free">l</span> <span class="main">↦</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span> <span class="free">T</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> Obj <span class="main">(</span><span class="free">f'</span><span class="main">(</span><span class="free">l</span> <span class="main">↦</span> <span class="free">t'</span><span class="main">)</span><span class="main">)</span> <span class="free">T</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">L</span> <span class="skolem">f</span> <span class="skolem">f'</span> <span class="skolem">T</span> <span class="skolem">l</span> <span class="skolem">t</span> <span class="skolem">t'</span> 
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"Obj <span class="skolem">f</span> <span class="skolem">T</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> Obj <span class="skolem">f'</span> <span class="skolem">T</span>"</span></span> <span class="keyword1"><span class="command">from</span></span> Obj_pbeta<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> 
    dom<span class="main">:</span> <span class="quoted"><span class="quoted">"dom <span class="main">(</span><span class="skolem">f'</span><span class="main">(</span><span class="skolem">l</span> <span class="main">↦</span> <span class="skolem">t'</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> dom <span class="main">(</span><span class="skolem">f</span><span class="main">(</span><span class="skolem">l</span> <span class="main">↦</span> <span class="skolem">t</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 
    exL<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">L</span><span class="main">.</span> finite <span class="bound">L</span> 
            <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">l</span><span class="main">∈</span>dom <span class="skolem">f</span><span class="main">.</span> <span class="main">∀</span><span class="bound">s</span> <span class="bound">p</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∉</span> <span class="bound">L</span> <span class="main">∧</span> <span class="bound">p</span> <span class="main">∉</span> <span class="bound">L</span> <span class="main">∧</span> <span class="bound">s</span> <span class="main">≠</span> <span class="bound">p</span> 
                           <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">t</span><span class="main">.</span> the <span class="main">(</span><span class="skolem">f</span> <span class="bound">l</span><span class="main">)</span><span class="hidden">⇗</span><sup>[Fvar <span class="bound">s</span><span class="main">,</span>Fvar <span class="bound">p</span>]</sup><span class="hidden">⇖</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> <span class="bound">t</span> 
                                  <span class="main">∧</span> the <span class="main">(</span><span class="skolem">f'</span> <span class="bound">l</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">σ[</span><span class="bound">s</span><span class="main">,</span><span class="bound">p</span><span class="main">]</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    bodyf<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">l</span><span class="main">∈</span>dom <span class="skolem">f</span><span class="main">.</span> body <span class="main">(</span>the <span class="main">(</span><span class="skolem">f</span> <span class="bound">l</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"body <span class="skolem">t</span>"</span></span> <span class="keyword1"><span class="command">with</span></span> bodyf 
  <span class="keyword1"><span class="command">have</span></span> body<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">l'</span><span class="main">∈</span>dom <span class="main">(</span><span class="skolem">f</span><span class="main">(</span><span class="skolem">l</span> <span class="main">↦</span> <span class="skolem">t</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> body <span class="main">(</span>the <span class="main">(</span><span class="main">(</span><span class="skolem">f</span><span class="main">(</span><span class="skolem">l</span> <span class="main">↦</span> <span class="skolem">t</span><span class="main">)</span><span class="main">)</span> <span class="bound">l'</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword3"><span class="command">assume</span></span> 
    <span class="quoted"><span class="quoted">"finite <span class="skolem">L</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">s</span> <span class="bound">p</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∉</span> <span class="skolem">L</span> <span class="main">∧</span> <span class="bound">p</span> <span class="main">∉</span> <span class="skolem">L</span> <span class="main">∧</span> <span class="bound">s</span> <span class="main">≠</span> <span class="bound">p</span> 
      <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">t''</span><span class="main">.</span> <span class="skolem">t</span><span class="hidden">⇗</span><sup>[Fvar <span class="bound">s</span><span class="main">,</span>Fvar <span class="bound">p</span>]</sup><span class="hidden">⇖</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> <span class="bound">t''</span> <span class="main">∧</span> <span class="skolem">t'</span> <span class="main">=</span> <span class="keyword1">σ[</span><span class="bound">s</span><span class="main">,</span><span class="bound">p</span><span class="main">]</span> <span class="bound">t''</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">with</span></span> exL
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">L'</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
    <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="skolem">L'</span> <span class="main">∪</span> <span class="skolem">L</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">l'</span><span class="main">∈</span>dom <span class="main">(</span><span class="skolem">f</span><span class="main">(</span><span class="skolem">l</span> <span class="main">↦</span> <span class="skolem">t</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> <span class="main">∀</span><span class="bound">s</span> <span class="bound">p</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∉</span> <span class="skolem">L'</span> <span class="main">∪</span> <span class="skolem">L</span> <span class="main">∧</span> <span class="bound">p</span> <span class="main">∉</span> <span class="skolem">L'</span> <span class="main">∪</span> <span class="skolem">L</span> <span class="main">∧</span> <span class="bound">s</span> <span class="main">≠</span> <span class="bound">p</span> 
                            <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">t''</span><span class="main">.</span> the <span class="main">(</span><span class="main">(</span><span class="skolem">f</span><span class="main">(</span><span class="skolem">l</span> <span class="main">↦</span> <span class="skolem">t</span><span class="main">)</span><span class="main">)</span> <span class="bound">l'</span><span class="main">)</span><span class="hidden">⇗</span><sup>[Fvar <span class="bound">s</span><span class="main">,</span>Fvar <span class="bound">p</span>]</sup><span class="hidden">⇖</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> <span class="bound">t''</span> 
                                     <span class="main">∧</span> the <span class="main">(</span><span class="main">(</span><span class="skolem">f'</span><span class="main">(</span><span class="skolem">l</span> <span class="main">↦</span> <span class="skolem">t'</span><span class="main">)</span><span class="main">)</span> <span class="bound">l'</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">σ[</span><span class="bound">s</span><span class="main">,</span><span class="bound">p</span><span class="main">]</span> <span class="bound">t''</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> par_beta.pbeta_Obj<span class="main">[</span><span class="operator">OF</span> dom this body<span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Obj <span class="main">(</span><span class="skolem">f</span><span class="main">(</span><span class="skolem">l</span> <span class="main">↦</span> <span class="skolem">t</span><span class="main">)</span><span class="main">)</span> <span class="skolem">T</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> Obj <span class="main">(</span><span class="skolem">f'</span><span class="main">(</span><span class="skolem">l</span> <span class="main">↦</span> <span class="skolem">t'</span><span class="main">)</span><span class="main">)</span> <span class="skolem">T</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">assumption</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="ParRed-Upd_pbeta"><span class="command">lemma</span></span> Upd_pbeta<span class="main">:</span> <span class="quoted"><span class="quoted">"Upd <span class="free">t</span> <span class="free">l</span> <span class="free">u</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> Upd <span class="free">t'</span> <span class="free">l</span> <span class="free">u'</span>
  <span class="main">⟹</span> <span class="free">t</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> <span class="free">t'</span> 
      <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span><span class="bound">L</span><span class="main">.</span> finite <span class="bound">L</span> 
           <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">s</span> <span class="bound">p</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∉</span> <span class="bound">L</span> <span class="main">∧</span> <span class="bound">p</span> <span class="main">∉</span> <span class="bound">L</span> <span class="main">∧</span> <span class="bound">s</span> <span class="main">≠</span> <span class="bound">p</span> 
               <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">t''</span><span class="main">.</span> <span class="main">(</span><span class="free">u</span><span class="hidden">⇗</span><sup>[Fvar <span class="bound">s</span><span class="main">,</span> Fvar <span class="bound">p</span>]</sup><span class="hidden">⇖</span><span class="main">)</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> <span class="bound">t''</span> <span class="main">∧</span> <span class="free">u'</span> <span class="main">=</span> <span class="keyword1">σ[</span><span class="bound">s</span><span class="main">,</span><span class="bound">p</span><span class="main">]</span><span class="bound">t''</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
      <span class="main">∧</span> lc <span class="free">t</span> <span class="main">∧</span> body <span class="free">u</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> par_beta_cases<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">assumption</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="ParRed-par_beta_refl"><span class="command">lemma</span></span> par_beta_refl<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">t</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"lc <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">pred_cof</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">pred_cof</span> <span class="skolem">L</span> <span class="skolem">t</span> <span class="main">⟷</span>
      <span class="main">(</span><span class="main">∀</span><span class="bound">s</span> <span class="bound">p</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∉</span> <span class="skolem">L</span> <span class="main">∧</span> <span class="bound">p</span> <span class="main">∉</span> <span class="skolem">L</span> <span class="main">∧</span> <span class="bound">s</span> <span class="main">≠</span> <span class="bound">p</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">t'</span><span class="main">.</span> <span class="main">(</span><span class="skolem">t</span><span class="hidden">⇗</span><sup>[Fvar <span class="bound">s</span><span class="main">,</span> Fvar <span class="bound">p</span>]</sup><span class="hidden">⇖</span><span class="main">)</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> <span class="bound">t'</span> <span class="main">∧</span> <span class="skolem">t</span> <span class="main">=</span> <span class="keyword1">σ[</span><span class="bound">s</span><span class="main">,</span><span class="bound">p</span><span class="main">]</span> <span class="bound">t'</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">L</span> <span class="skolem">t</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> 
    <span class="main">(</span><span class="operator">induct</span>
      <span class="quasi_keyword">taking</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">t</span><span class="main">.</span> body <span class="bound">t</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span><span class="bound">L</span><span class="main">.</span> finite <span class="bound">L</span> <span class="main">∧</span> <span class="skolem">pred_cof</span> <span class="bound">L</span> <span class="bound">t</span><span class="main">)</span>"</span></span>
      <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> lc_induct<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> Fvar <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> Call <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> Upd <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> pred_cof_def
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Obj <span class="skolem">f</span> <span class="skolem">T</span><span class="main">)</span> <span class="keyword1"><span class="command">note</span></span> pred <span class="main">=</span> this
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">pred_fl</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">pred_fl</span> <span class="skolem">s</span> <span class="skolem">p</span> <span class="skolem">b</span> <span class="skolem">l</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">t'</span><span class="main">.</span> <span class="main">(</span>the <span class="skolem">b</span><span class="hidden">⇗</span><sup>[Fvar <span class="skolem">s</span><span class="main">,</span> Fvar <span class="skolem">p</span>]</sup><span class="hidden">⇖</span><span class="main">)</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> <span class="bound">t'</span> <span class="main">∧</span> the <span class="skolem">b</span> <span class="main">=</span> <span class="keyword1">σ[</span><span class="skolem">s</span><span class="main">,</span><span class="skolem">p</span><span class="main">]</span><span class="bound">t'</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">s</span> <span class="skolem">p</span> <span class="skolem">b</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">l</span> <span class="main">::</span> <span class="quoted">Label</span>

    <span class="keyword1"><span class="command">from</span></span> fmap_ex_cof<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">f</span></span> <span class="quoted"><span class="skolem">pred_fl</span></span><span class="main">]</span> pred
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">L</span></span> <span class="keyword2"><span class="keyword">where</span></span>
      <span class="quoted"><span class="quoted">"finite <span class="skolem">L</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">l</span><span class="main">∈</span>dom <span class="skolem">f</span><span class="main">.</span> body <span class="main">(</span>the<span class="main">(</span><span class="skolem">f</span> <span class="bound">l</span><span class="main">)</span><span class="main">)</span> 
                              <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">s</span> <span class="bound">p</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∉</span> <span class="skolem">L</span> <span class="main">∧</span> <span class="bound">p</span> <span class="main">∉</span> <span class="skolem">L</span> <span class="main">∧</span> <span class="bound">s</span> <span class="main">≠</span> <span class="bound">p</span> <span class="main">⟶</span> <span class="skolem">pred_fl</span> <span class="bound">s</span> <span class="bound">p</span> <span class="main">(</span><span class="skolem">f</span> <span class="bound">l</span><span class="main">)</span> <span class="bound">l</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> pred_cof_def pred_fl_def
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"Obj <span class="skolem">f</span> <span class="skolem">T</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> Obj <span class="skolem">f</span> <span class="skolem">T</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> pred_fl_def
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Bnd <span class="skolem">L</span> <span class="skolem">t</span><span class="main">)</span> <span class="keyword1"><span class="command">note</span></span> pred <span class="main">=</span> this<span class="main">(</span>2<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹finite <span class="skolem">L</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> 
      <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> body_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold</span> pred_cof_def<span class="main"><span class="keyword3">,</span></span>
        <span class="operator">rule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">L</span> <span class="main">∪</span> FV <span class="skolem">t</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">clarify</span><span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span> <span class="skolem">p</span> <span class="keyword3"><span class="command">assume</span></span> 
        <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∉</span> <span class="skolem">L</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∉</span> <span class="skolem">L</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">≠</span> <span class="skolem">p</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
        <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∉</span> FV <span class="skolem">t</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∉</span> FV <span class="skolem">t</span>"</span></span>
      <span class="keyword1"><span class="command">from</span></span> 
        this<span class="main">(</span>1-3<span class="main">)</span> pred 
        sclose_sopen_eq_t<span class="main">[</span><span class="operator">OF</span> this<span class="main"><span class="main">(</span></span>4-5<span class="main"><span class="main">)</span></span> this<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">]</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">t'</span><span class="main">.</span> <span class="skolem">t</span><span class="hidden">⇗</span><sup>[Fvar <span class="skolem">s</span><span class="main">,</span>Fvar <span class="skolem">p</span>]</sup><span class="hidden">⇖</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> <span class="bound">t'</span> <span class="main">∧</span> <span class="skolem">t</span> <span class="main">=</span> <span class="keyword1">σ[</span><span class="skolem">s</span><span class="main">,</span><span class="skolem">p</span><span class="main">]</span> <span class="bound">t'</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span><span class="hidden">⇗</span><sup>[Fvar <span class="skolem">s</span><span class="main">,</span>Fvar <span class="skolem">p</span>]</sup><span class="hidden">⇖</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> openz_def closez_def<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="ParRed-par_beta_body_refl"><span class="command">lemma</span></span> par_beta_body_refl<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">u</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"body <span class="free">u</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">L</span><span class="main">.</span> finite <span class="bound">L</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">s</span> <span class="bound">p</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∉</span> <span class="bound">L</span> <span class="main">∧</span> <span class="bound">p</span> <span class="main">∉</span> <span class="bound">L</span> <span class="main">∧</span> <span class="bound">s</span> <span class="main">≠</span> <span class="bound">p</span> 
                          <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">t'</span><span class="main">.</span> <span class="main">(</span><span class="free">u</span><span class="hidden">⇗</span><sup>[Fvar <span class="bound">s</span><span class="main">,</span> Fvar <span class="bound">p</span>]</sup><span class="hidden">⇖</span><span class="main">)</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> <span class="bound">t'</span> <span class="main">∧</span> <span class="free">u</span> <span class="main">=</span> <span class="keyword1">σ[</span><span class="bound">s</span><span class="main">,</span><span class="bound">p</span><span class="main">]</span> <span class="bound">t'</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"FV <span class="free">u</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">clarify</span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span> <span class="skolem">p</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∉</span> FV <span class="free">u</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∉</span> FV <span class="free">u</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">≠</span> <span class="skolem">p</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> 
    par_beta_refl<span class="main">[</span><span class="operator">OF</span> body_lc<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms lc_Fvar<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem">s</span></span><span class="main"><span class="main">]</span></span> lc_Fvar<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem">p</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span>
    sclose_sopen_eq_t<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">t'</span><span class="main">.</span> <span class="main">(</span><span class="free">u</span><span class="hidden">⇗</span><sup>[Fvar <span class="skolem">s</span><span class="main">,</span> Fvar <span class="skolem">p</span>]</sup><span class="hidden">⇖</span><span class="main">)</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> <span class="bound">t'</span> <span class="main">∧</span> <span class="free">u</span> <span class="main">=</span> <span class="keyword1">σ[</span><span class="skolem">s</span><span class="main">,</span><span class="skolem">p</span><span class="main">]</span> <span class="bound">t'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span><span class="hidden">⇗</span><sup>[Fvar <span class="skolem">s</span><span class="main">,</span> Fvar <span class="skolem">p</span>]</sup><span class="hidden">⇖</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> openz_def closez_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="ParRed-par_beta_ssubst"><span class="command">lemma</span></span> par_beta_ssubst<span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">t</span> <span class="free">t'</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> <span class="free">t'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span> <span class="bound">v</span> <span class="bound">v'</span><span class="main">.</span> <span class="bound">v</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> <span class="bound">v'</span> <span class="main">⟶</span> <span class="main">[</span><span class="bound">x</span> <span class="main">→</span> <span class="bound">v</span><span class="main">]</span> <span class="free">t</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> <span class="main">[</span><span class="bound">x</span> <span class="main">→</span> <span class="bound">v'</span><span class="main">]</span> <span class="free">t'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">pred_cof</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">pred_cof</span> <span class="skolem">L</span> <span class="skolem">t</span> <span class="skolem">t'</span> <span class="main">⟷</span>
      <span class="main">(</span><span class="main">∀</span><span class="bound">s</span> <span class="bound">p</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∉</span> <span class="skolem">L</span> <span class="main">∧</span> <span class="bound">p</span> <span class="main">∉</span> <span class="skolem">L</span> <span class="main">∧</span> <span class="bound">s</span> <span class="main">≠</span> <span class="bound">p</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">t''</span><span class="main">.</span> <span class="skolem">t</span><span class="hidden">⇗</span><sup>[Fvar <span class="bound">s</span><span class="main">,</span> Fvar <span class="bound">p</span>]</sup><span class="hidden">⇖</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> <span class="bound">t''</span> <span class="main">∧</span> <span class="skolem">t'</span> <span class="main">=</span> <span class="keyword1">σ[</span><span class="bound">s</span><span class="main">,</span><span class="bound">p</span><span class="main">]</span> <span class="bound">t''</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">L</span> <span class="skolem">t</span> <span class="skolem">t'</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">v</span> <span class="skolem">v'</span> <span class="skolem">t</span> <span class="skolem">t'</span>
    <span class="keyword3"><span class="command">assume</span></span> 
      <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> <span class="skolem">v'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span> <span class="bound">v</span> <span class="bound">v'</span><span class="main">.</span> <span class="bound">v</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> <span class="bound">v'</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">L</span><span class="main">.</span> finite <span class="bound">L</span> <span class="main">∧</span> <span class="skolem">pred_cof</span> <span class="bound">L</span> <span class="main">(</span><span class="main">[</span><span class="bound">x</span> <span class="main">→</span> <span class="bound">v</span><span class="main">]</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">(</span><span class="main">[</span><span class="bound">x</span> <span class="main">→</span> <span class="bound">v'</span><span class="main">]</span> <span class="skolem">t'</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">L</span><span class="main">.</span> finite <span class="bound">L</span> <span class="main">∧</span> <span class="skolem">pred_cof</span> <span class="bound">L</span> <span class="main">(</span><span class="main">[</span><span class="skolem">x</span> <span class="main">→</span> <span class="skolem">v</span><span class="main">]</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">(</span><span class="main">[</span><span class="skolem">x</span> <span class="main">→</span> <span class="skolem">v'</span><span class="main">]</span> <span class="skolem">t'</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">}</span></span><span class="keyword1"><span class="command">note</span></span> Lex <span class="main">=</span> this

  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">v</span> <span class="skolem">l</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"Label <span class="main">⇒</span> sterm option"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">∈</span> dom <span class="skolem">f</span>"</span></span> <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">∈</span> dom <span class="main">(</span><span class="main">λ</span><span class="bound">l</span><span class="main">.</span> ssubst_option <span class="skolem">x</span> <span class="skolem">v</span> <span class="main">(</span><span class="skolem">f</span> <span class="bound">l</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">}</span></span><span class="keyword1"><span class="command">note</span></span> domssubst <span class="main">=</span> this
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">v</span> <span class="skolem">l</span> <span class="skolem">T</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"Label <span class="main">⇒</span> sterm option"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"lc <span class="main">(</span>Obj <span class="skolem">f</span> <span class="skolem">T</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"lc <span class="skolem">v</span>"</span></span> <span class="keyword1"><span class="command">from</span></span> ssubst_preserves_lc<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> 
    <span class="keyword1"><span class="command">have</span></span> obj<span class="main">:</span> <span class="quoted"><span class="quoted">"lc <span class="main">(</span>Obj <span class="main">(</span><span class="main">λ</span><span class="bound">l</span><span class="main">.</span> ssubst_option <span class="skolem">x</span> <span class="skolem">v</span> <span class="main">(</span><span class="skolem">f</span> <span class="bound">l</span><span class="main">)</span><span class="main">)</span> <span class="skolem">T</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">}</span></span><span class="keyword1"><span class="command">note</span></span> lcobj <span class="main">=</span> this

  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> 
    <span class="main">(</span><span class="operator">induct</span>
      <span class="quasi_keyword">taking</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">t</span> <span class="bound">t'</span><span class="main">.</span> <span class="main">∀</span><span class="bound">x</span> <span class="bound">v</span> <span class="bound">v'</span><span class="main">.</span> <span class="bound">v</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> <span class="bound">v'</span>
                       <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">L</span><span class="main">.</span> finite <span class="bound">L</span> 
                              <span class="main">∧</span> <span class="skolem">pred_cof</span> <span class="bound">L</span> <span class="main">(</span><span class="main">[</span><span class="bound">x</span> <span class="main">→</span> <span class="bound">v</span><span class="main">]</span> <span class="bound">t</span><span class="main">)</span> <span class="main">(</span><span class="main">[</span><span class="bound">x</span> <span class="main">→</span> <span class="bound">v'</span><span class="main">]</span> <span class="bound">t'</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> pbeta_induct<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> Fvar <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> Call <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Upd <span class="skolem">t</span> <span class="skolem">t'</span> <span class="skolem">l</span> <span class="skolem">u</span> <span class="skolem">u'</span><span class="main">)</span> <span class="keyword1"><span class="command">note</span></span> pred_t <span class="main">=</span> this<span class="main">(</span>2<span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span> pred_u <span class="main">=</span> this<span class="main">(</span>4<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> strip<span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">v</span> <span class="skolem">v'</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> <span class="skolem">v'</span>"</span></span>
      <span class="keyword1"><span class="command">from</span></span> Lex<span class="main">[</span><span class="operator">OF</span> this pred_u<span class="main">]</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">L</span></span> <span class="keyword2"><span class="keyword">where</span></span>
        <span class="quoted"><span class="quoted">"finite <span class="skolem">L</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">pred_cof</span> <span class="skolem">L</span> <span class="main">(</span><span class="main">[</span><span class="skolem">x</span> <span class="main">→</span> <span class="skolem">v</span><span class="main">]</span> <span class="skolem">u</span><span class="main">)</span> <span class="main">(</span><span class="main">[</span><span class="skolem">x</span> <span class="main">→</span> <span class="skolem">v'</span><span class="main">]</span> <span class="skolem">u'</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">with</span></span>
        ssubst_preserves_lc<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">t</span></span> <span class="quoted"><span class="skolem">v</span></span> <span class="quoted"><span class="skolem">x</span></span><span class="main">]</span>
        ssubst_preserves_body<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">u</span></span> <span class="quoted"><span class="skolem">v</span></span> <span class="quoted"><span class="skolem">x</span></span><span class="main">]</span>
        <span class="quoted"><span class="quoted">‹lc <span class="skolem">t</span>›</span></span> par_beta_lc<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">v</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> <span class="skolem">v'</span>›</span></span><span class="main">]</span> <span class="quoted"><span class="quoted">‹body <span class="skolem">u</span>›</span></span>
        <span class="quoted"><span class="quoted">‹<span class="skolem">v</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> <span class="skolem">v'</span>›</span></span> pred_t
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">x</span> <span class="main">→</span> <span class="skolem">v</span><span class="main">]</span> Upd <span class="skolem">t</span> <span class="skolem">l</span> <span class="skolem">u</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> <span class="main">[</span><span class="skolem">x</span> <span class="main">→</span> <span class="skolem">v'</span><span class="main">]</span> Upd <span class="skolem">t'</span> <span class="skolem">l</span> <span class="skolem">u'</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> pred_cof_def
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Upd' <span class="skolem">f</span> <span class="skolem">f'</span> <span class="skolem">T</span> <span class="skolem">t</span> <span class="skolem">t'</span> <span class="skolem">l</span><span class="main">)</span> 
    <span class="keyword1"><span class="command">note</span></span> pred_obj <span class="main">=</span> this<span class="main">(</span>2<span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span> pred_t <span class="main">=</span> this<span class="main">(</span>3<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> strip<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹Obj <span class="skolem">f</span> <span class="skolem">T</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> Obj <span class="skolem">f'</span> <span class="skolem">T</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">l</span> <span class="main">∈</span> dom <span class="skolem">f</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">∈</span> dom <span class="skolem">f'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">v</span> <span class="skolem">v'</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> <span class="skolem">v'</span>"</span></span>
      <span class="keyword1"><span class="command">with</span></span>
        domssubst<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">l</span> <span class="main">∈</span> dom <span class="skolem">f</span>›</span></span><span class="main">]</span>
        ssubst_preserves_lc<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"Obj <span class="skolem">f</span> <span class="skolem">T</span>"</span></span> <span class="quoted"><span class="skolem">v</span></span> <span class="quoted"><span class="skolem">x</span></span><span class="main">]</span>
        ssubst_preserves_body<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">t</span></span> <span class="quoted"><span class="skolem">v</span></span> <span class="quoted"><span class="skolem">x</span></span><span class="main">]</span>
        <span class="quoted"><span class="quoted">‹lc <span class="main">(</span>Obj <span class="skolem">f</span> <span class="skolem">T</span><span class="main">)</span>›</span></span> par_beta_lc<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">v</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> <span class="skolem">v'</span>›</span></span><span class="main">]</span> <span class="quoted"><span class="quoted">‹body <span class="skolem">t</span>›</span></span>
        pred_obj
      <span class="keyword1"><span class="command">have</span></span> 
        <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">x</span> <span class="main">→</span> <span class="skolem">v</span><span class="main">]</span> Obj <span class="skolem">f</span> <span class="skolem">T</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> <span class="main">[</span><span class="skolem">x</span> <span class="main">→</span> <span class="skolem">v'</span><span class="main">]</span> Obj <span class="skolem">f'</span> <span class="skolem">T</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
        <span class="quoted"><span class="quoted">"lc <span class="main">(</span><span class="main">[</span><span class="skolem">x</span> <span class="main">→</span> <span class="skolem">v</span><span class="main">]</span> Obj <span class="skolem">f</span> <span class="skolem">T</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"body <span class="main">(</span><span class="main">[</span><span class="skolem">x</span> <span class="main">→</span> <span class="skolem">v</span><span class="main">]</span> <span class="skolem">t</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">note</span></span> lem <span class="main">=</span> 
        pbeta_Upd'<span class="main">[</span><span class="operator">OF</span> this<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">simplified</span><span class="main"><span class="main">]</span></span> _ _ 
                      domssubst<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">l</span> <span class="main">∈</span> dom <span class="skolem">f</span>›</span></span><span class="main"><span class="main">]</span></span> 
                      this<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">simplified</span><span class="main"><span class="main">]</span></span> this<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">]</span>

      <span class="keyword1"><span class="command">from</span></span> Lex<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">v</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> <span class="skolem">v'</span>›</span></span> pred_t<span class="main">]</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">L</span></span> <span class="keyword2"><span class="keyword">where</span></span>
        <span class="quoted"><span class="quoted">"finite <span class="skolem">L</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">pred_cof</span> <span class="skolem">L</span> <span class="main">(</span><span class="main">[</span><span class="skolem">x</span> <span class="main">→</span> <span class="skolem">v</span><span class="main">]</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">(</span><span class="main">[</span><span class="skolem">x</span> <span class="main">→</span> <span class="skolem">v'</span><span class="main">]</span> <span class="skolem">t'</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">with</span></span> lem<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">L</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">x</span> <span class="main">→</span> <span class="skolem">v'</span><span class="main">]</span> <span class="skolem">t'</span>"</span></span><span class="main">]</span> ssubstoption_insert<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">l</span> <span class="main">∈</span> dom <span class="skolem">f'</span>›</span></span><span class="main">]</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">x</span> <span class="main">→</span> <span class="skolem">v</span><span class="main">]</span> Upd <span class="main">(</span>Obj <span class="skolem">f</span> <span class="skolem">T</span><span class="main">)</span> <span class="skolem">l</span> <span class="skolem">t</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> <span class="main">[</span><span class="skolem">x</span> <span class="main">→</span> <span class="skolem">v'</span><span class="main">]</span> Obj <span class="main">(</span><span class="skolem">f'</span><span class="main">(</span><span class="skolem">l</span> <span class="main">↦</span> <span class="skolem">t'</span><span class="main">)</span><span class="main">)</span> <span class="skolem">T</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> pred_cof_def
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>beta <span class="skolem">f</span> <span class="skolem">f'</span> <span class="skolem">T</span> <span class="skolem">l</span> <span class="skolem">p</span> <span class="skolem">p'</span><span class="main">)</span> 
    <span class="keyword1"><span class="command">note</span></span> pred_obj <span class="main">=</span> this<span class="main">(</span>2<span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span> pred_p <span class="main">=</span> this<span class="main">(</span>6<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> strip<span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">v</span> <span class="skolem">v'</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> <span class="skolem">v'</span>"</span></span>
      <span class="keyword1"><span class="command">from</span></span> 
        par_beta_lc<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span>
        ssubst_preserves_lc<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹lc <span class="skolem">p</span>›</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"lc <span class="skolem">v</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"lc <span class="skolem">v'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"lc <span class="main">(</span><span class="main">[</span><span class="skolem">x</span> <span class="main">→</span> <span class="skolem">v</span><span class="main">]</span> <span class="skolem">p</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">note</span></span> lem <span class="main">=</span> 
        pbeta_beta<span class="main">[</span><span class="operator">OF</span> _ domssubst<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">l</span> <span class="main">∈</span> dom <span class="skolem">f</span>›</span></span><span class="main"><span class="main">]</span></span> _ 
                      lcobj<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹lc <span class="main">(</span>Obj <span class="skolem">f</span> <span class="skolem">T</span><span class="main">)</span>›</span></span> this<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span> this<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹Obj <span class="skolem">f</span> <span class="skolem">T</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> Obj <span class="skolem">f'</span> <span class="skolem">T</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"dom <span class="skolem">f</span> <span class="main">=</span> dom <span class="skolem">f'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">l</span> <span class="main">∈</span> dom <span class="skolem">f</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"the <span class="main">(</span>ssubst_option <span class="skolem">x</span> <span class="skolem">v'</span> <span class="main">(</span><span class="skolem">f'</span> <span class="skolem">l</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">[</span><span class="skolem">x</span> <span class="main">→</span> <span class="skolem">v'</span><span class="main">]</span> the <span class="main">(</span><span class="skolem">f'</span> <span class="skolem">l</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">with</span></span>
        lem<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">x</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">l</span><span class="main">.</span> ssubst_option <span class="skolem">x</span> <span class="skolem">v'</span> <span class="main">(</span><span class="skolem">f'</span> <span class="bound">l</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">x</span> <span class="main">→</span> <span class="skolem">v'</span><span class="main">]</span> <span class="skolem">p'</span>"</span></span><span class="main">]</span>
        <span class="quoted"><span class="quoted">‹<span class="skolem">v</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> <span class="skolem">v'</span>›</span></span> pred_obj pred_p
        ssubst_openz_distrib<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹lc <span class="skolem">v'</span>›</span></span><span class="main">]</span>
      <span class="keyword3"><span class="command">show</span></span>
        <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">x</span> <span class="main">→</span> <span class="skolem">v</span><span class="main">]</span> Call <span class="main">(</span>Obj <span class="skolem">f</span> <span class="skolem">T</span><span class="main">)</span> <span class="skolem">l</span> <span class="skolem">p</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> <span class="main">[</span><span class="skolem">x</span> <span class="main">→</span> <span class="skolem">v'</span><span class="main">]</span> <span class="main">(</span>the <span class="main">(</span><span class="skolem">f'</span> <span class="skolem">l</span><span class="main">)</span><span class="hidden">⇗</span><sup>[Obj <span class="skolem">f'</span> <span class="skolem">T</span><span class="main">,</span> <span class="skolem">p'</span>]</sup><span class="hidden">⇖</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Obj <span class="skolem">f</span> <span class="skolem">f'</span> <span class="skolem">T</span><span class="main">)</span> <span class="keyword1"><span class="command">note</span></span> pred <span class="main">=</span> fmap_ball_all3<span class="main">[</span><span class="operator">OF</span> this<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> this<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">]</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> strip<span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">v</span> <span class="skolem">v'</span>
      <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">pred_bnd</span></span>
        <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">pred_bnd</span> <span class="skolem">s</span> <span class="skolem">p</span> <span class="skolem">b</span> <span class="skolem">b'</span> <span class="skolem">l</span> <span class="main">⟷</span>
          <span class="main">(</span><span class="main">∃</span><span class="bound">t''</span><span class="main">.</span> <span class="main">[</span><span class="skolem">x</span> <span class="main">→</span> <span class="skolem">v</span><span class="main">]</span> the <span class="skolem">b</span><span class="hidden">⇗</span><sup>[Fvar <span class="skolem">s</span><span class="main">,</span>Fvar <span class="skolem">p</span>]</sup><span class="hidden">⇖</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> <span class="bound">t''</span> <span class="main">∧</span> <span class="main">[</span><span class="skolem">x</span> <span class="main">→</span> <span class="skolem">v'</span><span class="main">]</span> the <span class="skolem">b'</span> <span class="main">=</span> <span class="keyword1">σ[</span><span class="skolem">s</span><span class="main">,</span><span class="skolem">p</span><span class="main">]</span> <span class="bound">t''</span><span class="main">)</span>"</span></span>
        <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">s</span> <span class="skolem">p</span> <span class="skolem">b</span> <span class="skolem">b'</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">l</span><span class="main">::</span><span class="quoted">Label</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> <span class="skolem">v'</span>"</span></span>
      <span class="keyword1"><span class="command">with</span></span> pred <span class="quoted"><span class="quoted">‹dom <span class="skolem">f'</span> <span class="main">=</span> dom <span class="skolem">f</span>›</span></span> fmap_ex_cof2<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">f'</span></span> <span class="quoted"><span class="skolem">f</span></span> <span class="quoted"><span class="skolem">pred_bnd</span></span><span class="main">]</span> 
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">L</span></span> <span class="keyword2"><span class="keyword">where</span></span>
        <span class="quoted"><span class="quoted">"finite <span class="skolem">L</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 
        predf<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">l</span><span class="main">∈</span>dom <span class="skolem">f</span><span class="main">.</span> <span class="skolem">pred_cof</span> <span class="skolem">L</span> <span class="main">(</span><span class="main">[</span><span class="skolem">x</span> <span class="main">→</span> <span class="skolem">v</span><span class="main">]</span> the <span class="main">(</span><span class="skolem">f</span> <span class="bound">l</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">[</span><span class="skolem">x</span> <span class="main">→</span> <span class="skolem">v'</span><span class="main">]</span> the <span class="main">(</span><span class="skolem">f'</span> <span class="bound">l</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> pred_cof_def pred_bnd_def 
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">l</span><span class="main">∈</span>dom <span class="main">(</span><span class="main">λ</span><span class="bound">l</span><span class="main">.</span> ssubst_option <span class="skolem">x</span> <span class="skolem">v</span> <span class="main">(</span><span class="skolem">f</span> <span class="bound">l</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> body <span class="main">(</span>the <span class="main">(</span>ssubst_option <span class="skolem">x</span> <span class="skolem">v</span> <span class="main">(</span><span class="skolem">f</span> <span class="bound">l</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> strip<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">l'</span> <span class="main">::</span> <span class="quoted">Label</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l'</span> <span class="main">∈</span> dom <span class="skolem">f</span>"</span></span>
        <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span><span class="bound">l</span><span class="main">∈</span>dom <span class="skolem">f</span><span class="main">.</span> body <span class="main">(</span>the<span class="main">(</span><span class="skolem">f</span> <span class="bound">l</span><span class="main">)</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"body <span class="main">(</span>the <span class="main">(</span><span class="skolem">f</span> <span class="skolem">l'</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">note</span></span> ssubst_preserves_body<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span>
        <span class="keyword1"><span class="command">from</span></span> 
          this<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">v</span></span> <span class="quoted"><span class="skolem">x</span></span><span class="main">]</span> par_beta_lc<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">v</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> <span class="skolem">v'</span>›</span></span><span class="main">]</span>
          <span class="quoted"><span class="quoted">‹<span class="skolem">l'</span> <span class="main">∈</span> dom <span class="skolem">f</span>›</span></span> ssubst_option_lem<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">f</span></span> <span class="quoted"><span class="skolem">x</span></span> <span class="quoted"><span class="skolem">v</span></span><span class="main">]</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"body <span class="main">(</span>the <span class="main">(</span>ssubst_option <span class="skolem">x</span> <span class="skolem">v</span> <span class="main">(</span><span class="skolem">f</span> <span class="skolem">l'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">note</span></span> intro <span class="main">=</span> pbeta_Obj<span class="main">[</span><span class="operator">OF</span> _ <span class="quoted"><span class="quoted">‹finite <span class="skolem">L</span>›</span></span> _ this<span class="main">]</span>
      <span class="keyword1"><span class="command">from</span></span>
        predf
        ssubst_option_lem<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">f</span></span> <span class="quoted"><span class="skolem">x</span></span> <span class="quoted"><span class="skolem">v</span></span><span class="main">]</span>
        ssubst_option_lem<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">f'</span></span> <span class="quoted"><span class="skolem">x</span></span> <span class="quoted"><span class="skolem">v'</span></span><span class="main">]</span> <span class="quoted"><span class="quoted">‹dom <span class="skolem">f'</span> <span class="main">=</span> dom <span class="skolem">f</span>›</span></span>
        dom_ssubstoption_lem<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">x</span></span> <span class="quoted"><span class="skolem">v</span></span> <span class="quoted"><span class="skolem">f</span></span><span class="main">]</span>
        dom_ssubstoption_lem<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">x</span></span> <span class="quoted"><span class="skolem">v'</span></span> <span class="quoted"><span class="skolem">f'</span></span><span class="main">]</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">x</span> <span class="main">→</span> <span class="skolem">v</span><span class="main">]</span> Obj <span class="skolem">f</span> <span class="skolem">T</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> <span class="main">[</span><span class="skolem">x</span> <span class="main">→</span> <span class="skolem">v'</span><span class="main">]</span> Obj <span class="skolem">f'</span> <span class="skolem">T</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> pred_cof_def
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> intro<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">(</span></span></span><span class="main"><span class="main"><span class="main">λ</span></span></span><span class="bound"><span class="bound"><span class="bound">l</span></span></span><span class="main"><span class="main"><span class="main">.</span></span></span> ssubst_option <span class="skolem"><span class="skolem"><span class="skolem">x</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">v'</span></span></span> <span class="main"><span class="main"><span class="main">(</span></span></span><span class="skolem"><span class="skolem"><span class="skolem">f'</span></span></span> <span class="bound"><span class="bound"><span class="bound">l</span></span></span><span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main"><span class="main">)</span></span></span>"</span></span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">T</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Bnd <span class="skolem">L</span> <span class="skolem">t</span> <span class="skolem">t'</span><span class="main">)</span> <span class="keyword1"><span class="command">note</span></span> pred <span class="main">=</span> this<span class="main">(</span>2<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> strip<span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">v</span> <span class="skolem">v'</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> <span class="skolem">v'</span>"</span></span>
      <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹finite <span class="skolem">L</span>›</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">L</span><span class="main">.</span> finite <span class="bound">L</span> <span class="main">∧</span> <span class="skolem">pred_cof</span> <span class="bound">L</span> <span class="main">(</span><span class="main">[</span><span class="skolem">x</span> <span class="main">→</span> <span class="skolem">v</span><span class="main">]</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">(</span><span class="main">[</span><span class="skolem">x</span> <span class="main">→</span> <span class="skolem">v'</span><span class="main">]</span> <span class="skolem">t'</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">L</span> <span class="main">∪</span> <span class="main">{</span><span class="skolem">x</span><span class="main">}</span> <span class="main">∪</span> FV <span class="skolem">v'</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main"><span class="keyword3">,</span></span> 
          <span class="operator">unfold</span> pred_cof_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span> <span class="skolem">p</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∉</span> <span class="skolem">L</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∉</span> <span class="skolem">L</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">≠</span> <span class="skolem">p</span>"</span></span>
        <span class="keyword1"><span class="command">with</span></span> pred 
        <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t''</span></span> <span class="keyword2"><span class="keyword">where</span></span>
          <span class="quoted"><span class="quoted">"<span class="skolem">t</span><span class="hidden">⇗</span><sup>[Fvar <span class="skolem">s</span><span class="main">,</span>Fvar <span class="skolem">p</span>]</sup><span class="hidden">⇖</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> <span class="skolem">t''</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
          <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span> <span class="bound">v</span> <span class="bound">v'</span><span class="main">.</span> <span class="bound">v</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> <span class="bound">v'</span> <span class="main">⟶</span> <span class="main">[</span><span class="bound">x</span> <span class="main">→</span> <span class="bound">v</span><span class="main">]</span> <span class="main">(</span><span class="skolem">t</span><span class="hidden">⇗</span><sup>[Fvar <span class="skolem">s</span><span class="main">,</span>Fvar <span class="skolem">p</span>]</sup><span class="hidden">⇖</span><span class="main">)</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> <span class="main">[</span><span class="bound">x</span> <span class="main">→</span> <span class="bound">v'</span><span class="main">]</span> <span class="skolem">t''</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
          <span class="quoted"><span class="quoted">"<span class="skolem">t'</span> <span class="main">=</span> <span class="keyword1">σ[</span><span class="skolem">s</span><span class="main">,</span><span class="skolem">p</span><span class="main">]</span> <span class="skolem">t''</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">from</span></span> this<span class="main">(</span>2<span class="main">)</span> <span class="quoted"><span class="quoted">‹<span class="skolem">v</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> <span class="skolem">v'</span>›</span></span> 
        <span class="keyword1"><span class="command">have</span></span> ssubst_pbeta<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">x</span> <span class="main">→</span> <span class="skolem">v</span><span class="main">]</span> <span class="main">(</span><span class="skolem">t</span><span class="hidden">⇗</span><sup>[Fvar <span class="skolem">s</span><span class="main">,</span>Fvar <span class="skolem">p</span>]</sup><span class="hidden">⇖</span><span class="main">)</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> <span class="main">[</span><span class="skolem">x</span> <span class="main">→</span> <span class="skolem">v'</span><span class="main">]</span> <span class="skolem">t''</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">≠</span> <span class="skolem">x</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">≠</span> <span class="skolem">x</span>"</span></span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> FV <span class="main">(</span>Fvar <span class="skolem">s</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> FV <span class="main">(</span>Fvar <span class="skolem">p</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">from</span></span> 
          ssubst_pbeta
          par_beta_lc<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">v</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> <span class="skolem">v'</span>›</span></span><span class="main">]</span> ssubst_sopen_commute<span class="main">[</span><span class="operator">OF</span> _ this<span class="main">]</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">x</span> <span class="main">→</span> <span class="skolem">v</span><span class="main">]</span> <span class="skolem">t</span><span class="hidden">⇗</span><sup>[Fvar <span class="skolem">s</span><span class="main">,</span>Fvar <span class="skolem">p</span>]</sup><span class="hidden">⇖</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> <span class="main">[</span><span class="skolem">x</span> <span class="main">→</span> <span class="skolem">v'</span><span class="main">]</span> <span class="skolem">t''</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> openz_def<span class="main">)</span>
        <span class="keyword1"><span class="command">moreover</span></span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∉</span> FV <span class="skolem">v'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∉</span> FV <span class="skolem">v'</span>"</span></span>
        <span class="keyword1"><span class="command">from</span></span> 
          ssubst_sclose_commute<span class="main">[</span><span class="operator">OF</span> this not_sym<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">s</span> <span class="main">≠</span> <span class="skolem">x</span>›</span></span><span class="main"><span class="main">]</span></span> 
                                        not_sym<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="main">≠</span> <span class="skolem">x</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span> 
          <span class="quoted"><span class="quoted">‹<span class="skolem">t'</span> <span class="main">=</span> <span class="keyword1">σ[</span><span class="skolem">s</span><span class="main">,</span><span class="skolem">p</span><span class="main">]</span> <span class="skolem">t''</span>›</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">x</span> <span class="main">→</span> <span class="skolem">v'</span><span class="main">]</span> <span class="skolem">t'</span> <span class="main">=</span> <span class="keyword1">σ[</span><span class="skolem">s</span><span class="main">,</span><span class="skolem">p</span><span class="main">]</span> <span class="main">[</span><span class="skolem">x</span> <span class="main">→</span> <span class="skolem">v'</span><span class="main">]</span> <span class="skolem">t''</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> closez_def<span class="main">)</span>
        <span class="keyword1"><span class="command">ultimately</span></span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">t''</span><span class="main">.</span> <span class="main">[</span><span class="skolem">x</span> <span class="main">→</span> <span class="skolem">v</span><span class="main">]</span> <span class="skolem">t</span><span class="hidden">⇗</span><sup>[Fvar <span class="skolem">s</span><span class="main">,</span>Fvar <span class="skolem">p</span>]</sup><span class="hidden">⇖</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> <span class="bound">t''</span> <span class="main">∧</span> <span class="main">[</span><span class="skolem">x</span> <span class="main">→</span> <span class="skolem">v'</span><span class="main">]</span> <span class="skolem">t'</span> <span class="main">=</span> <span class="keyword1">σ[</span><span class="skolem">s</span><span class="main">,</span><span class="skolem">p</span><span class="main">]</span> <span class="bound">t''</span>"</span></span> 
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">x</span> <span class="main">→</span> <span class="skolem">v'</span><span class="main">]</span> <span class="skolem">t''</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="ParRed-renaming_par_beta"><span class="command">lemma</span></span> renaming_par_beta<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> <span class="free">t'</span> <span class="main">⟹</span> <span class="main">[</span><span class="free">s</span> <span class="main">→</span> Fvar <span class="free">sa</span><span class="main">]</span> <span class="free">t</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> <span class="main">[</span><span class="free">s</span> <span class="main">→</span> Fvar <span class="free">sa</span><span class="main">]</span> <span class="free">t'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule</span> par_beta_ssubst<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>

<span class="keyword1" id="ParRed-par_beta_beta"><span class="command">lemma</span></span> par_beta_beta<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">l</span> <span class="free">f</span> <span class="free">f'</span> <span class="free">u</span> <span class="free">u'</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">∈</span> dom <span class="free">f</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"Obj <span class="free">f</span> <span class="free">T</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> Obj <span class="free">f'</span> <span class="free">T</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> <span class="free">u'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"lc <span class="main">(</span>Obj <span class="free">f</span> <span class="free">T</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"lc <span class="free">u</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>the<span class="main">(</span><span class="free">f</span> <span class="free">l</span><span class="main">)</span><span class="hidden">⇗</span><sup>[Obj <span class="free">f</span> <span class="free">T</span><span class="main">,</span> <span class="free">u</span>]</sup><span class="hidden">⇖</span><span class="main">)</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> <span class="main">(</span>the<span class="main">(</span><span class="free">f'</span> <span class="free">l</span><span class="main">)</span><span class="hidden">⇗</span><sup>[Obj <span class="free">f'</span> <span class="free">T</span><span class="main">,</span> <span class="free">u'</span>]</sup><span class="hidden">⇖</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> Obj_pbeta<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹Obj <span class="free">f</span> <span class="free">T</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> Obj <span class="free">f'</span> <span class="free">T</span>›</span></span><span class="main">]</span> 
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">L</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
    <span class="quoted"><span class="quoted">"dom <span class="free">f</span> <span class="main">=</span> dom <span class="free">f'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"finite <span class="skolem">L</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    pred_sp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">l</span><span class="main">∈</span>dom <span class="free">f</span><span class="main">.</span><span class="main">∀</span><span class="bound">s</span> <span class="bound">p</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∉</span> <span class="skolem">L</span> <span class="main">∧</span> <span class="bound">p</span> <span class="main">∉</span> <span class="skolem">L</span> <span class="main">∧</span> <span class="bound">s</span> <span class="main">≠</span> <span class="bound">p</span>
                         <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">t''</span><span class="main">.</span> the <span class="main">(</span><span class="free">f</span> <span class="bound">l</span><span class="main">)</span><span class="hidden">⇗</span><sup>[Fvar <span class="bound">s</span><span class="main">,</span>Fvar <span class="bound">p</span>]</sup><span class="hidden">⇖</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> <span class="bound">t''</span> 
                                  <span class="main">∧</span> the <span class="main">(</span><span class="free">f'</span> <span class="bound">l</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">σ[</span><span class="bound">s</span><span class="main">,</span><span class="bound">p</span><span class="main">]</span> <span class="bound">t''</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">l</span><span class="main">∈</span>dom <span class="free">f</span><span class="main">.</span> body <span class="main">(</span>the <span class="main">(</span><span class="free">f</span> <span class="bound">l</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">from</span></span> this<span class="main">(</span>2<span class="main">)</span> finite_FV<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"Obj <span class="free">f</span> <span class="free">T</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> fin<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="skolem">L</span> <span class="main">∪</span> FV <span class="main">(</span>Obj <span class="free">f</span> <span class="free">T</span><span class="main">)</span> <span class="main">∪</span> FV <span class="free">u</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> exFresh_s_p_cof<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
    sp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∉</span> <span class="skolem">L</span> <span class="main">∪</span> FV <span class="main">(</span>Obj <span class="free">f</span> <span class="free">T</span><span class="main">)</span> <span class="main">∪</span> FV <span class="free">u</span> <span class="main">∧</span> <span class="skolem">p</span> <span class="main">∉</span> <span class="skolem">L</span> <span class="main">∪</span> FV <span class="main">(</span>Obj <span class="free">f</span> <span class="free">T</span><span class="main">)</span> <span class="main">∪</span> FV <span class="free">u</span> <span class="main">∧</span> <span class="skolem">s</span> <span class="main">≠</span> <span class="skolem">p</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="free">l</span> <span class="main">∈</span> dom <span class="free">f</span>›</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t''</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
    <span class="quoted"><span class="quoted">"the <span class="main">(</span><span class="free">f</span> <span class="free">l</span><span class="main">)</span><span class="hidden">⇗</span><sup>[Fvar <span class="skolem">s</span><span class="main">,</span> Fvar <span class="skolem">p</span>]</sup><span class="hidden">⇖</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> <span class="skolem">t''</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"the <span class="main">(</span><span class="free">f'</span> <span class="free">l</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">σ[</span><span class="skolem">s</span><span class="main">,</span><span class="skolem">p</span><span class="main">]</span> <span class="skolem">t''</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> pred_sp <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> par_beta_lc<span class="main">[</span><span class="operator">OF</span> this<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"lc <span class="skolem">t''</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> 
    sopen_sclose_eq_t<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> 
    <span class="quoted"><span class="quoted">‹the <span class="main">(</span><span class="free">f</span> <span class="free">l</span><span class="main">)</span><span class="hidden">⇗</span><sup>[Fvar <span class="skolem">s</span><span class="main">,</span> Fvar <span class="skolem">p</span>]</sup><span class="hidden">⇖</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> <span class="skolem">t''</span>›</span></span> <span class="quoted"><span class="quoted">‹the<span class="main">(</span><span class="free">f'</span> <span class="free">l</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">σ[</span><span class="skolem">s</span><span class="main">,</span><span class="skolem">p</span><span class="main">]</span> <span class="skolem">t''</span>›</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"the <span class="main">(</span><span class="free">f</span> <span class="free">l</span><span class="main">)</span><span class="hidden">⇗</span><sup>[Fvar <span class="skolem">s</span><span class="main">,</span> Fvar <span class="skolem">p</span>]</sup><span class="hidden">⇖</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> <span class="main">(</span>the <span class="main">(</span><span class="free">f'</span> <span class="free">l</span><span class="main">)</span><span class="hidden">⇗</span><sup>[Fvar <span class="skolem">s</span><span class="main">,</span> Fvar <span class="skolem">p</span>]</sup><span class="hidden">⇖</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> openz_def closez_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> par_beta_ssubst<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> <span class="quoted"><span class="quoted">‹<span class="free">u</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> <span class="free">u'</span>›</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">p</span> <span class="main">→</span> <span class="free">u</span><span class="main">]</span> <span class="main">(</span>the <span class="main">(</span><span class="free">f</span> <span class="free">l</span><span class="main">)</span><span class="hidden">⇗</span><sup>[Fvar <span class="skolem">s</span><span class="main">,</span> Fvar <span class="skolem">p</span>]</sup><span class="hidden">⇖</span><span class="main">)</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> <span class="main">[</span><span class="skolem">p</span> <span class="main">→</span> <span class="free">u'</span><span class="main">]</span> <span class="main">(</span>the <span class="main">(</span><span class="free">f'</span> <span class="free">l</span><span class="main">)</span><span class="hidden">⇗</span><sup>[Fvar <span class="skolem">s</span><span class="main">,</span> Fvar <span class="skolem">p</span>]</sup><span class="hidden">⇖</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">note</span></span> par_beta_ssubst<span class="main">[</span><span class="operator">OF</span> this <span class="quoted"><span class="quoted">‹Obj <span class="free">f</span> <span class="free">T</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> Obj <span class="free">f'</span> <span class="free">T</span>›</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="free">l</span> <span class="main">∈</span> dom <span class="free">f</span>›</span></span> sp
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∉</span> FV <span class="main">(</span>the<span class="main">(</span><span class="free">f</span> <span class="free">l</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∉</span> FV <span class="main">(</span>the<span class="main">(</span><span class="free">f</span> <span class="free">l</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">≠</span> <span class="skolem">p</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∉</span> FV <span class="free">u</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">note</span></span> ssubst_intro<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="free">l</span> <span class="main">∈</span> dom <span class="free">f</span>›</span></span> <span class="quoted"><span class="quoted">‹dom <span class="free">f</span> <span class="main">=</span> dom <span class="free">f'</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">∈</span> dom <span class="free">f'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">with</span></span> 
    par_beta_preserves_FV<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹Obj <span class="free">f</span> <span class="free">T</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> Obj <span class="free">f'</span> <span class="free">T</span>›</span></span><span class="main">]</span>
    par_beta_preserves_FV<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">u</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> <span class="free">u'</span>›</span></span><span class="main">]</span> sp FV_option_lem<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">f'</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∉</span> FV <span class="main">(</span>the <span class="main">(</span><span class="free">f'</span> <span class="free">l</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∉</span> FV <span class="main">(</span>the <span class="main">(</span><span class="free">f'</span> <span class="free">l</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">≠</span> <span class="skolem">p</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∉</span> FV <span class="free">u'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">note</span></span> ssubst_intro<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"the <span class="main">(</span><span class="free">f</span> <span class="free">l</span><span class="main">)</span><span class="hidden">⇗</span><sup>[Obj <span class="free">f</span> <span class="free">T</span><span class="main">,</span> <span class="free">u</span>]</sup><span class="hidden">⇖</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> <span class="main">(</span>the <span class="main">(</span><span class="free">f'</span> <span class="free">l</span><span class="main">)</span><span class="hidden">⇗</span><sup>[Obj <span class="free">f'</span> <span class="free">T</span><span class="main">,</span> <span class="free">u'</span>]</sup><span class="hidden">⇖</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> openz_def closez_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Inclusions›</span></span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹<span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>beta ⊆ par_beta ⊆ beta^*›</span></span></span></span> \medskip›</span></span>
<span class="keyword1" id="ParRed-beta_subset_par_beta"><span class="command">lemma</span></span> beta_subset_par_beta<span class="main">:</span> <span class="quoted"><span class="quoted">"beta <span class="main">≤</span> par_beta"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">clarify</span><span class="main">)</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">pred_cof</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">pred_cof</span> <span class="skolem">L</span> <span class="skolem">t</span> <span class="skolem">t'</span> <span class="main">⟷</span>
      <span class="main">(</span><span class="main">∀</span><span class="bound">s</span> <span class="bound">p</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∉</span> <span class="skolem">L</span> <span class="main">∧</span> <span class="bound">p</span> <span class="main">∉</span> <span class="skolem">L</span> <span class="main">∧</span> <span class="bound">s</span> <span class="main">≠</span> <span class="bound">p</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">t''</span><span class="main">.</span> <span class="main">(</span><span class="skolem">t</span><span class="hidden">⇗</span><sup>[Fvar <span class="bound">s</span><span class="main">,</span> Fvar <span class="bound">p</span>]</sup><span class="hidden">⇖</span><span class="main">)</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> <span class="bound">t''</span> <span class="main">∧</span> <span class="skolem">t'</span> <span class="main">=</span> <span class="keyword1">σ[</span><span class="bound">s</span><span class="main">,</span><span class="bound">p</span><span class="main">]</span> <span class="bound">t''</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">L</span> <span class="skolem">t</span> <span class="skolem">t'</span>

  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">t</span> <span class="skolem">t'</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>β</sub></span> <span class="skolem">t'</span>"</span></span> <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> <span class="skolem">t'</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> 
    <span class="main">(</span><span class="operator">induct</span>
      <span class="quasi_keyword">taking</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">t</span> <span class="bound">t'</span><span class="main">.</span> body <span class="bound">t</span> <span class="main">∧</span> body <span class="bound">t'</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span><span class="bound">L</span><span class="main">.</span> finite <span class="bound">L</span> <span class="main">∧</span> <span class="skolem">pred_cof</span> <span class="bound">L</span> <span class="bound">t</span> <span class="bound">t'</span><span class="main">)</span>"</span></span>
      <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> beta_induct<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> CallL <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> par_beta_refl<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> CallR <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> par_beta_refl<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> beta <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> par_beta_refl<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> UpdL
    <span class="keyword1"><span class="command">from</span></span> 
      par_beta_lc<span class="main">[</span><span class="operator">OF</span> this<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> this<span class="main">(</span>2<span class="main">)</span> 
      par_beta_body_refl<span class="main">[</span><span class="operator">OF</span> this<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">]</span> this<span class="main">(</span>3<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>UpdR <span class="skolem">t</span> <span class="skolem">t'</span> <span class="skolem">u</span> <span class="skolem">l</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> this<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">L</span></span> <span class="keyword2"><span class="keyword">where</span></span>
      <span class="quoted"><span class="quoted">"finite <span class="skolem">L</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">pred_cof</span> <span class="skolem">L</span> <span class="skolem">t</span> <span class="skolem">t'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"body <span class="skolem">t</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> 
      this<span class="main">(</span>2<span class="main">)</span> pbeta_Upd<span class="main">[</span><span class="operator">OF</span> par_beta_refl<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹lc <span class="skolem">u</span>›</span></span><span class="main"><span class="main">]</span></span> <span class="quoted"><span class="quoted">‹lc <span class="skolem">u</span>›</span></span> this<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> _ this<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">]</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> pred_cof_def
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Upd <span class="skolem">l</span> <span class="skolem">f</span> <span class="skolem">T</span> <span class="skolem">t</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> par_beta_body_refl<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹body <span class="skolem">t</span>›</span></span><span class="main">]</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">L</span></span> <span class="keyword2"><span class="keyword">where</span></span>
      <span class="quoted"><span class="quoted">"finite <span class="skolem">L</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 
      <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">s</span> <span class="bound">p</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∉</span> <span class="skolem">L</span> <span class="main">∧</span> <span class="bound">p</span> <span class="main">∉</span> <span class="skolem">L</span> <span class="main">∧</span> <span class="bound">s</span> <span class="main">≠</span> <span class="bound">p</span> 
        <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">t'</span><span class="main">.</span> <span class="skolem">t</span><span class="hidden">⇗</span><sup>[Fvar <span class="bound">s</span><span class="main">,</span> Fvar <span class="bound">p</span>]</sup><span class="hidden">⇖</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> <span class="bound">t'</span> <span class="main">∧</span> <span class="skolem">t</span> <span class="main">=</span> <span class="keyword1">σ[</span><span class="bound">s</span><span class="main">,</span><span class="bound">p</span><span class="main">]</span> <span class="bound">t'</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> 
      pbeta_Upd'<span class="main">[</span><span class="operator">OF</span> par_beta_refl<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹lc <span class="main">(</span>Obj <span class="skolem">f</span> <span class="skolem">T</span><span class="main">)</span>›</span></span><span class="main"><span class="main">]</span></span> this
                    <span class="quoted"><span class="quoted">‹<span class="skolem">l</span> <span class="main">∈</span> dom <span class="skolem">f</span>›</span></span> <span class="quoted"><span class="quoted">‹lc <span class="main">(</span>Obj <span class="skolem">f</span> <span class="skolem">T</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹body <span class="skolem">t</span>›</span></span><span class="main">]</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">assumption</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Obj <span class="skolem">l</span> <span class="skolem">f</span> <span class="skolem">t</span> <span class="skolem">t'</span> <span class="skolem">T</span><span class="main">)</span> <span class="keyword1"><span class="command">note</span></span> cof <span class="main">=</span> this<span class="main">(</span>2<span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span> body <span class="main">=</span> this<span class="main">(</span>3<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> cof <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">L</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
      <span class="quoted"><span class="quoted">"body <span class="skolem">t</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"finite <span class="skolem">L</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">pred_cof</span> <span class="skolem">L</span> <span class="skolem">t</span> <span class="skolem">t'</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> body <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"lc <span class="main">(</span>Obj <span class="skolem">f</span> <span class="skolem">T</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lc_obj<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> 
      Obj_pbeta_subst<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹finite <span class="skolem">L</span>›</span></span> _ par_beta_refl<span class="main"><span class="main">[</span></span><span class="operator">OF</span> this<span class="main"><span class="main">]</span></span> this <span class="quoted"><span class="quoted">‹body <span class="skolem">t</span>›</span></span><span class="main">]</span>
      <span class="quoted"><span class="quoted">‹<span class="skolem">pred_cof</span> <span class="skolem">L</span> <span class="skolem">t</span> <span class="skolem">t'</span>›</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> pred_cof_def
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Bnd <span class="skolem">L</span> <span class="skolem">t</span> <span class="skolem">t'</span><span class="main">)</span> <span class="keyword1"><span class="command">note</span></span> pred <span class="main">=</span> this<span class="main">(</span>2<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹finite <span class="skolem">L</span>›</span></span> exFresh_s_p_cof<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">L</span> <span class="main">∪</span> FV <span class="skolem">t</span>"</span></span><span class="main">]</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
      <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∉</span> <span class="skolem">L</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∉</span> <span class="skolem">L</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">≠</span> <span class="skolem">p</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∉</span> FV <span class="skolem">t</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∉</span> FV <span class="skolem">t</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> pred <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t''</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
      <span class="quoted"><span class="quoted">"<span class="skolem">t</span><span class="hidden">⇗</span><sup>[Fvar <span class="skolem">s</span><span class="main">,</span> Fvar <span class="skolem">p</span>]</sup><span class="hidden">⇖</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> <span class="skolem">t''</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t'</span> <span class="main">=</span> <span class="keyword1">σ[</span><span class="skolem">s</span><span class="main">,</span><span class="skolem">p</span><span class="main">]</span> <span class="skolem">t''</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">from</span></span> 
      par_beta_lc<span class="main">[</span><span class="operator">OF</span> this<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> this<span class="main">(</span>2<span class="main">)</span> lc_body<span class="main">[</span><span class="operator">OF</span> _ <span class="quoted"><span class="quoted">‹<span class="skolem">s</span> <span class="main">≠</span> <span class="skolem">p</span>›</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"body <span class="keyword1">σ[</span><span class="skolem">s</span><span class="main">,</span><span class="skolem">p</span><span class="main">]</span><span class="main">(</span><span class="skolem">t</span><span class="hidden">⇗</span><sup>[Fvar <span class="skolem">s</span><span class="main">,</span> Fvar <span class="skolem">p</span>]</sup><span class="hidden">⇖</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"body <span class="skolem">t'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> this<span class="main">(</span>1<span class="main">)</span> sclose_sopen_eq_t<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">s</span> <span class="main">∉</span> FV <span class="skolem">t</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="main">∉</span> FV <span class="skolem">t</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">s</span> <span class="main">≠</span> <span class="skolem">p</span>›</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"body <span class="skolem">t</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> openz_def closez_def<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹body <span class="skolem">t'</span>›</span></span> <span class="quoted"><span class="quoted">‹finite <span class="skolem">L</span>›</span></span> pred <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> pred_cof_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="skolem">L</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="ParRed-par_beta_subset_beta"><span class="command">lemma</span></span> par_beta_subset_beta<span class="main">:</span> <span class="quoted"><span class="quoted">"par_beta <span class="main">≤</span> beta<span class="main">^**</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> predicate2I<span class="main">)</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">pred_cof</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">pred_cof</span> <span class="skolem">L</span> <span class="skolem">t</span> <span class="skolem">t'</span> <span class="main">⟷</span>
      <span class="main">(</span><span class="main">∀</span><span class="bound">s</span> <span class="bound">p</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∉</span> <span class="skolem">L</span> <span class="main">∧</span> <span class="bound">p</span> <span class="main">∉</span> <span class="skolem">L</span> <span class="main">∧</span> <span class="bound">s</span> <span class="main">≠</span> <span class="bound">p</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">t''</span><span class="main">.</span> <span class="main">(</span><span class="skolem">t</span><span class="hidden">⇗</span><sup>[Fvar <span class="bound">s</span><span class="main">,</span> Fvar <span class="bound">p</span>]</sup><span class="hidden">⇖</span><span class="main">)</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>β</sub><span class="hidden">⇧</span><sup>*</sup></span> <span class="bound">t''</span> <span class="main">∧</span> <span class="skolem">t'</span> <span class="main">=</span> <span class="keyword1">σ[</span><span class="bound">s</span><span class="main">,</span><span class="bound">p</span><span class="main">]</span> <span class="bound">t''</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">L</span> <span class="skolem">t</span> <span class="skolem">t'</span>

  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">y</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> <span class="skolem">y</span>"</span></span> <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>β</sub><span class="hidden">⇧</span><sup>*</sup></span> <span class="skolem">y</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> 
      <span class="quasi_keyword">taking</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">t</span> <span class="bound">t'</span><span class="main">.</span> body <span class="bound">t'</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span><span class="bound">L</span><span class="main">.</span> finite <span class="bound">L</span> <span class="main">∧</span> <span class="skolem">pred_cof</span> <span class="bound">L</span> <span class="bound">t</span> <span class="bound">t'</span><span class="main">)</span>"</span></span>
      <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> pbeta_induct<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> Fvar <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> Call <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Upd <span class="skolem">t</span> <span class="skolem">t'</span> <span class="skolem">l</span> <span class="skolem">u</span> <span class="skolem">u'</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> this<span class="main">(</span>4<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">L</span></span> <span class="keyword2"><span class="keyword">where</span></span>
      <span class="quoted"><span class="quoted">"finite <span class="skolem">L</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">pred_cof</span> <span class="skolem">L</span> <span class="skolem">u</span> <span class="skolem">u'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> 
      this<span class="main">(</span>2<span class="main">)</span> 
      rtrancl_beta_Upd<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">t</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>β</sub><span class="hidden">⇧</span><sup>*</sup></span> <span class="skolem">t'</span>›</span></span> this<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> _ <span class="quoted"><span class="quoted">‹lc <span class="skolem">t</span>›</span></span> <span class="quoted"><span class="quoted">‹body <span class="skolem">u</span>›</span></span><span class="main">]</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> pred_cof_def
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Upd' <span class="skolem">f</span> <span class="skolem">f'</span> <span class="skolem">T</span> <span class="skolem">t</span> <span class="skolem">t'</span> <span class="skolem">l</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> this<span class="main">(</span>3<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">L</span></span> <span class="keyword2"><span class="keyword">where</span></span>
      <span class="quoted"><span class="quoted">"body <span class="skolem">t'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"finite <span class="skolem">L</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">pred_cof</span> <span class="skolem">L</span> <span class="skolem">t</span> <span class="skolem">t'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> 
      this<span class="main">(</span>3<span class="main">)</span>
      rtrancl_beta_Upd<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹Obj <span class="skolem">f</span> <span class="skolem">T</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>β</sub><span class="hidden">⇧</span><sup>*</sup></span> Obj <span class="skolem">f'</span> <span class="skolem">T</span>›</span></span> <span class="quoted"><span class="quoted">‹finite <span class="skolem">L</span>›</span></span> _
                          <span class="quoted"><span class="quoted">‹lc <span class="main">(</span>Obj <span class="skolem">f</span> <span class="skolem">T</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹body <span class="skolem">t</span>›</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> rtranclp<span class="main">:</span> <span class="quoted"><span class="quoted">"Upd <span class="main">(</span>Obj <span class="skolem">f</span> <span class="skolem">T</span><span class="main">)</span> <span class="skolem">l</span> <span class="skolem">t</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>β</sub><span class="hidden">⇧</span><sup>*</sup></span> Upd <span class="main">(</span>Obj <span class="skolem">f'</span> <span class="skolem">T</span><span class="main">)</span> <span class="skolem">l</span> <span class="skolem">t'</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> pred_cof_def
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

    <span class="keyword1"><span class="command">from</span></span> 
      Obj_pbeta<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹Obj <span class="skolem">f</span> <span class="skolem">T</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> Obj <span class="skolem">f'</span> <span class="skolem">T</span>›</span></span><span class="main">]</span> <span class="quoted"><span class="quoted">‹<span class="skolem">l</span> <span class="main">∈</span> dom <span class="skolem">f</span>›</span></span> 
      par_beta_lc<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹Obj <span class="skolem">f</span> <span class="skolem">T</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> Obj <span class="skolem">f'</span> <span class="skolem">T</span>›</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">∈</span> dom <span class="skolem">f'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"lc <span class="main">(</span>Obj <span class="skolem">f'</span> <span class="skolem">T</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> beta_Upd<span class="main">[</span><span class="operator">OF</span> this <span class="quoted"><span class="quoted">‹body <span class="skolem">t'</span>›</span></span><span class="main">]</span> rtranclp
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Obj <span class="skolem">f</span> <span class="skolem">f'</span> <span class="skolem">T</span><span class="main">)</span> <span class="keyword1"><span class="command">note</span></span> body <span class="main">=</span> this<span class="main">(</span>2<span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span> pred <span class="main">=</span> this<span class="main">(</span>3<span class="main">)</span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">pred_bnd</span></span>
      <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">pred_bnd</span> <span class="skolem">s</span> <span class="skolem">p</span> <span class="skolem">b</span> <span class="skolem">b'</span> <span class="skolem">l</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">t''</span><span class="main">.</span> the <span class="skolem">b</span><span class="hidden">⇗</span><sup>[Fvar <span class="skolem">s</span><span class="main">,</span>Fvar <span class="skolem">p</span>]</sup><span class="hidden">⇖</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>β</sub><span class="hidden">⇧</span><sup>*</sup></span> <span class="bound">t''</span> <span class="main">∧</span> the <span class="skolem">b'</span> <span class="main">=</span> <span class="keyword1">σ[</span><span class="skolem">s</span><span class="main">,</span><span class="skolem">p</span><span class="main">]</span> <span class="bound">t''</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">s</span> <span class="skolem">p</span> <span class="skolem">b</span> <span class="skolem">b'</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">l</span><span class="main">::</span><span class="quoted">Label</span>
    <span class="keyword1"><span class="command">from</span></span> 
      pred <span class="quoted"><span class="quoted">‹dom <span class="skolem">f'</span> <span class="main">=</span> dom <span class="skolem">f</span>›</span></span> fmap_ex_cof2<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">f'</span></span> <span class="quoted"><span class="skolem">f</span></span> <span class="quoted"><span class="skolem">pred_bnd</span></span><span class="main">]</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">L</span></span> <span class="keyword2"><span class="keyword">where</span></span>
      <span class="quoted"><span class="quoted">"finite <span class="skolem">L</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 
      <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">l</span><span class="main">∈</span>dom <span class="skolem">f</span><span class="main">.</span> <span class="main">∀</span><span class="bound">s</span> <span class="bound">p</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∉</span> <span class="skolem">L</span> <span class="main">∧</span> <span class="bound">p</span> <span class="main">∉</span> <span class="skolem">L</span> <span class="main">∧</span> <span class="bound">s</span> <span class="main">≠</span> <span class="bound">p</span> <span class="main">⟶</span> <span class="skolem">pred_bnd</span> <span class="bound">s</span> <span class="bound">p</span> <span class="main">(</span><span class="skolem">f</span> <span class="bound">l</span><span class="main">)</span> <span class="main">(</span><span class="skolem">f'</span> <span class="bound">l</span><span class="main">)</span> <span class="bound">l</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> pred_cof_def pred_bnd_def
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> 
      this<span class="main">(</span>2<span class="main">)</span>
      rtrancl_beta_obj_n<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹finite <span class="skolem">L</span>›</span></span> _ sym<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹dom <span class="skolem">f'</span> <span class="main">=</span> dom <span class="skolem">f</span>›</span></span><span class="main"><span class="main">]</span></span> body<span class="main">]</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> pred_bnd_def
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>beta <span class="skolem">f</span> <span class="skolem">f'</span> <span class="skolem">T</span> <span class="skolem">l</span> <span class="skolem">p</span> <span class="skolem">p'</span><span class="main">)</span>
    <span class="keyword1"><span class="command">note</span></span> 
      rtrancl_beta_Call<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹Obj <span class="skolem">f</span> <span class="skolem">T</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>β</sub><span class="hidden">⇧</span><sup>*</sup></span> Obj <span class="skolem">f'</span> <span class="skolem">T</span>›</span></span> <span class="quoted"><span class="quoted">‹lc <span class="main">(</span>Obj <span class="skolem">f</span> <span class="skolem">T</span><span class="main">)</span>›</span></span> 
                           <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>β</sub><span class="hidden">⇧</span><sup>*</sup></span> <span class="skolem">p'</span>›</span></span> <span class="quoted"><span class="quoted">‹lc <span class="skolem">p</span>›</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">from</span></span> 
      Obj_pbeta<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹Obj <span class="skolem">f</span> <span class="skolem">T</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> Obj <span class="skolem">f'</span> <span class="skolem">T</span>›</span></span><span class="main">]</span> <span class="quoted"><span class="quoted">‹<span class="skolem">l</span> <span class="main">∈</span> dom <span class="skolem">f</span>›</span></span> 
      par_beta_lc<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹Obj <span class="skolem">f</span> <span class="skolem">T</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> Obj <span class="skolem">f'</span> <span class="skolem">T</span>›</span></span><span class="main">]</span>
      par_beta_lc<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> <span class="skolem">p'</span>›</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">∈</span> dom <span class="skolem">f'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"lc <span class="main">(</span>Obj <span class="skolem">f'</span> <span class="skolem">T</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"lc <span class="skolem">p'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">note</span></span> beta.beta<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span>
    <span class="keyword1"><span class="command">ultimately</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> rtranclp.rtrancl_into_rtrancl<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"Call <span class="main">(</span>Obj <span class="skolem">f'</span> <span class="skolem">T</span><span class="main">)</span> <span class="skolem">l</span> <span class="skolem">p'</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Bnd <span class="skolem">L</span> <span class="skolem">t</span> <span class="skolem">t'</span><span class="main">)</span> <span class="keyword1"><span class="command">note</span></span> pred <span class="main">=</span> this<span class="main">(</span>2<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">pred_cof</span> <span class="skolem">L</span> <span class="skolem">t</span> <span class="skolem">t'</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> pred_cof_def
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">from</span></span> pred <span class="quoted"><span class="quoted">‹finite <span class="skolem">L</span>›</span></span> par_beta_body<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">L</span></span> <span class="quoted"><span class="skolem">t</span></span> <span class="quoted"><span class="skolem">t'</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"body <span class="skolem">t'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">ultimately</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹finite <span class="skolem">L</span>›</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Confluence (directly)›</span></span>

<span class="comment1">(***Main result: Confluence of beta relation for Sigma calculus              ***)</span>
<span class="comment1">(*** by diamond property of parallel reduction and beta &lt;= par_beta &lt;= beta^* ***)</span>
<span class="keyword1" id="ParRed-diamond_binder"><span class="command">lemma</span></span> diamond_binder<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">L1</span> <span class="free">L2</span> <span class="free">t</span> <span class="free">ta</span> <span class="free">tb</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> 
  <span class="quoted"><span class="quoted">"finite <span class="free">L1</span>"</span></span>  <span class="keyword2"><span class="keyword">and</span></span>
  pred_L1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">s</span> <span class="bound">p</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∉</span> <span class="free">L1</span> <span class="main">∧</span> <span class="bound">p</span> <span class="main">∉</span> <span class="free">L1</span> <span class="main">∧</span> <span class="bound">s</span> <span class="main">≠</span> <span class="bound">p</span>
              <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">t'</span><span class="main">.</span> <span class="main">(</span><span class="free">t</span><span class="hidden">⇗</span><sup>[Fvar <span class="bound">s</span><span class="main">,</span> Fvar <span class="bound">p</span>]</sup><span class="hidden">⇖</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> <span class="bound">t'</span> 
                     <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">z</span><span class="main">.</span> <span class="main">(</span><span class="free">t</span><span class="hidden">⇗</span><sup>[Fvar <span class="bound">s</span><span class="main">,</span> Fvar  <span class="bound">p</span>]</sup><span class="hidden">⇖</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> <span class="bound">z</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">u</span><span class="main">.</span> <span class="bound">t'</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> <span class="bound">u</span> <span class="main">∧</span> <span class="bound">z</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> <span class="bound">u</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> 
                     <span class="main">∧</span> <span class="free">ta</span> <span class="main">=</span> <span class="keyword1">σ[</span><span class="bound">s</span><span class="main">,</span><span class="bound">p</span><span class="main">]</span><span class="bound">t'</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  <span class="quoted"><span class="quoted">"finite <span class="free">L2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  pred_L2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">s</span> <span class="bound">p</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∉</span> <span class="free">L2</span> <span class="main">∧</span> <span class="bound">p</span> <span class="main">∉</span> <span class="free">L2</span> <span class="main">∧</span> <span class="bound">s</span> <span class="main">≠</span> <span class="bound">p</span> 
              <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">t'</span><span class="main">.</span> <span class="free">t</span><span class="hidden">⇗</span><sup>[Fvar <span class="bound">s</span><span class="main">,</span> Fvar <span class="bound">p</span>]</sup><span class="hidden">⇖</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> <span class="bound">t'</span> <span class="main">∧</span> <span class="free">tb</span> <span class="main">=</span> <span class="keyword1">σ[</span><span class="bound">s</span><span class="main">,</span><span class="bound">p</span><span class="main">]</span><span class="bound">t'</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">L'</span><span class="main">.</span> finite <span class="bound">L'</span> 
      <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span><span class="bound">t''</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound">s</span> <span class="bound">p</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∉</span> <span class="bound">L'</span> <span class="main">∧</span> <span class="bound">p</span> <span class="main">∉</span> <span class="bound">L'</span> <span class="main">∧</span> <span class="bound">s</span> <span class="main">≠</span> <span class="bound">p</span> 
                  <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">u</span><span class="main">.</span> <span class="free">ta</span><span class="hidden">⇗</span><sup>[Fvar <span class="bound">s</span><span class="main">,</span> Fvar <span class="bound">p</span>]</sup><span class="hidden">⇖</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> <span class="bound">u</span> <span class="main">∧</span> <span class="bound">t''</span> <span class="main">=</span> <span class="keyword1">σ[</span><span class="bound">s</span><span class="main">,</span><span class="bound">p</span><span class="main">]</span><span class="bound">u</span><span class="main">)</span><span class="main">)</span>
             <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">s</span> <span class="bound">p</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∉</span> <span class="bound">L'</span> <span class="main">∧</span> <span class="bound">p</span> <span class="main">∉</span> <span class="bound">L'</span> <span class="main">∧</span> <span class="bound">s</span> <span class="main">≠</span> <span class="bound">p</span> 
                  <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">u</span><span class="main">.</span> <span class="free">tb</span><span class="hidden">⇗</span><sup>[Fvar <span class="bound">s</span><span class="main">,</span> Fvar <span class="bound">p</span>]</sup><span class="hidden">⇖</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> <span class="bound">u</span> <span class="main">∧</span> <span class="bound">t''</span> <span class="main">=</span> <span class="keyword1">σ[</span><span class="bound">s</span><span class="main">,</span><span class="bound">p</span><span class="main">]</span><span class="bound">u</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹finite <span class="free">L1</span>›</span></span> <span class="quoted"><span class="quoted">‹finite <span class="free">L2</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="free">L1</span> <span class="main">∪</span> <span class="free">L2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> exFresh_s_p_cof<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="keyword2"><span class="keyword">where</span></span> sp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∉</span> <span class="free">L1</span> <span class="main">∪</span> <span class="free">L2</span> <span class="main">∧</span> <span class="skolem">p</span> <span class="main">∉</span> <span class="free">L1</span> <span class="main">∪</span> <span class="free">L2</span> <span class="main">∧</span> <span class="skolem">s</span> <span class="main">≠</span> <span class="skolem">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> pred_L1
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t'</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
    <span class="quoted"><span class="quoted">"<span class="free">t</span><span class="hidden">⇗</span><sup>[Fvar <span class="skolem">s</span><span class="main">,</span>Fvar <span class="skolem">p</span>]</sup><span class="hidden">⇖</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> <span class="skolem">t'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 
    <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">z</span><span class="main">.</span> <span class="free">t</span><span class="hidden">⇗</span><sup>[Fvar <span class="skolem">s</span><span class="main">,</span>Fvar <span class="skolem">p</span>]</sup><span class="hidden">⇖</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> <span class="bound">z</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">u</span><span class="main">.</span> <span class="skolem">t'</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> <span class="bound">u</span> <span class="main">∧</span> <span class="bound">z</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> <span class="bound">u</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">ta</span> <span class="main">=</span> <span class="keyword1">σ[</span><span class="skolem">s</span><span class="main">,</span><span class="skolem">p</span><span class="main">]</span> <span class="skolem">t'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword1"><span class="command">from</span></span> sp pred_L2 <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t''</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span><span class="hidden">⇗</span><sup>[Fvar <span class="skolem">s</span><span class="main">,</span>Fvar <span class="skolem">p</span>]</sup><span class="hidden">⇖</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> <span class="skolem">t''</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">tb</span> <span class="main">=</span> <span class="keyword1">σ[</span><span class="skolem">s</span><span class="main">,</span><span class="skolem">p</span><span class="main">]</span> <span class="skolem">t''</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span><span class="bound">z</span><span class="main">.</span> <span class="free">t</span><span class="hidden">⇗</span><sup>[Fvar <span class="skolem">s</span><span class="main">,</span>Fvar <span class="skolem">p</span>]</sup><span class="hidden">⇖</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> <span class="bound">z</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">u</span><span class="main">.</span> <span class="skolem">t'</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> <span class="bound">u</span> <span class="main">∧</span> <span class="bound">z</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> <span class="bound">u</span><span class="main">)</span>›</span></span> this<span class="main">(</span>1<span class="main">)</span> 
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">u</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t'</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> <span class="skolem">u</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t''</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> <span class="skolem">u</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹finite <span class="free">L1</span>›</span></span> <span class="quoted"><span class="quoted">‹finite <span class="free">L2</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="free">L1</span> <span class="main">∪</span> <span class="free">L2</span> <span class="main">∪</span> FV <span class="free">t</span> <span class="main">∪</span> <span class="main">{</span><span class="skolem">s</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="skolem">p</span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="main">::</span> <span class="quoted">sterm</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">y</span> <span class="main">::</span> <span class="quoted">sterm</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span><span class="hidden">⇗</span><sup>[Fvar <span class="skolem">s</span><span class="main">,</span> Fvar <span class="skolem">p</span>]</sup><span class="hidden">⇖</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> <span class="skolem">y</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="keyword1">σ[</span><span class="skolem">s</span><span class="main">,</span><span class="skolem">p</span><span class="main">]</span> <span class="skolem">y</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> <span class="skolem">u</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> 
      <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">sa</span> <span class="bound">pa</span><span class="main">.</span> <span class="bound">sa</span> <span class="main">∉</span> <span class="free">L1</span> <span class="main">∪</span> <span class="free">L2</span> <span class="main">∪</span> FV <span class="free">t</span> <span class="main">∪</span> <span class="main">{</span><span class="skolem">s</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="skolem">p</span><span class="main">}</span> 
             <span class="main">∧</span> <span class="bound">pa</span> <span class="main">∉</span> <span class="free">L1</span> <span class="main">∪</span> <span class="free">L2</span> <span class="main">∪</span> FV <span class="free">t</span> <span class="main">∪</span> <span class="main">{</span><span class="skolem">s</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="skolem">p</span><span class="main">}</span> <span class="main">∧</span> <span class="bound">sa</span> <span class="main">≠</span> <span class="bound">pa</span> 
        <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">t</span><span class="main">.</span> <span class="skolem">x</span><span class="hidden">⇗</span><sup>[Fvar <span class="bound">sa</span><span class="main">,</span>Fvar <span class="bound">pa</span>]</sup><span class="hidden">⇖</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> <span class="bound">t</span> <span class="main">∧</span>  <span class="keyword1">σ[</span><span class="skolem">s</span><span class="main">,</span><span class="skolem">p</span><span class="main">]</span> <span class="skolem">u</span> <span class="main">=</span> <span class="keyword1">σ[</span><span class="bound">sa</span><span class="main">,</span><span class="bound">pa</span><span class="main">]</span> <span class="bound">t</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> strip<span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">sa</span> <span class="main">::</span> <span class="quoted">fVariable</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">pa</span> <span class="main">::</span> <span class="quoted">fVariable</span>
      <span class="keyword3"><span class="command">assume</span></span> 
        sapa<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">sa</span> <span class="main">∉</span> <span class="free">L1</span> <span class="main">∪</span> <span class="free">L2</span> <span class="main">∪</span> FV <span class="free">t</span> <span class="main">∪</span> <span class="main">{</span><span class="skolem">s</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="skolem">p</span><span class="main">}</span> 
               <span class="main">∧</span> <span class="skolem">pa</span> <span class="main">∉</span> <span class="free">L1</span> <span class="main">∪</span> <span class="free">L2</span> <span class="main">∪</span> FV <span class="free">t</span> <span class="main">∪</span> <span class="main">{</span><span class="skolem">s</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="skolem">p</span><span class="main">}</span> <span class="main">∧</span> <span class="skolem">sa</span> <span class="main">≠</span> <span class="skolem">pa</span>"</span></span>
      <span class="keyword1"><span class="command">with</span></span> sp par_beta_lc<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">y</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> <span class="skolem">u</span>›</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">≠</span> <span class="skolem">p</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∉</span> FV <span class="main">(</span>Fvar <span class="skolem">pa</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"lc <span class="skolem">y</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"lc <span class="skolem">u</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">from</span></span> 
        sopen_sclose_eq_ssubst<span class="main">[</span><span class="operator">OF</span> this<span class="main"><span class="main">(</span></span>1-3<span class="main"><span class="main">)</span></span><span class="main">]</span> 
        sopen_sclose_eq_ssubst<span class="main">[</span><span class="operator">OF</span> this<span class="main"><span class="main">(</span></span>1-2<span class="main"><span class="main">)</span></span> this<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">]</span>
        renaming_par_beta <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">=</span> <span class="keyword1">σ[</span><span class="skolem">s</span><span class="main">,</span><span class="skolem">p</span><span class="main">]</span> <span class="skolem">y</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">y</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> <span class="skolem">u</span>›</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span><span class="hidden">⇗</span><sup>[Fvar <span class="skolem">sa</span><span class="main">,</span> Fvar <span class="skolem">pa</span>]</sup><span class="hidden">⇖</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> <span class="main">(</span><span class="keyword1">σ[</span><span class="skolem">s</span><span class="main">,</span><span class="skolem">p</span><span class="main">]</span> <span class="skolem">u</span><span class="hidden">⇗</span><sup>[Fvar <span class="skolem">sa</span><span class="main">,</span> Fvar <span class="skolem">pa</span>]</sup><span class="hidden">⇖</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> openz_def closez_def<span class="main">)</span>
      
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">from</span></span> 
        sapa par_beta_preserves_FV<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">t</span> <span class="hidden">⇗</span><sup>[Fvar <span class="skolem">s</span><span class="main">,</span>Fvar <span class="skolem">p</span>]</sup><span class="hidden">⇖</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> <span class="skolem">y</span>›</span></span><span class="main">]</span>
        sopen_FV<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="main">0</span></span> <span class="quoted"><span class="quoted">"Fvar <span class="skolem">s</span>"</span></span> <span class="quoted"><span class="quoted">"Fvar <span class="skolem">p</span>"</span></span> <span class="quoted"><span class="free">t</span></span><span class="main">]</span>
        par_beta_preserves_FV<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">y</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> <span class="skolem">u</span>›</span></span><span class="main">]</span>
        sclose_subset_FV<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="main">0</span></span> <span class="quoted"><span class="skolem">s</span></span> <span class="quoted"><span class="skolem">p</span></span> <span class="quoted"><span class="skolem">u</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">sa</span> <span class="main">∉</span> FV <span class="main">(</span><span class="keyword1">σ[</span><span class="skolem">s</span><span class="main">,</span><span class="skolem">p</span><span class="main">]</span> <span class="skolem">u</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">pa</span> <span class="main">∉</span> FV <span class="main">(</span><span class="keyword1">σ[</span><span class="skolem">s</span><span class="main">,</span><span class="skolem">p</span><span class="main">]</span> <span class="skolem">u</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">sa</span> <span class="main">≠</span> <span class="skolem">pa</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> openz_def closez_def<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> sym<span class="main">[</span><span class="operator">OF</span> sclose_sopen_eq_t<span class="main"><span class="main">[</span></span><span class="operator">OF</span> this<span class="main"><span class="main">]</span></span><span class="main">]</span> 
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">σ[</span><span class="skolem">s</span><span class="main">,</span><span class="skolem">p</span><span class="main">]</span> <span class="skolem">u</span> <span class="main">=</span> <span class="keyword1">σ[</span><span class="skolem">sa</span><span class="main">,</span><span class="skolem">pa</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">σ[</span><span class="skolem">s</span><span class="main">,</span><span class="skolem">p</span><span class="main">]</span> <span class="skolem">u</span><span class="hidden">⇗</span><sup>[Fvar <span class="skolem">sa</span><span class="main">,</span> Fvar <span class="skolem">pa</span>]</sup><span class="hidden">⇖</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> openz_def closez_def<span class="main">)</span>

      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">t</span><span class="main">.</span> <span class="skolem">x</span><span class="hidden">⇗</span><sup>[Fvar <span class="skolem">sa</span><span class="main">,</span>Fvar <span class="skolem">pa</span>]</sup><span class="hidden">⇖</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> <span class="bound">t</span> <span class="main">∧</span> <span class="keyword1">σ[</span><span class="skolem">s</span><span class="main">,</span><span class="skolem">p</span><span class="main">]</span> <span class="skolem">u</span> <span class="main">=</span> <span class="keyword1">σ[</span><span class="skolem">sa</span><span class="main">,</span><span class="skolem">pa</span><span class="main">]</span> <span class="bound">t</span>"</span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">}</span></span><span class="keyword1"><span class="command">note</span></span> 
      this<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">t</span> <span class="hidden">⇗</span><sup>[Fvar <span class="skolem">s</span><span class="main">,</span>Fvar <span class="skolem">p</span>]</sup><span class="hidden">⇖</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> <span class="skolem">t'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">ta</span> <span class="main">=</span> <span class="keyword1">σ[</span><span class="skolem">s</span><span class="main">,</span><span class="skolem">p</span><span class="main">]</span> <span class="skolem">t'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">t'</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> <span class="skolem">u</span>›</span></span><span class="main">]</span>
      this<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">t</span> <span class="hidden">⇗</span><sup>[Fvar <span class="skolem">s</span><span class="main">,</span>Fvar <span class="skolem">p</span>]</sup><span class="hidden">⇖</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> <span class="skolem">t''</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">tb</span> <span class="main">=</span> <span class="keyword1">σ[</span><span class="skolem">s</span><span class="main">,</span><span class="skolem">p</span><span class="main">]</span> <span class="skolem">t''</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">t''</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> <span class="skolem">u</span>›</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword3"><span class="command">show</span></span> 
    <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">L'</span><span class="main">.</span> finite <span class="bound">L'</span> 
        <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span><span class="bound">t''</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound">s</span> <span class="bound">p</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∉</span> <span class="bound">L'</span> <span class="main">∧</span> <span class="bound">p</span> <span class="main">∉</span> <span class="bound">L'</span> <span class="main">∧</span> <span class="bound">s</span> <span class="main">≠</span> <span class="bound">p</span> 
                   <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">t'</span><span class="main">.</span> <span class="free">ta</span><span class="hidden">⇗</span><sup>[Fvar <span class="bound">s</span><span class="main">,</span>Fvar <span class="bound">p</span>]</sup><span class="hidden">⇖</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> <span class="bound">t'</span> <span class="main">∧</span> <span class="bound">t''</span> <span class="main">=</span> <span class="keyword1">σ[</span><span class="bound">s</span><span class="main">,</span><span class="bound">p</span><span class="main">]</span> <span class="bound">t'</span><span class="main">)</span><span class="main">)</span>
               <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">s</span> <span class="bound">p</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∉</span> <span class="bound">L'</span> <span class="main">∧</span> <span class="bound">p</span> <span class="main">∉</span> <span class="bound">L'</span> <span class="main">∧</span> <span class="bound">s</span> <span class="main">≠</span> <span class="bound">p</span> 
                   <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">t'</span><span class="main">.</span> <span class="free">tb</span><span class="hidden">⇗</span><sup>[Fvar <span class="bound">s</span><span class="main">,</span>Fvar <span class="bound">p</span>]</sup><span class="hidden">⇖</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> <span class="bound">t'</span> <span class="main">∧</span> <span class="bound">t''</span> <span class="main">=</span> <span class="keyword1">σ[</span><span class="bound">s</span><span class="main">,</span><span class="bound">p</span><span class="main">]</span> <span class="bound">t'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="free">L1</span> <span class="main">∪</span> <span class="free">L2</span> <span class="main">∪</span> FV <span class="free">t</span> <span class="main">∪</span> <span class="main">{</span><span class="skolem">s</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="skolem">p</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="ParRed-exL_exMap_lem"><span class="command">lemma</span></span> exL_exMap_lem<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> 
  <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"Label <span class="main">-~&gt;</span> sterm"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 
  <span class="free">lz</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"Label <span class="main">-~&gt;</span> sterm"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">f'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"Label <span class="main">-~&gt;</span> sterm"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"dom <span class="free">f</span> <span class="main">=</span> dom <span class="free">lz</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"dom <span class="free">f'</span> <span class="main">=</span> dom <span class="free">f</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> 
  <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">L1</span> <span class="bound">L2</span><span class="main">.</span> finite <span class="bound">L1</span> 
    <span class="main">⟶</span> <span class="main">(</span><span class="main">∀</span><span class="bound">l</span><span class="main">∈</span>dom <span class="free">f</span><span class="main">.</span> <span class="main">∀</span><span class="bound">s</span> <span class="bound">p</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∉</span> <span class="bound">L1</span> <span class="main">∧</span> <span class="bound">p</span> <span class="main">∉</span> <span class="bound">L1</span> <span class="main">∧</span> <span class="bound">s</span> <span class="main">≠</span> <span class="bound">p</span> 
                     <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">t</span><span class="main">.</span> <span class="main">(</span>the<span class="main">(</span><span class="free">f</span> <span class="bound">l</span><span class="main">)</span><span class="hidden">⇗</span><sup>[Fvar <span class="bound">s</span><span class="main">,</span> Fvar <span class="bound">p</span>]</sup><span class="hidden">⇖</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> <span class="bound">t</span> 
                            <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">z</span><span class="main">.</span> <span class="main">(</span>the<span class="main">(</span><span class="free">f</span> <span class="bound">l</span><span class="main">)</span><span class="hidden">⇗</span><sup>[Fvar <span class="bound">s</span><span class="main">,</span> Fvar  <span class="bound">p</span>]</sup><span class="hidden">⇖</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> <span class="bound">z</span><span class="main">)</span> 
                                <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">u</span><span class="main">.</span> <span class="bound">t</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> <span class="bound">u</span> <span class="main">∧</span> <span class="bound">z</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> <span class="bound">u</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
                            <span class="main">∧</span> the<span class="main">(</span><span class="free">f'</span> <span class="bound">l</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">σ[</span><span class="bound">s</span><span class="main">,</span><span class="bound">p</span><span class="main">]</span><span class="bound">t</span><span class="main">)</span><span class="main">)</span>
    <span class="main">⟶</span> finite <span class="bound">L2</span>
    <span class="main">⟶</span> <span class="main">(</span><span class="main">∀</span><span class="bound">l</span><span class="main">∈</span>dom <span class="free">f</span><span class="main">.</span> <span class="main">∀</span><span class="bound">s</span> <span class="bound">p</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∉</span> <span class="bound">L2</span> <span class="main">∧</span> <span class="bound">p</span> <span class="main">∉</span> <span class="bound">L2</span> <span class="main">∧</span> <span class="bound">s</span> <span class="main">≠</span> <span class="bound">p</span> 
          <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">t</span><span class="main">.</span> the<span class="main">(</span><span class="free">f</span> <span class="bound">l</span><span class="main">)</span><span class="hidden">⇗</span><sup>[Fvar <span class="bound">s</span><span class="main">,</span> Fvar <span class="bound">p</span>]</sup><span class="hidden">⇖</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> <span class="bound">t</span> <span class="main">∧</span> the<span class="main">(</span><span class="free">lz</span> <span class="bound">l</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">σ[</span><span class="bound">s</span><span class="main">,</span><span class="bound">p</span><span class="main">]</span><span class="bound">t</span><span class="main">)</span><span class="main">)</span>
    <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">L'</span><span class="main">.</span> finite <span class="bound">L'</span> 
            <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span><span class="bound">lu</span><span class="main">.</span> dom <span class="bound">lu</span> <span class="main">=</span> dom <span class="free">f</span> 
            <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">l</span><span class="main">∈</span>dom <span class="free">f</span><span class="main">.</span> <span class="main">∀</span><span class="bound">s</span> <span class="bound">p</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∉</span> <span class="bound">L'</span> <span class="main">∧</span> <span class="bound">p</span> <span class="main">∉</span> <span class="bound">L'</span> <span class="main">∧</span> <span class="bound">s</span> <span class="main">≠</span> <span class="bound">p</span> 
                           <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">t</span><span class="main">.</span> <span class="main">(</span>the<span class="main">(</span><span class="free">f'</span> <span class="bound">l</span><span class="main">)</span><span class="hidden">⇗</span><sup>[Fvar <span class="bound">s</span><span class="main">,</span> Fvar <span class="bound">p</span>]</sup><span class="hidden">⇖</span><span class="main">)</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> <span class="bound">t</span> 
                                  <span class="main">∧</span> the<span class="main">(</span><span class="bound">lu</span> <span class="bound">l</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">σ[</span><span class="bound">s</span><span class="main">,</span><span class="bound">p</span><span class="main">]</span><span class="bound">t</span><span class="main">)</span><span class="main">)</span>
            <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">l</span><span class="main">∈</span>dom <span class="free">f</span><span class="main">.</span> body <span class="main">(</span>the <span class="main">(</span><span class="free">f'</span> <span class="bound">l</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
            <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">l</span><span class="main">∈</span>dom <span class="free">f</span><span class="main">.</span> <span class="main">∀</span><span class="bound">s</span> <span class="bound">p</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∉</span> <span class="bound">L'</span> <span class="main">∧</span> <span class="bound">p</span> <span class="main">∉</span> <span class="bound">L'</span> <span class="main">∧</span> <span class="bound">s</span> <span class="main">≠</span> <span class="bound">p</span> 
                           <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">t</span><span class="main">.</span> <span class="main">(</span>the<span class="main">(</span><span class="free">lz</span> <span class="bound">l</span><span class="main">)</span><span class="hidden">⇗</span><sup>[Fvar <span class="bound">s</span><span class="main">,</span> Fvar <span class="bound">p</span>]</sup><span class="hidden">⇖</span><span class="main">)</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> <span class="bound">t</span> 
                                  <span class="main">∧</span> the<span class="main">(</span><span class="bound">lu</span> <span class="bound">l</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">σ[</span><span class="bound">s</span><span class="main">,</span><span class="bound">p</span><span class="main">]</span><span class="bound">t</span><span class="main">)</span><span class="main">)</span>
            <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">l</span><span class="main">∈</span>dom <span class="free">f</span><span class="main">.</span> body <span class="main">(</span>the <span class="main">(</span><span class="free">lz</span> <span class="bound">l</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> fmap_induct3<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> empty <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
<span class="keyword1"><span class="command">next</span></span> 
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>insert <span class="skolem">x</span> <span class="skolem">a</span> <span class="skolem">b</span> <span class="skolem">c</span> <span class="skolem">F1</span> <span class="skolem">F2</span> <span class="skolem">F3</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> strip<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">L1</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"fVariable set"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">L2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"fVariable set"</span></span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">fix</span></span> 
        <span class="skolem">L</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"fVariable set"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
        <span class="skolem">t</span> <span class="main">::</span> <span class="quoted">sterm</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">F</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"Label <span class="main">-~&gt;</span> sterm"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
        <span class="skolem">P</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"sterm <span class="main">⇒</span> sterm <span class="main">⇒</span> fVariable <span class="main">⇒</span> fVariable <span class="main">⇒</span> bool"</span></span>
      <span class="keyword3"><span class="command">assume</span></span> 
        <span class="quoted"><span class="quoted">"dom <span class="skolem">F1</span> <span class="main">=</span> dom <span class="skolem">F</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
        *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">l</span><span class="main">∈</span>dom <span class="main">(</span><span class="skolem">F1</span><span class="main">(</span><span class="skolem">x</span> <span class="main">↦</span> <span class="skolem">a</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> 
           <span class="main">∀</span><span class="bound">s</span> <span class="bound">p</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∉</span> <span class="skolem">L</span> <span class="main">∧</span> <span class="bound">p</span> <span class="main">∉</span> <span class="skolem">L</span> <span class="main">∧</span> <span class="bound">s</span> <span class="main">≠</span> <span class="bound">p</span>
            <span class="main">⟶</span> <span class="skolem">P</span> <span class="main">(</span>the <span class="main">(</span><span class="main">(</span><span class="skolem">F1</span><span class="main">(</span><span class="skolem">x</span> <span class="main">↦</span> <span class="skolem">a</span><span class="main">)</span><span class="main">)</span> <span class="bound">l</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>the <span class="main">(</span><span class="main">(</span><span class="skolem">F</span><span class="main">(</span><span class="skolem">x</span> <span class="main">↦</span> <span class="skolem">t</span><span class="main">)</span><span class="main">)</span> <span class="bound">l</span><span class="main">)</span><span class="main">)</span> <span class="bound">s</span> <span class="bound">p</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> 
        F<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">l</span><span class="main">∈</span>dom <span class="skolem">F1</span><span class="main">.</span> <span class="main">∀</span><span class="bound">s</span> <span class="bound">p</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∉</span> <span class="skolem">L</span> <span class="main">∧</span> <span class="bound">p</span> <span class="main">∉</span> <span class="skolem">L</span> <span class="main">∧</span> <span class="bound">s</span> <span class="main">≠</span> <span class="bound">p</span>
             <span class="main">⟶</span> <span class="skolem">P</span> <span class="main">(</span>the<span class="main">(</span><span class="skolem">F1</span> <span class="bound">l</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>the<span class="main">(</span><span class="skolem">F</span> <span class="bound">l</span><span class="main">)</span><span class="main">)</span> <span class="bound">s</span> <span class="bound">p</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> strip<span class="main">)</span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">l</span> <span class="main">::</span> <span class="quoted">Label</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">s</span> <span class="main">::</span> <span class="quoted">fVariable</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">p</span> <span class="main">::</span> <span class="quoted">fVariable</span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">∈</span> dom <span class="skolem">F1</span>"</span></span> <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">∈</span> dom <span class="main">(</span><span class="skolem">F1</span><span class="main">(</span><span class="skolem">x</span> <span class="main">↦</span> <span class="skolem">a</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∉</span> <span class="skolem">L</span> <span class="main">∧</span> <span class="skolem">p</span> <span class="main">∉</span> <span class="skolem">L</span> <span class="main">∧</span> <span class="skolem">s</span> <span class="main">≠</span> <span class="skolem">p</span>"</span></span>
        <span class="keyword1"><span class="command">ultimately</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main">(</span>the<span class="main">(</span><span class="main">(</span><span class="skolem">F1</span><span class="main">(</span><span class="skolem">x</span> <span class="main">↦</span> <span class="skolem">a</span><span class="main">)</span><span class="main">)</span> <span class="skolem">l</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>the<span class="main">(</span><span class="main">(</span><span class="skolem">F</span><span class="main">(</span><span class="skolem">x</span> <span class="main">↦</span> <span class="skolem">t</span><span class="main">)</span><span class="main">)</span> <span class="skolem">l</span><span class="main">)</span><span class="main">)</span> <span class="skolem">s</span> <span class="skolem">p</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> * <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∉</span> dom <span class="skolem">F1</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">l</span> <span class="main">∈</span> dom <span class="skolem">F1</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">≠</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main">(</span>the<span class="main">(</span><span class="skolem">F1</span> <span class="skolem">l</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>the<span class="main">(</span><span class="skolem">F</span> <span class="skolem">l</span><span class="main">)</span><span class="main">)</span> <span class="skolem">s</span> <span class="skolem">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
      <span class="keyword1"><span class="command">qed</span></span>

      <span class="keyword1"><span class="command">from</span></span> * <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">s</span> <span class="bound">p</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∉</span> <span class="skolem">L</span> <span class="main">∧</span> <span class="bound">p</span> <span class="main">∉</span> <span class="skolem">L</span> <span class="main">∧</span> <span class="bound">s</span> <span class="main">≠</span> <span class="bound">p</span> <span class="main">⟶</span> <span class="skolem">P</span> <span class="skolem">a</span> <span class="skolem">t</span> <span class="bound">s</span> <span class="bound">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">note</span></span> this F
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">note</span></span> pred <span class="main">=</span> this
    <span class="keyword1"><span class="command">note</span></span> 
      tmp <span class="main">=</span>
      pred<span class="main">[</span><span class="operator">of</span> <span class="main"><span class="main">_</span></span>  <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">L1</span></span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">(</span></span><span class="main"><span class="main">λ</span></span><span class="bound"><span class="bound">t</span></span> <span class="bound"><span class="bound">t'</span></span> <span class="bound"><span class="bound">s</span></span> <span class="bound"><span class="bound">p</span></span><span class="main"><span class="main">.</span></span> 
                        <span class="main"><span class="main">∃</span></span><span class="bound"><span class="bound">t''</span></span><span class="main"><span class="main">.</span></span> <span class="main"><span class="main">(</span></span><span class="bound"><span class="bound">t</span></span><span class="hidden">⇗</span><sup>[Fvar <span class="bound"><span class="bound">s</span></span><span class="main"><span class="main">,</span></span>Fvar <span class="bound"><span class="bound">p</span></span>]</sup><span class="hidden">⇖</span> <span class="keyword1"><span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span></span> <span class="bound"><span class="bound">t''</span></span>
                            <span class="main"><span class="main">∧</span></span> <span class="main"><span class="main">(</span></span><span class="main"><span class="main">∀</span></span><span class="bound"><span class="bound">z</span></span><span class="main"><span class="main">.</span></span> <span class="bound"><span class="bound">t</span></span><span class="hidden">⇗</span><sup>[Fvar <span class="bound"><span class="bound">s</span></span><span class="main"><span class="main">,</span></span>Fvar <span class="bound"><span class="bound">p</span></span>]</sup><span class="hidden">⇖</span> <span class="keyword1"><span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span></span> <span class="bound"><span class="bound">z</span></span> <span class="main"><span class="main">⟶</span></span> <span class="main"><span class="main">(</span></span><span class="main"><span class="main">∃</span></span><span class="bound"><span class="bound">u</span></span><span class="main"><span class="main">.</span></span> <span class="bound"><span class="bound">t''</span></span> <span class="keyword1"><span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span></span> <span class="bound"><span class="bound">u</span></span> <span class="main"><span class="main">∧</span></span> <span class="bound"><span class="bound">z</span></span> <span class="keyword1"><span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span></span> <span class="bound"><span class="bound">u</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">)</span></span>
                            <span class="main"><span class="main">∧</span></span> <span class="bound"><span class="bound">t'</span></span> <span class="main"><span class="main">=</span></span> <span class="keyword1"><span class="keyword1">σ[</span></span><span class="bound"><span class="bound">s</span></span><span class="main"><span class="main">,</span></span><span class="bound"><span class="bound">p</span></span><span class="main"><span class="main">]</span></span> <span class="bound"><span class="bound">t''</span></span><span class="main"><span class="main">)</span></span>"</span></span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">note</span></span> predc <span class="main">=</span> tmp<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">note</span></span> predF3 <span class="main">=</span> tmp<span class="main">(</span>2<span class="main">)</span>
    <span class="keyword1"><span class="command">note</span></span> tmp <span class="main">=</span> pred<span class="main">[</span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">L2</span></span></span></span> 
                       <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">(</span></span><span class="main"><span class="main">λ</span></span><span class="bound"><span class="bound">t</span></span> <span class="bound"><span class="bound">t'</span></span> <span class="bound"><span class="bound">s</span></span> <span class="bound"><span class="bound">p</span></span><span class="main"><span class="main">.</span></span> <span class="main"><span class="main">∃</span></span><span class="bound"><span class="bound">t''</span></span><span class="main"><span class="main">.</span></span> <span class="bound"><span class="bound">t</span></span><span class="hidden">⇗</span><sup>[Fvar <span class="bound"><span class="bound">s</span></span><span class="main"><span class="main">,</span></span>Fvar <span class="bound"><span class="bound">p</span></span>]</sup><span class="hidden">⇖</span> <span class="keyword1"><span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span></span> <span class="bound"><span class="bound">t''</span></span> <span class="main"><span class="main">∧</span></span> <span class="bound"><span class="bound">t'</span></span> <span class="main"><span class="main">=</span></span> <span class="keyword1"><span class="keyword1">σ[</span></span><span class="bound"><span class="bound">s</span></span><span class="main"><span class="main">,</span></span><span class="bound"><span class="bound">p</span></span><span class="main"><span class="main">]</span></span> <span class="bound"><span class="bound">t''</span></span><span class="main"><span class="main">)</span></span>"</span></span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">note</span></span> predb <span class="main">=</span> tmp<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">note</span></span> predF2 <span class="main">=</span> tmp<span class="main">(</span>2<span class="main">)</span>

    <span class="keyword3"><span class="command">assume</span></span> 
      a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">l</span><span class="main">∈</span>dom <span class="main">(</span><span class="skolem">F1</span><span class="main">(</span><span class="skolem">x</span> <span class="main">↦</span> <span class="skolem">a</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> <span class="main">∀</span><span class="bound">s</span> <span class="bound">p</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∉</span> <span class="skolem">L1</span> <span class="main">∧</span> <span class="bound">p</span> <span class="main">∉</span> <span class="skolem">L1</span> <span class="main">∧</span> <span class="bound">s</span> <span class="main">≠</span> <span class="bound">p</span> 
        <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">t</span><span class="main">.</span> <span class="main">(</span>the <span class="main">(</span><span class="main">(</span><span class="skolem">F1</span><span class="main">(</span><span class="skolem">x</span> <span class="main">↦</span> <span class="skolem">a</span><span class="main">)</span><span class="main">)</span> <span class="bound">l</span><span class="main">)</span><span class="hidden">⇗</span><sup>[Fvar <span class="bound">s</span><span class="main">,</span>Fvar <span class="bound">p</span>]</sup><span class="hidden">⇖</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> <span class="bound">t</span> 
               <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">z</span><span class="main">.</span> the <span class="main">(</span><span class="main">(</span><span class="skolem">F1</span><span class="main">(</span><span class="skolem">x</span> <span class="main">↦</span> <span class="skolem">a</span><span class="main">)</span><span class="main">)</span> <span class="bound">l</span><span class="main">)</span><span class="hidden">⇗</span><sup>[Fvar <span class="bound">s</span><span class="main">,</span>Fvar <span class="bound">p</span>]</sup><span class="hidden">⇖</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> <span class="bound">z</span> 
                   <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">u</span><span class="main">.</span> <span class="bound">t</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> <span class="bound">u</span> <span class="main">∧</span> <span class="bound">z</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> <span class="bound">u</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> 
               <span class="main">∧</span> the <span class="main">(</span><span class="main">(</span><span class="skolem">F3</span><span class="main">(</span><span class="skolem">x</span> <span class="main">↦</span> <span class="skolem">c</span><span class="main">)</span><span class="main">)</span> <span class="bound">l</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">σ[</span><span class="bound">s</span><span class="main">,</span><span class="bound">p</span><span class="main">]</span> <span class="bound">t</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      b<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">l</span><span class="main">∈</span>dom <span class="main">(</span><span class="skolem">F1</span><span class="main">(</span><span class="skolem">x</span> <span class="main">↦</span> <span class="skolem">a</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> <span class="main">∀</span><span class="bound">s</span> <span class="bound">p</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∉</span> <span class="skolem">L2</span> <span class="main">∧</span> <span class="bound">p</span> <span class="main">∉</span> <span class="skolem">L2</span> <span class="main">∧</span> <span class="bound">s</span> <span class="main">≠</span> <span class="bound">p</span> 
        <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">t</span><span class="main">.</span> the <span class="main">(</span><span class="main">(</span><span class="skolem">F1</span><span class="main">(</span><span class="skolem">x</span> <span class="main">↦</span> <span class="skolem">a</span><span class="main">)</span><span class="main">)</span> <span class="bound">l</span><span class="main">)</span><span class="hidden">⇗</span><sup>[Fvar <span class="bound">s</span><span class="main">,</span>Fvar <span class="bound">p</span>]</sup><span class="hidden">⇖</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> <span class="bound">t</span> 
               <span class="main">∧</span> the <span class="main">(</span><span class="main">(</span><span class="skolem">F2</span><span class="main">(</span><span class="skolem">x</span> <span class="main">↦</span> <span class="skolem">b</span><span class="main">)</span><span class="main">)</span> <span class="bound">l</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">σ[</span><span class="bound">s</span><span class="main">,</span><span class="bound">p</span><span class="main">]</span> <span class="bound">t</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      <span class="quoted"><span class="quoted">"finite <span class="skolem">L1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"finite <span class="skolem">L2</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> 
      diamond_binder<span class="main">[</span><span class="operator">OF</span> this<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> predc<span class="main"><span class="main">[</span></span><span class="operator">OF</span> sym<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹dom <span class="skolem">F3</span> <span class="main">=</span> dom <span class="skolem">F1</span>›</span></span><span class="main"><span class="main">]</span></span> this<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span>
                        this<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> predb<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹dom <span class="skolem">F1</span> <span class="main">=</span> dom <span class="skolem">F2</span>›</span></span> this<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">La</span></span> <span class="skolem"><span class="skolem">t</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
      <span class="quoted"><span class="quoted">"finite <span class="skolem">La</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      pred_c<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">s</span> <span class="bound">p</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∉</span> <span class="skolem">La</span> <span class="main">∧</span> <span class="bound">p</span> <span class="main">∉</span> <span class="skolem">La</span> <span class="main">∧</span> <span class="bound">s</span> <span class="main">≠</span> <span class="bound">p</span> 
                <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">u</span><span class="main">.</span> <span class="skolem">c</span><span class="hidden">⇗</span><sup>[Fvar <span class="bound">s</span><span class="main">,</span>Fvar <span class="bound">p</span>]</sup><span class="hidden">⇖</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> <span class="bound">u</span> <span class="main">∧</span> <span class="skolem">t</span> <span class="main">=</span> <span class="keyword1">σ[</span><span class="bound">s</span><span class="main">,</span><span class="bound">p</span><span class="main">]</span> <span class="bound">u</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      pred_b<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">s</span> <span class="bound">p</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∉</span> <span class="skolem">La</span> <span class="main">∧</span> <span class="bound">p</span> <span class="main">∉</span> <span class="skolem">La</span> <span class="main">∧</span> <span class="bound">s</span> <span class="main">≠</span> <span class="bound">p</span> 
                <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">u</span><span class="main">.</span> <span class="skolem">b</span><span class="hidden">⇗</span><sup>[Fvar <span class="bound">s</span><span class="main">,</span>Fvar <span class="bound">p</span>]</sup><span class="hidden">⇖</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> <span class="bound">u</span> <span class="main">∧</span> <span class="skolem">t</span> <span class="main">=</span> <span class="keyword1">σ[</span><span class="bound">s</span><span class="main">,</span><span class="bound">p</span><span class="main">]</span> <span class="bound">u</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword1"><span class="command">from</span></span> this<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="skolem">La</span> <span class="main">∪</span> FV <span class="skolem">c</span> <span class="main">∪</span> FV <span class="skolem">b</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">from</span></span> exFresh_s_p_cof<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
        sp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∉</span> <span class="skolem">La</span> <span class="main">∪</span> FV <span class="skolem">c</span> <span class="main">∪</span> FV <span class="skolem">b</span> <span class="main">∧</span> <span class="skolem">p</span> <span class="main">∉</span> <span class="skolem">La</span> <span class="main">∪</span> FV <span class="skolem">c</span> <span class="main">∪</span> FV <span class="skolem">b</span> <span class="main">∧</span> <span class="skolem">s</span> <span class="main">≠</span> <span class="skolem">p</span>"</span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">with</span></span> pred_c <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">u</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span><span class="hidden">⇗</span><sup>[Fvar <span class="skolem">s</span><span class="main">,</span>Fvar <span class="skolem">p</span>]</sup><span class="hidden">⇖</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> <span class="skolem">u</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">from</span></span> par_beta_lc<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"lc <span class="main">(</span><span class="skolem">c</span><span class="hidden">⇗</span><sup>[Fvar <span class="skolem">s</span><span class="main">,</span>Fvar <span class="skolem">p</span>]</sup><span class="hidden">⇖</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">with</span></span> lc_body<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span><span class="hidden">⇗</span><sup>[Fvar <span class="skolem">s</span><span class="main">,</span>Fvar <span class="skolem">p</span>]</sup><span class="hidden">⇖</span>"</span></span> <span class="quoted"><span class="skolem">s</span></span> <span class="quoted"><span class="skolem">p</span></span><span class="main">]</span> sp sclose_sopen_eq_t<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">s</span></span> <span class="quoted"><span class="skolem">c</span></span> <span class="quoted"><span class="skolem">p</span></span> <span class="quoted"><span class="main">0</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">have</span></span> c<span class="main">:</span> <span class="quoted"><span class="quoted">"body <span class="skolem">c</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> closez_def openz_def<span class="main">)</span>
          
      <span class="keyword1"><span class="command">from</span></span> sp pred_b <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">u</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span><span class="hidden">⇗</span><sup>[Fvar <span class="skolem">s</span><span class="main">,</span>Fvar <span class="skolem">p</span>]</sup><span class="hidden">⇖</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> <span class="skolem">u</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>      
      <span class="keyword1"><span class="command">from</span></span> par_beta_lc<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"lc <span class="main">(</span><span class="skolem">b</span><span class="hidden">⇗</span><sup>[Fvar <span class="skolem">s</span><span class="main">,</span>Fvar <span class="skolem">p</span>]</sup><span class="hidden">⇖</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">with</span></span> lc_body<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span><span class="hidden">⇗</span><sup>[Fvar <span class="skolem">s</span><span class="main">,</span>Fvar <span class="skolem">p</span>]</sup><span class="hidden">⇖</span>"</span></span> <span class="quoted"><span class="skolem">s</span></span> <span class="quoted"><span class="skolem">p</span></span><span class="main">]</span> sp sclose_sopen_eq_t<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">s</span></span> <span class="quoted"><span class="skolem">b</span></span> <span class="quoted"><span class="skolem">p</span></span> <span class="quoted"><span class="main">0</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"body <span class="skolem">b</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> closez_def openz_def<span class="main">)</span>
      <span class="keyword1"><span class="command">note</span></span> c this
    <span class="keyword1"><span class="command">}</span></span><span class="keyword1"><span class="command">note</span></span> bodycb <span class="main">=</span> this
    <span class="keyword1"><span class="command">from</span></span> 
      predF3<span class="main">[</span><span class="operator">OF</span> sym<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹dom <span class="skolem">F3</span> <span class="main">=</span> dom <span class="skolem">F1</span>›</span></span><span class="main"><span class="main">]</span></span> a<span class="main">]</span>
      predF2<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹dom <span class="skolem">F1</span> <span class="main">=</span> dom <span class="skolem">F2</span>›</span></span> b<span class="main">]</span>
      <span class="quoted"><span class="quoted">‹finite <span class="skolem">L1</span>›</span></span> <span class="quoted"><span class="quoted">‹finite <span class="skolem">L2</span>›</span></span>
    <span class="keyword1"><span class="command">have</span></span> 
      <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">L'</span><span class="main">.</span> finite <span class="bound">L'</span> 
          <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span><span class="bound">lu</span><span class="main">.</span> dom <span class="bound">lu</span> <span class="main">=</span> dom <span class="skolem">F1</span> 
          <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">l</span><span class="main">∈</span>dom <span class="skolem">F1</span><span class="main">.</span> <span class="main">∀</span><span class="bound">s</span> <span class="bound">p</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∉</span> <span class="bound">L'</span> <span class="main">∧</span> <span class="bound">p</span> <span class="main">∉</span> <span class="bound">L'</span> <span class="main">∧</span> <span class="bound">s</span> <span class="main">≠</span> <span class="bound">p</span> 
                          <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">t</span><span class="main">.</span> the <span class="main">(</span><span class="skolem">F3</span> <span class="bound">l</span><span class="main">)</span><span class="hidden">⇗</span><sup>[Fvar <span class="bound">s</span><span class="main">,</span>Fvar <span class="bound">p</span>]</sup><span class="hidden">⇖</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> <span class="bound">t</span> 
                                 <span class="main">∧</span> the <span class="main">(</span><span class="bound">lu</span> <span class="bound">l</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">σ[</span><span class="bound">s</span><span class="main">,</span><span class="bound">p</span><span class="main">]</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> 
          <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">l</span><span class="main">∈</span>dom <span class="skolem">F1</span><span class="main">.</span> body <span class="main">(</span>the <span class="main">(</span><span class="skolem">F3</span> <span class="bound">l</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> 
          <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">l</span><span class="main">∈</span>dom <span class="skolem">F1</span><span class="main">.</span> <span class="main">∀</span><span class="bound">s</span> <span class="bound">p</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∉</span> <span class="bound">L'</span> <span class="main">∧</span> <span class="bound">p</span> <span class="main">∉</span> <span class="bound">L'</span> <span class="main">∧</span> <span class="bound">s</span> <span class="main">≠</span> <span class="bound">p</span> 
                          <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">t</span><span class="main">.</span> the <span class="main">(</span><span class="skolem">F2</span> <span class="bound">l</span><span class="main">)</span><span class="hidden">⇗</span><sup>[Fvar <span class="bound">s</span><span class="main">,</span>Fvar <span class="bound">p</span>]</sup><span class="hidden">⇖</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> <span class="bound">t</span> 
                                 <span class="main">∧</span> the <span class="main">(</span><span class="bound">lu</span> <span class="bound">l</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">σ[</span><span class="bound">s</span><span class="main">,</span><span class="bound">p</span><span class="main">]</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> 
          <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">l</span><span class="main">∈</span>dom <span class="skolem">F1</span><span class="main">.</span> body <span class="main">(</span>the <span class="main">(</span><span class="skolem">F2</span> <span class="bound">l</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="skolem">L1</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> allE<span class="main"><span class="main">[</span></span><span class="operator">OF</span> insert<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Lb</span></span> <span class="skolem"><span class="skolem">f</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
      <span class="quoted"><span class="quoted">"finite <span class="skolem">Lb</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"dom <span class="skolem">f</span> <span class="main">=</span> dom <span class="skolem">F1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      pred_F3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">l</span><span class="main">∈</span>dom <span class="skolem">F1</span><span class="main">.</span> <span class="main">∀</span><span class="bound">s</span> <span class="bound">p</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∉</span> <span class="skolem">La</span> <span class="main">∪</span> <span class="skolem">Lb</span> <span class="main">∧</span> <span class="bound">p</span> <span class="main">∉</span> <span class="skolem">La</span> <span class="main">∪</span> <span class="skolem">Lb</span> <span class="main">∧</span> <span class="bound">s</span> <span class="main">≠</span> <span class="bound">p</span> 
                             <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">t</span><span class="main">.</span> the <span class="main">(</span><span class="skolem">F3</span> <span class="bound">l</span><span class="main">)</span><span class="hidden">⇗</span><sup>[Fvar <span class="bound">s</span><span class="main">,</span>Fvar <span class="bound">p</span>]</sup><span class="hidden">⇖</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> <span class="bound">t</span> 
                                    <span class="main">∧</span> the <span class="main">(</span><span class="skolem">f</span> <span class="bound">l</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">σ[</span><span class="bound">s</span><span class="main">,</span><span class="bound">p</span><span class="main">]</span> <span class="bound">t</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      body_F3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">l</span><span class="main">∈</span>dom <span class="skolem">F1</span><span class="main">.</span> body <span class="main">(</span>the <span class="main">(</span><span class="skolem">F3</span> <span class="bound">l</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      pred_F2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">l</span><span class="main">∈</span>dom <span class="skolem">F1</span><span class="main">.</span> <span class="main">∀</span><span class="bound">s</span> <span class="bound">p</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∉</span> <span class="skolem">La</span> <span class="main">∪</span> <span class="skolem">Lb</span> <span class="main">∧</span> <span class="bound">p</span> <span class="main">∉</span> <span class="skolem">La</span> <span class="main">∪</span> <span class="skolem">Lb</span> <span class="main">∧</span> <span class="bound">s</span> <span class="main">≠</span> <span class="bound">p</span> 
                             <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">t</span><span class="main">.</span> the <span class="main">(</span><span class="skolem">F2</span> <span class="bound">l</span><span class="main">)</span><span class="hidden">⇗</span><sup>[Fvar <span class="bound">s</span><span class="main">,</span>Fvar <span class="bound">p</span>]</sup><span class="hidden">⇖</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> <span class="bound">t</span> 
                                    <span class="main">∧</span> the <span class="main">(</span><span class="skolem">f</span> <span class="bound">l</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">σ[</span><span class="bound">s</span><span class="main">,</span><span class="bound">p</span><span class="main">]</span> <span class="bound">t</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      body_F2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">l</span><span class="main">∈</span>dom <span class="skolem">F1</span><span class="main">.</span> body <span class="main">(</span>the <span class="main">(</span><span class="skolem">F2</span> <span class="bound">l</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹finite <span class="skolem">La</span>›</span></span> <span class="quoted"><span class="quoted">‹finite <span class="skolem">Lb</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="skolem">La</span> <span class="main">∪</span> <span class="skolem">Lb</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹dom <span class="skolem">f</span> <span class="main">=</span> dom <span class="skolem">F1</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"dom <span class="main">(</span><span class="skolem">f</span><span class="main">(</span><span class="skolem">x</span> <span class="main">↦</span> <span class="skolem">t</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> dom <span class="main">(</span><span class="skolem">F1</span><span class="main">(</span><span class="skolem">x</span> <span class="main">↦</span> <span class="skolem">a</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">from</span></span> pred_c pred_F3
    <span class="keyword1"><span class="command">have</span></span> 
      <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">l</span><span class="main">∈</span>dom <span class="main">(</span><span class="skolem">F1</span><span class="main">(</span><span class="skolem">x</span> <span class="main">↦</span> <span class="skolem">a</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> <span class="main">∀</span><span class="bound">s</span> <span class="bound">p</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∉</span> <span class="skolem">La</span> <span class="main">∪</span> <span class="skolem">Lb</span> <span class="main">∧</span> <span class="bound">p</span> <span class="main">∉</span> <span class="skolem">La</span> <span class="main">∪</span> <span class="skolem">Lb</span> <span class="main">∧</span> <span class="bound">s</span> <span class="main">≠</span> <span class="bound">p</span> 
                              <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">t'</span><span class="main">.</span> the <span class="main">(</span><span class="main">(</span><span class="skolem">F3</span><span class="main">(</span><span class="skolem">x</span> <span class="main">↦</span> <span class="skolem">c</span><span class="main">)</span><span class="main">)</span> <span class="bound">l</span><span class="main">)</span><span class="hidden">⇗</span><sup>[Fvar <span class="bound">s</span><span class="main">,</span>Fvar <span class="bound">p</span>]</sup><span class="hidden">⇖</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> <span class="bound">t'</span> 
                                      <span class="main">∧</span> the <span class="main">(</span><span class="main">(</span><span class="skolem">f</span><span class="main">(</span><span class="skolem">x</span> <span class="main">↦</span> <span class="skolem">t</span><span class="main">)</span><span class="main">)</span> <span class="bound">l</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">σ[</span><span class="bound">s</span><span class="main">,</span><span class="bound">p</span><span class="main">]</span> <span class="bound">t'</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">from</span></span> bodycb<span class="main">(</span>1<span class="main">)</span> body_F3 
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">l</span><span class="main">∈</span>dom <span class="main">(</span><span class="skolem">F1</span><span class="main">(</span><span class="skolem">x</span> <span class="main">↦</span> <span class="skolem">a</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> body <span class="main">(</span>the <span class="main">(</span><span class="main">(</span><span class="skolem">F3</span><span class="main">(</span><span class="skolem">x</span> <span class="main">↦</span> <span class="skolem">c</span><span class="main">)</span><span class="main">)</span> <span class="bound">l</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">from</span></span> pred_b pred_F2
    <span class="keyword1"><span class="command">have</span></span> 
      <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">l</span><span class="main">∈</span>dom <span class="main">(</span><span class="skolem">F1</span><span class="main">(</span><span class="skolem">x</span> <span class="main">↦</span> <span class="skolem">a</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> <span class="main">∀</span><span class="bound">s</span> <span class="bound">p</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∉</span> <span class="skolem">La</span> <span class="main">∪</span> <span class="skolem">Lb</span> <span class="main">∧</span> <span class="bound">p</span> <span class="main">∉</span> <span class="skolem">La</span> <span class="main">∪</span> <span class="skolem">Lb</span> <span class="main">∧</span> <span class="bound">s</span> <span class="main">≠</span> <span class="bound">p</span> 
                              <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">t'</span><span class="main">.</span> the <span class="main">(</span><span class="main">(</span><span class="skolem">F2</span><span class="main">(</span><span class="skolem">x</span> <span class="main">↦</span> <span class="skolem">b</span><span class="main">)</span><span class="main">)</span> <span class="bound">l</span><span class="main">)</span><span class="hidden">⇗</span><sup>[Fvar <span class="bound">s</span><span class="main">,</span>Fvar <span class="bound">p</span>]</sup><span class="hidden">⇖</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> <span class="bound">t'</span> 
                                      <span class="main">∧</span> the <span class="main">(</span><span class="main">(</span><span class="skolem">f</span><span class="main">(</span><span class="skolem">x</span> <span class="main">↦</span> <span class="skolem">t</span><span class="main">)</span><span class="main">)</span> <span class="bound">l</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">σ[</span><span class="bound">s</span><span class="main">,</span><span class="bound">p</span><span class="main">]</span> <span class="bound">t'</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">from</span></span> bodycb<span class="main">(</span>2<span class="main">)</span> body_F2 
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">l</span><span class="main">∈</span>dom <span class="main">(</span><span class="skolem">F1</span><span class="main">(</span><span class="skolem">x</span> <span class="main">↦</span> <span class="skolem">a</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> body <span class="main">(</span>the <span class="main">(</span><span class="main">(</span><span class="skolem">F2</span><span class="main">(</span><span class="skolem">x</span> <span class="main">↦</span> <span class="skolem">b</span><span class="main">)</span><span class="main">)</span> <span class="bound">l</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">ultimately</span></span>
    <span class="keyword3"><span class="command">show</span></span> 
      <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">L'</span><span class="main">.</span> finite <span class="bound">L'</span>
          <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span><span class="bound">lu</span><span class="main">.</span> dom <span class="bound">lu</span> <span class="main">=</span> dom <span class="main">(</span><span class="skolem">F1</span><span class="main">(</span><span class="skolem">x</span> <span class="main">↦</span> <span class="skolem">a</span><span class="main">)</span><span class="main">)</span> 
                <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">l</span><span class="main">∈</span>dom <span class="main">(</span><span class="skolem">F1</span><span class="main">(</span><span class="skolem">x</span> <span class="main">↦</span> <span class="skolem">a</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> 
                    <span class="main">∀</span><span class="bound">s</span> <span class="bound">p</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∉</span> <span class="bound">L'</span> <span class="main">∧</span> <span class="bound">p</span> <span class="main">∉</span> <span class="bound">L'</span> <span class="main">∧</span> <span class="bound">s</span> <span class="main">≠</span> <span class="bound">p</span> 
                     <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">t'</span><span class="main">.</span> the <span class="main">(</span><span class="main">(</span><span class="skolem">F3</span><span class="main">(</span><span class="skolem">x</span> <span class="main">↦</span> <span class="skolem">c</span><span class="main">)</span><span class="main">)</span> <span class="bound">l</span><span class="main">)</span><span class="hidden">⇗</span><sup>[Fvar <span class="bound">s</span><span class="main">,</span>Fvar <span class="bound">p</span>]</sup><span class="hidden">⇖</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> <span class="bound">t'</span>
                             <span class="main">∧</span> the <span class="main">(</span><span class="bound">lu</span> <span class="bound">l</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">σ[</span><span class="bound">s</span><span class="main">,</span><span class="bound">p</span><span class="main">]</span> <span class="bound">t'</span><span class="main">)</span><span class="main">)</span>
                <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">l</span><span class="main">∈</span>dom <span class="main">(</span><span class="skolem">F1</span><span class="main">(</span><span class="skolem">x</span> <span class="main">↦</span> <span class="skolem">a</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> body <span class="main">(</span>the <span class="main">(</span><span class="main">(</span><span class="skolem">F3</span><span class="main">(</span><span class="skolem">x</span> <span class="main">↦</span> <span class="skolem">c</span><span class="main">)</span><span class="main">)</span> <span class="bound">l</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> 
                <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">l</span><span class="main">∈</span>dom <span class="main">(</span><span class="skolem">F1</span><span class="main">(</span><span class="skolem">x</span> <span class="main">↦</span> <span class="skolem">a</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> 
                    <span class="main">∀</span><span class="bound">s</span> <span class="bound">p</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∉</span> <span class="bound">L'</span> <span class="main">∧</span> <span class="bound">p</span> <span class="main">∉</span> <span class="bound">L'</span> <span class="main">∧</span> <span class="bound">s</span> <span class="main">≠</span> <span class="bound">p</span> 
                     <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">t'</span><span class="main">.</span> the <span class="main">(</span><span class="main">(</span><span class="skolem">F2</span><span class="main">(</span><span class="skolem">x</span> <span class="main">↦</span> <span class="skolem">b</span><span class="main">)</span><span class="main">)</span> <span class="bound">l</span><span class="main">)</span><span class="hidden">⇗</span><sup>[Fvar <span class="bound">s</span><span class="main">,</span>Fvar <span class="bound">p</span>]</sup><span class="hidden">⇖</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> <span class="bound">t'</span>
                <span class="main">∧</span> the <span class="main">(</span><span class="bound">lu</span> <span class="bound">l</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">σ[</span><span class="bound">s</span><span class="main">,</span><span class="bound">p</span><span class="main">]</span> <span class="bound">t'</span><span class="main">)</span><span class="main">)</span>
                <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">l</span><span class="main">∈</span>dom <span class="main">(</span><span class="skolem">F1</span><span class="main">(</span><span class="skolem">x</span> <span class="main">↦</span> <span class="skolem">a</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> body <span class="main">(</span>the <span class="main">(</span><span class="main">(</span><span class="skolem">F2</span><span class="main">(</span><span class="skolem">x</span> <span class="main">↦</span> <span class="skolem">b</span><span class="main">)</span><span class="main">)</span> <span class="bound">l</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">La</span> <span class="main">∪</span> <span class="skolem">Lb</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main"><span class="keyword3">,</span></span> 
        <span class="operator">simp</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">no_asm_simp</span><span class="main"><span class="main">)</span></span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> conjI simp_thms<span class="main"><span class="main">(</span></span>22<span class="main"><span class="main">)</span></span><span class="main"><span class="keyword3">,</span></span>
        <span class="operator">rule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">f</span><span class="main">(</span><span class="skolem">x</span> <span class="main">↦</span> <span class="skolem">t</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="ParRed-exL_exMap"><span class="command">lemma</span></span> exL_exMap<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> dom <span class="main">(</span><span class="free">f</span><span class="main">::</span>Label <span class="main">-~&gt;</span> sterm<span class="main">)</span> <span class="main">=</span> dom <span class="main">(</span><span class="free">lz</span><span class="main">::</span>Label <span class="main">-~&gt;</span> sterm<span class="main">)</span><span class="main">;</span> 
     dom <span class="main">(</span><span class="free">f'</span><span class="main">::</span>Label <span class="main">-~&gt;</span> sterm<span class="main">)</span> <span class="main">=</span> dom <span class="free">f</span><span class="main">;</span> 
     finite <span class="free">L1</span><span class="main">;</span>
     <span class="main">∀</span><span class="bound">l</span><span class="main">∈</span>dom <span class="free">f</span><span class="main">.</span> <span class="main">∀</span><span class="bound">s</span> <span class="bound">p</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∉</span> <span class="free">L1</span> <span class="main">∧</span> <span class="bound">p</span> <span class="main">∉</span> <span class="free">L1</span> <span class="main">∧</span> <span class="bound">s</span> <span class="main">≠</span> <span class="bound">p</span> 
      <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">t</span><span class="main">.</span> <span class="main">(</span>the<span class="main">(</span><span class="free">f</span> <span class="bound">l</span><span class="main">)</span><span class="hidden">⇗</span><sup>[Fvar <span class="bound">s</span><span class="main">,</span> Fvar <span class="bound">p</span>]</sup><span class="hidden">⇖</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> <span class="bound">t</span> 
             <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">z</span><span class="main">.</span> <span class="main">(</span>the<span class="main">(</span><span class="free">f</span> <span class="bound">l</span><span class="main">)</span><span class="hidden">⇗</span><sup>[Fvar <span class="bound">s</span><span class="main">,</span> Fvar  <span class="bound">p</span>]</sup><span class="hidden">⇖</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> <span class="bound">z</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">u</span><span class="main">.</span> <span class="bound">t</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> <span class="bound">u</span> <span class="main">∧</span> <span class="bound">z</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> <span class="bound">u</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
             <span class="main">∧</span> the<span class="main">(</span><span class="free">f'</span> <span class="bound">l</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">σ[</span><span class="bound">s</span><span class="main">,</span><span class="bound">p</span><span class="main">]</span><span class="bound">t</span><span class="main">)</span><span class="main">;</span>
     finite <span class="free">L2</span><span class="main">;</span>
     <span class="main">∀</span><span class="bound">l</span><span class="main">∈</span>dom <span class="free">lz</span><span class="main">.</span> <span class="main">∀</span><span class="bound">s</span> <span class="bound">p</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∉</span> <span class="free">L2</span> <span class="main">∧</span> <span class="bound">p</span> <span class="main">∉</span> <span class="free">L2</span> <span class="main">∧</span> <span class="bound">s</span> <span class="main">≠</span> <span class="bound">p</span> 
      <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">t</span><span class="main">.</span> the<span class="main">(</span><span class="free">f</span> <span class="bound">l</span><span class="main">)</span><span class="hidden">⇗</span><sup>[Fvar <span class="bound">s</span><span class="main">,</span> Fvar <span class="bound">p</span>]</sup><span class="hidden">⇖</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> <span class="bound">t</span> <span class="main">∧</span> the<span class="main">(</span><span class="free">lz</span> <span class="bound">l</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">σ[</span><span class="bound">s</span><span class="main">,</span><span class="bound">p</span><span class="main">]</span><span class="bound">t</span><span class="main">)</span> <span class="main">⟧</span>
  <span class="main">⟹</span> <span class="main">∃</span><span class="bound">L'</span><span class="main">.</span> finite <span class="bound">L'</span> 
         <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span><span class="bound">lu</span><span class="main">.</span> dom <span class="bound">lu</span> <span class="main">=</span> dom <span class="free">f</span> 
               <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">l</span><span class="main">∈</span>dom <span class="free">f</span><span class="main">.</span> <span class="main">∀</span><span class="bound">s</span> <span class="bound">p</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∉</span> <span class="bound">L'</span> <span class="main">∧</span> <span class="bound">p</span> <span class="main">∉</span> <span class="bound">L'</span> <span class="main">∧</span> <span class="bound">s</span> <span class="main">≠</span> <span class="bound">p</span> 
                              <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">t</span><span class="main">.</span> <span class="main">(</span>the<span class="main">(</span><span class="free">f'</span> <span class="bound">l</span><span class="main">)</span><span class="hidden">⇗</span><sup>[Fvar <span class="bound">s</span><span class="main">,</span> Fvar <span class="bound">p</span>]</sup><span class="hidden">⇖</span><span class="main">)</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> <span class="bound">t</span> 
                                     <span class="main">∧</span> the<span class="main">(</span><span class="bound">lu</span> <span class="bound">l</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">σ[</span><span class="bound">s</span><span class="main">,</span><span class="bound">p</span><span class="main">]</span><span class="bound">t</span><span class="main">)</span><span class="main">)</span>
               <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">l</span><span class="main">∈</span>dom <span class="free">f</span><span class="main">.</span> body <span class="main">(</span>the <span class="main">(</span><span class="free">f'</span> <span class="bound">l</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
               <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">l</span><span class="main">∈</span>dom <span class="free">f</span><span class="main">.</span> <span class="main">∀</span><span class="bound">s</span> <span class="bound">p</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∉</span> <span class="bound">L'</span> <span class="main">∧</span> <span class="bound">p</span> <span class="main">∉</span> <span class="bound">L'</span> <span class="main">∧</span> <span class="bound">s</span> <span class="main">≠</span> <span class="bound">p</span> 
                              <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">t</span><span class="main">.</span> <span class="main">(</span>the<span class="main">(</span><span class="free">lz</span> <span class="bound">l</span><span class="main">)</span><span class="hidden">⇗</span><sup>[Fvar <span class="bound">s</span><span class="main">,</span> Fvar <span class="bound">p</span>]</sup><span class="hidden">⇖</span><span class="main">)</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> <span class="bound">t</span> 
                                     <span class="main">∧</span> the<span class="main">(</span><span class="bound">lu</span> <span class="bound">l</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">σ[</span><span class="bound">s</span><span class="main">,</span><span class="bound">p</span><span class="main">]</span><span class="bound">t</span><span class="main">)</span><span class="main">)</span>
               <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">l</span><span class="main">∈</span>dom <span class="free">f</span><span class="main">.</span> body <span class="main">(</span>the <span class="main">(</span><span class="free">lz</span> <span class="bound">l</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> exL_exMap_lem<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="free">lz</span></span> <span class="quoted"><span class="free">f'</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="ParRed-diamond_par_beta"><span class="command">lemma</span></span> diamond_par_beta<span class="main">:</span> <span class="quoted"><span class="quoted">"diamond par_beta"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> diamond_def commute_def square_def
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> impI <span class="main"><span class="main">[</span></span><span class="operator">THEN</span> allI <span class="main"><span class="main">[</span></span><span class="operator">THEN</span> allI<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">y</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> <span class="skolem">y</span>"</span></span> 
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">z</span><span class="main">.</span> <span class="skolem">x</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> <span class="bound">z</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">u</span><span class="main">.</span> <span class="skolem">y</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> <span class="bound">u</span> <span class="main">∧</span> <span class="bound">z</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> <span class="bound">u</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> par_beta.induct<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> pbeta_Fvar <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>pbeta_Upd <span class="skolem">t</span> <span class="skolem">t'</span> <span class="skolem">L</span> <span class="skolem">u</span> <span class="skolem">u'</span> <span class="skolem">l</span><span class="main">)</span> 
    <span class="keyword1"><span class="command">note</span></span> pred_t <span class="main">=</span> this<span class="main">(</span>2<span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span> pred_u <span class="main">=</span> this<span class="main">(</span>5<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> strip<span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">z</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"Upd <span class="skolem">t</span> <span class="skolem">l</span> <span class="skolem">u</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> <span class="skolem">z</span>"</span></span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">u</span><span class="main">.</span> Upd <span class="skolem">t'</span> <span class="skolem">l</span> <span class="skolem">u'</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> <span class="bound">u</span> <span class="main">∧</span> <span class="skolem">z</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> <span class="bound">u</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> Upd_par_red<span class="main">)</span>
          <span class="comment1">(* Upd: case Upd
             Upd t' l u' ⇒<span class="hidden">⇩</span><sub>β</sub> Upd tb l ub ∧ Upd ta l ua ⇒<span class="hidden">⇩</span><sub>β</sub> Upd tb l ub *)</span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>upd <span class="skolem">ta</span> <span class="skolem">ua</span> <span class="skolem">La</span><span class="main">)</span>
        <span class="keyword1"><span class="command">from</span></span> 
          diamond_binder<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹finite <span class="skolem">L</span>›</span></span> pred_u this<span class="main"><span class="main">(</span></span>2-3<span class="main"><span class="main">)</span></span><span class="main">]</span>
          this<span class="main">(</span>1<span class="main">)</span> pred_t
          par_beta_lc<span class="main">[</span><span class="operator">OF</span> this<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> par_beta_lc<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">t</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> <span class="skolem">t'</span>›</span></span><span class="main">]</span>
        <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">L'</span></span> <span class="skolem"><span class="skolem">ub</span></span> <span class="skolem"><span class="skolem">tb</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
          <span class="quoted"><span class="quoted">"<span class="skolem">t'</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> <span class="skolem">tb</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"lc <span class="skolem">t'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ta</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> <span class="skolem">tb</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 
          <span class="quoted"><span class="quoted">"lc <span class="skolem">ta</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"finite <span class="skolem">L'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
          <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">s</span> <span class="bound">p</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∉</span> <span class="skolem">L'</span> <span class="main">∧</span> <span class="bound">p</span> <span class="main">∉</span> <span class="skolem">L'</span> <span class="main">∧</span> <span class="bound">s</span> <span class="main">≠</span> <span class="bound">p</span> 
            <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">u</span><span class="main">.</span> <span class="skolem">u'</span><span class="hidden">⇗</span><sup>[Fvar <span class="bound">s</span><span class="main">,</span>Fvar <span class="bound">p</span>]</sup><span class="hidden">⇖</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> <span class="bound">u</span> <span class="main">∧</span> <span class="skolem">ub</span> <span class="main">=</span> <span class="keyword1">σ[</span><span class="bound">s</span><span class="main">,</span><span class="bound">p</span><span class="main">]</span> <span class="bound">u</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
          <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">s</span> <span class="bound">p</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∉</span> <span class="skolem">L'</span> <span class="main">∧</span> <span class="bound">p</span> <span class="main">∉</span> <span class="skolem">L'</span> <span class="main">∧</span> <span class="bound">s</span> <span class="main">≠</span> <span class="bound">p</span> 
            <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">u</span><span class="main">.</span> <span class="skolem">ua</span><span class="hidden">⇗</span><sup>[Fvar <span class="bound">s</span><span class="main">,</span>Fvar <span class="bound">p</span>]</sup><span class="hidden">⇖</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> <span class="bound">u</span> <span class="main">∧</span> <span class="skolem">ub</span> <span class="main">=</span> <span class="keyword1">σ[</span><span class="bound">s</span><span class="main">,</span><span class="bound">p</span><span class="main">]</span> <span class="bound">u</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">from</span></span> 
          par_beta.pbeta_Upd<span class="main">[</span><span class="operator">OF</span> this<span class="main"><span class="main">(</span></span>1-2<span class="main"><span class="main">)</span></span> this<span class="main"><span class="main">(</span></span>5-6<span class="main"><span class="main">)</span></span><span class="main">]</span>
          par_beta.pbeta_Upd<span class="main">[</span><span class="operator">OF</span> this<span class="main"><span class="main">(</span></span>3-5<span class="main"><span class="main">)</span></span> this<span class="main"><span class="main">(</span></span>7<span class="main"><span class="main">)</span></span><span class="main">]</span>
          par_beta_body<span class="main">[</span><span class="operator">OF</span> this<span class="main"><span class="main">(</span></span>5-6<span class="main"><span class="main">)</span></span><span class="main">]</span>
          par_beta_body<span class="main">[</span><span class="operator">OF</span> this<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> this<span class="main"><span class="main">(</span></span>7<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="quoted"><span class="quoted">‹<span class="skolem">z</span> <span class="main">=</span> Upd <span class="skolem">ta</span> <span class="skolem">l</span> <span class="skolem">ua</span>›</span></span>
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"Upd <span class="skolem">tb</span> <span class="skolem">l</span> <span class="skolem">ub</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>obj <span class="skolem">f</span> <span class="skolem">fa</span> <span class="skolem">T</span> <span class="skolem">ua</span> <span class="skolem">La</span><span class="main">)</span>
          <span class="comment1">(* Upd: case Obj
             Upd (Obj f' T) l u' ⇒<span class="hidden">⇩</span><sub>β</sub> Obj (fb(l ↦ ub)) T 
           ∧ Obj (fa(l ↦ ua)) T ⇒<span class="hidden">⇩</span><sub>β</sub> Obj (fb(l ↦ ub)) T *)</span>
        <span class="keyword1"><span class="command">from</span></span> diamond_binder<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹finite <span class="skolem">L</span>›</span></span> pred_u this<span class="main"><span class="main">(</span></span>4-5<span class="main"><span class="main">)</span></span><span class="main">]</span>
        <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Lb</span></span> <span class="skolem"><span class="skolem">ub</span></span> <span class="keyword2"><span class="keyword">where</span></span>
          <span class="quoted"><span class="quoted">"finite <span class="skolem">Lb</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
          ub1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">s</span> <span class="bound">p</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∉</span> <span class="skolem">Lb</span> <span class="main">∧</span> <span class="bound">p</span> <span class="main">∉</span> <span class="skolem">Lb</span> <span class="main">∧</span> <span class="bound">s</span> <span class="main">≠</span> <span class="bound">p</span> 
                 <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">u</span><span class="main">.</span> <span class="skolem">ua</span><span class="hidden">⇗</span><sup>[Fvar <span class="bound">s</span><span class="main">,</span>Fvar <span class="bound">p</span>]</sup><span class="hidden">⇖</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> <span class="bound">u</span> <span class="main">∧</span> <span class="skolem">ub</span> <span class="main">=</span> <span class="keyword1">σ[</span><span class="bound">s</span><span class="main">,</span><span class="bound">p</span><span class="main">]</span> <span class="bound">u</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
          ub2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">s</span> <span class="bound">p</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∉</span> <span class="skolem">Lb</span> <span class="main">∧</span> <span class="bound">p</span> <span class="main">∉</span> <span class="skolem">Lb</span> <span class="main">∧</span> <span class="bound">s</span> <span class="main">≠</span> <span class="bound">p</span> 
                 <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">u</span><span class="main">.</span> <span class="skolem">u'</span><span class="hidden">⇗</span><sup>[Fvar <span class="bound">s</span><span class="main">,</span>Fvar <span class="bound">p</span>]</sup><span class="hidden">⇖</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> <span class="bound">u</span> <span class="main">∧</span> <span class="skolem">ub</span> <span class="main">=</span> <span class="keyword1">σ[</span><span class="bound">s</span><span class="main">,</span><span class="bound">p</span><span class="main">]</span> <span class="bound">u</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹Obj <span class="skolem">f</span> <span class="skolem">T</span> <span class="main">=</span> <span class="skolem">t</span>›</span></span> <span class="quoted"><span class="quoted">‹Obj <span class="skolem">f</span> <span class="skolem">T</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> Obj <span class="skolem">fa</span> <span class="skolem">T</span>›</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> Obj <span class="skolem">fa</span> <span class="skolem">T</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">with</span></span> pred_t <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t'</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> <span class="skolem">a</span>"</span></span> <span class="quoted"><span class="quoted">"Obj <span class="skolem">fa</span> <span class="skolem">T</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> <span class="skolem">a</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">with</span></span> 
          par_beta_lc<span class="main">[</span><span class="operator">OF</span> this<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> 
          par_beta_body<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹finite <span class="skolem">Lb</span>›</span></span> ub1<span class="main">]</span>
        <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">fb</span></span> <span class="keyword2"><span class="keyword">where</span></span>
          <span class="quoted"><span class="quoted">"<span class="skolem">t'</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> Obj <span class="skolem">fb</span> <span class="skolem">T</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"Obj <span class="skolem">fa</span> <span class="skolem">T</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> Obj <span class="skolem">fb</span> <span class="skolem">T</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
          <span class="quoted"><span class="quoted">"lc <span class="main">(</span>Obj <span class="skolem">fa</span> <span class="skolem">T</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"body <span class="skolem">ua</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">from</span></span> Obj_pbeta_subst<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹finite <span class="skolem">Lb</span>›</span></span> ub1 this<span class="main"><span class="main">(</span></span>2-4<span class="main"><span class="main">)</span></span><span class="main">]</span> 
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Obj <span class="main">(</span><span class="skolem">fa</span><span class="main">(</span><span class="skolem">l</span> <span class="main">↦</span> <span class="skolem">ua</span><span class="main">)</span><span class="main">)</span> <span class="skolem">T</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> Obj <span class="main">(</span><span class="skolem">fb</span><span class="main">(</span><span class="skolem">l</span> <span class="main">↦</span> <span class="skolem">ub</span><span class="main">)</span><span class="main">)</span> <span class="skolem">T</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">assumption</span>
        <span class="keyword1"><span class="command">moreover</span></span>
        <span class="keyword1"><span class="command">from</span></span> 
          <span class="quoted"><span class="quoted">‹<span class="skolem">t</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> <span class="skolem">t'</span>›</span></span> <span class="quoted"><span class="quoted">‹Obj <span class="skolem">f</span> <span class="skolem">T</span> <span class="main">=</span> <span class="skolem">t</span>›</span></span>
          par_beta_lc<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">t</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> <span class="skolem">t'</span>›</span></span><span class="main">]</span> <span class="quoted"><span class="quoted">‹<span class="skolem">t'</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> Obj <span class="skolem">fb</span> <span class="skolem">T</span>›</span></span>
          par_beta_body<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹finite <span class="skolem">Lb</span>›</span></span> ub2<span class="main">]</span>
        <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">f'</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
          <span class="quoted"><span class="quoted">"<span class="skolem">t'</span> <span class="main">=</span> Obj <span class="skolem">f'</span> <span class="skolem">T</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"Obj <span class="skolem">f'</span> <span class="skolem">T</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> Obj <span class="skolem">fb</span> <span class="skolem">T</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 
          <span class="quoted"><span class="quoted">"lc <span class="main">(</span>Obj <span class="skolem">f'</span> <span class="skolem">T</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"body <span class="skolem">u'</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">note</span></span> par_beta.pbeta_Upd'<span class="main">[</span><span class="operator">OF</span> this<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> <span class="quoted"><span class="quoted">‹finite <span class="skolem">Lb</span>›</span></span> ub2 _ this<span class="main"><span class="main">(</span></span>3-4<span class="main"><span class="main">)</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">moreover</span></span>
        <span class="keyword1"><span class="command">from</span></span> 
          <span class="quoted"><span class="quoted">‹<span class="skolem">t</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> <span class="skolem">t'</span>›</span></span> <span class="quoted"><span class="quoted">‹Obj <span class="skolem">f</span> <span class="skolem">T</span> <span class="main">=</span> <span class="skolem">t</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">t'</span> <span class="main">=</span> Obj <span class="skolem">f'</span> <span class="skolem">T</span>›</span></span>
          <span class="quoted"><span class="quoted">‹<span class="skolem">l</span> <span class="main">∈</span> dom <span class="skolem">f</span>›</span></span> Obj_pbeta<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">f</span></span> <span class="quoted"><span class="skolem">T</span></span> <span class="quoted"><span class="skolem">f'</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">∈</span> dom <span class="skolem">f'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">ultimately</span></span>
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">z</span> <span class="main">=</span> Obj <span class="main">(</span><span class="skolem">fa</span><span class="main">(</span><span class="skolem">l</span> <span class="main">↦</span> <span class="skolem">ua</span><span class="main">)</span><span class="main">)</span> <span class="skolem">T</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">t'</span> <span class="main">=</span> Obj <span class="skolem">f'</span> <span class="skolem">T</span>›</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"Obj <span class="main">(</span><span class="skolem">fb</span><span class="main">(</span><span class="skolem">l</span> <span class="main">↦</span> <span class="skolem">ub</span><span class="main">)</span><span class="main">)</span> <span class="skolem">T</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>pbeta_Obj <span class="skolem">f'</span> <span class="skolem">f</span> <span class="skolem">L</span> <span class="skolem">T</span><span class="main">)</span> <span class="keyword1"><span class="command">note</span></span> pred <span class="main">=</span> this<span class="main">(</span>3<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">clarify</span><span class="main">)</span>
        <span class="comment1">(* Obj f' T ⇒<span class="hidden">⇩</span><sub>β</sub> Obj fb T ∧ Obj fa T ⇒<span class="hidden">⇩</span><sub>β</sub> Obj fb T *)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">fa</span> <span class="skolem">La</span>
      <span class="keyword3"><span class="command">assume</span></span> 
        <span class="quoted"><span class="quoted">"dom <span class="skolem">fa</span> <span class="main">=</span> dom <span class="skolem">f</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"finite <span class="skolem">La</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
        <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">l</span><span class="main">∈</span>dom <span class="skolem">f</span><span class="main">.</span> <span class="main">∀</span><span class="bound">s</span> <span class="bound">p</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∉</span> <span class="skolem">La</span> <span class="main">∧</span> <span class="bound">p</span> <span class="main">∉</span> <span class="skolem">La</span> <span class="main">∧</span> <span class="bound">s</span> <span class="main">≠</span> <span class="bound">p</span>
                     <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">t</span><span class="main">.</span> the <span class="main">(</span><span class="skolem">f</span> <span class="bound">l</span><span class="main">)</span><span class="hidden">⇗</span><sup>[Fvar <span class="bound">s</span><span class="main">,</span>Fvar <span class="bound">p</span>]</sup><span class="hidden">⇖</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> <span class="bound">t</span> 
                            <span class="main">∧</span> the <span class="main">(</span><span class="skolem">fa</span> <span class="bound">l</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">σ[</span><span class="bound">s</span><span class="main">,</span><span class="bound">p</span><span class="main">]</span> <span class="bound">t</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">from</span></span> 
        exL_exMap<span class="main">[</span><span class="operator">OF</span> sym<span class="main"><span class="main">[</span></span><span class="operator">OF</span> this<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span> <span class="quoted"><span class="quoted">‹dom <span class="skolem">f'</span> <span class="main">=</span> dom <span class="skolem">f</span>›</span></span> 
                     <span class="quoted"><span class="quoted">‹finite <span class="skolem">L</span>›</span></span> pred this<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span>
        this<span class="main">(</span>1<span class="main">)</span> this<span class="main">(</span>3<span class="main">)</span> <span class="quoted"><span class="quoted">‹dom <span class="skolem">f'</span> <span class="main">=</span> dom <span class="skolem">f</span>›</span></span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Lb</span></span> <span class="skolem"><span class="skolem">fb</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
        <span class="quoted"><span class="quoted">"dom <span class="skolem">fb</span> <span class="main">=</span> dom <span class="skolem">f'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"dom <span class="skolem">fb</span> <span class="main">=</span> dom <span class="skolem">fa</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"finite <span class="skolem">Lb</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
        <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">l</span><span class="main">∈</span>dom <span class="skolem">f'</span><span class="main">.</span> <span class="main">∀</span><span class="bound">s</span> <span class="bound">p</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∉</span> <span class="skolem">Lb</span> <span class="main">∧</span> <span class="bound">p</span> <span class="main">∉</span> <span class="skolem">Lb</span> <span class="main">∧</span> <span class="bound">s</span> <span class="main">≠</span> <span class="bound">p</span> 
                      <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">t</span><span class="main">.</span> the <span class="main">(</span><span class="skolem">f'</span> <span class="bound">l</span><span class="main">)</span><span class="hidden">⇗</span><sup>[Fvar <span class="bound">s</span><span class="main">,</span>Fvar <span class="bound">p</span>]</sup><span class="hidden">⇖</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> <span class="bound">t</span> 
                             <span class="main">∧</span> the <span class="main">(</span><span class="skolem">fb</span> <span class="bound">l</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">σ[</span><span class="bound">s</span><span class="main">,</span><span class="bound">p</span><span class="main">]</span> <span class="bound">t</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
        <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">l</span><span class="main">∈</span>dom <span class="skolem">f'</span><span class="main">.</span> body <span class="main">(</span>the <span class="main">(</span><span class="skolem">f'</span> <span class="bound">l</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
        <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">l</span><span class="main">∈</span>dom <span class="skolem">fa</span><span class="main">.</span> <span class="main">∀</span><span class="bound">s</span> <span class="bound">p</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∉</span> <span class="skolem">Lb</span> <span class="main">∧</span> <span class="bound">p</span> <span class="main">∉</span> <span class="skolem">Lb</span> <span class="main">∧</span> <span class="bound">s</span> <span class="main">≠</span> <span class="bound">p</span> 
                      <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">t</span><span class="main">.</span> the <span class="main">(</span><span class="skolem">fa</span> <span class="bound">l</span><span class="main">)</span><span class="hidden">⇗</span><sup>[Fvar <span class="bound">s</span><span class="main">,</span>Fvar <span class="bound">p</span>]</sup><span class="hidden">⇖</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> <span class="bound">t</span> 
                             <span class="main">∧</span> the <span class="main">(</span><span class="skolem">fb</span> <span class="bound">l</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">σ[</span><span class="bound">s</span><span class="main">,</span><span class="bound">p</span><span class="main">]</span> <span class="bound">t</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
        <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">l</span><span class="main">∈</span>dom <span class="skolem">fa</span><span class="main">.</span> body <span class="main">(</span>the <span class="main">(</span><span class="skolem">fa</span> <span class="bound">l</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">from</span></span> 
        par_beta.pbeta_Obj<span class="main">[</span><span class="operator">OF</span> this<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> this<span class="main"><span class="main">(</span></span>3-5<span class="main"><span class="main">)</span></span><span class="main">]</span>
        par_beta.pbeta_Obj<span class="main">[</span><span class="operator">OF</span> this<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> this<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> this<span class="main"><span class="main">(</span></span>6-7<span class="main"><span class="main">)</span></span><span class="main">]</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">u</span><span class="main">.</span> Obj <span class="skolem">f'</span> <span class="skolem">T</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> <span class="bound">u</span> <span class="main">∧</span> Obj <span class="skolem">fa</span> <span class="skolem">T</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> <span class="bound">u</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"Obj <span class="skolem">fb</span> <span class="skolem">T</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>pbeta_Upd' <span class="skolem">f</span> <span class="skolem">T</span> <span class="skolem">f'</span> <span class="skolem">L</span> <span class="skolem">t</span> <span class="skolem">t'</span> <span class="skolem">l</span><span class="main">)</span> 
    <span class="keyword1"><span class="command">note</span></span> pred_obj <span class="main">=</span> this<span class="main">(</span>2<span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span> pred_bnd <span class="main">=</span> this<span class="main">(</span>4<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">clarify</span><span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">z</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"Upd <span class="main">(</span>Obj <span class="skolem">f</span> <span class="skolem">T</span><span class="main">)</span> <span class="skolem">l</span> <span class="skolem">t</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> <span class="skolem">z</span>"</span></span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">u</span><span class="main">.</span> Obj <span class="main">(</span><span class="skolem">f'</span><span class="main">(</span><span class="skolem">l</span> <span class="main">↦</span> <span class="skolem">t'</span><span class="main">)</span><span class="main">)</span> <span class="skolem">T</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> <span class="bound">u</span> <span class="main">∧</span> <span class="skolem">z</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> <span class="bound">u</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> Upd_par_red<span class="main">)</span>
          <span class="comment1">(* Upd': case Upd 
             Obj (f'(l ↦ t')) T ⇒<span class="hidden">⇩</span><sub>β</sub> Obj (fb(l ↦ tb)) T 
           ∧ Upd (Obj fa T) l ta ⇒<span class="hidden">⇩</span><sub>β</sub> Obj (fb(l ↦ tb)) T *)</span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>upd <span class="skolem">a</span> <span class="skolem">ta</span> <span class="skolem">La</span><span class="main">)</span> <span class="keyword1"><span class="command">note</span></span> pred_ta <span class="main">=</span> this<span class="main">(</span>3<span class="main">)</span>
        <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹Obj <span class="skolem">f</span> <span class="skolem">T</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> <span class="skolem">a</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">z</span> <span class="main">=</span> Upd <span class="skolem">a</span> <span class="skolem">l</span> <span class="skolem">ta</span>›</span></span>
        <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">fa</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
          <span class="quoted"><span class="quoted">"Obj <span class="skolem">f</span> <span class="skolem">T</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> Obj <span class="skolem">fa</span> <span class="skolem">T</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">=</span> Upd <span class="main">(</span>Obj <span class="skolem">fa</span> <span class="skolem">T</span><span class="main">)</span> <span class="skolem">l</span> <span class="skolem">ta</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">from</span></span> this<span class="main">(</span>1<span class="main">)</span> pred_obj
        <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">b</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"Obj <span class="skolem">f'</span> <span class="skolem">T</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> <span class="skolem">b</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"Obj <span class="skolem">fa</span> <span class="skolem">T</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> <span class="skolem">b</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">elim</span> allE impE exE conjE<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
        <span class="keyword1"><span class="command">with</span></span> 
          par_beta_lc<span class="main">[</span><span class="operator">OF</span> this<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> par_beta_lc<span class="main">[</span><span class="operator">OF</span> this<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span>
        <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">fb</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
          <span class="quoted"><span class="quoted">"Obj <span class="skolem">f'</span> <span class="skolem">T</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> Obj <span class="skolem">fb</span> <span class="skolem">T</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"lc <span class="main">(</span>Obj <span class="skolem">f'</span> <span class="skolem">T</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
          <span class="quoted"><span class="quoted">"Obj <span class="skolem">fa</span> <span class="skolem">T</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> Obj <span class="skolem">fb</span> <span class="skolem">T</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"lc <span class="main">(</span>Obj <span class="skolem">fa</span> <span class="skolem">T</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">from</span></span> diamond_binder<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹finite <span class="skolem">L</span>›</span></span> pbeta_Upd'<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> <span class="quoted"><span class="quoted">‹finite <span class="skolem">La</span>›</span></span> pred_ta<span class="main">]</span>
        <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Lb</span></span> <span class="skolem"><span class="skolem">tb</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
          <span class="quoted"><span class="quoted">"finite <span class="skolem">Lb</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
          cb1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">s</span> <span class="bound">p</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∉</span> <span class="skolem">Lb</span> <span class="main">∧</span> <span class="bound">p</span> <span class="main">∉</span> <span class="skolem">Lb</span> <span class="main">∧</span> <span class="bound">s</span> <span class="main">≠</span> <span class="bound">p</span> 
                 <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">u</span><span class="main">.</span> <span class="skolem">t'</span><span class="hidden">⇗</span><sup>[Fvar <span class="bound">s</span><span class="main">,</span>Fvar <span class="bound">p</span>]</sup><span class="hidden">⇖</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> <span class="bound">u</span> <span class="main">∧</span> <span class="skolem">tb</span> <span class="main">=</span> <span class="keyword1">σ[</span><span class="bound">s</span><span class="main">,</span><span class="bound">p</span><span class="main">]</span> <span class="bound">u</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
          cb2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">s</span> <span class="bound">p</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∉</span> <span class="skolem">Lb</span> <span class="main">∧</span> <span class="bound">p</span> <span class="main">∉</span> <span class="skolem">Lb</span> <span class="main">∧</span> <span class="bound">s</span> <span class="main">≠</span> <span class="bound">p</span> 
                 <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">u</span><span class="main">.</span> <span class="skolem">ta</span><span class="hidden">⇗</span><sup>[Fvar <span class="bound">s</span><span class="main">,</span>Fvar <span class="bound">p</span>]</sup><span class="hidden">⇖</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> <span class="bound">u</span> <span class="main">∧</span> <span class="skolem">tb</span> <span class="main">=</span> <span class="keyword1">σ[</span><span class="bound">s</span><span class="main">,</span><span class="bound">p</span><span class="main">]</span> <span class="bound">u</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">from</span></span> 
          par_beta_body<span class="main">[</span><span class="operator">OF</span> this<span class="main"><span class="main">(</span></span>1-2<span class="main"><span class="main">)</span></span><span class="main">]</span> 
          Obj_pbeta_subst<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹finite <span class="skolem">Lb</span>›</span></span> cb1 <span class="quoted"><span class="quoted">‹Obj <span class="skolem">f'</span> <span class="skolem">T</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> Obj <span class="skolem">fb</span> <span class="skolem">T</span>›</span></span>
                             <span class="quoted"><span class="quoted">‹lc <span class="main">(</span>Obj <span class="skolem">f'</span> <span class="skolem">T</span><span class="main">)</span>›</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Obj <span class="main">(</span><span class="skolem">f'</span><span class="main">(</span><span class="skolem">l</span> <span class="main">↦</span> <span class="skolem">t'</span><span class="main">)</span><span class="main">)</span> <span class="skolem">T</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> Obj <span class="main">(</span><span class="skolem">fb</span><span class="main">(</span><span class="skolem">l</span> <span class="main">↦</span> <span class="skolem">tb</span><span class="main">)</span><span class="main">)</span> <span class="skolem">T</span>"</span></span> 
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">moreover</span></span>
        <span class="keyword1"><span class="command">from</span></span> Obj_pbeta<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹Obj <span class="skolem">f</span> <span class="skolem">T</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> Obj <span class="skolem">fa</span> <span class="skolem">T</span>›</span></span><span class="main">]</span> <span class="quoted"><span class="quoted">‹<span class="skolem">l</span> <span class="main">∈</span> dom <span class="skolem">f</span>›</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">∈</span> dom <span class="skolem">fa</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">from</span></span> 
          par_beta_body<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹finite <span class="skolem">Lb</span>›</span></span> cb2<span class="main">]</span>
          par_beta.pbeta_Upd'<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹Obj <span class="skolem">fa</span> <span class="skolem">T</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> Obj <span class="skolem">fb</span> <span class="skolem">T</span>›</span></span> <span class="quoted"><span class="quoted">‹finite <span class="skolem">Lb</span>›</span></span> 
                                 cb2 this <span class="quoted"><span class="quoted">‹lc <span class="main">(</span>Obj <span class="skolem">fa</span> <span class="skolem">T</span><span class="main">)</span>›</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Upd <span class="main">(</span>Obj <span class="skolem">fa</span> <span class="skolem">T</span><span class="main">)</span> <span class="skolem">l</span> <span class="skolem">ta</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> Obj <span class="main">(</span><span class="skolem">fb</span><span class="main">(</span><span class="skolem">l</span> <span class="main">↦</span> <span class="skolem">tb</span><span class="main">)</span><span class="main">)</span> <span class="skolem">T</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">ultimately</span></span>
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">z</span> <span class="main">=</span> Upd <span class="main">(</span>Obj <span class="skolem">fa</span> <span class="skolem">T</span><span class="main">)</span> <span class="skolem">l</span> <span class="skolem">ta</span>›</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"Obj <span class="main">(</span><span class="skolem">fb</span><span class="main">(</span><span class="skolem">l</span> <span class="main">↦</span> <span class="skolem">tb</span><span class="main">)</span><span class="main">)</span> <span class="skolem">T</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
          <span class="comment1">(* Upd': case Obj 
             Obj (f'(l ↦ t')) T ⇒<span class="hidden">⇩</span><sub>β</sub> Obj (fb(l ↦ tb)) T 
           ∧ Obj (fa(l ↦ ta)) T ⇒<span class="hidden">⇩</span><sub>β</sub> Obj (fb(l ↦ tb)) T *)</span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>obj <span class="skolem">f''</span> <span class="skolem">fa</span> <span class="skolem">T'</span> <span class="skolem">ta</span> <span class="skolem">La</span><span class="main">)</span> 
        <span class="keyword1"><span class="command">note</span></span> pred_ta <span class="main">=</span> this<span class="main">(</span>5<span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span> this
        <span class="keyword1"><span class="command">hence</span></span> 
          <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">∈</span> dom <span class="skolem">f</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"Obj <span class="skolem">f</span> <span class="skolem">T</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> Obj <span class="skolem">fa</span> <span class="skolem">T</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
          <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">=</span> Obj <span class="main">(</span><span class="skolem">fa</span><span class="main">(</span><span class="skolem">l</span> <span class="main">↦</span> <span class="skolem">ta</span><span class="main">)</span><span class="main">)</span> <span class="skolem">T</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">from</span></span> diamond_binder<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹finite <span class="skolem">L</span>›</span></span> pred_bnd <span class="quoted"><span class="quoted">‹finite <span class="skolem">La</span>›</span></span> pred_ta<span class="main">]</span>
        <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Lb</span></span> <span class="skolem"><span class="skolem">tb</span></span> <span class="keyword2"><span class="keyword">where</span></span>
          <span class="quoted"><span class="quoted">"finite <span class="skolem">Lb</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
          tb1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">s</span> <span class="bound">p</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∉</span> <span class="skolem">Lb</span> <span class="main">∧</span> <span class="bound">p</span> <span class="main">∉</span> <span class="skolem">Lb</span> <span class="main">∧</span> <span class="bound">s</span> <span class="main">≠</span> <span class="bound">p</span> 
                 <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">u</span><span class="main">.</span> <span class="skolem">t'</span><span class="hidden">⇗</span><sup>[Fvar <span class="bound">s</span><span class="main">,</span>Fvar <span class="bound">p</span>]</sup><span class="hidden">⇖</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> <span class="bound">u</span> <span class="main">∧</span> <span class="skolem">tb</span> <span class="main">=</span> <span class="keyword1">σ[</span><span class="bound">s</span><span class="main">,</span><span class="bound">p</span><span class="main">]</span> <span class="bound">u</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
          tb2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">s</span> <span class="bound">p</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∉</span> <span class="skolem">Lb</span> <span class="main">∧</span> <span class="bound">p</span> <span class="main">∉</span> <span class="skolem">Lb</span> <span class="main">∧</span> <span class="bound">s</span> <span class="main">≠</span> <span class="bound">p</span> 
                 <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">u</span><span class="main">.</span> <span class="skolem">ta</span><span class="hidden">⇗</span><sup>[Fvar <span class="bound">s</span><span class="main">,</span>Fvar <span class="bound">p</span>]</sup><span class="hidden">⇖</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> <span class="bound">u</span> <span class="main">∧</span> <span class="skolem">tb</span> <span class="main">=</span> <span class="keyword1">σ[</span><span class="bound">s</span><span class="main">,</span><span class="bound">p</span><span class="main">]</span> <span class="bound">u</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹Obj <span class="skolem">f</span> <span class="skolem">T</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> Obj <span class="skolem">fa</span> <span class="skolem">T</span>›</span></span> pred_obj
        <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">b</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"Obj <span class="skolem">f'</span> <span class="skolem">T</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> <span class="skolem">b</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"Obj <span class="skolem">fa</span> <span class="skolem">T</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> <span class="skolem">b</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">elim</span> allE impE exE conjE<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
        <span class="keyword1"><span class="command">with</span></span> par_beta_lc<span class="main">[</span><span class="operator">OF</span> this<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> par_beta_lc<span class="main">[</span><span class="operator">OF</span> this<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span>
        <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">fb</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
          <span class="quoted"><span class="quoted">"Obj <span class="skolem">f'</span> <span class="skolem">T</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> Obj <span class="skolem">fb</span> <span class="skolem">T</span>"</span></span> <span class="quoted"><span class="quoted">"lc <span class="main">(</span>Obj <span class="skolem">f'</span> <span class="skolem">T</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
          <span class="quoted"><span class="quoted">"Obj <span class="skolem">fa</span> <span class="skolem">T</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> Obj <span class="skolem">fb</span> <span class="skolem">T</span>"</span></span> <span class="quoted"><span class="quoted">"lc <span class="main">(</span>Obj <span class="skolem">fa</span> <span class="skolem">T</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">from</span></span> 
          par_beta_body<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹finite <span class="skolem">Lb</span>›</span></span> tb1<span class="main">]</span> 
          Obj_pbeta_subst<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹finite <span class="skolem">Lb</span>›</span></span> tb1 this<span class="main"><span class="main">(</span></span>1-2<span class="main"><span class="main">)</span></span><span class="main">]</span>
          par_beta_body<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹finite <span class="skolem">Lb</span>›</span></span> tb2<span class="main">]</span> 
          Obj_pbeta_subst<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹finite <span class="skolem">Lb</span>›</span></span> tb2 this<span class="main"><span class="main">(</span></span>3-4<span class="main"><span class="main">)</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">have</span></span> 
          <span class="quoted"><span class="quoted">"Obj <span class="main">(</span><span class="skolem">f'</span><span class="main">(</span><span class="skolem">l</span> <span class="main">↦</span> <span class="skolem">t'</span><span class="main">)</span><span class="main">)</span> <span class="skolem">T</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> Obj <span class="main">(</span><span class="skolem">fb</span><span class="main">(</span><span class="skolem">l</span> <span class="main">↦</span> <span class="skolem">tb</span><span class="main">)</span><span class="main">)</span> <span class="skolem">T</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
          <span class="quoted"><span class="quoted">"Obj <span class="main">(</span><span class="skolem">fa</span><span class="main">(</span><span class="skolem">l</span> <span class="main">↦</span> <span class="skolem">ta</span><span class="main">)</span><span class="main">)</span> <span class="skolem">T</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> Obj <span class="main">(</span><span class="skolem">fb</span><span class="main">(</span><span class="skolem">l</span> <span class="main">↦</span> <span class="skolem">tb</span><span class="main">)</span><span class="main">)</span> <span class="skolem">T</span>"</span></span> 
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>
        <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">z</span> <span class="main">=</span> Obj <span class="main">(</span><span class="skolem">fa</span><span class="main">(</span><span class="skolem">l</span> <span class="main">↦</span> <span class="skolem">ta</span><span class="main">)</span><span class="main">)</span> <span class="skolem">T</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"Obj <span class="main">(</span><span class="skolem">fb</span><span class="main">(</span><span class="skolem">l</span> <span class="main">↦</span> <span class="skolem">tb</span><span class="main">)</span><span class="main">)</span> <span class="skolem">T</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>pbeta_Call <span class="skolem">t</span> <span class="skolem">t'</span> <span class="skolem">u</span> <span class="skolem">u'</span> <span class="skolem">l</span><span class="main">)</span> 
    <span class="keyword1"><span class="command">note</span></span> pred_t <span class="main">=</span> this<span class="main">(</span>2<span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span> pred_u <span class="main">=</span> this<span class="main">(</span>4<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> strip<span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">z</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"Call <span class="skolem">t</span> <span class="skolem">l</span> <span class="skolem">u</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> <span class="skolem">z</span>"</span></span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">u</span><span class="main">.</span> Call <span class="skolem">t'</span> <span class="skolem">l</span> <span class="skolem">u'</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> <span class="bound">u</span> <span class="main">∧</span> <span class="skolem">z</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> <span class="bound">u</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> Call_par_red<span class="main">)</span>
          <span class="comment1">(* Call: case Call 
             Call t' l u' ⇒<span class="hidden">⇩</span><sub>β</sub> Call tb l ub ∧ Call t' l u' ⇒<span class="hidden">⇩</span><sub>β</sub> Call tb l ub *)</span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>call <span class="skolem">ta</span> <span class="skolem">ua</span><span class="main">)</span>
        <span class="keyword1"><span class="command">from</span></span> 
          this<span class="main">(</span>1-2<span class="main">)</span> pred_t pred_u
        <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">tb</span></span> <span class="skolem"><span class="skolem">ub</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t'</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> <span class="skolem">tb</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u'</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> <span class="skolem">ub</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ta</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> <span class="skolem">tb</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ua</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> <span class="skolem">ub</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">elim</span> allE impE exE conjE<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
        <span class="keyword1"><span class="command">from</span></span> 
          par_beta_lc<span class="main">[</span><span class="operator">OF</span> this<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> par_beta_lc<span class="main">[</span><span class="operator">OF</span> this<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span>
          par_beta.pbeta_Call<span class="main">[</span><span class="operator">OF</span> this<span class="main"><span class="main">(</span></span>1-2<span class="main"><span class="main">)</span></span><span class="main">]</span>
          par_beta_lc<span class="main">[</span><span class="operator">OF</span> this<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">]</span> par_beta_lc<span class="main">[</span><span class="operator">OF</span> this<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">]</span> 
          par_beta.pbeta_Call<span class="main">[</span><span class="operator">OF</span> this<span class="main"><span class="main">(</span></span>3-4<span class="main"><span class="main">)</span></span><span class="main">]</span>
          <span class="quoted"><span class="quoted">‹<span class="skolem">z</span> <span class="main">=</span> Call <span class="skolem">ta</span> <span class="skolem">l</span> <span class="skolem">ua</span>›</span></span>
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"Call <span class="skolem">tb</span> <span class="skolem">l</span> <span class="skolem">ub</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
          <span class="comment1">(* Call: case beta 
             Call (Obj f' T) l u' ⇒<span class="hidden">⇩</span><sub>β</sub> (the (fb l)<span class="hidden">⇗</span><sup>[Obj fb T,ub]</sup><span class="hidden">⇖</span>)
           ∧ the (fa l)<span class="hidden">⇗</span><sup>[Obj fa T,ua]</sup><span class="hidden">⇖</span> ⇒<span class="hidden">⇩</span><sub>β</sub> (the (fb l)<span class="hidden">⇗</span><sup>[Obj fb T,ub]</sup><span class="hidden">⇖</span>) *)</span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>beta <span class="skolem">f</span> <span class="skolem">fa</span> <span class="skolem">T</span> <span class="skolem">ua</span><span class="main">)</span> 
        <span class="keyword1"><span class="command">from</span></span> this<span class="main">(</span>1-2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> Obj <span class="skolem">fa</span> <span class="skolem">T</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">u</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> <span class="skolem">ua</span>›</span></span> pred_t pred_u
        <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">b</span></span> <span class="skolem"><span class="skolem">ub</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
          <span class="quoted"><span class="quoted">"<span class="skolem">t'</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> <span class="skolem">b</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"Obj <span class="skolem">fa</span> <span class="skolem">T</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> <span class="skolem">b</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u'</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> <span class="skolem">ub</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ua</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> <span class="skolem">ub</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">elim</span> allE impE exE conjE<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
        <span class="keyword1"><span class="command">from</span></span> this<span class="main">(</span>1-2<span class="main">)</span> par_beta_lc<span class="main">[</span><span class="operator">OF</span> this<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span>
        <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">fb</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
          <span class="quoted"><span class="quoted">"<span class="skolem">t'</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> Obj <span class="skolem">fb</span> <span class="skolem">T</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 
          <span class="quoted"><span class="quoted">"Obj <span class="skolem">fa</span> <span class="skolem">T</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> Obj <span class="skolem">fb</span> <span class="skolem">T</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"lc <span class="main">(</span>Obj <span class="skolem">fa</span> <span class="skolem">T</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">from</span></span> 
          par_beta_beta<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">l</span> <span class="main">∈</span> dom <span class="skolem">fa</span>›</span></span> this<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">ua</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> <span class="skolem">ub</span>›</span></span> this<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">]</span>
          par_beta_lc<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">ua</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> <span class="skolem">ub</span>›</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"the <span class="main">(</span><span class="skolem">fa</span> <span class="skolem">l</span><span class="main">)</span><span class="hidden">⇗</span><sup>[Obj <span class="skolem">fa</span> <span class="skolem">T</span><span class="main">,</span><span class="skolem">ua</span>]</sup><span class="hidden">⇖</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> <span class="main">(</span>the <span class="main">(</span><span class="skolem">fb</span> <span class="skolem">l</span><span class="main">)</span><span class="hidden">⇗</span><sup>[Obj <span class="skolem">fb</span> <span class="skolem">T</span><span class="main">,</span><span class="skolem">ub</span>]</sup><span class="hidden">⇖</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">moreover</span></span>
        <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">l</span> <span class="main">∈</span> dom <span class="skolem">fa</span>›</span></span> Obj_pbeta<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹Obj <span class="skolem">fa</span> <span class="skolem">T</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> Obj <span class="skolem">fb</span> <span class="skolem">T</span>›</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">∈</span> dom <span class="skolem">fb</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">from</span></span> 
          <span class="quoted"><span class="quoted">‹<span class="skolem">t</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> <span class="skolem">t'</span>›</span></span> sym<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹Obj <span class="skolem">f</span> <span class="skolem">T</span> <span class="main">=</span> <span class="skolem">t</span>›</span></span><span class="main">]</span>
          par_beta_lc<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">t</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> <span class="skolem">t'</span>›</span></span><span class="main">]</span> <span class="quoted"><span class="quoted">‹<span class="skolem">t'</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> Obj <span class="skolem">fb</span> <span class="skolem">T</span>›</span></span>
        <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">f'</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
          <span class="quoted"><span class="quoted">"<span class="skolem">t'</span> <span class="main">=</span> Obj <span class="skolem">f'</span> <span class="skolem">T</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"Obj <span class="skolem">f'</span> <span class="skolem">T</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> Obj <span class="skolem">fb</span> <span class="skolem">T</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
          <span class="quoted"><span class="quoted">"lc <span class="main">(</span>Obj <span class="skolem">f'</span> <span class="skolem">T</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">from</span></span> 
          Obj_pbeta<span class="main">[</span><span class="operator">OF</span> this<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="quoted"><span class="quoted">‹<span class="skolem">l</span> <span class="main">∈</span> dom <span class="skolem">fb</span>›</span></span>
          par_beta.pbeta_beta<span class="main">[</span><span class="operator">OF</span> this<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> _ <span class="quoted"><span class="quoted">‹<span class="skolem">u'</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> <span class="skolem">ub</span>›</span></span> this<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">]</span>
          par_beta_lc<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">u'</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> <span class="skolem">ub</span>›</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Call <span class="main">(</span>Obj <span class="skolem">f'</span> <span class="skolem">T</span><span class="main">)</span> <span class="skolem">l</span> <span class="skolem">u'</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> <span class="main">(</span>the <span class="main">(</span><span class="skolem">fb</span> <span class="skolem">l</span><span class="main">)</span><span class="hidden">⇗</span><sup>[Obj <span class="skolem">fb</span> <span class="skolem">T</span><span class="main">,</span><span class="skolem">ub</span>]</sup><span class="hidden">⇖</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">ultimately</span></span>
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">t'</span> <span class="main">=</span> Obj <span class="skolem">f'</span> <span class="skolem">T</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">z</span> <span class="main">=</span> <span class="main">(</span>the <span class="main">(</span><span class="skolem">fa</span> <span class="skolem">l</span><span class="main">)</span><span class="hidden">⇗</span><sup>[Obj <span class="skolem">fa</span> <span class="skolem">T</span><span class="main">,</span><span class="skolem">ua</span>]</sup><span class="hidden">⇖</span><span class="main">)</span>›</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>the <span class="main">(</span><span class="skolem">fb</span> <span class="skolem">l</span><span class="main">)</span><span class="hidden">⇗</span><sup>[Obj <span class="skolem">fb</span> <span class="skolem">T</span><span class="main">,</span><span class="skolem">ub</span>]</sup><span class="hidden">⇖</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>pbeta_beta <span class="skolem">f</span> <span class="skolem">T</span> <span class="skolem">f'</span> <span class="skolem">l</span> <span class="skolem">p</span> <span class="skolem">p'</span><span class="main">)</span> 
    <span class="keyword1"><span class="command">note</span></span> pred_obj <span class="main">=</span> this<span class="main">(</span>2<span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span> pred_p <span class="main">=</span> this<span class="main">(</span>5<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> strip<span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">z</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"Call <span class="main">(</span>Obj <span class="skolem">f</span> <span class="skolem">T</span><span class="main">)</span> <span class="skolem">l</span> <span class="skolem">p</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> <span class="skolem">z</span>"</span></span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">u</span><span class="main">.</span> the <span class="main">(</span><span class="skolem">f'</span> <span class="skolem">l</span><span class="main">)</span><span class="hidden">⇗</span><sup>[Obj <span class="skolem">f'</span> <span class="skolem">T</span><span class="main">,</span><span class="skolem">p'</span>]</sup><span class="hidden">⇖</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> <span class="bound">u</span> <span class="main">∧</span> <span class="skolem">z</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> <span class="bound">u</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> Call_par_red<span class="main">)</span>
          <span class="comment1">(* beta: case Call 
             Call (Obj fa T) l pa ⇒<span class="hidden">⇩</span><sub>β</sub> (the (fb l)<span class="hidden">⇗</span><sup>[Obj fb T,pb]</sup><span class="hidden">⇖</span>) 
           ∧ the (f' l)<span class="hidden">⇗</span><sup>[Obj f' T,p']</sup><span class="hidden">⇖</span> ⇒<span class="hidden">⇩</span><sub>β</sub> (the (fb l)<span class="hidden">⇗</span><sup>[Obj fb T,pb]</sup><span class="hidden">⇖</span>) *)</span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>call <span class="skolem">a</span> <span class="skolem">pa</span><span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">fa</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
          <span class="quoted"><span class="quoted">"Obj <span class="skolem">f</span> <span class="skolem">T</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> Obj <span class="skolem">fa</span> <span class="skolem">T</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">=</span> Call <span class="main">(</span>Obj <span class="skolem">fa</span> <span class="skolem">T</span><span class="main">)</span> <span class="skolem">l</span> <span class="skolem">pa</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">from</span></span> 
          this<span class="main">(</span>1<span class="main">)</span> <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> <span class="skolem">pa</span>›</span></span> pred_obj pred_p
        <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">b</span></span> <span class="skolem"><span class="skolem">pb</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
          <span class="quoted"><span class="quoted">"Obj <span class="skolem">f'</span> <span class="skolem">T</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> <span class="skolem">b</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"Obj <span class="skolem">fa</span> <span class="skolem">T</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> <span class="skolem">b</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 
          <span class="quoted"><span class="quoted">"<span class="skolem">p'</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> <span class="skolem">pb</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">pa</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> <span class="skolem">pb</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">elim</span> allE impE exE conjE<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
        <span class="keyword1"><span class="command">with</span></span> par_beta_lc<span class="main">[</span><span class="operator">OF</span> this<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> par_beta_lc<span class="main">[</span><span class="operator">OF</span> this<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span>
        <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">fb</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
          <span class="quoted"><span class="quoted">"Obj <span class="skolem">f'</span> <span class="skolem">T</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> Obj <span class="skolem">fb</span> <span class="skolem">T</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"lc <span class="main">(</span>Obj <span class="skolem">f'</span> <span class="skolem">T</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
          <span class="quoted"><span class="quoted">"Obj <span class="skolem">fa</span> <span class="skolem">T</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> Obj <span class="skolem">fb</span> <span class="skolem">T</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"lc <span class="main">(</span>Obj <span class="skolem">fa</span> <span class="skolem">T</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">from</span></span> this<span class="main">(</span>1<span class="main">)</span> <span class="quoted"><span class="quoted">‹<span class="skolem">l</span> <span class="main">∈</span> dom <span class="skolem">f</span>›</span></span> <span class="quoted"><span class="quoted">‹Obj <span class="skolem">f</span> <span class="skolem">T</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> Obj <span class="skolem">f'</span> <span class="skolem">T</span>›</span></span> <span class="quoted"><span class="quoted">‹Obj <span class="skolem">f</span> <span class="skolem">T</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> Obj <span class="skolem">fa</span> <span class="skolem">T</span>›</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">∈</span> dom <span class="skolem">f'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">∈</span> dom <span class="skolem">fa</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">p'</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> <span class="skolem">pb</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">pa</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> <span class="skolem">pb</span>›</span></span> par_beta_lc
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p'</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> <span class="skolem">pb</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"lc <span class="skolem">p'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">pa</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> <span class="skolem">pb</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"lc <span class="skolem">pa</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">from</span></span> 
          par_beta.pbeta_beta<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹Obj <span class="skolem">fa</span> <span class="skolem">T</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> Obj <span class="skolem">fb</span> <span class="skolem">T</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">l</span> <span class="main">∈</span> dom <span class="skolem">fa</span>›</span></span>
                                  this<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> <span class="quoted"><span class="quoted">‹lc <span class="main">(</span>Obj <span class="skolem">fa</span> <span class="skolem">T</span><span class="main">)</span>›</span></span> this<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">]</span> 
          par_beta_beta<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">l</span> <span class="main">∈</span> dom <span class="skolem">f'</span>›</span></span> <span class="quoted"><span class="quoted">‹Obj <span class="skolem">f'</span> <span class="skolem">T</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> Obj <span class="skolem">fb</span> <span class="skolem">T</span>›</span></span>
                            this<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> <span class="quoted"><span class="quoted">‹lc <span class="main">(</span>Obj <span class="skolem">f'</span> <span class="skolem">T</span><span class="main">)</span>›</span></span> this<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span>
          <span class="quoted"><span class="quoted">‹<span class="skolem">z</span> <span class="main">=</span> Call <span class="main">(</span>Obj <span class="skolem">fa</span> <span class="skolem">T</span><span class="main">)</span> <span class="skolem">l</span> <span class="skolem">pa</span>›</span></span>
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>the <span class="main">(</span><span class="skolem">fb</span> <span class="skolem">l</span><span class="main">)</span><span class="hidden">⇗</span><sup>[Obj <span class="skolem">fb</span> <span class="skolem">T</span><span class="main">,</span><span class="skolem">pb</span>]</sup><span class="hidden">⇖</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
          <span class="comment1">(* beta: case beta 
             the (f' l)<span class="hidden">⇗</span><sup>[Obj f' T,p']</sup><span class="hidden">⇖</span> ⇒<span class="hidden">⇩</span><sub>β</sub> (the (fb l)<span class="hidden">⇗</span><sup>[Obj fb T,pb]</sup><span class="hidden">⇖</span>)
          ∧  the (fa l)<span class="hidden">⇗</span><sup>[Obj fa T,pa]</sup><span class="hidden">⇖</span> ⇒<span class="hidden">⇩</span><sub>β</sub> (the (fb l)<span class="hidden">⇗</span><sup>[Obj fb T,pb]</sup><span class="hidden">⇖</span>) *)</span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>beta <span class="skolem">f''</span> <span class="skolem">fa</span> <span class="skolem">Ta</span> <span class="skolem">pa</span><span class="main">)</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"Obj <span class="skolem">f</span> <span class="skolem">T</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> Obj <span class="skolem">fa</span> <span class="skolem">T</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">=</span> <span class="main">(</span>the <span class="main">(</span><span class="skolem">fa</span> <span class="skolem">l</span><span class="main">)</span><span class="hidden">⇗</span><sup>[Obj <span class="skolem">fa</span> <span class="skolem">T</span><span class="main">,</span><span class="skolem">pa</span>]</sup><span class="hidden">⇖</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> <span class="skolem">pa</span>›</span></span> pred_obj pred_p
        <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">b</span></span> <span class="skolem"><span class="skolem">pb</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
          <span class="quoted"><span class="quoted">"Obj <span class="skolem">f'</span> <span class="skolem">T</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> <span class="skolem">b</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"Obj <span class="skolem">fa</span> <span class="skolem">T</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> <span class="skolem">b</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
          <span class="quoted"><span class="quoted">"<span class="skolem">p'</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> <span class="skolem">pb</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">pa</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> <span class="skolem">pb</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">elim</span> allE impE exE conjE<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
        <span class="keyword1"><span class="command">with</span></span> par_beta_lc
        <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">fb</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
          <span class="quoted"><span class="quoted">"Obj <span class="skolem">f'</span> <span class="skolem">T</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> Obj <span class="skolem">fb</span> <span class="skolem">T</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"lc <span class="main">(</span>Obj <span class="skolem">f'</span> <span class="skolem">T</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"lc <span class="skolem">p'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
          <span class="quoted"><span class="quoted">"Obj <span class="skolem">fa</span> <span class="skolem">T</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> Obj <span class="skolem">fb</span> <span class="skolem">T</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"lc <span class="main">(</span>Obj <span class="skolem">fa</span> <span class="skolem">T</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"lc <span class="skolem">pa</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">l</span> <span class="main">∈</span> dom <span class="skolem">f</span>›</span></span> <span class="quoted"><span class="quoted">‹Obj <span class="skolem">f</span> <span class="skolem">T</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> Obj <span class="skolem">f'</span> <span class="skolem">T</span>›</span></span> <span class="quoted"><span class="quoted">‹Obj <span class="skolem">f</span> <span class="skolem">T</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> Obj <span class="skolem">fa</span> <span class="skolem">T</span>›</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">∈</span> dom <span class="skolem">f'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">∈</span> dom <span class="skolem">fa</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">from</span></span>
          par_beta_beta<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">l</span> <span class="main">∈</span> dom <span class="skolem">f'</span>›</span></span> <span class="quoted"><span class="quoted">‹Obj <span class="skolem">f'</span> <span class="skolem">T</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> Obj <span class="skolem">fb</span> <span class="skolem">T</span>›</span></span> 
                           <span class="quoted"><span class="quoted">‹<span class="skolem">p'</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> <span class="skolem">pb</span>›</span></span> <span class="quoted"><span class="quoted">‹lc <span class="main">(</span>Obj <span class="skolem">f'</span> <span class="skolem">T</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹lc <span class="skolem">p'</span>›</span></span><span class="main">]</span>
          par_beta_beta<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">l</span> <span class="main">∈</span> dom <span class="skolem">fa</span>›</span></span> <span class="quoted"><span class="quoted">‹Obj <span class="skolem">fa</span> <span class="skolem">T</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> Obj <span class="skolem">fb</span> <span class="skolem">T</span>›</span></span> 
                           <span class="quoted"><span class="quoted">‹<span class="skolem">pa</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>β</sub></span> <span class="skolem">pb</span>›</span></span> <span class="quoted"><span class="quoted">‹lc <span class="main">(</span>Obj <span class="skolem">fa</span> <span class="skolem">T</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹lc <span class="skolem">pa</span>›</span></span><span class="main">]</span>
          <span class="quoted"><span class="quoted">‹<span class="skolem">z</span> <span class="main">=</span> <span class="main">(</span>the <span class="main">(</span><span class="skolem">fa</span> <span class="skolem">l</span><span class="main">)</span><span class="hidden">⇗</span><sup>[Obj <span class="skolem">fa</span> <span class="skolem">T</span><span class="main">,</span><span class="skolem">pa</span>]</sup><span class="hidden">⇖</span><span class="main">)</span>›</span></span>
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>the <span class="main">(</span><span class="skolem">fb</span> <span class="skolem">l</span><span class="main">)</span><span class="hidden">⇗</span><sup>[Obj <span class="skolem">fb</span> <span class="skolem">T</span><span class="main">,</span><span class="skolem">pb</span>]</sup><span class="hidden">⇖</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Confluence (classical not via complete developments)›</span></span>

<span class="keyword1"><span class="command">theorem</span></span> beta_confluent<span class="main">:</span> <span class="quoted"><span class="quoted">"confluent beta"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> diamond_par_beta diamond_to_confluence
      par_beta_subset_beta beta_subset_par_beta<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Environments">
<div class="head">
<h1>Theory Environments</h1>
</div>
<pre class="source"><span class="comment1">(*  Title:      Environments.thy
    Author:     Florian Kammuller and Henry Sudhof, 2008
*)</span>

<span class="keyword1"><span class="command">theory</span></span> Environments <span class="keyword2"><span class="keyword">imports</span></span> <a href="https://www.cl.cam.ac.uk/research/hvg/Isabelle/dist/library/HOL/HOL/Main.html">Main</a> <span class="keyword2"><span class="keyword">begin</span></span> 

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Type Environments›</span></span>
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Some basic properties of our variable environments.›</span></span>

<span class="comment1">(* We use a wrapped map and an error element *)</span>
<span class="keyword1"><span class="command">datatype</span></span> <span class="tfree">'a</span> environment <span class="main">=</span> 
  Env <span class="quoted"><span class="quoted">"<span class="main">(</span>string <span class="main">⇀</span> <span class="tfree">'a</span><span class="main">)</span>"</span></span>
<span class="main">|</span> Malformed

<span class="comment1">(* Adding an entry to an environment. Overwriting an entry switches to the error state*)</span>
<span class="keyword1"><span class="command">primrec</span></span>
  <span class="entity">add</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> environment<span class="main">)</span> <span class="main">⇒</span> string <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> environment"</span></span>    
  <span class="main">(</span><span class="quoted">"_<span class="keyword1">⦇</span>_<span class="keyword1">:</span>_<span class="keyword1">⦈</span>"</span> <span class="main">[</span>90<span class="main">,</span> 0<span class="main">,</span> 0<span class="main">]</span> 91<span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span>
  add_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Env <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span><span class="main"><span class="free">⦇</span></span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main"><span class="free">:</span></span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main"><span class="free">⦈</span></span> <span class="main">=</span> 
     <span class="main">(</span><span class="keyword1">if</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">∉</span> dom <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="keyword1">then</span> <span class="main">(</span>Env <span class="main">(</span><span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">↦</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">else</span> Malformed<span class="main">)</span>"</span></span> 
<span class="main">|</span> add_mal<span class="main">:</span> <span class="quoted"><span class="quoted">"Malformed<span class="main"><span class="free">⦇</span></span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main"><span class="free">:</span></span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main"><span class="free">⦈</span></span> <span class="main">=</span> Malformed"</span></span>

<span class="comment1">(* domains of environments, i.e. the set of used variable names *)</span>
<span class="keyword1"><span class="command">primrec</span></span>
  <span class="entity">env_dom</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> environment<span class="main">)</span> <span class="main">⇒</span> string set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  env_dom_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">env_dom</span> <span class="main">(</span>Env <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="main">=</span> dom <span class="free"><span class="bound"><span class="entity">e</span></span></span>"</span></span> 
<span class="main">|</span> env_dom_mal<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">env_dom</span> <span class="main">(</span>Malformed<span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> 

<span class="comment1">(* Retrieving an entry from an environment *)</span>
<span class="keyword1"><span class="command">primrec</span></span>
  <span class="entity">env_get</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> environment<span class="main">)</span> <span class="main">⇒</span> string  <span class="main">⇒</span> <span class="tfree">'a</span> option"</span></span> <span class="main">(</span><span class="quoted">"_<span class="keyword1">!</span>_"</span><span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span>
  env_get_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">env_get</span> <span class="main">(</span>Env <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> "</span></span> 
<span class="main">|</span> env_get_mal<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">env_get</span> <span class="main">(</span>Malformed<span class="main">)</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> None "</span></span> 

<span class="comment1">(* Environment well-formedness. For now weaker than usually recommended for LN; just finiteness and not being the error value *)</span>
<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">ok</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> environment<span class="main">)</span> <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  OK_Env <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ok</span> <span class="main">(</span>Env <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>finite <span class="main">(</span>dom <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> OK_Mal <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ok</span> Malformed <span class="main">=</span> False"</span></span>

<span class="comment1">(* commutativity of add *)</span>
<span class="keyword1" id="Environments-subst_add"><span class="command">lemma</span></span> subst_add<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">x</span> <span class="free">y</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≠</span> <span class="free">y</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">e</span><span class="main">⦇</span><span class="free">x</span><span class="main">:</span><span class="free">a</span><span class="main">⦈</span><span class="main">⦇</span><span class="free">y</span><span class="main">:</span><span class="free">b</span><span class="main">⦈</span> <span class="main">=</span> <span class="free">e</span><span class="main">⦇</span><span class="free">y</span><span class="main">:</span><span class="free">b</span><span class="main">⦈</span><span class="main">⦇</span><span class="free">x</span><span class="main">:</span><span class="free">a</span><span class="main">⦈</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">e</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Malformed <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Env <span class="skolem">f</span><span class="main">)</span> <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> dom <span class="skolem">f</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> False <span class="keyword1"><span class="command">with</span></span> assms Env <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∈</span> dom <span class="skolem">f</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> ext<span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">xa</span> <span class="main">::</span> <span class="quoted">string</span>
      <span class="keyword3"><span class="command">case</span></span> False <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">f</span><span class="main">(</span><span class="free">x</span> <span class="main">↦</span> <span class="free">a</span><span class="main">,</span><span class="free">y</span> <span class="main">↦</span> <span class="free">b</span><span class="main">)</span><span class="main">)</span> <span class="skolem">xa</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">f</span><span class="main">(</span><span class="free">y</span> <span class="main">↦</span> <span class="free">b</span><span class="main">,</span><span class="free">x</span> <span class="main">↦</span> <span class="free">a</span><span class="main">)</span><span class="main">)</span> <span class="skolem">xa</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">xa</span> <span class="main">=</span> <span class="free">x</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> False <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">xa</span> <span class="main">=</span> <span class="free">y</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(* A well-formed environment is finite *)</span>
<span class="keyword1" id="Environments-ok_finite"><span class="command">lemma</span></span> ok_finite<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"ok <span class="free">e</span> <span class="main">⟹</span> finite <span class="main">(</span>env_dom <span class="free">e</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">e</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>

<span class="comment1">(* A well-formed environment is not malformed *)</span>
<span class="keyword1" id="Environments-ok_ok"><span class="command">lemma</span></span> ok_ok<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"ok <span class="free">e</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">x</span><span class="main">.</span> <span class="free">e</span> <span class="main">=</span> <span class="main">(</span>Env <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">e</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>

<span class="comment1">(* If something is in the set of variable names, then it has a value assigned to it *)</span>
<span class="keyword1" id="Environments-env_defined"><span class="command">lemma</span></span> env_defined<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">x</span> <span class="main">::</span> <span class="quoted">string</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">e</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> environment"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> env_dom <span class="free">e</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">T</span> <span class="main">.</span> <span class="free">e</span><span class="main">!</span><span class="free">x</span> <span class="main">=</span> Some <span class="bound">T</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">e</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Malformed <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> <span class="comment1">(* contradiction *)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> Env <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">force</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(* adding of new elements does not remove elements *)</span>
<span class="keyword1" id="Environments-env_bigger"><span class="command">lemma</span></span> env_bigger<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">a</span> <span class="main">∉</span> env_dom <span class="free">e</span><span class="main">;</span> <span class="free">x</span> <span class="main">∈</span> <span class="main">(</span>env_dom <span class="free">e</span><span class="main">)</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">∈</span> env_dom <span class="main">(</span><span class="free">e</span><span class="main">⦇</span><span class="free">a</span><span class="main">:</span><span class="free">X</span><span class="main">⦈</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">e</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>

<span class="comment1">(* Added for convenience *)</span>
<span class="keyword1" id="Environments-env_bigger2"><span class="command">lemma</span></span> env_bigger2<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">a</span> <span class="main">∉</span> env_dom <span class="free">e</span><span class="main">;</span> <span class="free">b</span> <span class="main">∉</span> <span class="main">(</span>env_dom <span class="free">e</span><span class="main">)</span><span class="main">;</span> <span class="free">x</span> <span class="main">∈</span> <span class="main">(</span>env_dom <span class="free">e</span><span class="main">)</span><span class="main">;</span> <span class="free">a</span> <span class="main">≠</span> <span class="free">b</span> <span class="main">⟧</span> 
  <span class="main">⟹</span> <span class="free">x</span> <span class="main">∈</span> env_dom <span class="main">(</span><span class="free">e</span><span class="main">⦇</span><span class="free">a</span><span class="main">:</span><span class="free">X</span><span class="main">⦈</span><span class="main">⦇</span><span class="free">b</span><span class="main">:</span><span class="free">Y</span><span class="main">⦈</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">e</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>

<span class="comment1">(* If there is an entry, then the environment is sane. *)</span>
<span class="keyword1" id="Environments-not_malformed"><span class="command">lemma</span></span> not_malformed<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="main">(</span>env_dom <span class="free">e</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">fun</span><span class="main">.</span> <span class="free">e</span> <span class="main">=</span> Env <span class="bound">fun</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">e</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>

<span class="comment1">(* Smaller environments are well formed. *)</span>
<span class="keyword1" id="Environments-not_malformed_smaller"><span class="command">lemma</span></span> not_malformed_smaller<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">e</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> environment"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">a</span> <span class="main">::</span> <span class="quoted">string</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">X</span> <span class="main">::</span> <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"ok <span class="main">(</span><span class="free">e</span><span class="main">⦇</span><span class="free">a</span><span class="main">:</span><span class="free">X</span><span class="main">⦈</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"ok <span class="free">e</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">e</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Malformed <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> <span class="comment1">(* contradiction *)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Env <span class="skolem">f</span><span class="main">)</span> <span class="keyword1"><span class="command">with</span></span> ok_finite<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∉</span> dom <span class="skolem">f</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(* Elements not in a bigger environment are not in a smaller one either *)</span>
<span class="keyword1" id="Environments-not_in_smaller"><span class="command">lemma</span></span> not_in_smaller<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">e</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> environment"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">a</span> <span class="main">::</span> <span class="quoted">string</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">X</span> <span class="main">::</span> <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"ok <span class="main">(</span><span class="free">e</span><span class="main">⦇</span><span class="free">a</span><span class="main">:</span><span class="free">X</span><span class="main">⦈</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∉</span> env_dom <span class="free">e</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">e</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Malformed <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Env <span class="skolem">f</span><span class="main">)</span> <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∉</span> dom <span class="skolem">f</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(* A variable that got added is in the environment *)</span>
<span class="keyword1" id="Environments-in_add"><span class="command">lemma</span></span> in_add<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">e</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> environment"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">a</span> <span class="main">::</span> <span class="quoted">string</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">X</span> <span class="main">::</span> <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"ok <span class="main">(</span><span class="free">e</span><span class="main">⦇</span><span class="free">a</span><span class="main">:</span><span class="free">X</span><span class="main">⦈</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> env_dom <span class="main">(</span><span class="free">e</span><span class="main">⦇</span><span class="free">a</span><span class="main">:</span><span class="free">X</span><span class="main">⦈</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">e</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Malformed <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> <span class="comment1">(* contradiction *)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Env <span class="skolem">f</span><span class="main">)</span> <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∉</span> dom <span class="skolem">f</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(* Similar to subst_add, but using a more convenient premise *)</span>
<span class="keyword1" id="Environments-ok_add_reverse"><span class="command">lemma</span></span> ok_add_reverse<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> 
  <span class="free">e</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> environment"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">a</span> <span class="main">::</span> <span class="quoted">string</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">X</span> <span class="main">::</span> <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span> <span class="keyword2"><span class="keyword">and</span></span> 
  <span class="free">b</span> <span class="main">::</span> <span class="quoted">string</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">Y</span> <span class="main">::</span> <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"ok <span class="main">(</span><span class="free">e</span><span class="main">⦇</span><span class="free">a</span><span class="main">:</span><span class="free">X</span><span class="main">⦈</span><span class="main">⦇</span><span class="free">b</span><span class="main">:</span><span class="free">Y</span><span class="main">⦈</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">e</span><span class="main">⦇</span><span class="free">b</span><span class="main">:</span><span class="free">Y</span><span class="main">⦈</span><span class="main">⦇</span><span class="free">a</span><span class="main">:</span><span class="free">X</span><span class="main">⦈</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">e</span><span class="main">⦇</span><span class="free">a</span><span class="main">:</span><span class="free">X</span><span class="main">⦈</span><span class="main">⦇</span><span class="free">b</span><span class="main">:</span><span class="free">Y</span><span class="main">⦈</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">e</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Malformed <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> <span class="comment1">(* contradiction *)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Env <span class="skolem">f</span><span class="main">)</span> 
  <span class="keyword1"><span class="command">with</span></span> 
    not_in_smaller<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹ok <span class="main">(</span><span class="free">e</span><span class="main">⦇</span><span class="free">a</span><span class="main">:</span><span class="free">X</span><span class="main">⦈</span><span class="main">⦇</span><span class="free">b</span><span class="main">:</span><span class="free">Y</span><span class="main">⦈</span><span class="main">)</span>›</span></span><span class="main">]</span> in_add<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span>
    not_in_smaller<span class="main">[</span><span class="operator">OF</span> not_malformed_smaller<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">]</span></span><span class="main">]</span> 
    in_add<span class="main">[</span><span class="operator">OF</span> not_malformed_smaller<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">]</span></span><span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> conjI impI<span class="main"><span class="keyword3">,</span></span> <span class="operator">elim</span> conjE<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fun_upd_twist<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Environments-not_in_env_bigger"><span class="command">lemma</span></span> not_in_env_bigger<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">e</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> environment"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">a</span> <span class="main">::</span> <span class="quoted">string</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">X</span> <span class="main">::</span> <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">x</span> <span class="main">::</span> <span class="quoted">string</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> <span class="main">(</span>env_dom <span class="free">e</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≠</span> <span class="free">a</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> env_dom <span class="main">(</span><span class="free">e</span><span class="main">⦇</span><span class="free">a</span><span class="main">:</span><span class="free">X</span><span class="main">⦈</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">e</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Malformed <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Env <span class="skolem">f</span><span class="main">)</span> <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∉</span> dom <span class="skolem">f</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Environments-not_in_env_bigger_2"><span class="command">lemma</span></span> not_in_env_bigger_2<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> 
  <span class="free">e</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> environment"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">a</span> <span class="main">::</span> <span class="quoted">string</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">X</span> <span class="main">::</span> <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span> <span class="keyword2"><span class="keyword">and</span></span> 
  <span class="free">b</span> <span class="main">::</span> <span class="quoted">string</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">Y</span> <span class="main">::</span> <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">x</span> <span class="main">::</span> <span class="quoted">string</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> <span class="main">(</span>env_dom <span class="free">e</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≠</span> <span class="free">a</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≠</span> <span class="free">b</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> env_dom <span class="main">(</span><span class="free">e</span><span class="main">⦇</span><span class="free">a</span><span class="main">:</span><span class="free">X</span><span class="main">⦈</span><span class="main">⦇</span><span class="free">b</span><span class="main">:</span><span class="free">Y</span><span class="main">⦈</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">e</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Malformed <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Env <span class="skolem">f</span><span class="main">)</span> <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∉</span> dom <span class="skolem">f</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Environments-not_in_env_smaller"><span class="command">lemma</span></span> not_in_env_smaller<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">e</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> environment"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">a</span> <span class="main">::</span> <span class="quoted">string</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">X</span> <span class="main">::</span> <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">x</span> <span class="main">::</span> <span class="quoted">string</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> <span class="main">(</span>env_dom <span class="main">(</span><span class="free">e</span><span class="main">⦇</span><span class="free">a</span><span class="main">:</span><span class="free">X</span><span class="main">⦈</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≠</span> <span class="free">a</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"ok <span class="main">(</span><span class="free">e</span><span class="main">⦇</span><span class="free">a</span><span class="main">:</span><span class="free">X</span><span class="main">⦈</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> env_dom <span class="free">e</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">e</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Malformed <span class="keyword1"><span class="command">with</span></span> assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> <span class="comment1">(* contradiction *)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Env <span class="skolem">f</span><span class="main">)</span> <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∉</span> dom <span class="skolem">f</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(* Conditions derivable from the well-formedness *)</span>
<span class="keyword1" id="Environments-ok_add_2"><span class="command">lemma</span></span> ok_add_2<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> 
  <span class="free">e</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> environment"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">a</span> <span class="main">::</span> <span class="quoted">string</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">X</span> <span class="main">::</span> <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span> <span class="keyword2"><span class="keyword">and</span></span> 
  <span class="free">b</span> <span class="main">::</span> <span class="quoted">string</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">Y</span> <span class="main">::</span> <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"ok <span class="main">(</span><span class="free">e</span><span class="main">⦇</span><span class="free">a</span><span class="main">:</span><span class="free">X</span><span class="main">⦈</span><span class="main">⦇</span><span class="free">b</span><span class="main">:</span><span class="free">Y</span><span class="main">⦈</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"ok <span class="free">e</span> <span class="main">∧</span> <span class="free">a</span> <span class="main">∉</span> env_dom <span class="free">e</span> <span class="main">∧</span> <span class="free">b</span> <span class="main">∉</span> env_dom <span class="free">e</span> <span class="main">∧</span> <span class="free">a</span> <span class="main">≠</span> <span class="free">b</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"ok <span class="main">(</span><span class="free">e</span><span class="main">⦇</span><span class="free">b</span><span class="main">:</span><span class="free">X</span><span class="main">⦈</span><span class="main">⦇</span><span class="free">b</span><span class="main">:</span><span class="free">Y</span><span class="main">⦈</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">from</span></span> not_in_smaller<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> in_add<span class="main">[</span><span class="operator">OF</span> not_malformed_smaller<span class="main"><span class="main">[</span></span><span class="operator">OF</span> this<span class="main"><span class="main">]</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">≠</span> <span class="free">b</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">from</span></span> assms ok_add_reverse<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ok <span class="main">(</span><span class="free">e</span><span class="main">⦇</span><span class="free">b</span><span class="main">:</span><span class="free">Y</span><span class="main">⦈</span><span class="main">⦇</span><span class="free">a</span><span class="main">:</span><span class="free">X</span><span class="main">⦈</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">note</span></span> not_in_smaller<span class="main">[</span><span class="operator">OF</span> not_malformed_smaller<span class="main"><span class="main">[</span></span><span class="operator">OF</span> this<span class="main"><span class="main">]</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
    <span class="keyword1"><span class="command">using</span></span> 
      not_malformed_smaller<span class="main">[</span><span class="operator">OF</span> not_malformed_smaller<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">]</span></span><span class="main">]</span>
      not_in_smaller<span class="main">[</span><span class="operator">OF</span> not_malformed_smaller<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">]</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(* A variable that got added is in the environment *)</span>
<span class="keyword1" id="Environments-in_add_2"><span class="command">lemma</span></span> in_add_2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> 
  <span class="free">e</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> environment"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">a</span> <span class="main">::</span> <span class="quoted">string</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">X</span> <span class="main">::</span> <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span> <span class="keyword2"><span class="keyword">and</span></span> 
  <span class="free">b</span> <span class="main">::</span> <span class="quoted">string</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">Y</span> <span class="main">::</span> <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"ok <span class="main">(</span><span class="free">e</span><span class="main">⦇</span><span class="free">a</span><span class="main">:</span><span class="free">X</span><span class="main">⦈</span><span class="main">⦇</span><span class="free">b</span><span class="main">:</span><span class="free">Y</span><span class="main">⦈</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> env_dom <span class="main">(</span><span class="free">e</span><span class="main">⦇</span><span class="free">a</span><span class="main">:</span><span class="free">X</span><span class="main">⦈</span><span class="main">⦇</span><span class="free">b</span><span class="main">:</span><span class="free">Y</span><span class="main">⦈</span><span class="main">)</span> <span class="main">∧</span> <span class="free">b</span> <span class="main">∈</span> env_dom <span class="main">(</span><span class="free">e</span><span class="main">⦇</span><span class="free">a</span><span class="main">:</span><span class="free">X</span><span class="main">⦈</span><span class="main">⦇</span><span class="free">b</span><span class="main">:</span><span class="free">Y</span><span class="main">⦈</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> ok_add_2<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">elim</span> conjE<span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> conjI<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">e</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(* Convenience version *)</span>
<span class="keyword1" id="Environments-ok_add_3"><span class="command">lemma</span></span> ok_add_3<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> 
  <span class="free">e</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> environment"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">a</span> <span class="main">::</span> <span class="quoted">string</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">X</span> <span class="main">::</span> <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span> <span class="keyword2"><span class="keyword">and</span></span> 
  <span class="free">b</span> <span class="main">::</span> <span class="quoted">string</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">Y</span> <span class="main">::</span> <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">c</span> <span class="main">::</span> <span class="quoted">string</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">Z</span> <span class="main">::</span> <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"ok <span class="main">(</span><span class="free">e</span><span class="main">⦇</span><span class="free">a</span><span class="main">:</span><span class="free">X</span><span class="main">⦈</span><span class="main">⦇</span><span class="free">b</span><span class="main">:</span><span class="free">Y</span><span class="main">⦈</span><span class="main">⦇</span><span class="free">c</span><span class="main">:</span><span class="free">Z</span><span class="main">⦈</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∉</span> env_dom <span class="free">e</span> <span class="main">∧</span> <span class="free">b</span> <span class="main">∉</span> env_dom <span class="free">e</span> <span class="main">∧</span> <span class="free">c</span> <span class="main">∉</span> env_dom <span class="free">e</span> <span class="main">∧</span> <span class="free">a</span> <span class="main">≠</span> <span class="free">b</span> <span class="main">∧</span> <span class="free">b</span> <span class="main">≠</span> <span class="free">c</span> <span class="main">∧</span> <span class="free">a</span> <span class="main">≠</span> <span class="free">c</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"ok <span class="main">(</span><span class="free">e</span><span class="main">⦇</span><span class="free">a</span><span class="main">:</span><span class="free">X</span><span class="main">⦈</span><span class="main">⦇</span><span class="free">c</span><span class="main">:</span><span class="free">Y</span><span class="main">⦈</span><span class="main">⦇</span><span class="free">c</span><span class="main">:</span><span class="free">Z</span><span class="main">⦈</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">from</span></span> not_in_smaller<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> in_add<span class="main">[</span><span class="operator">OF</span> not_malformed_smaller<span class="main"><span class="main">[</span></span><span class="operator">OF</span> this<span class="main"><span class="main">]</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">≠</span> <span class="free">c</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">from</span></span> assms ok_add_reverse<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ok <span class="main">(</span><span class="free">e</span><span class="main">⦇</span><span class="free">a</span><span class="main">:</span><span class="free">X</span><span class="main">⦈</span><span class="main">⦇</span><span class="free">c</span><span class="main">:</span><span class="free">Z</span><span class="main">⦈</span><span class="main">⦇</span><span class="free">b</span><span class="main">:</span><span class="free">Y</span><span class="main">⦈</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">note</span></span> ok_add_2<span class="main">[</span><span class="operator">OF</span> not_malformed_smaller<span class="main"><span class="main">[</span></span><span class="operator">OF</span> this<span class="main"><span class="main">]</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> ok_add_2<span class="main">[</span><span class="operator">OF</span> not_malformed_smaller<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">]</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Environments-in_env_smaller"><span class="command">lemma</span></span> in_env_smaller<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">e</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> environment"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">a</span> <span class="main">::</span> <span class="quoted">string</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">X</span> <span class="main">::</span> <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">x</span> <span class="main">::</span> <span class="quoted">string</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="main">(</span>env_dom <span class="main">(</span><span class="free">e</span><span class="main">⦇</span><span class="free">a</span><span class="main">:</span><span class="free">X</span><span class="main">⦈</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≠</span> <span class="free">a</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> env_dom <span class="free">e</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> not_malformed<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">f</span></span> <span class="keyword2"><span class="keyword">where</span></span> f<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">e</span><span class="main">⦇</span><span class="free">a</span><span class="main">:</span><span class="free">X</span><span class="main">⦈</span> <span class="main">=</span> Env <span class="skolem">f</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">e</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> Malformed <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="free">e</span><span class="main">⦇</span><span class="free">a</span><span class="main">:</span><span class="free">X</span><span class="main">⦈</span> <span class="main">=</span> Env <span class="skolem">f</span>›</span></span> 
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Env <span class="skolem">f'</span><span class="main">)</span> <span class="keyword1"><span class="command">with</span></span> assms f <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> dom <span class="skolem">f'</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">force</span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Environments-in_env_smaller2"><span class="command">lemma</span></span> in_env_smaller2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> 
  <span class="free">e</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> environment"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">a</span> <span class="main">::</span> <span class="quoted">string</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">X</span> <span class="main">::</span> <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span> <span class="keyword2"><span class="keyword">and</span></span> 
  <span class="free">b</span> <span class="main">::</span> <span class="quoted">string</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">Y</span> <span class="main">::</span> <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">x</span> <span class="main">::</span> <span class="quoted">string</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="main">(</span>env_dom <span class="main">(</span><span class="free">e</span><span class="main">⦇</span><span class="free">a</span><span class="main">:</span><span class="free">X</span><span class="main">⦈</span><span class="main">⦇</span><span class="free">b</span><span class="main">:</span><span class="free">Y</span><span class="main">⦈</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≠</span> <span class="free">a</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≠</span> <span class="free">b</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> env_dom <span class="free">e</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> in_env_smaller<span class="main"><span class="main">[</span></span><span class="operator">OF</span> in_env_smaller<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">)</span></span></span> assms<span class="main"><span class="main"><span class="main">(</span></span></span>3<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main"><span class="main">]</span></span></span> assms<span class="main"><span class="main"><span class="main">(</span></span></span>2<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1" id="Environments-get_env_bigger"><span class="command">lemma</span></span> get_env_bigger<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">e</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> environment"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">a</span> <span class="main">::</span> <span class="quoted">string</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">X</span> <span class="main">::</span> <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">x</span> <span class="main">::</span> <span class="quoted">string</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="main">(</span>env_dom <span class="main">(</span><span class="free">e</span><span class="main">⦇</span><span class="free">a</span><span class="main">:</span><span class="free">X</span><span class="main">⦈</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≠</span> <span class="free">a</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">e</span><span class="main">!</span><span class="free">x</span> <span class="main">=</span> <span class="free">e</span><span class="main">⦇</span><span class="free">a</span><span class="main">:</span><span class="free">X</span><span class="main">⦈</span><span class="main">!</span><span class="free">x</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> not_malformed<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">f</span></span> <span class="keyword2"><span class="keyword">where</span></span> f<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">e</span><span class="main">⦇</span><span class="free">a</span><span class="main">:</span><span class="free">X</span><span class="main">⦈</span> <span class="main">=</span> Env <span class="skolem">f</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">e</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> Malformed <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="free">e</span><span class="main">⦇</span><span class="free">a</span><span class="main">:</span><span class="free">X</span><span class="main">⦈</span> <span class="main">=</span> Env <span class="skolem">f</span>›</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> <span class="comment1">(* contradiction *)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Env <span class="skolem">f'</span><span class="main">)</span> <span class="keyword1"><span class="command">with</span></span> assms f <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∉</span> dom <span class="skolem">f'</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Environments-get_env_bigger2"><span class="command">lemma</span></span> get_env_bigger2<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> 
  <span class="free">e</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> environment"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">a</span> <span class="main">::</span> <span class="quoted">string</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">X</span> <span class="main">::</span> <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span> <span class="keyword2"><span class="keyword">and</span></span> 
  <span class="free">b</span> <span class="main">::</span> <span class="quoted">string</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">Y</span> <span class="main">::</span> <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">x</span> <span class="main">::</span> <span class="quoted">string</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="main">(</span>env_dom <span class="main">(</span><span class="free">e</span><span class="main">⦇</span><span class="free">a</span><span class="main">:</span><span class="free">X</span><span class="main">⦈</span><span class="main">⦇</span><span class="free">b</span><span class="main">:</span><span class="free">Y</span><span class="main">⦈</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≠</span> <span class="free">a</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≠</span> <span class="free">b</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">e</span><span class="main">!</span><span class="free">x</span> <span class="main">=</span> <span class="free">e</span><span class="main">⦇</span><span class="free">a</span><span class="main">:</span><span class="free">X</span><span class="main">⦈</span><span class="main">⦇</span><span class="free">b</span><span class="main">:</span><span class="free">Y</span><span class="main">⦈</span><span class="main">!</span><span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> get_env_bigger<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">)</span></span></span> assms<span class="main"><span class="main"><span class="main">(</span></span></span>3<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main">]</span></span>
                get_env_bigger<span class="main"><span class="main">[</span></span><span class="operator">OF</span> in_env_smaller<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">)</span></span></span> assms<span class="main"><span class="main"><span class="main">(</span></span></span>3<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main"><span class="main">]</span></span></span> assms<span class="main"><span class="main"><span class="main">(</span></span></span>2<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1" id="Environments-get_env_smaller"><span class="command">lemma</span></span> get_env_smaller<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">x</span> <span class="main">∈</span> env_dom <span class="free">e</span><span class="main">;</span> <span class="free">a</span> <span class="main">∉</span> env_dom <span class="free">e</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">e</span><span class="main">⦇</span><span class="free">a</span><span class="main">:</span><span class="free">X</span><span class="main">⦈</span><span class="main">!</span><span class="free">x</span> <span class="main">=</span> <span class="free">e</span><span class="main">!</span><span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">e</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="Environments-get_env_smaller2"><span class="command">lemma</span></span> get_env_smaller2<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">x</span> <span class="main">∈</span> env_dom <span class="free">e</span><span class="main">;</span> <span class="free">a</span> <span class="main">∉</span> env_dom <span class="free">e</span><span class="main">;</span> <span class="free">b</span> <span class="main">∉</span> env_dom <span class="free">e</span><span class="main">;</span> <span class="free">a</span> <span class="main">≠</span> <span class="free">b</span> <span class="main">⟧</span> 
  <span class="main">⟹</span> <span class="free">e</span><span class="main">⦇</span><span class="free">a</span><span class="main">:</span><span class="free">X</span><span class="main">⦈</span><span class="main">⦇</span><span class="free">b</span><span class="main">:</span><span class="free">Y</span><span class="main">⦈</span><span class="main">!</span><span class="free">x</span> <span class="main">=</span> <span class="free">e</span><span class="main">!</span><span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">e</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="Environments-add_get_eq"><span class="command">lemma</span></span> add_get_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">xa</span> <span class="main">∉</span> env_dom <span class="free">e</span><span class="main">;</span> ok <span class="free">e</span><span class="main">;</span> the <span class="free">e</span><span class="main">⦇</span><span class="free">xa</span><span class="main">:</span><span class="free">U</span><span class="main">⦈</span><span class="main">!</span><span class="free">xa</span> <span class="main">=</span> <span class="free">T</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">U</span> <span class="main">=</span> <span class="free">T</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">e</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="Environments-add_get"><span class="command">lemma</span></span> add_get<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">xa</span> <span class="main">∉</span> env_dom <span class="free">e</span><span class="main">;</span> ok <span class="free">e</span> <span class="main">⟧</span> <span class="main">⟹</span> the <span class="free">e</span><span class="main">⦇</span><span class="free">xa</span><span class="main">:</span><span class="free">U</span><span class="main">⦈</span><span class="main">!</span><span class="free">xa</span> <span class="main">=</span> <span class="free">U</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">e</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="Environments-add_get2_1"><span class="command">lemma</span></span> add_get2_1<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">e</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> environment"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">x</span> <span class="main">::</span> <span class="quoted">string</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">A</span> <span class="main">::</span> <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">y</span> <span class="main">::</span> <span class="quoted">string</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">B</span> <span class="main">::</span> <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"ok <span class="main">(</span><span class="free">e</span><span class="main">⦇</span><span class="free">x</span><span class="main">:</span><span class="free">A</span><span class="main">⦈</span><span class="main">⦇</span><span class="free">y</span><span class="main">:</span><span class="free">B</span><span class="main">⦈</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"the <span class="free">e</span><span class="main">⦇</span><span class="free">x</span><span class="main">:</span><span class="free">A</span><span class="main">⦈</span><span class="main">⦇</span><span class="free">y</span><span class="main">:</span><span class="free">B</span><span class="main">⦈</span><span class="main">!</span><span class="free">x</span> <span class="main">=</span> <span class="free">A</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> ok_add_2<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">e</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">elim</span> conjE<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Environments-add_get2_2"><span class="command">lemma</span></span> add_get2_2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">e</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> environment"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">x</span> <span class="main">::</span> <span class="quoted">string</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">A</span> <span class="main">::</span> <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">y</span> <span class="main">::</span> <span class="quoted">string</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">B</span> <span class="main">::</span> <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"ok <span class="main">(</span><span class="free">e</span><span class="main">⦇</span><span class="free">x</span><span class="main">:</span><span class="free">A</span><span class="main">⦈</span><span class="main">⦇</span><span class="free">y</span><span class="main">:</span><span class="free">B</span><span class="main">⦈</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"the <span class="free">e</span><span class="main">⦇</span><span class="free">x</span><span class="main">:</span><span class="free">A</span><span class="main">⦈</span><span class="main">⦇</span><span class="free">y</span><span class="main">:</span><span class="free">B</span><span class="main">⦈</span><span class="main">!</span><span class="free">y</span> <span class="main">=</span> <span class="free">B</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> ok_add_2<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">e</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">elim</span> conjE<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Environments-ok_add_ok"><span class="command">lemma</span></span> ok_add_ok<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> ok <span class="free">e</span><span class="main">;</span> <span class="free">x</span> <span class="main">∉</span> env_dom <span class="free">e</span> <span class="main">⟧</span> <span class="main">⟹</span> ok <span class="main">(</span><span class="free">e</span><span class="main">⦇</span><span class="free">x</span><span class="main">:</span><span class="free">X</span><span class="main">⦈</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">e</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="Environments-env_add_dom"><span class="command">lemma</span></span> env_add_dom<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">e</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> environment"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">x</span> <span class="main">::</span> <span class="quoted">string</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"ok <span class="free">e</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> env_dom <span class="free">e</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"env_dom <span class="main">(</span><span class="free">e</span><span class="main">⦇</span><span class="free">x</span><span class="main">:</span><span class="free">X</span><span class="main">⦈</span><span class="main">)</span> <span class="main">=</span> env_dom <span class="free">e</span> <span class="main">∪</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> in_add<span class="main"><span class="main">[</span></span><span class="operator">OF</span> ok_add_ok<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> ccontr<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">y</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> env_dom <span class="main">(</span><span class="free">e</span><span class="main">⦇</span><span class="free">x</span><span class="main">:</span><span class="free">X</span><span class="main">⦈</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∉</span> env_dom <span class="free">e</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">≠</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> in_env_smaller<span class="main">[</span><span class="operator">OF</span> this<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> this<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">]</span> this<span class="main">(</span>2<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">y</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> env_dom <span class="free">e</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> env_bigger<span class="main">[</span><span class="operator">OF</span> not_in_smaller<span class="main"><span class="main">[</span></span><span class="operator">OF</span> ok_add_ok<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span> this<span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> env_dom <span class="main">(</span><span class="free">e</span><span class="main">⦇</span><span class="free">x</span><span class="main">:</span><span class="free">X</span><span class="main">⦈</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">assumption</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Environments-env_add_dom_2"><span class="command">lemma</span></span> env_add_dom_2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">e</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> environment"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">x</span> <span class="main">::</span> <span class="quoted">string</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">y</span> <span class="main">::</span> <span class="quoted">string</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"ok <span class="free">e</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> env_dom <span class="free">e</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∉</span> env_dom <span class="free">e</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≠</span> <span class="free">y</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"env_dom <span class="main">(</span><span class="free">e</span><span class="main">⦇</span><span class="free">x</span><span class="main">:</span><span class="free">X</span><span class="main">⦈</span><span class="main">⦇</span><span class="free">y</span><span class="main">:</span><span class="free">Y</span><span class="main">⦈</span><span class="main">)</span> <span class="main">=</span> env_dom <span class="free">e</span> <span class="main">∪</span> <span class="main">{</span><span class="free">x</span><span class="main">,</span><span class="free">y</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> env_add_dom<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1-2<span class="main"><span class="main">)</span></span><span class="main">]</span> assms<span class="main">(</span>3-4<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∉</span> env_dom <span class="main">(</span><span class="free">e</span><span class="main">⦇</span><span class="free">x</span><span class="main">:</span><span class="free">X</span><span class="main">⦈</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> 
    env_add_dom<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1-2<span class="main"><span class="main">)</span></span><span class="main">]</span> 
    env_add_dom<span class="main">[</span><span class="operator">OF</span> ok_add_ok<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1-2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span> this<span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">fun</span></span>
   <span class="entity">env_app</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> environment<span class="main">)</span> <span class="main">⇒</span>  <span class="main">(</span><span class="tfree">'a</span> environment<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> environment<span class="main">)</span>"</span></span> <span class="main">(</span><span class="quoted">"_<span class="keyword1">+</span>_"</span><span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">env_app</span> <span class="main">(</span>Env <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="main">(</span>Env <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="main">=</span> 
  <span class="main">(</span><span class="keyword1">if</span> <span class="main">(</span>ok <span class="main">(</span>Env <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="main">∧</span> ok <span class="main">(</span>Env <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="main">∧</span> env_dom <span class="main">(</span>Env <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="main">∩</span> env_dom <span class="main">(</span>Env <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span><span class="main">)</span> 
   <span class="keyword1">then</span>  Env <span class="main">(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">++</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="keyword1">else</span> Malformed <span class="main">)</span>"</span></span>

<span class="keyword1" id="Environments-env_app_dom"><span class="command">lemma</span></span> env_app_dom<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">e1</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> environment"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">e2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> environment"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"ok <span class="free">e1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"env_dom <span class="free">e1</span> <span class="main">∩</span> env_dom <span class="free">e2</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"ok <span class="free">e2</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"env_dom <span class="main">(</span><span class="free">e1</span><span class="main">+</span><span class="free">e2</span><span class="main">)</span> <span class="main">=</span> env_dom <span class="free">e1</span> <span class="main">∪</span> env_dom <span class="free">e2</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> ok_ok<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹ok <span class="free">e1</span>›</span></span><span class="main">]</span> ok_ok<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹ok <span class="free">e2</span>›</span></span><span class="main">]</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">f1</span></span> <span class="skolem"><span class="skolem">f2</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">e1</span> <span class="main">=</span> Env <span class="skolem">f1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">e2</span> <span class="main">=</span> Env <span class="skolem">f2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> assms<span class="main">(</span>2<span class="main">)</span> ok_finite<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹ok <span class="free">e1</span>›</span></span><span class="main">]</span> ok_finite<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹ok <span class="free">e2</span>›</span></span><span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Environments-env_app_same"><span class="command">lemma</span></span> env_app_same<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">e1</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> environment"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">e2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> environment"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">x</span> <span class="main">::</span> <span class="quoted">string</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> 
  <span class="quoted"><span class="quoted">"ok <span class="free">e1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> env_dom <span class="free">e1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 
  <span class="quoted"><span class="quoted">"env_dom <span class="free">e1</span> <span class="main">∩</span> env_dom <span class="free">e2</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"ok <span class="free">e2</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"the <span class="main">(</span><span class="free">e1</span><span class="main">+</span><span class="free">e2</span><span class="main">!</span><span class="free">x</span><span class="main">)</span> <span class="main">=</span> the <span class="free">e1</span><span class="main">!</span><span class="free">x</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> ok_ok<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹ok <span class="free">e1</span>›</span></span><span class="main">]</span> ok_ok<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹ok <span class="free">e2</span>›</span></span><span class="main">]</span> 
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">f1</span></span> <span class="skolem"><span class="skolem">f2</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">e1</span> <span class="main">=</span> Env <span class="skolem">f1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">e2</span> <span class="main">=</span> Env <span class="skolem">f2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> assms<span class="main">(</span>2-3<span class="main">)</span> ok_finite<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹ok <span class="free">e1</span>›</span></span><span class="main">]</span> ok_finite<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹ok <span class="free">e2</span>›</span></span><span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span> 
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">y</span> <span class="main">::</span> <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"dom <span class="skolem">f1</span> <span class="main">∩</span> dom <span class="skolem">f2</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f1</span> <span class="free">x</span> <span class="main">=</span> Some <span class="skolem">y</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> map_add_comm<span class="main">[</span><span class="operator">OF</span> this<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> this<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">f1</span> <span class="main">++</span> <span class="skolem">f2</span><span class="main">)</span> <span class="free">x</span> <span class="main">=</span> Some <span class="skolem">y</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_add_Some_iff<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"the <span class="main">(</span><span class="main">(</span><span class="skolem">f1</span> <span class="main">++</span> <span class="skolem">f2</span><span class="main">)</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Environments-env_app_ok"><span class="command">lemma</span></span> env_app_ok<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">e1</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> environment"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">e2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> environment"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"ok <span class="free">e1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"env_dom <span class="free">e1</span> <span class="main">∩</span> env_dom <span class="free">e2</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"ok <span class="free">e2</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"ok <span class="main">(</span><span class="free">e1</span><span class="main">+</span><span class="free">e2</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> ok_ok<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹ok <span class="free">e1</span>›</span></span><span class="main">]</span> ok_ok<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹ok <span class="free">e2</span>›</span></span><span class="main">]</span> 
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">f1</span></span> <span class="skolem"><span class="skolem">f2</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">e1</span> <span class="main">=</span> Env <span class="skolem">f1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">e2</span> <span class="main">=</span> Env <span class="skolem">f2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span><span class="operator">force</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Environments-env_app_add"><span class="command">lemma</span></span> env_app_add<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">e1</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> environment"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">e2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> environment"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">x</span> <span class="main">::</span> <span class="quoted">string</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> 
  <span class="quoted"><span class="quoted">"ok <span class="free">e1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"env_dom <span class="free">e1</span> <span class="main">∩</span> env_dom <span class="free">e2</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"ok <span class="free">e2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> env_dom <span class="free">e1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> env_dom <span class="free">e2</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">e1</span><span class="main">+</span><span class="free">e2</span><span class="main">)</span><span class="main">⦇</span><span class="free">x</span><span class="main">:</span><span class="free">X</span><span class="main">⦈</span> <span class="main">=</span> <span class="free">e1</span><span class="main">⦇</span><span class="free">x</span><span class="main">:</span><span class="free">X</span><span class="main">⦈</span><span class="main">+</span><span class="free">e2</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> ok_ok<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹ok <span class="free">e1</span>›</span></span><span class="main">]</span> ok_ok<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹ok <span class="free">e2</span>›</span></span><span class="main">]</span> 
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">f1</span></span> <span class="skolem"><span class="skolem">f2</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">e1</span> <span class="main">=</span> Env <span class="skolem">f1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">e2</span> <span class="main">=</span> Env <span class="skolem">f2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">clarify</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> impI ext<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">xa</span> <span class="main">::</span> <span class="quoted">string</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> dom <span class="skolem">f1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> dom <span class="skolem">f2</span>"</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="skolem">f1</span> <span class="main">++</span> <span class="skolem">f2</span><span class="main">)</span><span class="main">(</span><span class="free">x</span> <span class="main">↦</span> <span class="free">X</span><span class="main">)</span><span class="main">)</span> <span class="skolem">xa</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">f1</span><span class="main">(</span><span class="free">x</span> <span class="main">↦</span> <span class="free">X</span><span class="main">)</span> <span class="main">++</span> <span class="skolem">f2</span><span class="main">)</span> <span class="skolem">xa</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> <span class="skolem">xa</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> False <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">f1</span> <span class="main">++</span> <span class="skolem">f2</span><span class="main">)</span> <span class="skolem">xa</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">f1</span><span class="main">(</span><span class="free">x</span> <span class="main">↦</span> <span class="free">X</span><span class="main">)</span> <span class="main">++</span> <span class="skolem">f2</span><span class="main">)</span> <span class="skolem">xa</span>"</span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_add_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.split<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> True <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="free">x</span> <span class="main">∉</span> dom <span class="skolem">f1</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">x</span> <span class="main">∉</span> dom <span class="skolem">f2</span>›</span></span> 
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">f1</span><span class="main">(</span><span class="skolem">xa</span> <span class="main">↦</span> <span class="free">X</span><span class="main">)</span> <span class="main">++</span> <span class="skolem">f2</span><span class="main">)</span> <span class="skolem">xa</span> <span class="main">=</span> Some <span class="free">X</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> map_add_Some_iff<span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"Some <span class="free">X</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">f1</span><span class="main">(</span><span class="skolem">xa</span> <span class="main">↦</span> <span class="free">X</span><span class="main">)</span> <span class="main">++</span> <span class="skolem">f2</span><span class="main">)</span> <span class="skolem">xa</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Environments-env_app_add2"><span class="command">lemma</span></span> env_app_add2<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> 
  <span class="free">e1</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> environment"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">e2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> environment"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 
  <span class="free">x</span> <span class="main">::</span> <span class="quoted">string</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">y</span> <span class="main">::</span> <span class="quoted">string</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> 
  <span class="quoted"><span class="quoted">"ok <span class="free">e1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"env_dom <span class="free">e1</span> <span class="main">∩</span> env_dom <span class="free">e2</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"ok <span class="free">e2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> env_dom <span class="free">e1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> env_dom <span class="free">e2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∉</span> env_dom <span class="free">e1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∉</span> env_dom <span class="free">e2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≠</span> <span class="free">y</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">e1</span><span class="main">+</span><span class="free">e2</span><span class="main">)</span><span class="main">⦇</span><span class="free">x</span><span class="main">:</span><span class="free">X</span><span class="main">⦈</span><span class="main">⦇</span><span class="free">y</span><span class="main">:</span><span class="free">Y</span><span class="main">⦈</span> <span class="main">=</span> <span class="free">e1</span><span class="main">⦇</span><span class="free">x</span><span class="main">:</span><span class="free">X</span><span class="main">⦈</span><span class="main">⦇</span><span class="free">y</span><span class="main">:</span><span class="free">Y</span><span class="main">⦈</span><span class="main">+</span><span class="free">e2</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> ok_ok<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹ok <span class="free">e1</span>›</span></span><span class="main">]</span> ok_ok<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹ok <span class="free">e2</span>›</span></span><span class="main">]</span> 
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">f1</span></span> <span class="skolem"><span class="skolem">f2</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">e1</span> <span class="main">=</span> Env <span class="skolem">f1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">e2</span> <span class="main">=</span> Env <span class="skolem">f2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">clarify</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> impI ext<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">xa</span> <span class="main">::</span> <span class="quoted">string</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> dom <span class="skolem">f1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> dom <span class="skolem">f2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∉</span> dom <span class="skolem">f1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∉</span> dom <span class="skolem">f2</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="free">x</span> <span class="main">≠</span> <span class="free">y</span>›</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="skolem">f1</span> <span class="main">++</span> <span class="skolem">f2</span><span class="main">)</span><span class="main">(</span><span class="free">x</span> <span class="main">↦</span> <span class="free">X</span><span class="main">,</span> <span class="free">y</span> <span class="main">↦</span> <span class="free">Y</span><span class="main">)</span><span class="main">)</span> <span class="skolem">xa</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">f1</span><span class="main">(</span><span class="free">x</span> <span class="main">↦</span> <span class="free">X</span><span class="main">,</span> <span class="free">y</span> <span class="main">↦</span> <span class="free">Y</span><span class="main">)</span> <span class="main">++</span> <span class="skolem">f2</span><span class="main">)</span> <span class="skolem">xa</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> <span class="skolem">xa</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True 
      <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="free">x</span> <span class="main">≠</span> <span class="free">y</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">x</span> <span class="main">∉</span> dom <span class="skolem">f1</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">x</span> <span class="main">∉</span> dom <span class="skolem">f2</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">y</span> <span class="main">∉</span> dom <span class="skolem">f1</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">y</span> <span class="main">∉</span> dom <span class="skolem">f2</span>›</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">f1</span><span class="main">(</span><span class="skolem">xa</span> <span class="main">↦</span> <span class="free">X</span><span class="main">,</span><span class="free">y</span> <span class="main">↦</span> <span class="free">Y</span><span class="main">)</span> <span class="main">++</span> <span class="skolem">f2</span><span class="main">)</span> <span class="skolem">xa</span> <span class="main">=</span> Some <span class="free">X</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> map_add_Some_iff<span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"Some <span class="free">X</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">f1</span><span class="main">(</span><span class="skolem">xa</span> <span class="main">↦</span> <span class="free">X</span><span class="main">,</span><span class="free">y</span> <span class="main">↦</span> <span class="free">Y</span><span class="main">)</span> <span class="main">++</span> <span class="skolem">f2</span><span class="main">)</span> <span class="skolem">xa</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">=</span> <span class="skolem">xa</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> False <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="free">x</span> <span class="main">≠</span> <span class="skolem">xa</span>›</span></span> 
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">f1</span> <span class="main">++</span> <span class="skolem">f2</span><span class="main">)</span> <span class="skolem">xa</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">f1</span><span class="main">(</span><span class="free">x</span> <span class="main">↦</span> <span class="free">X</span><span class="main">,</span><span class="free">y</span> <span class="main">↦</span> <span class="free">Y</span><span class="main">)</span> <span class="main">++</span> <span class="skolem">f2</span><span class="main">)</span> <span class="skolem">xa</span>"</span></span> 
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_add_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.split<span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> True 
        <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="free">x</span> <span class="main">≠</span> <span class="free">y</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">x</span> <span class="main">∉</span> dom <span class="skolem">f1</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">x</span> <span class="main">∉</span> dom <span class="skolem">f2</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">y</span> <span class="main">∉</span> dom <span class="skolem">f1</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">y</span> <span class="main">∉</span> dom <span class="skolem">f2</span>›</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">f1</span><span class="main">(</span><span class="free">x</span> <span class="main">↦</span> <span class="free">X</span><span class="main">,</span><span class="skolem">xa</span> <span class="main">↦</span> <span class="free">Y</span><span class="main">)</span> <span class="main">++</span> <span class="skolem">f2</span><span class="main">)</span> <span class="skolem">xa</span> <span class="main">=</span> Some <span class="free">Y</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> map_add_Some_iff<span class="main">)</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"Some <span class="free">Y</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">f1</span><span class="main">(</span><span class="free">x</span> <span class="main">↦</span> <span class="free">X</span><span class="main">,</span> <span class="skolem">xa</span> <span class="main">↦</span> <span class="free">Y</span><span class="main">)</span> <span class="main">++</span> <span class="skolem">f2</span><span class="main">)</span> <span class="skolem">xa</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="TypedSigma">
<div class="head">
<h1>Theory TypedSigma</h1>
</div>
<pre class="source"><span class="comment1">(*  Title:      Sigma/Typed_Sigma.thy
    Author:     Florian Kammuller and Henry Sudhof, 2006
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹First Order Types for Sigma terms›</span></span>

<span class="keyword1"><span class="command">theory</span></span> TypedSigma <span class="keyword2"><span class="keyword">imports</span></span> <span class="quoted">"<a href="#Environments">../preliminary/Environments</a>"</span> <a href="#Sigma">Sigma</a> <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Types and typing rules›</span></span>
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹The inductive definition of the typing relation.›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">return</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>type <span class="main">×</span> type<span class="main">)</span> <span class="main">⇒</span> type"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">return</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">=</span> fst <span class="free"><span class="bound"><span class="entity">a</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">param</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>type <span class="main">×</span> type<span class="main">)</span> <span class="main">⇒</span> type"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">param</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">=</span> snd <span class="free"><span class="bound"><span class="entity">a</span></span></span>"</span></span>

<span class="keyword1"><span class="command">primrec</span></span>
  <span class="entity">do</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"type <span class="main">⇒</span> <span class="main">(</span>Label set<span class="main">)</span>"</span></span>  
<span class="keyword2"><span class="keyword">where</span></span>
 <span class="quoted"><span class="quoted">"<span class="free">do</span> <span class="main">(</span>Object <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>dom <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">primrec</span></span>
  <span class="entity">type_get</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"type <span class="main">⇒</span> Label <span class="main">⇒</span> <span class="main">(</span>type <span class="main">×</span> type<span class="main">)</span> option "</span></span>  <span class="main">(</span><span class="quoted">"_<span class="keyword1">^</span>_"</span> 1000<span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span>
 <span class="quoted"><span class="quoted">"<span class="main">(</span>Object <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span><span class="main"><span class="free">^</span></span><span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span>"</span></span>

  <span class="comment1">(* we need to restrict objects to ok environments, 
     as the empty object does not yield ok env otherwise *)</span>
<span class="keyword1"><span class="command">inductive</span></span> 
  <span class="entity">typing</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>type environment<span class="main">)</span> <span class="main">⇒</span> sterm <span class="main">⇒</span> type <span class="main">⇒</span> bool"</span></span>    
  <span class="main">(</span><span class="quoted">"_ <span class="keyword1">⊢</span> _ <span class="keyword1">:</span> _"</span> <span class="main">[</span>80<span class="main">,</span> 0<span class="main">,</span> 80<span class="main">]</span> 230<span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span> 
  T_Var<span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">⟦</span> ok <span class="free"><span class="bound"><span class="entity">env</span></span></span><span class="main">;</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">∈</span> env_dom <span class="free"><span class="bound"><span class="entity">env</span></span></span><span class="main">;</span> <span class="main">(</span>the <span class="main">(</span><span class="free"><span class="bound"><span class="entity">env</span></span></span><span class="main">!</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="main">⟧</span> 
    <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="main"><span class="free">⊢</span></span> <span class="main">(</span>Fvar <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main"><span class="free">:</span></span> <span class="free"><span class="bound"><span class="entity">T</span></span></span>"</span></span>
<span class="main">|</span> T_Obj<span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">⟦</span> ok <span class="free"><span class="bound"><span class="entity">env</span></span></span><span class="main">;</span> dom <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">=</span> do <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">;</span>  finite <span class="free"><span class="bound"><span class="entity">F</span></span></span><span class="main">;</span> 
       <span class="main">∀</span><span class="bound">l</span><span class="main">∈</span>do <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">.</span> <span class="main">∀</span><span class="bound">s</span> <span class="bound">p</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∉</span> <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="main">∧</span> <span class="bound">p</span> <span class="main">∉</span> <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="main">∧</span> <span class="bound">s</span> <span class="main">≠</span> <span class="bound">p</span> 
        <span class="main">⟶</span> <span class="free"><span class="bound"><span class="entity">env</span></span></span><span class="main">⦇</span><span class="bound">s</span><span class="main">:</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">⦈</span><span class="main">⦇</span><span class="bound">p</span><span class="main">:</span>param<span class="main">(</span>the <span class="main">(</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">^</span><span class="bound">l</span><span class="main">)</span><span class="main">)</span><span class="main">⦈</span> 
            <span class="main"><span class="free">⊢</span></span> <span class="main">(</span>the <span class="main">(</span><span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="bound">l</span><span class="main">)</span><span class="hidden">⇗</span><sup>[Fvar <span class="bound">s</span><span class="main">,</span>Fvar <span class="bound">p</span>]</sup><span class="hidden">⇖</span><span class="main">)</span> <span class="main"><span class="free">:</span></span> return<span class="main">(</span>the <span class="main">(</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">^</span><span class="bound">l</span><span class="main">)</span><span class="main">)</span> <span class="main">⟧</span> 
    <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="main"><span class="free">⊢</span></span> <span class="main">(</span>Obj <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span> <span class="main"><span class="free">:</span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span>"</span></span>
<span class="main">|</span> T_Upd<span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span>  
    <span class="quoted"><span class="quoted">"<span class="main">⟦</span> finite <span class="free"><span class="bound"><span class="entity">F</span></span></span><span class="main">;</span> 
       <span class="main">∀</span><span class="bound">s</span> <span class="bound">p</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∉</span> <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="main">∧</span> <span class="bound">p</span> <span class="main">∉</span> <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="main">∧</span> <span class="bound">s</span> <span class="main">≠</span> <span class="bound">p</span> 
        <span class="main">⟶</span>  <span class="free"><span class="bound"><span class="entity">env</span></span></span><span class="main">⦇</span><span class="bound">s</span><span class="main">:</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">⦈</span><span class="main">⦇</span><span class="bound">p</span><span class="main">:</span>param<span class="main">(</span>the <span class="main">(</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">^</span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">⦈</span>
             <span class="main"><span class="free">⊢</span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="hidden">⇗</span><sup>[Fvar <span class="bound">s</span><span class="main">,</span>Fvar <span class="bound">p</span>]</sup><span class="hidden">⇖</span><span class="main">)</span> <span class="main"><span class="free">:</span></span> return<span class="main">(</span>the <span class="main">(</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">^</span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
    <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main"><span class="free">:</span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">;</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">∈</span> do <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="main"><span class="free">⊢</span></span> Upd <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main"><span class="free">:</span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span>"</span></span>
<span class="main">|</span> T_Call<span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> 
    <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main"><span class="free">:</span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">;</span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main"><span class="free">:</span></span> param<span class="main">(</span>the <span class="main">(</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">^</span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">;</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">∈</span> do <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">⟧</span> 
    <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="main"><span class="free">⊢</span></span> <span class="main">(</span>Call <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="main"><span class="free">:</span></span> return<span class="main">(</span>the <span class="main">(</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">^</span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">inductive_cases</span></span> typing_elims <span class="main">[</span><span class="operator">elim</span><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span></span></span></span></span></span></span></span></span></span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">e</span> <span class="main">⊢</span> Obj <span class="free">b</span> <span class="free">T</span> <span class="main">:</span> <span class="free">T</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">e</span> <span class="main">⊢</span> Fvar <span class="free">x</span> <span class="main">:</span> <span class="free">T</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">e</span> <span class="main">⊢</span> Call <span class="free">a</span> <span class="free">l</span> <span class="free">b</span> <span class="main">:</span> <span class="free">T</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">e</span> <span class="main">⊢</span> Upd <span class="free">a</span> <span class="free">l</span> <span class="free">n</span> <span class="main">:</span> <span class="free">T</span>"</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Basic lemmas›</span></span>
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Basic treats of the type system.›</span></span>
<span class="keyword1" id="TypedSigma-not_bvar"><span class="command">lemma</span></span> not_bvar<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">e</span> <span class="main">⊢</span> <span class="free">t</span> <span class="main">:</span> <span class="free">T</span> <span class="main">⟹</span> <span class="main">∀</span><span class="bound">i</span><span class="main">.</span> <span class="free">t</span> <span class="main">≠</span> Bvar <span class="bound">i</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule</span> typing.cases<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>

<span class="keyword1" id="TypedSigma-typing_regular'"><span class="command">lemma</span></span> typing_regular'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">e</span> <span class="main">⊢</span> <span class="free">t</span> <span class="main">:</span> <span class="free">T</span> <span class="main">⟹</span> ok <span class="free">e</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>typing.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="TypedSigma-typing_regular''"><span class="command">lemma</span></span> typing_regular''<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">e</span> <span class="main">⊢</span> <span class="free">t</span> <span class="main">:</span> <span class="free">T</span> <span class="main">⟹</span> lc <span class="free">t</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>typing.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">theorem</span></span> typing_regular<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">e</span> <span class="main">⊢</span> <span class="free">t</span> <span class="main">:</span> <span class="free">T</span> <span class="main">⟹</span> ok <span class="free">e</span> <span class="main">∧</span> lc <span class="free">t</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> typing_regular' typing_regular''<span class="main">)</span>

<span class="keyword1" id="TypedSigma-obj_inv"><span class="command">lemma</span></span> obj_inv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">e</span> <span class="main">⊢</span> Obj <span class="free">f</span> <span class="free">U</span> <span class="main">:</span> <span class="free">A</span> <span class="main">⟹</span> <span class="free">A</span> <span class="main">=</span> <span class="free">U</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule</span> typing.cases<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="TypedSigma-obj_inv_elim"><span class="command">lemma</span></span> obj_inv_elim<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="free">e</span> <span class="main">⊢</span> Obj <span class="free">f</span> <span class="free">U</span> <span class="main">:</span> <span class="free">U</span> 
  <span class="main">⟹</span> <span class="main">(</span>dom <span class="free">f</span> <span class="main">=</span> do <span class="free">U</span><span class="main">)</span> 
    <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span><span class="bound">F</span><span class="main">.</span> finite <span class="bound">F</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">l</span><span class="main">∈</span>do <span class="free">U</span><span class="main">.</span> <span class="main">∀</span><span class="bound">s</span> <span class="bound">p</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∉</span> <span class="bound">F</span> <span class="main">∧</span> <span class="bound">p</span> <span class="main">∉</span> <span class="bound">F</span> <span class="main">∧</span> <span class="bound">s</span> <span class="main">≠</span> <span class="bound">p</span> 
        <span class="main">⟶</span> <span class="free">e</span><span class="main">⦇</span><span class="bound">s</span><span class="main">:</span><span class="free">U</span><span class="main">⦈</span><span class="main">⦇</span><span class="bound">p</span><span class="main">:</span>param<span class="main">(</span>the <span class="free">U</span><span class="main">^</span><span class="bound">l</span><span class="main">)</span><span class="main">⦈</span>
            <span class="main">⊢</span> <span class="main">(</span>the <span class="main">(</span><span class="free">f</span> <span class="bound">l</span><span class="main">)</span><span class="hidden">⇗</span><sup>[Fvar <span class="bound">s</span><span class="main">,</span>Fvar <span class="bound">p</span>]</sup><span class="hidden">⇖</span><span class="main">)</span> <span class="main">:</span> return<span class="main">(</span>the <span class="main">(</span><span class="free">U</span><span class="main">^</span><span class="bound">l</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule</span> typing.cases<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>

<span class="keyword1" id="TypedSigma-typing_induct"><span class="command">lemma</span></span> typing_induct<span class="main">[</span><span class="operator">consumes</span> 1<span class="main">,</span> <span class="operator">case_names</span> Fvar Call Upd Obj Bnd<span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> 
  <span class="free">env</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"type environment"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">t</span> <span class="main">::</span> <span class="quoted">sterm</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">T</span> <span class="main">::</span> <span class="quoted">type</span> <span class="keyword2"><span class="keyword">and</span></span> 
  <span class="free">P1</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"type environment <span class="main">⇒</span> sterm <span class="main">⇒</span> type <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  <span class="free">P2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"type environment <span class="main">⇒</span> sterm <span class="main">⇒</span> type <span class="main">⇒</span> Label <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">env</span> <span class="main">⊢</span> <span class="free">t</span> <span class="main">:</span> <span class="free">T</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">env</span> <span class="bound">T</span> <span class="bound">x</span><span class="main">.</span> <span class="main">⟦</span> ok <span class="bound">env</span><span class="main">;</span> <span class="bound">x</span> <span class="main">∈</span> env_dom <span class="bound">env</span><span class="main">;</span> the <span class="bound">env</span><span class="main">!</span><span class="bound">x</span> <span class="main">=</span> <span class="bound">T</span> <span class="main">⟧</span>
  <span class="main">⟹</span> <span class="free">P1</span> <span class="bound">env</span> <span class="main">(</span>Fvar <span class="bound">x</span><span class="main">)</span> <span class="bound">T</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">env</span> <span class="bound">T</span> <span class="bound">t</span> <span class="bound">l</span> <span class="bound">p</span><span class="main">.</span> <span class="main">⟦</span> <span class="bound">env</span> <span class="main">⊢</span> <span class="bound">t</span> <span class="main">:</span> <span class="bound">T</span><span class="main">;</span> <span class="free">P1</span> <span class="bound">env</span> <span class="bound">t</span> <span class="bound">T</span><span class="main">;</span> <span class="bound">env</span> <span class="main">⊢</span> <span class="bound">p</span> <span class="main">:</span> param <span class="main">(</span>the<span class="main">(</span><span class="bound">T</span><span class="main">^</span><span class="bound">l</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
                    <span class="free">P1</span> <span class="bound">env</span> <span class="bound">p</span> <span class="main">(</span>param <span class="main">(</span>the<span class="main">(</span><span class="bound">T</span><span class="main">^</span><span class="bound">l</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">;</span> <span class="bound">l</span> <span class="main">∈</span> do <span class="bound">T</span> <span class="main">⟧</span>
  <span class="main">⟹</span> <span class="free">P1</span> <span class="bound">env</span> <span class="main">(</span>Call <span class="bound">t</span> <span class="bound">l</span> <span class="bound">p</span><span class="main">)</span> <span class="main">(</span>return <span class="main">(</span>the<span class="main">(</span><span class="bound">T</span><span class="main">^</span><span class="bound">l</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">env</span> <span class="bound">T</span> <span class="bound">t</span> <span class="bound">l</span> <span class="bound">u</span><span class="main">.</span> <span class="main">⟦</span> <span class="bound">env</span> <span class="main">⊢</span> <span class="bound">t</span> <span class="main">:</span> <span class="bound">T</span><span class="main">;</span> <span class="free">P1</span> <span class="bound">env</span> <span class="bound">t</span> <span class="bound">T</span><span class="main">;</span> <span class="bound">l</span> <span class="main">∈</span> do <span class="bound">T</span><span class="main">;</span> <span class="free">P2</span> <span class="bound">env</span> <span class="bound">u</span> <span class="bound">T</span> <span class="bound">l</span> <span class="main">⟧</span>
  <span class="main">⟹</span> <span class="free">P1</span> <span class="bound">env</span> <span class="main">(</span>Upd <span class="bound">t</span> <span class="bound">l</span> <span class="bound">u</span><span class="main">)</span> <span class="bound">T</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">env</span> <span class="bound">T</span> <span class="bound">f</span><span class="main">.</span> <span class="main">⟦</span> ok <span class="bound">env</span><span class="main">;</span> dom <span class="bound">f</span> <span class="main">=</span> do <span class="bound">T</span><span class="main">;</span> <span class="main">∀</span><span class="bound">l</span><span class="main">∈</span>dom <span class="bound">f</span><span class="main">.</span> <span class="free">P2</span> <span class="bound">env</span> <span class="main">(</span>the<span class="main">(</span><span class="bound">f</span> <span class="bound">l</span><span class="main">)</span><span class="main">)</span> <span class="bound">T</span> <span class="bound">l</span> <span class="main">⟧</span>
  <span class="main">⟹</span> <span class="free">P1</span> <span class="bound">env</span> <span class="main">(</span>Obj <span class="bound">f</span> <span class="bound">T</span><span class="main">)</span> <span class="bound">T</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">env</span> <span class="bound">T</span> <span class="bound">l</span> <span class="bound">t</span> <span class="bound">L</span><span class="main">.</span> <span class="main">⟦</span> ok <span class="bound">env</span><span class="main">;</span> finite <span class="bound">L</span><span class="main">;</span> 
                  <span class="main">∀</span><span class="bound">s</span> <span class="bound">p</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∉</span> <span class="bound">L</span> <span class="main">∧</span> <span class="bound">p</span> <span class="main">∉</span> <span class="bound">L</span> <span class="main">∧</span> <span class="bound">s</span> <span class="main">≠</span> <span class="bound">p</span> 
                   <span class="main">⟶</span> <span class="bound">env</span><span class="main">⦇</span><span class="bound">s</span><span class="main">:</span><span class="bound">T</span><span class="main">⦈</span><span class="main">⦇</span><span class="bound">p</span><span class="main">:</span>param <span class="main">(</span>the<span class="main">(</span><span class="bound">T</span><span class="main">^</span><span class="bound">l</span><span class="main">)</span><span class="main">)</span><span class="main">⦈</span> 
                       <span class="main">⊢</span> <span class="main">(</span><span class="bound">t</span><span class="hidden">⇗</span><sup>[Fvar <span class="bound">s</span><span class="main">,</span> Fvar <span class="bound">p</span>]</sup><span class="hidden">⇖</span><span class="main">)</span> <span class="main">:</span> return <span class="main">(</span>the<span class="main">(</span><span class="bound">T</span><span class="main">^</span><span class="bound">l</span><span class="main">)</span><span class="main">)</span>
                      <span class="main">∧</span> <span class="free">P1</span> <span class="main">(</span><span class="bound">env</span><span class="main">⦇</span><span class="bound">s</span><span class="main">:</span><span class="bound">T</span><span class="main">⦈</span><span class="main">⦇</span><span class="bound">p</span><span class="main">:</span>param <span class="main">(</span>the<span class="main">(</span><span class="bound">T</span><span class="main">^</span><span class="bound">l</span><span class="main">)</span><span class="main">)</span><span class="main">⦈</span><span class="main">)</span> <span class="main">(</span><span class="bound">t</span><span class="hidden">⇗</span><sup>[Fvar <span class="bound">s</span><span class="main">,</span> Fvar <span class="bound">p</span>]</sup><span class="hidden">⇖</span><span class="main">)</span> 
                           <span class="main">(</span>return <span class="main">(</span>the<span class="main">(</span><span class="bound">T</span><span class="main">^</span><span class="bound">l</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">⟧</span>
  <span class="main">⟹</span> <span class="free">P2</span> <span class="bound">env</span> <span class="bound">t</span> <span class="bound">T</span> <span class="bound">l</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">P1</span> <span class="free">env</span> <span class="free">t</span> <span class="free">T</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> typing.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> typing_regular'<span class="main">)</span>

<span class="comment1">(* TODO: delete after refactoring of disjunct_env *)</span>
<span class="keyword1" id="TypedSigma-ball_Tltsp"><span class="command">lemma</span></span> ball_Tltsp<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> 
  <span class="free">P1</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"type <span class="main">⇒</span> Label <span class="main">⇒</span> sterm <span class="main">⇒</span> string <span class="main">⇒</span> string <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 
  <span class="free">P2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"type <span class="main">⇒</span> Label <span class="main">⇒</span> sterm <span class="main">⇒</span> string <span class="main">⇒</span> string <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> 
  <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">l</span> <span class="bound">t</span> <span class="bound">t'</span><span class="main">.</span> <span class="main">⟦</span> <span class="main">∀</span><span class="bound">s</span> <span class="bound">p</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∉</span> <span class="free">F</span> <span class="main">∧</span> <span class="bound">p</span> <span class="main">∉</span> <span class="free">F</span> <span class="main">∧</span> <span class="bound">s</span> <span class="main">≠</span> <span class="bound">p</span> <span class="main">⟶</span> <span class="free">P1</span> <span class="free">T</span> <span class="bound">l</span> <span class="bound">t</span> <span class="bound">s</span> <span class="bound">p</span> <span class="main">⟧</span> 
  <span class="main">⟹</span> <span class="main">∀</span><span class="bound">s</span> <span class="bound">p</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∉</span> <span class="free">F'</span> <span class="main">∧</span> <span class="bound">p</span> <span class="main">∉</span> <span class="free">F'</span> <span class="main">∧</span> <span class="bound">s</span> <span class="main">≠</span> <span class="bound">p</span> <span class="main">⟶</span> <span class="free">P2</span> <span class="free">T</span> <span class="bound">l</span> <span class="bound">t</span> <span class="bound">s</span> <span class="bound">p</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">l</span><span class="main">∈</span>do <span class="free">T</span><span class="main">.</span> <span class="main">∀</span><span class="bound">s</span> <span class="bound">p</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∉</span> <span class="free">F</span> <span class="main">∧</span> <span class="bound">p</span> <span class="main">∉</span> <span class="free">F</span> <span class="main">∧</span> <span class="bound">s</span> <span class="main">≠</span> <span class="bound">p</span> <span class="main">⟶</span> <span class="free">P1</span> <span class="free">T</span> <span class="bound">l</span> <span class="main">(</span>the<span class="main">(</span><span class="free">f</span> <span class="bound">l</span><span class="main">)</span><span class="main">)</span> <span class="bound">s</span> <span class="bound">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">l</span><span class="main">∈</span>do <span class="free">T</span><span class="main">.</span> <span class="main">∀</span><span class="bound">s</span> <span class="bound">p</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∉</span> <span class="free">F'</span> <span class="main">∧</span> <span class="bound">p</span> <span class="main">∉</span> <span class="free">F'</span> <span class="main">∧</span> <span class="bound">s</span> <span class="main">≠</span> <span class="bound">p</span> <span class="main">⟶</span> <span class="free">P2</span> <span class="free">T</span> <span class="bound">l</span> <span class="main">(</span>the<span class="main">(</span><span class="free">f</span> <span class="bound">l</span><span class="main">)</span><span class="main">)</span> <span class="bound">s</span> <span class="bound">p</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">l</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">∈</span> do <span class="free">T</span>"</span></span>
  <span class="keyword1"><span class="command">with</span></span> assms<span class="main">(</span>2<span class="main">)</span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">s</span> <span class="bound">p</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∉</span> <span class="free">F</span> <span class="main">∧</span> <span class="bound">p</span> <span class="main">∉</span> <span class="free">F</span> <span class="main">∧</span> <span class="bound">s</span> <span class="main">≠</span> <span class="bound">p</span> <span class="main">⟶</span> <span class="free">P1</span> <span class="free">T</span> <span class="skolem">l</span> <span class="main">(</span>the<span class="main">(</span><span class="free">f</span> <span class="skolem">l</span><span class="main">)</span><span class="main">)</span> <span class="bound">s</span> <span class="bound">p</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">with</span></span> assms<span class="main">(</span>1<span class="main">)</span> 
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">s</span> <span class="bound">p</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∉</span> <span class="free">F'</span> <span class="main">∧</span> <span class="bound">p</span> <span class="main">∉</span> <span class="free">F'</span> <span class="main">∧</span> <span class="bound">s</span> <span class="main">≠</span> <span class="bound">p</span> <span class="main">⟶</span> <span class="free">P2</span> <span class="free">T</span> <span class="skolem">l</span> <span class="main">(</span>the<span class="main">(</span><span class="free">f</span> <span class="skolem">l</span><span class="main">)</span><span class="main">)</span> <span class="bound">s</span> <span class="bound">p</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(* TODO: delete after refactoring of subject_reduction *)</span>
<span class="keyword1" id="TypedSigma-ball_ex_finite"><span class="command">lemma</span></span> ball_ex_finite<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> 
  <span class="free">S</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">F</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'b</span> set"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">x</span> <span class="main">::</span> <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span> <span class="keyword2"><span class="keyword">and</span></span> 
  <span class="free">P</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> 
  <span class="quoted"><span class="quoted">"finite <span class="free">S</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">F</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span><span class="free">S</span><span class="main">.</span> <span class="main">(</span><span class="main">∃</span><span class="bound">F'</span><span class="main">.</span> finite <span class="bound">F'</span>
              <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">s</span> <span class="bound">p</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∉</span> <span class="bound">F'</span> <span class="main">∪</span> <span class="free">F</span> <span class="main">∧</span> <span class="bound">p</span> <span class="main">∉</span> <span class="bound">F'</span> <span class="main">∪</span> <span class="free">F</span> <span class="main">∧</span> <span class="bound">s</span> <span class="main">≠</span> <span class="bound">p</span>
                  <span class="main">⟶</span> <span class="free">P</span> <span class="bound">x</span> <span class="bound">s</span> <span class="bound">p</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> 
  <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">F'</span><span class="main">.</span> finite <span class="bound">F'</span>
      <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">∈</span><span class="free">S</span><span class="main">.</span> <span class="main">∀</span><span class="bound">s</span> <span class="bound">p</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∉</span> <span class="bound">F'</span> <span class="main">∪</span> <span class="free">F</span> <span class="main">∧</span> <span class="bound">p</span> <span class="main">∉</span> <span class="bound">F'</span> <span class="main">∪</span> <span class="free">F</span> <span class="main">∧</span> <span class="bound">s</span> <span class="main">≠</span> <span class="bound">p</span>
                 <span class="main">⟶</span> <span class="free">P</span> <span class="bound">x</span> <span class="bound">s</span> <span class="bound">p</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">S</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> empty <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>insert <span class="skolem">x</span> <span class="skolem">S</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> insert<span class="main">(</span>5<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> 
      <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">y</span><span class="main">∈</span><span class="skolem">S</span><span class="main">.</span> <span class="main">(</span><span class="main">∃</span><span class="bound">F'</span><span class="main">.</span> finite <span class="bound">F'</span> 
                  <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">s</span> <span class="bound">p</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∉</span> <span class="bound">F'</span> <span class="main">∪</span> <span class="free">F</span> <span class="main">∧</span> <span class="bound">p</span> <span class="main">∉</span> <span class="bound">F'</span> <span class="main">∪</span> <span class="free">F</span> <span class="main">∧</span> <span class="bound">s</span> <span class="main">≠</span> <span class="bound">p</span>
                      <span class="main">⟶</span> <span class="free">P</span> <span class="bound">y</span> <span class="bound">s</span> <span class="bound">p</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">from</span></span> insert<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹finite <span class="free">F</span>›</span></span> this<span class="main">]</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">F1</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
      <span class="quoted"><span class="quoted">"finite <span class="skolem">F1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      pred_S<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">y</span><span class="main">∈</span><span class="skolem">S</span><span class="main">.</span> <span class="main">∀</span><span class="bound">s</span> <span class="bound">p</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∉</span> <span class="skolem">F1</span> <span class="main">∪</span> <span class="free">F</span> <span class="main">∧</span> <span class="bound">p</span> <span class="main">∉</span> <span class="skolem">F1</span> <span class="main">∪</span> <span class="free">F</span> <span class="main">∧</span> <span class="bound">s</span> <span class="main">≠</span> <span class="bound">p</span>
                       <span class="main">⟶</span> <span class="free">P</span> <span class="bound">y</span> <span class="bound">s</span> <span class="bound">p</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> insert<span class="main">(</span>5<span class="main">)</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">F2</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
      <span class="quoted"><span class="quoted">"finite <span class="skolem">F2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">s</span> <span class="bound">p</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∉</span> <span class="skolem">F2</span> <span class="main">∪</span> <span class="free">F</span> <span class="main">∧</span> <span class="bound">p</span> <span class="main">∉</span> <span class="skolem">F2</span> <span class="main">∪</span> <span class="free">F</span> <span class="main">∧</span> <span class="bound">s</span> <span class="main">≠</span> <span class="bound">p</span> <span class="main">⟶</span> <span class="free">P</span> <span class="skolem">x</span> <span class="bound">s</span> <span class="bound">p</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> pred_S <span class="keyword1"><span class="command">have</span></span> 
      <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">y</span><span class="main">∈</span>insert <span class="skolem">x</span> <span class="skolem">S</span><span class="main">.</span> <span class="main">∀</span><span class="bound">s</span> <span class="bound">p</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∉</span> <span class="skolem">F1</span> <span class="main">∪</span> <span class="skolem">F2</span> <span class="main">∪</span> <span class="free">F</span> <span class="main">∧</span> <span class="bound">p</span> <span class="main">∉</span> <span class="skolem">F1</span> <span class="main">∪</span> <span class="skolem">F2</span> <span class="main">∪</span> <span class="free">F</span> <span class="main">∧</span> <span class="bound">s</span> <span class="main">≠</span> <span class="bound">p</span>
                        <span class="main">⟶</span> <span class="free">P</span> <span class="bound">y</span> <span class="bound">s</span> <span class="bound">p</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹finite <span class="skolem">F1</span>›</span></span> <span class="quoted"><span class="quoted">‹finite <span class="skolem">F2</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="skolem">F1</span> <span class="main">∪</span> <span class="skolem">F2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">ultimately</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(* TODO: delete after refactoring of type_renaming' *)</span>
<span class="keyword1" id="TypedSigma-bnd_renaming_lem"><span class="command">lemma</span></span> bnd_renaming_lem<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">∉</span> FV <span class="free">t'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∉</span> FV <span class="free">t'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> FV <span class="free">t'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∉</span> FV <span class="free">t'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> env_dom <span class="free">env'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∉</span> env_dom <span class="free">env'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">≠</span> <span class="free">p</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≠</span> <span class="free">y</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">=</span> <span class="main">{</span>Suc <span class="free">n</span> <span class="main">→</span> <span class="main">[</span>Fvar <span class="free">s</span><span class="main">,</span> Fvar <span class="free">p</span><span class="main">]}</span> <span class="free">t'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">env</span> <span class="main">=</span> <span class="free">env'</span><span class="main">⦇</span><span class="free">s</span><span class="main">:</span><span class="free">A</span><span class="main">⦈</span><span class="main">⦇</span><span class="free">p</span><span class="main">:</span><span class="free">B</span><span class="main">⦈</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  pred_bnd<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">sa</span> <span class="bound">pa</span><span class="main">.</span> <span class="bound">sa</span> <span class="main">∉</span> <span class="free">F</span> <span class="main">∧</span> <span class="bound">pa</span> <span class="main">∉</span> <span class="free">F</span> <span class="main">∧</span> <span class="bound">sa</span> <span class="main">≠</span> <span class="bound">pa</span> 
    <span class="main">⟶</span> <span class="free">env</span><span class="main">⦇</span><span class="bound">sa</span><span class="main">:</span><span class="free">T</span><span class="main">⦈</span><span class="main">⦇</span><span class="bound">pa</span><span class="main">:</span>param<span class="main">(</span>the<span class="main">(</span><span class="free">T</span><span class="main">^</span><span class="free">l</span><span class="main">)</span><span class="main">)</span><span class="main">⦈</span> <span class="main">⊢</span> <span class="main">(</span><span class="free">t</span><span class="hidden">⇗</span><sup>[Fvar <span class="bound">sa</span><span class="main">,</span>Fvar <span class="bound">pa</span>]</sup><span class="hidden">⇖</span><span class="main">)</span> <span class="main">:</span> return<span class="main">(</span>the<span class="main">(</span><span class="free">T</span><span class="main">^</span><span class="free">l</span><span class="main">)</span><span class="main">)</span>
        <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">env''</span> <span class="bound">t''</span> <span class="bound">s'</span> <span class="bound">p'</span> <span class="bound">x'</span> <span class="bound">y'</span> <span class="bound">A'</span> <span class="bound">B'</span> <span class="bound">n'</span><span class="main">.</span> 
            <span class="bound">s'</span> <span class="main">∉</span> FV <span class="bound">t''</span> <span class="main">⟶</span> <span class="bound">p'</span> <span class="main">∉</span> FV <span class="bound">t''</span> <span class="main">⟶</span> <span class="bound">x'</span> <span class="main">∉</span> FV <span class="bound">t''</span> <span class="main">⟶</span> <span class="bound">y'</span> <span class="main">∉</span> FV <span class="bound">t''</span> <span class="main">⟶</span> 
            <span class="bound">x'</span> <span class="main">∉</span> env_dom <span class="bound">env''</span> <span class="main">⟶</span> <span class="bound">y'</span> <span class="main">∉</span> env_dom <span class="bound">env''</span> <span class="main">⟶</span> <span class="bound">x'</span> <span class="main">≠</span> <span class="bound">y'</span> <span class="main">⟶</span> <span class="bound">s'</span> <span class="main">≠</span> <span class="bound">p'</span> 
            <span class="main">⟶</span> <span class="main">(</span><span class="free">t</span><span class="hidden">⇗</span><sup>[Fvar <span class="bound">sa</span><span class="main">,</span>Fvar <span class="bound">pa</span>]</sup><span class="hidden">⇖</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="bound">n'</span> <span class="main">→</span> <span class="main">[</span>Fvar <span class="bound">s'</span><span class="main">,</span>Fvar <span class="bound">p'</span><span class="main">]}</span> <span class="bound">t''</span> 
            <span class="main">⟶</span> <span class="free">env</span><span class="main">⦇</span><span class="bound">sa</span><span class="main">:</span><span class="free">T</span><span class="main">⦈</span><span class="main">⦇</span><span class="bound">pa</span><span class="main">:</span>param<span class="main">(</span>the<span class="main">(</span><span class="free">T</span><span class="main">^</span><span class="free">l</span><span class="main">)</span><span class="main">)</span><span class="main">⦈</span> <span class="main">=</span> <span class="bound">env''</span><span class="main">⦇</span><span class="bound">s'</span><span class="main">:</span><span class="bound">A'</span><span class="main">⦈</span><span class="main">⦇</span><span class="bound">p'</span><span class="main">:</span><span class="bound">B'</span><span class="main">⦈</span> 
            <span class="main">⟶</span> <span class="bound">env''</span><span class="main">⦇</span><span class="bound">x'</span><span class="main">:</span><span class="bound">A'</span><span class="main">⦈</span><span class="main">⦇</span><span class="bound">y'</span><span class="main">:</span><span class="bound">B'</span><span class="main">⦈</span> 
                <span class="main">⊢</span> <span class="main">{</span><span class="bound">n'</span> <span class="main">→</span> <span class="main">[</span>Fvar <span class="bound">x'</span><span class="main">,</span>Fvar <span class="bound">y'</span><span class="main">]}</span> <span class="bound">t''</span> <span class="main">:</span> return<span class="main">(</span>the<span class="main">(</span><span class="free">T</span><span class="main">^</span><span class="free">l</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  <span class="quoted"><span class="quoted">"FV <span class="free">t'</span> <span class="main">⊆</span> <span class="free">F'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">sa</span> <span class="bound">pa</span><span class="main">.</span> <span class="bound">sa</span> <span class="main">∉</span> <span class="free">F</span> <span class="main">∪</span> <span class="main">{</span><span class="free">s</span><span class="main">,</span><span class="free">p</span><span class="main">,</span><span class="free">x</span><span class="main">,</span><span class="free">y</span><span class="main">}</span> <span class="main">∪</span> <span class="free">F'</span> <span class="main">∪</span> env_dom <span class="free">env'</span> 
         <span class="main">∧</span> <span class="bound">pa</span> <span class="main">∉</span> <span class="free">F</span> <span class="main">∪</span> <span class="main">{</span><span class="free">s</span><span class="main">,</span><span class="free">p</span><span class="main">,</span><span class="free">x</span><span class="main">,</span><span class="free">y</span><span class="main">}</span> <span class="main">∪</span> <span class="free">F'</span> <span class="main">∪</span> env_dom <span class="free">env'</span> 
         <span class="main">∧</span> <span class="bound">sa</span> <span class="main">≠</span> <span class="bound">pa</span>
    <span class="main">⟶</span> <span class="free">env'</span><span class="main">⦇</span><span class="free">x</span><span class="main">:</span><span class="free">A</span><span class="main">⦈</span><span class="main">⦇</span><span class="free">y</span><span class="main">:</span><span class="free">B</span><span class="main">⦈</span><span class="main">⦇</span><span class="bound">sa</span><span class="main">:</span><span class="free">T</span><span class="main">⦈</span><span class="main">⦇</span><span class="bound">pa</span><span class="main">:</span>param<span class="main">(</span>the<span class="main">(</span><span class="free">T</span><span class="main">^</span><span class="free">l</span><span class="main">)</span><span class="main">)</span><span class="main">⦈</span>
        <span class="main">⊢</span> <span class="main">(</span><span class="main">{</span>Suc <span class="free">n</span> <span class="main">→</span> <span class="main">[</span>Fvar <span class="free">x</span><span class="main">,</span> Fvar <span class="free">y</span><span class="main">]}</span> <span class="free">t'</span><span class="hidden">⇗</span><sup>[Fvar <span class="bound">sa</span><span class="main">,</span>Fvar <span class="bound">pa</span>]</sup><span class="hidden">⇖</span><span class="main">)</span> <span class="main">:</span> return <span class="main">(</span>the<span class="main">(</span><span class="free">T</span><span class="main">^</span><span class="free">l</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> strip<span class="main"><span class="keyword3">,</span></span> <span class="operator">elim</span> conjE<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">sa</span> <span class="skolem">pa</span> 
  <span class="keyword3"><span class="command">assume</span></span> 
    nin_sa<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">sa</span> <span class="main">∉</span> <span class="free">F</span> <span class="main">∪</span> <span class="main">{</span><span class="free">s</span><span class="main">,</span><span class="free">p</span><span class="main">,</span><span class="free">x</span><span class="main">,</span><span class="free">y</span><span class="main">}</span> <span class="main">∪</span> <span class="free">F'</span> <span class="main">∪</span> env_dom <span class="free">env'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    nin_pa<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">pa</span> <span class="main">∉</span> <span class="free">F</span> <span class="main">∪</span> <span class="main">{</span><span class="free">s</span><span class="main">,</span><span class="free">p</span><span class="main">,</span><span class="free">x</span><span class="main">,</span><span class="free">y</span><span class="main">}</span> <span class="main">∪</span> <span class="free">F'</span> <span class="main">∪</span> env_dom <span class="free">env'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">sa</span> <span class="main">≠</span> <span class="skolem">pa</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">sa</span> <span class="main">∉</span> <span class="free">F</span> <span class="main">∧</span> <span class="skolem">pa</span> <span class="main">∉</span> <span class="free">F</span> <span class="main">∧</span> <span class="skolem">sa</span> <span class="main">≠</span> <span class="skolem">pa</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∉</span> FV <span class="free">t'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∈</span> <span class="main">{</span><span class="free">s</span><span class="main">,</span><span class="free">p</span><span class="main">,</span><span class="free">x</span><span class="main">,</span><span class="free">y</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> 
      <span class="quoted"><span class="quoted">‹FV <span class="free">t'</span> <span class="main">⊆</span> <span class="free">F'</span>›</span></span> nin_sa nin_pa <span class="quoted"><span class="quoted">‹<span class="skolem">sa</span> <span class="main">≠</span> <span class="skolem">pa</span>›</span></span> 
      sopen_FV<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="main">0</span></span> <span class="quoted"><span class="quoted">"Fvar <span class="skolem">sa</span>"</span></span> <span class="quoted"><span class="quoted">"Fvar <span class="skolem">pa</span>"</span></span> <span class="quoted"><span class="free">t'</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∉</span> FV <span class="main">(</span><span class="free">t'</span><span class="hidden">⇗</span><sup>[Fvar <span class="skolem">sa</span><span class="main">,</span>Fvar <span class="skolem">pa</span>]</sup><span class="hidden">⇖</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> openz_def<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> 
      this<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">s</span> <span class="main">∉</span> FV <span class="free">t'</span>›</span></span><span class="main">]</span> this<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">p</span> <span class="main">∉</span> FV <span class="free">t'</span>›</span></span><span class="main">]</span> 
      this<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">x</span> <span class="main">∉</span> FV <span class="free">t'</span>›</span></span><span class="main">]</span> this<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">y</span> <span class="main">∉</span> FV <span class="free">t'</span>›</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">from</span></span> 
    not_in_env_bigger_2<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">x</span> <span class="main">∉</span> env_dom <span class="free">env'</span>›</span></span><span class="main">]</span> 
    not_in_env_bigger_2<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">y</span> <span class="main">∉</span> env_dom <span class="free">env'</span>›</span></span><span class="main">]</span>
    nin_sa nin_pa
  <span class="keyword1"><span class="command">have</span></span> 
    <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> env_dom <span class="main">(</span><span class="free">env'</span><span class="main">⦇</span><span class="skolem">sa</span><span class="main">:</span><span class="free">T</span><span class="main">⦈</span><span class="main">⦇</span><span class="skolem">pa</span><span class="main">:</span>param<span class="main">(</span>the<span class="main">(</span><span class="free">T</span><span class="main">^</span><span class="free">l</span><span class="main">)</span><span class="main">)</span><span class="main">⦈</span><span class="main">)</span> 
    <span class="main">∧</span> <span class="free">y</span> <span class="main">∉</span> env_dom <span class="main">(</span><span class="free">env'</span><span class="main">⦇</span><span class="skolem">sa</span><span class="main">:</span><span class="free">T</span><span class="main">⦈</span><span class="main">⦇</span><span class="skolem">pa</span><span class="main">:</span>param<span class="main">(</span>the<span class="main">(</span><span class="free">T</span><span class="main">^</span><span class="free">l</span><span class="main">)</span><span class="main">)</span><span class="main">⦈</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="free">t</span> <span class="main">=</span> <span class="main">{</span>Suc <span class="free">n</span> <span class="main">→</span> <span class="main">[</span>Fvar <span class="free">s</span><span class="main">,</span> Fvar <span class="free">p</span><span class="main">]}</span> <span class="free">t'</span>›</span></span> sopen_commute<span class="main">[</span><span class="operator">OF</span> Suc_not_Zero<span class="main">]</span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">t</span><span class="hidden">⇗</span><sup>[Fvar <span class="skolem">sa</span><span class="main">,</span>Fvar <span class="skolem">pa</span>]</sup><span class="hidden">⇖</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span>Suc <span class="free">n</span> <span class="main">→</span> <span class="main">[</span>Fvar <span class="free">s</span><span class="main">,</span>Fvar <span class="free">p</span><span class="main">]}</span> <span class="main">(</span><span class="free">t'</span><span class="hidden">⇗</span><sup>[Fvar <span class="skolem">sa</span><span class="main">,</span>Fvar <span class="skolem">pa</span>]</sup><span class="hidden">⇖</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> openz_def<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">from</span></span> 
    subst_add<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="skolem">sa</span></span> <span class="quoted"><span class="free">env'</span></span> <span class="quoted"><span class="free">A</span></span> <span class="quoted"><span class="free">T</span></span><span class="main">]</span> subst_add<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">sa</span></span> <span class="quoted"><span class="free">p</span></span> <span class="quoted"><span class="quoted">"<span class="free">env'</span><span class="main">⦇</span><span class="free">s</span><span class="main">:</span><span class="free">A</span><span class="main">⦈</span>"</span></span> <span class="quoted"><span class="free">T</span></span> <span class="quoted"><span class="free">B</span></span><span class="main">]</span> 
    subst_add<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="skolem">pa</span></span> <span class="quoted"><span class="quoted">"<span class="free">env'</span><span class="main">⦇</span><span class="skolem">sa</span><span class="main">:</span><span class="free">T</span><span class="main">⦈</span>"</span></span> <span class="quoted"><span class="free">A</span></span> <span class="quoted"><span class="quoted">"param<span class="main">(</span>the<span class="main">(</span><span class="free">T</span><span class="main">^</span><span class="free">l</span><span class="main">)</span><span class="main">)</span>"</span></span><span class="main">]</span>
    subst_add<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">p</span></span> <span class="quoted"><span class="skolem">pa</span></span> <span class="quoted"><span class="quoted">"<span class="free">env'</span><span class="main">⦇</span><span class="skolem">sa</span><span class="main">:</span><span class="free">T</span><span class="main">⦈</span><span class="main">⦇</span><span class="free">s</span><span class="main">:</span><span class="free">A</span><span class="main">⦈</span>"</span></span> <span class="quoted"><span class="free">B</span></span> <span class="quoted"><span class="quoted">"param<span class="main">(</span>the<span class="main">(</span><span class="free">T</span><span class="main">^</span><span class="free">l</span><span class="main">)</span><span class="main">)</span>"</span></span><span class="main">]</span>
    <span class="quoted"><span class="quoted">‹<span class="free">env</span> <span class="main">=</span> <span class="free">env'</span><span class="main">⦇</span><span class="free">s</span><span class="main">:</span><span class="free">A</span><span class="main">⦈</span><span class="main">⦇</span><span class="free">p</span><span class="main">:</span><span class="free">B</span><span class="main">⦈</span>›</span></span> nin_sa nin_pa
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">env</span><span class="main">⦇</span><span class="skolem">sa</span><span class="main">:</span><span class="free">T</span><span class="main">⦈</span><span class="main">⦇</span><span class="skolem">pa</span><span class="main">:</span>param<span class="main">(</span>the<span class="main">(</span><span class="free">T</span><span class="main">^</span><span class="free">l</span><span class="main">)</span><span class="main">)</span><span class="main">⦈</span> <span class="main">=</span> <span class="free">env'</span><span class="main">⦇</span><span class="skolem">sa</span><span class="main">:</span><span class="free">T</span><span class="main">⦈</span><span class="main">⦇</span><span class="skolem">pa</span><span class="main">:</span>param<span class="main">(</span>the<span class="main">(</span><span class="free">T</span><span class="main">^</span><span class="free">l</span><span class="main">)</span><span class="main">)</span><span class="main">⦈</span><span class="main">⦇</span><span class="free">s</span><span class="main">:</span><span class="free">A</span><span class="main">⦈</span><span class="main">⦇</span><span class="free">p</span><span class="main">:</span><span class="free">B</span><span class="main">⦈</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword1"><span class="command">have</span></span> 
    <span class="quoted"><span class="quoted">"<span class="free">env'</span><span class="main">⦇</span><span class="skolem">sa</span><span class="main">:</span><span class="free">T</span><span class="main">⦈</span><span class="main">⦇</span><span class="skolem">pa</span><span class="main">:</span>param<span class="main">(</span>the <span class="free">T</span><span class="main">^</span><span class="free">l</span><span class="main">)</span><span class="main">⦈</span><span class="main">⦇</span><span class="free">x</span><span class="main">:</span><span class="free">A</span><span class="main">⦈</span><span class="main">⦇</span><span class="free">y</span><span class="main">:</span><span class="free">B</span><span class="main">⦈</span>
     <span class="main">⊢</span> <span class="main">{</span>Suc <span class="free">n</span> <span class="main">→</span> <span class="main">[</span>Fvar <span class="free">x</span><span class="main">,</span> Fvar <span class="free">y</span><span class="main">]}</span> <span class="main">(</span><span class="free">t'</span><span class="hidden">⇗</span><sup>[Fvar <span class="skolem">sa</span><span class="main">,</span>Fvar <span class="skolem">pa</span>]</sup><span class="hidden">⇖</span><span class="main">)</span> <span class="main">:</span> return<span class="main">(</span>the<span class="main">(</span><span class="free">T</span><span class="main">^</span><span class="free">l</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">s</span> <span class="main">≠</span> <span class="free">p</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">x</span> <span class="main">≠</span> <span class="free">y</span>›</span></span> pred_bnd <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">from</span></span> 
    subst_add<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">y</span></span> <span class="quoted"><span class="skolem">sa</span></span> <span class="quoted"><span class="quoted">"<span class="free">env'</span><span class="main">⦇</span><span class="free">x</span><span class="main">:</span><span class="free">A</span><span class="main">⦈</span>"</span></span> <span class="quoted"><span class="free">B</span></span> <span class="quoted"><span class="free">T</span></span><span class="main">]</span> subst_add<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="skolem">sa</span></span> <span class="quoted"><span class="free">env'</span></span> <span class="quoted"><span class="free">A</span></span> <span class="quoted"><span class="free">T</span></span><span class="main">]</span> 
    subst_add<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">y</span></span> <span class="quoted"><span class="skolem">pa</span></span> <span class="quoted"><span class="quoted">"<span class="free">env'</span><span class="main">⦇</span><span class="skolem">sa</span><span class="main">:</span><span class="free">T</span><span class="main">⦈</span><span class="main">⦇</span><span class="free">x</span><span class="main">:</span><span class="free">A</span><span class="main">⦈</span>"</span></span> <span class="quoted"><span class="free">B</span></span> <span class="quoted"><span class="quoted">"param<span class="main">(</span>the<span class="main">(</span><span class="free">T</span><span class="main">^</span><span class="free">l</span><span class="main">)</span><span class="main">)</span>"</span></span><span class="main">]</span>
    subst_add<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="skolem">pa</span></span> <span class="quoted"><span class="quoted">"<span class="free">env'</span><span class="main">⦇</span><span class="skolem">sa</span><span class="main">:</span><span class="free">T</span><span class="main">⦈</span>"</span></span> <span class="quoted"><span class="free">A</span></span> <span class="quoted"><span class="quoted">"param<span class="main">(</span>the<span class="main">(</span><span class="free">T</span><span class="main">^</span><span class="free">l</span><span class="main">)</span><span class="main">)</span>"</span></span><span class="main">]</span> 
    nin_sa nin_pa
  <span class="keyword1"><span class="command">have</span></span> 
    <span class="quoted"><span class="quoted">"<span class="free">env'</span><span class="main">⦇</span><span class="free">x</span><span class="main">:</span><span class="free">A</span><span class="main">⦈</span><span class="main">⦇</span><span class="free">y</span><span class="main">:</span><span class="free">B</span><span class="main">⦈</span><span class="main">⦇</span><span class="skolem">sa</span><span class="main">:</span><span class="free">T</span><span class="main">⦈</span><span class="main">⦇</span><span class="skolem">pa</span><span class="main">:</span>param<span class="main">(</span>the<span class="main">(</span><span class="free">T</span><span class="main">^</span><span class="free">l</span><span class="main">)</span><span class="main">)</span><span class="main">⦈</span>
     <span class="main">=</span> <span class="free">env'</span><span class="main">⦇</span><span class="skolem">sa</span><span class="main">:</span><span class="free">T</span><span class="main">⦈</span><span class="main">⦇</span><span class="skolem">pa</span><span class="main">:</span>param<span class="main">(</span>the<span class="main">(</span><span class="free">T</span><span class="main">^</span><span class="free">l</span><span class="main">)</span><span class="main">)</span><span class="main">⦈</span><span class="main">⦇</span><span class="free">x</span><span class="main">:</span><span class="free">A</span><span class="main">⦈</span><span class="main">⦇</span><span class="free">y</span><span class="main">:</span><span class="free">B</span><span class="main">⦈</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> 
  <span class="keyword3"><span class="command">show</span></span> 
    <span class="quoted"><span class="quoted">"<span class="free">env'</span><span class="main">⦇</span><span class="free">x</span><span class="main">:</span><span class="free">A</span><span class="main">⦈</span><span class="main">⦇</span><span class="free">y</span><span class="main">:</span><span class="free">B</span><span class="main">⦈</span><span class="main">⦇</span><span class="skolem">sa</span><span class="main">:</span><span class="free">T</span><span class="main">⦈</span><span class="main">⦇</span><span class="skolem">pa</span><span class="main">:</span>param<span class="main">(</span>the<span class="main">(</span><span class="free">T</span><span class="main">^</span><span class="free">l</span><span class="main">)</span><span class="main">)</span><span class="main">⦈</span>
     <span class="main">⊢</span> <span class="main">(</span><span class="main">{</span>Suc <span class="free">n</span> <span class="main">→</span> <span class="main">[</span>Fvar <span class="free">x</span><span class="main">,</span> Fvar <span class="free">y</span><span class="main">]}</span> <span class="free">t'</span><span class="hidden">⇗</span><sup>[Fvar <span class="skolem">sa</span><span class="main">,</span>Fvar <span class="skolem">pa</span>]</sup><span class="hidden">⇖</span><span class="main">)</span> <span class="main">:</span> return <span class="main">(</span>the<span class="main">(</span><span class="free">T</span><span class="main">^</span><span class="free">l</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> sopen_commute<span class="main">[</span><span class="operator">OF</span> not_sym<span class="main"><span class="main">[</span></span><span class="operator">OF</span> Suc_not_Zero<span class="main"><span class="main">]</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> openz_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(* TODO: refactor to work with typing_induct *)</span>
<span class="keyword1" id="TypedSigma-type_renaming'"><span class="command">lemma</span></span> type_renaming'<span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">e</span> <span class="main">⊢</span> <span class="free">t</span> <span class="main">:</span> <span class="free">C</span> <span class="main">⟹</span>
  <span class="main">(</span><span class="main">⋀</span><span class="bound">env</span> <span class="bound">t'</span> <span class="bound">s</span> <span class="bound">p</span> <span class="bound">x</span> <span class="bound">y</span> <span class="bound">A</span> <span class="bound">B</span> <span class="bound">n</span><span class="main">.</span> <span class="main">⟦</span> <span class="bound">s</span> <span class="main">∉</span> FV <span class="bound">t'</span><span class="main">;</span> <span class="bound">p</span> <span class="main">∉</span> FV <span class="bound">t'</span><span class="main">;</span> <span class="bound">x</span> <span class="main">∉</span> FV <span class="bound">t'</span><span class="main">;</span> <span class="bound">y</span> <span class="main">∉</span> FV <span class="bound">t'</span><span class="main">;</span> 
                             <span class="bound">x</span> <span class="main">∉</span> env_dom <span class="bound">env</span><span class="main">;</span> <span class="bound">y</span> <span class="main">∉</span> env_dom <span class="bound">env</span><span class="main">;</span> <span class="bound">s</span> <span class="main">≠</span> <span class="bound">p</span><span class="main">;</span>  <span class="bound">x</span> <span class="main">≠</span> <span class="bound">y</span><span class="main">;</span>
                             <span class="free">t</span> <span class="main">=</span> <span class="main">{</span><span class="bound">n</span> <span class="main">→</span> <span class="main">[</span>Fvar <span class="bound">s</span><span class="main">,</span>Fvar <span class="bound">p</span><span class="main">]}</span> <span class="bound">t'</span><span class="main">;</span> <span class="free">e</span> <span class="main">=</span> <span class="bound">env</span><span class="main">⦇</span><span class="bound">s</span><span class="main">:</span><span class="bound">A</span><span class="main">⦈</span><span class="main">⦇</span><span class="bound">p</span><span class="main">:</span><span class="bound">B</span><span class="main">⦈</span> <span class="main">⟧</span>
    <span class="main">⟹</span> <span class="bound">env</span><span class="main">⦇</span><span class="bound">x</span><span class="main">:</span><span class="bound">A</span><span class="main">⦈</span><span class="main">⦇</span><span class="bound">y</span><span class="main">:</span><span class="bound">B</span><span class="main">⦈</span> <span class="main">⊢</span> <span class="main">{</span><span class="bound">n</span> <span class="main">→</span> <span class="main">[</span>Fvar <span class="bound">x</span><span class="main">,</span>Fvar <span class="bound">y</span><span class="main">]}</span> <span class="bound">t'</span> <span class="main">:</span> <span class="free">C</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">set</span><span class="main"><span class="main">:</span></span>typing<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>T_Call <span class="skolem">env</span> <span class="skolem">t1</span> <span class="skolem">T</span> <span class="skolem">t2</span> <span class="skolem">l</span> <span class="skolem">env'</span> <span class="skolem">t'</span> <span class="skolem">s</span> <span class="skolem">p</span> <span class="skolem">x</span> <span class="skolem">y</span> <span class="skolem">A</span> <span class="skolem">B</span> <span class="skolem">n</span><span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> sopen_eq_Call<span class="main">[</span><span class="operator">OF</span> sym<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹Call <span class="skolem">t1</span> <span class="skolem">l</span> <span class="skolem">t2</span> <span class="main">=</span> <span class="main">{</span><span class="skolem">n</span> <span class="main">→</span> <span class="main">[</span>Fvar <span class="skolem">s</span><span class="main">,</span>Fvar <span class="skolem">p</span><span class="main">]}</span> <span class="skolem">t'</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>T_Var <span class="skolem">env</span> <span class="skolem">a</span> <span class="skolem">T</span> <span class="skolem">env'</span> <span class="skolem">t'</span> <span class="skolem">s</span> <span class="skolem">p</span> <span class="skolem">x</span> <span class="skolem">y</span> <span class="skolem">A</span> <span class="skolem">B</span> <span class="skolem">n</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹ok <span class="skolem">env</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">env</span> <span class="main">=</span> <span class="skolem">env'</span><span class="main">⦇</span><span class="skolem">s</span><span class="main">:</span><span class="skolem">A</span><span class="main">⦈</span><span class="main">⦇</span><span class="skolem">p</span><span class="main">:</span><span class="skolem">B</span><span class="main">⦈</span>›</span></span> ok_add_2<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">env'</span></span> <span class="quoted"><span class="skolem">s</span></span> <span class="quoted"><span class="skolem">A</span></span> <span class="quoted"><span class="skolem">p</span></span> <span class="quoted"><span class="skolem">B</span></span><span class="main">]</span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ok <span class="skolem">env'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> 
    ok_add_ok<span class="main">[</span><span class="operator">OF</span> ok_add_ok<span class="main"><span class="main">[</span></span><span class="operator">OF</span> this <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∉</span> env_dom <span class="skolem">env'</span>›</span></span><span class="main"><span class="main">]</span></span>
                 not_in_env_bigger<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">y</span> <span class="main">∉</span> env_dom <span class="skolem">env'</span>›</span></span> not_sym<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">≠</span> <span class="skolem">y</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> ok<span class="main">:</span> <span class="quoted"><span class="quoted">"ok <span class="main">(</span><span class="skolem">env'</span><span class="main">⦇</span><span class="skolem">x</span><span class="main">:</span><span class="skolem">A</span><span class="main">⦈</span><span class="main">⦇</span><span class="skolem">y</span><span class="main">:</span><span class="skolem">B</span><span class="main">⦈</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">assumption</span>

  <span class="keyword1"><span class="command">from</span></span> sopen_eq_Fvar<span class="main">[</span><span class="operator">OF</span> sym<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹Fvar <span class="skolem">a</span> <span class="main">=</span> <span class="main">{</span><span class="skolem">n</span> <span class="main">→</span> <span class="main">[</span>Fvar <span class="skolem">s</span><span class="main">,</span>Fvar <span class="skolem">p</span><span class="main">]}</span> <span class="skolem">t'</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span> 
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">elim</span> disjE conjE<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t'</span> <span class="main">=</span> Fvar <span class="skolem">a</span>"</span></span> <span class="keyword1"><span class="command">with</span></span> T_Var<span class="main">(</span>4-7<span class="main">)</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">≠</span> <span class="skolem">s</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">≠</span> <span class="skolem">p</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">≠</span> <span class="skolem">x</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">≠</span> <span class="skolem">y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">note</span></span> in_env_smaller2<span class="main">[</span><span class="operator">OF</span> _ this<span class="main"><span class="main">(</span></span>1-2<span class="main"><span class="main">)</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">a</span> <span class="main">∈</span> env_dom <span class="skolem">env</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">env</span> <span class="main">=</span> <span class="skolem">env'</span><span class="main">⦇</span><span class="skolem">s</span><span class="main">:</span><span class="skolem">A</span><span class="main">⦈</span><span class="main">⦇</span><span class="skolem">p</span><span class="main">:</span><span class="skolem">B</span><span class="main">⦈</span>›</span></span> this<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">env'</span></span> <span class="quoted"><span class="skolem">A</span></span> <span class="quoted"><span class="skolem">B</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∈</span> env_dom <span class="skolem">env'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">from</span></span> env_bigger2<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∉</span> env_dom <span class="skolem">env'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">y</span> <span class="main">∉</span> env_dom <span class="skolem">env'</span>›</span></span> this <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">≠</span> <span class="skolem">y</span>›</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> inenv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∈</span> env_dom <span class="main">(</span><span class="skolem">env'</span><span class="main">⦇</span><span class="skolem">x</span><span class="main">:</span><span class="skolem">A</span><span class="main">⦈</span><span class="main">⦇</span><span class="skolem">y</span><span class="main">:</span><span class="skolem">B</span><span class="main">⦈</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">assumption</span>
    <span class="keyword1"><span class="command">note</span></span> get_env_bigger2<span class="main">[</span><span class="operator">OF</span> _ <span class="quoted"><span class="quoted">‹<span class="skolem">a</span> <span class="main">≠</span> <span class="skolem">s</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">a</span> <span class="main">≠</span> <span class="skolem">p</span>›</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">from</span></span> 
      this<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">env'</span></span> <span class="quoted"><span class="skolem">A</span></span> <span class="quoted"><span class="skolem">B</span></span><span class="main">]</span> <span class="quoted"><span class="quoted">‹<span class="skolem">a</span> <span class="main">∈</span> env_dom <span class="skolem">env</span>›</span></span> <span class="quoted"><span class="quoted">‹the <span class="skolem">env</span><span class="main">!</span><span class="skolem">a</span> <span class="main">=</span> <span class="skolem">T</span>›</span></span> 
      <span class="quoted"><span class="quoted">‹<span class="skolem">env</span> <span class="main">=</span> <span class="skolem">env'</span><span class="main">⦇</span><span class="skolem">s</span><span class="main">:</span><span class="skolem">A</span><span class="main">⦈</span><span class="main">⦇</span><span class="skolem">p</span><span class="main">:</span><span class="skolem">B</span><span class="main">⦈</span>›</span></span> get_env_bigger2<span class="main">[</span><span class="operator">OF</span> inenv <span class="quoted"><span class="quoted">‹<span class="skolem">a</span> <span class="main">≠</span> <span class="skolem">x</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">a</span> <span class="main">≠</span> <span class="skolem">y</span>›</span></span><span class="main">]</span> 
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"the <span class="main">(</span><span class="skolem">env'</span><span class="main">⦇</span><span class="skolem">x</span><span class="main">:</span><span class="skolem">A</span><span class="main">⦈</span><span class="main">⦇</span><span class="skolem">y</span><span class="main">:</span><span class="skolem">B</span><span class="main">⦈</span><span class="main">!</span><span class="skolem">a</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">T</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">from</span></span> typing.T_Var<span class="main">[</span><span class="operator">OF</span> ok inenv this<span class="main">]</span> <span class="quoted"><span class="quoted">‹<span class="skolem">t'</span> <span class="main">=</span> Fvar <span class="skolem">a</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">=</span> <span class="skolem">s</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t'</span> <span class="main">=</span> Bvar <span class="main">(</span>Self <span class="skolem">n</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> 
      this<span class="main">(</span>1<span class="main">)</span> <span class="quoted"><span class="quoted">‹ok <span class="skolem">env</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">env</span> <span class="main">=</span> <span class="skolem">env'</span><span class="main">⦇</span><span class="skolem">s</span><span class="main">:</span><span class="skolem">A</span><span class="main">⦈</span><span class="main">⦇</span><span class="skolem">p</span><span class="main">:</span><span class="skolem">B</span><span class="main">⦈</span>›</span></span> <span class="quoted"><span class="quoted">‹the <span class="skolem">env</span><span class="main">!</span><span class="skolem">a</span> <span class="main">=</span> <span class="skolem">T</span>›</span></span> 
      add_get2_1<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">env'</span></span> <span class="quoted"><span class="skolem">s</span></span> <span class="quoted"><span class="skolem">A</span></span> <span class="quoted"><span class="skolem">p</span></span> <span class="quoted"><span class="skolem">B</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">T</span> <span class="main">=</span> <span class="skolem">A</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">t'</span> <span class="main">=</span> Bvar <span class="main">(</span>Self <span class="skolem">n</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="skolem">n</span> <span class="main">→</span> <span class="main">[</span>Fvar <span class="skolem">x</span><span class="main">,</span>Fvar <span class="skolem">y</span><span class="main">]}</span> <span class="skolem">t'</span> <span class="main">=</span> Fvar <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">ultimately</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> in_add_2<span class="main">[</span><span class="operator">OF</span> ok<span class="main">]</span> typing.T_Var<span class="main">[</span><span class="operator">OF</span> ok _ add_get2_1<span class="main"><span class="main">[</span></span><span class="operator">OF</span> ok<span class="main"><span class="main">]</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword1"><span class="command">note</span></span> subst <span class="main">=</span> subst_add<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">≠</span> <span class="skolem">y</span>›</span></span><span class="main">]</span> 
    <span class="keyword1"><span class="command">from</span></span> subst<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">env'</span></span> <span class="quoted"><span class="skolem">A</span></span> <span class="quoted"><span class="skolem">B</span></span><span class="main">]</span> ok <span class="keyword1"><span class="command">have</span></span> ok'<span class="main">:</span> <span class="quoted"><span class="quoted">"ok <span class="main">(</span><span class="skolem">env'</span><span class="main">⦇</span><span class="skolem">y</span><span class="main">:</span><span class="skolem">B</span><span class="main">⦈</span><span class="main">⦇</span><span class="skolem">x</span><span class="main">:</span><span class="skolem">A</span><span class="main">⦈</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">=</span> <span class="skolem">p</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t'</span> <span class="main">=</span> Bvar <span class="main">(</span>Param <span class="skolem">n</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> 
      this<span class="main">(</span>1<span class="main">)</span> <span class="quoted"><span class="quoted">‹ok <span class="skolem">env</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">env</span> <span class="main">=</span> <span class="skolem">env'</span><span class="main">⦇</span><span class="skolem">s</span><span class="main">:</span><span class="skolem">A</span><span class="main">⦈</span><span class="main">⦇</span><span class="skolem">p</span><span class="main">:</span><span class="skolem">B</span><span class="main">⦈</span>›</span></span> <span class="quoted"><span class="quoted">‹the <span class="skolem">env</span><span class="main">!</span><span class="skolem">a</span> <span class="main">=</span> <span class="skolem">T</span>›</span></span>
      add_get2_2<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">env'</span></span> <span class="quoted"><span class="skolem">s</span></span> <span class="quoted"><span class="skolem">A</span></span> <span class="quoted"><span class="skolem">p</span></span> <span class="quoted"><span class="skolem">B</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">T</span> <span class="main">=</span> <span class="skolem">B</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">t'</span> <span class="main">=</span> Bvar <span class="main">(</span>Param <span class="skolem">n</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="skolem">n</span> <span class="main">→</span> <span class="main">[</span>Fvar <span class="skolem">x</span><span class="main">,</span>Fvar <span class="skolem">y</span><span class="main">]}</span> <span class="skolem">t'</span> <span class="main">=</span> Fvar <span class="skolem">y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">ultimately</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
      <span class="keyword1"><span class="command">using</span></span> 
        subst<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">env'</span></span> <span class="quoted"><span class="skolem">A</span></span> <span class="quoted"><span class="skolem">B</span></span><span class="main">]</span> in_add_2<span class="main">[</span><span class="operator">OF</span> ok'<span class="main">]</span> 
        typing.T_Var<span class="main">[</span><span class="operator">OF</span> ok' _ add_get2_1<span class="main"><span class="main">[</span></span><span class="operator">OF</span> ok'<span class="main"><span class="main">]</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>T_Upd <span class="skolem">F</span> <span class="skolem">env</span> <span class="skolem">T</span> <span class="skolem">l</span> <span class="skolem">t2</span> <span class="skolem">t1</span> <span class="skolem">env'</span> <span class="skolem">t'</span> <span class="skolem">s</span> <span class="skolem">p</span> <span class="skolem">x</span> <span class="skolem">y</span> <span class="skolem">A</span> <span class="skolem">B</span> <span class="skolem">n</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> sopen_eq_Upd<span class="main">[</span><span class="operator">OF</span> sym<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹Upd <span class="skolem">t1</span> <span class="skolem">l</span> <span class="skolem">t2</span> <span class="main">=</span> <span class="main">{</span><span class="skolem">n</span> <span class="main">→</span> <span class="main">[</span>Fvar <span class="skolem">s</span><span class="main">,</span>Fvar <span class="skolem">p</span><span class="main">]}</span> <span class="skolem">t'</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t1'</span></span> <span class="skolem"><span class="skolem">t2'</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
    t1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t1</span> <span class="main">=</span> <span class="main">{</span><span class="skolem">n</span> <span class="main">→</span> <span class="main">[</span>Fvar <span class="skolem">s</span><span class="main">,</span>Fvar <span class="skolem">p</span><span class="main">]}</span> <span class="skolem">t1'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    t2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t2</span> <span class="main">=</span> <span class="main">{</span>Suc <span class="skolem">n</span> <span class="main">→</span> <span class="main">[</span>Fvar <span class="skolem">s</span><span class="main">,</span>Fvar <span class="skolem">p</span><span class="main">]}</span> <span class="skolem">t2'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    t'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t'</span> <span class="main">=</span> Upd <span class="skolem">t1'</span> <span class="skolem">l</span> <span class="skolem">t2'</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∉</span> FV <span class="skolem">t'</span>"</span></span> <span class="keyword1"><span class="command">with</span></span> t' <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∉</span> FV <span class="skolem">t1'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> <span class="keyword1"><span class="command">}</span></span> 
  <span class="keyword1"><span class="command">note</span></span> 
    t1' <span class="main">=</span> T_Upd<span class="main">(</span>4<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> this<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">s</span> <span class="main">∉</span> FV <span class="skolem">t'</span>›</span></span><span class="main"><span class="main">]</span></span> this<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="main">∉</span> FV <span class="skolem">t'</span>›</span></span><span class="main"><span class="main">]</span></span> 
                      this<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∉</span> FV <span class="skolem">t'</span>›</span></span><span class="main"><span class="main">]</span></span> this<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">y</span> <span class="main">∉</span> FV <span class="skolem">t'</span>›</span></span><span class="main"><span class="main">]</span></span> 
                      <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∉</span> env_dom <span class="skolem">env'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">y</span> <span class="main">∉</span> env_dom <span class="skolem">env'</span>›</span></span>
                      <span class="quoted"><span class="quoted">‹<span class="skolem">s</span> <span class="main">≠</span> <span class="skolem">p</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">≠</span> <span class="skolem">y</span>›</span></span> t1 <span class="quoted"><span class="quoted">‹<span class="skolem">env</span> <span class="main">=</span> <span class="skolem">env'</span><span class="main">⦇</span><span class="skolem">s</span><span class="main">:</span><span class="skolem">A</span><span class="main">⦈</span><span class="main">⦇</span><span class="skolem">p</span><span class="main">:</span><span class="skolem">B</span><span class="main">⦈</span>›</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">from</span></span> ok_finite<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">env'</span></span><span class="main">]</span> ok_add_2<span class="main">[</span><span class="operator">OF</span> typing_regular'<span class="main"><span class="main">[</span></span><span class="operator">OF</span> this<span class="main"><span class="main">]</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> findom<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>env_dom <span class="skolem">env'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∉</span> FV <span class="skolem">t'</span>"</span></span> <span class="keyword1"><span class="command">with</span></span> t' <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∉</span> FV <span class="skolem">t2'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">note</span></span> 
    bnd_renaming_lem<span class="main">[</span><span class="operator">OF</span> this<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">s</span> <span class="main">∉</span> FV <span class="skolem">t'</span>›</span></span><span class="main"><span class="main">]</span></span> this<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="main">∉</span> FV <span class="skolem">t'</span>›</span></span><span class="main"><span class="main">]</span></span> 
                        this<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∉</span> FV <span class="skolem">t'</span>›</span></span><span class="main"><span class="main">]</span></span> this<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">y</span> <span class="main">∉</span> FV <span class="skolem">t'</span>›</span></span><span class="main"><span class="main">]</span></span> 
                        <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∉</span> env_dom <span class="skolem">env'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">y</span> <span class="main">∉</span> env_dom <span class="skolem">env'</span>›</span></span>
                        <span class="quoted"><span class="quoted">‹<span class="skolem">s</span> <span class="main">≠</span> <span class="skolem">p</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">≠</span> <span class="skolem">y</span>›</span></span> t2 <span class="quoted"><span class="quoted">‹<span class="skolem">env</span> <span class="main">=</span> <span class="skolem">env'</span><span class="main">⦇</span><span class="skolem">s</span><span class="main">:</span><span class="skolem">A</span><span class="main">⦈</span><span class="main">⦇</span><span class="skolem">p</span><span class="main">:</span><span class="skolem">B</span><span class="main">⦈</span>›</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">from</span></span> this<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">F</span></span> <span class="quoted"><span class="skolem">T</span></span> <span class="quoted"><span class="skolem">l</span></span> <span class="quoted"><span class="quoted">"FV <span class="skolem">t2'</span>"</span></span><span class="main">]</span> T_Upd<span class="main">(</span>2<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> 
    <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">sa</span> <span class="bound">pa</span><span class="main">.</span> <span class="bound">sa</span> <span class="main">∉</span> <span class="skolem">F</span> <span class="main">∪</span> <span class="main">{</span><span class="skolem">s</span><span class="main">,</span> <span class="skolem">p</span><span class="main">,</span> <span class="skolem">x</span><span class="main">,</span> <span class="skolem">y</span><span class="main">}</span> <span class="main">∪</span> FV <span class="skolem">t2'</span> <span class="main">∪</span> env_dom <span class="skolem">env'</span> 
           <span class="main">∧</span> <span class="bound">pa</span> <span class="main">∉</span> <span class="skolem">F</span> <span class="main">∪</span> <span class="main">{</span><span class="skolem">s</span><span class="main">,</span> <span class="skolem">p</span><span class="main">,</span> <span class="skolem">x</span><span class="main">,</span> <span class="skolem">y</span><span class="main">}</span> <span class="main">∪</span> FV <span class="skolem">t2'</span> <span class="main">∪</span> env_dom <span class="skolem">env'</span> 
           <span class="main">∧</span> <span class="bound">sa</span> <span class="main">≠</span> <span class="bound">pa</span> 
      <span class="main">⟶</span> <span class="skolem">env'</span><span class="main">⦇</span><span class="skolem">x</span><span class="main">:</span><span class="skolem">A</span><span class="main">⦈</span><span class="main">⦇</span><span class="skolem">y</span><span class="main">:</span><span class="skolem">B</span><span class="main">⦈</span><span class="main">⦇</span><span class="bound">sa</span><span class="main">:</span><span class="skolem">T</span><span class="main">⦈</span><span class="main">⦇</span><span class="bound">pa</span><span class="main">:</span>param<span class="main">(</span>the<span class="main">(</span><span class="skolem">T</span><span class="main">^</span><span class="skolem">l</span><span class="main">)</span><span class="main">)</span><span class="main">⦈</span>
          <span class="main">⊢</span> <span class="main">(</span><span class="main">{</span>Suc <span class="skolem">n</span> <span class="main">→</span> <span class="main">[</span>Fvar <span class="skolem">x</span><span class="main">,</span>Fvar <span class="skolem">y</span><span class="main">]}</span> <span class="skolem">t2'</span><span class="hidden">⇗</span><sup>[Fvar <span class="bound">sa</span><span class="main">,</span>Fvar <span class="bound">pa</span>]</sup><span class="hidden">⇖</span><span class="main">)</span> <span class="main">:</span> return<span class="main">(</span>the<span class="main">(</span><span class="skolem">T</span><span class="main">^</span><span class="skolem">l</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> 
    typing.T_Upd<span class="main">[</span><span class="operator">OF</span> _ this t1' <span class="quoted"><span class="quoted">‹<span class="skolem">l</span> <span class="main">∈</span> do <span class="skolem">T</span>›</span></span><span class="main">]</span>
    <span class="quoted"><span class="quoted">‹finite <span class="skolem">F</span>›</span></span> findom t' 
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>T_Obj <span class="skolem">env</span> <span class="skolem">f</span> <span class="skolem">T</span> <span class="skolem">F</span> <span class="skolem">env'</span> <span class="skolem">t'</span> <span class="skolem">s</span> <span class="skolem">p</span> <span class="skolem">x</span> <span class="skolem">y</span> <span class="skolem">A</span> <span class="skolem">B</span> <span class="skolem">n</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹ok <span class="skolem">env</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">env</span> <span class="main">=</span> <span class="skolem">env'</span><span class="main">⦇</span><span class="skolem">s</span><span class="main">:</span><span class="skolem">A</span><span class="main">⦈</span><span class="main">⦇</span><span class="skolem">p</span><span class="main">:</span><span class="skolem">B</span><span class="main">⦈</span>›</span></span> ok_add_2<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">env'</span></span> <span class="quoted"><span class="skolem">s</span></span> <span class="quoted"><span class="skolem">A</span></span> <span class="quoted"><span class="skolem">p</span></span> <span class="quoted"><span class="skolem">B</span></span><span class="main">]</span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ok <span class="skolem">env'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> 
    ok_add_ok<span class="main">[</span><span class="operator">OF</span> ok_add_ok<span class="main"><span class="main">[</span></span><span class="operator">OF</span> this <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∉</span> env_dom <span class="skolem">env'</span>›</span></span><span class="main"><span class="main">]</span></span>
                 not_in_env_bigger<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">y</span> <span class="main">∉</span> env_dom <span class="skolem">env'</span>›</span></span> not_sym<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">≠</span> <span class="skolem">y</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> ok<span class="main">:</span> <span class="quoted"><span class="quoted">"ok <span class="main">(</span><span class="skolem">env'</span><span class="main">⦇</span><span class="skolem">x</span><span class="main">:</span><span class="skolem">A</span><span class="main">⦈</span><span class="main">⦇</span><span class="skolem">y</span><span class="main">:</span><span class="skolem">B</span><span class="main">⦈</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">assumption</span>
  <span class="keyword1"><span class="command">from</span></span> sopen_eq_Obj<span class="main">[</span><span class="operator">OF</span> sym<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹Obj <span class="skolem">f</span> <span class="skolem">T</span> <span class="main">=</span> <span class="main">{</span><span class="skolem">n</span> <span class="main">→</span> <span class="main">[</span>Fvar <span class="skolem">s</span><span class="main">,</span>Fvar <span class="skolem">p</span><span class="main">]}</span> <span class="skolem">t'</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span> 
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">f'</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
    obj<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="skolem">n</span> <span class="main">→</span> <span class="main">[</span>Fvar <span class="skolem">s</span><span class="main">,</span>Fvar <span class="skolem">p</span><span class="main">]}</span> Obj <span class="skolem">f'</span> <span class="skolem">T</span> <span class="main">=</span> Obj <span class="skolem">f</span> <span class="skolem">T</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    t'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t'</span> <span class="main">=</span> Obj <span class="skolem">f'</span> <span class="skolem">T</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> 
    this<span class="main">(</span>1<span class="main">)</span> <span class="quoted"><span class="quoted">‹dom <span class="skolem">f</span> <span class="main">=</span> do <span class="skolem">T</span>›</span></span>
    sym<span class="main">[</span><span class="operator">OF</span> dom_sopenoption_lem<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">n</span>"</span></span> <span class="quoted"><span class="quoted">"Fvar <span class="skolem">s</span>"</span></span> <span class="quoted"><span class="quoted">"Fvar <span class="skolem">p</span>"</span></span> <span class="quoted"><span class="skolem">f'</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span>
    dom_sopenoption_lem<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">n</span>"</span></span> <span class="quoted"><span class="quoted">"Fvar <span class="skolem">x</span>"</span></span> <span class="quoted"><span class="quoted">"Fvar <span class="skolem">y</span>"</span></span> <span class="quoted"><span class="skolem">f'</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> dom<span class="main">:</span> <span class="quoted"><span class="quoted">"dom <span class="main">(</span><span class="main">λ</span><span class="bound">l</span><span class="main">.</span> sopen_option <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="main">(</span>Fvar <span class="skolem">x</span><span class="main">)</span> <span class="main">(</span>Fvar <span class="skolem">y</span><span class="main">)</span> <span class="main">(</span><span class="skolem">f'</span> <span class="bound">l</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> do <span class="skolem">T</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    
  <span class="keyword1"><span class="command">from</span></span> 
    <span class="quoted"><span class="quoted">‹finite <span class="skolem">F</span>›</span></span> finite_FV<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"Obj <span class="skolem">f'</span> <span class="skolem">T</span>"</span></span><span class="main">]</span> 
    ok_finite<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">env'</span></span><span class="main">]</span> ok_add_2<span class="main">[</span><span class="operator">OF</span> ok<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> finF<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="skolem">F</span> <span class="main">∪</span> <span class="main">{</span><span class="skolem">s</span><span class="main">,</span><span class="skolem">p</span><span class="main">,</span><span class="skolem">x</span><span class="main">,</span><span class="skolem">y</span><span class="main">}</span> <span class="main">∪</span>  FV <span class="main">(</span>Obj <span class="skolem">f'</span> <span class="skolem">T</span><span class="main">)</span> <span class="main">∪</span> env_dom <span class="skolem">env'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command">have</span></span> 
    <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">l</span><span class="main">∈</span>do <span class="skolem">T</span><span class="main">.</span> <span class="main">∀</span><span class="bound">sa</span> <span class="bound">pa</span><span class="main">.</span> <span class="bound">sa</span> <span class="main">∉</span> <span class="skolem">F</span> <span class="main">∪</span> <span class="main">{</span><span class="skolem">s</span><span class="main">,</span> <span class="skolem">p</span><span class="main">,</span> <span class="skolem">x</span><span class="main">,</span> <span class="skolem">y</span><span class="main">}</span> <span class="main">∪</span> FV <span class="main">(</span>Obj <span class="skolem">f'</span> <span class="skolem">T</span><span class="main">)</span> <span class="main">∪</span> env_dom <span class="skolem">env'</span> 
                     <span class="main">∧</span> <span class="bound">pa</span> <span class="main">∉</span> <span class="skolem">F</span> <span class="main">∪</span> <span class="main">{</span><span class="skolem">s</span><span class="main">,</span> <span class="skolem">p</span><span class="main">,</span> <span class="skolem">x</span><span class="main">,</span> <span class="skolem">y</span><span class="main">}</span> <span class="main">∪</span> FV <span class="main">(</span>Obj <span class="skolem">f'</span> <span class="skolem">T</span><span class="main">)</span> <span class="main">∪</span> env_dom <span class="skolem">env'</span> 
                     <span class="main">∧</span> <span class="bound">sa</span> <span class="main">≠</span> <span class="bound">pa</span> 
      <span class="main">⟶</span> <span class="skolem">env'</span><span class="main">⦇</span><span class="skolem">x</span><span class="main">:</span><span class="skolem">A</span><span class="main">⦈</span><span class="main">⦇</span><span class="skolem">y</span><span class="main">:</span><span class="skolem">B</span><span class="main">⦈</span><span class="main">⦇</span><span class="bound">sa</span><span class="main">:</span><span class="skolem">T</span><span class="main">⦈</span><span class="main">⦇</span><span class="bound">pa</span><span class="main">:</span>param<span class="main">(</span>the<span class="main">(</span><span class="skolem">T</span><span class="main">^</span><span class="bound">l</span><span class="main">)</span><span class="main">)</span><span class="main">⦈</span>
          <span class="main">⊢</span> <span class="main">(</span>the<span class="main">(</span>sopen_option <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="main">(</span>Fvar <span class="skolem">x</span><span class="main">)</span> <span class="main">(</span>Fvar <span class="skolem">y</span><span class="main">)</span> <span class="main">(</span><span class="skolem">f'</span> <span class="bound">l</span><span class="main">)</span><span class="main">)</span><span class="hidden">⇗</span><sup>[Fvar <span class="bound">sa</span><span class="main">,</span>Fvar <span class="bound">pa</span>]</sup><span class="hidden">⇖</span><span class="main">)</span> <span class="main">:</span> 
          return<span class="main">(</span>the<span class="main">(</span><span class="skolem">T</span><span class="main">^</span><span class="bound">l</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> 
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">l</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">∈</span> do <span class="skolem">T</span>"</span></span> <span class="keyword1"><span class="command">with</span></span> T_Obj<span class="main">(</span>4<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> cof<span class="main">:</span> 
      <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">sa</span> <span class="bound">pa</span><span class="main">.</span> <span class="bound">sa</span> <span class="main">∉</span> <span class="skolem">F</span> <span class="main">∧</span> <span class="bound">pa</span> <span class="main">∉</span> <span class="skolem">F</span> <span class="main">∧</span> <span class="bound">sa</span> <span class="main">≠</span> <span class="bound">pa</span>
        <span class="main">⟶</span> <span class="skolem">env</span><span class="main">⦇</span><span class="bound">sa</span><span class="main">:</span><span class="skolem">T</span><span class="main">⦈</span><span class="main">⦇</span><span class="bound">pa</span><span class="main">:</span>param<span class="main">(</span>the<span class="main">(</span><span class="skolem">T</span><span class="main">^</span><span class="skolem">l</span><span class="main">)</span><span class="main">)</span><span class="main">⦈</span>
            <span class="main">⊢</span> <span class="main">(</span>the<span class="main">(</span><span class="skolem">f</span> <span class="skolem">l</span><span class="main">)</span><span class="hidden">⇗</span><sup>[Fvar <span class="bound">sa</span><span class="main">,</span>Fvar <span class="bound">pa</span>]</sup><span class="hidden">⇖</span><span class="main">)</span> <span class="main">:</span> return<span class="main">(</span>the<span class="main">(</span><span class="skolem">T</span><span class="main">^</span><span class="skolem">l</span><span class="main">)</span><span class="main">)</span>
          <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">env''</span> <span class="bound">t''</span> <span class="bound">s'</span> <span class="bound">p'</span> <span class="bound">x'</span> <span class="bound">y'</span> <span class="bound">A'</span> <span class="bound">B'</span> <span class="bound">n'</span><span class="main">.</span>
               <span class="bound">s'</span> <span class="main">∉</span> FV <span class="bound">t''</span> <span class="main">⟶</span> <span class="bound">p'</span> <span class="main">∉</span> FV <span class="bound">t''</span> <span class="main">⟶</span> <span class="bound">x'</span> <span class="main">∉</span> FV <span class="bound">t''</span> <span class="main">⟶</span> <span class="bound">y'</span> <span class="main">∉</span> FV <span class="bound">t''</span> 
               <span class="main">⟶</span> <span class="bound">x'</span> <span class="main">∉</span> env_dom <span class="bound">env''</span> <span class="main">⟶</span> <span class="bound">y'</span> <span class="main">∉</span> env_dom <span class="bound">env''</span> <span class="main">⟶</span> <span class="bound">x'</span> <span class="main">≠</span> <span class="bound">y'</span> 
               <span class="main">⟶</span> <span class="bound">s'</span> <span class="main">≠</span> <span class="bound">p'</span> 
               <span class="main">⟶</span> <span class="main">(</span>the<span class="main">(</span><span class="skolem">f</span> <span class="skolem">l</span><span class="main">)</span><span class="hidden">⇗</span><sup>[Fvar <span class="bound">sa</span><span class="main">,</span>Fvar <span class="bound">pa</span>]</sup><span class="hidden">⇖</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="bound">n'</span> <span class="main">→</span> <span class="main">[</span>Fvar <span class="bound">s'</span><span class="main">,</span>Fvar <span class="bound">p'</span><span class="main">]}</span> <span class="bound">t''</span> 
               <span class="main">⟶</span> <span class="skolem">env</span><span class="main">⦇</span><span class="bound">sa</span><span class="main">:</span><span class="skolem">T</span><span class="main">⦈</span><span class="main">⦇</span><span class="bound">pa</span><span class="main">:</span>param<span class="main">(</span>the<span class="main">(</span><span class="skolem">T</span><span class="main">^</span><span class="skolem">l</span><span class="main">)</span><span class="main">)</span><span class="main">⦈</span> <span class="main">=</span> <span class="bound">env''</span><span class="main">⦇</span><span class="bound">s'</span><span class="main">:</span><span class="bound">A'</span><span class="main">⦈</span><span class="main">⦇</span><span class="bound">p'</span><span class="main">:</span><span class="bound">B'</span><span class="main">⦈</span> 
               <span class="main">⟶</span> <span class="bound">env''</span><span class="main">⦇</span><span class="bound">x'</span><span class="main">:</span><span class="bound">A'</span><span class="main">⦈</span><span class="main">⦇</span><span class="bound">y'</span><span class="main">:</span><span class="bound">B'</span><span class="main">⦈</span>
                   <span class="main">⊢</span> <span class="main">{</span><span class="bound">n'</span> <span class="main">→</span> <span class="main">[</span>Fvar <span class="bound">x'</span><span class="main">,</span>Fvar <span class="bound">y'</span><span class="main">]}</span> <span class="bound">t''</span> <span class="main">:</span> return<span class="main">(</span>the<span class="main">(</span><span class="skolem">T</span><span class="main">^</span><span class="skolem">l</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">from</span></span> 
      <span class="quoted"><span class="quoted">‹<span class="skolem">l</span> <span class="main">∈</span> do <span class="skolem">T</span>›</span></span> <span class="quoted"><span class="quoted">‹dom <span class="skolem">f</span> <span class="main">=</span> do <span class="skolem">T</span>›</span></span> <span class="quoted"><span class="quoted">‹Obj <span class="skolem">f</span> <span class="skolem">T</span> <span class="main">=</span> <span class="main">{</span><span class="skolem">n</span> <span class="main">→</span> <span class="main">[</span>Fvar <span class="skolem">s</span><span class="main">,</span>Fvar <span class="skolem">p</span><span class="main">]}</span> <span class="skolem">t'</span>›</span></span> obj t'
      dom_sopenoption_lem<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">n</span>"</span></span> <span class="quoted"><span class="quoted">"Fvar <span class="skolem">s</span>"</span></span> <span class="quoted"><span class="quoted">"Fvar <span class="skolem">p</span>"</span></span> <span class="quoted"><span class="skolem">f'</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> indomf'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">∈</span> dom <span class="skolem">f'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> 
      opened<span class="main">:</span> <span class="quoted"><span class="quoted">"the <span class="main">(</span>sopen_option <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="main">(</span>Fvar <span class="skolem">x</span><span class="main">)</span> <span class="main">(</span>Fvar <span class="skolem">y</span><span class="main">)</span> <span class="main">(</span><span class="skolem">f'</span> <span class="skolem">l</span><span class="main">)</span><span class="main">)</span> 
               <span class="main">=</span> <span class="main">{</span>Suc <span class="skolem">n</span> <span class="main">→</span> <span class="main">[</span>Fvar <span class="skolem">x</span><span class="main">,</span>Fvar <span class="skolem">y</span><span class="main">]}</span> the<span class="main">(</span><span class="skolem">f'</span> <span class="skolem">l</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">from</span></span> indomf' <span class="keyword1"><span class="command">have</span></span> FVsubset<span class="main">:</span> <span class="quoted"><span class="quoted">"FV <span class="main">(</span>the<span class="main">(</span><span class="skolem">f'</span> <span class="skolem">l</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> FV <span class="main">(</span>Obj <span class="skolem">f'</span> <span class="skolem">T</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">with</span></span> 
      <span class="quoted"><span class="quoted">‹<span class="skolem">s</span> <span class="main">∉</span> FV <span class="skolem">t'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="main">∉</span> FV <span class="skolem">t'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∉</span> FV <span class="skolem">t'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">y</span> <span class="main">∉</span> FV <span class="skolem">t'</span>›</span></span> obj t'
      indomf' FV_option_lem<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">f'</span></span><span class="main">]</span>
    <span class="keyword3"><span class="command">obtain</span></span> 
      <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∉</span> FV <span class="main">(</span>the<span class="main">(</span><span class="skolem">f'</span> <span class="skolem">l</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∉</span> FV <span class="main">(</span>the<span class="main">(</span><span class="skolem">f'</span> <span class="skolem">l</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> FV <span class="main">(</span>the<span class="main">(</span><span class="skolem">f'</span> <span class="skolem">l</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∉</span> FV <span class="main">(</span>the<span class="main">(</span><span class="skolem">f'</span> <span class="skolem">l</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      <span class="quoted"><span class="quoted">"the<span class="main">(</span><span class="skolem">f</span> <span class="skolem">l</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span>Suc <span class="skolem">n</span> <span class="main">→</span> <span class="main">[</span>Fvar <span class="skolem">s</span><span class="main">,</span>Fvar <span class="skolem">p</span><span class="main">]}</span> the<span class="main">(</span><span class="skolem">f'</span> <span class="skolem">l</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> 
      bnd_renaming_lem<span class="main">[</span><span class="operator">OF</span> this<span class="main"><span class="main">(</span></span>1-4<span class="main"><span class="main">)</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∉</span> env_dom <span class="skolem">env'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">y</span> <span class="main">∉</span> env_dom <span class="skolem">env'</span>›</span></span>
                          <span class="quoted"><span class="quoted">‹<span class="skolem">s</span> <span class="main">≠</span> <span class="skolem">p</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">≠</span> <span class="skolem">y</span>›</span></span> this<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">env</span> <span class="main">=</span> <span class="skolem">env'</span><span class="main">⦇</span><span class="skolem">s</span><span class="main">:</span><span class="skolem">A</span><span class="main">⦈</span><span class="main">⦇</span><span class="skolem">p</span><span class="main">:</span><span class="skolem">B</span><span class="main">⦈</span>›</span></span> 
                          cof FVsubset<span class="main">]</span>
    <span class="keyword3"><span class="command">show</span></span> 
      <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">sa</span> <span class="bound">pa</span><span class="main">.</span> <span class="bound">sa</span> <span class="main">∉</span> <span class="skolem">F</span> <span class="main">∪</span> <span class="main">{</span><span class="skolem">s</span><span class="main">,</span> <span class="skolem">p</span><span class="main">,</span> <span class="skolem">x</span><span class="main">,</span> <span class="skolem">y</span><span class="main">}</span> <span class="main">∪</span> FV <span class="main">(</span>Obj <span class="skolem">f'</span> <span class="skolem">T</span><span class="main">)</span> <span class="main">∪</span> env_dom <span class="skolem">env'</span> 
             <span class="main">∧</span> <span class="bound">pa</span> <span class="main">∉</span> <span class="skolem">F</span> <span class="main">∪</span> <span class="main">{</span><span class="skolem">s</span><span class="main">,</span> <span class="skolem">p</span><span class="main">,</span> <span class="skolem">x</span><span class="main">,</span> <span class="skolem">y</span><span class="main">}</span> <span class="main">∪</span> FV <span class="main">(</span>Obj <span class="skolem">f'</span> <span class="skolem">T</span><span class="main">)</span> <span class="main">∪</span> env_dom <span class="skolem">env'</span> 
             <span class="main">∧</span> <span class="bound">sa</span> <span class="main">≠</span> <span class="bound">pa</span> 
        <span class="main">⟶</span> <span class="skolem">env'</span><span class="main">⦇</span><span class="skolem">x</span><span class="main">:</span><span class="skolem">A</span><span class="main">⦈</span><span class="main">⦇</span><span class="skolem">y</span><span class="main">:</span><span class="skolem">B</span><span class="main">⦈</span><span class="main">⦇</span><span class="bound">sa</span><span class="main">:</span><span class="skolem">T</span><span class="main">⦈</span><span class="main">⦇</span><span class="bound">pa</span><span class="main">:</span>param<span class="main">(</span>the<span class="main">(</span><span class="skolem">T</span><span class="main">^</span><span class="skolem">l</span><span class="main">)</span><span class="main">)</span><span class="main">⦈</span>
            <span class="main">⊢</span> <span class="main">(</span>the<span class="main">(</span>sopen_option <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="main">(</span>Fvar <span class="skolem">x</span><span class="main">)</span> <span class="main">(</span>Fvar <span class="skolem">y</span><span class="main">)</span> <span class="main">(</span><span class="skolem">f'</span> <span class="skolem">l</span><span class="main">)</span><span class="main">)</span><span class="hidden">⇗</span><sup>[Fvar <span class="bound">sa</span><span class="main">,</span>Fvar <span class="bound">pa</span>]</sup><span class="hidden">⇖</span><span class="main">)</span> <span class="main">:</span> 
              return<span class="main">(</span>the<span class="main">(</span><span class="skolem">T</span><span class="main">^</span><span class="skolem">l</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> opened<span class="main"><span class="keyword3">,</span></span> <span class="operator">assumption</span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">from</span></span> typing.T_Obj<span class="main">[</span><span class="operator">OF</span> ok dom finF this<span class="main">]</span> t' <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="TypedSigma-type_renaming"><span class="command">lemma</span></span> type_renaming<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">e</span><span class="main">⦇</span><span class="free">s</span><span class="main">:</span><span class="free">A</span><span class="main">⦈</span><span class="main">⦇</span><span class="free">p</span><span class="main">:</span><span class="free">B</span><span class="main">⦈</span> <span class="main">⊢</span> <span class="main">{</span><span class="free">n</span> <span class="main">→</span> <span class="main">[</span>Fvar <span class="free">s</span><span class="main">,</span>Fvar <span class="free">p</span><span class="main">]}</span> <span class="free">t</span> <span class="main">:</span> <span class="free">T</span><span class="main">;</span> 
     <span class="free">s</span> <span class="main">∉</span> FV <span class="free">t</span><span class="main">;</span> <span class="free">p</span> <span class="main">∉</span> FV <span class="free">t</span><span class="main">;</span> <span class="free">x</span> <span class="main">∉</span> FV <span class="free">t</span><span class="main">;</span> <span class="free">y</span> <span class="main">∉</span> FV <span class="free">t</span><span class="main">;</span> 
     <span class="free">x</span> <span class="main">∉</span> env_dom <span class="free">e</span><span class="main">;</span> <span class="free">y</span> <span class="main">∉</span> env_dom <span class="free">e</span><span class="main">;</span> <span class="free">x</span> <span class="main">≠</span> <span class="free">y</span><span class="main">;</span> <span class="free">s</span> <span class="main">≠</span> <span class="free">p</span><span class="main">⟧</span> 
  <span class="main">⟹</span> <span class="free">e</span><span class="main">⦇</span><span class="free">x</span><span class="main">:</span><span class="free">A</span><span class="main">⦈</span><span class="main">⦇</span><span class="free">y</span><span class="main">:</span><span class="free">B</span><span class="main">⦈</span> <span class="main">⊢</span> <span class="main">{</span><span class="free">n</span> <span class="main">→</span> <span class="main">[</span>Fvar <span class="free">x</span><span class="main">,</span>Fvar <span class="free">y</span><span class="main">]}</span> <span class="free">t</span> <span class="main">:</span> <span class="free">T</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> type_renaming'<span class="main">)</span>
<span class="comment1">(* too weak, as we need specific s,p *)</span>

<span class="keyword1" id="TypedSigma-obj_inv_elim'"><span class="command">lemma</span></span> obj_inv_elim'<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">e</span> <span class="main">⊢</span> Obj <span class="free">f</span> <span class="free">U</span> <span class="main">:</span> <span class="free">U</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 
  nin_s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">∉</span> FV <span class="main">(</span>Obj <span class="free">f</span> <span class="free">U</span><span class="main">)</span> <span class="main">∪</span> env_dom <span class="free">e</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  nin_p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∉</span> FV <span class="main">(</span>Obj <span class="free">f</span> <span class="free">U</span><span class="main">)</span> <span class="main">∪</span> env_dom <span class="free">e</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">≠</span> <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> 
  <span class="quoted"><span class="quoted">"<span class="main">(</span>dom <span class="free">f</span> <span class="main">=</span> do <span class="free">U</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">l</span><span class="main">∈</span>do <span class="free">U</span><span class="main">.</span> <span class="free">e</span><span class="main">⦇</span><span class="free">s</span><span class="main">:</span><span class="free">U</span><span class="main">⦈</span><span class="main">⦇</span><span class="free">p</span><span class="main">:</span>param<span class="main">(</span>the<span class="main">(</span><span class="free">U</span><span class="main">^</span><span class="bound">l</span><span class="main">)</span><span class="main">)</span><span class="main">⦈</span>
                               <span class="main">⊢</span> <span class="main">(</span>the<span class="main">(</span><span class="free">f</span> <span class="bound">l</span><span class="main">)</span><span class="hidden">⇗</span><sup>[Fvar <span class="free">s</span><span class="main">,</span>Fvar <span class="free">p</span>]</sup><span class="hidden">⇖</span><span class="main">)</span> <span class="main">:</span> return<span class="main">(</span>the<span class="main">(</span><span class="free">U</span><span class="main">^</span><span class="bound">l</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> typing.cases<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>T_Obj <span class="skolem">F</span><span class="main">)</span>
<span class="comment1">(*  from `e = env` `Obj f U = Obj f' T` `dom f' = do T`
  have "dom f = do U" by simp*)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> strip<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">l</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">∈</span> do <span class="free">U</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹finite <span class="skolem">F</span>›</span></span> finite_FV<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"Obj <span class="free">f</span> <span class="free">U</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="skolem">F</span> <span class="main">∪</span> FV <span class="main">(</span>Obj <span class="free">f</span> <span class="free">U</span><span class="main">)</span> <span class="main">∪</span> <span class="main">{</span><span class="free">s</span><span class="main">,</span><span class="free">p</span><span class="main">}</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">from</span></span> exFresh_s_p_cof<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">sa</span></span> <span class="skolem"><span class="skolem">pa</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
      <span class="quoted"><span class="quoted">"<span class="skolem">sa</span> <span class="main">≠</span> <span class="skolem">pa</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      nin_sa<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">sa</span> <span class="main">∉</span> <span class="skolem">F</span> <span class="main">∪</span> FV <span class="main">(</span>Obj <span class="free">f</span> <span class="free">U</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      nin_pa<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">pa</span> <span class="main">∉</span> <span class="skolem">F</span> <span class="main">∪</span> FV <span class="main">(</span>Obj <span class="free">f</span> <span class="free">U</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">l</span> <span class="main">∈</span> do <span class="free">U</span>›</span></span> T_Obj<span class="main">(</span>4<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> 
      <span class="quoted"><span class="quoted">"<span class="free">e</span><span class="main">⦇</span><span class="skolem">sa</span><span class="main">:</span><span class="free">U</span><span class="main">⦈</span><span class="main">⦇</span><span class="skolem">pa</span><span class="main">:</span>param<span class="main">(</span>the<span class="main">(</span><span class="free">U</span><span class="main">^</span><span class="skolem">l</span><span class="main">)</span><span class="main">)</span><span class="main">⦈</span> 
       <span class="main">⊢</span> <span class="main">(</span>the<span class="main">(</span><span class="free">f</span> <span class="skolem">l</span><span class="main">)</span><span class="hidden">⇗</span><sup>[Fvar <span class="skolem">sa</span><span class="main">,</span>Fvar <span class="skolem">pa</span>]</sup><span class="hidden">⇖</span><span class="main">)</span> <span class="main">:</span> return<span class="main">(</span>the<span class="main">(</span><span class="free">U</span><span class="main">^</span><span class="skolem">l</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">l</span> <span class="main">∈</span> do <span class="free">U</span>›</span></span> <span class="quoted"><span class="quoted">‹dom <span class="free">f</span> <span class="main">=</span> do <span class="free">U</span>›</span></span>  
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">∈</span> dom <span class="free">f</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">with</span></span> nin_s nin_p nin_sa nin_pa FV_option_lem<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">f</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> 
      <span class="quoted"><span class="quoted">"<span class="skolem">sa</span> <span class="main">∉</span> FV <span class="main">(</span>the<span class="main">(</span><span class="free">f</span> <span class="skolem">l</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="skolem">pa</span> <span class="main">∉</span> FV <span class="main">(</span>the<span class="main">(</span><span class="free">f</span> <span class="skolem">l</span><span class="main">)</span><span class="main">)</span> 
       <span class="main">∧</span> <span class="free">s</span> <span class="main">∉</span> FV <span class="main">(</span>the<span class="main">(</span><span class="free">f</span> <span class="skolem">l</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="free">p</span> <span class="main">∉</span> FV <span class="main">(</span>the<span class="main">(</span><span class="free">f</span> <span class="skolem">l</span><span class="main">)</span><span class="main">)</span>
       <span class="main">∧</span> <span class="free">s</span> <span class="main">∉</span> env_dom <span class="free">e</span> <span class="main">∧</span> <span class="free">p</span> <span class="main">∉</span> env_dom <span class="free">e</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span>
    <span class="keyword3"><span class="command">show</span></span> 
      <span class="quoted"><span class="quoted">"<span class="free">e</span><span class="main">⦇</span><span class="free">s</span><span class="main">:</span><span class="free">U</span><span class="main">⦈</span><span class="main">⦇</span><span class="free">p</span><span class="main">:</span>param<span class="main">(</span>the<span class="main">(</span><span class="free">U</span><span class="main">^</span><span class="skolem">l</span><span class="main">)</span><span class="main">)</span><span class="main">⦈</span> 
       <span class="main">⊢</span> <span class="main">(</span>the<span class="main">(</span><span class="free">f</span> <span class="skolem">l</span><span class="main">)</span><span class="hidden">⇗</span><sup>[Fvar <span class="free">s</span><span class="main">,</span>Fvar <span class="free">p</span>]</sup><span class="hidden">⇖</span><span class="main">)</span> <span class="main">:</span> return<span class="main">(</span>the<span class="main">(</span><span class="free">U</span><span class="main">^</span><span class="skolem">l</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> type_renaming<span class="main">[</span><span class="operator">OF</span> _ _ _ _ _ _ _ <span class="quoted"><span class="quoted">‹<span class="free">s</span> <span class="main">≠</span> <span class="free">p</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">sa</span> <span class="main">≠</span> <span class="skolem">pa</span>›</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> openz_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="TypedSigma-dom_lem"><span class="command">lemma</span></span> dom_lem<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">e</span> <span class="main">⊢</span> Obj <span class="free">f</span> <span class="main">(</span>Object <span class="free">fun</span><span class="main">)</span> <span class="main">:</span> Object <span class="free">fun</span> <span class="main">⟹</span> dom <span class="free">f</span> <span class="main">=</span> dom <span class="free">fun</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule</span> typing.cases<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="TypedSigma-abs_typeE"><span class="command">lemma</span></span> abs_typeE<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">e</span> <span class="main">⊢</span> Call <span class="main">(</span>Obj <span class="free">f</span> <span class="free">U</span><span class="main">)</span> <span class="free">l</span> <span class="free">b</span> <span class="main">:</span> <span class="free">T</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> 
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound">F</span><span class="main">.</span> finite <span class="bound">F</span> 
      <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">s</span> <span class="bound">p</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∉</span> <span class="bound">F</span> <span class="main">∧</span> <span class="bound">p</span> <span class="main">∉</span> <span class="bound">F</span> <span class="main">∧</span> <span class="bound">s</span> <span class="main">≠</span> <span class="bound">p</span> 
          <span class="main">⟶</span> <span class="free">e</span><span class="main">⦇</span><span class="bound">s</span><span class="main">:</span><span class="free">U</span><span class="main">⦈</span><span class="main">⦇</span><span class="bound">p</span><span class="main">:</span> param<span class="main">(</span>the<span class="main">(</span><span class="free">U</span><span class="main">^</span><span class="free">l</span><span class="main">)</span><span class="main">)</span><span class="main">⦈</span> <span class="main">⊢</span> <span class="main">(</span>the<span class="main">(</span><span class="free">f</span> <span class="free">l</span><span class="main">)</span><span class="hidden">⇗</span><sup>[Fvar <span class="bound">s</span><span class="main">,</span>Fvar <span class="bound">p</span>]</sup><span class="hidden">⇖</span><span class="main">)</span> <span class="main">:</span> <span class="free">T</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">P</span><span class="main">)</span> 
  <span class="main">⟹</span> <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> typing.cases<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>T_Call <span class="skolem">A</span> <span class="comment1">(*env t1 t2=b*)</span><span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> 
    cof<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">F</span><span class="main">.</span> finite <span class="bound">F</span> 
            <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">s</span> <span class="bound">p</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∉</span> <span class="bound">F</span> <span class="main">∧</span> <span class="bound">p</span> <span class="main">∉</span> <span class="bound">F</span> <span class="main">∧</span> <span class="bound">s</span> <span class="main">≠</span> <span class="bound">p</span> 
                <span class="main">⟶</span> <span class="free">e</span><span class="main">⦇</span><span class="bound">s</span><span class="main">:</span><span class="free">U</span><span class="main">⦈</span><span class="main">⦇</span><span class="bound">p</span><span class="main">:</span> param<span class="main">(</span>the<span class="main">(</span><span class="free">U</span><span class="main">^</span><span class="free">l</span><span class="main">)</span><span class="main">)</span><span class="main">⦈</span> <span class="main">⊢</span> <span class="main">(</span>the<span class="main">(</span><span class="free">f</span> <span class="free">l</span><span class="main">)</span><span class="hidden">⇗</span><sup>[Fvar <span class="bound">s</span><span class="main">,</span>Fvar <span class="bound">p</span>]</sup><span class="hidden">⇖</span><span class="main">)</span> <span class="main">:</span> <span class="free">T</span><span class="main">)</span> 
          <span class="main">⟹</span> <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> 
    <span class="quoted"><span class="quoted">‹<span class="free">T</span> <span class="main">=</span> return<span class="main">(</span>the<span class="main">(</span><span class="skolem">A</span><span class="main">^</span><span class="free">l</span><span class="main">)</span><span class="main">)</span>›</span></span>
    <span class="quoted"><span class="quoted">‹<span class="free">e</span> <span class="main">⊢</span> Obj <span class="free">f</span> <span class="free">U</span> <span class="main">:</span> <span class="skolem">A</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">l</span> <span class="main">∈</span> do <span class="skolem">A</span>›</span></span> obj_inv<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">e</span></span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="free">U</span></span> <span class="quoted"><span class="skolem">A</span></span><span class="main">]</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="quoted"><span class="quoted">"<span class="free">e</span> <span class="main">⊢</span> <span class="main">(</span>Obj <span class="free">f</span> <span class="free">U</span><span class="main">)</span> <span class="main">:</span> <span class="free">U</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">T</span> <span class="main">=</span> return<span class="main">(</span>the<span class="main">(</span><span class="free">U</span><span class="main">^</span><span class="free">l</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">∈</span> do <span class="free">U</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> obj_inv_elim<span class="main">[</span><span class="operator">OF</span> this<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> this<span class="main">(</span>2-3<span class="main">)</span> cof <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Substitution preserves Well-Typedness›</span></span>
<span class="keyword1" id="TypedSigma-bigger_env_lemma"><span class="command">lemma</span></span> bigger_env_lemma<span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span><span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">e</span> <span class="main">⊢</span> <span class="free">t</span> <span class="main">:</span> <span class="free">T</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span> <span class="bound">X</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∉</span> env_dom <span class="free">e</span> <span class="main">⟶</span> <span class="free">e</span><span class="main">⦇</span><span class="bound">x</span><span class="main">:</span><span class="bound">X</span><span class="main">⦈</span> <span class="main">⊢</span> <span class="free">t</span><span class="main">:</span> <span class="free">T</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">pred_cof</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">pred_cof</span> <span class="skolem">L</span> <span class="skolem">env</span> <span class="skolem">t</span> <span class="skolem">T</span> <span class="skolem">l</span> <span class="main">⟷</span>
      <span class="main">(</span><span class="main">∀</span><span class="bound">s</span> <span class="bound">p</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∉</span> <span class="skolem">L</span> <span class="main">∧</span> <span class="bound">p</span> <span class="main">∉</span> <span class="skolem">L</span> <span class="main">∧</span> <span class="bound">s</span> <span class="main">≠</span> <span class="bound">p</span>
        <span class="main">⟶</span> <span class="skolem">env</span><span class="main">⦇</span><span class="bound">s</span><span class="main">:</span><span class="skolem">T</span><span class="main">⦈</span><span class="main">⦇</span><span class="bound">p</span><span class="main">:</span>param <span class="main">(</span>the<span class="main">(</span><span class="skolem">T</span><span class="main">^</span><span class="skolem">l</span><span class="main">)</span><span class="main">)</span><span class="main">⦈</span> <span class="main">⊢</span> <span class="main">(</span><span class="skolem">t</span><span class="hidden">⇗</span><sup>[Fvar <span class="bound">s</span><span class="main">,</span>Fvar <span class="bound">p</span>]</sup><span class="hidden">⇖</span><span class="main">)</span> <span class="main">:</span> return <span class="main">(</span>the<span class="main">(</span><span class="skolem">T</span><span class="main">^</span><span class="skolem">l</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">L</span> <span class="skolem">env</span> <span class="skolem">t</span> <span class="skolem">T</span> <span class="skolem">l</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span>
      <span class="quasi_keyword">taking</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">env</span> <span class="bound">t</span> <span class="bound">T</span> <span class="bound">l</span><span class="main">.</span> <span class="main">∀</span><span class="bound">x</span> <span class="bound">X</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∉</span> env_dom <span class="bound">env</span> 
                            <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">L</span><span class="main">.</span> finite <span class="bound">L</span> <span class="main">∧</span> <span class="skolem">pred_cof</span> <span class="bound">L</span> <span class="main">(</span><span class="bound">env</span><span class="main">⦇</span><span class="bound">x</span><span class="main">:</span><span class="bound">X</span><span class="main">⦈</span><span class="main">)</span> <span class="bound">t</span> <span class="bound">T</span> <span class="bound">l</span><span class="main">)</span>"</span></span>
      <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> typing_induct<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> Call <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Fvar <span class="skolem">env</span> <span class="skolem">Ta</span> <span class="skolem">xa</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> strip<span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">X</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> env_dom <span class="skolem">env</span>"</span></span>
      <span class="keyword1"><span class="command">from</span></span> 
        get_env_smaller<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">xa</span> <span class="main">∈</span> env_dom <span class="skolem">env</span>›</span></span> this<span class="main">]</span>
        T_Var<span class="main">[</span><span class="operator">OF</span> ok_add_ok<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹ok <span class="skolem">env</span>›</span></span> this<span class="main"><span class="main">]</span></span>
        env_bigger<span class="main"><span class="main">[</span></span><span class="operator">OF</span> this <span class="quoted"><span class="quoted">‹<span class="skolem">xa</span> <span class="main">∈</span> env_dom <span class="skolem">env</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span>
        <span class="quoted"><span class="quoted">‹the <span class="skolem">env</span><span class="main">!</span><span class="skolem">xa</span> <span class="main">=</span> <span class="skolem">Ta</span>›</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">env</span><span class="main">⦇</span><span class="skolem">x</span><span class="main">:</span><span class="skolem">X</span><span class="main">⦈</span> <span class="main">⊢</span> Fvar <span class="skolem">xa</span> <span class="main">:</span> <span class="skolem">Ta</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Obj <span class="skolem">env</span> <span class="skolem">Ta</span> <span class="skolem">f</span><span class="main">)</span> <span class="keyword1"><span class="command">note</span></span> pred_o <span class="main">=</span> this<span class="main">(</span>3<span class="main">)</span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">pred_cof'</span></span>
      <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">pred_cof'</span> <span class="skolem">x</span> <span class="skolem">X</span> <span class="skolem">b</span> <span class="skolem">l</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">L</span><span class="main">.</span> finite <span class="bound">L</span> <span class="main">∧</span> <span class="skolem">pred_cof</span> <span class="bound">L</span> <span class="main">(</span><span class="skolem">env</span><span class="main">⦇</span><span class="skolem">x</span><span class="main">:</span><span class="skolem">X</span><span class="main">⦈</span><span class="main">)</span> <span class="main">(</span>the <span class="skolem">b</span><span class="main">)</span> <span class="skolem">Ta</span> <span class="skolem">l</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span> <span class="skolem">X</span> <span class="skolem">b</span> <span class="skolem">l</span>
    <span class="keyword1"><span class="command">from</span></span> pred_o
    <span class="keyword1"><span class="command">have</span></span> pred<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span> <span class="bound">X</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∉</span> env_dom <span class="skolem">env</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∀</span><span class="bound">l</span><span class="main">∈</span>dom <span class="skolem">f</span><span class="main">.</span> <span class="skolem">pred_cof'</span> <span class="bound">x</span> <span class="bound">X</span> <span class="main">(</span><span class="skolem">f</span> <span class="bound">l</span><span class="main">)</span> <span class="bound">l</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> fmap_ball_all2'<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">f</span></span></span></span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">λ</span></span></span><span class="bound"><span class="bound"><span class="bound">x</span></span></span> <span class="bound"><span class="bound"><span class="bound">X</span></span></span><span class="main"><span class="main"><span class="main">.</span></span></span> <span class="bound"><span class="bound"><span class="bound">x</span></span></span> <span class="main"><span class="main"><span class="main">∉</span></span></span> env_dom <span class="skolem"><span class="skolem"><span class="skolem">env</span></span></span>"</span></span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">pred_cof'</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span>
        <span class="operator">unfold</span> pred_cof_def pred_cof'_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> strip<span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">X</span> 
      <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">pred_bnd</span></span>
        <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">pred_bnd</span> <span class="skolem">s</span> <span class="skolem">p</span> <span class="skolem">b</span> <span class="skolem">l</span> <span class="main">⟷</span>
          <span class="skolem">env</span><span class="main">⦇</span><span class="skolem">x</span><span class="main">:</span><span class="skolem">X</span><span class="main">⦈</span><span class="main">⦇</span><span class="skolem">s</span><span class="main">:</span><span class="skolem">Ta</span><span class="main">⦈</span><span class="main">⦇</span><span class="skolem">p</span><span class="main">:</span>param <span class="main">(</span>the<span class="main">(</span><span class="skolem">Ta</span><span class="main">^</span><span class="skolem">l</span><span class="main">)</span><span class="main">)</span><span class="main">⦈</span> <span class="main">⊢</span> <span class="main">(</span>the <span class="skolem">b</span><span class="hidden">⇗</span><sup>[Fvar <span class="skolem">s</span><span class="main">,</span>Fvar <span class="skolem">p</span>]</sup><span class="hidden">⇖</span><span class="main">)</span> <span class="main">:</span> return <span class="main">(</span>the<span class="main">(</span><span class="skolem">Ta</span><span class="main">^</span><span class="skolem">l</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">s</span> <span class="skolem">p</span> <span class="skolem">b</span> <span class="skolem">l</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> env_dom <span class="skolem">env</span>"</span></span>
      <span class="keyword1"><span class="command">with</span></span> pred fmap_ex_cof<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">f</span></span> <span class="quoted"><span class="skolem">pred_bnd</span></span><span class="main">]</span> <span class="quoted"><span class="quoted">‹dom <span class="skolem">f</span> <span class="main">=</span> do <span class="skolem">Ta</span>›</span></span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">L</span></span> <span class="keyword2"><span class="keyword">where</span></span>
        <span class="quoted"><span class="quoted">"finite <span class="skolem">L</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">l</span><span class="main">∈</span>do <span class="skolem">Ta</span><span class="main">.</span> <span class="skolem">pred_cof</span> <span class="skolem">L</span> <span class="main">(</span><span class="skolem">env</span><span class="main">⦇</span><span class="skolem">x</span><span class="main">:</span><span class="skolem">X</span><span class="main">⦈</span><span class="main">)</span> <span class="main">(</span>the<span class="main">(</span><span class="skolem">f</span> <span class="bound">l</span><span class="main">)</span><span class="main">)</span> <span class="skolem">Ta</span> <span class="bound">l</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> pred_bnd_def pred_cof_def pred_cof'_def
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">from</span></span> 
        T_Obj<span class="main">[</span><span class="operator">OF</span> ok_add_ok<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹ok <span class="skolem">env</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∉</span> env_dom <span class="skolem">env</span>›</span></span><span class="main"><span class="main">]</span></span> 
                 <span class="quoted"><span class="quoted">‹dom <span class="skolem">f</span> <span class="main">=</span> do <span class="skolem">Ta</span>›</span></span> this<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
        this<span class="main">(</span>2<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">env</span><span class="main">⦇</span><span class="skolem">x</span><span class="main">:</span><span class="skolem">X</span><span class="main">⦈</span> <span class="main">⊢</span> Obj <span class="skolem">f</span> <span class="skolem">Ta</span> <span class="main">:</span> <span class="skolem">Ta</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> pred_cof_def
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Upd <span class="skolem">env</span> <span class="skolem">Ta</span> <span class="skolem">t</span> <span class="skolem">l</span> <span class="skolem">u</span><span class="main">)</span> 
    <span class="keyword1"><span class="command">note</span></span> pred_t <span class="main">=</span> this<span class="main">(</span>2<span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span> pred_u <span class="main">=</span> this<span class="main">(</span>4<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> strip<span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">X</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> env_dom <span class="skolem">env</span>"</span></span> 
      <span class="keyword1"><span class="command">with</span></span> pred_u <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">L</span></span> <span class="keyword2"><span class="keyword">where</span></span>
        <span class="quoted"><span class="quoted">"finite <span class="skolem">L</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">pred_cof</span> <span class="skolem">L</span> <span class="main">(</span><span class="skolem">env</span><span class="main">⦇</span><span class="skolem">x</span><span class="main">:</span><span class="skolem">X</span><span class="main">⦈</span><span class="main">)</span> <span class="skolem">u</span> <span class="skolem">Ta</span> <span class="skolem">l</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">l</span> <span class="main">∈</span> do <span class="skolem">Ta</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∉</span> env_dom <span class="skolem">env</span>›</span></span> pred_t
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">env</span><span class="main">⦇</span><span class="skolem">x</span><span class="main">:</span><span class="skolem">X</span><span class="main">⦈</span> <span class="main">⊢</span> Upd <span class="skolem">t</span> <span class="skolem">l</span> <span class="skolem">u</span> <span class="main">:</span> <span class="skolem">Ta</span>"</span></span> 
        <span class="keyword1"><span class="command">unfolding</span></span> pred_cof_def
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Bnd <span class="skolem">env</span> <span class="skolem">Ta</span> <span class="skolem">l</span> <span class="skolem">t</span> <span class="skolem">L</span><span class="main">)</span> <span class="keyword1"><span class="command">note</span></span> pred <span class="main">=</span> this<span class="main">(</span>3<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> strip<span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">X</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> env_dom <span class="skolem">env</span>"</span></span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">L</span><span class="main">.</span> finite <span class="bound">L</span> <span class="main">∧</span> <span class="skolem">pred_cof</span> <span class="bound">L</span> <span class="main">(</span><span class="skolem">env</span><span class="main">⦇</span><span class="skolem">x</span><span class="main">:</span><span class="skolem">X</span><span class="main">⦈</span><span class="main">)</span> <span class="skolem">t</span> <span class="skolem">Ta</span> <span class="skolem">l</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">L</span> <span class="main">∪</span> <span class="main">{</span><span class="skolem">x</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹finite <span class="skolem">L</span>›</span></span><span class="main"><span class="keyword3">,</span></span> 
          <span class="operator">unfold</span> pred_cof_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span> <span class="skolem">p</span>
        <span class="keyword3"><span class="command">assume</span></span> 
          <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∉</span> <span class="skolem">L</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∉</span> <span class="skolem">L</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">≠</span> <span class="skolem">p</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
          <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">≠</span> <span class="skolem">x</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">≠</span> <span class="skolem">x</span>"</span></span>
        <span class="keyword1"><span class="command">note</span></span> 
          subst_add<span class="main">[</span><span class="operator">OF</span> not_sym<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">s</span> <span class="main">≠</span> <span class="skolem">x</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span>
          subst_add<span class="main">[</span><span class="operator">OF</span> not_sym<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="main">≠</span> <span class="skolem">x</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">from</span></span> 
          this<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">env</span></span> <span class="quoted"><span class="skolem">X</span></span> <span class="quoted"><span class="skolem">Ta</span></span><span class="main">]</span> this<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">env</span><span class="main">⦇</span><span class="skolem">s</span><span class="main">:</span><span class="skolem">Ta</span><span class="main">⦈</span>"</span></span> <span class="quoted"><span class="skolem">X</span></span> <span class="quoted"><span class="quoted">"param <span class="main">(</span>the<span class="main">(</span><span class="skolem">Ta</span><span class="main">^</span><span class="skolem">l</span><span class="main">)</span><span class="main">)</span>"</span></span><span class="main">]</span>
          pred <span class="quoted"><span class="quoted">‹<span class="skolem">s</span> <span class="main">∉</span> <span class="skolem">L</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="main">∉</span> <span class="skolem">L</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">s</span> <span class="main">≠</span> <span class="skolem">p</span>›</span></span>
          not_in_env_bigger_2<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∉</span> env_dom <span class="skolem">env</span>›</span></span> 
                                 not_sym<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">s</span> <span class="main">≠</span> <span class="skolem">x</span>›</span></span><span class="main"><span class="main">]</span></span> not_sym<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="main">≠</span> <span class="skolem">x</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span>
        <span class="keyword3"><span class="command">show</span></span> 
          <span class="quoted"><span class="quoted">"<span class="skolem">env</span><span class="main">⦇</span><span class="skolem">x</span><span class="main">:</span><span class="skolem">X</span><span class="main">⦈</span><span class="main">⦇</span><span class="skolem">s</span><span class="main">:</span><span class="skolem">Ta</span><span class="main">⦈</span><span class="main">⦇</span><span class="skolem">p</span><span class="main">:</span>param <span class="main">(</span>the<span class="main">(</span><span class="skolem">Ta</span><span class="main">^</span><span class="skolem">l</span><span class="main">)</span><span class="main">)</span><span class="main">⦈</span> 
          <span class="main">⊢</span> <span class="main">(</span><span class="skolem">t</span><span class="hidden">⇗</span><sup>[Fvar <span class="skolem">s</span><span class="main">,</span>Fvar <span class="skolem">p</span>]</sup><span class="hidden">⇖</span><span class="main">)</span> <span class="main">:</span> return <span class="main">(</span>the<span class="main">(</span><span class="skolem">Ta</span><span class="main">^</span><span class="skolem">l</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="TypedSigma-bnd_disj_env_lem"><span class="command">lemma</span></span> bnd_disj_env_lem<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> 
  <span class="quoted"><span class="quoted">"ok <span class="free">e1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"env_dom <span class="free">e1</span> <span class="main">∩</span> env_dom <span class="free">e2</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"ok <span class="free">e2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">s</span> <span class="bound">p</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∉</span> <span class="free">F</span> <span class="main">∧</span> <span class="bound">p</span> <span class="main">∉</span> <span class="free">F</span> <span class="main">∧</span> <span class="bound">s</span> <span class="main">≠</span> <span class="bound">p</span> 
    <span class="main">⟶</span> <span class="free">e1</span><span class="main">⦇</span><span class="bound">s</span><span class="main">:</span><span class="free">T</span><span class="main">⦈</span><span class="main">⦇</span><span class="bound">p</span><span class="main">:</span>param<span class="main">(</span>the<span class="main">(</span><span class="free">T</span><span class="main">^</span><span class="free">l</span><span class="main">)</span><span class="main">)</span><span class="main">⦈</span>
        <span class="main">⊢</span> <span class="main">(</span><span class="free">t2</span><span class="hidden">⇗</span><sup>[Fvar <span class="bound">s</span><span class="main">,</span>Fvar <span class="bound">p</span>]</sup><span class="hidden">⇖</span><span class="main">)</span> <span class="main">:</span> return<span class="main">(</span>the<span class="main">(</span><span class="free">T</span><span class="main">^</span><span class="free">l</span><span class="main">)</span><span class="main">)</span> 
        <span class="main">∧</span> <span class="main">(</span>env_dom <span class="main">(</span><span class="free">e1</span><span class="main">⦇</span><span class="bound">s</span><span class="main">:</span><span class="free">T</span><span class="main">⦈</span><span class="main">⦇</span><span class="bound">p</span><span class="main">:</span>param<span class="main">(</span>the<span class="main">(</span><span class="free">T</span><span class="main">^</span><span class="free">l</span><span class="main">)</span><span class="main">)</span><span class="main">⦈</span><span class="main">)</span> <span class="main">∩</span> env_dom <span class="free">e2</span> <span class="main">=</span> <span class="main">{}</span> 
    <span class="main">⟶</span> ok <span class="free">e2</span> 
    <span class="main">⟶</span> <span class="free">e1</span><span class="main">⦇</span><span class="bound">s</span><span class="main">:</span><span class="free">T</span><span class="main">⦈</span><span class="main">⦇</span><span class="bound">p</span><span class="main">:</span>param<span class="main">(</span>the<span class="main">(</span><span class="free">T</span><span class="main">^</span><span class="free">l</span><span class="main">)</span><span class="main">)</span><span class="main">⦈</span><span class="main">+</span><span class="free">e2</span> 
        <span class="main">⊢</span> <span class="main">(</span><span class="free">t2</span><span class="hidden">⇗</span><sup>[Fvar <span class="bound">s</span><span class="main">,</span>Fvar <span class="bound">p</span>]</sup><span class="hidden">⇖</span><span class="main">)</span> <span class="main">:</span> return<span class="main">(</span>the<span class="main">(</span><span class="free">T</span><span class="main">^</span><span class="free">l</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> 
  <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">s</span> <span class="bound">p</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∉</span> <span class="free">F</span> <span class="main">∪</span> env_dom <span class="main">(</span><span class="free">e1</span><span class="main">+</span><span class="free">e2</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">p</span> <span class="main">∉</span> <span class="free">F</span> <span class="main">∪</span> env_dom <span class="main">(</span><span class="free">e1</span><span class="main">+</span><span class="free">e2</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">s</span> <span class="main">≠</span> <span class="bound">p</span>
    <span class="main">⟶</span> <span class="main">(</span><span class="free">e1</span><span class="main">+</span><span class="free">e2</span><span class="main">)</span><span class="main">⦇</span><span class="bound">s</span><span class="main">:</span><span class="free">T</span><span class="main">⦈</span><span class="main">⦇</span><span class="bound">p</span><span class="main">:</span>param<span class="main">(</span>the<span class="main">(</span><span class="free">T</span><span class="main">^</span><span class="free">l</span><span class="main">)</span><span class="main">)</span><span class="main">⦈</span> <span class="main">⊢</span> <span class="main">(</span><span class="free">t2</span><span class="hidden">⇗</span><sup>[Fvar <span class="bound">s</span><span class="main">,</span>Fvar <span class="bound">p</span>]</sup><span class="hidden">⇖</span><span class="main">)</span> <span class="main">:</span> return<span class="main">(</span>the<span class="main">(</span><span class="free">T</span><span class="main">^</span><span class="free">l</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> strip<span class="main"><span class="keyword3">,</span></span> <span class="operator">elim</span> conjE<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span> <span class="skolem">p</span> <span class="keyword3"><span class="command">assume</span></span> 
    nin_s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∉</span> <span class="free">F</span> <span class="main">∪</span> env_dom <span class="main">(</span><span class="free">e1</span><span class="main">+</span><span class="free">e2</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    nin_p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∉</span> <span class="free">F</span> <span class="main">∪</span> env_dom <span class="main">(</span><span class="free">e1</span><span class="main">+</span><span class="free">e2</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">≠</span> <span class="skolem">p</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> 
    this<span class="main">(</span>1-2<span class="main">)</span> env_add_dom_2<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> _ _ this<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">]</span>
    assms<span class="main">(</span>2<span class="main">)</span> env_app_dom<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1-3<span class="main"><span class="main">)</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"env_dom <span class="main">(</span><span class="free">e1</span><span class="main">⦇</span><span class="skolem">s</span><span class="main">:</span><span class="free">T</span><span class="main">⦈</span><span class="main">⦇</span><span class="skolem">p</span><span class="main">:</span>param<span class="main">(</span>the<span class="main">(</span><span class="free">T</span><span class="main">^</span><span class="free">l</span><span class="main">)</span><span class="main">)</span><span class="main">⦈</span><span class="main">)</span> <span class="main">∩</span> env_dom <span class="free">e2</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">with</span></span> 
    env_app_add2<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1-3<span class="main"><span class="main">)</span></span> _ _ _ _ <span class="quoted"><span class="quoted">‹<span class="skolem">s</span> <span class="main">≠</span> <span class="skolem">p</span>›</span></span><span class="main">]</span>
    env_app_dom<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1-3<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="quoted"><span class="quoted">‹ok <span class="free">e2</span>›</span></span> assms<span class="main">(</span>4<span class="main">)</span> nin_s nin_p <span class="quoted"><span class="quoted">‹<span class="skolem">s</span> <span class="main">≠</span> <span class="skolem">p</span>›</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">e1</span><span class="main">+</span><span class="free">e2</span><span class="main">)</span><span class="main">⦇</span><span class="skolem">s</span><span class="main">:</span><span class="free">T</span><span class="main">⦈</span><span class="main">⦇</span><span class="skolem">p</span><span class="main">:</span>param<span class="main">(</span>the<span class="main">(</span><span class="free">T</span><span class="main">^</span><span class="free">l</span><span class="main">)</span><span class="main">)</span><span class="main">⦈</span> <span class="main">⊢</span> <span class="main">(</span><span class="free">t2</span><span class="hidden">⇗</span><sup>[Fvar <span class="skolem">s</span><span class="main">,</span>Fvar <span class="skolem">p</span>]</sup><span class="hidden">⇖</span><span class="main">)</span> <span class="main">:</span> return<span class="main">(</span>the<span class="main">(</span><span class="free">T</span><span class="main">^</span><span class="free">l</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(* TODO: refactor to work with typing_induct *)</span>
<span class="keyword1" id="TypedSigma-disjunct_env"><span class="command">lemma</span></span> disjunct_env<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">e</span> <span class="main">⊢</span> <span class="free">t</span> <span class="main">:</span> <span class="free">A</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>env_dom <span class="free">e</span> <span class="main">∩</span> env_dom <span class="free">e'</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">⟹</span> ok <span class="free">e'</span> <span class="main">⟹</span> <span class="free">e</span> <span class="main">+</span> <span class="free">e'</span> <span class="main">⊢</span> <span class="free">t</span> <span class="main">:</span> <span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> typing.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> T_Call <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>T_Var <span class="skolem">env</span> <span class="skolem">x</span> <span class="skolem">T</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> 
    env_app_dom<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹ok <span class="skolem">env</span>›</span></span> <span class="quoted"><span class="quoted">‹env_dom <span class="skolem">env</span> <span class="main">∩</span> env_dom <span class="free">e'</span> <span class="main">=</span> <span class="main">{}</span>›</span></span> <span class="quoted"><span class="quoted">‹ok <span class="free">e'</span>›</span></span><span class="main">]</span>
    <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> env_dom <span class="skolem">env</span>›</span></span>
  <span class="keyword1"><span class="command">have</span></span> indom<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> env_dom <span class="main">(</span><span class="skolem">env</span><span class="main">+</span><span class="free">e'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> 
    <span class="quoted"><span class="quoted">‹ok <span class="skolem">env</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> env_dom <span class="skolem">env</span>›</span></span> <span class="quoted"><span class="quoted">‹the <span class="skolem">env</span><span class="main">!</span><span class="skolem">x</span> <span class="main">=</span> <span class="skolem">T</span>›</span></span> <span class="quoted"><span class="quoted">‹env_dom <span class="skolem">env</span> <span class="main">∩</span> env_dom <span class="free">e'</span> <span class="main">=</span> <span class="main">{}</span>›</span></span>
    <span class="quoted"><span class="quoted">‹ok <span class="free">e'</span>›</span></span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"the <span class="main">(</span><span class="skolem">env</span><span class="main">+</span><span class="free">e'</span><span class="main">)</span><span class="main">!</span><span class="skolem">x</span> <span class="main">=</span> <span class="skolem">T</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> 
    typing.T_Var<span class="main">[</span><span class="operator">OF</span> env_app_ok<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹ok <span class="skolem">env</span>›</span></span> <span class="quoted"><span class="quoted">‹env_dom <span class="skolem">env</span> <span class="main">∩</span> env_dom <span class="free">e'</span> <span class="main">=</span> <span class="main">{}</span>›</span></span> 
                                  <span class="quoted"><span class="quoted">‹ok <span class="free">e'</span>›</span></span><span class="main"><span class="main">]</span></span> 
                    indom this<span class="main">]</span> 
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">assumption</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>T_Upd <span class="skolem">F</span> <span class="skolem">env</span> <span class="skolem">T</span> <span class="skolem">l</span> <span class="skolem">t2</span> <span class="skolem">t1</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> 
    typing.T_Upd<span class="main">[</span><span class="operator">OF</span> _ bnd_disj_env_lem<span class="main"><span class="main">[</span></span><span class="operator">OF</span> typing_regular'<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">env</span> <span class="main">⊢</span> <span class="skolem">t1</span> <span class="main">:</span> <span class="skolem">T</span>›</span></span><span class="main"><span class="main">]</span></span> 
                                          <span class="quoted"><span class="quoted">‹env_dom <span class="skolem">env</span> <span class="main">∩</span> env_dom <span class="free">e'</span> <span class="main">=</span> <span class="main">{}</span>›</span></span> <span class="quoted"><span class="quoted">‹ok <span class="free">e'</span>›</span></span> 
                                          T_Upd<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span> 
                    T_Upd<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹env_dom <span class="skolem">env</span> <span class="main">∩</span> env_dom <span class="free">e'</span> <span class="main">=</span> <span class="main">{}</span>›</span></span> <span class="quoted"><span class="quoted">‹ok <span class="free">e'</span>›</span></span><span class="main"><span class="main">]</span></span> 
                    <span class="quoted"><span class="quoted">‹<span class="skolem">l</span> <span class="main">∈</span> do <span class="skolem">T</span>›</span></span><span class="main">]</span>
    <span class="quoted"><span class="quoted">‹finite <span class="skolem">F</span>›</span></span> ok_finite<span class="main">[</span><span class="operator">OF</span> env_app_ok<span class="main"><span class="main">[</span></span><span class="operator">OF</span> typing_regular'<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">env</span> <span class="main">⊢</span> <span class="skolem">t1</span> <span class="main">:</span> <span class="skolem">T</span>›</span></span><span class="main"><span class="main">]</span></span> 
                                          <span class="quoted"><span class="quoted">‹env_dom <span class="skolem">env</span> <span class="main">∩</span> env_dom <span class="free">e'</span> <span class="main">=</span> <span class="main">{}</span>›</span></span> <span class="quoted"><span class="quoted">‹ok <span class="free">e'</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>T_Obj <span class="skolem">env</span> <span class="skolem">f</span> <span class="skolem">T</span> <span class="skolem">F</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> 
    ok_finite<span class="main">[</span><span class="operator">OF</span> env_app_ok<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹ok <span class="skolem">env</span>›</span></span> <span class="quoted"><span class="quoted">‹env_dom <span class="skolem">env</span> <span class="main">∩</span> env_dom <span class="free">e'</span> <span class="main">=</span> <span class="main">{}</span>›</span></span> <span class="quoted"><span class="quoted">‹ok <span class="free">e'</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span>
    <span class="quoted"><span class="quoted">‹finite <span class="skolem">F</span>›</span></span> 
  <span class="keyword1"><span class="command">have</span></span> finF<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="skolem">F</span> <span class="main">∪</span> env_dom <span class="main">(</span><span class="skolem">env</span><span class="main">+</span><span class="free">e'</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">note</span></span> 
    ball_Tltsp<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">F</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">T</span> <span class="bound">l</span> <span class="bound">t</span> <span class="bound">s</span> <span class="bound">p</span><span class="main">.</span> <span class="skolem">env</span><span class="main">⦇</span><span class="bound">s</span><span class="main">:</span><span class="bound">T</span><span class="main">⦈</span><span class="main">⦇</span><span class="bound">p</span><span class="main">:</span>param<span class="main">(</span>the<span class="main">(</span><span class="bound">T</span><span class="main">^</span><span class="bound">l</span><span class="main">)</span><span class="main">)</span><span class="main">⦈</span> <span class="main">⊢</span> <span class="main">(</span><span class="bound">t</span><span class="hidden">⇗</span><sup>[Fvar <span class="bound">s</span><span class="main">,</span>Fvar <span class="bound">p</span>]</sup><span class="hidden">⇖</span><span class="main">)</span> <span class="main">:</span> return<span class="main">(</span>the<span class="main">(</span><span class="bound">T</span><span class="main">^</span><span class="bound">l</span><span class="main">)</span><span class="main">)</span>
               <span class="main">∧</span> <span class="main">(</span>env_dom <span class="main">(</span><span class="skolem">env</span><span class="main">⦇</span><span class="bound">s</span><span class="main">:</span><span class="bound">T</span><span class="main">⦈</span><span class="main">⦇</span><span class="bound">p</span><span class="main">:</span>param<span class="main">(</span>the<span class="main">(</span><span class="bound">T</span><span class="main">^</span><span class="bound">l</span><span class="main">)</span><span class="main">)</span><span class="main">⦈</span><span class="main">)</span> <span class="main">∩</span> env_dom <span class="free">e'</span> <span class="main">=</span> <span class="main">{}</span> 
                  <span class="main">⟶</span> ok <span class="free">e'</span> 
                  <span class="main">⟶</span> <span class="skolem">env</span><span class="main">⦇</span><span class="bound">s</span><span class="main">:</span><span class="bound">T</span><span class="main">⦈</span><span class="main">⦇</span><span class="bound">p</span><span class="main">:</span>param<span class="main">(</span>the<span class="main">(</span><span class="bound">T</span><span class="main">^</span><span class="bound">l</span><span class="main">)</span><span class="main">)</span><span class="main">⦈</span><span class="main">+</span><span class="free">e'</span> 
                      <span class="main">⊢</span> <span class="main">(</span><span class="bound">t</span><span class="hidden">⇗</span><sup>[Fvar <span class="bound">s</span><span class="main">,</span>Fvar <span class="bound">p</span>]</sup><span class="hidden">⇖</span><span class="main">)</span> <span class="main">:</span> return<span class="main">(</span>the<span class="main">(</span><span class="bound">T</span><span class="main">^</span><span class="bound">l</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="skolem">T</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">F</span> <span class="main">∪</span> env_dom <span class="main">(</span><span class="skolem">env</span><span class="main">+</span><span class="free">e'</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">T</span> <span class="bound">l</span> <span class="bound">t</span> <span class="bound">s</span> <span class="bound">p</span><span class="main">.</span> <span class="main">(</span><span class="skolem">env</span><span class="main">+</span><span class="free">e'</span><span class="main">)</span><span class="main">⦇</span><span class="bound">s</span><span class="main">:</span><span class="bound">T</span><span class="main">⦈</span><span class="main">⦇</span><span class="bound">p</span><span class="main">:</span>param<span class="main">(</span>the<span class="main">(</span><span class="bound">T</span><span class="main">^</span><span class="bound">l</span><span class="main">)</span><span class="main">)</span><span class="main">⦈</span> 
                 <span class="main">⊢</span> <span class="main">(</span><span class="bound">t</span><span class="hidden">⇗</span><sup>[Fvar <span class="bound">s</span><span class="main">,</span>Fvar <span class="bound">p</span>]</sup><span class="hidden">⇖</span><span class="main">)</span> <span class="main">:</span> return<span class="main">(</span>the<span class="main">(</span><span class="bound">T</span><span class="main">^</span><span class="bound">l</span><span class="main">)</span><span class="main">)</span>"</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">from</span></span> 
    this<span class="main">[</span><span class="operator">OF</span> _ T_Obj<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">]</span> 
    bnd_disj_env_lem<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹ok <span class="skolem">env</span>›</span></span> <span class="quoted"><span class="quoted">‹env_dom <span class="skolem">env</span> <span class="main">∩</span> env_dom <span class="free">e'</span> <span class="main">=</span> <span class="main">{}</span>›</span></span> <span class="quoted"><span class="quoted">‹ok <span class="free">e'</span>›</span></span><span class="main">]</span> 
    typing.T_Obj<span class="main">[</span><span class="operator">OF</span> env_app_ok<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹ok <span class="skolem">env</span>›</span></span> 
                    <span class="quoted"><span class="quoted">‹env_dom <span class="skolem">env</span> <span class="main">∩</span> env_dom <span class="free">e'</span> <span class="main">=</span> <span class="main">{}</span>›</span></span> <span class="quoted"><span class="quoted">‹ok <span class="free">e'</span>›</span></span><span class="main"><span class="main">]</span></span> 
                    <span class="quoted"><span class="quoted">‹dom <span class="skolem">f</span> <span class="main">=</span> do <span class="skolem">T</span>›</span></span> finF<span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Typed in the Empty Environment implies typed in any Environment›</span></span>
<span class="keyword1" id="TypedSigma-empty_env"><span class="command">lemma</span></span> empty_env<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Env Map.empty<span class="main">)</span> <span class="main">⊢</span> <span class="free">t</span> <span class="main">:</span> <span class="free">A</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"ok <span class="free">env</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">env</span> <span class="main">⊢</span> <span class="free">t</span> <span class="main">:</span> <span class="free">A</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹ok <span class="free">env</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">env</span> <span class="main">=</span> <span class="main">(</span>Env Map.empty<span class="main">)</span><span class="main">+</span><span class="free">env</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">env</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> disjunct_env<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> _ assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="TypedSigma-bnd_open_lem"><span class="command">lemma</span></span> bnd_open_lem<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
  pred_bnd<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">sa</span> <span class="bound">pa</span><span class="main">.</span> <span class="bound">sa</span> <span class="main">∉</span> <span class="free">F</span> <span class="main">∧</span> <span class="bound">pa</span> <span class="main">∉</span> <span class="free">F</span> <span class="main">∧</span> <span class="bound">sa</span> <span class="main">≠</span> <span class="bound">pa</span> 
    <span class="main">⟶</span> <span class="free">env</span><span class="main">⦇</span><span class="bound">sa</span><span class="main">:</span><span class="free">T</span><span class="main">⦈</span><span class="main">⦇</span><span class="bound">pa</span><span class="main">:</span>param<span class="main">(</span>the<span class="main">(</span><span class="free">T</span><span class="main">^</span><span class="free">l</span><span class="main">)</span><span class="main">)</span><span class="main">⦈</span> 
        <span class="main">⊢</span> <span class="main">(</span><span class="free">t</span><span class="hidden">⇗</span><sup>[Fvar <span class="bound">sa</span><span class="main">,</span>Fvar <span class="bound">pa</span>]</sup><span class="hidden">⇖</span><span class="main">)</span> <span class="main">:</span> return<span class="main">(</span>the<span class="main">(</span><span class="free">T</span><span class="main">^</span><span class="free">l</span><span class="main">)</span><span class="main">)</span> 
     <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">env''</span> <span class="bound">t''</span> <span class="bound">s'</span> <span class="bound">p'</span> <span class="bound">x'</span> <span class="bound">y'</span> <span class="bound">A'</span> <span class="bound">B'</span> <span class="bound">n'</span><span class="main">.</span> <span class="bound">s'</span> <span class="main">∉</span> FV <span class="bound">t''</span> <span class="main">∪</span> FV <span class="bound">x'</span> <span class="main">∪</span> FV <span class="bound">y'</span> 
         <span class="main">⟶</span> <span class="bound">p'</span> <span class="main">∉</span> FV <span class="bound">t''</span> <span class="main">∪</span> FV <span class="bound">x'</span> <span class="main">∪</span> FV <span class="bound">y'</span> <span class="main">⟶</span> <span class="bound">s'</span> <span class="main">≠</span> <span class="bound">p'</span> 
         <span class="main">⟶</span> <span class="bound">env''</span> <span class="main">⊢</span> <span class="bound">x'</span> <span class="main">:</span> <span class="bound">A'</span> <span class="main">⟶</span> <span class="bound">env''</span> <span class="main">⊢</span> <span class="bound">y'</span> <span class="main">:</span> <span class="bound">B'</span> 
         <span class="main">⟶</span> <span class="main">(</span><span class="free">t</span><span class="hidden">⇗</span><sup>[Fvar <span class="bound">sa</span><span class="main">,</span>Fvar <span class="bound">pa</span>]</sup><span class="hidden">⇖</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="bound">n'</span> <span class="main">→</span> <span class="main">[</span>Fvar <span class="bound">s'</span><span class="main">,</span>Fvar <span class="bound">p'</span><span class="main">]}</span> <span class="bound">t''</span> 
         <span class="main">⟶</span> <span class="free">env</span><span class="main">⦇</span><span class="bound">sa</span><span class="main">:</span><span class="free">T</span><span class="main">⦈</span><span class="main">⦇</span><span class="bound">pa</span><span class="main">:</span>param<span class="main">(</span>the<span class="main">(</span><span class="free">T</span><span class="main">^</span><span class="free">l</span><span class="main">)</span><span class="main">)</span><span class="main">⦈</span> <span class="main">=</span> <span class="bound">env''</span><span class="main">⦇</span><span class="bound">s'</span><span class="main">:</span><span class="bound">A'</span><span class="main">⦈</span><span class="main">⦇</span><span class="bound">p'</span><span class="main">:</span><span class="bound">B'</span><span class="main">⦈</span> 
         <span class="main">⟶</span> <span class="bound">env''</span> <span class="main">⊢</span> <span class="main">{</span><span class="bound">n'</span> <span class="main">→</span> <span class="main">[</span><span class="bound">x'</span><span class="main">,</span><span class="bound">y'</span><span class="main">]}</span> <span class="bound">t''</span> <span class="main">:</span> return<span class="main">(</span>the<span class="main">(</span><span class="free">T</span><span class="main">^</span><span class="free">l</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  <span class="quoted"><span class="quoted">"ok <span class="free">env</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">env</span> <span class="main">=</span> <span class="free">env'</span><span class="main">⦇</span><span class="free">s</span><span class="main">:</span><span class="free">A</span><span class="main">⦈</span><span class="main">⦇</span><span class="free">p</span><span class="main">:</span><span class="free">B</span><span class="main">⦈</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">∉</span> FV <span class="free">t''</span> <span class="main">∪</span> FV <span class="free">x</span> <span class="main">∪</span> FV <span class="free">y</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∉</span> FV <span class="free">t''</span> <span class="main">∪</span> FV <span class="free">x</span> <span class="main">∪</span> FV <span class="free">y</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">≠</span> <span class="free">p</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">env'</span> <span class="main">⊢</span> <span class="free">x</span> <span class="main">:</span> <span class="free">A</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">env'</span> <span class="main">⊢</span> <span class="free">y</span> <span class="main">:</span> <span class="free">B</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">=</span> <span class="main">{</span>Suc <span class="free">n</span> <span class="main">→</span> <span class="main">[</span>Fvar <span class="free">s</span><span class="main">,</span>Fvar <span class="free">p</span><span class="main">]}</span> <span class="free">t'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"FV <span class="free">t'</span> <span class="main">⊆</span> FV <span class="free">t''</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> 
  <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">sa</span> <span class="bound">pa</span><span class="main">.</span> <span class="bound">sa</span> <span class="main">∉</span> <span class="free">F</span> <span class="main">∪</span> <span class="main">{</span><span class="free">s</span><span class="main">,</span><span class="free">p</span><span class="main">}</span> <span class="main">∪</span> env_dom <span class="free">env'</span> 
         <span class="main">∧</span> <span class="bound">pa</span> <span class="main">∉</span> <span class="free">F</span> <span class="main">∪</span> <span class="main">{</span><span class="free">s</span><span class="main">,</span><span class="free">p</span><span class="main">}</span> <span class="main">∪</span> env_dom <span class="free">env'</span> <span class="main">∧</span> <span class="bound">sa</span> <span class="main">≠</span> <span class="bound">pa</span>
    <span class="main">⟶</span> <span class="free">env'</span><span class="main">⦇</span><span class="bound">sa</span><span class="main">:</span><span class="free">T</span><span class="main">⦈</span><span class="main">⦇</span><span class="bound">pa</span><span class="main">:</span>param<span class="main">(</span>the<span class="main">(</span><span class="free">T</span><span class="main">^</span><span class="free">l</span><span class="main">)</span><span class="main">)</span><span class="main">⦈</span>
        <span class="main">⊢</span> <span class="main">(</span><span class="main">{</span>Suc <span class="free">n</span> <span class="main">→</span> <span class="main">[</span><span class="free">x</span><span class="main">,</span><span class="free">y</span><span class="main">]}</span> <span class="free">t'</span><span class="hidden">⇗</span><sup>[Fvar <span class="bound">sa</span><span class="main">,</span> Fvar <span class="bound">pa</span>]</sup><span class="hidden">⇖</span><span class="main">)</span> <span class="main">:</span> return<span class="main">(</span>the<span class="main">(</span><span class="free">T</span><span class="main">^</span><span class="free">l</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> strip<span class="main"><span class="keyword3">,</span></span> <span class="operator">elim</span> conjE<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">sa</span> <span class="skolem">pa</span> <span class="keyword3"><span class="command">assume</span></span> 
    nin_sa<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">sa</span> <span class="main">∉</span> <span class="free">F</span> <span class="main">∪</span> <span class="main">{</span><span class="free">s</span><span class="main">,</span><span class="free">p</span><span class="main">}</span> <span class="main">∪</span> env_dom <span class="free">env'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 
    nin_pa<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">pa</span> <span class="main">∉</span> <span class="free">F</span> <span class="main">∪</span> <span class="main">{</span><span class="free">s</span><span class="main">,</span><span class="free">p</span><span class="main">}</span> <span class="main">∪</span> env_dom <span class="free">env'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">sa</span> <span class="main">≠</span> <span class="skolem">pa</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">sa</span> <span class="main">∉</span> <span class="free">F</span> <span class="main">∧</span> <span class="skolem">pa</span> <span class="main">∉</span> <span class="free">F</span> <span class="main">∧</span> <span class="skolem">sa</span> <span class="main">≠</span> <span class="skolem">pa</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∉</span> FV <span class="free">t''</span> <span class="main">∪</span> FV <span class="free">x</span> <span class="main">∪</span> FV <span class="free">y</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∈</span> <span class="main">{</span><span class="free">s</span><span class="main">,</span><span class="free">p</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> 
      <span class="quoted"><span class="quoted">‹FV <span class="free">t'</span> <span class="main">⊆</span> FV <span class="free">t''</span>›</span></span> nin_sa nin_pa <span class="quoted"><span class="quoted">‹<span class="skolem">sa</span> <span class="main">≠</span> <span class="skolem">pa</span>›</span></span> 
      sopen_FV<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="main">0</span></span> <span class="quoted"><span class="quoted">"Fvar <span class="skolem">sa</span>"</span></span> <span class="quoted"><span class="quoted">"Fvar <span class="skolem">pa</span>"</span></span> <span class="quoted"><span class="free">t'</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∉</span> FV <span class="main">(</span><span class="free">t'</span><span class="hidden">⇗</span><sup>[Fvar <span class="skolem">sa</span><span class="main">,</span>Fvar <span class="skolem">pa</span>]</sup><span class="hidden">⇖</span><span class="main">)</span> <span class="main">∪</span> FV <span class="free">x</span> <span class="main">∪</span> FV <span class="free">y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> openz_def<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> 
      this<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">s</span> <span class="main">∉</span> FV <span class="free">t''</span> <span class="main">∪</span> FV <span class="free">x</span> <span class="main">∪</span> FV <span class="free">y</span>›</span></span><span class="main">]</span> 
      this<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">p</span> <span class="main">∉</span> FV <span class="free">t''</span> <span class="main">∪</span> FV <span class="free">x</span> <span class="main">∪</span> FV <span class="free">y</span>›</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹ok <span class="free">env</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">env</span> <span class="main">=</span> <span class="free">env'</span><span class="main">⦇</span><span class="free">s</span><span class="main">:</span><span class="free">A</span><span class="main">⦈</span><span class="main">⦇</span><span class="free">p</span><span class="main">:</span><span class="free">B</span><span class="main">⦈</span>›</span></span> ok_add_2<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">env'</span></span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="free">A</span></span> <span class="quoted"><span class="free">p</span></span> <span class="quoted"><span class="free">B</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ok <span class="free">env'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">from</span></span> nin_sa nin_pa <span class="quoted"><span class="quoted">‹<span class="skolem">sa</span> <span class="main">≠</span> <span class="skolem">pa</span>›</span></span> env_add_dom<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> 
    <span class="keyword3"><span class="command">obtain</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">sa</span> <span class="main">∉</span> env_dom <span class="free">env'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">pa</span> <span class="main">∉</span> env_dom <span class="main">(</span><span class="free">env'</span><span class="main">⦇</span><span class="skolem">sa</span><span class="main">:</span><span class="free">T</span><span class="main">⦈</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">note</span></span> 
      bigger_env_lemma<span class="main">[</span><span class="operator">OF</span> bigger_env_lemma<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">env'</span> <span class="main">⊢</span> <span class="free">x</span> <span class="main">:</span> <span class="free">A</span>›</span></span> this<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span> this<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span>
      bigger_env_lemma<span class="main">[</span><span class="operator">OF</span> bigger_env_lemma<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">env'</span> <span class="main">⊢</span> <span class="free">y</span> <span class="main">:</span> <span class="free">B</span>›</span></span> this<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span> this<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">}</span></span><span class="keyword1"><span class="command">note</span></span> 
      this<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"param<span class="main">(</span>the<span class="main">(</span><span class="free">T</span><span class="main">^</span><span class="free">l</span><span class="main">)</span><span class="main">)</span>"</span></span><span class="main">]</span> 
      this<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"param<span class="main">(</span>the<span class="main">(</span><span class="free">T</span><span class="main">^</span><span class="free">l</span><span class="main">)</span><span class="main">)</span>"</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="free">t</span> <span class="main">=</span> <span class="main">{</span>Suc <span class="free">n</span> <span class="main">→</span> <span class="main">[</span>Fvar <span class="free">s</span><span class="main">,</span>Fvar <span class="free">p</span><span class="main">]}</span> <span class="free">t'</span>›</span></span> sopen_commute<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="main">0</span></span> <span class="quoted"><span class="quoted">"Suc <span class="free">n</span>"</span></span> <span class="quoted"><span class="skolem">sa</span></span> <span class="quoted"><span class="skolem">pa</span></span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="free">p</span></span> <span class="quoted"><span class="free">t'</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">t</span><span class="hidden">⇗</span><sup>[Fvar <span class="skolem">sa</span><span class="main">,</span>Fvar <span class="skolem">pa</span>]</sup><span class="hidden">⇖</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span>Suc <span class="free">n</span> <span class="main">→</span> <span class="main">[</span>Fvar <span class="free">s</span><span class="main">,</span>Fvar <span class="free">p</span><span class="main">]}</span> <span class="main">(</span><span class="free">t'</span><span class="hidden">⇗</span><sup>[Fvar <span class="skolem">sa</span><span class="main">,</span>Fvar <span class="skolem">pa</span>]</sup><span class="hidden">⇖</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> openz_def<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">from</span></span> 
    subst_add<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">p</span></span> <span class="quoted"><span class="skolem">sa</span></span> <span class="quoted"><span class="quoted">"<span class="free">env'</span><span class="main">⦇</span><span class="free">s</span><span class="main">:</span><span class="free">A</span><span class="main">⦈</span>"</span></span> <span class="quoted"><span class="free">B</span></span> <span class="quoted"><span class="free">T</span></span><span class="main">]</span> subst_add<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="skolem">sa</span></span> <span class="quoted"><span class="free">env'</span></span> <span class="quoted"><span class="free">A</span></span> <span class="quoted"><span class="free">T</span></span><span class="main">]</span>
    subst_add<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">p</span></span> <span class="quoted"><span class="skolem">pa</span></span> <span class="quoted"><span class="quoted">"<span class="free">env'</span><span class="main">⦇</span><span class="skolem">sa</span><span class="main">:</span><span class="free">T</span><span class="main">⦈</span><span class="main">⦇</span><span class="free">s</span><span class="main">:</span><span class="free">A</span><span class="main">⦈</span>"</span></span> <span class="quoted"><span class="free">B</span></span> <span class="quoted"><span class="quoted">"param<span class="main">(</span>the<span class="main">(</span><span class="free">T</span><span class="main">^</span><span class="free">l</span><span class="main">)</span><span class="main">)</span>"</span></span><span class="main">]</span> 
    subst_add<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="skolem">pa</span></span> <span class="quoted"><span class="quoted">"<span class="free">env'</span><span class="main">⦇</span><span class="skolem">sa</span><span class="main">:</span><span class="free">T</span><span class="main">⦈</span>"</span></span> <span class="quoted"><span class="free">A</span></span> <span class="quoted"><span class="quoted">"param<span class="main">(</span>the<span class="main">(</span><span class="free">T</span><span class="main">^</span><span class="free">l</span><span class="main">)</span><span class="main">)</span>"</span></span><span class="main">]</span>
    <span class="quoted"><span class="quoted">‹<span class="free">env</span> <span class="main">=</span> <span class="free">env'</span><span class="main">⦇</span><span class="free">s</span><span class="main">:</span><span class="free">A</span><span class="main">⦈</span><span class="main">⦇</span><span class="free">p</span><span class="main">:</span><span class="free">B</span><span class="main">⦈</span>›</span></span> nin_sa nin_pa
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">env</span><span class="main">⦇</span><span class="skolem">sa</span><span class="main">:</span><span class="free">T</span><span class="main">⦈</span><span class="main">⦇</span><span class="skolem">pa</span><span class="main">:</span>param<span class="main">(</span>the<span class="main">(</span><span class="free">T</span><span class="main">^</span><span class="free">l</span><span class="main">)</span><span class="main">)</span><span class="main">⦈</span> <span class="main">=</span> <span class="free">env'</span><span class="main">⦇</span><span class="skolem">sa</span><span class="main">:</span><span class="free">T</span><span class="main">⦈</span><span class="main">⦇</span><span class="skolem">pa</span><span class="main">:</span>param<span class="main">(</span>the<span class="main">(</span><span class="free">T</span><span class="main">^</span><span class="free">l</span><span class="main">)</span><span class="main">)</span><span class="main">⦈</span><span class="main">⦇</span><span class="free">s</span><span class="main">:</span><span class="free">A</span><span class="main">⦈</span><span class="main">⦇</span><span class="free">p</span><span class="main">:</span><span class="free">B</span><span class="main">⦈</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword3"><span class="command">show</span></span> 
    <span class="quoted"><span class="quoted">"<span class="free">env'</span><span class="main">⦇</span><span class="skolem">sa</span><span class="main">:</span><span class="free">T</span><span class="main">⦈</span><span class="main">⦇</span><span class="skolem">pa</span><span class="main">:</span>param<span class="main">(</span>the<span class="main">(</span><span class="free">T</span><span class="main">^</span><span class="free">l</span><span class="main">)</span><span class="main">)</span><span class="main">⦈</span>
     <span class="main">⊢</span> <span class="main">(</span><span class="main">{</span>Suc <span class="free">n</span> <span class="main">→</span> <span class="main">[</span><span class="free">x</span><span class="main">,</span><span class="free">y</span><span class="main">]}</span> <span class="free">t'</span><span class="hidden">⇗</span><sup>[Fvar <span class="skolem">sa</span><span class="main">,</span> Fvar <span class="skolem">pa</span>]</sup><span class="hidden">⇖</span><span class="main">)</span> <span class="main">:</span> return<span class="main">(</span>the<span class="main">(</span><span class="free">T</span><span class="main">^</span><span class="free">l</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> 
      pred_bnd <span class="quoted"><span class="quoted">‹<span class="free">s</span> <span class="main">≠</span> <span class="free">p</span>›</span></span>
      sopen_commute_gen<span class="main">[</span><span class="operator">OF</span> lc_Fvar<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem">sa</span></span><span class="main"><span class="main">]</span></span> lc_Fvar<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem">pa</span></span><span class="main"><span class="main">]</span></span> 
                           typing_regular''<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">env'</span> <span class="main">⊢</span> <span class="free">x</span> <span class="main">:</span> <span class="free">A</span>›</span></span><span class="main"><span class="main">]</span></span> 
                           typing_regular''<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">env'</span> <span class="main">⊢</span> <span class="free">y</span> <span class="main">:</span> <span class="free">B</span>›</span></span><span class="main"><span class="main">]</span></span>
                           not_sym<span class="main"><span class="main">[</span></span><span class="operator">OF</span> Suc_not_Zero<span class="main"><span class="main">]</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> openz_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(* A variation of the Type Renaming lemma above. This is stronger and could be extended to show type renaming, using that a term typed in one environment is typed in any bigger environment *)</span>
<span class="comment1">(* TODO: refactor to work with typing_induct *)</span>
<span class="keyword1" id="TypedSigma-open_lemma'"><span class="command">lemma</span></span> open_lemma'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">e</span> <span class="main">⊢</span> <span class="free">t</span> <span class="main">:</span> <span class="free">C</span> 
  <span class="main">⟹</span> <span class="main">(</span><span class="main">⋀</span><span class="bound">env</span> <span class="bound">t'</span> <span class="bound">s</span> <span class="bound">p</span> <span class="bound">x</span> <span class="bound">y</span> <span class="bound">A</span> <span class="bound">B</span> <span class="bound">n</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∉</span> FV <span class="bound">t'</span> <span class="main">∪</span> FV <span class="bound">x</span> <span class="main">∪</span> FV <span class="bound">y</span> 
         <span class="main">⟹</span> <span class="bound">p</span> <span class="main">∉</span> FV <span class="bound">t'</span> <span class="main">∪</span> FV <span class="bound">x</span> <span class="main">∪</span> FV <span class="bound">y</span> <span class="main">⟹</span> <span class="bound">s</span> <span class="main">≠</span> <span class="bound">p</span>
         <span class="main">⟹</span> <span class="bound">env</span> <span class="main">⊢</span> <span class="bound">x</span> <span class="main">:</span> <span class="bound">A</span> <span class="main">⟹</span> <span class="bound">env</span> <span class="main">⊢</span> <span class="bound">y</span> <span class="main">:</span> <span class="bound">B</span> 
         <span class="main">⟹</span> <span class="free">t</span> <span class="main">=</span> <span class="main">{</span><span class="bound">n</span> <span class="main">→</span> <span class="main">[</span>Fvar <span class="bound">s</span><span class="main">,</span>Fvar <span class="bound">p</span><span class="main">]}</span> <span class="bound">t'</span>
         <span class="main">⟹</span> <span class="free">e</span> <span class="main">=</span> <span class="bound">env</span><span class="main">⦇</span><span class="bound">s</span><span class="main">:</span><span class="bound">A</span><span class="main">⦈</span><span class="main">⦇</span><span class="bound">p</span><span class="main">:</span><span class="bound">B</span><span class="main">⦈</span>
         <span class="main">⟹</span> <span class="bound">env</span> <span class="main">⊢</span> <span class="main">{</span><span class="bound">n</span> <span class="main">→</span> <span class="main">[</span><span class="bound">x</span><span class="main">,</span><span class="bound">y</span><span class="main">]}</span> <span class="bound">t'</span> <span class="main">:</span> <span class="free">C</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">set</span><span class="main"><span class="main">:</span></span>typing<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>T_Var <span class="skolem">env</span> <span class="skolem">x</span> <span class="skolem">T</span> <span class="skolem">env'</span> <span class="skolem">t'</span> <span class="skolem">s</span> <span class="skolem">p</span> <span class="skolem">y</span> <span class="skolem">z</span> <span class="skolem">A</span> <span class="skolem">B</span> <span class="skolem">n</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> sopen_eq_Fvar<span class="main">[</span><span class="operator">OF</span> sym<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹Fvar <span class="skolem">x</span> <span class="main">=</span> <span class="main">{</span><span class="skolem">n</span> <span class="main">→</span> <span class="main">[</span>Fvar <span class="skolem">s</span><span class="main">,</span>Fvar <span class="skolem">p</span><span class="main">]}</span> <span class="skolem">t'</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span> 
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">elim</span> disjE conjE<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t'</span> <span class="main">=</span> Fvar <span class="skolem">x</span>"</span></span> 
    <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">s</span> <span class="main">∉</span> FV <span class="skolem">t'</span> <span class="main">∪</span> FV <span class="skolem">y</span> <span class="main">∪</span> FV <span class="skolem">z</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="main">∉</span> FV <span class="skolem">t'</span> <span class="main">∪</span> FV <span class="skolem">y</span> <span class="main">∪</span> FV <span class="skolem">z</span>›</span></span> 
    <span class="keyword3"><span class="command">obtain</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≠</span> <span class="skolem">s</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≠</span> <span class="skolem">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> env_dom <span class="skolem">env</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">env</span> <span class="main">=</span> <span class="skolem">env'</span><span class="main">⦇</span><span class="skolem">s</span><span class="main">:</span><span class="skolem">A</span><span class="main">⦈</span><span class="main">⦇</span><span class="skolem">p</span><span class="main">:</span><span class="skolem">B</span><span class="main">⦈</span>›</span></span> in_env_smaller2<span class="main">[</span><span class="operator">OF</span> _ this<span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> indom<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> env_dom <span class="skolem">env'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">from</span></span> 
      <span class="quoted"><span class="quoted">‹ok <span class="skolem">env</span>›</span></span> <span class="quoted"><span class="quoted">‹the <span class="skolem">env</span><span class="main">!</span><span class="skolem">x</span> <span class="main">=</span> <span class="skolem">T</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">env</span> <span class="main">=</span> <span class="skolem">env'</span><span class="main">⦇</span><span class="skolem">s</span><span class="main">:</span><span class="skolem">A</span><span class="main">⦈</span><span class="main">⦇</span><span class="skolem">p</span><span class="main">:</span><span class="skolem">B</span><span class="main">⦈</span>›</span></span>
      ok_add_2<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">env'</span></span> <span class="quoted"><span class="skolem">s</span></span> <span class="quoted"><span class="skolem">A</span></span> <span class="quoted"><span class="skolem">p</span></span> <span class="quoted"><span class="skolem">B</span></span><span class="main">]</span> get_env_smaller2<span class="main">[</span><span class="operator">OF</span> this _ _ <span class="quoted"><span class="quoted">‹<span class="skolem">s</span> <span class="main">≠</span> <span class="skolem">p</span>›</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"the <span class="skolem">env'</span><span class="main">!</span><span class="skolem">x</span> <span class="main">=</span> <span class="skolem">T</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">from</span></span> 
      <span class="quoted"><span class="quoted">‹ok <span class="skolem">env</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">env</span> <span class="main">=</span> <span class="skolem">env'</span><span class="main">⦇</span><span class="skolem">s</span><span class="main">:</span><span class="skolem">A</span><span class="main">⦈</span><span class="main">⦇</span><span class="skolem">p</span><span class="main">:</span><span class="skolem">B</span><span class="main">⦈</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">t'</span> <span class="main">=</span> Fvar <span class="skolem">x</span>›</span></span>
      ok_add_2<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">env'</span></span> <span class="quoted"><span class="skolem">s</span></span> <span class="quoted"><span class="skolem">A</span></span> <span class="quoted"><span class="skolem">p</span></span> <span class="quoted"><span class="skolem">B</span></span><span class="main">]</span> typing.T_Var<span class="main">[</span><span class="operator">OF</span> _ indom this<span class="main">]</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> 
      <span class="quoted"><span class="quoted">‹ok <span class="skolem">env</span>›</span></span> <span class="quoted"><span class="quoted">‹the <span class="skolem">env</span><span class="main">!</span><span class="skolem">x</span> <span class="main">=</span> <span class="skolem">T</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">env</span> <span class="main">=</span> <span class="skolem">env'</span><span class="main">⦇</span><span class="skolem">s</span><span class="main">:</span><span class="skolem">A</span><span class="main">⦈</span><span class="main">⦇</span><span class="skolem">p</span><span class="main">:</span><span class="skolem">B</span><span class="main">⦈</span>›</span></span> 
      add_get2_1<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">env'</span></span> <span class="quoted"><span class="skolem">s</span></span> <span class="quoted"><span class="skolem">A</span></span> <span class="quoted"><span class="skolem">p</span></span> <span class="quoted"><span class="skolem">B</span></span><span class="main">]</span> 
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">T</span> <span class="main">=</span> <span class="skolem">A</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t'</span> <span class="main">=</span> Bvar <span class="main">(</span>Self <span class="skolem">n</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">env'</span> <span class="main">⊢</span> <span class="skolem">y</span> <span class="main">:</span> <span class="skolem">A</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="skolem">p</span>"</span></span> 
    <span class="keyword1"><span class="command">with</span></span> 
      <span class="quoted"><span class="quoted">‹ok <span class="skolem">env</span>›</span></span> <span class="quoted"><span class="quoted">‹the <span class="skolem">env</span><span class="main">!</span><span class="skolem">x</span> <span class="main">=</span> <span class="skolem">T</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">env</span> <span class="main">=</span> <span class="skolem">env'</span><span class="main">⦇</span><span class="skolem">s</span><span class="main">:</span><span class="skolem">A</span><span class="main">⦈</span><span class="main">⦇</span><span class="skolem">p</span><span class="main">:</span><span class="skolem">B</span><span class="main">⦈</span>›</span></span> 
      add_get2_2<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">env'</span></span> <span class="quoted"><span class="skolem">s</span></span> <span class="quoted"><span class="skolem">A</span></span> <span class="quoted"><span class="skolem">p</span></span> <span class="quoted"><span class="skolem">B</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">T</span> <span class="main">=</span> <span class="skolem">B</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t'</span> <span class="main">=</span> Bvar <span class="main">(</span>Param <span class="skolem">n</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">env'</span> <span class="main">⊢</span> <span class="skolem">z</span> <span class="main">:</span> <span class="skolem">B</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>T_Upd <span class="skolem">F</span> <span class="skolem">env</span> <span class="skolem">T</span> <span class="skolem">l</span> <span class="skolem">t2</span> <span class="skolem">t1</span> <span class="skolem">env'</span> <span class="skolem">t'</span> <span class="skolem">s</span> <span class="skolem">p</span> <span class="skolem">x</span> <span class="skolem">y</span> <span class="skolem">A</span> <span class="skolem">B</span> <span class="skolem">n</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> sopen_eq_Upd<span class="main">[</span><span class="operator">OF</span> sym<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹Upd <span class="skolem">t1</span> <span class="skolem">l</span> <span class="skolem">t2</span> <span class="main">=</span> <span class="main">{</span><span class="skolem">n</span> <span class="main">→</span> <span class="main">[</span>Fvar <span class="skolem">s</span><span class="main">,</span>Fvar <span class="skolem">p</span><span class="main">]}</span> <span class="skolem">t'</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t1'</span></span> <span class="skolem"><span class="skolem">t2'</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
    t1'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t1</span> <span class="main">=</span> <span class="main">{</span><span class="skolem">n</span> <span class="main">→</span> <span class="main">[</span>Fvar <span class="skolem">s</span><span class="main">,</span>Fvar <span class="skolem">p</span><span class="main">]}</span> <span class="skolem">t1'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    t2'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t2</span> <span class="main">=</span> <span class="main">{</span>Suc <span class="skolem">n</span> <span class="main">→</span> <span class="main">[</span>Fvar <span class="skolem">s</span><span class="main">,</span>Fvar <span class="skolem">p</span><span class="main">]}</span> <span class="skolem">t2'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    t'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t'</span> <span class="main">=</span> Upd <span class="skolem">t1'</span> <span class="skolem">l</span> <span class="skolem">t2'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"FV <span class="skolem">t2'</span> <span class="main">⊆</span> FV <span class="skolem">t'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> 
    <span class="quoted"><span class="quoted">‹<span class="skolem">s</span> <span class="main">∉</span> FV <span class="skolem">t'</span> <span class="main">∪</span> FV <span class="skolem">x</span> <span class="main">∪</span> FV <span class="skolem">y</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="main">∉</span> FV <span class="skolem">t'</span> <span class="main">∪</span> FV <span class="skolem">x</span> <span class="main">∪</span> FV <span class="skolem">y</span>›</span></span>
    t' <span class="quoted"><span class="quoted">‹finite <span class="skolem">F</span>›</span></span> ok_finite<span class="main">[</span><span class="operator">OF</span> typing_regular'<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">env'</span> <span class="main">⊢</span> <span class="skolem">x</span> <span class="main">:</span> <span class="skolem">A</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span>
    typing.T_Upd<span class="main">[</span><span class="operator">OF</span> _ bnd_open_lem<span class="main"><span class="main">[</span></span><span class="operator">OF</span> T_Upd<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> 
                    typing_regular'<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">env</span> <span class="main">⊢</span> <span class="skolem">t1</span> <span class="main">:</span> <span class="skolem">T</span>›</span></span><span class="main"><span class="main">]</span></span> 
                    <span class="quoted"><span class="quoted">‹<span class="skolem">env</span> <span class="main">=</span> <span class="skolem">env'</span><span class="main">⦇</span><span class="skolem">s</span><span class="main">:</span><span class="skolem">A</span><span class="main">⦈</span><span class="main">⦇</span><span class="skolem">p</span><span class="main">:</span><span class="skolem">B</span><span class="main">⦈</span>›</span></span> 
                    <span class="quoted"><span class="quoted">‹<span class="skolem">s</span> <span class="main">∉</span> FV <span class="skolem">t'</span> <span class="main">∪</span> FV <span class="skolem">x</span> <span class="main">∪</span> FV <span class="skolem">y</span>›</span></span> 
                    <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="main">∉</span> FV <span class="skolem">t'</span> <span class="main">∪</span> FV <span class="skolem">x</span> <span class="main">∪</span> FV <span class="skolem">y</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">s</span> <span class="main">≠</span> <span class="skolem">p</span>›</span></span>
                    <span class="quoted"><span class="quoted">‹<span class="skolem">env'</span> <span class="main">⊢</span> <span class="skolem">x</span> <span class="main">:</span> <span class="skolem">A</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">env'</span> <span class="main">⊢</span> <span class="skolem">y</span> <span class="main">:</span> <span class="skolem">B</span>›</span></span> t2' this<span class="main"><span class="main">]</span></span>
    T_Upd<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ _ <span class="quoted"><span class="quoted">‹<span class="skolem">s</span> <span class="main">≠</span> <span class="skolem">p</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">env'</span> <span class="main">⊢</span> <span class="skolem">x</span> <span class="main">:</span> <span class="skolem">A</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">env'</span> <span class="main">⊢</span> <span class="skolem">y</span> <span class="main">:</span> <span class="skolem">B</span>›</span></span> 
                t1' <span class="quoted"><span class="quoted">‹<span class="skolem">env</span> <span class="main">=</span> <span class="skolem">env'</span><span class="main">⦇</span><span class="skolem">s</span><span class="main">:</span><span class="skolem">A</span><span class="main">⦈</span><span class="main">⦇</span><span class="skolem">p</span><span class="main">:</span><span class="skolem">B</span><span class="main">⦈</span>›</span></span><span class="main"><span class="main">]</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">l</span> <span class="main">∈</span> do <span class="skolem">T</span>›</span></span><span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>T_Obj <span class="skolem">env</span> <span class="skolem">f</span> <span class="skolem">T</span> <span class="skolem">F</span> <span class="skolem">env'</span> <span class="skolem">t'</span> <span class="skolem">s</span> <span class="skolem">p</span> <span class="skolem">x</span> <span class="skolem">y</span> <span class="skolem">A</span> <span class="skolem">B</span> <span class="skolem">n</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> sopen_eq_Obj<span class="main">[</span><span class="operator">OF</span> sym<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹Obj <span class="skolem">f</span> <span class="skolem">T</span> <span class="main">=</span> <span class="main">{</span><span class="skolem">n</span> <span class="main">→</span> <span class="main">[</span>Fvar <span class="skolem">s</span><span class="main">,</span>Fvar <span class="skolem">p</span><span class="main">]}</span> <span class="skolem">t'</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">f'</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
    obj<span class="main">:</span> <span class="quoted"><span class="quoted">"Obj <span class="skolem">f</span> <span class="skolem">T</span> <span class="main">=</span> <span class="main">{</span><span class="skolem">n</span> <span class="main">→</span> <span class="main">[</span>Fvar <span class="skolem">s</span><span class="main">,</span>Fvar <span class="skolem">p</span><span class="main">]}</span> Obj <span class="skolem">f'</span> <span class="skolem">T</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 
    t'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t'</span> <span class="main">=</span> Obj <span class="skolem">f'</span> <span class="skolem">T</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> 
    sym<span class="main">[</span><span class="operator">OF</span> this<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="quoted"><span class="quoted">‹dom <span class="skolem">f</span> <span class="main">=</span> do <span class="skolem">T</span>›</span></span>
    sym<span class="main">[</span><span class="operator">OF</span> dom_sopenoption_lem<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">n</span>"</span></span> <span class="quoted"><span class="quoted">"Fvar <span class="skolem">s</span>"</span></span> <span class="quoted"><span class="quoted">"Fvar <span class="skolem">p</span>"</span></span> <span class="quoted"><span class="skolem">f'</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span>
    dom_sopenoption_lem<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">n</span>"</span></span> <span class="quoted"><span class="skolem">x</span></span> <span class="quoted"><span class="skolem">y</span></span> <span class="quoted"><span class="skolem">f'</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> dom<span class="main">:</span> <span class="quoted"><span class="quoted">"dom <span class="main">(</span><span class="main">λ</span><span class="bound">l</span><span class="main">.</span> sopen_option <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="skolem">x</span> <span class="skolem">y</span> <span class="main">(</span><span class="skolem">f'</span> <span class="bound">l</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> do <span class="skolem">T</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹finite <span class="skolem">F</span>›</span></span> ok_finite<span class="main">[</span><span class="operator">OF</span> typing_regular'<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">env'</span> <span class="main">⊢</span> <span class="skolem">x</span> <span class="main">:</span> <span class="skolem">A</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span> 
  <span class="keyword1"><span class="command">have</span></span> finF<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="skolem">F</span> <span class="main">∪</span> <span class="main">{</span><span class="skolem">s</span><span class="main">,</span><span class="skolem">p</span><span class="main">}</span> <span class="main">∪</span> env_dom <span class="skolem">env'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command">have</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">l</span><span class="main">∈</span>do <span class="skolem">T</span><span class="main">.</span> <span class="main">∀</span><span class="bound">sa</span> <span class="bound">pa</span><span class="main">.</span> <span class="bound">sa</span> <span class="main">∉</span> <span class="skolem">F</span> <span class="main">∪</span> <span class="main">{</span><span class="skolem">s</span><span class="main">,</span><span class="skolem">p</span><span class="main">}</span> <span class="main">∪</span> env_dom <span class="skolem">env'</span> 
                     <span class="main">∧</span> <span class="bound">pa</span> <span class="main">∉</span> <span class="skolem">F</span> <span class="main">∪</span> <span class="main">{</span><span class="skolem">s</span><span class="main">,</span><span class="skolem">p</span><span class="main">}</span> <span class="main">∪</span> env_dom <span class="skolem">env'</span> 
                     <span class="main">∧</span> <span class="bound">sa</span> <span class="main">≠</span> <span class="bound">pa</span> 
      <span class="main">⟶</span> <span class="skolem">env'</span><span class="main">⦇</span><span class="bound">sa</span><span class="main">:</span><span class="skolem">T</span><span class="main">⦈</span><span class="main">⦇</span><span class="bound">pa</span><span class="main">:</span>param<span class="main">(</span>the<span class="main">(</span><span class="skolem">T</span><span class="main">^</span><span class="bound">l</span><span class="main">)</span><span class="main">)</span><span class="main">⦈</span>
          <span class="main">⊢</span> <span class="main">(</span>the<span class="main">(</span>sopen_option <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="skolem">x</span> <span class="skolem">y</span> <span class="main">(</span><span class="skolem">f'</span> <span class="bound">l</span><span class="main">)</span><span class="main">)</span><span class="hidden">⇗</span><sup>[Fvar <span class="bound">sa</span><span class="main">,</span>Fvar <span class="bound">pa</span>]</sup><span class="hidden">⇖</span><span class="main">)</span> <span class="main">:</span> return<span class="main">(</span>the<span class="main">(</span><span class="skolem">T</span><span class="main">^</span><span class="bound">l</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> 
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">l</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">∈</span> do <span class="skolem">T</span>"</span></span> <span class="keyword1"><span class="command">with</span></span> T_Obj<span class="main">(</span>4<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> 
      cof<span class="main">:</span> 
      <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">sa</span> <span class="bound">pa</span><span class="main">.</span> <span class="bound">sa</span> <span class="main">∉</span> <span class="skolem">F</span> <span class="main">∧</span> <span class="bound">pa</span> <span class="main">∉</span> <span class="skolem">F</span> <span class="main">∧</span> <span class="bound">sa</span> <span class="main">≠</span> <span class="bound">pa</span>
        <span class="main">⟶</span> <span class="skolem">env</span><span class="main">⦇</span><span class="bound">sa</span><span class="main">:</span><span class="skolem">T</span><span class="main">⦈</span><span class="main">⦇</span><span class="bound">pa</span><span class="main">:</span>param<span class="main">(</span>the<span class="main">(</span><span class="skolem">T</span><span class="main">^</span><span class="skolem">l</span><span class="main">)</span><span class="main">)</span><span class="main">⦈</span> 
            <span class="main">⊢</span> <span class="main">(</span>the<span class="main">(</span><span class="skolem">f</span> <span class="skolem">l</span><span class="main">)</span><span class="hidden">⇗</span><sup>[Fvar <span class="bound">sa</span><span class="main">,</span>Fvar <span class="bound">pa</span>]</sup><span class="hidden">⇖</span><span class="main">)</span> <span class="main">:</span> return<span class="main">(</span>the<span class="main">(</span><span class="skolem">T</span><span class="main">^</span><span class="skolem">l</span><span class="main">)</span><span class="main">)</span>
          <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">env''</span> <span class="bound">t''</span> <span class="bound">s'</span> <span class="bound">p'</span> <span class="bound">x'</span> <span class="bound">y'</span> <span class="bound">A'</span> <span class="bound">B'</span> <span class="bound">n'</span><span class="main">.</span>
               <span class="bound">s'</span> <span class="main">∉</span> FV <span class="bound">t''</span> <span class="main">∪</span> FV <span class="bound">x'</span> <span class="main">∪</span> FV <span class="bound">y'</span> <span class="main">⟶</span> <span class="bound">p'</span> <span class="main">∉</span> FV <span class="bound">t''</span> <span class="main">∪</span> FV <span class="bound">x'</span> <span class="main">∪</span> FV <span class="bound">y'</span> 
               <span class="main">⟶</span> <span class="bound">s'</span> <span class="main">≠</span> <span class="bound">p'</span> <span class="main">⟶</span> <span class="bound">env''</span> <span class="main">⊢</span> <span class="bound">x'</span> <span class="main">:</span> <span class="bound">A'</span> <span class="main">⟶</span> <span class="bound">env''</span> <span class="main">⊢</span> <span class="bound">y'</span> <span class="main">:</span> <span class="bound">B'</span>
               <span class="main">⟶</span> <span class="main">(</span>the<span class="main">(</span><span class="skolem">f</span> <span class="skolem">l</span><span class="main">)</span><span class="hidden">⇗</span><sup>[Fvar <span class="bound">sa</span><span class="main">,</span>Fvar <span class="bound">pa</span>]</sup><span class="hidden">⇖</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="bound">n'</span> <span class="main">→</span> <span class="main">[</span>Fvar <span class="bound">s'</span><span class="main">,</span>Fvar <span class="bound">p'</span><span class="main">]}</span> <span class="bound">t''</span>
               <span class="main">⟶</span> <span class="skolem">env</span><span class="main">⦇</span><span class="bound">sa</span><span class="main">:</span><span class="skolem">T</span><span class="main">⦈</span><span class="main">⦇</span><span class="bound">pa</span><span class="main">:</span>param<span class="main">(</span>the<span class="main">(</span><span class="skolem">T</span><span class="main">^</span><span class="skolem">l</span><span class="main">)</span><span class="main">)</span><span class="main">⦈</span> <span class="main">=</span> <span class="bound">env''</span><span class="main">⦇</span><span class="bound">s'</span><span class="main">:</span><span class="bound">A'</span><span class="main">⦈</span><span class="main">⦇</span><span class="bound">p'</span><span class="main">:</span><span class="bound">B'</span><span class="main">⦈</span> 
               <span class="main">⟶</span> <span class="bound">env''</span> <span class="main">⊢</span> <span class="main">{</span><span class="bound">n'</span> <span class="main">→</span> <span class="main">[</span><span class="bound">x'</span><span class="main">,</span><span class="bound">y'</span><span class="main">]}</span> <span class="bound">t''</span> <span class="main">:</span> return<span class="main">(</span>the<span class="main">(</span><span class="skolem">T</span><span class="main">^</span><span class="skolem">l</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">from</span></span> 
      <span class="quoted"><span class="quoted">‹<span class="skolem">l</span> <span class="main">∈</span> do <span class="skolem">T</span>›</span></span> <span class="quoted"><span class="quoted">‹dom <span class="skolem">f</span> <span class="main">=</span> do <span class="skolem">T</span>›</span></span> <span class="quoted"><span class="quoted">‹Obj <span class="skolem">f</span> <span class="skolem">T</span> <span class="main">=</span> <span class="main">{</span><span class="skolem">n</span> <span class="main">→</span> <span class="main">[</span>Fvar <span class="skolem">s</span><span class="main">,</span>Fvar <span class="skolem">p</span><span class="main">]}</span> <span class="skolem">t'</span>›</span></span> obj t'
      dom_sopenoption_lem<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">n</span>"</span></span> <span class="quoted"><span class="quoted">"Fvar <span class="skolem">s</span>"</span></span> <span class="quoted"><span class="quoted">"Fvar <span class="skolem">p</span>"</span></span> <span class="quoted"><span class="skolem">f'</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> indomf'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">∈</span> dom <span class="skolem">f'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> obj sopen_option_lem<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">f'</span></span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">n</span>"</span></span> <span class="quoted"><span class="quoted">"Fvar <span class="skolem">s</span>"</span></span> <span class="quoted"><span class="quoted">"Fvar <span class="skolem">p</span>"</span></span><span class="main">]</span> FV_option_lem<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">f'</span></span><span class="main">]</span> t'
    <span class="keyword3"><span class="command">obtain</span></span> 
      <span class="quoted"><span class="quoted">"the<span class="main">(</span><span class="skolem">f</span> <span class="skolem">l</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span>Suc <span class="skolem">n</span> <span class="main">→</span> <span class="main">[</span>Fvar <span class="skolem">s</span><span class="main">,</span>Fvar <span class="skolem">p</span><span class="main">]}</span> the<span class="main">(</span><span class="skolem">f'</span> <span class="skolem">l</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      <span class="quoted"><span class="quoted">"FV <span class="main">(</span>the<span class="main">(</span><span class="skolem">f'</span> <span class="skolem">l</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> FV <span class="skolem">t'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> 
      bnd_open_lem<span class="main">[</span><span class="operator">OF</span> cof <span class="quoted"><span class="quoted">‹ok <span class="skolem">env</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">env</span> <span class="main">=</span> <span class="skolem">env'</span><span class="main">⦇</span><span class="skolem">s</span><span class="main">:</span><span class="skolem">A</span><span class="main">⦈</span><span class="main">⦇</span><span class="skolem">p</span><span class="main">:</span><span class="skolem">B</span><span class="main">⦈</span>›</span></span> 
                      <span class="quoted"><span class="quoted">‹<span class="skolem">s</span> <span class="main">∉</span> FV <span class="skolem">t'</span> <span class="main">∪</span> FV <span class="skolem">x</span> <span class="main">∪</span> FV <span class="skolem">y</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="main">∉</span> FV <span class="skolem">t'</span> <span class="main">∪</span> FV <span class="skolem">x</span> <span class="main">∪</span> FV <span class="skolem">y</span>›</span></span>
                      <span class="quoted"><span class="quoted">‹<span class="skolem">s</span> <span class="main">≠</span> <span class="skolem">p</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">env'</span> <span class="main">⊢</span> <span class="skolem">x</span> <span class="main">:</span> <span class="skolem">A</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">env'</span> <span class="main">⊢</span> <span class="skolem">y</span> <span class="main">:</span> <span class="skolem">B</span>›</span></span> this<span class="main">]</span>
      indomf' sopen_option_lem<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">f'</span></span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">n</span>"</span></span> <span class="quoted"><span class="skolem">x</span></span> <span class="quoted"><span class="skolem">y</span></span><span class="main">]</span> T_Obj<span class="main">(</span>4<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> 
      <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">sa</span> <span class="bound">pa</span><span class="main">.</span> <span class="bound">sa</span> <span class="main">∉</span> <span class="skolem">F</span> <span class="main">∪</span> <span class="main">{</span><span class="skolem">s</span><span class="main">,</span><span class="skolem">p</span><span class="main">}</span> <span class="main">∪</span> env_dom <span class="skolem">env'</span> 
             <span class="main">∧</span> <span class="bound">pa</span> <span class="main">∉</span> <span class="skolem">F</span> <span class="main">∪</span> <span class="main">{</span><span class="skolem">s</span><span class="main">,</span><span class="skolem">p</span><span class="main">}</span> <span class="main">∪</span> env_dom <span class="skolem">env'</span> <span class="main">∧</span> <span class="bound">sa</span> <span class="main">≠</span> <span class="bound">pa</span> 
        <span class="main">⟶</span> <span class="skolem">env'</span><span class="main">⦇</span><span class="bound">sa</span><span class="main">:</span><span class="skolem">T</span><span class="main">⦈</span><span class="main">⦇</span><span class="bound">pa</span><span class="main">:</span>param<span class="main">(</span>the<span class="main">(</span><span class="skolem">T</span><span class="main">^</span><span class="skolem">l</span><span class="main">)</span><span class="main">)</span><span class="main">⦈</span>
            <span class="main">⊢</span> <span class="main">(</span>the<span class="main">(</span>sopen_option <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="skolem">x</span> <span class="skolem">y</span> <span class="main">(</span><span class="skolem">f'</span> <span class="skolem">l</span><span class="main">)</span><span class="main">)</span><span class="hidden">⇗</span><sup>[Fvar <span class="bound">sa</span><span class="main">,</span>Fvar <span class="bound">pa</span>]</sup><span class="hidden">⇖</span><span class="main">)</span> <span class="main">:</span> return<span class="main">(</span>the<span class="main">(</span><span class="skolem">T</span><span class="main">^</span><span class="skolem">l</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">from</span></span> typing.T_Obj<span class="main">[</span><span class="operator">OF</span> typing_regular'<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">env'</span> <span class="main">⊢</span> <span class="skolem">x</span> <span class="main">:</span> <span class="skolem">A</span>›</span></span><span class="main"><span class="main">]</span></span> dom finF this<span class="main">]</span> t' 
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>T_Call <span class="skolem">env</span> <span class="skolem">t1</span> <span class="skolem">T</span> <span class="skolem">t2</span> <span class="skolem">l</span> <span class="skolem">env'</span> <span class="skolem">t'</span> <span class="skolem">s</span> <span class="skolem">p</span> <span class="skolem">x</span> <span class="skolem">y</span> <span class="skolem">A</span> <span class="skolem">B</span> <span class="skolem">n</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> sopen_eq_Call<span class="main">[</span><span class="operator">OF</span> sym<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹Call <span class="skolem">t1</span> <span class="skolem">l</span> <span class="skolem">t2</span> <span class="main">=</span> <span class="main">{</span><span class="skolem">n</span> <span class="main">→</span> <span class="main">[</span>Fvar <span class="skolem">s</span><span class="main">,</span>Fvar <span class="skolem">p</span><span class="main">]}</span> <span class="skolem">t'</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t1'</span></span> <span class="skolem"><span class="skolem">t2'</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
    t1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t1</span> <span class="main">=</span> <span class="main">{</span><span class="skolem">n</span> <span class="main">→</span> <span class="main">[</span>Fvar <span class="skolem">s</span><span class="main">,</span>Fvar <span class="skolem">p</span><span class="main">]}</span> <span class="skolem">t1'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    t2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t2</span> <span class="main">=</span> <span class="main">{</span><span class="skolem">n</span> <span class="main">→</span> <span class="main">[</span>Fvar <span class="skolem">s</span><span class="main">,</span>Fvar <span class="skolem">p</span><span class="main">]}</span> <span class="skolem">t2'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    t'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t'</span> <span class="main">=</span> Call <span class="skolem">t1'</span> <span class="skolem">l</span> <span class="skolem">t2'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∉</span> FV <span class="skolem">t'</span> <span class="main">∪</span> FV <span class="skolem">x</span> <span class="main">∪</span> FV <span class="skolem">y</span>"</span></span> 
    <span class="keyword1"><span class="command">with</span></span> t' <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∉</span> FV <span class="skolem">t1'</span> <span class="main">∪</span> FV <span class="skolem">x</span> <span class="main">∪</span> FV <span class="skolem">y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">}</span></span><span class="keyword1"><span class="command">note</span></span> 
      t1' <span class="main">=</span> T_Call<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> this<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">s</span> <span class="main">∉</span> FV <span class="skolem">t'</span> <span class="main">∪</span> FV <span class="skolem">x</span> <span class="main">∪</span> FV <span class="skolem">y</span>›</span></span><span class="main"><span class="main">]</span></span>
                        this<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="main">∉</span> FV <span class="skolem">t'</span> <span class="main">∪</span> FV <span class="skolem">x</span> <span class="main">∪</span> FV <span class="skolem">y</span>›</span></span><span class="main"><span class="main">]</span></span>
                        <span class="quoted"><span class="quoted">‹<span class="skolem">s</span> <span class="main">≠</span> <span class="skolem">p</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">env'</span> <span class="main">⊢</span> <span class="skolem">x</span> <span class="main">:</span> <span class="skolem">A</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">env'</span> <span class="main">⊢</span> <span class="skolem">y</span> <span class="main">:</span> <span class="skolem">B</span>›</span></span>
                        t1 <span class="quoted"><span class="quoted">‹<span class="skolem">env</span> <span class="main">=</span> <span class="skolem">env'</span><span class="main">⦇</span><span class="skolem">s</span><span class="main">:</span><span class="skolem">A</span><span class="main">⦈</span><span class="main">⦇</span><span class="skolem">p</span><span class="main">:</span><span class="skolem">B</span><span class="main">⦈</span>›</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∉</span> FV <span class="skolem">t'</span> <span class="main">∪</span> FV <span class="skolem">x</span> <span class="main">∪</span> FV <span class="skolem">y</span>"</span></span> 
    <span class="keyword1"><span class="command">with</span></span> t' <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∉</span> FV <span class="skolem">t2'</span> <span class="main">∪</span> FV <span class="skolem">x</span> <span class="main">∪</span> FV <span class="skolem">y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">from</span></span> 
    typing.T_Call<span class="main">[</span><span class="operator">OF</span> t1' T_Call<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">OF</span> this<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">s</span> <span class="main">∉</span> FV <span class="skolem">t'</span> <span class="main">∪</span> FV <span class="skolem">x</span> <span class="main">∪</span> FV <span class="skolem">y</span>›</span></span><span class="main"><span class="main">]</span></span>
                                     this<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="main">∉</span> FV <span class="skolem">t'</span> <span class="main">∪</span> FV <span class="skolem">x</span> <span class="main">∪</span> FV <span class="skolem">y</span>›</span></span><span class="main"><span class="main">]</span></span>
                                     <span class="quoted"><span class="quoted">‹<span class="skolem">s</span> <span class="main">≠</span> <span class="skolem">p</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">env'</span> <span class="main">⊢</span> <span class="skolem">x</span> <span class="main">:</span> <span class="skolem">A</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">env'</span> <span class="main">⊢</span> <span class="skolem">y</span> <span class="main">:</span> <span class="skolem">B</span>›</span></span>
                                     t2 <span class="quoted"><span class="quoted">‹<span class="skolem">env</span> <span class="main">=</span> <span class="skolem">env'</span><span class="main">⦇</span><span class="skolem">s</span><span class="main">:</span><span class="skolem">A</span><span class="main">⦈</span><span class="main">⦇</span><span class="skolem">p</span><span class="main">:</span><span class="skolem">B</span><span class="main">⦈</span>›</span></span><span class="main"><span class="main">]</span></span> 
                     <span class="quoted"><span class="quoted">‹<span class="skolem">l</span> <span class="main">∈</span> do <span class="skolem">T</span>›</span></span><span class="main">]</span>
    t'
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="TypedSigma-open_lemma"><span class="command">lemma</span></span> open_lemma<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">env</span><span class="main">⦇</span><span class="free">s</span><span class="main">:</span><span class="free">A</span><span class="main">⦈</span><span class="main">⦇</span><span class="free">p</span><span class="main">:</span><span class="free">B</span><span class="main">⦈</span> <span class="main">⊢</span> <span class="main">{</span><span class="free">n</span> <span class="main">→</span> <span class="main">[</span>Fvar <span class="free">s</span><span class="main">,</span>Fvar <span class="free">p</span><span class="main">]}</span> <span class="free">t</span> <span class="main">:</span> <span class="free">T</span><span class="main">;</span> 
     <span class="free">s</span> <span class="main">∉</span> FV <span class="free">t</span> <span class="main">∪</span> FV <span class="free">x</span> <span class="main">∪</span> FV <span class="free">y</span><span class="main">;</span>  <span class="free">p</span> <span class="main">∉</span> FV <span class="free">t</span> <span class="main">∪</span> FV <span class="free">x</span> <span class="main">∪</span> FV <span class="free">y</span><span class="main">;</span> <span class="free">s</span> <span class="main">≠</span> <span class="free">p</span><span class="main">;</span> 
     <span class="free">env</span> <span class="main">⊢</span> <span class="free">x</span> <span class="main">:</span> <span class="free">A</span><span class="main">;</span> <span class="free">env</span> <span class="main">⊢</span> <span class="free">y</span> <span class="main">:</span> <span class="free">B</span> <span class="main">⟧</span> 
  <span class="main">⟹</span> <span class="free">env</span> <span class="main">⊢</span> <span class="main">{</span><span class="free">n</span> <span class="main">→</span> <span class="main">[</span><span class="free">x</span><span class="main">,</span><span class="free">y</span><span class="main">]}</span> <span class="free">t</span> <span class="main">:</span> <span class="free">T</span>"</span></span>  
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> open_lemma'<span class="main">)</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Subject reduction›</span></span>
<span class="keyword1" id="TypedSigma-type_dom"><span class="command">lemma</span></span> type_dom<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">env</span> <span class="main">⊢</span> <span class="main">(</span>Obj <span class="free">a</span> <span class="free">A</span><span class="main">)</span> <span class="main">:</span> <span class="free">A</span> <span class="main">⟹</span> dom <span class="free">a</span> <span class="main">=</span> do <span class="free">A</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule</span> typing.cases<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="TypedSigma-select_preserve_type"><span class="command">lemma</span></span> select_preserve_type<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">env</span> <span class="main">⊢</span> Obj <span class="free">f</span> <span class="main">(</span>Object <span class="free">t</span><span class="main">)</span> <span class="main">:</span> Object <span class="free">t</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">∉</span> FV <span class="free">a</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∉</span> FV <span class="free">a</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">env</span><span class="main">⦇</span><span class="free">s</span><span class="main">:</span><span class="main">(</span>Object <span class="free">t</span><span class="main">)</span><span class="main">⦈</span><span class="main">⦇</span><span class="free">p</span><span class="main">:</span>param<span class="main">(</span>the<span class="main">(</span><span class="free">t</span> <span class="free">l2</span><span class="main">)</span><span class="main">)</span><span class="main">⦈</span> <span class="main">⊢</span> <span class="main">(</span><span class="free">a</span><span class="hidden">⇗</span><sup>[Fvar <span class="free">s</span><span class="main">,</span>Fvar <span class="free">p</span>]</sup><span class="hidden">⇖</span><span class="main">)</span> <span class="main">:</span> return<span class="main">(</span>the<span class="main">(</span><span class="free">t</span> <span class="free">l2</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">l1</span> <span class="main">∈</span> dom <span class="free">t</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">l2</span> <span class="main">∈</span> dom <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> 
  <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">F</span><span class="main">.</span> finite <span class="bound">F</span> 
     <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">s</span> <span class="bound">p</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∉</span> <span class="bound">F</span> <span class="main">∧</span> <span class="bound">p</span> <span class="main">∉</span> <span class="bound">F</span> <span class="main">∧</span> <span class="bound">s</span> <span class="main">≠</span> <span class="bound">p</span>
         <span class="main">⟶</span> <span class="free">env</span><span class="main">⦇</span><span class="bound">s</span><span class="main">:</span><span class="main">(</span>Object <span class="free">t</span><span class="main">)</span><span class="main">⦈</span><span class="main">⦇</span><span class="bound">p</span><span class="main">:</span>param<span class="main">(</span>the<span class="main">(</span><span class="free">t</span> <span class="free">l1</span><span class="main">)</span><span class="main">)</span><span class="main">⦈</span>
             <span class="main">⊢</span> <span class="main">(</span>the<span class="main">(</span><span class="main">(</span><span class="free">f</span><span class="main">(</span><span class="free">l2</span> <span class="main">↦</span> <span class="free">a</span><span class="main">)</span><span class="main">)</span> <span class="free">l1</span><span class="main">)</span><span class="hidden">⇗</span><sup>[Fvar <span class="bound">s</span><span class="main">,</span>Fvar <span class="bound">p</span>]</sup><span class="hidden">⇖</span><span class="main">)</span> <span class="main">:</span> return<span class="main">(</span>the<span class="main">(</span><span class="free">t</span> <span class="free">l1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> ok_finite<span class="main">[</span><span class="operator">OF</span> typing_regular'<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">env</span> <span class="main">⊢</span> Obj <span class="free">f</span> <span class="main">(</span>Object <span class="free">t</span><span class="main">)</span> <span class="main">:</span> Object <span class="free">t</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> finF<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="main">{</span><span class="free">s</span><span class="main">,</span><span class="free">p</span><span class="main">}</span> <span class="main">∪</span> env_dom <span class="free">env</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command">{</span></span> 
    <span class="keyword1"><span class="command">note</span></span> 
      ok_env <span class="main">=</span> typing_regular'<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">env</span> <span class="main">⊢</span> Obj <span class="free">f</span> <span class="main">(</span>Object <span class="free">t</span><span class="main">)</span> <span class="main">:</span> Object <span class="free">t</span>›</span></span><span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span>
      ok_env_sp <span class="main">=</span> typing_regular'<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">]</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">sa</span> <span class="skolem">pa</span> <span class="keyword3"><span class="command">assume</span></span> 
      nin_sa<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">sa</span> <span class="main">∉</span> <span class="main">{</span><span class="free">s</span><span class="main">,</span><span class="free">p</span><span class="main">}</span> <span class="main">∪</span> env_dom <span class="free">env</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      nin_pa<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">pa</span> <span class="main">∉</span> <span class="main">{</span><span class="free">s</span><span class="main">,</span><span class="free">p</span><span class="main">}</span> <span class="main">∪</span> env_dom <span class="free">env</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">sa</span> <span class="main">≠</span> <span class="skolem">pa</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> this<span class="main">(</span>1<span class="main">)</span> ok_add_2<span class="main">[</span><span class="operator">OF</span> ok_env_sp<span class="main">]</span> env_add_dom_2<span class="main">[</span><span class="operator">OF</span> ok_env<span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">sa</span> <span class="main">∉</span> env_dom <span class="main">(</span><span class="free">env</span><span class="main">⦇</span><span class="free">s</span><span class="main">:</span>Object <span class="free">t</span><span class="main">⦈</span><span class="main">⦇</span><span class="free">p</span><span class="main">:</span>param<span class="main">(</span>the<span class="main">(</span><span class="free">t</span> <span class="free">l2</span><span class="main">)</span><span class="main">)</span><span class="main">⦈</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">from</span></span> 
      nin_sa bigger_env_lemma<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> this<span class="main">]</span>
      subst_add<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">sa</span></span> <span class="quoted"><span class="free">p</span></span> <span class="quoted"><span class="quoted">"<span class="free">env</span><span class="main">⦇</span><span class="free">s</span><span class="main">:</span>Object <span class="free">t</span><span class="main">⦈</span>"</span></span> <span class="quoted"><span class="quoted">"Object <span class="free">t</span>"</span></span> <span class="quoted"><span class="quoted">"param<span class="main">(</span>the<span class="main">(</span><span class="free">t</span> <span class="free">l2</span><span class="main">)</span><span class="main">)</span>"</span></span><span class="main">]</span>
      subst_add<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">sa</span></span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="free">env</span></span> <span class="quoted"><span class="quoted">"Object <span class="free">t</span>"</span></span> <span class="quoted"><span class="quoted">"Object <span class="free">t</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> 
      aT_sa<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">env</span><span class="main">⦇</span><span class="skolem">sa</span><span class="main">:</span>Object <span class="free">t</span><span class="main">⦈</span><span class="main">⦇</span><span class="free">s</span><span class="main">:</span>Object <span class="free">t</span><span class="main">⦈</span><span class="main">⦇</span><span class="free">p</span><span class="main">:</span>param<span class="main">(</span>the<span class="main">(</span><span class="free">t</span> <span class="free">l2</span><span class="main">)</span><span class="main">)</span><span class="main">⦈</span>
              <span class="main">⊢</span> <span class="main">(</span><span class="free">a</span><span class="hidden">⇗</span><sup>[Fvar <span class="free">s</span><span class="main">,</span>Fvar <span class="free">p</span>]</sup><span class="hidden">⇖</span><span class="main">)</span> <span class="main">:</span> return<span class="main">(</span>the<span class="main">(</span><span class="free">t</span> <span class="free">l2</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">from</span></span> 
      <span class="quoted"><span class="quoted">‹<span class="skolem">sa</span> <span class="main">≠</span> <span class="skolem">pa</span>›</span></span> nin_sa nin_pa env_add_dom<span class="main">[</span><span class="operator">OF</span> ok_env<span class="main">]</span> 
      ok_add_2<span class="main">[</span><span class="operator">OF</span> ok_env_sp<span class="main">]</span>
    <span class="keyword3"><span class="command">obtain</span></span> 
      <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">∉</span> env_dom <span class="main">(</span><span class="free">env</span><span class="main">⦇</span><span class="skolem">sa</span><span class="main">:</span>Object <span class="free">t</span><span class="main">⦈</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∉</span> env_dom <span class="main">(</span><span class="free">env</span><span class="main">⦇</span><span class="skolem">sa</span><span class="main">:</span>Object <span class="free">t</span><span class="main">⦈</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">≠</span> <span class="free">p</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 
      <span class="quoted"><span class="quoted">"<span class="skolem">sa</span> <span class="main">∉</span> env_dom <span class="free">env</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">pa</span> <span class="main">∉</span> env_dom <span class="main">(</span><span class="free">env</span><span class="main">⦇</span><span class="skolem">sa</span><span class="main">:</span>Object <span class="free">t</span><span class="main">⦈</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> env_add_dom_2<span class="main">[</span><span class="operator">OF</span> ok_add_ok<span class="main"><span class="main">[</span></span><span class="operator">OF</span> ok_env this<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span> this<span class="main"><span class="main">(</span></span>1-3<span class="main"><span class="main">)</span></span><span class="main">]</span> nin_pa
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">pa</span> <span class="main">∉</span> env_dom <span class="main">(</span><span class="free">env</span><span class="main">⦇</span><span class="skolem">sa</span><span class="main">:</span>Object <span class="free">t</span><span class="main">⦈</span><span class="main">⦇</span><span class="free">s</span><span class="main">:</span>Object <span class="free">t</span><span class="main">⦈</span><span class="main">⦇</span><span class="free">p</span><span class="main">:</span>param<span class="main">(</span>the<span class="main">(</span><span class="free">t</span> <span class="free">l2</span><span class="main">)</span><span class="main">)</span><span class="main">⦈</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">from</span></span> 
      nin_pa bigger_env_lemma<span class="main">[</span><span class="operator">OF</span> aT_sa this<span class="main">]</span>
      subst_add<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">pa</span></span> <span class="quoted"><span class="free">p</span></span> <span class="quoted"><span class="quoted">"<span class="free">env</span><span class="main">⦇</span><span class="skolem">sa</span><span class="main">:</span>Object <span class="free">t</span><span class="main">⦈</span><span class="main">⦇</span><span class="free">s</span><span class="main">:</span>Object <span class="free">t</span><span class="main">⦈</span>"</span></span> 
                   <span class="quoted"><span class="quoted">"param<span class="main">(</span>the<span class="main">(</span><span class="free">t</span> <span class="free">l2</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"param<span class="main">(</span>the<span class="main">(</span><span class="free">t</span> <span class="free">l2</span><span class="main">)</span><span class="main">)</span>"</span></span><span class="main">]</span>
      subst_add<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">pa</span></span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="quoted">"<span class="free">env</span><span class="main">⦇</span><span class="skolem">sa</span><span class="main">:</span>Object <span class="free">t</span><span class="main">⦈</span>"</span></span> <span class="quoted"><span class="quoted">"param<span class="main">(</span>the<span class="main">(</span><span class="free">t</span> <span class="free">l2</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"Object <span class="free">t</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> 
      aT_sapa<span class="main">:</span> 
      <span class="quoted"><span class="quoted">"<span class="free">env</span><span class="main">⦇</span><span class="skolem">sa</span><span class="main">:</span>Object <span class="free">t</span><span class="main">⦈</span><span class="main">⦇</span><span class="skolem">pa</span><span class="main">:</span>param<span class="main">(</span>the<span class="main">(</span><span class="free">t</span> <span class="free">l2</span><span class="main">)</span><span class="main">)</span><span class="main">⦈</span><span class="main">⦇</span><span class="free">s</span><span class="main">:</span>Object <span class="free">t</span><span class="main">⦈</span><span class="main">⦇</span><span class="free">p</span><span class="main">:</span>param<span class="main">(</span>the<span class="main">(</span><span class="free">t</span> <span class="free">l2</span><span class="main">)</span><span class="main">)</span><span class="main">⦈</span>
      <span class="main">⊢</span> <span class="main">{</span><span class="main">0</span> <span class="main">→</span> <span class="main">[</span>Fvar <span class="free">s</span><span class="main">,</span> Fvar <span class="free">p</span><span class="main">]}</span> <span class="free">a</span> <span class="main">:</span> return<span class="main">(</span>the<span class="main">(</span><span class="free">t</span> <span class="free">l2</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> openz_def<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> nin_sa nin_pa <span class="quoted"><span class="quoted">‹<span class="free">s</span> <span class="main">∉</span> FV <span class="free">a</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">p</span> <span class="main">∉</span> FV <span class="free">a</span>›</span></span> ok_add_2<span class="main">[</span><span class="operator">OF</span> ok_env_sp<span class="main">]</span> 
    <span class="keyword3"><span class="command">obtain</span></span> 
      ninFV_s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">∉</span> FV <span class="free">a</span> <span class="main">∪</span> FV <span class="main">(</span>Fvar <span class="skolem">sa</span><span class="main">)</span> <span class="main">∪</span> FV <span class="main">(</span>Fvar <span class="skolem">pa</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      ninFV_p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∉</span> FV <span class="free">a</span> <span class="main">∪</span> FV <span class="main">(</span>Fvar <span class="skolem">sa</span><span class="main">)</span> <span class="main">∪</span> FV <span class="main">(</span>Fvar <span class="skolem">pa</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">≠</span> <span class="free">p</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> ok_add_2<span class="main">[</span><span class="operator">OF</span> typing_regular'<span class="main"><span class="main">[</span></span><span class="operator">OF</span> aT_sapa<span class="main"><span class="main">]</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> ok_env_sapa<span class="main">:</span> <span class="quoted"><span class="quoted">"ok <span class="main">(</span><span class="free">env</span><span class="main">⦇</span><span class="skolem">sa</span><span class="main">:</span>Object <span class="free">t</span><span class="main">⦈</span><span class="main">⦇</span><span class="skolem">pa</span><span class="main">:</span>param<span class="main">(</span>the<span class="main">(</span><span class="free">t</span> <span class="free">l2</span><span class="main">)</span><span class="main">)</span><span class="main">⦈</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">with</span></span> ok_add_reverse<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> ok_env_pasa<span class="main">:</span> <span class="quoted"><span class="quoted">"ok <span class="main">(</span><span class="free">env</span><span class="main">⦇</span><span class="skolem">pa</span><span class="main">:</span>param<span class="main">(</span>the<span class="main">(</span><span class="free">t</span> <span class="free">l2</span><span class="main">)</span><span class="main">)</span><span class="main">⦈</span><span class="main">⦇</span><span class="skolem">sa</span><span class="main">:</span>Object <span class="free">t</span><span class="main">⦈</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

    <span class="keyword1"><span class="command">from</span></span> 
      open_lemma<span class="main">[</span><span class="operator">OF</span> aT_sapa ninFV_s ninFV_p <span class="quoted"><span class="quoted">‹<span class="free">s</span> <span class="main">≠</span> <span class="free">p</span>›</span></span> _
                    T_Var<span class="main"><span class="main">[</span></span><span class="operator">OF</span> ok_env_sapa in_add<span class="main"><span class="main">[</span></span><span class="operator">OF</span> ok_env_sapa<span class="main"><span class="main">]</span></span> 
                             add_get2_2<span class="main"><span class="main">[</span></span><span class="operator">OF</span> ok_env_sapa<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span>
      T_Var<span class="main">[</span><span class="operator">OF</span> ok_env_pasa in_add<span class="main"><span class="main">[</span></span><span class="operator">OF</span> ok_env_pasa<span class="main"><span class="main">]</span></span> add_get2_2<span class="main"><span class="main">[</span></span><span class="operator">OF</span> ok_env_pasa<span class="main"><span class="main">]</span></span><span class="main">]</span>
      ok_add_reverse<span class="main">[</span><span class="operator">OF</span> ok_env_sapa<span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> 
      <span class="quoted"><span class="quoted">"<span class="free">env</span><span class="main">⦇</span><span class="skolem">sa</span><span class="main">:</span><span class="main">(</span>Object <span class="free">t</span><span class="main">)</span><span class="main">⦈</span><span class="main">⦇</span><span class="skolem">pa</span><span class="main">:</span>param<span class="main">(</span>the<span class="main">(</span><span class="free">t</span> <span class="free">l2</span><span class="main">)</span><span class="main">)</span><span class="main">⦈</span> 
       <span class="main">⊢</span> <span class="main">(</span><span class="free">a</span><span class="hidden">⇗</span><sup>[Fvar <span class="skolem">sa</span><span class="main">,</span>Fvar <span class="skolem">pa</span>]</sup><span class="hidden">⇖</span><span class="main">)</span> <span class="main">:</span> return<span class="main">(</span>the<span class="main">(</span><span class="free">t</span> <span class="free">l2</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> openz_def<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span><span class="keyword1"><span class="command">note</span></span> alem <span class="main">=</span> this

<span class="comment1">(* case split *)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">l1</span> <span class="main">=</span> <span class="free">l2</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True <span class="keyword1"><span class="command">with</span></span> assms obj_inv_elim'<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">no_asm_simp</span><span class="main"><span class="main">)</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">s</span><span class="main">,</span><span class="free">p</span><span class="main">}</span> <span class="main">∪</span> env_dom <span class="free">env</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main"><span class="keyword3">,</span></span>
          <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> finF alem<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">from</span></span> obj_inv_elim<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">env</span> <span class="main">⊢</span> Obj <span class="free">f</span> <span class="main">(</span>Object <span class="free">t</span><span class="main">)</span> <span class="main">:</span> Object <span class="free">t</span>›</span></span><span class="main">]</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">F</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
      <span class="quoted"><span class="quoted">"finite <span class="skolem">F</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">l</span><span class="main">∈</span>dom <span class="free">t</span><span class="main">.</span> 
        <span class="main">∀</span><span class="bound">s</span> <span class="bound">p</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∉</span> <span class="skolem">F</span> <span class="main">∧</span> <span class="bound">p</span> <span class="main">∉</span> <span class="skolem">F</span> <span class="main">∧</span> <span class="bound">s</span> <span class="main">≠</span> <span class="bound">p</span>
         <span class="main">⟶</span> <span class="free">env</span><span class="main">⦇</span><span class="bound">s</span><span class="main">:</span>Object <span class="free">t</span><span class="main">⦈</span><span class="main">⦇</span><span class="bound">p</span><span class="main">:</span>param<span class="main">(</span>the<span class="main">(</span>Object <span class="free">t</span><span class="main">^</span><span class="bound">l</span><span class="main">)</span><span class="main">)</span><span class="main">⦈</span>
             <span class="main">⊢</span> <span class="main">(</span>the<span class="main">(</span><span class="free">f</span> <span class="bound">l</span><span class="main">)</span><span class="hidden">⇗</span><sup>[Fvar <span class="bound">s</span><span class="main">,</span>Fvar <span class="bound">p</span>]</sup><span class="hidden">⇖</span><span class="main">)</span> <span class="main">:</span> return<span class="main">(</span>the<span class="main">(</span>Object <span class="free">t</span><span class="main">^</span><span class="bound">l</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> this<span class="main">(</span>2<span class="main">)</span> <span class="quoted"><span class="quoted">‹<span class="free">l1</span> <span class="main">∈</span> dom <span class="free">t</span>›</span></span>
    <span class="keyword1"><span class="command">have</span></span> 
      <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">s</span> <span class="bound">p</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∉</span> <span class="skolem">F</span> <span class="main">∧</span> <span class="bound">p</span> <span class="main">∉</span> <span class="skolem">F</span> <span class="main">∧</span> <span class="bound">s</span> <span class="main">≠</span> <span class="bound">p</span>
        <span class="main">⟶</span> <span class="free">env</span><span class="main">⦇</span><span class="bound">s</span><span class="main">:</span>Object <span class="free">t</span><span class="main">⦈</span><span class="main">⦇</span><span class="bound">p</span><span class="main">:</span>param<span class="main">(</span>the<span class="main">(</span>Object <span class="free">t</span><span class="main">^</span><span class="free">l1</span><span class="main">)</span><span class="main">)</span><span class="main">⦈</span>
            <span class="main">⊢</span> <span class="main">(</span>the<span class="main">(</span><span class="free">f</span> <span class="free">l1</span><span class="main">)</span><span class="hidden">⇗</span><sup>[Fvar <span class="bound">s</span><span class="main">,</span>Fvar <span class="bound">p</span>]</sup><span class="hidden">⇖</span><span class="main">)</span> <span class="main">:</span> return<span class="main">(</span>the<span class="main">(</span>Object <span class="free">t</span><span class="main">^</span><span class="free">l1</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹finite <span class="skolem">F</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">l1</span> <span class="main">≠</span> <span class="free">l2</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span><span class="operator">blast</span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Main Lemma›</span></span>
<span class="comment1">(* TODO: refactor to work with typing_induct *)</span>
<span class="keyword1" id="TypedSigma-subject_reduction"><span class="command">lemma</span></span> subject_reduction<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">e</span> <span class="main">⊢</span> <span class="free">t</span> <span class="main">:</span> <span class="free">T</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">⋀</span><span class="bound">t'</span><span class="main">.</span> <span class="free">t</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>β</sub></span> <span class="bound">t'</span> <span class="main">⟹</span> <span class="free">e</span> <span class="main">⊢</span> <span class="bound">t'</span> <span class="main">:</span> <span class="free">T</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">set</span><span class="main"><span class="main">:</span></span> typing<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>T_Var <span class="skolem">env</span> <span class="skolem">x</span> <span class="skolem">T</span> <span class="skolem">t'</span><span class="main">)</span> 
  <span class="keyword1"><span class="command">from</span></span> Fvar_beta<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹Fvar <span class="skolem">x</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>β</sub></span> <span class="skolem">t'</span>›</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> 
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>T_Upd <span class="skolem">F</span> <span class="skolem">env</span> <span class="skolem">T</span> <span class="skolem">l</span> <span class="skolem">t2</span> <span class="skolem">t1</span> <span class="skolem">t'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> Upd_beta<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹Upd <span class="skolem">t1</span> <span class="skolem">l</span> <span class="skolem">t2</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>β</sub></span> <span class="skolem">t'</span>›</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">elim</span> disjE exE conjE<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">t1'</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t1</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>β</sub></span> <span class="skolem">t1'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t'</span> <span class="main">=</span> Upd <span class="skolem">t1'</span> <span class="skolem">l</span> <span class="skolem">t2</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> 
      this<span class="main">(</span>2<span class="main">)</span> T_Upd<span class="main">(</span>2<span class="main">)</span> 
      typing.T_Upd<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹finite <span class="skolem">F</span>›</span></span> _ T_Upd<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">OF</span> this<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">l</span> <span class="main">∈</span> do <span class="skolem">T</span>›</span></span><span class="main">]</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">t2'</span> <span class="skolem">F'</span> 
    <span class="keyword3"><span class="command">assume</span></span> 
      <span class="quoted"><span class="quoted">"finite <span class="skolem">F'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      pred_F'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">s</span> <span class="bound">p</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∉</span> <span class="skolem">F'</span> <span class="main">∧</span> <span class="bound">p</span> <span class="main">∉</span> <span class="skolem">F'</span> <span class="main">∧</span> <span class="bound">s</span> <span class="main">≠</span> <span class="bound">p</span> 
                 <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">t''</span><span class="main">.</span> <span class="skolem">t2</span><span class="hidden">⇗</span><sup>[Fvar <span class="bound">s</span><span class="main">,</span>Fvar <span class="bound">p</span>]</sup><span class="hidden">⇖</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>β</sub></span> <span class="bound">t''</span> <span class="main">∧</span> <span class="skolem">t2'</span> <span class="main">=</span> <span class="keyword1">σ[</span><span class="bound">s</span><span class="main">,</span><span class="bound">p</span><span class="main">]</span> <span class="bound">t''</span><span class="main">)</span>"</span></span>  <span class="keyword2"><span class="keyword">and</span></span>
      t'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t'</span> <span class="main">=</span> Upd <span class="skolem">t1</span> <span class="skolem">l</span> <span class="skolem">t2'</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> 
      <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">s</span> <span class="bound">p</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∉</span> <span class="skolem">F</span> <span class="main">∪</span> <span class="skolem">F'</span> <span class="main">∧</span> <span class="bound">p</span> <span class="main">∉</span> <span class="skolem">F</span> <span class="main">∪</span> <span class="skolem">F'</span> <span class="main">∧</span> <span class="bound">s</span> <span class="main">≠</span> <span class="bound">p</span>
        <span class="main">⟶</span> <span class="skolem">env</span><span class="main">⦇</span><span class="bound">s</span><span class="main">:</span><span class="skolem">T</span><span class="main">⦈</span><span class="main">⦇</span><span class="bound">p</span><span class="main">:</span>param<span class="main">(</span>the<span class="main">(</span><span class="skolem">T</span><span class="main">^</span><span class="skolem">l</span><span class="main">)</span><span class="main">)</span><span class="main">⦈</span> <span class="main">⊢</span> <span class="main">(</span><span class="skolem">t2'</span><span class="hidden">⇗</span><sup>[Fvar <span class="bound">s</span><span class="main">,</span>Fvar <span class="bound">p</span>]</sup><span class="hidden">⇖</span><span class="main">)</span> <span class="main">:</span> return<span class="main">(</span>the<span class="main">(</span><span class="skolem">T</span><span class="main">^</span><span class="skolem">l</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> strip<span class="main"><span class="keyword3">,</span></span> <span class="operator">elim</span> conjE<span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span> <span class="skolem">p</span> <span class="keyword3"><span class="command">assume</span></span> 
        nin_s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∉</span> <span class="skolem">F</span> <span class="main">∪</span> <span class="skolem">F'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
        nin_p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∉</span> <span class="skolem">F</span> <span class="main">∪</span> <span class="skolem">F'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">≠</span> <span class="skolem">p</span>"</span></span>
      <span class="keyword1"><span class="command">with</span></span> pred_F' <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t''</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t2</span><span class="hidden">⇗</span><sup>[Fvar <span class="skolem">s</span><span class="main">,</span>Fvar <span class="skolem">p</span>]</sup><span class="hidden">⇖</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>β</sub></span> <span class="skolem">t''</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t2'</span> <span class="main">=</span> <span class="keyword1">σ[</span><span class="skolem">s</span><span class="main">,</span><span class="skolem">p</span><span class="main">]</span> <span class="skolem">t''</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">with</span></span> beta_lc<span class="main">[</span><span class="operator">OF</span> this<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> sopen_sclose_eq_t<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">t''</span></span> <span class="quoted"><span class="main">0</span></span> <span class="quoted"><span class="skolem">s</span></span> <span class="quoted"><span class="skolem">p</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t2</span><span class="hidden">⇗</span><sup>[Fvar <span class="skolem">s</span><span class="main">,</span>Fvar <span class="skolem">p</span>]</sup><span class="hidden">⇖</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>β</sub></span> <span class="main">(</span><span class="skolem">t2'</span><span class="hidden">⇗</span><sup>[Fvar <span class="skolem">s</span><span class="main">,</span>Fvar <span class="skolem">p</span>]</sup><span class="hidden">⇖</span><span class="main">)</span>"</span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> openz_def closez_def<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> nin_s nin_p <span class="quoted"><span class="quoted">‹<span class="skolem">s</span> <span class="main">≠</span> <span class="skolem">p</span>›</span></span> T_Upd<span class="main">(</span>2<span class="main">)</span> 
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">env</span><span class="main">⦇</span><span class="skolem">s</span><span class="main">:</span><span class="skolem">T</span><span class="main">⦈</span><span class="main">⦇</span><span class="skolem">p</span><span class="main">:</span>param<span class="main">(</span>the<span class="main">(</span><span class="skolem">T</span><span class="main">^</span><span class="skolem">l</span><span class="main">)</span><span class="main">)</span><span class="main">⦈</span> <span class="main">⊢</span> <span class="main">(</span><span class="skolem">t2'</span><span class="hidden">⇗</span><sup>[Fvar <span class="skolem">s</span><span class="main">,</span>Fvar <span class="skolem">p</span>]</sup><span class="hidden">⇖</span><span class="main">)</span> <span class="main">:</span> return<span class="main">(</span>the<span class="main">(</span><span class="skolem">T</span><span class="main">^</span><span class="skolem">l</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">from</span></span> t' <span class="quoted"><span class="quoted">‹finite <span class="skolem">F</span>›</span></span> <span class="quoted"><span class="quoted">‹finite <span class="skolem">F'</span>›</span></span> typing.T_Upd<span class="main">[</span><span class="operator">OF</span> _ this <span class="quoted"><span class="quoted">‹<span class="skolem">env</span> <span class="main">⊢</span> <span class="skolem">t1</span> <span class="main">:</span> <span class="skolem">T</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">l</span> <span class="main">∈</span> do <span class="skolem">T</span>›</span></span><span class="main">]</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">f</span> <span class="skolem">U</span> <span class="keyword3"><span class="command">assume</span></span> 
      <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">∈</span> dom <span class="skolem">f</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"Obj <span class="skolem">f</span> <span class="skolem">U</span> <span class="main">=</span> <span class="skolem">t1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 
      t'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t'</span> <span class="main">=</span> Obj <span class="main">(</span><span class="skolem">f</span><span class="main">(</span><span class="skolem">l</span> <span class="main">↦</span> <span class="skolem">t2</span><span class="main">)</span><span class="main">)</span> <span class="skolem">U</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> this<span class="main">(</span>1-2<span class="main">)</span> <span class="quoted"><span class="quoted">‹<span class="skolem">env</span> <span class="main">⊢</span> <span class="skolem">t1</span> <span class="main">:</span> <span class="skolem">T</span>›</span></span> obj_inv<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">env</span></span> <span class="quoted"><span class="skolem">f</span></span> <span class="quoted"><span class="skolem">U</span></span> <span class="quoted"><span class="skolem">T</span></span><span class="main">]</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
      objT<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">env</span> <span class="main">⊢</span> Obj <span class="skolem">f</span> <span class="main">(</span>Object <span class="skolem">t</span><span class="main">)</span> <span class="main">:</span> <span class="main">(</span>Object <span class="skolem">t</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 
      <span class="quoted"><span class="quoted">"Object <span class="skolem">t</span> <span class="main">=</span> <span class="skolem">T</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">T</span> <span class="main">=</span> <span class="skolem">U</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">T</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> obj_inv_elim<span class="main">[</span><span class="operator">OF</span> objT<span class="main">]</span> <span class="quoted"><span class="quoted">‹Object <span class="skolem">t</span> <span class="main">=</span> <span class="skolem">T</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">l</span> <span class="main">∈</span> dom <span class="skolem">f</span>›</span></span> 
    <span class="keyword1"><span class="command">have</span></span> domf'<span class="main">:</span> <span class="quoted"><span class="quoted">"dom <span class="main">(</span><span class="skolem">f</span><span class="main">(</span><span class="skolem">l</span> <span class="main">↦</span> <span class="skolem">t2</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> do <span class="skolem">T</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> 
      exF<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">l'</span><span class="main">∈</span>do <span class="skolem">T</span><span class="main">.</span> 
             <span class="main">(</span><span class="main">∃</span><span class="bound">F'</span><span class="main">.</span> finite <span class="bound">F'</span> 
                 <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">s</span> <span class="bound">p</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∉</span> <span class="bound">F'</span> <span class="main">∪</span> <span class="main">(</span><span class="skolem">F</span> <span class="main">∪</span> FV <span class="skolem">t2</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">p</span> <span class="main">∉</span> <span class="bound">F'</span> <span class="main">∪</span> <span class="main">(</span><span class="skolem">F</span> <span class="main">∪</span> FV <span class="skolem">t2</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">s</span> <span class="main">≠</span> <span class="bound">p</span> 
                     <span class="main">⟶</span> <span class="skolem">env</span><span class="main">⦇</span><span class="bound">s</span><span class="main">:</span><span class="skolem">T</span><span class="main">⦈</span><span class="main">⦇</span><span class="bound">p</span><span class="main">:</span>param<span class="main">(</span>the<span class="main">(</span><span class="skolem">T</span><span class="main">^</span><span class="bound">l'</span><span class="main">)</span><span class="main">)</span><span class="main">⦈</span>
                         <span class="main">⊢</span> <span class="main">(</span>the <span class="main">(</span><span class="main">(</span><span class="skolem">f</span><span class="main">(</span><span class="skolem">l</span> <span class="main">↦</span> <span class="skolem">t2</span><span class="main">)</span><span class="main">)</span> <span class="bound">l'</span><span class="main">)</span><span class="hidden">⇗</span><sup>[Fvar <span class="bound">s</span><span class="main">,</span>Fvar <span class="bound">p</span>]</sup><span class="hidden">⇖</span><span class="main">)</span> <span class="main">:</span> return<span class="main">(</span>the<span class="main">(</span><span class="skolem">T</span><span class="main">^</span><span class="bound">l'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">l'</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l'</span> <span class="main">∈</span> do <span class="skolem">T</span>"</span></span>
      <span class="keyword1"><span class="command">with</span></span> dom_lem<span class="main">[</span><span class="operator">OF</span> objT<span class="main">]</span> <span class="quoted"><span class="quoted">‹<span class="skolem">l</span> <span class="main">∈</span> dom <span class="skolem">f</span>›</span></span> <span class="quoted"><span class="quoted">‹Object <span class="skolem">t</span> <span class="main">=</span> <span class="skolem">T</span>›</span></span>
      <span class="keyword3"><span class="command">obtain</span></span> ll'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">l'</span> <span class="main">∈</span> dom <span class="skolem">t</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">∈</span> dom <span class="skolem">t</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

      <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹finite <span class="skolem">F</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="skolem">F</span> <span class="main">∪</span> FV <span class="skolem">t2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">from</span></span> exFresh_s_p_cof<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
        nin_s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∉</span> <span class="skolem">F</span> <span class="main">∪</span> FV <span class="skolem">t2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 
        nin_p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∉</span> <span class="skolem">F</span> <span class="main">∪</span> FV <span class="skolem">t2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">≠</span> <span class="skolem">p</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">with</span></span> T_Upd<span class="main">(</span>2<span class="main">)</span> <span class="quoted"><span class="quoted">‹Object <span class="skolem">t</span> <span class="main">=</span> <span class="skolem">T</span>›</span></span> 
      <span class="keyword1"><span class="command">have</span></span> 
        <span class="quoted"><span class="quoted">"<span class="skolem">env</span><span class="main">⦇</span><span class="skolem">s</span><span class="main">:</span>Object <span class="skolem">t</span><span class="main">⦈</span><span class="main">⦇</span><span class="skolem">p</span><span class="main">:</span>param<span class="main">(</span>the<span class="main">(</span><span class="skolem">t</span> <span class="skolem">l</span><span class="main">)</span><span class="main">)</span><span class="main">⦈</span> 
         <span class="main">⊢</span> <span class="main">(</span><span class="skolem">t2</span><span class="hidden">⇗</span><sup>[Fvar <span class="skolem">s</span><span class="main">,</span>Fvar <span class="skolem">p</span>]</sup><span class="hidden">⇖</span><span class="main">)</span> <span class="main">:</span> return<span class="main">(</span>the<span class="main">(</span><span class="skolem">t</span> <span class="skolem">l</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">from</span></span> 
        select_preserve_type<span class="main">[</span><span class="operator">OF</span> objT _ _ this ll'<span class="main">]</span> sym<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹Object <span class="skolem">t</span> <span class="main">=</span> <span class="skolem">T</span>›</span></span><span class="main">]</span>
        nin_s nin_p <span class="quoted"><span class="quoted">‹<span class="skolem">l</span> <span class="main">∈</span> dom <span class="skolem">t</span>›</span></span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">F'</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
        <span class="quoted"><span class="quoted">"finite <span class="skolem">F'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
        <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">s</span> <span class="bound">p</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∉</span> <span class="skolem">F'</span> <span class="main">∧</span> <span class="bound">p</span> <span class="main">∉</span> <span class="skolem">F'</span> <span class="main">∧</span> <span class="bound">s</span> <span class="main">≠</span> <span class="bound">p</span>
          <span class="main">⟶</span> <span class="skolem">env</span><span class="main">⦇</span><span class="bound">s</span><span class="main">:</span><span class="skolem">T</span><span class="main">⦈</span><span class="main">⦇</span><span class="bound">p</span><span class="main">:</span>param<span class="main">(</span>the<span class="main">(</span><span class="skolem">T</span><span class="main">^</span><span class="skolem">l'</span><span class="main">)</span><span class="main">)</span><span class="main">⦈</span>
              <span class="main">⊢</span> <span class="main">(</span>the <span class="main">(</span><span class="main">(</span><span class="skolem">f</span><span class="main">(</span><span class="skolem">l</span> <span class="main">↦</span> <span class="skolem">t2</span><span class="main">)</span><span class="main">)</span> <span class="skolem">l'</span><span class="main">)</span><span class="hidden">⇗</span><sup>[Fvar <span class="bound">s</span><span class="main">,</span>Fvar <span class="bound">p</span>]</sup><span class="hidden">⇖</span><span class="main">)</span> <span class="main">:</span> return<span class="main">(</span>the<span class="main">(</span><span class="skolem">T</span><span class="main">^</span><span class="skolem">l'</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">thus</span></span> 
        <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">F'</span><span class="main">.</span> finite <span class="bound">F'</span> 
            <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">s</span> <span class="bound">p</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∉</span> <span class="bound">F'</span> <span class="main">∪</span> <span class="main">(</span><span class="skolem">F</span> <span class="main">∪</span> FV <span class="skolem">t2</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">p</span> <span class="main">∉</span> <span class="bound">F'</span> <span class="main">∪</span> <span class="main">(</span><span class="skolem">F</span> <span class="main">∪</span> FV <span class="skolem">t2</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">s</span> <span class="main">≠</span> <span class="bound">p</span>
                <span class="main">⟶</span> <span class="skolem">env</span><span class="main">⦇</span><span class="bound">s</span><span class="main">:</span><span class="skolem">T</span><span class="main">⦈</span><span class="main">⦇</span><span class="bound">p</span><span class="main">:</span>param<span class="main">(</span>the<span class="main">(</span><span class="skolem">T</span><span class="main">^</span><span class="skolem">l'</span><span class="main">)</span><span class="main">)</span><span class="main">⦈</span>
                    <span class="main">⊢</span> <span class="main">(</span>the <span class="main">(</span><span class="main">(</span><span class="skolem">f</span><span class="main">(</span><span class="skolem">l</span> <span class="main">↦</span> <span class="skolem">t2</span><span class="main">)</span><span class="main">)</span> <span class="skolem">l'</span><span class="main">)</span><span class="hidden">⇗</span><sup>[Fvar <span class="bound">s</span><span class="main">,</span>Fvar <span class="bound">p</span>]</sup><span class="hidden">⇖</span><span class="main">)</span> <span class="main">:</span> return<span class="main">(</span>the<span class="main">(</span><span class="skolem">T</span><span class="main">^</span><span class="skolem">l'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">Ta</span> <span class="keyword1"><span class="command">from</span></span> finite_dom_fmap <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>do <span class="skolem">Ta</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">Ta</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span> <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">note</span></span> fin_doT <span class="main">=</span> this ball_ex_finite<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"do <span class="skolem">T</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">F</span> <span class="main">∪</span> FV <span class="skolem">t2</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">from</span></span> this<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> this<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem">T</span></span><span class="main"><span class="main">]</span></span> _ exF<span class="main">]</span> <span class="quoted"><span class="quoted">‹finite <span class="skolem">F</span>›</span></span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">F'</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
      <span class="quoted"><span class="quoted">"finite <span class="skolem">F'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">l'</span><span class="main">∈</span>do <span class="skolem">T</span><span class="main">.</span> <span class="main">∀</span><span class="bound">s</span> <span class="bound">p</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∉</span> <span class="skolem">F'</span> <span class="main">∪</span> <span class="main">(</span><span class="skolem">F</span> <span class="main">∪</span> FV <span class="skolem">t2</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">p</span> <span class="main">∉</span> <span class="skolem">F'</span> <span class="main">∪</span> <span class="main">(</span><span class="skolem">F</span> <span class="main">∪</span> FV <span class="skolem">t2</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">s</span> <span class="main">≠</span> <span class="bound">p</span>
                   <span class="main">⟶</span> <span class="skolem">env</span><span class="main">⦇</span><span class="bound">s</span><span class="main">:</span><span class="skolem">T</span><span class="main">⦈</span><span class="main">⦇</span><span class="bound">p</span><span class="main">:</span>param<span class="main">(</span>the<span class="main">(</span><span class="skolem">T</span><span class="main">^</span><span class="bound">l'</span><span class="main">)</span><span class="main">)</span><span class="main">⦈</span>
                       <span class="main">⊢</span> <span class="main">(</span>the <span class="main">(</span><span class="main">(</span><span class="skolem">f</span><span class="main">(</span><span class="skolem">l</span> <span class="main">↦</span> <span class="skolem">t2</span><span class="main">)</span><span class="main">)</span> <span class="bound">l'</span><span class="main">)</span><span class="hidden">⇗</span><sup>[Fvar <span class="bound">s</span><span class="main">,</span>Fvar <span class="bound">p</span>]</sup><span class="hidden">⇖</span><span class="main">)</span> <span class="main">:</span> return<span class="main">(</span>the<span class="main">(</span><span class="skolem">T</span><span class="main">^</span><span class="bound">l'</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹finite <span class="skolem">F'</span>›</span></span> <span class="quoted"><span class="quoted">‹finite <span class="skolem">F</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="skolem">F'</span> <span class="main">∪</span> <span class="main">(</span><span class="skolem">F</span> <span class="main">∪</span> FV <span class="skolem">t2</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">note</span></span> typing.T_Obj<span class="main">[</span><span class="operator">OF</span> typing_regular'<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">env</span> <span class="main">⊢</span> <span class="skolem">t1</span> <span class="main">:</span> <span class="skolem">T</span>›</span></span><span class="main"><span class="main">]</span></span> domf' this<span class="main">]</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> t' <span class="quoted"><span class="quoted">‹<span class="skolem">T</span> <span class="main">=</span> <span class="skolem">U</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>T_Obj <span class="skolem">env</span> <span class="skolem">f</span> <span class="skolem">T</span> <span class="skolem">F</span> <span class="skolem">t'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> Obj_beta<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹Obj <span class="skolem">f</span> <span class="skolem">T</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>β</sub></span> <span class="skolem">t'</span>›</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">elim</span> exE conjE<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">l</span> <span class="skolem">f'</span> <span class="skolem">a</span> <span class="skolem">a'</span> <span class="skolem">F'</span> <span class="keyword3"><span class="command">assume</span></span> 
      <span class="quoted"><span class="quoted">"dom <span class="skolem">f</span> <span class="main">=</span> dom <span class="skolem">f'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">=</span> <span class="skolem">f'</span><span class="main">(</span><span class="skolem">l</span> <span class="main">↦</span> <span class="skolem">a</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">∈</span> dom <span class="skolem">f'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      t'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t'</span> <span class="main">=</span> Obj <span class="main">(</span><span class="skolem">f'</span><span class="main">(</span><span class="skolem">l</span> <span class="main">↦</span> <span class="skolem">a'</span><span class="main">)</span><span class="main">)</span> <span class="skolem">T</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"finite <span class="skolem">F'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      red_sp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">s</span> <span class="bound">p</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∉</span> <span class="skolem">F'</span> <span class="main">∧</span> <span class="bound">p</span> <span class="main">∉</span> <span class="skolem">F'</span> <span class="main">∧</span> <span class="bound">s</span> <span class="main">≠</span> <span class="bound">p</span> 
                <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">t''</span><span class="main">.</span> <span class="skolem">a</span><span class="hidden">⇗</span><sup>[Fvar <span class="bound">s</span><span class="main">,</span> Fvar <span class="bound">p</span>]</sup><span class="hidden">⇖</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>β</sub></span> <span class="bound">t''</span> <span class="main">∧</span> <span class="skolem">a'</span> <span class="main">=</span> <span class="keyword1">σ[</span><span class="bound">s</span><span class="main">,</span><span class="bound">p</span><span class="main">]</span> <span class="bound">t''</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> this<span class="main">(</span>2<span class="main">)</span> <span class="quoted"><span class="quoted">‹dom <span class="skolem">f</span> <span class="main">=</span> do <span class="skolem">T</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> domf'<span class="main">:</span> <span class="quoted"><span class="quoted">"dom <span class="main">(</span><span class="skolem">f'</span><span class="main">(</span><span class="skolem">l</span> <span class="main">↦</span> <span class="skolem">a'</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> do <span class="skolem">T</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> 
      exF<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">l'</span><span class="main">∈</span>do <span class="skolem">T</span><span class="main">.</span> <span class="main">∀</span><span class="bound">s</span> <span class="bound">p</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∉</span> <span class="skolem">F</span> <span class="main">∪</span> <span class="skolem">F'</span> <span class="main">∧</span> <span class="bound">p</span> <span class="main">∉</span> <span class="skolem">F</span> <span class="main">∪</span> <span class="skolem">F'</span> <span class="main">∧</span> <span class="bound">s</span> <span class="main">≠</span> <span class="bound">p</span> 
             <span class="main">⟶</span> <span class="skolem">env</span><span class="main">⦇</span><span class="bound">s</span><span class="main">:</span><span class="skolem">T</span><span class="main">⦈</span><span class="main">⦇</span><span class="bound">p</span><span class="main">:</span>param<span class="main">(</span>the<span class="main">(</span><span class="skolem">T</span><span class="main">^</span><span class="bound">l'</span><span class="main">)</span><span class="main">)</span><span class="main">⦈</span>
                 <span class="main">⊢</span> <span class="main">(</span>the <span class="main">(</span><span class="main">(</span><span class="skolem">f'</span><span class="main">(</span><span class="skolem">l</span> <span class="main">↦</span> <span class="skolem">a'</span><span class="main">)</span><span class="main">)</span> <span class="bound">l'</span><span class="main">)</span><span class="hidden">⇗</span><sup>[Fvar <span class="bound">s</span><span class="main">,</span>Fvar <span class="bound">p</span>]</sup><span class="hidden">⇖</span><span class="main">)</span> <span class="main">:</span> return<span class="main">(</span>the<span class="main">(</span><span class="skolem">T</span><span class="main">^</span><span class="bound">l'</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> strip<span class="main"><span class="keyword3">,</span></span> <span class="operator">elim</span> conjE<span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">l'</span> <span class="skolem">s</span> <span class="skolem">p</span> <span class="keyword3"><span class="command">assume</span></span> 
        <span class="quoted"><span class="quoted">"<span class="skolem">l'</span> <span class="main">∈</span> do <span class="skolem">T</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 
        nin_s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∉</span> <span class="skolem">F</span> <span class="main">∪</span> <span class="skolem">F'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
        nin_p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∉</span> <span class="skolem">F</span> <span class="main">∪</span> <span class="skolem">F'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">≠</span> <span class="skolem">p</span>"</span></span>
      <span class="keyword1"><span class="command">with</span></span> red_sp <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t''</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span><span class="hidden">⇗</span><sup>[Fvar <span class="skolem">s</span><span class="main">,</span>Fvar <span class="skolem">p</span>]</sup><span class="hidden">⇖</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>β</sub></span> <span class="skolem">t''</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a'</span> <span class="main">=</span> <span class="keyword1">σ[</span><span class="skolem">s</span><span class="main">,</span><span class="skolem">p</span><span class="main">]</span> <span class="skolem">t''</span>"</span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">with</span></span> 
        beta_lc<span class="main">[</span><span class="operator">OF</span> this<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> sopen_sclose_eq_t<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">t''</span></span> <span class="quoted"><span class="main">0</span></span> <span class="quoted"><span class="skolem">s</span></span> <span class="quoted"><span class="skolem">p</span></span><span class="main">]</span> 
        <span class="quoted"><span class="quoted">‹<span class="skolem">f</span> <span class="main">=</span> <span class="skolem">f'</span><span class="main">(</span><span class="skolem">l</span> <span class="main">↦</span> <span class="skolem">a</span><span class="main">)</span>›</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"the <span class="main">(</span><span class="skolem">f</span> <span class="skolem">l</span><span class="main">)</span><span class="hidden">⇗</span><sup>[Fvar <span class="skolem">s</span><span class="main">,</span>Fvar <span class="skolem">p</span>]</sup><span class="hidden">⇖</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>β</sub></span> <span class="main">(</span>the<span class="main">(</span><span class="main">(</span><span class="skolem">f'</span><span class="main">(</span><span class="skolem">l</span> <span class="main">↦</span> <span class="skolem">a'</span><span class="main">)</span><span class="main">)</span> <span class="skolem">l</span><span class="main">)</span><span class="hidden">⇗</span><sup>[Fvar <span class="skolem">s</span><span class="main">,</span>Fvar <span class="skolem">p</span>]</sup><span class="hidden">⇖</span><span class="main">)</span>"</span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> openz_def closez_def<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> T_Obj<span class="main">(</span>4<span class="main">)</span> nin_s nin_p <span class="quoted"><span class="quoted">‹<span class="skolem">s</span> <span class="main">≠</span> <span class="skolem">p</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">l'</span> <span class="main">∈</span> do <span class="skolem">T</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">f</span> <span class="main">=</span> <span class="skolem">f'</span><span class="main">(</span><span class="skolem">l</span> <span class="main">↦</span> <span class="skolem">a</span><span class="main">)</span>›</span></span>
      <span class="keyword3"><span class="command">show</span></span> 
        <span class="quoted"><span class="quoted">"<span class="skolem">env</span><span class="main">⦇</span><span class="skolem">s</span><span class="main">:</span><span class="skolem">T</span><span class="main">⦈</span><span class="main">⦇</span><span class="skolem">p</span><span class="main">:</span>param<span class="main">(</span>the<span class="main">(</span><span class="skolem">T</span><span class="main">^</span><span class="skolem">l'</span><span class="main">)</span><span class="main">)</span><span class="main">⦈</span>
         <span class="main">⊢</span> <span class="main">(</span>the<span class="main">(</span><span class="main">(</span><span class="skolem">f'</span><span class="main">(</span><span class="skolem">l</span> <span class="main">↦</span> <span class="skolem">a'</span><span class="main">)</span><span class="main">)</span> <span class="skolem">l'</span><span class="main">)</span><span class="hidden">⇗</span><sup>[Fvar <span class="skolem">s</span><span class="main">,</span>Fvar <span class="skolem">p</span>]</sup><span class="hidden">⇖</span><span class="main">)</span> <span class="main">:</span> return<span class="main">(</span>the<span class="main">(</span><span class="skolem">T</span><span class="main">^</span><span class="skolem">l'</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">from</span></span> typing.T_Obj<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹ok <span class="skolem">env</span>›</span></span> domf' _ this<span class="main">]</span> <span class="quoted"><span class="quoted">‹finite <span class="skolem">F</span>›</span></span> <span class="quoted"><span class="quoted">‹finite <span class="skolem">F'</span>›</span></span> t'
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">no_asm_simp</span><span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>T_Call <span class="skolem">env</span> <span class="skolem">t1</span> <span class="skolem">T</span> <span class="skolem">t2</span> <span class="skolem">l</span> <span class="skolem">t'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> Call_beta<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹Call <span class="skolem">t1</span> <span class="skolem">l</span> <span class="skolem">t2</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>β</sub></span> <span class="skolem">t'</span>›</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">elim</span> disjE conjE exE<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">t1'</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t1</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>β</sub></span> <span class="skolem">t1'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t'</span> <span class="main">=</span> Call <span class="skolem">t1'</span> <span class="skolem">l</span> <span class="skolem">t2</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> 
      typing.T_Call<span class="main">[</span><span class="operator">OF</span> T_Call<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">OF</span> this<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span> 
                       <span class="quoted"><span class="quoted">‹<span class="skolem">env</span> <span class="main">⊢</span> <span class="skolem">t2</span> <span class="main">:</span> param<span class="main">(</span>the<span class="main">(</span><span class="skolem">T</span><span class="main">^</span><span class="skolem">l</span><span class="main">)</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">l</span> <span class="main">∈</span> do <span class="skolem">T</span>›</span></span><span class="main">]</span>
      this<span class="main">(</span>2<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">t2'</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t2</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>β</sub></span> <span class="skolem">t2'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t'</span> <span class="main">=</span> Call <span class="skolem">t1</span> <span class="skolem">l</span> <span class="skolem">t2'</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> 
      typing.T_Call<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">env</span> <span class="main">⊢</span> <span class="skolem">t1</span> <span class="main">:</span> <span class="skolem">T</span>›</span></span> T_Call<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">OF</span> this<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">l</span> <span class="main">∈</span> do <span class="skolem">T</span>›</span></span><span class="main">]</span>
      this<span class="main">(</span>2<span class="main">)</span> 
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">f</span> <span class="skolem">U</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"Obj <span class="skolem">f</span> <span class="skolem">U</span> <span class="main">=</span> <span class="skolem">t1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">∈</span> dom <span class="skolem">f</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> t'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t'</span> <span class="main">=</span> <span class="main">(</span>the<span class="main">(</span><span class="skolem">f</span> <span class="skolem">l</span><span class="main">)</span><span class="hidden">⇗</span><sup>[Obj <span class="skolem">f</span> <span class="skolem">U</span><span class="main">,</span><span class="skolem">t2</span>]</sup><span class="hidden">⇖</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> 
      typing.T_Call<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">env</span> <span class="main">⊢</span> <span class="skolem">t1</span> <span class="main">:</span> <span class="skolem">T</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">env</span> <span class="main">⊢</span> <span class="skolem">t2</span> <span class="main">:</span> param<span class="main">(</span>the<span class="main">(</span><span class="skolem">T</span><span class="main">^</span><span class="skolem">l</span><span class="main">)</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">l</span> <span class="main">∈</span> do <span class="skolem">T</span>›</span></span><span class="main">]</span>
      sym<span class="main">[</span><span class="operator">OF</span> this<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="quoted"><span class="quoted">‹<span class="skolem">env</span> <span class="main">⊢</span> <span class="skolem">t1</span> <span class="main">:</span> <span class="skolem">T</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">env</span> <span class="main">⊢</span> <span class="skolem">t2</span> <span class="main">:</span> param<span class="main">(</span>the<span class="main">(</span><span class="skolem">T</span><span class="main">^</span><span class="skolem">l</span><span class="main">)</span><span class="main">)</span>›</span></span> 
      obj_inv<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">env</span></span> <span class="quoted"><span class="skolem">f</span></span> <span class="quoted"><span class="skolem">U</span></span> <span class="quoted"><span class="skolem">T</span></span><span class="main">]</span>
    <span class="keyword3"><span class="command">obtain</span></span> 
      objT<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">env</span> <span class="main">⊢</span> <span class="main">(</span>Obj <span class="skolem">f</span> <span class="skolem">T</span><span class="main">)</span> <span class="main">:</span> <span class="skolem">T</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">T</span> <span class="main">=</span> <span class="skolem">U</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      callT<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">env</span> <span class="main">⊢</span> Call <span class="main">(</span>Obj <span class="skolem">f</span> <span class="skolem">T</span><span class="main">)</span> <span class="skolem">l</span> <span class="skolem">t2</span> <span class="main">:</span> return<span class="main">(</span>the<span class="main">(</span><span class="skolem">T</span><span class="main">^</span><span class="skolem">l</span><span class="main">)</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> 
      <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound">F</span><span class="main">.</span> finite <span class="bound">F</span> 
          <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">s</span> <span class="bound">p</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∉</span> <span class="bound">F</span> <span class="main">∧</span> <span class="bound">p</span> <span class="main">∉</span> <span class="bound">F</span> <span class="main">∧</span> <span class="bound">s</span> <span class="main">≠</span> <span class="bound">p</span> 
              <span class="main">⟶</span> <span class="skolem">env</span><span class="main">⦇</span><span class="bound">s</span><span class="main">:</span><span class="skolem">T</span><span class="main">⦈</span><span class="main">⦇</span><span class="bound">p</span><span class="main">:</span>param<span class="main">(</span>the<span class="main">(</span><span class="skolem">T</span><span class="main">^</span><span class="skolem">l</span><span class="main">)</span><span class="main">)</span><span class="main">⦈</span> 
                  <span class="main">⊢</span> <span class="main">(</span>the<span class="main">(</span><span class="skolem">f</span> <span class="skolem">l</span><span class="main">)</span><span class="hidden">⇗</span><sup>[Fvar <span class="bound">s</span><span class="main">,</span>Fvar <span class="bound">p</span>]</sup><span class="hidden">⇖</span><span class="main">)</span> <span class="main">:</span> return<span class="main">(</span>the<span class="main">(</span><span class="skolem">T</span><span class="main">^</span><span class="skolem">l</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
      <span class="main">⟹</span> <span class="skolem">env</span> <span class="main">⊢</span> <span class="main">(</span>the <span class="main">(</span><span class="skolem">f</span> <span class="skolem">l</span><span class="main">)</span><span class="hidden">⇗</span><sup>[Obj <span class="skolem">f</span> <span class="skolem">T</span><span class="main">,</span><span class="skolem">t2</span>]</sup><span class="hidden">⇖</span><span class="main">)</span> <span class="main">:</span> return <span class="main">(</span>the<span class="main">(</span><span class="skolem">T</span><span class="main">^</span><span class="skolem">l</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">elim</span> exE conjE<span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">F</span> 
      <span class="keyword3"><span class="command">assume</span></span> 
        <span class="quoted"><span class="quoted">"finite <span class="skolem">F</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
        pred_F<span class="main">:</span>
        <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">s</span> <span class="bound">p</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∉</span> <span class="skolem">F</span> <span class="main">∧</span> <span class="bound">p</span> <span class="main">∉</span> <span class="skolem">F</span> <span class="main">∧</span> <span class="bound">s</span> <span class="main">≠</span> <span class="bound">p</span>
          <span class="main">⟶</span> <span class="skolem">env</span><span class="main">⦇</span><span class="bound">s</span><span class="main">:</span><span class="skolem">T</span><span class="main">⦈</span><span class="main">⦇</span><span class="bound">p</span><span class="main">:</span>param<span class="main">(</span>the<span class="main">(</span><span class="skolem">T</span><span class="main">^</span><span class="skolem">l</span><span class="main">)</span><span class="main">)</span><span class="main">⦈</span> 
              <span class="main">⊢</span> <span class="main">(</span>the<span class="main">(</span><span class="skolem">f</span> <span class="skolem">l</span><span class="main">)</span><span class="hidden">⇗</span><sup>[Fvar <span class="bound">s</span><span class="main">,</span>Fvar <span class="bound">p</span>]</sup><span class="hidden">⇖</span><span class="main">)</span> <span class="main">:</span> return<span class="main">(</span>the<span class="main">(</span><span class="skolem">T</span><span class="main">^</span><span class="skolem">l</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">from</span></span> this<span class="main">(</span>1<span class="main">)</span> finite_FV<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"Obj <span class="skolem">f</span> <span class="skolem">T</span>"</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="skolem">F</span> <span class="main">∪</span> FV <span class="main">(</span>Obj <span class="skolem">f</span> <span class="skolem">T</span><span class="main">)</span> <span class="main">∪</span> FV <span class="skolem">t2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">from</span></span> exFresh_s_p_cof<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
        nin_s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∉</span> <span class="skolem">F</span> <span class="main">∪</span> FV <span class="main">(</span>Obj <span class="skolem">f</span> <span class="skolem">T</span><span class="main">)</span> <span class="main">∪</span> FV <span class="skolem">t2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
        nin_p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∉</span> <span class="skolem">F</span> <span class="main">∪</span> FV <span class="main">(</span>Obj <span class="skolem">f</span> <span class="skolem">T</span><span class="main">)</span> <span class="main">∪</span> FV <span class="skolem">t2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">≠</span> <span class="skolem">p</span>"</span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">with</span></span> pred_F
      <span class="keyword1"><span class="command">have</span></span> 
        type_opened<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">env</span><span class="main">⦇</span><span class="skolem">s</span><span class="main">:</span><span class="skolem">T</span><span class="main">⦈</span><span class="main">⦇</span><span class="skolem">p</span><span class="main">:</span>param<span class="main">(</span>the<span class="main">(</span><span class="skolem">T</span><span class="main">^</span><span class="skolem">l</span><span class="main">)</span><span class="main">)</span><span class="main">⦈</span>
                      <span class="main">⊢</span> <span class="main">{</span><span class="main">0</span> <span class="main">→</span> <span class="main">[</span>Fvar <span class="skolem">s</span><span class="main">,</span>Fvar <span class="skolem">p</span><span class="main">]}</span> the<span class="main">(</span><span class="skolem">f</span> <span class="skolem">l</span><span class="main">)</span> <span class="main">:</span> return<span class="main">(</span>the<span class="main">(</span><span class="skolem">T</span><span class="main">^</span><span class="skolem">l</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> openz_def<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> nin_s nin_p FV_option_lem<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">f</span></span><span class="main">]</span> objT <span class="quoted"><span class="quoted">‹<span class="skolem">l</span> <span class="main">∈</span> do <span class="skolem">T</span>›</span></span>
      <span class="keyword3"><span class="command">obtain</span></span> 
        <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∉</span> FV <span class="main">(</span>the<span class="main">(</span><span class="skolem">f</span> <span class="skolem">l</span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span> FV <span class="main">(</span>Obj <span class="skolem">f</span> <span class="skolem">T</span><span class="main">)</span> <span class="main">∪</span> FV <span class="skolem">t2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
        <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∉</span> FV <span class="main">(</span>the<span class="main">(</span><span class="skolem">f</span> <span class="skolem">l</span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span> FV <span class="main">(</span>Obj <span class="skolem">f</span> <span class="skolem">T</span><span class="main">)</span> <span class="main">∪</span> FV <span class="skolem">t2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">from</span></span> 
        open_lemma<span class="main">[</span><span class="operator">OF</span> type_opened this <span class="quoted"><span class="quoted">‹<span class="skolem">s</span> <span class="main">≠</span> <span class="skolem">p</span>›</span></span> 
        objT <span class="quoted"><span class="quoted">‹<span class="skolem">env</span> <span class="main">⊢</span> <span class="skolem">t2</span> <span class="main">:</span> param<span class="main">(</span>the<span class="main">(</span><span class="skolem">T</span><span class="main">^</span><span class="skolem">l</span><span class="main">)</span><span class="main">)</span>›</span></span><span class="main">]</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> openz_def<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">with</span></span> abs_typeE<span class="main">[</span><span class="operator">OF</span> callT<span class="main">]</span> t' <span class="quoted"><span class="quoted">‹<span class="skolem">T</span> <span class="main">=</span> <span class="skolem">U</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">theorem</span></span> subject_reduction'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>β</sub><span class="hidden">⇧</span><sup>*</sup></span> <span class="free">t'</span> <span class="main">⟹</span> <span class="free">e</span> <span class="main">⊢</span> <span class="free">t</span> <span class="main">:</span> <span class="free">T</span> <span class="main">⟹</span> <span class="free">e</span> <span class="main">⊢</span> <span class="free">t'</span> <span class="main">:</span> <span class="free">T</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">set</span><span class="main"><span class="main">:</span></span> rtranclp<span class="main">)</span> <span class="main">(</span><span class="operator">iprover</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> subject_reduction<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1" id="TypedSigma-type_members_equal"><span class="command">lemma</span></span> type_members_equal<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span> <span class="main">::</span> <span class="quoted">type</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">B</span> <span class="main">::</span> <span class="quoted">type</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"do <span class="free">A</span> <span class="main">=</span> do <span class="free">B</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">.</span> <span class="main">(</span><span class="free">A</span><span class="main">^</span><span class="bound">i</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">B</span><span class="main">^</span><span class="bound">i</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">=</span> <span class="free">B</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">A</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Object <span class="skolem">ta</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">B</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Object <span class="skolem">tb</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span><span class="bound">i</span><span class="main">.</span> <span class="main">(</span><span class="free">A</span><span class="main">^</span><span class="bound">i</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">B</span><span class="main">^</span><span class="bound">i</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">A</span> <span class="main">=</span> Object <span class="skolem">ta</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">B</span> <span class="main">=</span> Object <span class="skolem">tb</span>›</span></span> 
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="skolem">ta</span> <span class="bound">i</span> <span class="main">=</span> <span class="skolem">tb</span> <span class="bound">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="free">A</span> <span class="main">=</span> Object <span class="skolem">ta</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">B</span> <span class="main">=</span> Object <span class="skolem">tb</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ext<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="TypedSigma-not_var"><span class="command">lemma</span></span> not_var<span class="main">:</span> <span class="quoted"><span class="quoted">"Env Map.empty <span class="main">⊢</span> <span class="free">a</span> <span class="main">:</span> <span class="free">A</span> <span class="main">⟹</span> <span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="free">a</span> <span class="main">≠</span> Fvar <span class="bound">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> allI<span class="main"><span class="keyword3">,</span></span> <span class="operator">case_tac</span> <span class="quoted"><span class="improper">x</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="TypedSigma-Call_label_range"><span class="command">lemma</span></span> Call_label_range<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Env Map.empty<span class="main">)</span> <span class="main">⊢</span> Call <span class="main">(</span>Obj <span class="free">c</span> <span class="free">T</span><span class="main">)</span> <span class="free">l</span> <span class="free">b</span> <span class="main">:</span> <span class="free">A</span> <span class="main">⟹</span> <span class="free">l</span> <span class="main">∈</span> dom <span class="free">c</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule</span> typing_elims<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> typing.cases<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>

<span class="keyword1" id="TypedSigma-Call_subterm_type"><span class="command">lemma</span></span>  Call_subterm_type<span class="main">:</span> <span class="quoted"><span class="quoted">"Env Map.empty <span class="main">⊢</span> Call <span class="free">t</span> <span class="free">l</span> <span class="free">b</span><span class="main">:</span> <span class="free">T</span> 
  <span class="main">⟹</span> <span class="main">(</span><span class="main">∃</span><span class="bound">T'</span><span class="main">.</span> Env Map.empty <span class="main">⊢</span> <span class="free">t</span> <span class="main">:</span> <span class="bound">T'</span><span class="main">)</span> <span class="main">∧</span>  <span class="main">(</span><span class="main">∃</span><span class="bound">T'</span><span class="main">.</span> Env Map.empty <span class="main">⊢</span> <span class="free">b</span> <span class="main">:</span> <span class="bound">T'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule</span> typing.cases<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="TypedSigma-Upd_label_range"><span class="command">lemma</span></span> Upd_label_range<span class="main">:</span> <span class="quoted"><span class="quoted">"Env Map.empty <span class="main">⊢</span> Upd <span class="main">(</span>Obj <span class="free">c</span> <span class="free">T</span><span class="main">)</span> <span class="free">l</span> <span class="free">x</span> <span class="main">:</span> <span class="free">A</span> <span class="main">⟹</span> <span class="free">l</span> <span class="main">∈</span> dom <span class="free">c</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule</span> typing_elims<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> typing.cases<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>

<span class="keyword1" id="TypedSigma-Upd_subterm_type"><span class="command">lemma</span></span> Upd_subterm_type<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"Env Map.empty <span class="main">⊢</span> Upd <span class="free">t</span> <span class="free">l</span> <span class="free">x</span> <span class="main">:</span> <span class="free">T</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">T'</span><span class="main">.</span> Env Map.empty <span class="main">⊢</span> <span class="free">t</span> <span class="main">:</span> <span class="bound">T'</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule</span> typing.cases<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="TypedSigma-no_var"><span class="command">lemma</span></span> no_var<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">T</span><span class="main">.</span> Env Map.empty <span class="main">⊢</span> Fvar <span class="free">x</span> <span class="main">:</span> <span class="bound">T</span> <span class="main">⟹</span> False"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="free">x</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="TypedSigma-no_bvar"><span class="command">lemma</span></span> no_bvar<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">e</span> <span class="main">⊢</span> Bvar <span class="free">x</span> <span class="main">:</span> <span class="free">T</span> <span class="main">⟹</span> False"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule</span> typing.cases<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">subsubsection</span></span><span class="quoted"><span class="plain_text">‹Unique Type›</span></span>
<span class="keyword1"><span class="command">theorem</span></span> type_unique<span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span><span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">env</span> <span class="main">⊢</span> <span class="free">a</span><span class="main">:</span> <span class="free">T</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">T'</span><span class="main">.</span> <span class="free">env</span> <span class="main">⊢</span> <span class="free">a</span><span class="main">:</span> <span class="bound">T'</span> <span class="main">⟶</span> <span class="free">T</span> <span class="main">=</span> <span class="bound">T'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> typing.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> T_Var <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> add_get_eq<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> T_Obj <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sym<span class="main"><span class="main">[</span></span><span class="operator">OF</span> obj_inv<span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> T_Call <span class="keyword1"><span class="command">from</span></span> this<span class="main">(</span>2<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span> 
  <span class="keyword3"><span class="command">case</span></span> T_Upd <span class="keyword1"><span class="command">from</span></span> this<span class="main">(</span>4<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span><span class="quoted"><span class="plain_text">‹Progress›</span></span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Final Type Soundness Lemma›</span></span>
<span class="keyword1"><span class="command">theorem</span></span> progress<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"Env Map.empty <span class="main">⊢</span> <span class="free">t</span> <span class="main">:</span> <span class="free">A</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="main">(</span><span class="main">∃</span><span class="bound">c</span> <span class="bound">A</span><span class="main">.</span> <span class="free">t</span> <span class="main">=</span> Obj <span class="bound">c</span> <span class="bound">A</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">b</span><span class="main">.</span> <span class="free">t</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>β</sub></span> <span class="bound">b</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">f</span>
  <span class="keyword1"><span class="command">have</span></span> 
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">A</span><span class="main">.</span> Env Map.empty <span class="main">⊢</span> <span class="free">t</span> <span class="main">:</span> <span class="bound">A</span> <span class="main">⟶</span> <span class="main">¬</span><span class="main">(</span><span class="main">∃</span><span class="bound">c</span> <span class="bound">T</span><span class="main">.</span> <span class="free">t</span> <span class="main">=</span> Obj <span class="bound">c</span> <span class="bound">T</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">b</span><span class="main">.</span> <span class="free">t</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>β</sub></span> <span class="bound">b</span><span class="main">)</span><span class="main">)</span>
    <span class="main">&amp;</span><span class="main">(</span><span class="main">∀</span><span class="bound">A</span><span class="main">.</span> Env Map.empty <span class="main">⊢</span> Obj <span class="skolem">f</span> <span class="bound">A</span> <span class="main">:</span> <span class="bound">A</span> <span class="main">⟶</span> <span class="main">¬</span><span class="main">(</span><span class="main">∃</span><span class="bound">c</span> <span class="bound">T</span><span class="main">.</span> Obj <span class="skolem">f</span> <span class="bound">A</span> <span class="main">=</span> Obj <span class="bound">c</span> <span class="bound">T</span><span class="main">)</span> 
       <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">b</span><span class="main">.</span> Obj <span class="skolem">f</span> <span class="bound">A</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>β</sub></span> <span class="bound">b</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> sterm_induct<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Bvar <span class="skolem">b</span><span class="main">)</span> <span class="keyword1"><span class="command">with</span></span> no_bvar<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"Env Map.empty"</span></span> <span class="quoted"><span class="skolem">b</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> <span class="comment1">(* contradiction *)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Fvar <span class="skolem">x</span><span class="main">)</span> <span class="keyword1"><span class="command">with</span></span> Fvar_beta<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">x</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> <span class="comment1">(* contradiction *)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> Obj <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> <span class="comment1">(* contradiction *)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> empty <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> <span class="comment1">(* contradiction *)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> insert <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> <span class="comment1">(* contradiction *)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Call <span class="skolem">t1</span> <span class="skolem">l</span> <span class="skolem">t2</span><span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">clarify</span><span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">T</span> <span class="keyword3"><span class="command">assume</span></span> 
        <span class="quoted"><span class="quoted">"Env Map.empty <span class="main">⊢</span> <span class="skolem">t1</span> <span class="main">:</span> <span class="skolem">T</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"Env Map.empty <span class="main">⊢</span> <span class="skolem">t2</span> <span class="main">:</span> param<span class="main">(</span>the<span class="main">(</span><span class="skolem">T</span><span class="main">^</span><span class="skolem">l</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">∈</span> do <span class="skolem">T</span>"</span></span>
      <span class="keyword1"><span class="command">note</span></span> lc <span class="main">=</span> typing_regular''<span class="main">[</span><span class="operator">OF</span> this<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> typing_regular''<span class="main">[</span><span class="operator">OF</span> this<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">from</span></span> 
        <span class="quoted"><span class="quoted">‹Env Map.empty <span class="main">⊢</span> <span class="skolem">t1</span> <span class="main">:</span> <span class="skolem">T</span>›</span></span> 
        <span class="quoted"><span class="quoted">‹<span class="main">∀</span><span class="bound">A</span><span class="main">.</span> Env Map.empty <span class="main">⊢</span> <span class="skolem">t1</span> <span class="main">:</span> <span class="bound">A</span> <span class="main">⟶</span> <span class="main">¬</span> <span class="main">(</span><span class="main">∃</span><span class="bound">c</span> <span class="bound">T</span><span class="main">.</span> <span class="skolem">t1</span> <span class="main">=</span> Obj <span class="bound">c</span> <span class="bound">T</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">b</span><span class="main">.</span> <span class="skolem">t1</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>β</sub></span> <span class="bound">b</span><span class="main">)</span>›</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound">c</span> <span class="bound">B</span><span class="main">.</span> <span class="skolem">t1</span> <span class="main">=</span> Obj <span class="bound">c</span> <span class="bound">B</span><span class="main">)</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound">b</span><span class="main">.</span> <span class="skolem">t1</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>β</sub></span> <span class="bound">b</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">b</span><span class="main">.</span> Call <span class="skolem">t1</span> <span class="skolem">l</span> <span class="skolem">t2</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>β</sub></span> <span class="bound">b</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">elim</span> disjE exE<span class="main">)</span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">c</span> <span class="skolem">B</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t1</span> <span class="main">=</span> Obj <span class="skolem">c</span> <span class="skolem">B</span>"</span></span> 
        <span class="keyword1"><span class="command">with</span></span> 
          <span class="quoted"><span class="quoted">‹Env Map.empty <span class="main">⊢</span> <span class="skolem">t1</span> <span class="main">:</span> <span class="skolem">T</span>›</span></span> obj_inv<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"Env Map.empty"</span></span> <span class="quoted"><span class="skolem">c</span></span> <span class="quoted"><span class="skolem">B</span></span> <span class="quoted"><span class="skolem">T</span></span><span class="main">]</span> 
          <span class="quoted"><span class="quoted">‹<span class="skolem">l</span> <span class="main">∈</span> do <span class="skolem">T</span>›</span></span> obj_inv_elim<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"Env Map.empty"</span></span> <span class="quoted"><span class="skolem">c</span></span> <span class="quoted"><span class="skolem">B</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">∈</span> dom <span class="skolem">c</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">t1</span> <span class="main">=</span> Obj <span class="skolem">c</span> <span class="skolem">B</span>›</span></span> lc beta.beta<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">l</span></span> <span class="quoted"><span class="skolem">c</span></span> <span class="quoted"><span class="skolem">B</span></span> <span class="quoted"><span class="skolem">t2</span></span><span class="main">]</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">b</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t1</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>β</sub></span> <span class="skolem">b</span>"</span></span>
        <span class="keyword1"><span class="command">from</span></span> beta.beta_CallL<span class="main">[</span><span class="operator">OF</span> this lc<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Upd <span class="skolem">t1</span> <span class="skolem">l</span> <span class="skolem">t2</span><span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">clarify</span><span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">T</span> <span class="skolem">F</span>
      <span class="keyword3"><span class="command">assume</span></span> 
        <span class="quoted"><span class="quoted">"finite <span class="skolem">F</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
        <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">s</span> <span class="bound">p</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∉</span> <span class="skolem">F</span> <span class="main">∧</span> <span class="bound">p</span> <span class="main">∉</span> <span class="skolem">F</span> <span class="main">∧</span> <span class="bound">s</span> <span class="main">≠</span> <span class="bound">p</span>
          <span class="main">⟶</span> Env Map.empty<span class="main">⦇</span><span class="bound">s</span><span class="main">:</span><span class="skolem">T</span><span class="main">⦈</span><span class="main">⦇</span><span class="bound">p</span><span class="main">:</span>param<span class="main">(</span>the<span class="main">(</span><span class="skolem">T</span><span class="main">^</span><span class="skolem">l</span><span class="main">)</span><span class="main">)</span><span class="main">⦈</span> 
              <span class="main">⊢</span> <span class="main">(</span><span class="skolem">t2</span><span class="hidden">⇗</span><sup>[Fvar <span class="bound">s</span><span class="main">,</span>Fvar <span class="bound">p</span>]</sup><span class="hidden">⇖</span><span class="main">)</span> <span class="main">:</span> return<span class="main">(</span>the<span class="main">(</span><span class="skolem">T</span><span class="main">^</span><span class="skolem">l</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
        <span class="quoted"><span class="quoted">"Env Map.empty <span class="main">⊢</span> <span class="skolem">t1</span> <span class="main">:</span> <span class="skolem">T</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
        <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">∈</span> do <span class="skolem">T</span>"</span></span>
      <span class="keyword1"><span class="command">from</span></span> typing_regular''<span class="main">[</span><span class="operator">OF</span> T_Upd<span class="main"><span class="main">[</span></span><span class="operator">OF</span> this<span class="main"><span class="main">]</span></span><span class="main">]</span> lc_upd<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">t1</span></span> <span class="quoted"><span class="skolem">l</span></span> <span class="quoted"><span class="skolem">t2</span></span><span class="main">]</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="quoted"><span class="quoted">"lc <span class="skolem">t1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"body <span class="skolem">t2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">from</span></span> 
        <span class="quoted"><span class="quoted">‹Env Map.empty <span class="main">⊢</span> <span class="skolem">t1</span> <span class="main">:</span> <span class="skolem">T</span>›</span></span> 
        <span class="quoted"><span class="quoted">‹<span class="main">∀</span><span class="bound">A</span><span class="main">.</span> Env Map.empty <span class="main">⊢</span> <span class="skolem">t1</span> <span class="main">:</span> <span class="bound">A</span> <span class="main">⟶</span> <span class="main">¬</span> <span class="main">(</span><span class="main">∃</span><span class="bound">c</span> <span class="bound">T</span><span class="main">.</span> <span class="skolem">t1</span> <span class="main">=</span> Obj <span class="bound">c</span> <span class="bound">T</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">b</span><span class="main">.</span> <span class="skolem">t1</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>β</sub></span> <span class="bound">b</span><span class="main">)</span>›</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound">c</span> <span class="bound">B</span><span class="main">.</span> <span class="skolem">t1</span> <span class="main">=</span> Obj <span class="bound">c</span> <span class="bound">B</span><span class="main">)</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound">b</span><span class="main">.</span> <span class="skolem">t1</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>β</sub></span> <span class="bound">b</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">b</span><span class="main">.</span> Upd <span class="skolem">t1</span> <span class="skolem">l</span> <span class="skolem">t2</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>β</sub></span> <span class="bound">b</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">elim</span> disjE exE<span class="main">)</span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">c</span> <span class="skolem">B</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t1</span> <span class="main">=</span> Obj <span class="skolem">c</span> <span class="skolem">B</span>"</span></span> 
        <span class="keyword1"><span class="command">with</span></span> 
          <span class="quoted"><span class="quoted">‹Env Map.empty <span class="main">⊢</span> <span class="skolem">t1</span> <span class="main">:</span> <span class="skolem">T</span>›</span></span> obj_inv<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"Env Map.empty"</span></span> <span class="quoted"><span class="skolem">c</span></span> <span class="quoted"><span class="skolem">B</span></span> <span class="quoted"><span class="skolem">T</span></span><span class="main">]</span> 
          <span class="quoted"><span class="quoted">‹<span class="skolem">l</span> <span class="main">∈</span> do <span class="skolem">T</span>›</span></span> obj_inv_elim<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"Env Map.empty"</span></span> <span class="quoted"><span class="skolem">c</span></span> <span class="quoted"><span class="skolem">B</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">∈</span> dom <span class="skolem">c</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">t1</span> <span class="main">=</span> Obj <span class="skolem">c</span> <span class="skolem">B</span>›</span></span> <span class="quoted"><span class="quoted">‹lc <span class="skolem">t1</span>›</span></span> <span class="quoted"><span class="quoted">‹body <span class="skolem">t2</span>›</span></span> beta.beta_Upd<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">l</span></span> <span class="quoted"><span class="skolem">c</span></span> <span class="quoted"><span class="skolem">B</span></span> <span class="quoted"><span class="skolem">t2</span></span><span class="main">]</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">b</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t1</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>β</sub></span> <span class="skolem">b</span>"</span></span>
        <span class="keyword1"><span class="command">from</span></span> beta.beta_UpdL<span class="main">[</span><span class="operator">OF</span> this <span class="quoted"><span class="quoted">‹body <span class="skolem">t2</span>›</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Locally_Nameless_Sigma">
<div class="head">
<h1>Theory Locally_Nameless_Sigma</h1>
</div>
<pre class="source">
<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Locally Nameless Sigma Calculus›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Locally_Nameless_Sigma
<span class="keyword2"><span class="keyword">imports</span></span> <span class="quoted">"<a href="#ParRed">Sigma/ParRed</a>"</span> <span class="quoted">"<a href="#TypedSigma">Sigma/TypedSigma</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div>