<div id="BitByte">
<div class="head">
<h1>Theory BitByte</h1>
</div>
<pre class="source"><span class="comment1">(*  Title:       X86 instruction semantics and basic block symbolic execution
    Authors:     Freek Verbeek, Abhijith Bharadwaj, Joshua Bockenek, Ian Roessle, Timmy Weerwag, Binoy Ravindran
    Year:        2020
    Maintainer:  Freek Verbeek (freek@vt.edu)
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">"Bit and byte-level theorems"</span></span>

<span class="keyword1"><span class="command">theory</span></span> BitByte
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="https://www.cl.cam.ac.uk/research/hvg/Isabelle/dist/library/HOL/HOL/Main.html">Main</a> <span class="quoted">"<a href="../../word_lib/theories/#Syntax_Bundles">Word_Lib.Syntax_Bundles</a>"</span> <span class="quoted">"<a href="../../word_lib/theories/#Bit_Shifts_Infix_Syntax">Word_Lib.Bit_Shifts_Infix_Syntax</a>"</span> <span class="quoted">"<a href="../../word_lib/theories/#Bitwise">Word_Lib.Bitwise</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Basics›</span></span>

<span class="keyword1"><span class="command">unbundle</span></span> bit_operations_syntax
<span class="keyword1"><span class="command">unbundle</span></span> bit_projection_infix_syntax

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">take_bits</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">::</span>len word <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">::</span>len word"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">⟨</span>_<span class="keyword1">,</span>_<span class="keyword1">⟩</span>_"</span> 51<span class="main">)</span> <span class="comment1">― ‹little-endian›</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">take_bits</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="main">&gt;&gt;</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span> <span class="keyword1">AND</span> mask <span class="main">(</span><span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">-</span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"take_bits <span class="free"><span class="free">l</span></span> <span class="free"><span class="free">h</span></span> <span class="free"><span class="free">w</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> takes a subset of bits from word <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">w</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, from low (inclusive) to high (exclusive).
  For example, <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> [show_types] <span class="quoted"><span class="quoted">"take_bits <span class="numeral"><span class="numeral">2</span></span> <span class="numeral"><span class="numeral">5</span></span> <span class="main"><span class="main">(</span></span><span class="numeral"><span class="numeral">28</span></span><span class="main"><span class="main">::</span></span><span class="numeral"><span class="numeral">8</span></span>word<span class="main"><span class="main">)</span></span> <span class="main"><span class="main">=</span></span> <span class="numeral"><span class="numeral">7</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.
›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">take_byte</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">::</span>len word <span class="main">⇒</span> <span class="numeral">8</span>word"</span></span> <span class="comment1">― ‹little-endian›</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">take_byte</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="main">≡</span> ucast <span class="main">(</span><span class="main">⟨</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">*</span><span class="numeral">8</span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">*</span><span class="numeral">8</span><span class="main">+</span><span class="numeral">8</span><span class="main">⟩</span><span class="free"><span class="bound"><span class="entity">w</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"take_byte <span class="free"><span class="free">n</span></span> <span class="free"><span class="free">w</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> takes the nth byte from word <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">w</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.
  For example, <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> [show_types] <span class="quoted"><span class="quoted">"take_byte <span class="main"><span class="main">1</span></span> <span class="main"><span class="main">(</span></span><span class="numeral"><span class="numeral">42</span></span> <span class="main"><span class="main">&lt;&lt;</span></span> <span class="numeral"><span class="numeral">8</span></span><span class="main"><span class="main">::</span></span><span class="numeral"><span class="numeral">16</span></span>word<span class="main"><span class="main">)</span></span> <span class="main"><span class="main">=</span></span> <span class="numeral"><span class="numeral">42</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.
›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">overwrite</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">::</span>len word <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">::</span>len word <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">::</span>len word"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">overwrite</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="free"><span class="bound"><span class="entity">w0</span></span></span> <span class="free"><span class="bound"><span class="entity">w1</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="main">(</span><span class="main">⟨</span><span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">,</span><span class="keyword1">LENGTH</span><span class="main">(</span><span class="tfree">'a</span><span class="main">)</span><span class="main">⟩</span><span class="free"><span class="bound"><span class="entity">w0</span></span></span><span class="main">)</span> <span class="main">&lt;&lt;</span> <span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">)</span> <span class="keyword1">OR</span> <span class="main">(</span><span class="main">(</span><span class="main">⟨</span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">⟩</span><span class="free"><span class="bound"><span class="entity">w1</span></span></span><span class="main">)</span> <span class="main">&lt;&lt;</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span> <span class="keyword1">OR</span> <span class="main">(</span><span class="main">⟨</span><span class="main">0</span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">⟩</span><span class="free"><span class="bound"><span class="entity">w0</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"overwrite <span class="free"><span class="free">l</span></span> <span class="free"><span class="free">h</span></span> <span class="free"><span class="free">w0</span></span> <span class="free"><span class="free">w1</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> overwrites low (inclusive) to high (exclusive) bits in
  word <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">w0</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> with bits from word <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">w1</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.
  For example, <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> [show_types] <span class="quoted"><span class="quoted">"<span class="main"><span class="main">(</span></span>overwrite <span class="numeral"><span class="numeral">2</span></span> <span class="numeral"><span class="numeral">4</span></span> <span class="numeral"><span class="numeral">28</span></span> <span class="numeral"><span class="numeral">227</span></span> <span class="main"><span class="main">::</span></span> <span class="numeral"><span class="numeral">8</span></span>word<span class="main"><span class="main">)</span></span> <span class="main"><span class="main">=</span></span> <span class="numeral"><span class="numeral">16</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.
›</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We prove some theorems about taking the nth bit/byte of an operation. These are useful to prove
      equaltiy between different words, by first applying rule <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span> word_eqI<span class="antiquote"><span class="antiquote">}</span></span></span></span>.›</span></span>

<span class="keyword1" id="BitByte-bit_take_bits_iff"><span class="command">lemma</span></span> bit_take_bits_iff <span class="main">[</span><span class="operator">bit_simps</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main">⟨</span><span class="free">l</span><span class="main">,</span><span class="free">h</span><span class="main">⟩</span><span class="free">w</span><span class="main">)</span> <span class="main">!!</span> <span class="free">n</span> <span class="main">⟷</span> <span class="free">n</span> <span class="main">&lt;</span> <span class="keyword1">LENGTH</span><span class="main">(</span><span class="tfree">'a</span><span class="main">)</span> <span class="main">∧</span> <span class="free">n</span> <span class="main">&lt;</span> <span class="free">h</span> <span class="main">-</span> <span class="free">l</span> <span class="main">∧</span> <span class="free">w</span> <span class="main">!!</span> <span class="main">(</span><span class="free">n</span> <span class="main">+</span> <span class="free">l</span><span class="main">)</span>›</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">w</span> <span class="main">::</span> <span class="quoted"><span class="quoted">‹<span class="tfree">'a</span><span class="main">::</span>len word›</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> take_bits_def <span class="dynamic"><span class="dynamic">bit_simps</span></span> <span class="dynamic"><span class="dynamic">ac_simps</span></span><span class="main">)</span>

<span class="keyword1" id="BitByte-bit_take_byte_iff"><span class="command">lemma</span></span> bit_take_byte_iff <span class="main">[</span><span class="operator">bit_simps</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">‹take_byte <span class="free">m</span> <span class="free">w</span> <span class="main">!!</span> <span class="free">n</span> <span class="main">⟷</span> <span class="free">n</span> <span class="main">&lt;</span> <span class="keyword1">LENGTH</span><span class="main">(</span><span class="tfree">'a</span><span class="main">)</span> <span class="main">∧</span> <span class="free">n</span> <span class="main">&lt;</span> <span class="numeral">8</span> <span class="main">∧</span> <span class="free">w</span> <span class="main">!!</span> <span class="main">(</span><span class="free">n</span> <span class="main">+</span> <span class="free">m</span> <span class="main">*</span> <span class="numeral">8</span><span class="main">)</span>›</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">w</span> <span class="main">::</span> <span class="quoted"><span class="quoted">‹<span class="tfree">'a</span><span class="main">::</span>len word›</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> take_byte_def <span class="dynamic"><span class="dynamic">bit_simps</span></span><span class="main">)</span>

<span class="keyword1" id="BitByte-bit_overwrite_iff"><span class="command">lemma</span></span> bit_overwrite_iff <span class="main">[</span><span class="operator">bit_simps</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">‹overwrite <span class="free">l</span> <span class="free">h</span> <span class="free">w0</span> <span class="free">w1</span> <span class="main">!!</span> <span class="free">n</span> <span class="main">⟷</span> <span class="free">n</span> <span class="main">&lt;</span> <span class="keyword1">LENGTH</span><span class="main">(</span><span class="tfree">'a</span><span class="main">)</span> <span class="main">∧</span>
    <span class="main">(</span><span class="keyword1">if</span> <span class="free">l</span> <span class="main">≤</span> <span class="free">n</span> <span class="main">∧</span> <span class="free">n</span> <span class="main">&lt;</span> <span class="free">h</span> <span class="keyword1">then</span> <span class="free">w1</span> <span class="keyword1">else</span> <span class="free">w0</span><span class="main">)</span> <span class="main">!!</span> <span class="free">n</span>›</span></span>
    <span class="keyword2"><span class="keyword">for</span></span> <span class="free">w0</span> <span class="free">w1</span> <span class="main">::</span> <span class="quoted"><span class="quoted">‹<span class="tfree">'a</span><span class="main">::</span>len word›</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> overwrite_def <span class="dynamic"><span class="dynamic">bit_simps</span></span><span class="main">)</span>

<span class="keyword1" id="BitByte-nth_takebits"><span class="command">lemma</span></span> nth_takebits<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">w</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>len word"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⟨</span><span class="free">l</span><span class="main">,</span><span class="free">h</span><span class="main">⟩</span><span class="free">w</span><span class="main">)</span> <span class="main">!!</span> <span class="free">n</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">n</span> <span class="main">&lt;</span> <span class="keyword1">LENGTH</span><span class="main">(</span><span class="tfree">'a</span><span class="main">)</span> <span class="main">∧</span> <span class="free">n</span> <span class="main">&lt;</span> <span class="free">h</span> <span class="main">-</span> <span class="free">l</span> <span class="keyword1">then</span> <span class="free">w</span> <span class="main">!!</span> <span class="main">(</span><span class="free">n</span> <span class="main">+</span> <span class="free">l</span><span class="main">)</span> <span class="keyword1">else</span> False<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">bit_simps</span></span><span class="main">)</span>

<span class="keyword1" id="BitByte-nth_takebyte"><span class="command">lemma</span></span> nth_takebyte<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">w</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>len word"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"take_byte <span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> <span class="numeral">8</span><span class="main">)</span> <span class="free">w</span> <span class="main">!!</span> <span class="main">(</span><span class="free">n</span> <span class="keyword1">mod</span> <span class="numeral">8</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">n</span> <span class="keyword1">mod</span> <span class="numeral">8</span> <span class="main">&lt;</span> <span class="keyword1">LENGTH</span><span class="main">(</span><span class="tfree">'a</span><span class="main">)</span> <span class="keyword1">then</span> <span class="free">w</span><span class="main">!!</span><span class="free">n</span> <span class="keyword1">else</span> False <span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">bit_simps</span></span><span class="main">)</span>

<span class="keyword1" id="BitByte-nth_take_byte_overwrite"><span class="command">lemma</span></span> nth_take_byte_overwrite<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">v</span> <span class="free">v'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>len word"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"take_byte <span class="free">n</span> <span class="main">(</span>overwrite <span class="free">l</span> <span class="free">h</span> <span class="free">v</span> <span class="free">v'</span><span class="main">)</span> <span class="main">!!</span> <span class="free">i</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">i</span> <span class="main">+</span> <span class="free">n</span> <span class="main">*</span> <span class="numeral">8</span> <span class="main">&lt;</span> <span class="free">l</span> <span class="main">∨</span> <span class="free">i</span> <span class="main">+</span> <span class="free">n</span> <span class="main">*</span> <span class="numeral">8</span> <span class="main">≥</span> <span class="free">h</span> <span class="keyword1">then</span> take_byte <span class="free">n</span> <span class="free">v</span> <span class="main">!!</span> <span class="free">i</span> <span class="keyword1">else</span> take_byte <span class="free">n</span> <span class="free">v'</span> <span class="main">!!</span> <span class="free">i</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">bit_simps</span></span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> bit_imp_le_length<span class="main">)</span>

<span class="keyword1" id="BitByte-nth_bitNOT"><span class="command">lemma</span></span> nth_bitNOT<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">a</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>len word"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">NOT</span> <span class="free">a</span><span class="main">)</span> <span class="main">!!</span> <span class="free">n</span> <span class="main">⟷</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">n</span> <span class="main">&lt;</span> <span class="keyword1">LENGTH</span><span class="main">(</span><span class="tfree">'a</span><span class="main">)</span>  <span class="keyword1">then</span> <span class="main">¬</span><span class="main">(</span><span class="free">a</span> <span class="main">!!</span> <span class="free">n</span><span class="main">)</span> <span class="keyword1">else</span> False<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">bit_simps</span></span><span class="main">)</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Various simplification rules›</span></span>

<span class="keyword1" id="BitByte-ucast_take_bits"><span class="command">lemma</span></span> ucast_take_bits<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">w</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>len word"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">=</span> <span class="keyword1">LENGTH</span><span class="main">(</span><span class="tfree">'b</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">LENGTH</span><span class="main">(</span><span class="tfree">'b</span><span class="main">)</span> <span class="main">≤</span> <span class="keyword1">LENGTH</span><span class="main">(</span><span class="tfree">'a</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"ucast <span class="main">(</span><span class="main">⟨</span><span class="main">0</span><span class="main">,</span><span class="free">h</span><span class="main">⟩</span><span class="free">w</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>ucast <span class="free">w</span> <span class="main">::</span><span class="tfree">'b</span> <span class="main">::</span> len word<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> bit_word_eqI<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">bit_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="BitByte-take_bits_ucast"><span class="command">lemma</span></span> take_bits_ucast<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">w</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'b</span><span class="main">::</span>len word"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">=</span> <span class="keyword1">LENGTH</span><span class="main">(</span><span class="tfree">'b</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⟨</span><span class="main">0</span><span class="main">,</span><span class="free">h</span><span class="main">⟩</span> <span class="main">(</span>ucast <span class="free">w</span> <span class="main">::</span><span class="tfree">'a</span> <span class="main">::</span> len word<span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>ucast <span class="free">w</span> <span class="main">::</span><span class="tfree">'a</span> <span class="main">::</span> len word<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> bit_word_eqI<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">bit_simps</span></span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> bit_imp_le_length<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="BitByte-take_bits_take_bits"><span class="command">lemma</span></span> take_bits_take_bits<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">w</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>len word"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⟨</span><span class="free">l</span><span class="main">,</span><span class="free">h</span><span class="main">⟩</span><span class="main">(</span><span class="main">⟨</span><span class="free">l'</span><span class="main">,</span><span class="free">h'</span><span class="main">⟩</span><span class="free">w</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> min <span class="keyword1">LENGTH</span><span class="main">(</span><span class="tfree">'a</span><span class="main">)</span> <span class="free">h</span> <span class="main">≥</span> <span class="free">h'</span> <span class="main">-</span> <span class="free">l'</span> <span class="keyword1">then</span> <span class="main">⟨</span><span class="free">l</span><span class="main">+</span><span class="free">l'</span><span class="main">,</span><span class="free">h'</span><span class="main">⟩</span><span class="free">w</span> <span class="keyword1">else</span> <span class="main">(</span><span class="main">⟨</span><span class="free">l</span><span class="main">+</span><span class="free">l'</span><span class="main">,</span><span class="free">l'</span><span class="main">+</span>min <span class="keyword1">LENGTH</span><span class="main">(</span><span class="tfree">'a</span><span class="main">)</span> <span class="free">h</span><span class="main">⟩</span><span class="free">w</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> bit_word_eqI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">bit_simps</span></span> <span class="dynamic"><span class="dynamic">ac_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="BitByte-take_bits_overwrite"><span class="command">lemma</span></span> take_bits_overwrite<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="free">l</span><span class="main">,</span><span class="free">h</span><span class="main">⟩</span><span class="main">(</span>overwrite <span class="free">l</span> <span class="free">h</span> <span class="free">w0</span> <span class="free">w1</span><span class="main">)</span> <span class="main">=</span> <span class="main">⟨</span><span class="free">l</span><span class="main">,</span><span class="free">h</span><span class="main">⟩</span><span class="free">w1</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> bit_word_eqI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">bit_simps</span></span> <span class="dynamic"><span class="dynamic">ac_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> bit_imp_le_length<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="BitByte-overwrite_0_take_bits_0"><span class="command">lemma</span></span> overwrite_0_take_bits_0<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"overwrite <span class="main">0</span> <span class="free">h</span> <span class="main">(</span><span class="main">⟨</span><span class="main">0</span><span class="main">,</span><span class="free">h</span><span class="main">⟩</span><span class="free">w0</span><span class="main">)</span> <span class="free">w1</span> <span class="main">=</span> <span class="main">⟨</span><span class="main">0</span><span class="main">,</span><span class="free">h</span><span class="main">⟩</span><span class="free">w1</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> bit_word_eqI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">bit_simps</span></span> <span class="dynamic"><span class="dynamic">ac_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="BitByte-take_byte_shiftlr_256"><span class="command">lemma</span></span> take_byte_shiftlr_256<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">v</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="numeral">256</span> word"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">≤</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"take_byte <span class="free">n</span> <span class="main">(</span><span class="free">v</span> <span class="main">&lt;&lt;</span> <span class="free">m</span><span class="main">*</span><span class="numeral">8</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="main">(</span><span class="free">n</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">*</span><span class="numeral">8</span> <span class="main">≤</span> <span class="numeral">256</span> <span class="keyword1">then</span> take_byte <span class="main">(</span><span class="free">n</span><span class="main">-</span><span class="free">m</span><span class="main">)</span> <span class="free">v</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> bit_word_eqI<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">bit_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹ Take\_Bits and arithmetic›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹This definition is based on <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span> to_bl_plus_carry<span class="antiquote"><span class="antiquote">}</span></span></span></span>, which formulates addition as bitwise operations using <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">xor3</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">carry</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">bitwise_add</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>bool <span class="main">×</span> bool<span class="main">)</span> list <span class="main">⇒</span> bool <span class="main">⇒</span> bool list"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">bitwise_add</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">≡</span> foldr <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span> <span class="bound">res</span> <span class="bound">car</span><span class="main">.</span> xor3 <span class="bound">x</span> <span class="bound">y</span> <span class="bound">car</span> <span class="main">#</span> <span class="bound">res</span> <span class="main">(</span>carry <span class="bound">x</span> <span class="bound">y</span> <span class="bound">car</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="main">[]</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span>"</span></span>

<span class="keyword1" id="BitByte-length_foldr_bitwise_add"><span class="command">lemma</span></span> length_foldr_bitwise_add<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>bitwise_add <span class="free">x</span> <span class="free">c</span><span class="main">)</span> <span class="main">=</span> length <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> bitwise_add_def
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">x</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">c</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹This is the "heart" of the proof: bitwise addition of two appended zipped lists can be expressed as
      two consecutive bitwise additions.
      Here, I need to make the assumption that the final carry is False.
 ›</span></span>
<span class="keyword1" id="BitByte-bitwise_add_append"><span class="command">lemma</span></span> bitwise_add_append<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> <span class="main">[]</span> <span class="main">∨</span> <span class="main">¬</span>carry <span class="main">(</span>fst <span class="main">(</span>last <span class="free">x</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>snd <span class="main">(</span>last <span class="free">x</span><span class="main">)</span><span class="main">)</span> True"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"bitwise_add <span class="main">(</span><span class="free">x</span> <span class="main">@</span> <span class="free">y</span><span class="main">)</span> <span class="main">(</span><span class="free">x</span><span class="main">≠</span><span class="main">[]</span> <span class="main">∧</span> <span class="free">c</span><span class="main">)</span> <span class="main">=</span> bitwise_add <span class="free">x</span> <span class="main">(</span><span class="free">x</span><span class="main">≠</span><span class="main">[]</span> <span class="main">∧</span> <span class="free">c</span><span class="main">)</span> <span class="main">@</span> bitwise_add <span class="free">y</span> False"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">unfolding</span></span> bitwise_add_def
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">x</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">c</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> case_prod_unfold xor3_def carry_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm<span class="main">)</span>

<span class="keyword1" id="BitByte-bitwise_add_take_append"><span class="command">lemma</span></span> bitwise_add_take_append<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"take <span class="main">(</span>length <span class="free">x</span><span class="main">)</span> <span class="main">(</span>bitwise_add <span class="main">(</span><span class="free">x</span> <span class="main">@</span> <span class="free">y</span><span class="main">)</span> <span class="free">c</span><span class="main">)</span> <span class="main">=</span> bitwise_add <span class="free">x</span> <span class="free">c</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> bitwise_add_def
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">x</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">c</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> case_prod_unfold xor3_def carry_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm<span class="main">)</span>

<span class="keyword1" id="BitByte-bitwise_add_zero"><span class="command">lemma</span></span> bitwise_add_zero<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"bitwise_add <span class="main">(</span>replicate <span class="free">n</span> <span class="main">(</span>False<span class="main">,</span> False<span class="main">)</span><span class="main">)</span> False <span class="main">=</span> replicate <span class="free">n</span> False "</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> bitwise_add_def
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> xor3_def carry_def<span class="main">)</span>

<span class="keyword1" id="BitByte-bitwise_add_take"><span class="command">lemma</span></span> bitwise_add_take<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"take <span class="free">n</span> <span class="main">(</span>bitwise_add <span class="free">x</span> <span class="free">c</span><span class="main">)</span> <span class="main">=</span> bitwise_add <span class="main">(</span>take <span class="free">n</span> <span class="free">x</span><span class="main">)</span> <span class="free">c</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> bitwise_add_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">c</span></span><span class="main"><span class="keyword3">,</span></span><span class="operator">auto</span><span class="main">)</span>
     <span class="main">(</span><span class="operator">metis</span> append_take_drop_id bitwise_add_def bitwise_add_take_append diff_is_0_eq' length_foldr_bitwise_add length_take nat_le_linear rev_min_pm1 take_all<span class="main">)</span>


<span class="keyword1" id="BitByte-fst_hd_drop_zip"><span class="command">lemma</span></span> fst_hd_drop_zip<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&lt;</span> length <span class="free">x</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"length <span class="free">x</span> <span class="main">=</span> length <span class="free">y</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>hd <span class="main">(</span>drop <span class="free">n</span> <span class="main">(</span>zip <span class="free">x</span> <span class="free">y</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> hd <span class="main">(</span>drop <span class="free">n</span> <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">x</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="free">y</span></span><span class="main"><span class="keyword3">,</span></span><span class="operator">auto</span><span class="main">)</span>
     <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> Cons_nth_drop_Suc drop_zip fst_conv length_Cons list.sel<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> zip_Cons_Cons<span class="main">)</span>

<span class="keyword1" id="BitByte-snd_hd_drop_zip"><span class="command">lemma</span></span> snd_hd_drop_zip<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&lt;</span> length <span class="free">x</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"length <span class="free">x</span> <span class="main">=</span> length <span class="free">y</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span>hd <span class="main">(</span>drop <span class="free">n</span> <span class="main">(</span>zip <span class="free">x</span> <span class="free">y</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> hd <span class="main">(</span>drop <span class="free">n</span> <span class="free">y</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">x</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="free">y</span></span><span class="main"><span class="keyword3">,</span></span><span class="operator">auto</span><span class="main">)</span>
     <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> Cons_nth_drop_Suc drop_zip snd_conv length_Cons list.sel<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> zip_Cons_Cons<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Ucasting of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">a</span></span><span class="main"><span class="main">+</span></span><span class="free"><span class="free">b</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> can be rewritten to taking bits of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">a</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">b</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.
›</span></span>

<span class="keyword1" id="BitByte-ucast_plus"><span class="command">lemma</span></span> ucast_plus<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">a</span> <span class="free">b</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>len word"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">LENGTH</span><span class="main">(</span><span class="tfree">'a</span><span class="main">)</span> <span class="main">&gt;</span> <span class="keyword1">LENGTH</span><span class="main">(</span><span class="tfree">'b</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>ucast <span class="main">(</span><span class="free">a</span> <span class="main">+</span> <span class="free">b</span><span class="main">)</span> <span class="main">::</span><span class="tfree">'b</span><span class="main">::</span>len word<span class="main">)</span> <span class="main">=</span> <span class="main">(</span>ucast <span class="free">a</span> <span class="main">+</span> ucast <span class="free">b</span><span class="main">::</span><span class="tfree">'b</span><span class="main">::</span>len word<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"to_bl <span class="main">(</span>ucast <span class="main">(</span><span class="free">a</span> <span class="main">+</span> <span class="free">b</span><span class="main">)</span> <span class="main">::</span><span class="tfree">'b</span><span class="main">::</span>len word<span class="main">)</span> <span class="main">=</span> to_bl <span class="main">(</span>ucast <span class="free">a</span> <span class="main">+</span> ucast <span class="free">b</span><span class="main">::</span><span class="tfree">'b</span><span class="main">::</span>len word<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> to_bl_ucast to_bl_plus_carry word_rep_drop length_foldr_bitwise_add drop_zip<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> rev_drop bitwise_add_def <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> foldr_replicate foldr_append<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> bitwise_add_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> length_foldr_bitwise_add<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> drop_take bitwise_add_take<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> rev_take length_foldr_bitwise_add<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> word_bl.Rep_eqD
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="BitByte-ucast_uminus"><span class="command">lemma</span></span> ucast_uminus<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">a</span> <span class="free">b</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>len word"</span></span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">LENGTH</span><span class="main">(</span><span class="tfree">'a</span><span class="main">)</span> <span class="main">&gt;</span> <span class="keyword1">LENGTH</span><span class="main">(</span><span class="tfree">'b</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"ucast <span class="main">(</span><span class="main">-</span> <span class="free">a</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">-</span> ucast <span class="free">a</span> <span class="main">::</span> <span class="tfree">'b</span><span class="main">::</span>len word<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> twos_complement<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> word_succ_p1<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> ucast_plus<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> assms<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> word_eqI<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> word_size nth_ucast nth_bitNOT<span class="main">)</span>
   <span class="keyword1"><span class="command">using</span></span> assms order.strict_trans
   <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="BitByte-ucast_minus"><span class="command">lemma</span></span> ucast_minus<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">a</span> <span class="free">b</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>len word"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">LENGTH</span><span class="main">(</span><span class="tfree">'a</span><span class="main">)</span> <span class="main">&gt;</span> <span class="keyword1">LENGTH</span><span class="main">(</span><span class="tfree">'b</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>ucast <span class="main">(</span><span class="free">a</span> <span class="main">-</span> <span class="free">b</span><span class="main">)</span> <span class="main">::</span><span class="tfree">'b</span><span class="main">::</span>len word<span class="main">)</span> <span class="main">=</span> <span class="main">(</span>ucast <span class="free">a</span> <span class="main">-</span> ucast <span class="free">b</span><span class="main">::</span><span class="tfree">'b</span><span class="main">::</span>len word<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> ucast_plus<span class="main">[</span><span class="operator">OF</span> assms<span class="main">,</span><span class="operator">of</span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="quoted">"<span class="main">-</span><span class="free">b</span>"</span></span><span class="main">]</span> ucast_uminus<span class="main">[</span><span class="operator">OF</span> assms<span class="main">,</span><span class="operator">of</span> <span class="quoted"><span class="free">b</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="BitByte-to_bl_takebits"><span class="command">lemma</span></span> to_bl_takebits<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">a</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>len word"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"to_bl <span class="main">(</span><span class="main">⟨</span><span class="main">0</span><span class="main">,</span><span class="free">h</span><span class="main">⟩</span><span class="free">a</span><span class="main">)</span> <span class="main">=</span> replicate <span class="main">(</span><span class="keyword1">LENGTH</span><span class="main">(</span><span class="tfree">'a</span><span class="main">)</span> <span class="main">-</span> <span class="free">h</span><span class="main">)</span> False <span class="main">@</span> drop <span class="main">(</span><span class="keyword1">LENGTH</span><span class="main">(</span><span class="tfree">'a</span><span class="main">)</span> <span class="main">-</span> <span class="free">h</span><span class="main">)</span> <span class="main">(</span>to_bl <span class="free">a</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> take_bits_def bl_word_and to_bl_mask<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> nth_equalityI<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> min_def nth_append<span class="main">)</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹ All simplification rules that are used during symbolic execution.›</span></span>
<span class="keyword1"><span class="command">lemmas</span></span> BitByte_simps <span class="main">=</span> ucast_plus ucast_minus ucast_uminus take_bits_overwrite take_bits_take_bits
  ucast_take_bits overwrite_0_take_bits_0 mask_eq_exp_minus_1
  ucast_down_ucast_id is_down take_bits_ucast ucast_up_ucast_id is_up

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Simplification for immediate (numeral) values.›</span></span>
<span class="keyword1"><span class="command">lemmas</span></span> take_bits_numeral<span class="main">[</span><span class="operator">simp</span><span class="main">]</span> <span class="main">=</span> take_bits_def<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="main">_</span> <span class="quoted"><span class="quoted">"numeral <span class="free">n</span>"</span></span><span class="main">]</span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">n</span>
<span class="keyword1"><span class="command">lemmas</span></span> take_bits_num0<span class="main">[</span><span class="operator">simp</span><span class="main">]</span> <span class="main">=</span> take_bits_def<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="main">_</span> <span class="quoted"><span class="quoted">"<span class="main">0</span>"</span></span><span class="main">]</span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">n</span>
<span class="keyword1"><span class="command">lemmas</span></span> take_bits_num1<span class="main">[</span><span class="operator">simp</span><span class="main">]</span> <span class="main">=</span> take_bits_def<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="main">_</span> <span class="quoted"><span class="quoted">"<span class="main">1</span>"</span></span><span class="main">]</span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">n</span>
<span class="keyword1"><span class="command">lemmas</span></span> overwrite_numeral_numeral<span class="main">[</span><span class="operator">simp</span><span class="main">]</span> <span class="main">=</span> overwrite_def<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="main">_</span> <span class="quoted"><span class="quoted">"numeral <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"numeral <span class="free">m</span>"</span></span><span class="main">]</span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">n</span> <span class="free">m</span>
<span class="keyword1"><span class="command">lemmas</span></span> overwrite_num0_numeral<span class="main">[</span><span class="operator">simp</span><span class="main">]</span> <span class="main">=</span> overwrite_def<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="main">_</span> <span class="quoted"><span class="main">0</span></span> <span class="quoted"><span class="quoted">"numeral <span class="free">m</span>"</span></span><span class="main">]</span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">n</span> <span class="free">m</span>
<span class="keyword1"><span class="command">lemmas</span></span> overwrite_numeral_num0<span class="main">[</span><span class="operator">simp</span><span class="main">]</span> <span class="main">=</span> overwrite_def<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="main">_</span> <span class="quoted"><span class="quoted">"numeral <span class="free">m</span>"</span></span> <span class="quoted"><span class="main">0</span></span><span class="main">]</span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">n</span> <span class="free">m</span>
<span class="keyword1"><span class="command">lemmas</span></span> overwrite_numeral_00<span class="main">[</span><span class="operator">simp</span><span class="main">]</span> <span class="main">=</span> overwrite_def<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="main">_</span> <span class="quoted"><span class="main">0</span></span> <span class="quoted"><span class="main">0</span></span><span class="main">]</span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="Memory">
<div class="head">
<h1>Theory Memory</h1>
</div>
<pre class="source"><span class="comment1">(*  Title:       X86 instruction semantics and basic block symbolic execution
    Authors:     Freek Verbeek, Abhijith Bharadwaj, Joshua Bockenek, Ian Roessle, Timmy Weerwag, Binoy Ravindran
    Year:        2020
    Maintainer:  Freek Verbeek (freek@vt.edu)
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">"Memory-related theorems"</span></span>

<span class="keyword1"><span class="command">theory</span></span> Memory
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="#BitByte">BitByte</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">context</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">dummy_type</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>len"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">read_bytes</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> word <span class="main">⇒</span> <span class="numeral">8</span> word<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> word <span class="main">⇒</span> nat <span class="main">⇒</span> <span class="numeral">8</span>word list"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">read_bytes</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">0</span>   <span class="main">=</span> <span class="main">[]</span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">read_bytes</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">+</span> of_nat <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">#</span> <span class="free">read_bytes</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Read bytes from memory. Memory is represented by a term of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="quoted">"<span class="numeral"><span class="numeral">64</span></span> word <span class="main"><span class="main">⇒</span></span> <span class="numeral"><span class="numeral">8</span></span> word"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.
      Given an address <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> [show_types] <span class="quoted"><span class="quoted">"<span class="free"><span class="free">a</span></span><span class="main"><span class="main">::</span></span><span class="numeral"><span class="numeral">64</span></span> word"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and a size <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">n</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, retrieve the bytes in
      the order they are stored in memory.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">region_addresses</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> word <span class="main">⇒</span> nat <span class="main">⇒</span> <span class="tfree">'a</span> word set"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">region_addresses</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">si</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="bound">a'</span> <span class="main">.</span> <span class="main">∃</span> <span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">si</span></span></span> <span class="main">.</span> <span class="bound">a'</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">+</span> of_nat <span class="main">(</span><span class="free"><span class="bound"><span class="entity">si</span></span></span> <span class="main">-</span> <span class="bound">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The set of addresses belonging to a region starting at address <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">a</span></span><span class="main"><span class="main">::</span></span><span class="numeral"><span class="numeral">64</span></span> word"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">si</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> bytes.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">region_overflow</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> word <span class="main">⇒</span> nat <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">region_overflow</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">si</span></span></span> <span class="main">≡</span> unat <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">+</span> <span class="free"><span class="bound"><span class="entity">si</span></span></span> <span class="main">≥</span> <span class="numeral">2</span><span class="main">^</span><span class="keyword1">LENGTH</span><span class="main">(</span><span class="tfree">'a</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹An overflow occurs if the address plus the size is greater equal <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="numeral"><span class="numeral">2</span></span><span class="main"><span class="main">^</span></span><span class="numeral"><span class="numeral">64</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">enclosed</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> word <span class="main">⇒</span> nat <span class="main">⇒</span> <span class="tfree">'a</span> word <span class="main">⇒</span> nat <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">enclosed</span> <span class="free"><span class="bound"><span class="entity">a'</span></span></span> <span class="free"><span class="bound"><span class="entity">si'</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">si</span></span></span> <span class="main">≡</span> unat <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">+</span> <span class="free"><span class="bound"><span class="entity">si</span></span></span> <span class="main">&lt;</span> <span class="numeral">2</span><span class="main">^</span><span class="keyword1">LENGTH</span><span class="main">(</span><span class="tfree">'a</span><span class="main">)</span> <span class="main">∧</span> unat <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">≤</span> unat <span class="free"><span class="bound"><span class="entity">a'</span></span></span> <span class="main">∧</span> unat <span class="free"><span class="bound"><span class="entity">a'</span></span></span> <span class="main">+</span> <span class="free"><span class="bound"><span class="entity">si'</span></span></span> <span class="main">≤</span> unat <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">+</span> <span class="free"><span class="bound"><span class="entity">si</span></span></span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹A region is enclosed in another if its <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> region_addresses<span class="antiquote"><span class="antiquote">}</span></span></span></span> is a subset of the other.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">separate</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> word <span class="main">⇒</span> nat <span class="main">⇒</span> <span class="tfree">'a</span> word <span class="main">⇒</span> nat <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">separate</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">si</span></span></span> <span class="free"><span class="bound"><span class="entity">a'</span></span></span> <span class="free"><span class="bound"><span class="entity">si'</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">si</span></span></span> <span class="main">≠</span><span class="main">0</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">si'</span></span></span> <span class="main">≠</span> <span class="main">0</span> <span class="main">∧</span> region_addresses <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">si</span></span></span> <span class="main">∩</span> region_addresses <span class="free"><span class="bound"><span class="entity">a'</span></span></span> <span class="free"><span class="bound"><span class="entity">si'</span></span></span> <span class="main">=</span> <span class="main">{}</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹A region is separate from another if they do not overlap.›</span></span>



<span class="keyword1" id="Memory-region_addresses_iff"><span class="command">lemma</span></span> region_addresses_iff<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a'</span> <span class="main">∈</span> region_addresses <span class="free">a</span> <span class="free">si</span> <span class="main">⟷</span> unat <span class="main">(</span><span class="free">a'</span> <span class="main">-</span> <span class="free">a</span><span class="main">)</span> <span class="main">&lt;</span> <span class="free">si</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> region_addresses_def unsigned_of_nat<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> diff_Suc_less le_less_trans less_imp_Suc_add take_bit_nat_less_eq_self zero_less_Suc<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> <span class="main"><span class="main">(</span></span>z3<span class="main"><span class="main">)</span></span> add.commute add_Suc_right add_diff_cancel_left' diff_add_cancel less_add_Suc2 less_imp_Suc_add word_unat.Rep_inverse<span class="main">)</span>

<span class="keyword1" id="Memory-notin_region_addresses"><span class="command">lemma</span></span> notin_region_addresses<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> region_addresses <span class="free">a</span> <span class="free">si</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"unat <span class="free">x</span> <span class="main">&lt;</span> unat <span class="free">a</span> <span class="main">∨</span> unat <span class="free">a</span> <span class="main">+</span> <span class="free">si</span> <span class="main">≤</span> unat <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms add.commute less_diff_conv2 not_le_imp_less region_addresses_iff unat_sub_if'<span class="main">)</span>

<span class="keyword1" id="Memory-notin_region_addresses_sub"><span class="command">lemma</span></span> notin_region_addresses_sub<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> region_addresses <span class="free">a</span> <span class="free">si</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"unat <span class="main">(</span><span class="free">x</span> <span class="main">-</span> <span class="free">a'</span><span class="main">)</span> <span class="main">&lt;</span> unat <span class="main">(</span><span class="free">a</span> <span class="main">-</span> <span class="free">a'</span><span class="main">)</span> <span class="main">∨</span> unat <span class="main">(</span><span class="free">a</span> <span class="main">-</span> <span class="free">a'</span><span class="main">)</span> <span class="main">+</span> <span class="free">si</span> <span class="main">≤</span> unat <span class="main">(</span><span class="free">x</span> <span class="main">-</span> <span class="free">a'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms notin_region_addresses region_addresses_iff <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Memory-region_addresses_eq_empty_iff"><span class="command">lemma</span></span> region_addresses_eq_empty_iff<span class="main">:</span> <span class="quoted"><span class="quoted">"region_addresses <span class="free">a</span> <span class="free">si</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">⟷</span> <span class="free">si</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> region_addresses_iff add_diff_cancel_left' ex_in_conv neq0_conv not_less0 unsigned_0<span class="main">)</span>

<span class="keyword1" id="Memory-length_read_bytes"><span class="command">lemma</span></span> length_read_bytes<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>read_bytes <span class="free">m</span> <span class="free">a</span> <span class="free">si</span><span class="main">)</span> <span class="main">=</span> <span class="free">si</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">si</span></span><span class="main"><span class="keyword3">,</span></span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="Memory-nth_read_bytes"><span class="command">lemma</span></span> nth_read_bytes<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&lt;</span> <span class="free">si</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"read_bytes <span class="free">m</span> <span class="free">a</span> <span class="free">si</span> <span class="main">!</span> <span class="free">n</span> <span class="main">=</span> <span class="free">m</span> <span class="main">(</span><span class="free">a</span> <span class="main">+</span> of_nat <span class="main">(</span><span class="free">si</span> <span class="main">-</span> <span class="main">1</span> <span class="main">-</span> <span class="free">n</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">si</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">n</span></span><span class="main"><span class="keyword3">,</span></span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> si n
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">n</span></span><span class="main"><span class="keyword3">,</span></span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Writing to memory occurs via function <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> override_on<span class="antiquote"><span class="antiquote">}</span></span></span></span>.
      In case of enclosure, reading bytes from memory overridden on a set of region addresses can
      be simplified to reading bytes from the overwritten memory only.
      In case of separation, reading bytes from overridden memory can be simplified to reading
      from the original memory.›</span></span>

<span class="keyword1" id="Memory-read_bytes_override_on_enclosed"><span class="command">lemma</span></span> read_bytes_override_on_enclosed<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">offset'</span> <span class="main">≤</span> <span class="free">offset</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">si'</span> <span class="main">≤</span> <span class="free">si</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"unat <span class="free">offset</span> <span class="main">+</span> <span class="free">si'</span> <span class="main">≤</span> <span class="free">si</span> <span class="main">+</span> unat <span class="free">offset'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"read_bytes <span class="main">(</span>override_on <span class="free">m</span> <span class="free">m'</span> <span class="main">(</span>region_addresses <span class="main">(</span><span class="free">a</span> <span class="main">-</span> <span class="free">offset</span><span class="main">)</span> <span class="free">si</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">a</span> <span class="main">-</span> <span class="free">offset'</span><span class="main">)</span> <span class="free">si'</span> <span class="main">=</span> read_bytes <span class="free">m'</span> <span class="main">(</span><span class="free">a</span> <span class="main">-</span> <span class="free">offset'</span><span class="main">)</span> <span class="free">si'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span>
    <span class="keyword3"><span class="command">assume</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> <span class="free">si'</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?i</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">si</span> <span class="main">+</span> <span class="skolem">i</span> <span class="main">+</span> unat <span class="free">offset'</span><span class="main">)</span> <span class="main">-</span> unat <span class="free">offset</span> <span class="main">-</span> <span class="free">si'</span>"</span></span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">+</span> unat <span class="free">offset'</span> <span class="main">&lt;</span> <span class="free">si'</span> <span class="main">+</span> unat <span class="free">offset</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> 1 assms<span class="main">(</span>1<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">unat_arith</span>
    <span class="keyword1"><span class="command">hence</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">si</span> <span class="main">+</span> <span class="skolem">i</span> <span class="main">+</span> unat <span class="free">offset'</span> <span class="main">-</span> <span class="main">(</span>unat <span class="free">offset</span> <span class="main">+</span> <span class="free">si'</span><span class="main">)</span> <span class="main">&lt;</span> <span class="free">si</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> diff_less<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">si'</span> <span class="main">+</span> unat <span class="free">offset</span> <span class="main">-</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">-</span> unat <span class="free">offset'</span>"</span></span> <span class="quoted"><span class="free">si</span></span><span class="main">]</span> assms<span class="main">(</span>3<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"of_nat <span class="main">(</span><span class="free">si'</span> <span class="main">-</span> Suc <span class="skolem">i</span><span class="main">)</span> <span class="main">-</span> <span class="free">offset'</span> <span class="main">=</span> of_nat <span class="main">(</span><span class="free">si</span> <span class="main">-</span> Suc <span class="var">?i</span><span class="main">)</span> <span class="main">-</span> <span class="free">offset</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms 1 2 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> of_nat_diff<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound"><span class="bound">i'</span></span> <span class="main">&lt;</span> <span class="free">si</span><span class="main">.</span> of_nat <span class="main">(</span><span class="free">si'</span> <span class="main">-</span> Suc <span class="skolem">i</span><span class="main">)</span> <span class="main">-</span> <span class="free">offset'</span> <span class="main">=</span> of_nat <span class="main">(</span><span class="free">si</span> <span class="main">-</span> Suc <span class="bound">i'</span><span class="main">)</span> <span class="main">-</span> <span class="free">offset</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">note</span></span> 1 <span class="main">=</span> this
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> nth_equalityI<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> 1
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> length_read_bytes nth_read_bytes override_on_def region_addresses_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> read_bytes_override_on <span class="main">=</span> read_bytes_override_on_enclosed<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> offset<span class="main"><span class="main">=</span></span><span class="quoted"><span class="main">0</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> offset'<span class="main"><span class="main">=</span></span><span class="quoted"><span class="main">0</span></span><span class="main">,</span><span class="operator">simplified</span><span class="main">]</span>

<span class="keyword1" id="Memory-read_bytes_override_on_enclosed_plus"><span class="command">lemma</span></span> read_bytes_override_on_enclosed_plus<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"unat <span class="free">offset</span> <span class="main">+</span> <span class="free">si'</span> <span class="main">≤</span> <span class="free">si</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">si</span> <span class="main">≤</span> <span class="numeral">2</span><span class="main">^</span><span class="keyword1">LENGTH</span><span class="main">(</span><span class="tfree">'a</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"read_bytes <span class="main">(</span>override_on <span class="free">m</span> <span class="free">m'</span> <span class="main">(</span>region_addresses <span class="free">a</span> <span class="free">si</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">offset</span><span class="main">+</span><span class="free">a</span><span class="main">)</span> <span class="free">si'</span> <span class="main">=</span> read_bytes <span class="free">m'</span> <span class="main">(</span><span class="free">offset</span><span class="main">+</span><span class="free">a</span><span class="main">)</span> <span class="free">si'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> <span class="free">si'</span> <span class="main">⟹</span> <span class="main">∃</span> <span class="bound"><span class="bound">i'</span></span> <span class="main">&lt;</span> <span class="free">si</span><span class="main">.</span> <span class="free">offset</span> <span class="main">+</span> <span class="main">(</span>of_nat <span class="main">(</span><span class="free">si'</span> <span class="main">-</span> Suc <span class="skolem">i</span><span class="main">)</span><span class="main">::</span><span class="tfree">'a</span> word<span class="main">)</span> <span class="main">=</span> of_nat <span class="main">(</span><span class="free">si</span> <span class="main">-</span> Suc <span class="bound">i'</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span><span class="quoted"><span class="quoted"><span class="quoted">"<span class="free"><span class="free">si</span></span> <span class="main"><span class="main">-</span></span> <span class="free"><span class="free">si'</span></span> <span class="main"><span class="main">+</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="main"><span class="main">-</span></span> unat <span class="free"><span class="free">offset</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> of_nat_diff<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">note</span></span> 1 <span class="main">=</span> this
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> nth_equalityI<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> assms 1
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> override_on_def length_read_bytes nth_read_bytes region_addresses_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1" id="Memory-read_bytes_override_on_separate"><span class="command">lemma</span></span> read_bytes_override_on_separate<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"separate <span class="free">a</span> <span class="free">si</span> <span class="free">a'</span> <span class="free">si'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"read_bytes <span class="main">(</span>override_on <span class="free">m</span> <span class="free">m'</span> <span class="main">(</span>region_addresses <span class="free">a</span> <span class="free">si</span><span class="main">)</span><span class="main">)</span> <span class="free">a'</span> <span class="free">si'</span> <span class="main">=</span> read_bytes <span class="free">m</span> <span class="free">a'</span> <span class="free">si'</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> nth_equalityI<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> length_read_bytes nth_read_bytes override_on_def separate_def region_addresses_def<span class="main">)</span>


<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Bytes are are written to memory one-by-one, then read by <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> read_bytes<span class="antiquote"><span class="antiquote">}</span></span></span></span> producing a list of bytes.
    That list is concatenated again using <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> word_rcat<span class="antiquote"><span class="antiquote">}</span></span></span></span>. Writing <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">si</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> bytes of word <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">w</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> into
    memory, reading the byte-list and concatenating again produces <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">si</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> bytes of the original word.›</span></span>


<span class="keyword1" id="Memory-word_rcat_read_bytes_enclosed"><span class="command">lemma</span></span> word_rcat_read_bytes_enclosed<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">w</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'b</span><span class="main">::</span>len word"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">LENGTH</span><span class="main">(</span><span class="tfree">'b</span><span class="main">)</span> <span class="main">≤</span> <span class="numeral">2</span><span class="main">^</span><span class="keyword1">LENGTH</span><span class="main">(</span><span class="tfree">'a</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"unat <span class="free">offset</span> <span class="main">+</span> <span class="free">si</span> <span class="main">≤</span> <span class="numeral">2</span><span class="main">^</span><span class="keyword1">LENGTH</span><span class="main">(</span><span class="tfree">'a</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"word_rcat <span class="main">(</span>read_bytes <span class="main">(</span><span class="main">λ</span><span class="bound">a'</span><span class="main">.</span> take_byte <span class="main">(</span>unat <span class="main">(</span><span class="bound">a'</span> <span class="main">-</span> <span class="free">a</span><span class="main">)</span><span class="main">)</span> <span class="free">w</span><span class="main">)</span> <span class="main">(</span><span class="free">a</span> <span class="main">+</span> <span class="free">offset</span><span class="main">)</span> <span class="free">si</span><span class="main">)</span> <span class="main">=</span> <span class="main">⟨</span>unat <span class="free">offset</span> <span class="main">*</span> <span class="numeral">8</span><span class="main">,</span><span class="main">(</span>unat <span class="free">offset</span> <span class="main">+</span> <span class="free">si</span><span class="main">)</span> <span class="main">*</span> <span class="numeral">8</span><span class="main">⟩</span><span class="free">w</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> word_eqI<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> test_bit_rcat word_size length_read_bytes rev_nth nth_read_bytes unat_of_nat nth_takebyte unat_word_ariths <span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> take_byte_def nth_ucast nth_takebits take_bit_eq_mod <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm<span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nth_takebits <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm<span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> take_byte_def nth_ucast nth_takebits <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm<span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rev_nth length_read_bytes take_byte_def nth_ucast nth_takebits nth_read_bytes unat_word_ariths unat_of_nat take_bit_eq_mod <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm<span class="main">)</span>

<span class="keyword1"><span class="command">lemmas</span></span> word_rcat_read_bytes <span class="main">=</span> word_rcat_read_bytes_enclosed<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> offset<span class="main"><span class="main">=</span></span><span class="quoted"><span class="main">0</span></span><span class="main">,</span><span class="operator">simplified</span><span class="main">]</span>



<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The following theorems allow reasoning over enclosure and separation, for example as linear arithmetic.›</span></span>

<span class="keyword1" id="Memory-enclosed_spec"><span class="command">lemma</span></span> enclosed_spec<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> enclosed<span class="main">:</span> <span class="quoted"><span class="quoted">"enclosed <span class="free">a'</span> <span class="free">si'</span> <span class="free">a</span> <span class="free">si</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> x_in<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> region_addresses <span class="free">a'</span> <span class="free">si'</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> region_addresses <span class="free">a</span> <span class="free">si</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> x_in <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"unat <span class="main">(</span><span class="free">x</span> <span class="main">-</span> <span class="free">a'</span><span class="main">)</span> <span class="main">&lt;</span> <span class="free">si'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> region_addresses_iff <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">with</span></span> enclosed <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"unat <span class="main">(</span><span class="free">x</span> <span class="main">-</span> <span class="free">a</span><span class="main">)</span> <span class="main">&lt;</span> <span class="free">si</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> enclosed_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> unat_sub_if' <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> region_addresses_iff <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Memory-address_in_enclosed_region_as_linarith"><span class="command">lemma</span></span> address_in_enclosed_region_as_linarith<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"enclosed <span class="free">a'</span> <span class="free">si'</span> <span class="free">a</span> <span class="free">si</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> region_addresses <span class="free">a'</span> <span class="free">si'</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">≤</span> <span class="free">x</span> <span class="main">∧</span> <span class="free">a'</span> <span class="main">≤</span> <span class="free">x</span> <span class="main">∧</span> <span class="free">x</span> <span class="main">&lt;</span> <span class="free">a'</span> <span class="main">+</span> of_nat <span class="free">si'</span> <span class="main">∧</span> <span class="free">x</span> <span class="main">&lt;</span> <span class="free">a</span> <span class="main">+</span> of_nat <span class="free">si</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> enclosed_def region_addresses_def word_le_nat_alt word_less_nat_alt unat_of_nat unat_word_ariths unat_sub_if' take_bit_eq_mod<span class="main">)</span>


<span class="keyword1" id="Memory-address_of_enclosed_region_ge"><span class="command">lemma</span></span> address_of_enclosed_region_ge<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"enclosed <span class="free">a'</span> <span class="free">si'</span> <span class="free">a</span> <span class="free">si</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">a'</span> <span class="main">≥</span> <span class="free">a</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms word_le_nat_alt
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> enclosed_def<span class="main">)</span>

<span class="keyword1" id="Memory-address_in_enclosed_region"><span class="command">lemma</span></span> address_in_enclosed_region<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"enclosed <span class="free">a'</span> <span class="free">si'</span> <span class="free">a</span> <span class="free">si</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> region_addresses <span class="free">a'</span> <span class="free">si'</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"unat <span class="main">(</span><span class="free">x</span> <span class="main">-</span> <span class="free">a</span><span class="main">)</span> <span class="main">≥</span> unat <span class="main">(</span><span class="free">a'</span> <span class="main">-</span> <span class="free">a</span><span class="main">)</span> <span class="main">∧</span> unat <span class="main">(</span><span class="free">a'</span> <span class="main">-</span> <span class="free">a</span><span class="main">)</span> <span class="main">+</span> <span class="free">si'</span> <span class="main">&gt;</span> unat <span class="main">(</span><span class="free">x</span> <span class="main">-</span> <span class="free">a</span><span class="main">)</span> <span class="main">∧</span> unat <span class="main">(</span><span class="free">x</span> <span class="main">-</span> <span class="free">a</span><span class="main">)</span> <span class="main">&lt;</span> <span class="free">si</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> <span class="main"><span class="main">(</span></span>z3<span class="main"><span class="main">)</span></span> address_in_enclosed_region_as_linarith add_diff_cancel_left' address_of_enclosed_region_ge assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> diff_diff_add enclosed_spec le_iff_add nat_add_left_cancel_less region_addresses_iff unat_sub_if' word_le_minus_mono_left word_unat.Rep_inverse word_unat_less_le<span class="main">)</span>

<span class="keyword1" id="Memory-enclosed_minus_minus"><span class="command">lemma</span></span> enclosed_minus_minus<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">a</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> word"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">offset</span> <span class="main">≥</span> <span class="free">offset'</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"unat <span class="free">offset</span> <span class="main">-</span> <span class="free">si</span> <span class="main">≤</span> unat <span class="free">offset'</span> <span class="main">-</span> <span class="free">si'</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"unat <span class="free">offset'</span> <span class="main">≥</span> <span class="free">si'</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"unat <span class="free">offset</span> <span class="main">≥</span> <span class="free">si</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">≥</span> <span class="free">offset</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"enclosed <span class="main">(</span><span class="free">a</span> <span class="main">-</span> <span class="free">offset'</span><span class="main">)</span> <span class="free">si'</span> <span class="main">(</span><span class="free">a</span> <span class="main">-</span> <span class="free">offset</span><span class="main">)</span> <span class="free">si</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"unat <span class="free">offset'</span> <span class="main">≤</span> unat <span class="free">a</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">,</span>5<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">unat_arith</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> enclosed_def unat_sub_if_size word_size<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">unat_arith</span>
    <span class="keyword1"><span class="command">using</span></span> diff_le_mono2<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"unat <span class="free">offset</span> <span class="main">-</span> <span class="free">si</span>"</span></span> <span class="quoted"><span class="quoted">"unat <span class="free">offset'</span> <span class="main">-</span> <span class="free">si'</span>"</span></span> <span class="quoted"><span class="quoted">"unat <span class="free">a</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> enclosed_def unat_sub_if_size word_size<span class="main">)</span>
     <span class="keyword1"><span class="command">by</span></span> <span class="operator">unat_arith</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Memory-enclosed_plus"><span class="command">lemma</span></span> enclosed_plus<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">a</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> word"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">si'</span> <span class="main">&lt;</span> <span class="free">si</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"unat <span class="free">a</span> <span class="main">+</span> <span class="free">si</span> <span class="main">&lt;</span> <span class="numeral">2</span><span class="main">^</span><span class="keyword1">LENGTH</span><span class="main">(</span><span class="tfree">'a</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"enclosed <span class="free">a</span> <span class="free">si'</span> <span class="free">a</span> <span class="free">si</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> enclosed_def<span class="main">)</span>

<span class="keyword1" id="Memory-separate_symm"><span class="command">lemma</span></span> separate_symm<span class="main">:</span> <span class="quoted"><span class="quoted">"separate <span class="free">a</span> <span class="free">si</span> <span class="free">a'</span> <span class="free">si'</span> <span class="main">=</span> separate <span class="free">a'</span> <span class="free">si'</span> <span class="free">a</span> <span class="free">si</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> inf.commute separate_def<span class="main">)</span>

<span class="keyword1" id="Memory-separate_iff"><span class="command">lemma</span></span> separate_iff<span class="main">:</span> <span class="quoted"><span class="quoted">"separate <span class="free">a</span> <span class="free">si</span> <span class="free">a'</span> <span class="free">si'</span> <span class="main">⟷</span> <span class="free">si</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">∧</span> <span class="free">si'</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">∧</span> unat <span class="main">(</span><span class="free">a'</span> <span class="main">-</span> <span class="free">a</span><span class="main">)</span> <span class="main">≥</span> <span class="free">si</span> <span class="main">∧</span> unat <span class="main">(</span><span class="free">a</span> <span class="main">-</span> <span class="free">a'</span><span class="main">)</span> <span class="main">≥</span> <span class="free">si'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> assm<span class="main">:</span> <span class="quoted"><span class="quoted">"separate <span class="free">a</span> <span class="free">si</span> <span class="free">a'</span> <span class="free">si'</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"unat <span class="main">(</span><span class="skolem">a'</span> <span class="main">-</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">≥</span> <span class="skolem">si</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"separate <span class="skolem">a</span> <span class="skolem">si</span> <span class="skolem">a'</span> <span class="skolem">si'</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">a</span> <span class="skolem">si</span> <span class="skolem">a'</span> <span class="skolem">si'</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> unat <span class="main">(</span><span class="skolem">a'</span> <span class="main">-</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">≥</span> <span class="skolem">si</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a'</span> <span class="main">∈</span> region_addresses <span class="skolem">a</span> <span class="skolem">si</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> region_addresses_iff<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> that <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a'</span> <span class="main">∈</span> region_addresses <span class="skolem">a'</span> <span class="skolem">si'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> region_addresses_iff separate_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>separate <span class="skolem">a</span> <span class="skolem">si</span> <span class="skolem">a'</span> <span class="skolem">si'</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> disjoint_iff separate_def<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> that <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">with</span></span> assm <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"unat <span class="main">(</span><span class="free">a'</span> <span class="main">-</span> <span class="free">a</span><span class="main">)</span> <span class="main">≥</span> <span class="free">si</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"unat <span class="main">(</span><span class="free">a</span> <span class="main">-</span> <span class="free">a'</span><span class="main">)</span> <span class="main">≥</span> <span class="free">si'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> separate_symm <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> assm <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">si</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">∧</span> <span class="free">si'</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">∧</span> unat <span class="main">(</span><span class="free">a'</span> <span class="main">-</span> <span class="free">a</span><span class="main">)</span> <span class="main">≥</span> <span class="free">si</span> <span class="main">∧</span> unat <span class="main">(</span><span class="free">a</span> <span class="main">-</span> <span class="free">a'</span><span class="main">)</span> <span class="main">≥</span> <span class="free">si'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> separate_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> assm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">si</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">∧</span> <span class="free">si'</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">∧</span> unat <span class="main">(</span><span class="free">a'</span> <span class="main">-</span> <span class="free">a</span><span class="main">)</span> <span class="main">≥</span> <span class="free">si</span> <span class="main">∧</span> unat <span class="main">(</span><span class="free">a</span> <span class="main">-</span> <span class="free">a'</span><span class="main">)</span> <span class="main">≥</span> <span class="free">si'</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"unat <span class="main">(</span><span class="skolem">x</span> <span class="main">-</span> <span class="free">a'</span><span class="main">)</span> <span class="main">≥</span> <span class="free">si'</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"unat <span class="main">(</span><span class="skolem">x</span> <span class="main">-</span> <span class="free">a</span><span class="main">)</span> <span class="main">&lt;</span> <span class="free">si</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span>
    <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> unat_sub_if' <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">meson</span> Nat.le_diff_conv2 add_increasing le_less_trans less_imp_le_nat unsigned_greater_eq unsigned_less<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> <span class="main"><span class="main">(</span></span>z3<span class="main"><span class="main">)</span></span> Nat.le_diff_conv2 add_leD2 le_less_trans linorder_not_less nat_le_linear unat_lt2p<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"region_addresses <span class="free">a</span> <span class="free">si</span> <span class="main">∩</span> region_addresses <span class="free">a'</span> <span class="free">si'</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> region_addresses_iff disjoint_iff leD<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> assm <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"separate <span class="free">a</span> <span class="free">si</span> <span class="free">a'</span> <span class="free">si'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> separate_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Memory-separate_as_linarith"><span class="command">lemma</span></span> separate_as_linarith<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>region_overflow <span class="free">a</span> <span class="free">si</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>region_overflow <span class="free">a'</span> <span class="free">si'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"separate <span class="free">a</span> <span class="free">si</span> <span class="free">a'</span> <span class="free">si'</span> <span class="main">⟷</span> <span class="main">0</span> <span class="main">&lt;</span> <span class="free">si</span> <span class="main">∧</span> <span class="main">0</span> <span class="main">&lt;</span> <span class="free">si'</span> <span class="main">∧</span> <span class="main">(</span><span class="free">a</span> <span class="main">+</span> of_nat <span class="free">si</span> <span class="main">≤</span> <span class="free">a'</span> <span class="main">∨</span> <span class="free">a'</span> <span class="main">+</span> of_nat <span class="free">si'</span> <span class="main">≤</span> <span class="free">a</span><span class="main">)</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">⟷</span> <span class="var">?rhs</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="var"><span class="quoted"><span class="var">?lhs</span></span></span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?rhs</span></span></span>
   <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> separate_iff le_less le_plus not_le_imp_less word_of_nat_le<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"separate <span class="skolem">a</span> <span class="skolem">si</span> <span class="skolem">a'</span> <span class="skolem">si'</span>"</span></span>
    <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">si</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">si'</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">+</span> of_nat <span class="skolem">si</span> <span class="main">≤</span> <span class="skolem">a'</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>region_overflow <span class="skolem">a</span> <span class="skolem">si</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>region_overflow <span class="skolem">a'</span> <span class="skolem">si'</span>"</span></span>
    <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">a</span> <span class="skolem">si</span> <span class="skolem">a'</span> <span class="skolem">si'</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">from</span></span> that <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"unat <span class="skolem">a</span> <span class="main">+</span> <span class="skolem">si</span> <span class="main">&lt;</span> <span class="numeral">2</span><span class="main">^</span><span class="keyword1">LENGTH</span><span class="main">(</span><span class="tfree">'a</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"unat <span class="skolem">a'</span> <span class="main">+</span> <span class="skolem">si'</span> <span class="main">&lt;</span> <span class="numeral">2</span><span class="main">^</span><span class="keyword1">LENGTH</span><span class="main">(</span><span class="tfree">'a</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> not_le region_overflow_def<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">&lt;</span> <span class="skolem">a</span> <span class="main">+</span> of_nat <span class="skolem">si</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> region_addresses <span class="skolem">a</span> <span class="skolem">si</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> <span class="main"><span class="main">(</span></span>z3<span class="main"><span class="main">)</span></span> Abs_fnat_hom_add <span class="quoted"><span class="quoted">‹unat <span class="skolem">a</span> <span class="main">+</span> <span class="skolem">si</span> <span class="main">&lt;</span> <span class="numeral">2</span> <span class="main">^</span> <span class="keyword1">LENGTH</span><span class="main">(</span><span class="tfree">'a</span><span class="main">)</span>›</span></span> add.commute dual_order.trans le_add1 less_diff_conv2 not_less region_addresses_iff that unat_of_nat_len unat_sub_if' word_less_iff_unsigned word_unat.Rep_inverse<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≥</span> <span class="skolem">a'</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> region_addresses <span class="skolem">a'</span> <span class="skolem">si'</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span>
      <span class="keyword1"><span class="command">using</span></span> address_in_enclosed_region_as_linarith enclosed_def <span class="quoted"><span class="quoted">‹unat <span class="skolem">a'</span> <span class="main">+</span> <span class="skolem">si'</span> <span class="main">&lt;</span> <span class="numeral">2</span> <span class="main">^</span> <span class="keyword1">LENGTH</span><span class="main">(</span><span class="tfree">'a</span><span class="main">)</span>›</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> separate_def that <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="var"><span class="quoted"><span class="var">?rhs</span></span></span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?lhs</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> <span class="quoted">"*"</span> assms separate_symm<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Compute separation in case the addresses and sizes are immediate values.›</span></span>
<span class="keyword1"><span class="command">lemmas</span></span> separate_as_linarith_numeral <span class="main">[</span><span class="operator">simp</span><span class="main">]</span> <span class="main">=</span>
  separate_as_linarith <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"numeral <span class="free">a</span><span class="main">::</span><span class="tfree">'a</span> word"</span></span> <span class="quoted"><span class="quoted">"numeral <span class="free">si</span>"</span></span> <span class="quoted"><span class="quoted">"numeral <span class="free">a'</span><span class="main">::</span><span class="tfree">'a</span> word"</span></span> <span class="quoted"><span class="quoted">"numeral <span class="free">si'</span>"</span></span><span class="main">]</span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">a</span> <span class="free">si</span> <span class="free">a'</span> <span class="free">si'</span>
<span class="keyword1"><span class="command">lemmas</span></span> separate_as_linarith_numeral_1 <span class="main">[</span><span class="operator">simp</span><span class="main">]</span> <span class="main">=</span>
  separate_as_linarith <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"numeral <span class="free">a</span><span class="main">::</span><span class="tfree">'a</span> word"</span></span> <span class="quoted"><span class="quoted">"numeral <span class="free">si</span>"</span></span> <span class="quoted"><span class="quoted">"numeral <span class="free">a'</span><span class="main">::</span><span class="tfree">'a</span> word"</span></span> <span class="quoted"><span class="quoted">"Suc <span class="main">0</span>"</span></span><span class="main">]</span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">a</span> <span class="free">si</span> <span class="free">a'</span>
<span class="keyword1"><span class="command">lemmas</span></span> separate_as_linarith_numeral1_ <span class="main">[</span><span class="operator">simp</span><span class="main">]</span> <span class="main">=</span>
  separate_as_linarith <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"numeral <span class="free">a</span><span class="main">::</span><span class="tfree">'a</span> word"</span></span> <span class="quoted"><span class="quoted">"Suc <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"numeral <span class="free">a'</span><span class="main">::</span><span class="tfree">'a</span> word"</span></span> <span class="quoted"><span class="quoted">"numeral <span class="free">si'</span>"</span></span><span class="main">]</span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">a</span> <span class="free">a'</span> <span class="free">si'</span>
<span class="keyword1"><span class="command">lemmas</span></span> separate_as_linarith_numeral11 <span class="main">[</span><span class="operator">simp</span><span class="main">]</span> <span class="main">=</span>
  separate_as_linarith <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"numeral <span class="free">a</span><span class="main">::</span><span class="tfree">'a</span> word"</span></span> <span class="quoted"><span class="quoted">"Suc <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"numeral <span class="free">a'</span><span class="main">::</span><span class="tfree">'a</span> word"</span></span> <span class="quoted"><span class="quoted">"Suc <span class="main">0</span>"</span></span><span class="main">]</span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">a</span> <span class="free">a'</span>
<span class="keyword1"><span class="command">lemmas</span></span> region_overflow_numeral<span class="main">[</span><span class="operator">simp</span><span class="main">]</span> <span class="main">=</span>
  region_overflow_def <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"numeral <span class="free">a</span><span class="main">::</span><span class="tfree">'a</span> word"</span></span> <span class="quoted"><span class="quoted">"numeral <span class="free">si</span>"</span></span><span class="main">]</span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">a</span> <span class="free">si</span>
<span class="keyword1"><span class="command">lemmas</span></span> region_overflow_numeral1<span class="main">[</span><span class="operator">simp</span><span class="main">]</span> <span class="main">=</span>
  region_overflow_def <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"numeral <span class="free">a</span><span class="main">::</span><span class="tfree">'a</span> word"</span></span> <span class="quoted"><span class="quoted">"Suc <span class="main">0</span>"</span></span><span class="main">]</span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">a</span>


<span class="keyword1" id="Memory-separate_plus_none"><span class="command">lemma</span></span> separate_plus_none<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">si'</span> <span class="main">≤</span> unat <span class="free">offset</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="free">si</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="free">si'</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"unat <span class="free">offset</span> <span class="main">+</span> <span class="free">si</span> <span class="main">≤</span> <span class="numeral">2</span><span class="main">^</span><span class="keyword1">LENGTH</span><span class="main">(</span><span class="tfree">'a</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"separate <span class="main">(</span><span class="free">offset</span> <span class="main">+</span> <span class="free">a</span><span class="main">)</span> <span class="free">si</span> <span class="free">a</span> <span class="free">si'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> separate_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> <span class="main"><span class="main">(</span></span>z3<span class="main"><span class="main">)</span></span> Nat.diff_diff_right add.commute add_leD1 diff_0 diff_is_0_eq diff_zero not_gr_zero unat_sub_if' unsigned_0<span class="main">)</span>

<span class="keyword1"><span class="command">lemmas</span></span> unat_minus <span class="main">=</span> unat_sub_if'<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="main">0</span></span><span class="main">,</span><span class="operator">simplified</span><span class="main">]</span>

<span class="keyword1" id="Memory-separate_minus_minus'"><span class="command">lemma</span></span> separate_minus_minus'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">si</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">si'</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"unat <span class="free">offset</span> <span class="main">≥</span> <span class="free">si</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"unat <span class="free">offset'</span> <span class="main">≥</span> <span class="free">si'</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"unat <span class="free">offset</span> <span class="main">-</span> <span class="free">si</span> <span class="main">≥</span> unat <span class="free">offset'</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"separate <span class="main">(</span><span class="free">a</span> <span class="main">-</span> <span class="free">offset</span><span class="main">)</span> <span class="free">si</span> <span class="main">(</span><span class="free">a</span> <span class="main">-</span> <span class="free">offset'</span><span class="main">)</span> <span class="free">si'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> separate_iff<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> Nat.le_diff_conv2 add.commute add_leD2 unat_sub_if'<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> <span class="main"><span class="main">(</span></span>z3<span class="main"><span class="main">)</span></span> add.commute add_diff_cancel_right' diff_add_cancel diff_le_self diff_less less_le_trans nat_le_linear not_le unat_sub_if'<span class="main">)</span>

<span class="keyword1" id="Memory-separate_minus_minus"><span class="command">lemma</span></span> separate_minus_minus<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">si</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">si'</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"unat <span class="free">offset</span> <span class="main">≥</span> <span class="free">si</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"unat <span class="free">offset'</span> <span class="main">≥</span> <span class="free">si'</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"unat <span class="free">offset</span> <span class="main">-</span> <span class="free">si</span> <span class="main">≥</span> unat <span class="free">offset'</span> <span class="main">∨</span> unat <span class="free">offset'</span> <span class="main">-</span> <span class="free">si'</span> <span class="main">≥</span> unat <span class="free">offset</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"separate <span class="main">(</span><span class="free">a</span> <span class="main">-</span> <span class="free">offset</span><span class="main">)</span> <span class="free">si</span> <span class="main">(</span><span class="free">a</span> <span class="main">-</span> <span class="free">offset'</span><span class="main">)</span> <span class="free">si'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> assms separate_minus_minus' separate_symm<span class="main">)</span>

<span class="keyword1" id="Memory-separate_minus_none"><span class="command">lemma</span></span> separate_minus_none<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">si</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">si'</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"unat <span class="free">offset</span> <span class="main">≥</span> <span class="free">si</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">si'</span> <span class="main">≤</span> <span class="numeral">2</span><span class="main">^</span><span class="keyword1">LENGTH</span><span class="main">(</span><span class="tfree">'a</span><span class="main">)</span> <span class="main">-</span> unat <span class="free">offset</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"separate <span class="main">(</span><span class="free">a</span> <span class="main">-</span> <span class="free">offset</span><span class="main">)</span> <span class="free">si</span> <span class="free">a</span> <span class="free">si'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="free">si</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="free">si'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="free">offset</span> <span class="main">≤</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> <span class="main"><span class="main">(</span></span>z3<span class="main"><span class="main">)</span></span> add_diff_cancel_left' assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">,</span></span>4<span class="main"><span class="main">)</span></span> diff_diff_eq2 diff_zero le_add_diff_inverse less_or_eq_imp_le separate_iff unat_sub_if' unsigned_0 unsigned_less word_less_eq_iff_unsigned<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The following theorems are used during symbolic execution to determine whether two regions are separate.›</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> separate_simps <span class="main">=</span> separate_plus_none separate_minus_none separate_minus_minus

<span class="keyword2"><span class="keyword">end</span></span>
<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="State">
<div class="head">
<h1>Theory State</h1>
</div>
<pre class="source"><span class="comment1">(*  Title:       X86 instruction semantics and basic block symbolic execution
    Authors:     Freek Verbeek, Abhijith Bharadwaj, Joshua Bockenek, Ian Roessle, Timmy Weerwag, Binoy Ravindran
    Year:        2020
    Maintainer:  Freek Verbeek (freek@vt.edu)
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">"Concrete state and instructions"</span></span>

<span class="keyword1"><span class="command">theory</span></span> State
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="https://www.cl.cam.ac.uk/research/hvg/Isabelle/dist/library/HOL/HOL/Main.html">Main</a> <a href="#Memory">Memory</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹A state consists of registers, memory, flags and a rip. Some design considerations here:
\begin{itemize}
\item All register values are 256 bits. We could also distinguish 64 bits registers, 128 registers etc.
      That would increase complexity in proofs and datastructures. The cost of using 256 everywhere is
      that a goal typically will have some casted 64 bits values.
\item The instruction pointer RIP is a special 64-bit register outside of the normal register set.
\item Strings are used for registers and flags. We would prefer an enumerative datatype, however, that would be
      extremely slow since there are roughly 100 register names.
\end{itemize}
›</span></span>

<span class="keyword1"><span class="command">record</span></span> state <span class="main">=</span>
  regs  <span class="main">::</span> <span class="quoted"><span class="quoted">"string  <span class="main">⇒</span> <span class="numeral">256</span>word"</span></span>
  mem   <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="numeral">64</span> word <span class="main">⇒</span> <span class="numeral">8</span> word"</span></span>
  flags <span class="main">::</span> <span class="quoted"><span class="quoted">"string  <span class="main">⇒</span> bool"</span></span>
  rip   <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="numeral">64</span> word"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">real_reg</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"string <span class="main">⇒</span> bool <span class="main">×</span> string <span class="main">×</span> nat <span class="main">×</span> nat"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">real_reg</span> <span class="free"><span class="bound"><span class="entity">reg</span></span></span> <span class="main">≡</span>
  <span class="comment1">― ‹TODO: xmm, ymm, etc.›</span>
  <span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">reg</span></span></span> <span class="keyword1">of</span>
  <span class="comment1">― ‹rip›</span>
    <span class="inner_quoted">''rip''</span>   <span class="main">⇒</span> <span class="main">(</span>True<span class="main">,</span>  <span class="inner_quoted">''rip''</span><span class="main">,</span> <span class="main">0</span><span class="main">,</span><span class="numeral">64</span><span class="main">)</span>
  <span class="comment1">― ‹rax,rbx,rcx,rdx›</span>
  <span class="main">|</span> <span class="inner_quoted">''rax''</span>   <span class="main">⇒</span> <span class="main">(</span>True<span class="main">,</span>  <span class="inner_quoted">''rax''</span><span class="main">,</span> <span class="main">0</span><span class="main">,</span><span class="numeral">64</span><span class="main">)</span>
  <span class="main">|</span> <span class="inner_quoted">''eax''</span>   <span class="main">⇒</span> <span class="main">(</span>True<span class="main">,</span>  <span class="inner_quoted">''rax''</span><span class="main">,</span> <span class="main">0</span><span class="main">,</span><span class="numeral">32</span><span class="main">)</span>
  <span class="main">|</span> <span class="inner_quoted">''ax''</span>    <span class="main">⇒</span> <span class="main">(</span>False<span class="main">,</span> <span class="inner_quoted">''rax''</span><span class="main">,</span> <span class="main">0</span><span class="main">,</span><span class="numeral">16</span><span class="main">)</span>
  <span class="main">|</span> <span class="inner_quoted">''ah''</span>    <span class="main">⇒</span> <span class="main">(</span>False<span class="main">,</span> <span class="inner_quoted">''rax''</span><span class="main">,</span> <span class="numeral">8</span><span class="main">,</span><span class="numeral">16</span><span class="main">)</span>
  <span class="main">|</span> <span class="inner_quoted">''al''</span>    <span class="main">⇒</span> <span class="main">(</span>False<span class="main">,</span> <span class="inner_quoted">''rax''</span><span class="main">,</span> <span class="main">0</span><span class="main">,</span><span class="numeral">8</span><span class="main">)</span>
  <span class="main">|</span> <span class="inner_quoted">''rbx''</span>   <span class="main">⇒</span> <span class="main">(</span>True<span class="main">,</span>  <span class="inner_quoted">''rbx''</span><span class="main">,</span> <span class="main">0</span><span class="main">,</span><span class="numeral">64</span><span class="main">)</span>
  <span class="main">|</span> <span class="inner_quoted">''ebx''</span>   <span class="main">⇒</span> <span class="main">(</span>True<span class="main">,</span>  <span class="inner_quoted">''rbx''</span><span class="main">,</span> <span class="main">0</span><span class="main">,</span><span class="numeral">32</span><span class="main">)</span>
  <span class="main">|</span> <span class="inner_quoted">''bx''</span>    <span class="main">⇒</span> <span class="main">(</span>False<span class="main">,</span> <span class="inner_quoted">''rbx''</span><span class="main">,</span> <span class="main">0</span><span class="main">,</span><span class="numeral">16</span><span class="main">)</span>
  <span class="main">|</span> <span class="inner_quoted">''bh''</span>    <span class="main">⇒</span> <span class="main">(</span>False<span class="main">,</span> <span class="inner_quoted">''rbx''</span><span class="main">,</span> <span class="numeral">8</span><span class="main">,</span><span class="numeral">16</span><span class="main">)</span>
  <span class="main">|</span> <span class="inner_quoted">''bl''</span>    <span class="main">⇒</span> <span class="main">(</span>False<span class="main">,</span> <span class="inner_quoted">''rbx''</span><span class="main">,</span> <span class="main">0</span><span class="main">,</span><span class="numeral">8</span><span class="main">)</span>
  <span class="main">|</span> <span class="inner_quoted">''rcx''</span>   <span class="main">⇒</span> <span class="main">(</span>True<span class="main">,</span>  <span class="inner_quoted">''rcx''</span><span class="main">,</span> <span class="main">0</span><span class="main">,</span><span class="numeral">64</span><span class="main">)</span>
  <span class="main">|</span> <span class="inner_quoted">''ecx''</span>   <span class="main">⇒</span> <span class="main">(</span>True<span class="main">,</span>  <span class="inner_quoted">''rcx''</span><span class="main">,</span> <span class="main">0</span><span class="main">,</span><span class="numeral">32</span><span class="main">)</span>
  <span class="main">|</span> <span class="inner_quoted">''cx''</span>    <span class="main">⇒</span> <span class="main">(</span>False<span class="main">,</span> <span class="inner_quoted">''rcx''</span><span class="main">,</span> <span class="main">0</span><span class="main">,</span><span class="numeral">16</span><span class="main">)</span>
  <span class="main">|</span> <span class="inner_quoted">''ch''</span>    <span class="main">⇒</span> <span class="main">(</span>False<span class="main">,</span> <span class="inner_quoted">''rcx''</span><span class="main">,</span> <span class="numeral">8</span><span class="main">,</span><span class="numeral">16</span><span class="main">)</span>
  <span class="main">|</span> <span class="inner_quoted">''cl''</span>    <span class="main">⇒</span> <span class="main">(</span>False<span class="main">,</span> <span class="inner_quoted">''rcx''</span><span class="main">,</span> <span class="main">0</span><span class="main">,</span><span class="numeral">8</span><span class="main">)</span>
  <span class="main">|</span> <span class="inner_quoted">''rdx''</span>   <span class="main">⇒</span> <span class="main">(</span>True<span class="main">,</span>  <span class="inner_quoted">''rdx''</span><span class="main">,</span> <span class="main">0</span><span class="main">,</span><span class="numeral">64</span><span class="main">)</span>
  <span class="main">|</span> <span class="inner_quoted">''edx''</span>   <span class="main">⇒</span> <span class="main">(</span>True<span class="main">,</span>  <span class="inner_quoted">''rdx''</span><span class="main">,</span> <span class="main">0</span><span class="main">,</span><span class="numeral">32</span><span class="main">)</span>
  <span class="main">|</span> <span class="inner_quoted">''dx''</span>    <span class="main">⇒</span> <span class="main">(</span>False<span class="main">,</span> <span class="inner_quoted">''rdx''</span><span class="main">,</span> <span class="main">0</span><span class="main">,</span><span class="numeral">16</span><span class="main">)</span>
  <span class="main">|</span> <span class="inner_quoted">''dh''</span>    <span class="main">⇒</span> <span class="main">(</span>False<span class="main">,</span> <span class="inner_quoted">''rdx''</span><span class="main">,</span> <span class="numeral">8</span><span class="main">,</span><span class="numeral">16</span><span class="main">)</span>
  <span class="main">|</span> <span class="inner_quoted">''dl''</span>    <span class="main">⇒</span> <span class="main">(</span>False<span class="main">,</span> <span class="inner_quoted">''rdx''</span><span class="main">,</span> <span class="main">0</span><span class="main">,</span><span class="numeral">8</span><span class="main">)</span>
  <span class="comment1">― ‹RBP, RSP›</span>
  <span class="main">|</span> <span class="inner_quoted">''rbp''</span>   <span class="main">⇒</span> <span class="main">(</span>True<span class="main">,</span>  <span class="inner_quoted">''rbp''</span><span class="main">,</span> <span class="main">0</span><span class="main">,</span><span class="numeral">64</span><span class="main">)</span>
  <span class="main">|</span> <span class="inner_quoted">''ebp''</span>   <span class="main">⇒</span> <span class="main">(</span>True<span class="main">,</span>  <span class="inner_quoted">''rbp''</span><span class="main">,</span> <span class="main">0</span><span class="main">,</span><span class="numeral">32</span><span class="main">)</span>
  <span class="main">|</span> <span class="inner_quoted">''bp''</span>    <span class="main">⇒</span> <span class="main">(</span>False<span class="main">,</span> <span class="inner_quoted">''rbp''</span><span class="main">,</span> <span class="main">0</span><span class="main">,</span><span class="numeral">16</span><span class="main">)</span>
  <span class="main">|</span> <span class="inner_quoted">''bpl''</span>   <span class="main">⇒</span> <span class="main">(</span>False<span class="main">,</span> <span class="inner_quoted">''rbp''</span><span class="main">,</span> <span class="main">0</span><span class="main">,</span><span class="numeral">8</span><span class="main">)</span>
  <span class="main">|</span> <span class="inner_quoted">''rsp''</span>   <span class="main">⇒</span> <span class="main">(</span>True<span class="main">,</span>  <span class="inner_quoted">''rsp''</span><span class="main">,</span> <span class="main">0</span><span class="main">,</span><span class="numeral">64</span><span class="main">)</span>
  <span class="main">|</span> <span class="inner_quoted">''esp''</span>   <span class="main">⇒</span> <span class="main">(</span>True<span class="main">,</span>  <span class="inner_quoted">''rsp''</span><span class="main">,</span> <span class="main">0</span><span class="main">,</span><span class="numeral">32</span><span class="main">)</span>
  <span class="main">|</span> <span class="inner_quoted">''sp''</span>    <span class="main">⇒</span> <span class="main">(</span>False<span class="main">,</span> <span class="inner_quoted">''rsp''</span><span class="main">,</span> <span class="main">0</span><span class="main">,</span><span class="numeral">16</span><span class="main">)</span>
  <span class="main">|</span> <span class="inner_quoted">''spl''</span>   <span class="main">⇒</span> <span class="main">(</span>False<span class="main">,</span> <span class="inner_quoted">''rsp''</span><span class="main">,</span> <span class="main">0</span><span class="main">,</span><span class="numeral">8</span><span class="main">)</span>
  <span class="comment1">― ‹ RDI, RSI, R8 to R15›</span>
  <span class="main">|</span> <span class="inner_quoted">''rdi''</span>   <span class="main">⇒</span> <span class="main">(</span>True<span class="main">,</span>  <span class="inner_quoted">''rdi''</span><span class="main">,</span> <span class="main">0</span><span class="main">,</span><span class="numeral">64</span><span class="main">)</span>
  <span class="main">|</span> <span class="inner_quoted">''edi''</span>   <span class="main">⇒</span> <span class="main">(</span>True<span class="main">,</span>  <span class="inner_quoted">''rdi''</span><span class="main">,</span> <span class="main">0</span><span class="main">,</span><span class="numeral">32</span><span class="main">)</span>
  <span class="main">|</span> <span class="inner_quoted">''di''</span>    <span class="main">⇒</span> <span class="main">(</span>False<span class="main">,</span> <span class="inner_quoted">''rdi''</span><span class="main">,</span> <span class="main">0</span><span class="main">,</span><span class="numeral">16</span><span class="main">)</span>
  <span class="main">|</span> <span class="inner_quoted">''dil''</span>   <span class="main">⇒</span> <span class="main">(</span>False<span class="main">,</span> <span class="inner_quoted">''rdi''</span><span class="main">,</span> <span class="main">0</span><span class="main">,</span><span class="numeral">8</span><span class="main">)</span>
  <span class="main">|</span> <span class="inner_quoted">''rsi''</span>   <span class="main">⇒</span> <span class="main">(</span>True<span class="main">,</span>  <span class="inner_quoted">''rsi''</span><span class="main">,</span> <span class="main">0</span><span class="main">,</span><span class="numeral">64</span><span class="main">)</span>
  <span class="main">|</span> <span class="inner_quoted">''esi''</span>   <span class="main">⇒</span> <span class="main">(</span>True<span class="main">,</span>  <span class="inner_quoted">''rsi''</span><span class="main">,</span> <span class="main">0</span><span class="main">,</span><span class="numeral">32</span><span class="main">)</span>
  <span class="main">|</span> <span class="inner_quoted">''si''</span>    <span class="main">⇒</span> <span class="main">(</span>False<span class="main">,</span> <span class="inner_quoted">''rsi''</span><span class="main">,</span> <span class="main">0</span><span class="main">,</span><span class="numeral">16</span><span class="main">)</span>
  <span class="main">|</span> <span class="inner_quoted">''sil''</span>   <span class="main">⇒</span> <span class="main">(</span>False<span class="main">,</span> <span class="inner_quoted">''rsi''</span><span class="main">,</span> <span class="main">0</span><span class="main">,</span><span class="numeral">8</span><span class="main">)</span>
  <span class="main">|</span> <span class="inner_quoted">''r15''</span>   <span class="main">⇒</span> <span class="main">(</span>True<span class="main">,</span>  <span class="inner_quoted">''r15''</span><span class="main">,</span> <span class="main">0</span><span class="main">,</span><span class="numeral">64</span><span class="main">)</span>
  <span class="main">|</span> <span class="inner_quoted">''r15d''</span>  <span class="main">⇒</span> <span class="main">(</span>True<span class="main">,</span>  <span class="inner_quoted">''r15''</span><span class="main">,</span> <span class="main">0</span><span class="main">,</span><span class="numeral">32</span><span class="main">)</span>
  <span class="main">|</span> <span class="inner_quoted">''r15w''</span>  <span class="main">⇒</span> <span class="main">(</span>False<span class="main">,</span> <span class="inner_quoted">''r15''</span><span class="main">,</span> <span class="main">0</span><span class="main">,</span><span class="numeral">16</span><span class="main">)</span>
  <span class="main">|</span> <span class="inner_quoted">''r15b''</span>  <span class="main">⇒</span> <span class="main">(</span>False<span class="main">,</span> <span class="inner_quoted">''r15''</span><span class="main">,</span> <span class="main">0</span><span class="main">,</span><span class="numeral">8</span><span class="main">)</span>
  <span class="main">|</span> <span class="inner_quoted">''r14''</span>   <span class="main">⇒</span> <span class="main">(</span>True<span class="main">,</span>  <span class="inner_quoted">''r14''</span><span class="main">,</span> <span class="main">0</span><span class="main">,</span><span class="numeral">64</span><span class="main">)</span>
  <span class="main">|</span> <span class="inner_quoted">''r14d''</span>  <span class="main">⇒</span> <span class="main">(</span>True<span class="main">,</span>  <span class="inner_quoted">''r14''</span><span class="main">,</span> <span class="main">0</span><span class="main">,</span><span class="numeral">32</span><span class="main">)</span>
  <span class="main">|</span> <span class="inner_quoted">''r14w''</span>  <span class="main">⇒</span> <span class="main">(</span>False<span class="main">,</span> <span class="inner_quoted">''r14''</span><span class="main">,</span> <span class="main">0</span><span class="main">,</span><span class="numeral">16</span><span class="main">)</span>
  <span class="main">|</span> <span class="inner_quoted">''r14b''</span>  <span class="main">⇒</span> <span class="main">(</span>False<span class="main">,</span> <span class="inner_quoted">''r14''</span><span class="main">,</span> <span class="main">0</span><span class="main">,</span><span class="numeral">8</span><span class="main">)</span>
  <span class="main">|</span> <span class="inner_quoted">''r13''</span>   <span class="main">⇒</span> <span class="main">(</span>True<span class="main">,</span>  <span class="inner_quoted">''r13''</span><span class="main">,</span> <span class="main">0</span><span class="main">,</span><span class="numeral">64</span><span class="main">)</span>
  <span class="main">|</span> <span class="inner_quoted">''r13d''</span>  <span class="main">⇒</span> <span class="main">(</span>True<span class="main">,</span>  <span class="inner_quoted">''r13''</span><span class="main">,</span> <span class="main">0</span><span class="main">,</span><span class="numeral">32</span><span class="main">)</span>
  <span class="main">|</span> <span class="inner_quoted">''r13w''</span>  <span class="main">⇒</span> <span class="main">(</span>False<span class="main">,</span> <span class="inner_quoted">''r13''</span><span class="main">,</span> <span class="main">0</span><span class="main">,</span><span class="numeral">16</span><span class="main">)</span>
  <span class="main">|</span> <span class="inner_quoted">''r13b''</span>  <span class="main">⇒</span> <span class="main">(</span>False<span class="main">,</span> <span class="inner_quoted">''r13''</span><span class="main">,</span> <span class="main">0</span><span class="main">,</span><span class="numeral">8</span><span class="main">)</span>
  <span class="main">|</span> <span class="inner_quoted">''r12''</span>   <span class="main">⇒</span> <span class="main">(</span>True<span class="main">,</span>  <span class="inner_quoted">''r12''</span><span class="main">,</span> <span class="main">0</span><span class="main">,</span><span class="numeral">64</span><span class="main">)</span>
  <span class="main">|</span> <span class="inner_quoted">''r12d''</span>  <span class="main">⇒</span> <span class="main">(</span>True<span class="main">,</span>  <span class="inner_quoted">''r12''</span><span class="main">,</span> <span class="main">0</span><span class="main">,</span><span class="numeral">32</span><span class="main">)</span>
  <span class="main">|</span> <span class="inner_quoted">''r12w''</span>  <span class="main">⇒</span> <span class="main">(</span>False<span class="main">,</span> <span class="inner_quoted">''r12''</span><span class="main">,</span> <span class="main">0</span><span class="main">,</span><span class="numeral">16</span><span class="main">)</span>
  <span class="main">|</span> <span class="inner_quoted">''r12b''</span>  <span class="main">⇒</span> <span class="main">(</span>False<span class="main">,</span> <span class="inner_quoted">''r12''</span><span class="main">,</span> <span class="main">0</span><span class="main">,</span><span class="numeral">8</span><span class="main">)</span>
  <span class="main">|</span> <span class="inner_quoted">''r11''</span>   <span class="main">⇒</span> <span class="main">(</span>True<span class="main">,</span>  <span class="inner_quoted">''r11''</span><span class="main">,</span> <span class="main">0</span><span class="main">,</span><span class="numeral">64</span><span class="main">)</span>
  <span class="main">|</span> <span class="inner_quoted">''r11d''</span>  <span class="main">⇒</span> <span class="main">(</span>True<span class="main">,</span>  <span class="inner_quoted">''r11''</span><span class="main">,</span> <span class="main">0</span><span class="main">,</span><span class="numeral">32</span><span class="main">)</span>
  <span class="main">|</span> <span class="inner_quoted">''r11w''</span>  <span class="main">⇒</span> <span class="main">(</span>False<span class="main">,</span> <span class="inner_quoted">''r11''</span><span class="main">,</span> <span class="main">0</span><span class="main">,</span><span class="numeral">16</span><span class="main">)</span>
  <span class="main">|</span> <span class="inner_quoted">''r11b''</span>  <span class="main">⇒</span> <span class="main">(</span>False<span class="main">,</span> <span class="inner_quoted">''r11''</span><span class="main">,</span> <span class="main">0</span><span class="main">,</span><span class="numeral">8</span><span class="main">)</span>
  <span class="main">|</span> <span class="inner_quoted">''r10''</span>   <span class="main">⇒</span> <span class="main">(</span>True<span class="main">,</span>  <span class="inner_quoted">''r10''</span><span class="main">,</span> <span class="main">0</span><span class="main">,</span><span class="numeral">64</span><span class="main">)</span>
  <span class="main">|</span> <span class="inner_quoted">''r10d''</span>  <span class="main">⇒</span> <span class="main">(</span>True<span class="main">,</span>  <span class="inner_quoted">''r10''</span><span class="main">,</span> <span class="main">0</span><span class="main">,</span><span class="numeral">32</span><span class="main">)</span>
  <span class="main">|</span> <span class="inner_quoted">''r10w''</span>  <span class="main">⇒</span> <span class="main">(</span>False<span class="main">,</span> <span class="inner_quoted">''r10''</span><span class="main">,</span> <span class="main">0</span><span class="main">,</span><span class="numeral">16</span><span class="main">)</span>
  <span class="main">|</span> <span class="inner_quoted">''r10b''</span>  <span class="main">⇒</span> <span class="main">(</span>False<span class="main">,</span> <span class="inner_quoted">''r10''</span><span class="main">,</span> <span class="main">0</span><span class="main">,</span><span class="numeral">8</span><span class="main">)</span>
  <span class="main">|</span> <span class="inner_quoted">''r9''</span>    <span class="main">⇒</span> <span class="main">(</span>True<span class="main">,</span>  <span class="inner_quoted">''r9''</span> <span class="main">,</span> <span class="main">0</span><span class="main">,</span><span class="numeral">64</span><span class="main">)</span>
  <span class="main">|</span> <span class="inner_quoted">''r9d''</span>   <span class="main">⇒</span> <span class="main">(</span>True<span class="main">,</span>  <span class="inner_quoted">''r9''</span> <span class="main">,</span> <span class="main">0</span><span class="main">,</span><span class="numeral">32</span><span class="main">)</span>
  <span class="main">|</span> <span class="inner_quoted">''r9w''</span>   <span class="main">⇒</span> <span class="main">(</span>False<span class="main">,</span> <span class="inner_quoted">''r9''</span> <span class="main">,</span> <span class="main">0</span><span class="main">,</span><span class="numeral">16</span><span class="main">)</span>
  <span class="main">|</span> <span class="inner_quoted">''r9b''</span>   <span class="main">⇒</span> <span class="main">(</span>False<span class="main">,</span> <span class="inner_quoted">''r9''</span> <span class="main">,</span> <span class="main">0</span><span class="main">,</span><span class="numeral">8</span><span class="main">)</span>
  <span class="main">|</span> <span class="inner_quoted">''r8''</span>    <span class="main">⇒</span> <span class="main">(</span>True<span class="main">,</span>  <span class="inner_quoted">''r8''</span> <span class="main">,</span> <span class="main">0</span><span class="main">,</span><span class="numeral">64</span><span class="main">)</span>
  <span class="main">|</span> <span class="inner_quoted">''r8d''</span>   <span class="main">⇒</span> <span class="main">(</span>True<span class="main">,</span>  <span class="inner_quoted">''r8''</span> <span class="main">,</span> <span class="main">0</span><span class="main">,</span><span class="numeral">32</span><span class="main">)</span>
  <span class="main">|</span> <span class="inner_quoted">''r8w''</span>   <span class="main">⇒</span> <span class="main">(</span>False<span class="main">,</span> <span class="inner_quoted">''r8''</span> <span class="main">,</span> <span class="main">0</span><span class="main">,</span><span class="numeral">16</span><span class="main">)</span>
  <span class="main">|</span> <span class="inner_quoted">''r8b''</span>   <span class="main">⇒</span> <span class="main">(</span>False<span class="main">,</span> <span class="inner_quoted">''r8''</span> <span class="main">,</span> <span class="main">0</span><span class="main">,</span><span class="numeral">8</span><span class="main">)</span>
  <span class="comment1">― ‹xmm›</span>
  <span class="main">|</span> <span class="inner_quoted">''xmm0''</span>  <span class="main">⇒</span> <span class="main">(</span>True<span class="main">,</span> <span class="inner_quoted">''xmm0''</span> <span class="main">,</span> <span class="main">0</span><span class="main">,</span><span class="numeral">128</span><span class="main">)</span>
  <span class="main">|</span> <span class="inner_quoted">''xmm1''</span>  <span class="main">⇒</span> <span class="main">(</span>True<span class="main">,</span> <span class="inner_quoted">''xmm1''</span> <span class="main">,</span> <span class="main">0</span><span class="main">,</span><span class="numeral">128</span><span class="main">)</span>
  <span class="main">|</span> <span class="inner_quoted">''xmm2''</span>  <span class="main">⇒</span> <span class="main">(</span>True<span class="main">,</span> <span class="inner_quoted">''xmm2''</span> <span class="main">,</span> <span class="main">0</span><span class="main">,</span><span class="numeral">128</span><span class="main">)</span>
  <span class="main">|</span> <span class="inner_quoted">''xmm3''</span>  <span class="main">⇒</span> <span class="main">(</span>True<span class="main">,</span> <span class="inner_quoted">''xmm3''</span> <span class="main">,</span> <span class="main">0</span><span class="main">,</span><span class="numeral">128</span><span class="main">)</span>
  <span class="main">|</span> <span class="inner_quoted">''xmm4''</span>  <span class="main">⇒</span> <span class="main">(</span>True<span class="main">,</span> <span class="inner_quoted">''xmm4''</span> <span class="main">,</span> <span class="main">0</span><span class="main">,</span><span class="numeral">128</span><span class="main">)</span>
  <span class="main">|</span> <span class="inner_quoted">''xmm5''</span>  <span class="main">⇒</span> <span class="main">(</span>True<span class="main">,</span> <span class="inner_quoted">''xmm5''</span> <span class="main">,</span> <span class="main">0</span><span class="main">,</span><span class="numeral">128</span><span class="main">)</span>
  <span class="main">|</span> <span class="inner_quoted">''xmm6''</span>  <span class="main">⇒</span> <span class="main">(</span>True<span class="main">,</span> <span class="inner_quoted">''xmm6''</span> <span class="main">,</span> <span class="main">0</span><span class="main">,</span><span class="numeral">128</span><span class="main">)</span>
  <span class="main">|</span> <span class="inner_quoted">''xmm7''</span>  <span class="main">⇒</span> <span class="main">(</span>True<span class="main">,</span> <span class="inner_quoted">''xmm7''</span> <span class="main">,</span> <span class="main">0</span><span class="main">,</span><span class="numeral">128</span><span class="main">)</span>
  <span class="main">|</span> <span class="inner_quoted">''xmm8''</span>  <span class="main">⇒</span> <span class="main">(</span>True<span class="main">,</span> <span class="inner_quoted">''xmm8''</span> <span class="main">,</span> <span class="main">0</span><span class="main">,</span><span class="numeral">128</span><span class="main">)</span>
  <span class="main">|</span> <span class="inner_quoted">''xmm9''</span>  <span class="main">⇒</span> <span class="main">(</span>True<span class="main">,</span> <span class="inner_quoted">''xmm9''</span> <span class="main">,</span> <span class="main">0</span><span class="main">,</span><span class="numeral">128</span><span class="main">)</span>
  <span class="main">|</span> <span class="inner_quoted">''xmm10''</span>  <span class="main">⇒</span> <span class="main">(</span>True<span class="main">,</span> <span class="inner_quoted">''xmm10''</span> <span class="main">,</span> <span class="main">0</span><span class="main">,</span><span class="numeral">128</span><span class="main">)</span>
  <span class="main">|</span> <span class="inner_quoted">''xmm11''</span>  <span class="main">⇒</span> <span class="main">(</span>True<span class="main">,</span> <span class="inner_quoted">''xmm11''</span> <span class="main">,</span> <span class="main">0</span><span class="main">,</span><span class="numeral">128</span><span class="main">)</span>
  <span class="main">|</span> <span class="inner_quoted">''xmm12''</span>  <span class="main">⇒</span> <span class="main">(</span>True<span class="main">,</span> <span class="inner_quoted">''xmm12''</span> <span class="main">,</span> <span class="main">0</span><span class="main">,</span><span class="numeral">128</span><span class="main">)</span>
  <span class="main">|</span> <span class="inner_quoted">''xmm13''</span>  <span class="main">⇒</span> <span class="main">(</span>True<span class="main">,</span> <span class="inner_quoted">''xmm13''</span> <span class="main">,</span> <span class="main">0</span><span class="main">,</span><span class="numeral">128</span><span class="main">)</span>
  <span class="main">|</span> <span class="inner_quoted">''xmm14''</span>  <span class="main">⇒</span> <span class="main">(</span>True<span class="main">,</span> <span class="inner_quoted">''xmm14''</span> <span class="main">,</span> <span class="main">0</span><span class="main">,</span><span class="numeral">128</span><span class="main">)</span>
  <span class="main">|</span> <span class="inner_quoted">''xmm15''</span>  <span class="main">⇒</span> <span class="main">(</span>True<span class="main">,</span> <span class="inner_quoted">''xmm15''</span> <span class="main">,</span> <span class="main">0</span><span class="main">,</span><span class="numeral">128</span><span class="main">)</span>
  "</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹x86 has register aliassing. For example, register EAX is the lower 32 bits of register RAX.
      This function map register aliasses to the ``real'' register. For example:

      <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"real_reg <span class="inner_quoted"><span class="inner_quoted">''ah''</span></span> <span class="main"><span class="main">=</span></span> <span class="main"><span class="main">(</span></span>False<span class="main"><span class="main">,</span></span> <span class="inner_quoted"><span class="inner_quoted">''rax''</span></span><span class="main"><span class="main">,</span></span> <span class="numeral"><span class="numeral">8</span></span><span class="main"><span class="main">,</span></span><span class="numeral"><span class="numeral">16</span></span><span class="main"><span class="main">)</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.

      This means that register AH is the second byte (bits 8 to 16) of register RAX.
      The bool <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> False<span class="antiquote"><span class="antiquote">}</span></span></span></span> indicates that writing to AH does not overwrite the remainder of RAX.

      <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"real_reg <span class="inner_quoted"><span class="inner_quoted">''eax''</span></span> <span class="main"><span class="main">=</span></span> <span class="main"><span class="main">(</span></span>True<span class="main"><span class="main">,</span></span> <span class="inner_quoted"><span class="inner_quoted">''rax''</span></span><span class="main"><span class="main">,</span></span> <span class="main"><span class="main">0</span></span><span class="main"><span class="main">,</span></span><span class="numeral"><span class="numeral">32</span></span><span class="main"><span class="main">)</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.

      Register EAX is the lower 4 bytes of RAX. Writing to EAX means overwritting the remainder of RAX
      with zeroes.
›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">reg_size</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"string <span class="main">⇒</span> nat"</span></span> <span class="comment1">― ‹in bytes›</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">reg_size</span> <span class="free"><span class="bound"><span class="entity">reg</span></span></span> <span class="main">≡</span> <span class="keyword1">let</span> <span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span><span class="main"><span class="bound">_</span></span><span class="main">,</span><span class="bound">l</span><span class="main">,</span><span class="bound">h</span><span class="main">)</span> <span class="main">=</span> real_reg <span class="free"><span class="bound"><span class="entity">reg</span></span></span> <span class="keyword1">in</span> <span class="main">(</span><span class="bound">h</span> <span class="main">-</span> <span class="bound">l</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">8</span>"</span></span>


<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹ We now define functions for reading and writing from state.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">reg_read</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"state <span class="main">⇒</span> string <span class="main">⇒</span> <span class="numeral">256</span> word"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">reg_read</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">reg</span></span></span> <span class="main">≡</span>
      <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">reg</span></span></span> <span class="main">=</span> <span class="inner_quoted">''rip''</span> <span class="keyword1">then</span> ucast <span class="main">(</span>rip <span class="free"><span class="bound"><span class="entity">σ</span></span></span><span class="main">)</span> <span class="keyword1">else</span>
      <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">reg</span></span></span> <span class="main">=</span> <span class="inner_quoted">''''</span> <span class="keyword1">then</span> <span class="main">0</span> <span class="keyword1">else</span> <span class="comment1">― ‹happens if no base register is used in an address›</span>
      <span class="keyword1">let</span> <span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span><span class="bound">r</span><span class="main">,</span><span class="bound">l</span><span class="main">,</span><span class="bound">h</span><span class="main">)</span> <span class="main">=</span> real_reg <span class="free"><span class="bound"><span class="entity">reg</span></span></span> <span class="keyword1">in</span>
        <span class="main">⟨</span><span class="bound">l</span><span class="main">,</span><span class="bound">h</span><span class="main">⟩</span><span class="main">(</span>regs <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="bound">r</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity"><span class="entity">fromBool</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted"><span class="quoted">"bool <span class="main"><span class="main">⇒</span></span> <span class="tfree"><span class="tfree">'a</span></span> <span class="main"><span class="main">::</span></span> len word"</span></span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted"><span class="quoted">"<span class="free"><span class="free">fromBool</span></span> True <span class="main"><span class="main">=</span></span> <span class="main"><span class="main">1</span></span>"</span></span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="free"><span class="free">fromBool</span></span> False <span class="main"><span class="main">=</span></span> <span class="main"><span class="main">0</span></span>"</span></span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">flag_read</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"state <span class="main">⇒</span> string <span class="main">⇒</span> <span class="numeral">256</span> word"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">flag_read</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">flag</span></span></span> <span class="main">≡</span> fromBool <span class="main">(</span>flags <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">flag</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">mem_read</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"state <span class="main">⇒</span> <span class="numeral">64</span> word <span class="main">⇒</span> nat <span class="main">⇒</span> <span class="numeral">256</span> word"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">mem_read</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">si</span></span></span> <span class="main">≡</span> word_rcat <span class="main">(</span>read_bytes <span class="main">(</span>mem <span class="free"><span class="bound"><span class="entity">σ</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">si</span></span></span><span class="main">)</span>"</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Doing state-updates occur through a tiny deeply embedded language of state updates. This allows us
      to reason over state updates through theorems.›</span></span>

<span class="keyword1"><span class="command">datatype</span></span> StateUpdate <span class="main">=</span>
    RegUpdate <span class="quoted">string</span> <span class="quoted"><span class="quoted">"<span class="numeral">256</span> word"</span></span>         <span class="comment1">― ‹Write value to register›</span>
  <span class="main">|</span> FlagUpdate <span class="quoted"><span class="quoted">"string <span class="main">⇒</span> bool"</span></span>         <span class="comment1">― ‹Update all flags at once›</span>
  <span class="main">|</span> RipUpdate <span class="quoted"><span class="quoted">"<span class="numeral">64</span> word"</span></span>                 <span class="comment1">― ‹Update instruction pointer with address›</span>
  <span class="main">|</span> MemUpdate <span class="quoted"><span class="quoted">"<span class="numeral">64</span> word"</span></span> <span class="quoted">nat</span> <span class="quoted"><span class="quoted">"<span class="numeral">256</span> word"</span></span>  <span class="comment1">― ‹Write a number of bytes of a value to the address›</span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">state_update</span>
  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">state_update</span> <span class="main">(</span>RegUpdate <span class="free"><span class="bound"><span class="entity">reg</span></span></span> <span class="free"><span class="bound"><span class="entity">val</span></span></span><span class="main">)</span>  <span class="main">=</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">σ</span> <span class="main">.</span> <span class="bound">σ</span><span class="main">⦇</span>regs <span class="main">:=</span> <span class="main">(</span>regs <span class="bound">σ</span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">reg</span></span></span> <span class="main">:=</span> <span class="free"><span class="bound"><span class="entity">val</span></span></span><span class="main">)</span><span class="main">⦈</span><span class="main">)</span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">state_update</span> <span class="main">(</span>FlagUpdate  <span class="free"><span class="bound"><span class="entity">val</span></span></span><span class="main">)</span>    <span class="main">=</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">σ</span> <span class="main">.</span> <span class="bound">σ</span><span class="main">⦇</span>flags <span class="main">:=</span> <span class="free"><span class="bound"><span class="entity">val</span></span></span><span class="main">⦈</span><span class="main">)</span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">state_update</span> <span class="main">(</span>RipUpdate <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span>        <span class="main">=</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">σ</span> <span class="main">.</span> <span class="bound">σ</span><span class="main">⦇</span>rip <span class="main">:=</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">⦈</span><span class="main">)</span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">state_update</span> <span class="main">(</span>MemUpdate <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">si</span></span></span> <span class="free"><span class="bound"><span class="entity">val</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">σ</span> <span class="main">.</span>
        <span class="keyword1">let</span> <span class="bound">new</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">a'</span> <span class="main">.</span> take_byte <span class="main">(</span>unat <span class="main">(</span><span class="bound">a'</span> <span class="main">-</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">val</span></span></span><span class="main">)</span> <span class="keyword1">in</span>
         <span class="bound">σ</span><span class="main">⦇</span>mem <span class="main">:=</span> override_on <span class="main">(</span>mem <span class="bound">σ</span><span class="main">)</span> <span class="bound">new</span> <span class="main">(</span>region_addresses <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">si</span></span></span><span class="main">)</span><span class="main">⦈</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">RegUpdateSyntax</span> <span class="main">(</span><span class="quoted">"_ <span class="keyword1">:=<span class="hidden">⇩</span><sub>r</sub></span> _"</span> 30<span class="main">)</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">RegUpdateSyntax</span> <span class="free"><span class="bound"><span class="entity">reg</span></span></span> <span class="free"><span class="bound"><span class="entity">val</span></span></span> <span class="main">≡</span> RegUpdate <span class="free"><span class="bound"><span class="entity">reg</span></span></span> <span class="free"><span class="bound"><span class="entity">val</span></span></span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">MemUpdateSyntax</span> <span class="main">(</span><span class="quoted">"<span class="keyword1">⟦</span>_<span class="keyword1">,</span>_<span class="keyword1">⟧</span> <span class="keyword1">:=<span class="hidden">⇩</span><sub>m</sub></span> _"</span> 30<span class="main">)</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">MemUpdateSyntax</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">si</span></span></span> <span class="free"><span class="bound"><span class="entity">val</span></span></span> <span class="main">≡</span> MemUpdate <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">si</span></span></span> <span class="free"><span class="bound"><span class="entity">val</span></span></span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">FlagUpdateSyntax</span> <span class="main">(</span><span class="quoted">"<span class="keyword1">setFlags</span>"</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">FlagUpdateSyntax</span> <span class="free"><span class="bound"><span class="entity">val</span></span></span> <span class="main">≡</span> FlagUpdate <span class="free"><span class="bound"><span class="entity">val</span></span></span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">RipUpdateSyntax</span> <span class="main">(</span><span class="quoted">"<span class="keyword1">setRip</span>"</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">RipUpdateSyntax</span> <span class="free"><span class="bound"><span class="entity">val</span></span></span> <span class="main">≡</span> RipUpdate <span class="free"><span class="bound"><span class="entity">val</span></span></span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Executes a write to a register in terms of the tiny deeply embedded language above.›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">reg_write</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">reg_write</span> <span class="free"><span class="bound"><span class="entity">reg</span></span></span> <span class="free"><span class="bound"><span class="entity">val</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">≡</span>
      <span class="keyword1">let</span> <span class="main">(</span><span class="bound">b</span><span class="main">,</span><span class="bound">r</span><span class="main">,</span><span class="bound">l</span><span class="main">,</span><span class="bound">h</span><span class="main">)</span>  <span class="main">=</span> real_reg <span class="free"><span class="bound"><span class="entity">reg</span></span></span><span class="main">;</span>
          <span class="bound">curr_val</span>   <span class="main">=</span> reg_read <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="bound">r</span><span class="main">;</span>
          <span class="bound">new_val</span>    <span class="main">=</span> <span class="keyword1">if</span> <span class="bound">b</span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">val</span></span></span> <span class="keyword1">else</span> overwrite <span class="bound">l</span> <span class="bound">h</span> <span class="bound">curr_val</span> <span class="free"><span class="bound"><span class="entity">val</span></span></span> <span class="keyword1">in</span>
        state_update <span class="main">(</span>RegUpdate <span class="bound">r</span> <span class="bound">new_val</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span>"</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹A datatype for operands of instructions.›</span></span>

<span class="keyword1"><span class="command">datatype</span></span> Operand <span class="main">=</span>
    Imm <span class="quoted"><span class="quoted">"<span class="numeral">256</span> word"</span></span>
  <span class="main">|</span> Reg <span class="quoted">string</span>
  <span class="main">|</span> Flag <span class="quoted">string</span>
  <span class="main">|</span> Mem  <span class="quoted">nat</span>    <span class="quoted"><span class="quoted">"<span class="numeral">64</span> word"</span></span>   <span class="quoted">string</span>    <span class="quoted"><span class="quoted">"string"</span></span>      <span class="quoted">nat</span>
      <span class="comment1">― ‹size   offset      base-reg  index-reg    scale›</span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">mem_op_no_offset_no_index</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"string <span class="main">⇒</span> <span class="main">(</span><span class="numeral">64</span> word <span class="main">×</span> string <span class="main">×</span> string <span class="main">×</span> nat<span class="main">)</span>"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">[</span>_<span class="keyword1">]<span class="hidden">⇩</span><sub>1</sub></span>"</span> 40<span class="main">)</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">mem_op_no_offset_no_index</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="main">0</span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">,</span><span class="main">[]</span><span class="main">,</span><span class="main">0</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">mem_op_no_index</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="numeral">64</span> word <span class="main">⇒</span> string <span class="main">⇒</span> <span class="main">(</span><span class="numeral">64</span> word <span class="main">×</span> string <span class="main">×</span> string <span class="main">×</span> nat<span class="main">)</span>"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">[</span>_ <span class="keyword1">+</span> _<span class="keyword1">]<span class="hidden">⇩</span><sub>2</sub></span>"</span> 40<span class="main">)</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">mem_op_no_index</span> <span class="free"><span class="bound"><span class="entity">offset</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">offset</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">,</span><span class="main">[]</span><span class="main">,</span><span class="main">0</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">mem_op</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="numeral">64</span> word <span class="main">⇒</span> string <span class="main">⇒</span> string <span class="main">⇒</span> nat <span class="main">⇒</span> <span class="main">(</span><span class="numeral">64</span> word <span class="main">×</span> string <span class="main">×</span> string <span class="main">×</span> nat<span class="main">)</span>"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">[</span>_ <span class="keyword1">+</span> _ <span class="keyword1">+</span> _ <span class="keyword1">*</span> _<span class="keyword1">]<span class="hidden">⇩</span><sub>3</sub></span>"</span> 40<span class="main">)</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">mem_op</span> <span class="free"><span class="bound"><span class="entity">offset</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">index</span></span></span> <span class="free"><span class="bound"><span class="entity">scale</span></span></span><span class="main">≡</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">offset</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">index</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">scale</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">ymm_ptr</span> <span class="main">(</span><span class="quoted">"<span class="keyword1">YMMWORD</span> <span class="keyword1">PTR</span> _"</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">YMMWORD</span></span> <span class="keyword1"><span class="free">PTR</span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">≡</span> <span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">offset</span><span class="main">,</span><span class="bound">base</span><span class="main">,</span><span class="bound">index</span><span class="main">,</span><span class="bound">scale</span><span class="main">)</span> <span class="main">⇒</span> Mem <span class="numeral">32</span> <span class="bound">offset</span> <span class="bound">base</span> <span class="bound">index</span> <span class="bound">scale</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">xmm_ptr</span> <span class="main">(</span><span class="quoted">"<span class="keyword1">XMMWORD</span> <span class="keyword1">PTR</span> _"</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">XMMWORD</span></span> <span class="keyword1"><span class="free">PTR</span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">≡</span> <span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">offset</span><span class="main">,</span><span class="bound">base</span><span class="main">,</span><span class="bound">index</span><span class="main">,</span><span class="bound">scale</span><span class="main">)</span> <span class="main">⇒</span> Mem <span class="numeral">16</span> <span class="bound">offset</span> <span class="bound">base</span> <span class="bound">index</span> <span class="bound">scale</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">qword_ptr</span> <span class="main">(</span><span class="quoted">"<span class="keyword1">QWORD</span> <span class="keyword1">PTR</span> _"</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">QWORD</span></span> <span class="keyword1"><span class="free">PTR</span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">≡</span> <span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">offset</span><span class="main">,</span><span class="bound">base</span><span class="main">,</span><span class="bound">index</span><span class="main">,</span><span class="bound">scale</span><span class="main">)</span> <span class="main">⇒</span> Mem <span class="numeral">8</span> <span class="bound">offset</span> <span class="bound">base</span> <span class="bound">index</span> <span class="bound">scale</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">dword_ptr</span> <span class="main">(</span><span class="quoted">"<span class="keyword1">DWORD</span> <span class="keyword1">PTR</span> _"</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">DWORD</span></span> <span class="keyword1"><span class="free">PTR</span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">≡</span> <span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">offset</span><span class="main">,</span><span class="bound">base</span><span class="main">,</span><span class="bound">index</span><span class="main">,</span><span class="bound">scale</span><span class="main">)</span> <span class="main">⇒</span> Mem <span class="numeral">4</span> <span class="bound">offset</span> <span class="bound">base</span> <span class="bound">index</span> <span class="bound">scale</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">word_ptr</span> <span class="main">(</span><span class="quoted">"<span class="keyword1">WORD</span> <span class="keyword1">PTR</span> _"</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">WORD</span></span> <span class="keyword1"><span class="free">PTR</span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">≡</span> <span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">offset</span><span class="main">,</span><span class="bound">base</span><span class="main">,</span><span class="bound">index</span><span class="main">,</span><span class="bound">scale</span><span class="main">)</span> <span class="main">⇒</span> Mem <span class="numeral">2</span> <span class="bound">offset</span> <span class="bound">base</span> <span class="bound">index</span> <span class="bound">scale</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">byte_ptr</span> <span class="main">(</span><span class="quoted">"<span class="keyword1">BYTE</span> <span class="keyword1">PTR</span> _"</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">BYTE</span></span> <span class="keyword1"><span class="free">PTR</span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">≡</span> <span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">offset</span><span class="main">,</span><span class="bound">base</span><span class="main">,</span><span class="bound">index</span><span class="main">,</span><span class="bound">scale</span><span class="main">)</span> <span class="main">⇒</span> Mem <span class="main">1</span> <span class="bound">offset</span> <span class="bound">base</span> <span class="bound">index</span> <span class="bound">scale</span>"</span></span>


<span class="keyword1"><span class="command">primrec</span></span> <span class="main">(</span>nonexhaustive<span class="main">)</span> <span class="entity">operand_size</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"Operand <span class="main">⇒</span> nat"</span></span> <span class="comment1">― ‹in bytes›</span>
  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">operand_size</span> <span class="main">(</span>Reg <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span> reg_size <span class="free"><span class="bound"><span class="entity">r</span></span></span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">operand_size</span> <span class="main">(</span>Mem <span class="free"><span class="bound"><span class="entity">si</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">si</span></span></span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">resolve_address</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"state <span class="main">⇒</span> <span class="numeral">64</span> word <span class="main">⇒</span> char list <span class="main">⇒</span> char list <span class="main">⇒</span> nat <span class="main">⇒</span> <span class="numeral">64</span> word"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">resolve_address</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">offset</span></span></span> <span class="free"><span class="bound"><span class="entity">base</span></span></span> <span class="free"><span class="bound"><span class="entity">index</span></span></span> <span class="free"><span class="bound"><span class="entity">scale</span></span></span> <span class="main">=</span>
      <span class="main">(</span><span class="keyword1">let</span> <span class="bound">i</span> <span class="main">=</span> ucast <span class="main">(</span>reg_read <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">index</span></span></span><span class="main">)</span><span class="main">;</span>
           <span class="bound">b</span> <span class="main">=</span> ucast <span class="main">(</span>reg_read <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">base</span></span></span><span class="main">)</span> <span class="keyword1">in</span>
         <span class="free"><span class="bound"><span class="entity">offset</span></span></span> <span class="main">+</span> <span class="bound">b</span> <span class="main">+</span> of_nat <span class="free"><span class="bound"><span class="entity">scale</span></span></span><span class="main">*</span><span class="bound">i</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">operand_read</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"state <span class="main">⇒</span> Operand <span class="main">⇒</span> <span class="numeral">256</span> word"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">operand_read</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">(</span>Imm <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span>  <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">operand_read</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">(</span>Reg <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span>  <span class="main">=</span> reg_read <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">operand_read</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">(</span>Flag <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span> <span class="main">=</span> flag_read <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">operand_read</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">(</span>Mem <span class="free"><span class="bound"><span class="entity">si</span></span></span> <span class="free"><span class="bound"><span class="entity">offset</span></span></span> <span class="free"><span class="bound"><span class="entity">base</span></span></span> <span class="free"><span class="bound"><span class="entity">index</span></span></span> <span class="free"><span class="bound"><span class="entity">scale</span></span></span><span class="main">)</span> <span class="main">=</span>
      <span class="main">(</span><span class="keyword1">let</span> <span class="bound">a</span> <span class="main">=</span> resolve_address <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">offset</span></span></span> <span class="free"><span class="bound"><span class="entity">base</span></span></span> <span class="free"><span class="bound"><span class="entity">index</span></span></span> <span class="free"><span class="bound"><span class="entity">scale</span></span></span> <span class="keyword1">in</span>
        mem_read <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="bound">a</span> <span class="free"><span class="bound"><span class="entity">si</span></span></span>
      <span class="main">)</span>"</span></span>


<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">state_with_updates</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"state <span class="main">⇒</span> StateUpdate list <span class="main">⇒</span> state"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">with</span>"</span> 66<span class="main">)</span>
  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="keyword1"><span class="free">with</span></span> <span class="main">[]</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="keyword1"><span class="free">with</span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">fs</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> state_update <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="keyword1"><span class="free">with</span></span> <span class="free"><span class="bound"><span class="entity">fs</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="main">(</span>nonexhaustive<span class="main">)</span> <span class="entity">operand_write</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"Operand <span class="main">⇒</span> <span class="numeral">256</span>word <span class="main">⇒</span> state <span class="main">⇒</span> state"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">operand_write</span> <span class="main">(</span>Reg <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span>  <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">=</span> reg_write <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">operand_write</span> <span class="main">(</span>Mem <span class="free"><span class="bound"><span class="entity">si</span></span></span> <span class="free"><span class="bound"><span class="entity">offset</span></span></span> <span class="free"><span class="bound"><span class="entity">base</span></span></span> <span class="free"><span class="bound"><span class="entity">index</span></span></span> <span class="free"><span class="bound"><span class="entity">scale</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">=</span>
      <span class="main">(</span><span class="keyword1">let</span> <span class="bound">i</span> <span class="main">=</span> ucast <span class="main">(</span>reg_read <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">index</span></span></span><span class="main">)</span><span class="main">;</span>
           <span class="bound">b</span> <span class="main">=</span> ucast <span class="main">(</span>reg_read <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">base</span></span></span><span class="main">)</span><span class="main">;</span>
           <span class="bound">a</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">offset</span></span></span> <span class="main">+</span> <span class="bound">b</span> <span class="main">+</span> of_nat <span class="free"><span class="bound"><span class="entity">scale</span></span></span><span class="main">*</span><span class="bound">i</span> <span class="keyword1">in</span>
        <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="keyword1">with</span> <span class="main">[</span><span class="main">⟦</span><span class="bound">a</span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">si</span></span></span><span class="main">⟧</span> <span class="keyword1">:=<span class="hidden">⇩</span><sub>m</sub></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">]</span>
      <span class="main">)</span>"</span></span>





<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹ The following theorems simplify reading from state parts after doing updates to other state parts.›</span></span>

<span class="keyword1" id="State-regs_reg_write"><span class="command">lemma</span></span> regs_reg_write<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"regs <span class="main">(</span><span class="free">σ</span> <span class="keyword1">with</span> <span class="main">(</span><span class="main">(</span><span class="free">r</span> <span class="keyword1">:=<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">w</span><span class="main">)</span><span class="main">#</span><span class="free">updates</span><span class="main">)</span><span class="main">)</span> <span class="free">r'</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">r</span><span class="main">=</span><span class="free">r'</span> <span class="keyword1">then</span> <span class="free">w</span> <span class="keyword1">else</span> regs <span class="main">(</span><span class="free">σ</span> <span class="keyword1">with</span> <span class="free">updates</span><span class="main">)</span> <span class="free">r'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">updates</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">σ</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> case_prod_unfold Let_def<span class="main">)</span>

<span class="keyword1" id="State-regs_mem_write"><span class="command">lemma</span></span> regs_mem_write<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"regs <span class="main">(</span><span class="free">σ</span> <span class="keyword1">with</span> <span class="main">(</span><span class="main">(</span><span class="main">⟦</span><span class="free">a</span><span class="main">,</span><span class="free">si</span><span class="main">⟧</span> <span class="keyword1">:=<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">v</span><span class="main">)</span><span class="main">#</span><span class="free">updates</span><span class="main">)</span><span class="main">)</span> <span class="free">r</span> <span class="main">=</span> regs <span class="main">(</span><span class="free">σ</span> <span class="keyword1">with</span> <span class="free">updates</span><span class="main">)</span> <span class="free">r</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">updates</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">σ</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="State-regs_flag_write"><span class="command">lemma</span></span> regs_flag_write<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"regs <span class="main">(</span><span class="free">σ</span> <span class="keyword1">with</span> <span class="main">(</span><span class="main">(</span><span class="keyword1">setFlags</span> <span class="free">v</span><span class="main">)</span><span class="main">#</span><span class="free">updates</span><span class="main">)</span><span class="main">)</span> <span class="free">r</span> <span class="main">=</span> regs <span class="main">(</span><span class="free">σ</span> <span class="keyword1">with</span> <span class="free">updates</span><span class="main">)</span> <span class="free">r</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">updates</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">σ</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="State-regs_rip_write"><span class="command">lemma</span></span> regs_rip_write<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"regs <span class="main">(</span><span class="free">σ</span> <span class="keyword1">with</span> <span class="main">(</span><span class="main">(</span><span class="keyword1">setRip</span> <span class="free">a</span><span class="main">)</span><span class="main">#</span><span class="free">updates</span><span class="main">)</span><span class="main">)</span> <span class="free">f</span> <span class="main">=</span> regs <span class="main">(</span><span class="free">σ</span> <span class="keyword1">with</span> <span class="free">updates</span><span class="main">)</span> <span class="free">f</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>


<span class="keyword1" id="State-flag_read_reg_write"><span class="command">lemma</span></span> flag_read_reg_write<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"flag_read <span class="main">(</span><span class="free">σ</span> <span class="keyword1">with</span> <span class="main">(</span><span class="main">(</span><span class="free">r</span> <span class="keyword1">:=<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">w</span><span class="main">)</span><span class="main">#</span><span class="free">updates</span><span class="main">)</span><span class="main">)</span> <span class="free">f</span> <span class="main">=</span> flag_read <span class="main">(</span><span class="free">σ</span> <span class="keyword1">with</span> <span class="free">updates</span><span class="main">)</span> <span class="free">f</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">updates</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">σ</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> flag_read_def<span class="main">)</span>

<span class="keyword1" id="State-flag_read_mem_write"><span class="command">lemma</span></span> flag_read_mem_write<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"flag_read <span class="main">(</span><span class="free">σ</span> <span class="keyword1">with</span> <span class="main">(</span><span class="main">(</span><span class="main">⟦</span><span class="free">a</span><span class="main">,</span><span class="free">si</span><span class="main">⟧</span> <span class="keyword1">:=<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">v</span><span class="main">)</span><span class="main">#</span><span class="free">updates</span><span class="main">)</span><span class="main">)</span> <span class="free">f</span> <span class="main">=</span> flag_read <span class="main">(</span><span class="free">σ</span> <span class="keyword1">with</span> <span class="free">updates</span><span class="main">)</span> <span class="free">f</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">updates</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">σ</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> flag_read_def<span class="main">)</span>

<span class="keyword1" id="State-flag_read_flag_write"><span class="command">lemma</span></span> flag_read_flag_write<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"flag_read <span class="main">(</span><span class="free">σ</span> <span class="keyword1">with</span> <span class="main">(</span><span class="main">(</span><span class="keyword1">setFlags</span> <span class="free">v</span><span class="main">)</span><span class="main">#</span><span class="free">updates</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> fromBool <span class="keyword1">o</span> <span class="free">v</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">updates</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">σ</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> flag_read_def<span class="main">)</span>

<span class="keyword1" id="State-flag_read_rip_write"><span class="command">lemma</span></span> flag_read_rip_write<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"flag_read <span class="main">(</span><span class="free">σ</span> <span class="keyword1">with</span> <span class="main">(</span><span class="main">(</span><span class="keyword1">setRip</span> <span class="free">a</span><span class="main">)</span><span class="main">#</span><span class="free">updates</span><span class="main">)</span><span class="main">)</span> <span class="free">f</span> <span class="main">=</span> flag_read <span class="main">(</span><span class="free">σ</span> <span class="keyword1">with</span> <span class="free">updates</span><span class="main">)</span> <span class="free">f</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> flag_read_def<span class="main">)</span>

<span class="keyword1" id="State-mem_read_reg_write"><span class="command">lemma</span></span> mem_read_reg_write<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"mem_read <span class="main">(</span><span class="free">σ</span> <span class="keyword1">with</span> <span class="main">(</span><span class="main">(</span><span class="free">r</span> <span class="keyword1">:=<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">w</span><span class="main">)</span><span class="main">#</span><span class="free">updates</span><span class="main">)</span><span class="main">)</span> <span class="free">a</span> <span class="free">si</span> <span class="main">=</span> mem_read <span class="main">(</span><span class="free">σ</span> <span class="keyword1">with</span> <span class="free">updates</span><span class="main">)</span> <span class="free">a</span> <span class="free">si</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mem_read_def read_bytes_def<span class="main">)</span>

<span class="keyword1" id="State-mem_read_flag_write"><span class="command">lemma</span></span> mem_read_flag_write<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"mem_read <span class="main">(</span><span class="free">σ</span> <span class="keyword1">with</span> <span class="main">(</span><span class="main">(</span><span class="keyword1">setFlags</span> <span class="free">v</span><span class="main">)</span><span class="main">#</span><span class="free">updates</span><span class="main">)</span><span class="main">)</span> <span class="free">a</span> <span class="free">si</span> <span class="main">=</span> mem_read <span class="main">(</span><span class="free">σ</span> <span class="keyword1">with</span> <span class="free">updates</span><span class="main">)</span> <span class="free">a</span> <span class="free">si</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mem_read_def read_bytes_def<span class="main">)</span>

<span class="keyword1" id="State-mem_read_rip_write"><span class="command">lemma</span></span> mem_read_rip_write<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"mem_read <span class="main">(</span><span class="free">σ</span> <span class="keyword1">with</span> <span class="main">(</span><span class="main">(</span><span class="keyword1">setRip</span> <span class="free">a'</span><span class="main">)</span><span class="main">#</span><span class="free">updates</span><span class="main">)</span><span class="main">)</span> <span class="free">a</span> <span class="free">si</span> <span class="main">=</span> mem_read <span class="main">(</span><span class="free">σ</span> <span class="keyword1">with</span> <span class="free">updates</span><span class="main">)</span> <span class="free">a</span> <span class="free">si</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mem_read_def read_bytes_def<span class="main">)</span>

<span class="keyword1" id="State-mem_read_mem_write_alias"><span class="command">lemma</span></span> mem_read_mem_write_alias<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">si'</span> <span class="main">≤</span> <span class="free">si</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">si</span> <span class="main">≤</span> <span class="numeral">2</span><span class="main">^</span><span class="numeral">64</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"mem_read <span class="main">(</span><span class="free">σ</span> <span class="keyword1">with</span> <span class="main">(</span><span class="main">(</span><span class="main">⟦</span><span class="free">a</span><span class="main">,</span><span class="free">si</span><span class="main">⟧</span> <span class="keyword1">:=<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">v</span><span class="main">)</span><span class="main">#</span><span class="free">updates</span><span class="main">)</span><span class="main">)</span> <span class="free">a</span> <span class="free">si'</span> <span class="main">=</span> <span class="main">⟨</span><span class="main">0</span><span class="main">,</span><span class="free">si'</span><span class="main">*</span><span class="numeral">8</span><span class="main">⟩</span> <span class="free">v</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mem_read_def word_rcat_read_bytes read_bytes_override_on_enclosed<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> offset<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="main">0</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> offset'<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="main">0</span></span><span class="main"><span class="main">,</span></span><span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1" id="State-mem_read_mem_write_separate"><span class="command">lemma</span></span> mem_read_mem_write_separate<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"separate <span class="free">a</span> <span class="free">si</span> <span class="free">a'</span> <span class="free">si'</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"mem_read <span class="main">(</span><span class="free">σ</span> <span class="keyword1">with</span> <span class="main">(</span><span class="main">(</span><span class="main">⟦</span><span class="free">a</span><span class="main">,</span><span class="free">si</span><span class="main">⟧</span> <span class="keyword1">:=<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">v</span><span class="main">)</span><span class="main">#</span><span class="free">updates</span><span class="main">)</span><span class="main">)</span> <span class="free">a'</span> <span class="free">si'</span> <span class="main">=</span> mem_read <span class="main">(</span><span class="free">σ</span> <span class="keyword1">with</span> <span class="free">updates</span><span class="main">)</span> <span class="free">a'</span> <span class="free">si'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mem_read_def read_bytes_override_on_separate<span class="main">)</span>

<span class="keyword1" id="State-mem_read_mem_write_enclosed_minus"><span class="command">lemma</span></span> mem_read_mem_write_enclosed_minus<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">offset'</span> <span class="main">≤</span> <span class="free">offset</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">si'</span> <span class="main">≤</span> <span class="free">si</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"unat <span class="main">(</span><span class="free">offset</span> <span class="main">-</span> <span class="free">offset'</span><span class="main">)</span> <span class="main">+</span> <span class="free">si'</span> <span class="main">&lt;</span> <span class="numeral">2</span><span class="main">^</span><span class="numeral">64</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"unat <span class="free">offset</span> <span class="main">+</span> <span class="free">si'</span> <span class="main">≤</span> <span class="free">si</span> <span class="main">+</span> unat <span class="free">offset'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"mem_read <span class="main">(</span><span class="free">σ</span> <span class="keyword1">with</span> <span class="main">(</span><span class="main">(</span><span class="main">⟦</span><span class="free">a</span> <span class="main">-</span> <span class="free">offset</span><span class="main">,</span><span class="free">si</span><span class="main">⟧</span> <span class="keyword1">:=<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">v</span><span class="main">)</span><span class="main">#</span><span class="free">updates</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">a</span> <span class="main">-</span> <span class="free">offset'</span><span class="main">)</span> <span class="free">si'</span> <span class="main">=</span> <span class="main">⟨</span>unat <span class="main">(</span><span class="free">offset</span> <span class="main">-</span> <span class="free">offset'</span><span class="main">)</span> <span class="main">*</span> <span class="numeral">8</span><span class="main">,</span>unat <span class="main">(</span><span class="free">offset</span> <span class="main">-</span> <span class="free">offset'</span><span class="main">)</span> <span class="main">*</span> <span class="numeral">8</span> <span class="main">+</span> <span class="free">si'</span> <span class="main">*</span> <span class="numeral">8</span><span class="main">⟩</span><span class="free">v</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mem_read_def read_bytes_override_on_enclosed word_rcat_read_bytes_enclosed<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">offset</span> <span class="main">-</span> <span class="free">offset'</span>"</span></span> <span class="quoted"><span class="free">si'</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">-</span> <span class="free">offset</span>"</span></span> <span class="quoted"><span class="free">v</span></span><span class="main"><span class="main">,</span></span><span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1" id="State-mem_read_mem_write_enclosed_plus"><span class="command">lemma</span></span> mem_read_mem_write_enclosed_plus<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"unat <span class="free">offset</span> <span class="main">+</span> <span class="free">si'</span> <span class="main">≤</span> <span class="free">si</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">si</span> <span class="main">&lt;</span> <span class="numeral">2</span> <span class="main">^</span> <span class="numeral">64</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"mem_read <span class="main">(</span><span class="free">σ</span> <span class="keyword1">with</span> <span class="main">(</span><span class="main">(</span><span class="main">⟦</span><span class="free">a</span><span class="main">,</span><span class="free">si</span><span class="main">⟧</span> <span class="keyword1">:=<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">v</span><span class="main">)</span><span class="main">#</span><span class="free">updates</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">offset</span> <span class="main">+</span> <span class="free">a</span><span class="main">)</span> <span class="free">si'</span> <span class="main">=</span> <span class="main">⟨</span>unat <span class="free">offset</span> <span class="main">*</span> <span class="numeral">8</span><span class="main">,</span><span class="main">(</span>unat <span class="free">offset</span> <span class="main">+</span> <span class="free">si'</span><span class="main">)</span> <span class="main">*</span> <span class="numeral">8</span><span class="main">⟩</span><span class="free">v</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mem_read_def read_bytes_override_on_enclosed_plus<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> word_rcat_read_bytes_enclosed<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">offset</span></span> <span class="quoted"><span class="free">si'</span></span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="free">v</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> add.commute<span class="main">)</span>

<span class="keyword1" id="State-mem_read_mem_write_enclosed_plus2"><span class="command">lemma</span></span> mem_read_mem_write_enclosed_plus2<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"unat <span class="free">offset</span> <span class="main">+</span> <span class="free">si'</span> <span class="main">≤</span> <span class="free">si</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">si</span> <span class="main">&lt;</span> <span class="numeral">2</span> <span class="main">^</span> <span class="numeral">64</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"mem_read <span class="main">(</span><span class="free">σ</span> <span class="keyword1">with</span> <span class="main">(</span><span class="main">(</span><span class="main">⟦</span><span class="free">a</span><span class="main">,</span><span class="free">si</span><span class="main">⟧</span> <span class="keyword1">:=<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">v</span><span class="main">)</span><span class="main">#</span><span class="free">updates</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">a</span> <span class="main">+</span> <span class="free">offset</span><span class="main">)</span> <span class="free">si'</span> <span class="main">=</span> <span class="main">⟨</span>unat <span class="free">offset</span> <span class="main">*</span> <span class="numeral">8</span><span class="main">,</span><span class="main">(</span>unat <span class="free">offset</span> <span class="main">+</span> <span class="free">si'</span><span class="main">)</span> <span class="main">*</span> <span class="numeral">8</span><span class="main">⟩</span><span class="free">v</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> mem_read_mem_write_enclosed_plus<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> add.commute<span class="main">)</span>

<span class="keyword1" id="State-mem_read_mem_write_enclosed_numeral"><span class="command">lemma</span></span> mem_read_mem_write_enclosed_numeral<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"unat <span class="main">(</span>numeral <span class="free">a'</span> <span class="main">-</span> numeral <span class="free">a</span><span class="main">::</span><span class="numeral">64</span> word<span class="main">)</span> <span class="main">+</span> <span class="main">(</span>numeral <span class="free">si'</span><span class="main">::</span>nat<span class="main">)</span> <span class="main">≤</span> numeral <span class="free">si</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"numeral <span class="free">a'</span> <span class="main">≥</span> <span class="main">(</span>numeral <span class="free">a</span><span class="main">::</span><span class="numeral">64</span> word<span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"numeral <span class="free">si</span> <span class="main">&lt;</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="numeral">64</span><span class="main">::</span>nat<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"mem_read <span class="main">(</span><span class="free">σ</span> <span class="keyword1">with</span> <span class="main">(</span><span class="main">(</span><span class="main">⟦</span>numeral <span class="free">a</span><span class="main">,</span>numeral <span class="free">si</span><span class="main">⟧</span> <span class="keyword1">:=<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">v</span><span class="main">)</span><span class="main">#</span><span class="free">updates</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>numeral <span class="free">a'</span><span class="main">)</span> <span class="main">(</span>numeral <span class="free">si'</span><span class="main">)</span> <span class="main">=</span> <span class="main">⟨</span>unat <span class="main">(</span>numeral <span class="free">a'</span> <span class="main">-</span> <span class="main">(</span>numeral <span class="free">a</span><span class="main">::</span><span class="numeral">64</span> word<span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="numeral">8</span><span class="main">,</span><span class="main">(</span>unat <span class="main">(</span>numeral <span class="free">a'</span> <span class="main">-</span> <span class="main">(</span>numeral <span class="free">a</span><span class="main">::</span><span class="numeral">64</span> word<span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span>numeral <span class="free">si'</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="numeral">8</span><span class="main">⟩</span><span class="free">v</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"numeral <span class="free">a</span> <span class="main">+</span> <span class="main">(</span>numeral <span class="free">a'</span> <span class="main">-</span> numeral <span class="free">a</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>numeral <span class="free">a'</span><span class="main">::</span><span class="numeral">64</span> word<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> add.commute diff_add_cancel<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> mem_read_mem_write_enclosed_plus2<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"numeral <span class="free">a'</span> <span class="main">-</span> numeral <span class="free">a</span>"</span></span> <span class="quoted"><span class="quoted">"numeral <span class="free">si'</span>"</span></span> <span class="quoted"><span class="quoted">"numeral <span class="free">si</span>"</span></span> <span class="quoted"><span class="free">σ</span></span> <span class="quoted"><span class="quoted">"numeral <span class="free">a</span>"</span></span> <span class="quoted"><span class="free">v</span></span> <span class="quoted"><span class="free">updates</span></span><span class="main">,</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>3<span class="main"><span class="main">)</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="State-mem_read_mem_write_enclosed_numeral1_"><span class="command">lemma</span></span> mem_read_mem_write_enclosed_numeral1_<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"unat <span class="main">(</span>numeral <span class="free">a'</span> <span class="main">-</span> numeral <span class="free">a</span><span class="main">::</span><span class="numeral">64</span> word<span class="main">)</span> <span class="main">+</span> <span class="main">(</span>numeral <span class="free">si'</span><span class="main">::</span>nat<span class="main">)</span> <span class="main">≤</span> Suc <span class="main">0</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"numeral <span class="free">a'</span> <span class="main">≥</span> <span class="main">(</span>numeral <span class="free">a</span><span class="main">::</span><span class="numeral">64</span> word<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"mem_read <span class="main">(</span><span class="free">σ</span> <span class="keyword1">with</span> <span class="main">(</span><span class="main">(</span><span class="main">⟦</span>numeral <span class="free">a</span><span class="main">,</span>Suc <span class="main">0</span><span class="main">⟧</span> <span class="keyword1">:=<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">v</span><span class="main">)</span><span class="main">#</span><span class="free">updates</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>numeral <span class="free">a'</span><span class="main">)</span> <span class="main">(</span>numeral <span class="free">si'</span><span class="main">)</span> <span class="main">=</span> <span class="main">⟨</span>unat <span class="main">(</span>numeral <span class="free">a'</span> <span class="main">-</span> <span class="main">(</span>numeral <span class="free">a</span><span class="main">::</span><span class="numeral">64</span> word<span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="numeral">8</span><span class="main">,</span><span class="main">(</span>unat <span class="main">(</span>numeral <span class="free">a'</span> <span class="main">-</span> <span class="main">(</span>numeral <span class="free">a</span><span class="main">::</span><span class="numeral">64</span> word<span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span>numeral <span class="free">si'</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="numeral">8</span><span class="main">⟩</span><span class="free">v</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"numeral <span class="free">a</span> <span class="main">+</span> <span class="main">(</span>numeral <span class="free">a'</span> <span class="main">-</span> numeral <span class="free">a</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>numeral <span class="free">a'</span><span class="main">::</span><span class="numeral">64</span> word<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> add.commute diff_add_cancel<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> mem_read_mem_write_enclosed_plus2<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"numeral <span class="free">a'</span> <span class="main">-</span> numeral <span class="free">a</span>"</span></span> <span class="quoted"><span class="quoted">"numeral <span class="free">si'</span>"</span></span> <span class="quoted"><span class="quoted">"Suc <span class="main">0</span>"</span></span> <span class="quoted"><span class="free">σ</span></span> <span class="quoted"><span class="quoted">"numeral <span class="free">a</span>"</span></span> <span class="quoted"><span class="free">v</span></span> <span class="quoted"><span class="free">updates</span></span><span class="main">,</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="State-mem_read_mem_write_enclosed_numeral_1"><span class="command">lemma</span></span> mem_read_mem_write_enclosed_numeral_1<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"unat <span class="main">(</span>numeral <span class="free">a'</span> <span class="main">-</span> numeral <span class="free">a</span><span class="main">::</span><span class="numeral">64</span> word<span class="main">)</span> <span class="main">+</span> <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span> <span class="main">≤</span> numeral <span class="free">si</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"numeral <span class="free">a'</span> <span class="main">≥</span> <span class="main">(</span>numeral <span class="free">a</span><span class="main">::</span><span class="numeral">64</span> word<span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"numeral <span class="free">si</span> <span class="main">&lt;</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="numeral">64</span><span class="main">::</span>nat<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"mem_read <span class="main">(</span><span class="free">σ</span> <span class="keyword1">with</span> <span class="main">(</span><span class="main">(</span><span class="main">⟦</span>numeral <span class="free">a</span><span class="main">,</span>numeral <span class="free">si</span><span class="main">⟧</span> <span class="keyword1">:=<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">v</span><span class="main">)</span><span class="main">#</span><span class="free">updates</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>numeral <span class="free">a'</span><span class="main">)</span> <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span> <span class="main">=</span> <span class="main">⟨</span>unat <span class="main">(</span>numeral <span class="free">a'</span> <span class="main">-</span> <span class="main">(</span>numeral <span class="free">a</span><span class="main">::</span><span class="numeral">64</span> word<span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="numeral">8</span><span class="main">,</span><span class="main">(</span>unat <span class="main">(</span>numeral <span class="free">a'</span> <span class="main">-</span> <span class="main">(</span>numeral <span class="free">a</span><span class="main">::</span><span class="numeral">64</span> word<span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="numeral">8</span><span class="main">⟩</span><span class="free">v</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"numeral <span class="free">a</span> <span class="main">+</span> <span class="main">(</span>numeral <span class="free">a'</span> <span class="main">-</span> numeral <span class="free">a</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>numeral <span class="free">a'</span><span class="main">::</span><span class="numeral">64</span> word<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> add.commute diff_add_cancel<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> mem_read_mem_write_enclosed_plus2<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"numeral <span class="free">a'</span> <span class="main">-</span> numeral <span class="free">a</span>"</span></span> <span class="quoted"><span class="quoted">"Suc <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"numeral <span class="free">si</span>"</span></span> <span class="quoted"><span class="free">σ</span></span> <span class="quoted"><span class="quoted">"numeral <span class="free">a</span>"</span></span> <span class="quoted"><span class="free">v</span></span> <span class="quoted"><span class="free">updates</span></span><span class="main">,</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>3<span class="main"><span class="main">)</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1" id="State-mem_read_mem_write_enclosed_numeral11"><span class="command">lemma</span></span> mem_read_mem_write_enclosed_numeral11<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"unat <span class="main">(</span>numeral <span class="free">a'</span> <span class="main">-</span> numeral <span class="free">a</span><span class="main">::</span><span class="numeral">64</span> word<span class="main">)</span> <span class="main">+</span> <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span> <span class="main">≤</span> Suc <span class="main">0</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"numeral <span class="free">a'</span> <span class="main">≥</span> <span class="main">(</span>numeral <span class="free">a</span><span class="main">::</span><span class="numeral">64</span> word<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"mem_read <span class="main">(</span><span class="free">σ</span> <span class="keyword1">with</span> <span class="main">(</span><span class="main">(</span><span class="main">⟦</span>numeral <span class="free">a</span><span class="main">,</span>Suc <span class="main">0</span><span class="main">⟧</span> <span class="keyword1">:=<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">v</span><span class="main">)</span><span class="main">#</span><span class="free">updates</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>numeral <span class="free">a'</span><span class="main">)</span> <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span> <span class="main">=</span> <span class="main">⟨</span>unat <span class="main">(</span>numeral <span class="free">a'</span> <span class="main">-</span> <span class="main">(</span>numeral <span class="free">a</span><span class="main">::</span><span class="numeral">64</span> word<span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="numeral">8</span><span class="main">,</span><span class="main">(</span>unat <span class="main">(</span>numeral <span class="free">a'</span> <span class="main">-</span> <span class="main">(</span>numeral <span class="free">a</span><span class="main">::</span><span class="numeral">64</span> word<span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="numeral">8</span><span class="main">⟩</span><span class="free">v</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"numeral <span class="free">a</span> <span class="main">+</span> <span class="main">(</span>numeral <span class="free">a'</span> <span class="main">-</span> numeral <span class="free">a</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>numeral <span class="free">a'</span><span class="main">::</span><span class="numeral">64</span> word<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> add.commute diff_add_cancel<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> mem_read_mem_write_enclosed_plus2<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"numeral <span class="free">a'</span> <span class="main">-</span> numeral <span class="free">a</span>"</span></span> <span class="quoted"><span class="quoted">"Suc <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"Suc <span class="main">0</span>"</span></span> <span class="quoted"><span class="free">σ</span></span> <span class="quoted"><span class="quoted">"numeral <span class="free">a</span>"</span></span> <span class="quoted"><span class="free">v</span></span> <span class="quoted"><span class="free">updates</span></span><span class="main">,</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1" id="State-rip_reg_write"><span class="command">lemma</span></span> rip_reg_write<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"rip <span class="main">(</span><span class="free">σ</span> <span class="keyword1">with</span> <span class="main">(</span><span class="main">(</span><span class="free">r</span> <span class="keyword1">:=<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">v</span><span class="main">)</span><span class="main">#</span><span class="free">updates</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> rip <span class="main">(</span><span class="free">σ</span> <span class="keyword1">with</span> <span class="free">updates</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> case_prod_unfold Let_def<span class="main">)</span>

<span class="keyword1" id="State-rip_flag_write"><span class="command">lemma</span></span> rip_flag_write<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"rip <span class="main">(</span><span class="free">σ</span> <span class="keyword1">with</span> <span class="main">(</span><span class="main">(</span><span class="keyword1">setFlags</span> <span class="free">v</span><span class="main">)</span><span class="main">#</span><span class="free">updates</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> rip <span class="main">(</span><span class="free">σ</span> <span class="keyword1">with</span> <span class="free">updates</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="State-rip_mem_write"><span class="command">lemma</span></span> rip_mem_write<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"rip <span class="main">(</span><span class="free">σ</span> <span class="keyword1">with</span> <span class="main">(</span><span class="main">(</span><span class="main">⟦</span><span class="free">a</span><span class="main">,</span><span class="free">si</span><span class="main">⟧</span> <span class="keyword1">:=<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">v</span><span class="main">)</span><span class="main">#</span><span class="free">updates</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> rip <span class="main">(</span><span class="free">σ</span> <span class="keyword1">with</span> <span class="free">updates</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="State-rip_rip_write"><span class="command">lemma</span></span> rip_rip_write<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
 <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"rip <span class="main">(</span><span class="free">σ</span> <span class="keyword1">with</span> <span class="main">(</span><span class="main">(</span><span class="keyword1">setRip</span> <span class="free">a</span><span class="main">)</span><span class="main">#</span><span class="free">updates</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">a</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>


<span class="keyword1" id="State-with_with"><span class="command">lemma</span></span> with_with<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">σ</span> <span class="keyword1">with</span> <span class="free">updates</span><span class="main">)</span> <span class="keyword1">with</span> <span class="free">updates'</span> <span class="main">=</span> <span class="free">σ</span> <span class="keyword1">with</span> <span class="main">(</span><span class="free">updates'</span> <span class="main">@</span> <span class="free">updates</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">updates'</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">σ</span></span><span class="main"><span class="keyword3">,</span></span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="State-add_state_update_to_list"><span class="command">lemma</span></span> add_state_update_to_list<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"state_update <span class="free">upd</span> <span class="main">(</span><span class="free">σ</span> <span class="keyword1">with</span> <span class="free">updates</span><span class="main">)</span> <span class="main">=</span> <span class="free">σ</span> <span class="keyword1">with</span> <span class="main">(</span><span class="free">upd</span><span class="main">#</span><span class="free">updates</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The updates performed to a state are ordered: memoery, registers, flags, rip.
      This function is basically insertion sort. Moreover, consecutive updates to the same register
      are removed.›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">insert_state_update</span>
  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">insert_state_update</span> <span class="main">(</span><span class="keyword1">setRip</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="main">(</span><span class="keyword1">setRip</span> <span class="free"><span class="bound"><span class="entity">a'</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">updates</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">insert_state_update</span> <span class="main">(</span><span class="keyword1">setRip</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">updates</span></span></span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">insert_state_update</span> <span class="main">(</span><span class="keyword1">setRip</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="main">(</span><span class="keyword1">setFlags</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">updates</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">setFlags</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">#</span> <span class="main">(</span><span class="free">insert_state_update</span> <span class="main">(</span><span class="keyword1">setRip</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">updates</span></span></span><span class="main">)</span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">insert_state_update</span> <span class="main">(</span><span class="keyword1">setRip</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="keyword1">:=<span class="hidden">⇩</span><sub>r</sub></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">updates</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="keyword1">:=<span class="hidden">⇩</span><sub>r</sub></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span> <span class="main">#</span> <span class="main">(</span><span class="free">insert_state_update</span> <span class="main">(</span><span class="keyword1">setRip</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">updates</span></span></span><span class="main">)</span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">insert_state_update</span> <span class="main">(</span><span class="keyword1">setRip</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="main">⟦</span><span class="free"><span class="bound"><span class="entity">a'</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">si</span></span></span><span class="main">⟧</span> <span class="keyword1">:=<span class="hidden">⇩</span><sub>m</sub></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">updates</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">⟦</span><span class="free"><span class="bound"><span class="entity">a'</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">si</span></span></span><span class="main">⟧</span> <span class="keyword1">:=<span class="hidden">⇩</span><sub>m</sub></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span> <span class="main">#</span> <span class="main">(</span><span class="free">insert_state_update</span> <span class="main">(</span><span class="keyword1">setRip</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">updates</span></span></span><span class="main">)</span>"</span></span>

  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">insert_state_update</span> <span class="main">(</span><span class="keyword1">setFlags</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span> <span class="main">(</span><span class="keyword1">setFlags</span> <span class="free"><span class="bound"><span class="entity">v'</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">updates</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">insert_state_update</span> <span class="main">(</span><span class="keyword1">setFlags</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">updates</span></span></span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">insert_state_update</span> <span class="main">(</span><span class="keyword1">setFlags</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="keyword1">:=<span class="hidden">⇩</span><sub>r</sub></span> <span class="free"><span class="bound"><span class="entity">v'</span></span></span><span class="main">)</span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">updates</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="keyword1">:=<span class="hidden">⇩</span><sub>r</sub></span> <span class="free"><span class="bound"><span class="entity">v'</span></span></span><span class="main">)</span> <span class="main">#</span> <span class="free">insert_state_update</span> <span class="main">(</span><span class="keyword1">setFlags</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">updates</span></span></span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">insert_state_update</span> <span class="main">(</span><span class="keyword1">setFlags</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="main">⟦</span><span class="free"><span class="bound"><span class="entity">a'</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">si</span></span></span><span class="main">⟧</span> <span class="keyword1">:=<span class="hidden">⇩</span><sub>m</sub></span> <span class="free"><span class="bound"><span class="entity">v'</span></span></span><span class="main">)</span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">updates</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">⟦</span><span class="free"><span class="bound"><span class="entity">a'</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">si</span></span></span><span class="main">⟧</span> <span class="keyword1">:=<span class="hidden">⇩</span><sub>m</sub></span> <span class="free"><span class="bound"><span class="entity">v'</span></span></span><span class="main">)</span> <span class="main">#</span> <span class="free">insert_state_update</span> <span class="main">(</span><span class="keyword1">setFlags</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">updates</span></span></span>"</span></span>

  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">insert_state_update</span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="keyword1">:=<span class="hidden">⇩</span><sub>r</sub></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">r'</span></span></span> <span class="keyword1">:=<span class="hidden">⇩</span><sub>r</sub></span> <span class="free"><span class="bound"><span class="entity">v'</span></span></span><span class="main">)</span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">updates</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">r'</span></span></span> <span class="keyword1">then</span> <span class="free">insert_state_update</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="keyword1">:=<span class="hidden">⇩</span><sub>r</sub></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">updates</span></span></span> <span class="keyword1">else</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">r'</span></span></span> <span class="keyword1">:=<span class="hidden">⇩</span><sub>r</sub></span> <span class="free"><span class="bound"><span class="entity">v'</span></span></span><span class="main">)</span><span class="main">#</span><span class="free">insert_state_update</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="keyword1">:=<span class="hidden">⇩</span><sub>r</sub></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">updates</span></span></span><span class="main">)</span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">insert_state_update</span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="keyword1">:=<span class="hidden">⇩</span><sub>r</sub></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="main">⟦</span><span class="free"><span class="bound"><span class="entity">a'</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">si</span></span></span><span class="main">⟧</span> <span class="keyword1">:=<span class="hidden">⇩</span><sub>m</sub></span> <span class="free"><span class="bound"><span class="entity">v'</span></span></span><span class="main">)</span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">updates</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">⟦</span><span class="free"><span class="bound"><span class="entity">a'</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">si</span></span></span><span class="main">⟧</span> <span class="keyword1">:=<span class="hidden">⇩</span><sub>m</sub></span> <span class="free"><span class="bound"><span class="entity">v'</span></span></span><span class="main">)</span> <span class="main">#</span> <span class="free">insert_state_update</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="keyword1">:=<span class="hidden">⇩</span><sub>r</sub></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">updates</span></span></span>"</span></span>

  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">insert_state_update</span> <span class="free"><span class="bound"><span class="entity">upd</span></span></span> <span class="free"><span class="bound"><span class="entity">updates</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">upd</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">updates</span></span></span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">clean</span>
  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">clean</span> <span class="main">[]</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">clean</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">upd</span></span></span><span class="main">]</span> <span class="main">=</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">upd</span></span></span><span class="main">]</span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">clean</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">upd</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">upd'</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">updates</span></span></span><span class="main">)</span> <span class="main">=</span>  insert_state_update <span class="free"><span class="bound"><span class="entity">upd</span></span></span> <span class="main">(</span><span class="free">clean</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">upd'</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">updates</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="State-insert_state_update"><span class="command">lemma</span></span> insert_state_update<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">σ</span> <span class="keyword1">with</span> <span class="main">(</span>insert_state_update <span class="free">upd</span> <span class="free">updates</span><span class="main">)</span> <span class="main">=</span> <span class="free">σ</span> <span class="keyword1">with</span> <span class="main">(</span><span class="free">upd</span> <span class="main">#</span> <span class="free">updates</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">updates</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> insert_state_update.induct<span class="main"><span class="keyword3">,</span></span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fun_upd_twist<span class="main">)</span>

<span class="keyword1" id="State-clean_state_updates"><span class="command">lemma</span></span> clean_state_updates<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">σ</span> <span class="keyword1">with</span> <span class="main">(</span>clean <span class="free">updates</span><span class="main">)</span> <span class="main">=</span> <span class="free">σ</span> <span class="keyword1">with</span> <span class="free">updates</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">updates</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> clean.induct<span class="main"><span class="keyword3">,</span></span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> insert_state_update<span class="main">)</span>



<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The set of simplification rules used during symbolic execution.›</span></span>
<span class="keyword1"><span class="command">lemmas</span></span> state_simps <span class="main">=</span>
      qword_ptr_def dword_ptr_def word_ptr_def byte_ptr_def reg_size_def
      reg_write_def real_reg_def reg_read_def

      regs_rip_write regs_mem_write regs_reg_write regs_flag_write
      flag_read_reg_write flag_read_mem_write flag_read_rip_write flag_read_flag_write
      mem_read_reg_write mem_read_flag_write mem_read_rip_write
      mem_read_mem_write_alias mem_read_mem_write_separate
      mem_read_mem_write_enclosed_minus mem_read_mem_write_enclosed_plus mem_read_mem_write_enclosed_plus2

      with_with add_state_update_to_list

<span class="keyword1"><span class="command">declare</span></span> state_with_updates.simps<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main">]</span>
<span class="keyword1"><span class="command">declare</span></span> state_update.simps<span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">del</span></span></span></span><span class="main">]</span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="X86_InstructionSemantics">
<div class="head">
<h1>Theory X86_InstructionSemantics</h1>
</div>
<pre class="source"><span class="comment1">(*  Title:       X86 instruction semantics and basic block symbolic execution
    Authors:     Freek Verbeek, Abhijith Bharadwaj, Joshua Bockenek, Ian Roessle, Timmy Weerwag, Binoy Ravindran
    Year:        2020
    Maintainer:  Freek Verbeek (freek@vt.edu)
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">"Instruction Semantics"</span></span>

<span class="keyword1"><span class="command">theory</span></span> X86_InstructionSemantics
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="#State">State</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹A datatype for storing instructions. Note that we add a special kind of meta-instruction, called
      ExternalFunc. A call to an external function can manually be mapped to a manually supplied state 
      transformation function.›</span></span>
<span class="keyword1"><span class="command">datatype</span></span> I <span class="main">=</span> 
    Instr <span class="quoted">string</span> <span class="quoted"><span class="quoted">"Operand option"</span></span> <span class="quoted"><span class="quoted">"Operand option"</span></span> <span class="quoted"><span class="quoted">"Operand option"</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">64</span> word"</span></span>
  <span class="main">|</span> ExternalFunc <span class="quoted"><span class="quoted">"state <span class="main">⇒</span> state"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹A datatype for the result of floating point comparisons.›</span></span>
<span class="keyword1"><span class="command">datatype</span></span> FP_Order <span class="main">=</span> FP_Unordered <span class="main">|</span> FP_GT <span class="main">|</span> FP_LT <span class="main">|</span> FP_EQ


<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">instr_next</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">≡</span> <span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="keyword1">of</span> <span class="main">(</span>Instr <span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span> <span class="bound">a'</span><span class="main">)</span> <span class="main">⇒</span> <span class="bound">a'</span>"</span></span>

<span class="keyword1"><span class="command">locale</span></span> unknowns <span class="main">=</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">unknown_addsd</span>     <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="numeral">64</span> word <span class="main">⇒</span> <span class="numeral">64</span> word <span class="main">⇒</span> <span class="numeral">64</span> word"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">unknown_subsd</span>     <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="numeral">64</span> word <span class="main">⇒</span> <span class="numeral">64</span> word <span class="main">⇒</span> <span class="numeral">64</span> word"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">unknown_mulsd</span>     <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="numeral">64</span> word <span class="main">⇒</span> <span class="numeral">64</span> word <span class="main">⇒</span> <span class="numeral">64</span> word"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">unknown_divsd</span>     <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="numeral">64</span> word <span class="main">⇒</span> <span class="numeral">64</span> word <span class="main">⇒</span> <span class="numeral">64</span> word"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">unknown_ucomisd</span>   <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="numeral">64</span> word <span class="main">⇒</span> <span class="numeral">64</span> word <span class="main">⇒</span> FP_Order"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">unknown_semantics</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"I <span class="main">⇒</span> state <span class="main">⇒</span> state"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">unknown_flags</span>     <span class="main">::</span> <span class="quoted"><span class="quoted">"string <span class="main">⇒</span> string <span class="main">⇒</span> bool"</span></span> 
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The semantics below are intended to be overapproximative and incomplete.
  This is achieved using locale ``unknowns''.
  Any place where semantics is \emph{not} modelled, it is mapped to a universally quantified uninterpreted function
  from that locale. We do not make use of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> undefined<span class="antiquote"><span class="antiquote">}</span></span></span></span>, since that could be used to prove that the semantics
  of two undefined behaviors are equivalent. 
  For example:
  \begin{itemize}
  \item Only a subset of instructions has semantics. In case of an unknown instruction $i$,
        the function <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">semantics</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> below will result in <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">unknown_semantics</span></span> <span class="free"><span class="free">i</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.
  \item Not all flags have been defined. In case a flag is read whose semantics is not defined below,
        the read will resolve to <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">unknown_flags</span></span> <span class="free"><span class="free">i</span></span> <span class="free"><span class="free">f</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>. Note that if the semantics of an instruction do
        not set flags, an overapproximative semantics such as below imply that the instruction indeed
        does not modify flags. In order words, if we were uncertain we would assign unknown values to flags.
  \item Not all operations have been defined. For example, floating points operations have no executable
        semantics, but are mapped to uninterpreted functions such as <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">unknown_addsd</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.
  \end{itemize}
›</span></span>



<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Moves›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">semantics_MOV</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"Operand <span class="main">⇒</span> Operand <span class="main">⇒</span> state <span class="main">⇒</span> state"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">semantics_MOV</span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="free"><span class="bound"><span class="entity">op2</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">≡</span>
          <span class="keyword1">let</span> <span class="bound">src</span> <span class="main">=</span> operand_read <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">op2</span></span></span> <span class="keyword1">in</span>
             operand_write <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="bound">src</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">MOV</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">MOV</span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="free"><span class="bound"><span class="entity">op2</span></span></span> <span class="main">≡</span> Instr <span class="inner_quoted">''mov''</span> <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">op1</span></span></span><span class="main">)</span> <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">op2</span></span></span><span class="main">)</span> None"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">MOVABS</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">MOVABS</span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="free"><span class="bound"><span class="entity">op2</span></span></span> <span class="main">≡</span> Instr <span class="inner_quoted">''movabs''</span> <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">op1</span></span></span><span class="main">)</span> <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">op2</span></span></span><span class="main">)</span> None"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">MOVAPS</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">MOVAPS</span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="free"><span class="bound"><span class="entity">op2</span></span></span> <span class="main">≡</span> Instr <span class="inner_quoted">''movaps''</span> <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">op1</span></span></span><span class="main">)</span> <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">op2</span></span></span><span class="main">)</span> None"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">MOVZX</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">MOVZX</span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="free"><span class="bound"><span class="entity">op2</span></span></span> <span class="main">≡</span> Instr <span class="inner_quoted">''movzx''</span> <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">op1</span></span></span><span class="main">)</span> <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">op2</span></span></span><span class="main">)</span> None"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">MOVDQU</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">MOVDQU</span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="free"><span class="bound"><span class="entity">op2</span></span></span> <span class="main">≡</span> Instr <span class="inner_quoted">''movdqu''</span> <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">op1</span></span></span><span class="main">)</span> <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">op2</span></span></span><span class="main">)</span> None"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">semantics_MOVD</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"Operand <span class="main">⇒</span> Operand <span class="main">⇒</span> state <span class="main">⇒</span> state"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">semantics_MOVD</span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="free"><span class="bound"><span class="entity">op2</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">≡</span>
          <span class="keyword1">let</span> <span class="bound">src</span> <span class="main">=</span> ucast<span class="main">(</span>operand_read <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">op2</span></span></span><span class="main">)</span><span class="main">::</span><span class="numeral">32</span>word <span class="keyword1">in</span>
             operand_write <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="main">(</span>ucast <span class="bound">src</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">MOVD</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">MOVD</span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="free"><span class="bound"><span class="entity">op2</span></span></span> <span class="main">≡</span> Instr <span class="inner_quoted">''movd''</span> <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">op1</span></span></span><span class="main">)</span> <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">op2</span></span></span><span class="main">)</span> None"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">isXMM</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"Operand <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">isXMM</span> <span class="main">(</span>Reg <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>take <span class="numeral">3</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span> <span class="inner_quoted">''xmm''</span><span class="main">)</span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">isXMM</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> False"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">semantics_MOVSD</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"Operand <span class="main">⇒</span> Operand <span class="main">⇒</span> state <span class="main">⇒</span> state"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">semantics_MOVSD</span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="free"><span class="bound"><span class="entity">op2</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">≡</span>
    <span class="keyword1">if</span> isXMM <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="main">∧</span> isXMM <span class="free"><span class="bound"><span class="entity">op2</span></span></span> <span class="keyword1">then</span>
      <span class="keyword1">let</span> <span class="bound">src</span> <span class="main">=</span> <span class="main">⟨</span><span class="main">0</span><span class="main">,</span><span class="numeral">64</span><span class="main">⟩</span>operand_read <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">op2</span></span></span><span class="main">;</span>
          <span class="bound">dst</span> <span class="main">=</span> <span class="main">⟨</span><span class="numeral">64</span><span class="main">,</span><span class="numeral">128</span><span class="main">⟩</span>operand_read <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="keyword1">in</span>
             operand_write <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="main">(</span>overwrite <span class="main">0</span> <span class="numeral">64</span> <span class="bound">dst</span> <span class="bound">src</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span>
     <span class="keyword1">else</span>
      <span class="keyword1">let</span> <span class="bound">src</span> <span class="main">=</span> <span class="main">⟨</span><span class="main">0</span><span class="main">,</span><span class="numeral">64</span><span class="main">⟩</span>operand_read <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">op2</span></span></span> <span class="keyword1">in</span>
         operand_write <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="bound">src</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">MOVSD</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">MOVSD</span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="free"><span class="bound"><span class="entity">op2</span></span></span> <span class="main">≡</span> Instr <span class="inner_quoted">''movsd''</span> <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">op1</span></span></span><span class="main">)</span> <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">op2</span></span></span><span class="main">)</span> None"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">MOVQ</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">MOVQ</span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="free"><span class="bound"><span class="entity">op2</span></span></span> <span class="main">≡</span> Instr <span class="inner_quoted">''movq''</span> <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">op1</span></span></span><span class="main">)</span> <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">op2</span></span></span><span class="main">)</span> None"</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹ lea/push/pop/call/ret/leave ›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">semantics_LEA</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"Operand <span class="main">⇒</span> Operand <span class="main">⇒</span> state <span class="main">⇒</span> state"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">semantics_LEA</span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="free"><span class="bound"><span class="entity">op2</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">≡</span>
          <span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">op2</span></span></span> <span class="keyword1">of</span> Mem <span class="bound">si</span> <span class="bound">offset</span> <span class="bound">base</span> <span class="bound">index</span> <span class="bound">scale</span> <span class="main">⇒</span>
            operand_write <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="main">(</span>ucast <span class="main">(</span>resolve_address <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="bound">offset</span> <span class="bound">base</span> <span class="bound">index</span> <span class="bound">scale</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">LEA</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">LEA</span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="free"><span class="bound"><span class="entity">op2</span></span></span> <span class="main">≡</span> Instr <span class="inner_quoted">''lea''</span> <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">op1</span></span></span><span class="main">)</span> <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">op2</span></span></span><span class="main">)</span> None"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">semantics_PUSH</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"Operand <span class="main">⇒</span> state <span class="main">⇒</span> state"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">semantics_PUSH</span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">≡</span>
          <span class="keyword1">let</span> <span class="bound">src</span> <span class="main">=</span> operand_read <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span><span class="main">;</span>
              <span class="bound">si</span>  <span class="main">=</span> operand_size <span class="free"><span class="bound"><span class="entity">op1</span></span></span><span class="main">;</span>
              <span class="bound">rsp</span> <span class="main">=</span> ucast <span class="main">(</span>ucast<span class="main">(</span>reg_read <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="inner_quoted">''rsp''</span><span class="main">)</span> <span class="main">-</span> of_nat <span class="bound">si</span> <span class="main">::</span> <span class="numeral">64</span> word<span class="main">)</span> <span class="keyword1">in</span>
             operand_write <span class="main">(</span><span class="keyword1">QWORD</span> <span class="keyword1">PTR</span> <span class="main">[</span><span class="inner_quoted">''rsp''</span><span class="main">]<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="bound">src</span> <span class="main">(</span>operand_write <span class="main">(</span>Reg <span class="inner_quoted">''rsp''</span><span class="main">)</span> <span class="bound">rsp</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">PUSH</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">PUSH</span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="main">≡</span> Instr <span class="inner_quoted">''push''</span> <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">op1</span></span></span><span class="main">)</span> None None"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">semantics_POP</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"Operand <span class="main">⇒</span> state <span class="main">⇒</span> state"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">semantics_POP</span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">≡</span>
          <span class="keyword1">let</span> <span class="bound">si</span>  <span class="main">=</span> operand_size <span class="free"><span class="bound"><span class="entity">op1</span></span></span><span class="main">;</span>
              <span class="bound">src</span> <span class="main">=</span> operand_read <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">(</span><span class="keyword1">QWORD</span> <span class="keyword1">PTR</span> <span class="main">[</span><span class="inner_quoted">''rsp''</span><span class="main">]<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span><span class="main">;</span>
              <span class="bound">rsp</span> <span class="main">=</span> ucast <span class="main">(</span>ucast<span class="main">(</span>reg_read <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="inner_quoted">''rsp''</span><span class="main">)</span> <span class="main">+</span> of_nat <span class="bound">si</span><span class="main">::</span><span class="numeral">64</span> word<span class="main">)</span> <span class="keyword1">in</span>
             operand_write <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="bound">src</span> <span class="main">(</span>operand_write <span class="main">(</span>Reg <span class="inner_quoted">''rsp''</span><span class="main">)</span> <span class="bound">rsp</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">POP</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">POP</span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="main">≡</span> Instr <span class="inner_quoted">''pop''</span> <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">op1</span></span></span><span class="main">)</span> None None"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">semantics_CALL</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"Operand <span class="main">⇒</span> state <span class="main">⇒</span> state"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">semantics_CALL</span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">≡</span>
        <span class="keyword1">let</span> <span class="bound">src</span> <span class="main">=</span> ucast <span class="main">(</span>operand_read <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span><span class="main">)</span> <span class="keyword1">in</span>
           <span class="main">(</span>state_update <span class="main">(</span><span class="keyword1">setRip</span> <span class="bound">src</span><span class="main">)</span> <span class="keyword1">o</span> semantics_PUSH <span class="main">(</span>Reg <span class="inner_quoted">''rip''</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">semantics_RET</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"state <span class="main">⇒</span> state"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">semantics_RET</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">≡</span>
          <span class="keyword1">let</span> <span class="bound">a</span>   <span class="main">=</span> ucast <span class="main">(</span>operand_read <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">(</span><span class="keyword1">QWORD</span> <span class="keyword1">PTR</span> <span class="main">[</span><span class="inner_quoted">''rsp''</span><span class="main">]<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
              <span class="bound">rsp</span> <span class="main">=</span> ucast <span class="main">(</span>reg_read <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="inner_quoted">''rsp''</span><span class="main">)</span> <span class="main">+</span> <span class="numeral">8</span> <span class="main">::</span> <span class="numeral">64</span> word <span class="keyword1">in</span>
             <span class="main">(</span>state_update <span class="main">(</span><span class="keyword1">setRip</span> <span class="bound">a</span><span class="main">)</span> <span class="keyword1">o</span> operand_write <span class="main">(</span>Reg <span class="inner_quoted">''rsp''</span><span class="main">)</span> <span class="main">(</span>ucast <span class="bound">rsp</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">RET</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">RET</span> <span class="main">≡</span> Instr <span class="inner_quoted">''ret''</span> None None None"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">semantics_LEAVE</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"state <span class="main">⇒</span> state"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">semantics_LEAVE</span> <span class="main">≡</span> semantics_POP <span class="main">(</span>Reg <span class="inner_quoted">''rbp''</span><span class="main">)</span> <span class="keyword1">o</span> semantics_MOV <span class="main">(</span>Reg <span class="inner_quoted">''rsp''</span><span class="main">)</span> <span class="main">(</span>Reg <span class="inner_quoted">''rbp''</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">LEAVE</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">LEAVE</span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="main">≡</span> Instr <span class="inner_quoted">''pop''</span> <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">op1</span></span></span><span class="main">)</span> None None"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Generic operators ›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">unop</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">::</span>len word <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">::</span>len word<span class="main">)</span> <span class="main">⇒</span> 
                     <span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>len word  <span class="main">⇒</span> string <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span>
                      Operand <span class="main">⇒</span> state <span class="main">⇒</span> state"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">unop</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">≡</span>
          <span class="keyword1">let</span> <span class="bound">si</span>  <span class="main">=</span> operand_size <span class="free"><span class="bound"><span class="entity">op1</span></span></span><span class="main">;</span>
              <span class="bound">dst</span> <span class="main">=</span> ucast <span class="main">(</span>operand_read <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span><span class="main">)</span><span class="main">::</span><span class="tfree">'a</span><span class="main">::</span>len word <span class="keyword1">in</span>
             operand_write <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="main">(</span>ucast <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">dst</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="keyword1">with</span> <span class="main">[</span><span class="keyword1">setFlags</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="bound">dst</span><span class="main">)</span><span class="main">]</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">binop</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>len word <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">::</span>len word <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">::</span>len word<span class="main">)</span> <span class="main">⇒</span>
                     <span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>len word <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">::</span>len word  <span class="main">⇒</span> string <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span>
                      Operand <span class="main">⇒</span> Operand <span class="main">⇒</span> state <span class="main">⇒</span> state"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">binop</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="free"><span class="bound"><span class="entity">op2</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">≡</span>
          <span class="keyword1">let</span> <span class="bound">dst</span> <span class="main">=</span> ucast <span class="main">(</span>operand_read <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span><span class="main">)</span><span class="main">::</span><span class="tfree">'a</span><span class="main">::</span>len word<span class="main">;</span>
              <span class="bound">src</span> <span class="main">=</span> ucast <span class="main">(</span>operand_read <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">op2</span></span></span><span class="main">)</span><span class="main">::</span><span class="tfree">'a</span><span class="main">::</span>len word <span class="keyword1">in</span>
             operand_write <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="main">(</span>ucast <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">dst</span> <span class="bound">src</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="keyword1">with</span> <span class="main">[</span><span class="keyword1">setFlags</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="bound">dst</span> <span class="bound">src</span><span class="main">)</span><span class="main">]</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">unop_no_flags</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">::</span>len word <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">::</span>len word<span class="main">)</span> <span class="main">⇒</span> Operand <span class="main">⇒</span> state <span class="main">⇒</span> state"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">unop_no_flags</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">≡</span>
          <span class="keyword1">let</span> <span class="bound">dst</span> <span class="main">=</span> ucast <span class="main">(</span>operand_read <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span><span class="main">)</span><span class="main">::</span><span class="tfree">'a</span><span class="main">::</span>len word <span class="keyword1">in</span>
             operand_write <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="main">(</span>ucast <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">dst</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">binop_flags</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>len word <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">::</span>len word  <span class="main">⇒</span> string <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span>
                      Operand <span class="main">⇒</span> Operand <span class="main">⇒</span> state <span class="main">⇒</span> state"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">binop_flags</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="free"><span class="bound"><span class="entity">op2</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">≡</span>
          <span class="keyword1">let</span> <span class="bound">si</span>  <span class="main">=</span> operand_size <span class="free"><span class="bound"><span class="entity">op1</span></span></span><span class="main">;</span>
              <span class="bound">dst</span> <span class="main">=</span> ucast <span class="main">(</span>operand_read <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span><span class="main">)</span><span class="main">::</span><span class="tfree">'a</span><span class="main">::</span>len word<span class="main">;</span>
              <span class="bound">src</span> <span class="main">=</span> ucast <span class="main">(</span>operand_read <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">op2</span></span></span><span class="main">)</span><span class="main">::</span><span class="tfree">'a</span><span class="main">::</span>len word <span class="keyword1">in</span>
            <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="keyword1">with</span> <span class="main">[</span><span class="keyword1">setFlags</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="bound">dst</span> <span class="bound">src</span><span class="main">)</span><span class="main">]</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">binop_no_flags</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>len word <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">::</span>len word <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">::</span>len word<span class="main">)</span> <span class="main">⇒</span>
                      Operand <span class="main">⇒</span> Operand <span class="main">⇒</span> state <span class="main">⇒</span> state"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">binop_no_flags</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="free"><span class="bound"><span class="entity">op2</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">≡</span>
          <span class="keyword1">let</span> <span class="bound">si</span>  <span class="main">=</span> operand_size <span class="free"><span class="bound"><span class="entity">op1</span></span></span><span class="main">;</span>
              <span class="bound">dst</span> <span class="main">=</span> ucast <span class="main">(</span>operand_read <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span><span class="main">)</span><span class="main">::</span><span class="tfree">'a</span><span class="main">::</span>len word<span class="main">;</span>
              <span class="bound">src</span> <span class="main">=</span> ucast <span class="main">(</span>operand_read <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">op2</span></span></span><span class="main">)</span><span class="main">::</span><span class="tfree">'a</span><span class="main">::</span>len word <span class="keyword1">in</span>
            operand_write <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="main">(</span>ucast <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">dst</span> <span class="bound">src</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">binop_XMM</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="numeral">64</span> word <span class="main">⇒</span> <span class="numeral">64</span> word <span class="main">⇒</span> <span class="numeral">64</span> word<span class="main">)</span> <span class="main">⇒</span> Operand <span class="main">⇒</span> Operand <span class="main">⇒</span> state <span class="main">⇒</span> state"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">binop_XMM</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="free"><span class="bound"><span class="entity">op2</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">≡</span>
          <span class="keyword1">let</span> <span class="bound">dst</span> <span class="main">=</span> ucast <span class="main">(</span>operand_read <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span><span class="main">)</span><span class="main">::</span><span class="numeral">64</span>word<span class="main">;</span>
              <span class="bound">src</span> <span class="main">=</span> ucast <span class="main">(</span>operand_read <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">op2</span></span></span><span class="main">)</span><span class="main">::</span><span class="numeral">64</span>word <span class="keyword1">in</span>
            operand_write <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="main">(</span>ucast <span class="main">(</span>overwrite <span class="main">0</span> <span class="numeral">64</span> <span class="bound">dst</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">dst</span> <span class="bound">src</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Arithmetic›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">ADD_flags</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>len word <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">::</span>len word <span class="main">⇒</span> string <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">ADD_flags</span> <span class="free"><span class="bound"><span class="entity">w0</span></span></span> <span class="free"><span class="bound"><span class="entity">w1</span></span></span> <span class="free"><span class="bound"><span class="entity">flag</span></span></span> <span class="main">≡</span> <span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">flag</span></span></span> <span class="keyword1">of</span>
    <span class="inner_quoted">''zf''</span> <span class="main">⇒</span> <span class="free"><span class="bound"><span class="entity">w0</span></span></span> <span class="main">+</span> <span class="free"><span class="bound"><span class="entity">w1</span></span></span> <span class="main">=</span> <span class="main">0</span>
  <span class="main">|</span> <span class="inner_quoted">''cf''</span> <span class="main">⇒</span> unat <span class="free"><span class="bound"><span class="entity">w0</span></span></span> <span class="main">+</span> unat <span class="free"><span class="bound"><span class="entity">w1</span></span></span> <span class="main">≥</span> <span class="numeral">2</span><span class="main">^</span><span class="main">(</span><span class="keyword1">LENGTH</span><span class="main">(</span><span class="tfree">'a</span><span class="main">)</span><span class="main">)</span>
  <span class="main">|</span> <span class="inner_quoted">''of''</span> <span class="main">⇒</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">w0</span></span></span> <span class="keyword1">&lt;s</span> <span class="main">0</span> <span class="main">⟷</span> <span class="free"><span class="bound"><span class="entity">w1</span></span></span> <span class="keyword1">&lt;s</span> <span class="main">0</span><span class="main">)</span> <span class="main">∧</span> <span class="main">¬</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">w0</span></span></span> <span class="keyword1">&lt;s</span> <span class="main">0</span> <span class="main">⟷</span> <span class="free"><span class="bound"><span class="entity">w0</span></span></span><span class="main">+</span><span class="free"><span class="bound"><span class="entity">w1</span></span></span> <span class="keyword1">&lt;s</span> <span class="main">0</span><span class="main">)</span>
  <span class="main">|</span> <span class="inner_quoted">''sf''</span> <span class="main">⇒</span> <span class="free"><span class="bound"><span class="entity">w0</span></span></span> <span class="main">+</span> <span class="free"><span class="bound"><span class="entity">w1</span></span></span> <span class="keyword1">&lt;s</span> <span class="main">0</span>
  <span class="main">|</span> <span class="bound">f</span>      <span class="main">⇒</span> <span class="free">unknown_flags</span> <span class="inner_quoted">''ADD''</span> <span class="bound">f</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">semantics_ADD</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"Operand <span class="main">⇒</span> Operand <span class="main">⇒</span> state <span class="main">⇒</span> state"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">semantics_ADD</span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="main">≡</span> 
           <span class="keyword1">if</span> operand_size <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="main">=</span> <span class="numeral">32</span> <span class="keyword1">then</span> binop <span class="main">(</span><span class="main">(+)</span><span class="main">::</span><span class="numeral">256</span> word <span class="main">⇒</span> <span class="main">_</span> <span class="main">⇒</span> <span class="main">_</span><span class="main">)</span> ADD_flags <span class="free"><span class="bound"><span class="entity">op1</span></span></span>
      <span class="keyword1">else</span> <span class="keyword1">if</span> operand_size <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="main">=</span> <span class="numeral">16</span> <span class="keyword1">then</span> binop <span class="main">(</span><span class="main">(+)</span><span class="main">::</span><span class="numeral">128</span> word <span class="main">⇒</span> <span class="main">_</span> <span class="main">⇒</span> <span class="main">_</span><span class="main">)</span> ADD_flags <span class="free"><span class="bound"><span class="entity">op1</span></span></span>
      <span class="keyword1">else</span> <span class="keyword1">if</span> operand_size <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="main">=</span> <span class="numeral">8</span>  <span class="keyword1">then</span> binop <span class="main">(</span><span class="main">(+)</span><span class="main">::</span><span class="numeral">64</span>  word <span class="main">⇒</span> <span class="main">_</span> <span class="main">⇒</span> <span class="main">_</span><span class="main">)</span> ADD_flags <span class="free"><span class="bound"><span class="entity">op1</span></span></span>
      <span class="keyword1">else</span> <span class="keyword1">if</span> operand_size <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="main">=</span> <span class="numeral">4</span>  <span class="keyword1">then</span> binop <span class="main">(</span><span class="main">(+)</span><span class="main">::</span><span class="numeral">32</span>  word <span class="main">⇒</span> <span class="main">_</span> <span class="main">⇒</span> <span class="main">_</span><span class="main">)</span> ADD_flags <span class="free"><span class="bound"><span class="entity">op1</span></span></span>
      <span class="keyword1">else</span> <span class="keyword1">if</span> operand_size <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="main">=</span> <span class="numeral">2</span>  <span class="keyword1">then</span> binop <span class="main">(</span><span class="main">(+)</span><span class="main">::</span><span class="numeral">16</span>  word <span class="main">⇒</span> <span class="main">_</span> <span class="main">⇒</span> <span class="main">_</span><span class="main">)</span> ADD_flags <span class="free"><span class="bound"><span class="entity">op1</span></span></span>
      <span class="keyword1">else</span> <span class="keyword1">if</span> operand_size <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="main">=</span> <span class="main">1</span>  <span class="keyword1">then</span> binop <span class="main">(</span><span class="main">(+)</span><span class="main">::</span><span class="numeral">8</span>   word <span class="main">⇒</span> <span class="main">_</span> <span class="main">⇒</span> <span class="main">_</span><span class="main">)</span> ADD_flags <span class="free"><span class="bound"><span class="entity">op1</span></span></span>
      <span class="keyword1">else</span> undefined"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">ADD</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">ADD</span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="free"><span class="bound"><span class="entity">op2</span></span></span> <span class="main">≡</span> Instr <span class="inner_quoted">''add''</span> <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">op1</span></span></span><span class="main">)</span> <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">op2</span></span></span><span class="main">)</span> None"</span></span>


<span class="keyword1"><span class="command">definition</span></span> <span class="entity">INC_flags</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="numeral">256</span> word <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>len word <span class="main">⇒</span> string <span class="main">⇒</span> bool<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">INC_flags</span> <span class="free"><span class="bound"><span class="entity">cf</span></span></span> <span class="free"><span class="bound"><span class="entity">w0</span></span></span> <span class="free"><span class="bound"><span class="entity">flag</span></span></span> <span class="main">≡</span> <span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">flag</span></span></span> <span class="keyword1">of</span>
    <span class="inner_quoted">''zf''</span> <span class="main">⇒</span> <span class="free"><span class="bound"><span class="entity">w0</span></span></span> <span class="main">+</span> <span class="main">1</span> <span class="main">=</span> <span class="main">0</span>
  <span class="main">|</span> <span class="inner_quoted">''cf''</span> <span class="main">⇒</span> <span class="free"><span class="bound"><span class="entity">cf</span></span></span> <span class="main">≠</span> <span class="main">0</span>
  <span class="main">|</span> <span class="inner_quoted">''of''</span> <span class="main">⇒</span> <span class="main">0</span> <span class="keyword1">&lt;=s</span> <span class="free"><span class="bound"><span class="entity">w0</span></span></span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">w0</span></span></span><span class="main">+</span><span class="main">1</span> <span class="keyword1">&lt;s</span> <span class="main">0</span>
  <span class="main">|</span> <span class="inner_quoted">''sf''</span> <span class="main">⇒</span> <span class="free"><span class="bound"><span class="entity">w0</span></span></span> <span class="main">+</span> <span class="main">1</span> <span class="keyword1">&lt;s</span> <span class="main">0</span>
  <span class="main">|</span> <span class="bound">f</span>      <span class="main">⇒</span> <span class="free">unknown_flags</span> <span class="inner_quoted">''INC''</span> <span class="bound">f</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">semantics_INC</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"Operand <span class="main">⇒</span> state <span class="main">⇒</span> state"</span></span> 
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">semantics_INC</span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">≡</span> 
    <span class="keyword1">let</span> <span class="bound">cf</span> <span class="main">=</span> flag_read <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="inner_quoted">''cf''</span> <span class="keyword1">in</span>
           <span class="keyword1">if</span> operand_size <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="main">=</span> <span class="numeral">32</span> <span class="keyword1">then</span> unop <span class="main">(</span><span class="main">(+)</span> <span class="main">(</span><span class="main">1</span><span class="main">::</span><span class="numeral">256</span> word<span class="main">)</span><span class="main">)</span> <span class="main">(</span>INC_flags <span class="bound">cf</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span>
      <span class="keyword1">else</span> <span class="keyword1">if</span> operand_size <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="main">=</span> <span class="numeral">16</span> <span class="keyword1">then</span> unop <span class="main">(</span><span class="main">(+)</span> <span class="main">(</span><span class="main">1</span><span class="main">::</span><span class="numeral">128</span> word<span class="main">)</span><span class="main">)</span> <span class="main">(</span>INC_flags <span class="bound">cf</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span>
      <span class="keyword1">else</span> <span class="keyword1">if</span> operand_size <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="main">=</span> <span class="numeral">8</span>  <span class="keyword1">then</span> unop <span class="main">(</span><span class="main">(+)</span> <span class="main">(</span><span class="main">1</span><span class="main">::</span><span class="numeral">64</span>  word<span class="main">)</span><span class="main">)</span> <span class="main">(</span>INC_flags <span class="bound">cf</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span>
      <span class="keyword1">else</span> <span class="keyword1">if</span> operand_size <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="main">=</span> <span class="numeral">4</span>  <span class="keyword1">then</span> unop <span class="main">(</span><span class="main">(+)</span> <span class="main">(</span><span class="main">1</span><span class="main">::</span><span class="numeral">32</span>  word<span class="main">)</span><span class="main">)</span> <span class="main">(</span>INC_flags <span class="bound">cf</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span>
      <span class="keyword1">else</span> <span class="keyword1">if</span> operand_size <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="main">=</span> <span class="numeral">2</span>  <span class="keyword1">then</span> unop <span class="main">(</span><span class="main">(+)</span> <span class="main">(</span><span class="main">1</span><span class="main">::</span><span class="numeral">16</span>  word<span class="main">)</span><span class="main">)</span> <span class="main">(</span>INC_flags <span class="bound">cf</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span>
      <span class="keyword1">else</span> <span class="keyword1">if</span> operand_size <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="main">=</span> <span class="main">1</span>  <span class="keyword1">then</span> unop <span class="main">(</span><span class="main">(+)</span> <span class="main">(</span><span class="main">1</span><span class="main">::</span><span class="numeral">8</span>   word<span class="main">)</span><span class="main">)</span> <span class="main">(</span>INC_flags <span class="bound">cf</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span>
      <span class="keyword1">else</span> undefined"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">INC</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">INC</span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="main">≡</span> Instr <span class="inner_quoted">''inc''</span> <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">op1</span></span></span><span class="main">)</span> None None"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">DEC_flags</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="numeral">256</span> word <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>len word <span class="main">⇒</span> string <span class="main">⇒</span> bool<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">DEC_flags</span> <span class="free"><span class="bound"><span class="entity">cf</span></span></span> <span class="free"><span class="bound"><span class="entity">w0</span></span></span> <span class="free"><span class="bound"><span class="entity">flag</span></span></span> <span class="main">≡</span> <span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">flag</span></span></span> <span class="keyword1">of</span>
    <span class="inner_quoted">''zf''</span> <span class="main">⇒</span> <span class="free"><span class="bound"><span class="entity">w0</span></span></span> <span class="main">=</span> <span class="main">1</span>
  <span class="main">|</span> <span class="inner_quoted">''cf''</span> <span class="main">⇒</span> <span class="free"><span class="bound"><span class="entity">cf</span></span></span> <span class="main">≠</span> <span class="main">0</span>
  <span class="main">|</span> <span class="inner_quoted">''of''</span> <span class="main">⇒</span> <span class="free"><span class="bound"><span class="entity">w0</span></span></span> <span class="keyword1">&lt;s</span> <span class="main">0</span> <span class="main">∧</span> <span class="main">0</span> <span class="keyword1">&lt;=s</span> <span class="free"><span class="bound"><span class="entity">w0</span></span></span> <span class="main">-</span> <span class="main">1</span>
  <span class="main">|</span> <span class="inner_quoted">''sf''</span> <span class="main">⇒</span> <span class="free"><span class="bound"><span class="entity">w0</span></span></span> <span class="main">-</span> <span class="main">1</span> <span class="keyword1">&lt;s</span> <span class="main">0</span>
  <span class="main">|</span> <span class="bound">f</span>      <span class="main">⇒</span> <span class="free">unknown_flags</span> <span class="inner_quoted">''DEC''</span> <span class="bound">f</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">semantics_DEC</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"Operand <span class="main">⇒</span> state <span class="main">⇒</span> state"</span></span> 
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">semantics_DEC</span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">≡</span> 
    <span class="keyword1">let</span> <span class="bound">cf</span> <span class="main">=</span> flag_read <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="inner_quoted">''cf''</span> <span class="keyword1">in</span>
           <span class="keyword1">if</span> operand_size <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="main">=</span> <span class="numeral">32</span> <span class="keyword1">then</span> unop <span class="main">(</span><span class="main">λ</span> <span class="bound">w</span> <span class="main">.</span> <span class="bound">w</span> <span class="main">-</span> <span class="main">1</span><span class="main">::</span><span class="numeral">256</span> word<span class="main">)</span> <span class="main">(</span>DEC_flags <span class="bound">cf</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span>
      <span class="keyword1">else</span> <span class="keyword1">if</span> operand_size <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="main">=</span> <span class="numeral">16</span> <span class="keyword1">then</span> unop <span class="main">(</span><span class="main">λ</span> <span class="bound">w</span> <span class="main">.</span> <span class="bound">w</span> <span class="main">-</span> <span class="main">1</span><span class="main">::</span><span class="numeral">128</span> word<span class="main">)</span> <span class="main">(</span>DEC_flags <span class="bound">cf</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span>
      <span class="keyword1">else</span> <span class="keyword1">if</span> operand_size <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="main">=</span> <span class="numeral">8</span>  <span class="keyword1">then</span> unop <span class="main">(</span><span class="main">λ</span> <span class="bound">w</span> <span class="main">.</span> <span class="bound">w</span> <span class="main">-</span> <span class="main">1</span><span class="main">::</span><span class="numeral">64</span>  word<span class="main">)</span> <span class="main">(</span>DEC_flags <span class="bound">cf</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span>
      <span class="keyword1">else</span> <span class="keyword1">if</span> operand_size <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="main">=</span> <span class="numeral">4</span>  <span class="keyword1">then</span> unop <span class="main">(</span><span class="main">λ</span> <span class="bound">w</span> <span class="main">.</span> <span class="bound">w</span> <span class="main">-</span> <span class="main">1</span><span class="main">::</span><span class="numeral">32</span>  word<span class="main">)</span> <span class="main">(</span>DEC_flags <span class="bound">cf</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span>
      <span class="keyword1">else</span> <span class="keyword1">if</span> operand_size <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="main">=</span> <span class="numeral">2</span>  <span class="keyword1">then</span> unop <span class="main">(</span><span class="main">λ</span> <span class="bound">w</span> <span class="main">.</span> <span class="bound">w</span> <span class="main">-</span> <span class="main">1</span><span class="main">::</span><span class="numeral">16</span>  word<span class="main">)</span> <span class="main">(</span>DEC_flags <span class="bound">cf</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span>
      <span class="keyword1">else</span> <span class="keyword1">if</span> operand_size <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="main">=</span> <span class="main">1</span>  <span class="keyword1">then</span> unop <span class="main">(</span><span class="main">λ</span> <span class="bound">w</span> <span class="main">.</span> <span class="bound">w</span> <span class="main">-</span> <span class="main">1</span><span class="main">::</span><span class="numeral">8</span>   word<span class="main">)</span> <span class="main">(</span>DEC_flags <span class="bound">cf</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span>
      <span class="keyword1">else</span> undefined"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">DEC</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">DEC</span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="main">≡</span> Instr <span class="inner_quoted">''dec''</span> <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">op1</span></span></span><span class="main">)</span> None None"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">NEG_flags</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>len word <span class="main">⇒</span> string <span class="main">⇒</span> bool<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">NEG_flags</span> <span class="free"><span class="bound"><span class="entity">w0</span></span></span> <span class="free"><span class="bound"><span class="entity">flag</span></span></span> <span class="main">≡</span> <span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">flag</span></span></span> <span class="keyword1">of</span>
    <span class="inner_quoted">''zf''</span> <span class="main">⇒</span> <span class="free"><span class="bound"><span class="entity">w0</span></span></span> <span class="main">=</span> <span class="main">0</span>
  <span class="main">|</span> <span class="inner_quoted">''cf''</span> <span class="main">⇒</span> <span class="free"><span class="bound"><span class="entity">w0</span></span></span> <span class="main">≠</span> <span class="main">0</span>
  <span class="main">|</span> <span class="inner_quoted">''sf''</span> <span class="main">⇒</span> <span class="main">-</span> <span class="free"><span class="bound"><span class="entity">w0</span></span></span> <span class="keyword1">&lt;s</span> <span class="main">0</span>
  <span class="main">|</span> <span class="inner_quoted">''of''</span> <span class="main">⇒</span> msb <span class="main">(</span><span class="main">-</span> <span class="free"><span class="bound"><span class="entity">w0</span></span></span><span class="main">)</span> <span class="main">∧</span> msb <span class="free"><span class="bound"><span class="entity">w0</span></span></span>
  <span class="main">|</span> <span class="bound">f</span>      <span class="main">⇒</span> <span class="free">unknown_flags</span> <span class="inner_quoted">''NEG''</span> <span class="bound">f</span>"</span></span>


<span class="keyword1"><span class="command">definition</span></span> <span class="entity">semantics_NEG</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"Operand <span class="main">⇒</span> state <span class="main">⇒</span> state"</span></span> 
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">semantics_NEG</span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">≡</span> 
           <span class="keyword1">if</span> operand_size <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="main">=</span> <span class="numeral">32</span> <span class="keyword1">then</span> unop <span class="main">(</span><span class="main">λ</span> <span class="bound">w0</span> <span class="main">.</span> <span class="main">-</span> <span class="main">(</span><span class="bound">w0</span><span class="main">::</span><span class="numeral">256</span> word<span class="main">)</span><span class="main">)</span> NEG_flags <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span>
      <span class="keyword1">else</span> <span class="keyword1">if</span> operand_size <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="main">=</span> <span class="numeral">16</span> <span class="keyword1">then</span> unop <span class="main">(</span><span class="main">λ</span> <span class="bound">w0</span> <span class="main">.</span> <span class="main">-</span> <span class="main">(</span><span class="bound">w0</span><span class="main">::</span><span class="numeral">128</span> word<span class="main">)</span><span class="main">)</span> NEG_flags <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span>
      <span class="keyword1">else</span> <span class="keyword1">if</span> operand_size <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="main">=</span> <span class="numeral">8</span>  <span class="keyword1">then</span> unop <span class="main">(</span><span class="main">λ</span> <span class="bound">w0</span> <span class="main">.</span> <span class="main">-</span> <span class="main">(</span><span class="bound">w0</span><span class="main">::</span><span class="numeral">64</span>  word<span class="main">)</span><span class="main">)</span> NEG_flags <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span>
      <span class="keyword1">else</span> <span class="keyword1">if</span> operand_size <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="main">=</span> <span class="numeral">4</span>  <span class="keyword1">then</span> unop <span class="main">(</span><span class="main">λ</span> <span class="bound">w0</span> <span class="main">.</span> <span class="main">-</span> <span class="main">(</span><span class="bound">w0</span><span class="main">::</span><span class="numeral">32</span>  word<span class="main">)</span><span class="main">)</span> NEG_flags <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span>
      <span class="keyword1">else</span> <span class="keyword1">if</span> operand_size <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="main">=</span> <span class="numeral">2</span>  <span class="keyword1">then</span> unop <span class="main">(</span><span class="main">λ</span> <span class="bound">w0</span> <span class="main">.</span> <span class="main">-</span> <span class="main">(</span><span class="bound">w0</span><span class="main">::</span><span class="numeral">16</span>  word<span class="main">)</span><span class="main">)</span> NEG_flags <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span>
      <span class="keyword1">else</span> <span class="keyword1">if</span> operand_size <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="main">=</span> <span class="main">1</span>  <span class="keyword1">then</span> unop <span class="main">(</span><span class="main">λ</span> <span class="bound">w0</span> <span class="main">.</span> <span class="main">-</span> <span class="main">(</span><span class="bound">w0</span><span class="main">::</span><span class="numeral">8</span>   word<span class="main">)</span><span class="main">)</span> NEG_flags <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span>
      <span class="keyword1">else</span> undefined"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">NEG</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">NEG</span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="main">≡</span> Instr <span class="inner_quoted">''neg''</span> <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">op1</span></span></span><span class="main">)</span> None None"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">SUB_flags</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>len word <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">::</span>len word <span class="main">⇒</span> string  <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">SUB_flags</span> <span class="free"><span class="bound"><span class="entity">w0</span></span></span> <span class="free"><span class="bound"><span class="entity">w1</span></span></span> <span class="free"><span class="bound"><span class="entity">flag</span></span></span> <span class="main">≡</span> <span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">flag</span></span></span> <span class="keyword1">of</span>
    <span class="inner_quoted">''zf''</span> <span class="main">⇒</span> <span class="free"><span class="bound"><span class="entity">w0</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">w1</span></span></span>
  <span class="main">|</span> <span class="inner_quoted">''cf''</span> <span class="main">⇒</span> <span class="free"><span class="bound"><span class="entity">w0</span></span></span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">w1</span></span></span>
  <span class="main">|</span> <span class="inner_quoted">''sf''</span> <span class="main">⇒</span> <span class="free"><span class="bound"><span class="entity">w0</span></span></span> <span class="main">-</span> <span class="free"><span class="bound"><span class="entity">w1</span></span></span> <span class="keyword1">&lt;s</span> <span class="main">0</span>
  <span class="main">|</span> <span class="inner_quoted">''of''</span> <span class="main">⇒</span> <span class="main">(</span>msb <span class="free"><span class="bound"><span class="entity">w0</span></span></span> <span class="main">≠</span> msb <span class="free"><span class="bound"><span class="entity">w1</span></span></span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span>msb <span class="main">(</span><span class="free"><span class="bound"><span class="entity">w0</span></span></span> <span class="main">-</span> <span class="free"><span class="bound"><span class="entity">w1</span></span></span><span class="main">)</span> <span class="main">=</span> msb <span class="free"><span class="bound"><span class="entity">w1</span></span></span><span class="main">)</span>
  <span class="main">|</span> <span class="bound">f</span>      <span class="main">⇒</span> <span class="free">unknown_flags</span> <span class="inner_quoted">''SUB''</span> <span class="bound">f</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">semantics_SUB</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"Operand <span class="main">⇒</span> Operand <span class="main">⇒</span> state <span class="main">⇒</span> state"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">semantics_SUB</span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="main">≡</span> 
           <span class="keyword1">if</span> operand_size <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="main">=</span> <span class="numeral">32</span> <span class="keyword1">then</span> binop <span class="main">(</span><span class="main">(-)</span><span class="main">::</span><span class="numeral">256</span> word <span class="main">⇒</span> <span class="main">_</span> <span class="main">⇒</span> <span class="main">_</span><span class="main">)</span> SUB_flags <span class="free"><span class="bound"><span class="entity">op1</span></span></span>
      <span class="keyword1">else</span> <span class="keyword1">if</span> operand_size <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="main">=</span> <span class="numeral">16</span> <span class="keyword1">then</span> binop <span class="main">(</span><span class="main">(-)</span><span class="main">::</span><span class="numeral">128</span> word <span class="main">⇒</span> <span class="main">_</span> <span class="main">⇒</span> <span class="main">_</span><span class="main">)</span> SUB_flags <span class="free"><span class="bound"><span class="entity">op1</span></span></span>
      <span class="keyword1">else</span> <span class="keyword1">if</span> operand_size <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="main">=</span> <span class="numeral">8</span>  <span class="keyword1">then</span> binop <span class="main">(</span><span class="main">(-)</span><span class="main">::</span><span class="numeral">64</span>  word <span class="main">⇒</span> <span class="main">_</span> <span class="main">⇒</span> <span class="main">_</span><span class="main">)</span> SUB_flags <span class="free"><span class="bound"><span class="entity">op1</span></span></span>
      <span class="keyword1">else</span> <span class="keyword1">if</span> operand_size <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="main">=</span> <span class="numeral">4</span>  <span class="keyword1">then</span> binop <span class="main">(</span><span class="main">(-)</span><span class="main">::</span><span class="numeral">32</span>  word <span class="main">⇒</span> <span class="main">_</span> <span class="main">⇒</span> <span class="main">_</span><span class="main">)</span> SUB_flags <span class="free"><span class="bound"><span class="entity">op1</span></span></span>
      <span class="keyword1">else</span> <span class="keyword1">if</span> operand_size <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="main">=</span> <span class="numeral">2</span>  <span class="keyword1">then</span> binop <span class="main">(</span><span class="main">(-)</span><span class="main">::</span><span class="numeral">16</span>  word <span class="main">⇒</span> <span class="main">_</span> <span class="main">⇒</span> <span class="main">_</span><span class="main">)</span> SUB_flags <span class="free"><span class="bound"><span class="entity">op1</span></span></span>
      <span class="keyword1">else</span> <span class="keyword1">if</span> operand_size <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="main">=</span> <span class="main">1</span>  <span class="keyword1">then</span> binop <span class="main">(</span><span class="main">(-)</span><span class="main">::</span><span class="numeral">8</span>   word <span class="main">⇒</span> <span class="main">_</span> <span class="main">⇒</span> <span class="main">_</span><span class="main">)</span> SUB_flags <span class="free"><span class="bound"><span class="entity">op1</span></span></span>
      <span class="keyword1">else</span> undefined"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">SUB</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">SUB</span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="free"><span class="bound"><span class="entity">op2</span></span></span> <span class="main">≡</span> Instr <span class="inner_quoted">''sub''</span> <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">op1</span></span></span><span class="main">)</span> <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">op2</span></span></span><span class="main">)</span> None"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">sbb</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'b</span><span class="main">::</span>len word <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">::</span>len word <span class="main">⇒</span> <span class="tfree">'a</span> word <span class="main">⇒</span> <span class="tfree">'a</span> word"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">sbb</span> <span class="free"><span class="bound"><span class="entity">cf</span></span></span> <span class="free"><span class="bound"><span class="entity">dst</span></span></span> <span class="free"><span class="bound"><span class="entity">src</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">dst</span></span></span> <span class="main">-</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">src</span></span></span> <span class="main">+</span> ucast <span class="free"><span class="bound"><span class="entity">cf</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">SBB_flags</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'b</span><span class="main">::</span>len word <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">::</span>len word <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">::</span>len word <span class="main">⇒</span> string  <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">SBB_flags</span> <span class="free"><span class="bound"><span class="entity">cf</span></span></span> <span class="free"><span class="bound"><span class="entity">dst</span></span></span> <span class="free"><span class="bound"><span class="entity">src</span></span></span> <span class="free"><span class="bound"><span class="entity">flag</span></span></span> <span class="main">≡</span> <span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">flag</span></span></span> <span class="keyword1">of</span>
    <span class="inner_quoted">''zf''</span> <span class="main">⇒</span> sbb <span class="free"><span class="bound"><span class="entity">cf</span></span></span> <span class="free"><span class="bound"><span class="entity">dst</span></span></span> <span class="free"><span class="bound"><span class="entity">src</span></span></span> <span class="main">=</span> <span class="main">0</span>
  <span class="main">|</span> <span class="inner_quoted">''cf''</span> <span class="main">⇒</span> <span class="free"><span class="bound"><span class="entity">dst</span></span></span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">src</span></span></span> <span class="main">+</span> ucast <span class="free"><span class="bound"><span class="entity">cf</span></span></span>
  <span class="main">|</span> <span class="inner_quoted">''sf''</span> <span class="main">⇒</span> sbb <span class="free"><span class="bound"><span class="entity">cf</span></span></span> <span class="free"><span class="bound"><span class="entity">dst</span></span></span> <span class="free"><span class="bound"><span class="entity">src</span></span></span> <span class="keyword1">&lt;s</span> <span class="main">0</span>
  <span class="main">|</span> <span class="inner_quoted">''of''</span> <span class="main">⇒</span> <span class="main">(</span>msb <span class="free"><span class="bound"><span class="entity">dst</span></span></span> <span class="main">≠</span> msb <span class="main">(</span><span class="free"><span class="bound"><span class="entity">src</span></span></span> <span class="main">+</span> ucast <span class="free"><span class="bound"><span class="entity">cf</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span>msb <span class="main">(</span>sbb <span class="free"><span class="bound"><span class="entity">cf</span></span></span> <span class="free"><span class="bound"><span class="entity">dst</span></span></span> <span class="free"><span class="bound"><span class="entity">src</span></span></span><span class="main">)</span> <span class="main">=</span> msb <span class="main">(</span><span class="free"><span class="bound"><span class="entity">src</span></span></span> <span class="main">+</span> ucast <span class="free"><span class="bound"><span class="entity">cf</span></span></span><span class="main">)</span><span class="main">)</span>
  <span class="main">|</span> <span class="bound">f</span>      <span class="main">⇒</span> <span class="free">unknown_flags</span> <span class="inner_quoted">''SBB''</span> <span class="bound">f</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">semantics_SBB</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"Operand <span class="main">⇒</span> Operand <span class="main">⇒</span> state <span class="main">⇒</span> state"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">semantics_SBB</span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="free"><span class="bound"><span class="entity">op2</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">≡</span> 
    <span class="keyword1">let</span> <span class="bound">cf</span> <span class="main">=</span> flag_read <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="inner_quoted">''cf''</span> <span class="keyword1">in</span>
           <span class="keyword1">if</span> operand_size <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="main">=</span> <span class="numeral">32</span> <span class="keyword1">then</span> binop <span class="main">(</span>sbb <span class="bound">cf</span><span class="main">::</span><span class="numeral">256</span> word <span class="main">⇒</span> <span class="main">_</span> <span class="main">⇒</span> <span class="main">_</span><span class="main">)</span> <span class="main">(</span>SBB_flags <span class="bound">cf</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="free"><span class="bound"><span class="entity">op2</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span>
      <span class="keyword1">else</span> <span class="keyword1">if</span> operand_size <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="main">=</span> <span class="numeral">16</span> <span class="keyword1">then</span> binop <span class="main">(</span>sbb <span class="bound">cf</span><span class="main">::</span><span class="numeral">128</span> word <span class="main">⇒</span> <span class="main">_</span> <span class="main">⇒</span> <span class="main">_</span><span class="main">)</span> <span class="main">(</span>SBB_flags <span class="bound">cf</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="free"><span class="bound"><span class="entity">op2</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span>
      <span class="keyword1">else</span> <span class="keyword1">if</span> operand_size <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="main">=</span> <span class="numeral">8</span>  <span class="keyword1">then</span> binop <span class="main">(</span>sbb <span class="bound">cf</span><span class="main">::</span><span class="numeral">64</span>  word <span class="main">⇒</span> <span class="main">_</span> <span class="main">⇒</span> <span class="main">_</span><span class="main">)</span> <span class="main">(</span>SBB_flags <span class="bound">cf</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="free"><span class="bound"><span class="entity">op2</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span>
      <span class="keyword1">else</span> <span class="keyword1">if</span> operand_size <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="main">=</span> <span class="numeral">4</span>  <span class="keyword1">then</span> binop <span class="main">(</span>sbb <span class="bound">cf</span><span class="main">::</span><span class="numeral">32</span>  word <span class="main">⇒</span> <span class="main">_</span> <span class="main">⇒</span> <span class="main">_</span><span class="main">)</span> <span class="main">(</span>SBB_flags <span class="bound">cf</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="free"><span class="bound"><span class="entity">op2</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span>
      <span class="keyword1">else</span> <span class="keyword1">if</span> operand_size <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="main">=</span> <span class="numeral">2</span>  <span class="keyword1">then</span> binop <span class="main">(</span>sbb <span class="bound">cf</span><span class="main">::</span><span class="numeral">16</span>  word <span class="main">⇒</span> <span class="main">_</span> <span class="main">⇒</span> <span class="main">_</span><span class="main">)</span> <span class="main">(</span>SBB_flags <span class="bound">cf</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="free"><span class="bound"><span class="entity">op2</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span>
      <span class="keyword1">else</span> <span class="keyword1">if</span> operand_size <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="main">=</span> <span class="main">1</span>  <span class="keyword1">then</span> binop <span class="main">(</span>sbb <span class="bound">cf</span><span class="main">::</span><span class="numeral">8</span>   word <span class="main">⇒</span> <span class="main">_</span> <span class="main">⇒</span> <span class="main">_</span><span class="main">)</span> <span class="main">(</span>SBB_flags <span class="bound">cf</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="free"><span class="bound"><span class="entity">op2</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span>
      <span class="keyword1">else</span> undefined"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">SBB</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">SBB</span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="free"><span class="bound"><span class="entity">op2</span></span></span> <span class="main">≡</span> Instr <span class="inner_quoted">''sbb''</span> <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">op1</span></span></span><span class="main">)</span> <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">op2</span></span></span><span class="main">)</span> None"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">adc</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'b</span><span class="main">::</span>len word <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">::</span>len word <span class="main">⇒</span> <span class="tfree">'a</span> word <span class="main">⇒</span> <span class="tfree">'a</span> word"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">adc</span> <span class="free"><span class="bound"><span class="entity">cf</span></span></span> <span class="free"><span class="bound"><span class="entity">dst</span></span></span> <span class="free"><span class="bound"><span class="entity">src</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">dst</span></span></span> <span class="main">+</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">src</span></span></span> <span class="main">+</span> ucast <span class="free"><span class="bound"><span class="entity">cf</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">ADC_flags</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'b</span><span class="main">::</span>len word <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">::</span>len word <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">::</span>len word <span class="main">⇒</span> string  <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">ADC_flags</span> <span class="free"><span class="bound"><span class="entity">cf</span></span></span> <span class="free"><span class="bound"><span class="entity">dst</span></span></span> <span class="free"><span class="bound"><span class="entity">src</span></span></span> <span class="free"><span class="bound"><span class="entity">flag</span></span></span> <span class="main">≡</span> <span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">flag</span></span></span> <span class="keyword1">of</span>
    <span class="inner_quoted">''zf''</span> <span class="main">⇒</span> adc <span class="free"><span class="bound"><span class="entity">cf</span></span></span> <span class="free"><span class="bound"><span class="entity">dst</span></span></span> <span class="free"><span class="bound"><span class="entity">src</span></span></span> <span class="main">=</span> <span class="main">0</span>
  <span class="main">|</span> <span class="inner_quoted">''cf''</span> <span class="main">⇒</span> unat <span class="free"><span class="bound"><span class="entity">dst</span></span></span> <span class="main">+</span> unat <span class="free"><span class="bound"><span class="entity">src</span></span></span> <span class="main">+</span> unat <span class="free"><span class="bound"><span class="entity">cf</span></span></span> <span class="main">≥</span> <span class="numeral">2</span><span class="main">^</span><span class="main">(</span><span class="keyword1">LENGTH</span><span class="main">(</span><span class="tfree">'a</span><span class="main">)</span><span class="main">)</span>
  <span class="main">|</span> <span class="inner_quoted">''of''</span> <span class="main">⇒</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">dst</span></span></span> <span class="keyword1">&lt;s</span> <span class="main">0</span> <span class="main">⟷</span> <span class="free"><span class="bound"><span class="entity">src</span></span></span> <span class="main">+</span> ucast <span class="free"><span class="bound"><span class="entity">cf</span></span></span> <span class="keyword1">&lt;s</span> <span class="main">0</span><span class="main">)</span> <span class="main">∧</span> <span class="main">¬</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">dst</span></span></span> <span class="keyword1">&lt;s</span> <span class="main">0</span> <span class="main">⟷</span> adc <span class="free"><span class="bound"><span class="entity">cf</span></span></span> <span class="free"><span class="bound"><span class="entity">dst</span></span></span> <span class="free"><span class="bound"><span class="entity">src</span></span></span> <span class="keyword1">&lt;s</span> <span class="main">0</span><span class="main">)</span>
  <span class="main">|</span> <span class="inner_quoted">''sf''</span> <span class="main">⇒</span> adc <span class="free"><span class="bound"><span class="entity">cf</span></span></span> <span class="free"><span class="bound"><span class="entity">dst</span></span></span> <span class="free"><span class="bound"><span class="entity">src</span></span></span> <span class="keyword1">&lt;s</span> <span class="main">0</span>
  <span class="main">|</span> <span class="bound">f</span>      <span class="main">⇒</span> <span class="free">unknown_flags</span> <span class="inner_quoted">''ADC''</span> <span class="bound">f</span>"</span></span>


<span class="keyword1"><span class="command">definition</span></span> <span class="entity">semantics_ADC</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"Operand <span class="main">⇒</span> Operand <span class="main">⇒</span> state <span class="main">⇒</span> state"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">semantics_ADC</span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="free"><span class="bound"><span class="entity">op2</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">≡</span> 
    <span class="keyword1">let</span> <span class="bound">cf</span> <span class="main">=</span> flag_read <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="inner_quoted">''cf''</span> <span class="keyword1">in</span>
           <span class="keyword1">if</span> operand_size <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="main">=</span> <span class="numeral">32</span> <span class="keyword1">then</span> binop <span class="main">(</span>adc <span class="bound">cf</span><span class="main">::</span><span class="numeral">256</span> word <span class="main">⇒</span> <span class="main">_</span> <span class="main">⇒</span> <span class="main">_</span><span class="main">)</span> <span class="main">(</span>ADC_flags <span class="bound">cf</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="free"><span class="bound"><span class="entity">op2</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span>
      <span class="keyword1">else</span> <span class="keyword1">if</span> operand_size <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="main">=</span> <span class="numeral">16</span> <span class="keyword1">then</span> binop <span class="main">(</span>adc <span class="bound">cf</span><span class="main">::</span><span class="numeral">128</span> word <span class="main">⇒</span> <span class="main">_</span> <span class="main">⇒</span> <span class="main">_</span><span class="main">)</span> <span class="main">(</span>ADC_flags <span class="bound">cf</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="free"><span class="bound"><span class="entity">op2</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span>
      <span class="keyword1">else</span> <span class="keyword1">if</span> operand_size <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="main">=</span> <span class="numeral">8</span>  <span class="keyword1">then</span> binop <span class="main">(</span>adc <span class="bound">cf</span><span class="main">::</span><span class="numeral">64</span>  word <span class="main">⇒</span> <span class="main">_</span> <span class="main">⇒</span> <span class="main">_</span><span class="main">)</span> <span class="main">(</span>ADC_flags <span class="bound">cf</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="free"><span class="bound"><span class="entity">op2</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span>
      <span class="keyword1">else</span> <span class="keyword1">if</span> operand_size <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="main">=</span> <span class="numeral">4</span>  <span class="keyword1">then</span> binop <span class="main">(</span>adc <span class="bound">cf</span><span class="main">::</span><span class="numeral">32</span>  word <span class="main">⇒</span> <span class="main">_</span> <span class="main">⇒</span> <span class="main">_</span><span class="main">)</span> <span class="main">(</span>ADC_flags <span class="bound">cf</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="free"><span class="bound"><span class="entity">op2</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span>
      <span class="keyword1">else</span> <span class="keyword1">if</span> operand_size <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="main">=</span> <span class="numeral">2</span>  <span class="keyword1">then</span> binop <span class="main">(</span>adc <span class="bound">cf</span><span class="main">::</span><span class="numeral">16</span>  word <span class="main">⇒</span> <span class="main">_</span> <span class="main">⇒</span> <span class="main">_</span><span class="main">)</span> <span class="main">(</span>ADC_flags <span class="bound">cf</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="free"><span class="bound"><span class="entity">op2</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span>
      <span class="keyword1">else</span> <span class="keyword1">if</span> operand_size <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="main">=</span> <span class="main">1</span>  <span class="keyword1">then</span> binop <span class="main">(</span>adc <span class="bound">cf</span><span class="main">::</span><span class="numeral">8</span>   word <span class="main">⇒</span> <span class="main">_</span> <span class="main">⇒</span> <span class="main">_</span><span class="main">)</span> <span class="main">(</span>ADC_flags <span class="bound">cf</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="free"><span class="bound"><span class="entity">op2</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span>
      <span class="keyword1">else</span> undefined"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">ADC</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">ADC</span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="free"><span class="bound"><span class="entity">op2</span></span></span> <span class="main">≡</span> Instr <span class="inner_quoted">''adc''</span> <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">op1</span></span></span><span class="main">)</span> <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">op2</span></span></span><span class="main">)</span> None"</span></span>


<span class="keyword1"><span class="command">definition</span></span> <span class="entity">write_MUL_result</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"string <span class="main">⇒</span> string <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">::</span>len word <span class="main">⇒</span> <span class="main">_</span> <span class="main">⇒</span> state <span class="main">⇒</span> state"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">write_MUL_result</span> <span class="free"><span class="bound"><span class="entity">rh</span></span></span> <span class="free"><span class="bound"><span class="entity">rl</span></span></span> <span class="free"><span class="bound"><span class="entity">result</span></span></span> <span class="free"><span class="bound"><span class="entity">flgs</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">≡</span> 
        <span class="keyword1">let</span> <span class="bound">si</span> <span class="main">=</span> <span class="keyword1">LENGTH</span><span class="main">(</span><span class="tfree">'a</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span> <span class="keyword1">in</span>
          operand_write <span class="main">(</span>Reg <span class="free"><span class="bound"><span class="entity">rh</span></span></span><span class="main">)</span> <span class="main">(</span>ucast <span class="main">(</span><span class="main">⟨</span><span class="bound">si</span><span class="main">,</span><span class="numeral">2</span><span class="main">*</span><span class="bound">si</span><span class="main">⟩</span><span class="free"><span class="bound"><span class="entity">result</span></span></span><span class="main">)</span><span class="main">)</span>
            <span class="main">(</span>operand_write <span class="main">(</span>Reg <span class="free"><span class="bound"><span class="entity">rl</span></span></span><span class="main">)</span> <span class="main">(</span>ucast <span class="main">(</span><span class="main">⟨</span><span class="main">0</span><span class="main">,</span><span class="bound">si</span><span class="main">⟩</span><span class="free"><span class="bound"><span class="entity">result</span></span></span><span class="main">)</span><span class="main">)</span>
              <span class="main">(</span><span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="keyword1">with</span> <span class="main">[</span><span class="keyword1">setFlags</span> <span class="free"><span class="bound"><span class="entity">flgs</span></span></span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">MUL_flags</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>len word <span class="main">⇒</span> string <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">MUL_flags</span> <span class="free"><span class="bound"><span class="entity">result</span></span></span> <span class="free"><span class="bound"><span class="entity">flag</span></span></span> <span class="main">≡</span> <span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">flag</span></span></span> <span class="keyword1">of</span>
        <span class="inner_quoted">''cf''</span> <span class="main">⇒</span> <span class="main">(</span><span class="main">⟨</span><span class="keyword1">LENGTH</span><span class="main">(</span><span class="tfree">'a</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">,</span><span class="keyword1">LENGTH</span><span class="main">(</span><span class="tfree">'a</span><span class="main">)</span><span class="main">⟩</span><span class="free"><span class="bound"><span class="entity">result</span></span></span><span class="main">)</span> <span class="main">≠</span> <span class="main">0</span>
      <span class="main">|</span> <span class="inner_quoted">''of''</span> <span class="main">⇒</span> <span class="main">(</span><span class="main">⟨</span><span class="keyword1">LENGTH</span><span class="main">(</span><span class="tfree">'a</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">,</span><span class="keyword1">LENGTH</span><span class="main">(</span><span class="tfree">'a</span><span class="main">)</span><span class="main">⟩</span><span class="free"><span class="bound"><span class="entity">result</span></span></span><span class="main">)</span> <span class="main">≠</span> <span class="main">0</span>
      <span class="main">|</span> <span class="bound">f</span>      <span class="main">⇒</span> <span class="free">unknown_flags</span> <span class="inner_quoted">''MUL''</span> <span class="bound">f</span>"</span></span>


<span class="keyword1"><span class="command">definition</span></span> <span class="entity">IMUL_flags</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>len word <span class="main">⇒</span> string <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">IMUL_flags</span> <span class="free"><span class="bound"><span class="entity">result</span></span></span> <span class="free"><span class="bound"><span class="entity">flag</span></span></span> <span class="main">≡</span> <span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">flag</span></span></span> <span class="keyword1">of</span>
        <span class="inner_quoted">''cf''</span> <span class="main">⇒</span> <span class="main">(</span><span class="main">⟨</span><span class="keyword1">LENGTH</span><span class="main">(</span><span class="tfree">'a</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">,</span><span class="keyword1">LENGTH</span><span class="main">(</span><span class="tfree">'a</span><span class="main">)</span><span class="main">⟩</span><span class="free"><span class="bound"><span class="entity">result</span></span></span><span class="main">)</span> <span class="main">≠</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">result</span></span></span> <span class="main">!!</span> <span class="main">(</span><span class="keyword1">LENGTH</span><span class="main">(</span><span class="tfree">'a</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">then</span> <span class="numeral">2</span><span class="main">^</span><span class="main">(</span><span class="keyword1">LENGTH</span><span class="main">(</span><span class="tfree">'a</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span><span class="main">-</span><span class="main">1</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span>
      <span class="main">|</span> <span class="inner_quoted">''of''</span> <span class="main">⇒</span> <span class="main">(</span><span class="main">⟨</span><span class="keyword1">LENGTH</span><span class="main">(</span><span class="tfree">'a</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">,</span><span class="keyword1">LENGTH</span><span class="main">(</span><span class="tfree">'a</span><span class="main">)</span><span class="main">⟩</span><span class="free"><span class="bound"><span class="entity">result</span></span></span><span class="main">)</span> <span class="main">≠</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">result</span></span></span> <span class="main">!!</span> <span class="main">(</span><span class="keyword1">LENGTH</span><span class="main">(</span><span class="tfree">'a</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">then</span> <span class="numeral">2</span><span class="main">^</span><span class="main">(</span><span class="keyword1">LENGTH</span><span class="main">(</span><span class="tfree">'a</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span><span class="main">-</span><span class="main">1</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span>
      <span class="main">|</span> <span class="bound">f</span>      <span class="main">⇒</span> <span class="free">unknown_flags</span> <span class="inner_quoted">''IMUL''</span> <span class="bound">f</span>"</span></span>


<span class="comment1">(*
  Assumes LENGTH('a) is twice the size of the operands, e.g.:
    unop_MUL TYPE(16) True ''al'' (Reg ''r15b'') σ
*)</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">unop_MUL</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>len itself <span class="main">⇒</span> bool <span class="main">⇒</span> string <span class="main">⇒</span> Operand <span class="main">⇒</span> state <span class="main">⇒</span> state"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">unop_MUL</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">signd</span></span></span> <span class="free"><span class="bound"><span class="entity">op1_reg</span></span></span> <span class="free"><span class="bound"><span class="entity">op2</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">≡</span>
          <span class="keyword1">let</span> <span class="bound">cast</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">signd</span></span></span> <span class="keyword1">then</span> scast <span class="keyword1">else</span> ucast<span class="main">)</span><span class="main">;</span>
              <span class="bound">dst</span>  <span class="main">=</span> <span class="bound">cast</span> <span class="main">(</span>operand_read <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">(</span>Reg <span class="free"><span class="bound"><span class="entity">op1_reg</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">::</span><span class="tfree">'a</span><span class="main">::</span>len word<span class="main">;</span>
              <span class="bound">src</span>  <span class="main">=</span> <span class="bound">cast</span> <span class="main">(</span>operand_read <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">op2</span></span></span><span class="main">)</span><span class="main">::</span><span class="tfree">'a</span><span class="main">::</span>len word<span class="main">;</span>
              <span class="bound">prod</span> <span class="main">=</span> <span class="bound">dst</span> <span class="main">*</span> <span class="bound">src</span><span class="main">;</span>
              <span class="bound">flgs</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">signd</span></span></span> <span class="keyword1">then</span> IMUL_flags <span class="keyword1">else</span> MUL_flags<span class="main">)</span> <span class="bound">prod</span> <span class="keyword1">in</span>
            <span class="keyword1">if</span> <span class="keyword1">LENGTH</span><span class="main">(</span><span class="tfree">'a</span><span class="main">)</span> <span class="main">=</span> <span class="numeral">16</span> <span class="keyword1">then</span>
              write_MUL_result <span class="inner_quoted">''ah''</span> <span class="free"><span class="bound"><span class="entity">op1_reg</span></span></span> <span class="bound">prod</span> <span class="bound">flgs</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span>
            <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="keyword1">LENGTH</span><span class="main">(</span><span class="tfree">'a</span><span class="main">)</span> <span class="main">=</span> <span class="numeral">32</span> <span class="keyword1">then</span>
              write_MUL_result <span class="inner_quoted">''dx''</span> <span class="free"><span class="bound"><span class="entity">op1_reg</span></span></span> <span class="bound">prod</span> <span class="bound">flgs</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span>
            <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="keyword1">LENGTH</span><span class="main">(</span><span class="tfree">'a</span><span class="main">)</span> <span class="main">=</span> <span class="numeral">64</span> <span class="keyword1">then</span>
              write_MUL_result <span class="inner_quoted">''edx''</span> <span class="free"><span class="bound"><span class="entity">op1_reg</span></span></span>  <span class="bound">prod</span> <span class="bound">flgs</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span>
            <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="keyword1">LENGTH</span><span class="main">(</span><span class="tfree">'a</span><span class="main">)</span> <span class="main">=</span> <span class="numeral">128</span> <span class="keyword1">then</span>
              write_MUL_result <span class="inner_quoted">''rdx''</span> <span class="free"><span class="bound"><span class="entity">op1_reg</span></span></span> <span class="bound">prod</span> <span class="bound">flgs</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span>
            <span class="keyword1">else</span>
              undefined"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">semantics_MUL</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"Operand <span class="main">⇒</span> state <span class="main">⇒</span> state"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">semantics_MUL</span> <span class="free"><span class="bound"><span class="entity">op2</span></span></span> <span class="main">≡</span> 
           <span class="keyword1">if</span> operand_size <span class="free"><span class="bound"><span class="entity">op2</span></span></span> <span class="main">=</span> <span class="numeral">8</span> <span class="keyword1">then</span> unop_MUL <span class="keyword1">TYPE</span><span class="main">(</span><span class="numeral">128</span><span class="main">)</span> False <span class="inner_quoted">''rax''</span> <span class="free"><span class="bound"><span class="entity">op2</span></span></span>
      <span class="keyword1">else</span> <span class="keyword1">if</span> operand_size <span class="free"><span class="bound"><span class="entity">op2</span></span></span> <span class="main">=</span> <span class="numeral">4</span> <span class="keyword1">then</span> unop_MUL <span class="keyword1">TYPE</span><span class="main">(</span><span class="numeral">64</span><span class="main">)</span>  False <span class="inner_quoted">''eax''</span> <span class="free"><span class="bound"><span class="entity">op2</span></span></span>
      <span class="keyword1">else</span> <span class="keyword1">if</span> operand_size <span class="free"><span class="bound"><span class="entity">op2</span></span></span> <span class="main">=</span> <span class="numeral">2</span> <span class="keyword1">then</span> unop_MUL <span class="keyword1">TYPE</span><span class="main">(</span><span class="numeral">32</span><span class="main">)</span>  False <span class="inner_quoted">''ax''</span>  <span class="free"><span class="bound"><span class="entity">op2</span></span></span>
      <span class="keyword1">else</span> <span class="keyword1">if</span> operand_size <span class="free"><span class="bound"><span class="entity">op2</span></span></span> <span class="main">=</span> <span class="main">1</span> <span class="keyword1">then</span> unop_MUL <span class="keyword1">TYPE</span><span class="main">(</span><span class="numeral">16</span><span class="main">)</span>  False <span class="inner_quoted">''al''</span>  <span class="free"><span class="bound"><span class="entity">op2</span></span></span>
      <span class="keyword1">else</span> undefined"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">MUL</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">MUL</span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="main">≡</span> Instr <span class="inner_quoted">''mul''</span> <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">op1</span></span></span><span class="main">)</span> None None"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">semantics_IMUL1</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"Operand <span class="main">⇒</span> state <span class="main">⇒</span> state"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">semantics_IMUL1</span> <span class="free"><span class="bound"><span class="entity">op2</span></span></span> <span class="main">≡</span> 
           <span class="keyword1">if</span> operand_size <span class="free"><span class="bound"><span class="entity">op2</span></span></span> <span class="main">=</span> <span class="numeral">8</span> <span class="keyword1">then</span> unop_MUL <span class="keyword1">TYPE</span><span class="main">(</span><span class="numeral">128</span><span class="main">)</span> True <span class="inner_quoted">''rax''</span> <span class="free"><span class="bound"><span class="entity">op2</span></span></span>
      <span class="keyword1">else</span> <span class="keyword1">if</span> operand_size <span class="free"><span class="bound"><span class="entity">op2</span></span></span> <span class="main">=</span> <span class="numeral">4</span> <span class="keyword1">then</span> unop_MUL <span class="keyword1">TYPE</span><span class="main">(</span><span class="numeral">64</span><span class="main">)</span>  True <span class="inner_quoted">''eax''</span> <span class="free"><span class="bound"><span class="entity">op2</span></span></span>
      <span class="keyword1">else</span> <span class="keyword1">if</span> operand_size <span class="free"><span class="bound"><span class="entity">op2</span></span></span> <span class="main">=</span> <span class="numeral">2</span> <span class="keyword1">then</span> unop_MUL <span class="keyword1">TYPE</span><span class="main">(</span><span class="numeral">32</span><span class="main">)</span>  True <span class="inner_quoted">''ax''</span>  <span class="free"><span class="bound"><span class="entity">op2</span></span></span>
      <span class="keyword1">else</span> <span class="keyword1">if</span> operand_size <span class="free"><span class="bound"><span class="entity">op2</span></span></span> <span class="main">=</span> <span class="main">1</span> <span class="keyword1">then</span> unop_MUL <span class="keyword1">TYPE</span><span class="main">(</span><span class="numeral">16</span><span class="main">)</span>  True <span class="inner_quoted">''al''</span>  <span class="free"><span class="bound"><span class="entity">op2</span></span></span>
      <span class="keyword1">else</span> undefined"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">IMUL1</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">IMUL1</span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="main">≡</span> Instr <span class="inner_quoted">''imul''</span> <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">op1</span></span></span><span class="main">)</span> None None"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">ternop_IMUL</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>len itself <span class="main">⇒</span> Operand <span class="main">⇒</span> Operand <span class="main">⇒</span> Operand <span class="main">⇒</span> state <span class="main">⇒</span> state"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">ternop_IMUL</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="free"><span class="bound"><span class="entity">op2</span></span></span> <span class="free"><span class="bound"><span class="entity">op3</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">≡</span>
          <span class="keyword1">let</span> <span class="bound">src1</span> <span class="main">=</span> scast <span class="main">(</span>operand_read <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">op2</span></span></span><span class="main">)</span><span class="main">::</span><span class="tfree">'a</span><span class="main">::</span>len word<span class="main">;</span>
              <span class="bound">src2</span> <span class="main">=</span> scast <span class="main">(</span>operand_read <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">op3</span></span></span><span class="main">)</span><span class="main">::</span><span class="tfree">'a</span><span class="main">::</span>len word<span class="main">;</span>
              <span class="bound">prod</span> <span class="main">=</span> <span class="bound">src1</span> <span class="main">*</span> <span class="bound">src2</span><span class="main">;</span>
              <span class="bound">flgs</span> <span class="main">=</span> IMUL_flags <span class="bound">prod</span> <span class="keyword1">in</span>
            <span class="main">(</span>operand_write <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="main">(</span>ucast <span class="main">(</span><span class="main">⟨</span><span class="main">0</span><span class="main">,</span><span class="keyword1">LENGTH</span><span class="main">(</span><span class="tfree">'a</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">⟩</span><span class="bound">prod</span><span class="main">)</span><span class="main">)</span>
                <span class="main">(</span><span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="keyword1">with</span> <span class="main">[</span><span class="keyword1">setFlags</span> <span class="bound">flgs</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">semantics_IMUL2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"Operand <span class="main">⇒</span> Operand <span class="main">⇒</span> state <span class="main">⇒</span> state"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">semantics_IMUL2</span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="free"><span class="bound"><span class="entity">op2</span></span></span> <span class="main">≡</span> 
           <span class="keyword1">if</span> operand_size <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="main">=</span> <span class="numeral">8</span> <span class="keyword1">then</span> ternop_IMUL <span class="keyword1">TYPE</span><span class="main">(</span><span class="numeral">128</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="free"><span class="bound"><span class="entity">op2</span></span></span>
      <span class="keyword1">else</span> <span class="keyword1">if</span> operand_size <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="main">=</span> <span class="numeral">4</span> <span class="keyword1">then</span> ternop_IMUL <span class="keyword1">TYPE</span><span class="main">(</span><span class="numeral">64</span><span class="main">)</span>  <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="free"><span class="bound"><span class="entity">op2</span></span></span>
      <span class="keyword1">else</span> <span class="keyword1">if</span> operand_size <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="main">=</span> <span class="numeral">2</span> <span class="keyword1">then</span> ternop_IMUL <span class="keyword1">TYPE</span><span class="main">(</span><span class="numeral">32</span><span class="main">)</span>  <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="free"><span class="bound"><span class="entity">op2</span></span></span>
      <span class="keyword1">else</span> <span class="keyword1">if</span> operand_size <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="main">=</span> <span class="main">1</span> <span class="keyword1">then</span> ternop_IMUL <span class="keyword1">TYPE</span><span class="main">(</span><span class="numeral">16</span><span class="main">)</span>  <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="free"><span class="bound"><span class="entity">op2</span></span></span>
      <span class="keyword1">else</span> undefined"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">IMUL2</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">IMUL2</span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="free"><span class="bound"><span class="entity">op2</span></span></span> <span class="main">≡</span> Instr <span class="inner_quoted">''imul''</span> <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">op1</span></span></span><span class="main">)</span> <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">op2</span></span></span><span class="main">)</span> None"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">semantics_IMUL3</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"Operand <span class="main">⇒</span> Operand <span class="main">⇒</span> Operand <span class="main">⇒</span> state <span class="main">⇒</span> state"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">semantics_IMUL3</span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="free"><span class="bound"><span class="entity">op2</span></span></span> <span class="free"><span class="bound"><span class="entity">op3</span></span></span> <span class="main">≡</span> 
           <span class="keyword1">if</span> operand_size <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="main">=</span> <span class="numeral">8</span> <span class="keyword1">then</span> ternop_IMUL <span class="keyword1">TYPE</span><span class="main">(</span><span class="numeral">128</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="free"><span class="bound"><span class="entity">op2</span></span></span> <span class="free"><span class="bound"><span class="entity">op3</span></span></span>
      <span class="keyword1">else</span> <span class="keyword1">if</span> operand_size <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="main">=</span> <span class="numeral">4</span> <span class="keyword1">then</span> ternop_IMUL <span class="keyword1">TYPE</span><span class="main">(</span><span class="numeral">64</span><span class="main">)</span>  <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="free"><span class="bound"><span class="entity">op2</span></span></span> <span class="free"><span class="bound"><span class="entity">op3</span></span></span>
      <span class="keyword1">else</span> <span class="keyword1">if</span> operand_size <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="main">=</span> <span class="numeral">2</span> <span class="keyword1">then</span> ternop_IMUL <span class="keyword1">TYPE</span><span class="main">(</span><span class="numeral">32</span><span class="main">)</span>  <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="free"><span class="bound"><span class="entity">op2</span></span></span> <span class="free"><span class="bound"><span class="entity">op3</span></span></span>
      <span class="keyword1">else</span> <span class="keyword1">if</span> operand_size <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="main">=</span> <span class="main">1</span> <span class="keyword1">then</span> ternop_IMUL <span class="keyword1">TYPE</span><span class="main">(</span><span class="numeral">16</span><span class="main">)</span>  <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="free"><span class="bound"><span class="entity">op2</span></span></span> <span class="free"><span class="bound"><span class="entity">op3</span></span></span>
      <span class="keyword1">else</span> undefined"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">IMUL3</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">IMUL3</span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="free"><span class="bound"><span class="entity">op2</span></span></span> <span class="free"><span class="bound"><span class="entity">op3</span></span></span> <span class="main">≡</span> Instr <span class="inner_quoted">''imul''</span> <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">op1</span></span></span><span class="main">)</span> <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">op2</span></span></span><span class="main">)</span> <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">op3</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">SHL_flags</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>len word <span class="main">⇒</span> string <span class="main">⇒</span> bool<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">SHL_flags</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">dst</span></span></span> <span class="free"><span class="bound"><span class="entity">flag</span></span></span> <span class="main">≡</span> <span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">flag</span></span></span> <span class="keyword1">of</span>
        <span class="inner_quoted">''cf''</span> <span class="main">⇒</span> <span class="free"><span class="bound"><span class="entity">dst</span></span></span> <span class="main">!!</span> <span class="main">(</span><span class="keyword1">LENGTH</span><span class="main">(</span><span class="tfree">'a</span><span class="main">)</span> <span class="main">-</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> 
      <span class="main">|</span> <span class="inner_quoted">''of''</span> <span class="main">⇒</span> <span class="free"><span class="bound"><span class="entity">dst</span></span></span> <span class="main">!!</span> <span class="main">(</span><span class="keyword1">LENGTH</span><span class="main">(</span><span class="tfree">'a</span><span class="main">)</span> <span class="main">-</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">≠</span> <span class="free"><span class="bound"><span class="entity">dst</span></span></span> <span class="main">!!</span> <span class="main">(</span><span class="keyword1">LENGTH</span><span class="main">(</span><span class="tfree">'a</span><span class="main">)</span> <span class="main">-</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span>
      <span class="main">|</span> <span class="inner_quoted">''zf''</span> <span class="main">⇒</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">dst</span></span></span> <span class="main">&lt;&lt;</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>
      <span class="main">|</span> <span class="inner_quoted">''sf''</span> <span class="main">⇒</span> <span class="free"><span class="bound"><span class="entity">dst</span></span></span> <span class="main">!!</span> <span class="main">(</span><span class="keyword1">LENGTH</span><span class="main">(</span><span class="tfree">'a</span><span class="main">)</span> <span class="main">-</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>
      <span class="main">|</span> <span class="bound">f</span>      <span class="main">⇒</span> <span class="free">unknown_flags</span> <span class="inner_quoted">''SHL''</span> <span class="bound">f</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">semantics_SHL</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"Operand <span class="main">⇒</span> Operand <span class="main">⇒</span> state <span class="main">⇒</span> state"</span></span> 
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">semantics_SHL</span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="free"><span class="bound"><span class="entity">op2</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">≡</span> 
    <span class="keyword1">let</span> <span class="bound">src</span> <span class="main">=</span> unat <span class="main">(</span>operand_read <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">op2</span></span></span><span class="main">)</span> <span class="keyword1">in</span>
           <span class="keyword1">if</span> operand_size <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="main">=</span> <span class="numeral">32</span> <span class="keyword1">then</span> unop <span class="main">(</span><span class="main">λ</span> <span class="bound">w</span> <span class="main">.</span> <span class="bound">w</span> <span class="main">&lt;&lt;</span> <span class="bound">src</span><span class="main">::</span><span class="numeral">256</span> word<span class="main">)</span> <span class="main">(</span>SHL_flags <span class="bound">src</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span>
      <span class="keyword1">else</span> <span class="keyword1">if</span> operand_size <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="main">=</span> <span class="numeral">16</span> <span class="keyword1">then</span> unop <span class="main">(</span><span class="main">λ</span> <span class="bound">w</span> <span class="main">.</span> <span class="bound">w</span> <span class="main">&lt;&lt;</span> <span class="bound">src</span><span class="main">::</span><span class="numeral">128</span> word<span class="main">)</span> <span class="main">(</span>SHL_flags <span class="bound">src</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span>
      <span class="keyword1">else</span> <span class="keyword1">if</span> operand_size <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="main">=</span> <span class="numeral">8</span>  <span class="keyword1">then</span> unop <span class="main">(</span><span class="main">λ</span> <span class="bound">w</span> <span class="main">.</span> <span class="bound">w</span> <span class="main">&lt;&lt;</span> <span class="bound">src</span><span class="main">::</span><span class="numeral">64</span>  word<span class="main">)</span> <span class="main">(</span>SHL_flags <span class="bound">src</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span>
      <span class="keyword1">else</span> <span class="keyword1">if</span> operand_size <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="main">=</span> <span class="numeral">4</span>  <span class="keyword1">then</span> unop <span class="main">(</span><span class="main">λ</span> <span class="bound">w</span> <span class="main">.</span> <span class="bound">w</span> <span class="main">&lt;&lt;</span> <span class="bound">src</span><span class="main">::</span><span class="numeral">32</span>  word<span class="main">)</span> <span class="main">(</span>SHL_flags <span class="bound">src</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span>
      <span class="keyword1">else</span> <span class="keyword1">if</span> operand_size <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="main">=</span> <span class="numeral">2</span>  <span class="keyword1">then</span> unop <span class="main">(</span><span class="main">λ</span> <span class="bound">w</span> <span class="main">.</span> <span class="bound">w</span> <span class="main">&lt;&lt;</span> <span class="bound">src</span><span class="main">::</span><span class="numeral">16</span>  word<span class="main">)</span> <span class="main">(</span>SHL_flags <span class="bound">src</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span>
      <span class="keyword1">else</span> <span class="keyword1">if</span> operand_size <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="main">=</span> <span class="main">1</span>  <span class="keyword1">then</span> unop <span class="main">(</span><span class="main">λ</span> <span class="bound">w</span> <span class="main">.</span> <span class="bound">w</span> <span class="main">&lt;&lt;</span> <span class="bound">src</span><span class="main">::</span><span class="numeral">8</span>   word<span class="main">)</span> <span class="main">(</span>SHL_flags <span class="bound">src</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span>
      <span class="keyword1">else</span> undefined"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">SHL</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">SHL</span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="free"><span class="bound"><span class="entity">op2</span></span></span> <span class="main">≡</span> Instr <span class="inner_quoted">''shl''</span> <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">op1</span></span></span><span class="main">)</span> <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">op2</span></span></span><span class="main">)</span> None"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">SAL</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">SAL</span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="free"><span class="bound"><span class="entity">op2</span></span></span> <span class="main">≡</span> Instr <span class="inner_quoted">''sal''</span> <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">op1</span></span></span><span class="main">)</span> <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">op2</span></span></span><span class="main">)</span> None"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">SHR_flags</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>len word <span class="main">⇒</span> string <span class="main">⇒</span> bool<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">SHR_flags</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">dst</span></span></span> <span class="free"><span class="bound"><span class="entity">flag</span></span></span> <span class="main">≡</span> <span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">flag</span></span></span> <span class="keyword1">of</span>
        <span class="inner_quoted">''cf''</span> <span class="main">⇒</span> <span class="free"><span class="bound"><span class="entity">dst</span></span></span> <span class="main">!!</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> 
      <span class="main">|</span> <span class="inner_quoted">''of''</span> <span class="main">⇒</span> msb <span class="free"><span class="bound"><span class="entity">dst</span></span></span>
      <span class="main">|</span> <span class="inner_quoted">''zf''</span> <span class="main">⇒</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">dst</span></span></span> <span class="main">&gt;&gt;</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>
      <span class="main">|</span> <span class="bound">f</span>      <span class="main">⇒</span> <span class="free">unknown_flags</span> <span class="inner_quoted">''SHR''</span> <span class="bound">f</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">semantics_SHR</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"Operand <span class="main">⇒</span> Operand <span class="main">⇒</span> state <span class="main">⇒</span> state"</span></span> 
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">semantics_SHR</span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="free"><span class="bound"><span class="entity">op2</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">≡</span> 
    <span class="keyword1">let</span> <span class="bound">src</span> <span class="main">=</span> unat <span class="main">(</span>operand_read <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">op2</span></span></span><span class="main">)</span> <span class="keyword1">in</span>
           <span class="keyword1">if</span> operand_size <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="main">=</span> <span class="numeral">32</span> <span class="keyword1">then</span> unop <span class="main">(</span><span class="main">λ</span> <span class="bound">w</span> <span class="main">.</span> <span class="bound">w</span> <span class="main">&gt;&gt;</span> <span class="bound">src</span><span class="main">::</span><span class="numeral">256</span> word<span class="main">)</span> <span class="main">(</span>SHR_flags <span class="bound">src</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span>
      <span class="keyword1">else</span> <span class="keyword1">if</span> operand_size <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="main">=</span> <span class="numeral">16</span> <span class="keyword1">then</span> unop <span class="main">(</span><span class="main">λ</span> <span class="bound">w</span> <span class="main">.</span> <span class="bound">w</span> <span class="main">&gt;&gt;</span> <span class="bound">src</span><span class="main">::</span><span class="numeral">128</span> word<span class="main">)</span> <span class="main">(</span>SHR_flags <span class="bound">src</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span>
      <span class="keyword1">else</span> <span class="keyword1">if</span> operand_size <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="main">=</span> <span class="numeral">8</span>  <span class="keyword1">then</span> unop <span class="main">(</span><span class="main">λ</span> <span class="bound">w</span> <span class="main">.</span> <span class="bound">w</span> <span class="main">&gt;&gt;</span> <span class="bound">src</span><span class="main">::</span><span class="numeral">64</span>  word<span class="main">)</span> <span class="main">(</span>SHR_flags <span class="bound">src</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span>
      <span class="keyword1">else</span> <span class="keyword1">if</span> operand_size <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="main">=</span> <span class="numeral">4</span>  <span class="keyword1">then</span> unop <span class="main">(</span><span class="main">λ</span> <span class="bound">w</span> <span class="main">.</span> <span class="bound">w</span> <span class="main">&gt;&gt;</span> <span class="bound">src</span><span class="main">::</span><span class="numeral">32</span>  word<span class="main">)</span> <span class="main">(</span>SHR_flags <span class="bound">src</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span>
      <span class="keyword1">else</span> <span class="keyword1">if</span> operand_size <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="main">=</span> <span class="numeral">2</span>  <span class="keyword1">then</span> unop <span class="main">(</span><span class="main">λ</span> <span class="bound">w</span> <span class="main">.</span> <span class="bound">w</span> <span class="main">&gt;&gt;</span> <span class="bound">src</span><span class="main">::</span><span class="numeral">16</span>  word<span class="main">)</span> <span class="main">(</span>SHR_flags <span class="bound">src</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span>
      <span class="keyword1">else</span> <span class="keyword1">if</span> operand_size <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="main">=</span> <span class="main">1</span>  <span class="keyword1">then</span> unop <span class="main">(</span><span class="main">λ</span> <span class="bound">w</span> <span class="main">.</span> <span class="bound">w</span> <span class="main">&gt;&gt;</span> <span class="bound">src</span><span class="main">::</span><span class="numeral">8</span>   word<span class="main">)</span> <span class="main">(</span>SHR_flags <span class="bound">src</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span>
      <span class="keyword1">else</span> undefined"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">SHR</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">SHR</span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="free"><span class="bound"><span class="entity">op2</span></span></span> <span class="main">≡</span> Instr <span class="inner_quoted">''shr''</span> <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">op1</span></span></span><span class="main">)</span> <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">op2</span></span></span><span class="main">)</span> None"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">SAR_flags</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>len word <span class="main">⇒</span> string <span class="main">⇒</span> bool<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">SAR_flags</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">dst</span></span></span> <span class="free"><span class="bound"><span class="entity">flag</span></span></span> <span class="main">≡</span> <span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">flag</span></span></span> <span class="keyword1">of</span>
        <span class="inner_quoted">''cf''</span> <span class="main">⇒</span> <span class="free"><span class="bound"><span class="entity">dst</span></span></span> <span class="main">!!</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> 
      <span class="main">|</span> <span class="inner_quoted">''of''</span> <span class="main">⇒</span> False
      <span class="main">|</span> <span class="inner_quoted">''zf''</span> <span class="main">⇒</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">dst</span></span></span> <span class="main">&gt;&gt;&gt;</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>
      <span class="main">|</span> <span class="bound">f</span>      <span class="main">⇒</span> <span class="free">unknown_flags</span> <span class="inner_quoted">''SAR''</span> <span class="bound">f</span>"</span></span>


<span class="keyword1"><span class="command">definition</span></span> <span class="entity">semantics_SAR</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"Operand <span class="main">⇒</span> Operand <span class="main">⇒</span> state <span class="main">⇒</span> state"</span></span> 
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">semantics_SAR</span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="free"><span class="bound"><span class="entity">op2</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">≡</span> 
    <span class="keyword1">let</span> <span class="bound">src</span> <span class="main">=</span> unat <span class="main">(</span>operand_read <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">op2</span></span></span><span class="main">)</span> <span class="keyword1">in</span>
           <span class="keyword1">if</span> operand_size <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="main">=</span> <span class="numeral">32</span> <span class="keyword1">then</span> unop <span class="main">(</span><span class="main">λ</span> <span class="bound">w</span> <span class="main">.</span> <span class="bound">w</span> <span class="main">&gt;&gt;&gt;</span> <span class="bound">src</span><span class="main">::</span><span class="numeral">256</span> word<span class="main">)</span> <span class="main">(</span>SAR_flags <span class="bound">src</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span>
      <span class="keyword1">else</span> <span class="keyword1">if</span> operand_size <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="main">=</span> <span class="numeral">16</span> <span class="keyword1">then</span> unop <span class="main">(</span><span class="main">λ</span> <span class="bound">w</span> <span class="main">.</span> <span class="bound">w</span> <span class="main">&gt;&gt;&gt;</span> <span class="bound">src</span><span class="main">::</span><span class="numeral">128</span> word<span class="main">)</span> <span class="main">(</span>SAR_flags <span class="bound">src</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span>
      <span class="keyword1">else</span> <span class="keyword1">if</span> operand_size <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="main">=</span> <span class="numeral">8</span>  <span class="keyword1">then</span> unop <span class="main">(</span><span class="main">λ</span> <span class="bound">w</span> <span class="main">.</span> <span class="bound">w</span> <span class="main">&gt;&gt;&gt;</span> <span class="bound">src</span><span class="main">::</span><span class="numeral">64</span>  word<span class="main">)</span> <span class="main">(</span>SAR_flags <span class="bound">src</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span>
      <span class="keyword1">else</span> <span class="keyword1">if</span> operand_size <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="main">=</span> <span class="numeral">4</span>  <span class="keyword1">then</span> unop <span class="main">(</span><span class="main">λ</span> <span class="bound">w</span> <span class="main">.</span> <span class="bound">w</span> <span class="main">&gt;&gt;&gt;</span> <span class="bound">src</span><span class="main">::</span><span class="numeral">32</span>  word<span class="main">)</span> <span class="main">(</span>SAR_flags <span class="bound">src</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span>
      <span class="keyword1">else</span> <span class="keyword1">if</span> operand_size <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="main">=</span> <span class="numeral">2</span>  <span class="keyword1">then</span> unop <span class="main">(</span><span class="main">λ</span> <span class="bound">w</span> <span class="main">.</span> <span class="bound">w</span> <span class="main">&gt;&gt;&gt;</span> <span class="bound">src</span><span class="main">::</span><span class="numeral">16</span>  word<span class="main">)</span> <span class="main">(</span>SAR_flags <span class="bound">src</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span>
      <span class="keyword1">else</span> <span class="keyword1">if</span> operand_size <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="main">=</span> <span class="main">1</span>  <span class="keyword1">then</span> unop <span class="main">(</span><span class="main">λ</span> <span class="bound">w</span> <span class="main">.</span> <span class="bound">w</span> <span class="main">&gt;&gt;&gt;</span> <span class="bound">src</span><span class="main">::</span><span class="numeral">8</span>   word<span class="main">)</span> <span class="main">(</span>SAR_flags <span class="bound">src</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span>
      <span class="keyword1">else</span> undefined"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">SAR</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">SAR</span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="free"><span class="bound"><span class="entity">op2</span></span></span> <span class="main">≡</span> Instr <span class="inner_quoted">''sar''</span> <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">op1</span></span></span><span class="main">)</span> <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">op2</span></span></span><span class="main">)</span> None"</span></span>


<span class="keyword1"><span class="command">definition</span></span> <span class="entity">shld</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'b</span><span class="main">::</span>len itself <span class="main">⇒</span> nat <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">::</span>len word <span class="main">⇒</span> <span class="tfree">'a</span> word <span class="main">⇒</span> <span class="tfree">'a</span> word"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">shld</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">dst</span></span></span> <span class="free"><span class="bound"><span class="entity">src</span></span></span> <span class="main">≡</span>
    <span class="keyword1">let</span> <span class="bound">dstsrc</span>  <span class="main">=</span> <span class="main">(</span>ucast <span class="free"><span class="bound"><span class="entity">dst</span></span></span> <span class="main">&lt;&lt;</span> <span class="keyword1">LENGTH</span><span class="main">(</span><span class="tfree">'a</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">OR</span> <span class="main">(</span>ucast <span class="free"><span class="bound"><span class="entity">src</span></span></span> <span class="main">::</span> <span class="tfree">'b</span> word<span class="main">)</span><span class="main">;</span>
        <span class="bound">shifted</span> <span class="main">=</span> <span class="main">⟨</span><span class="keyword1">LENGTH</span><span class="main">(</span><span class="tfree">'a</span><span class="main">)</span><span class="main">,</span><span class="keyword1">LENGTH</span><span class="main">(</span><span class="tfree">'a</span><span class="main">)</span><span class="main">*</span><span class="numeral">2</span><span class="main">⟩</span><span class="main">(</span><span class="bound">dstsrc</span> <span class="main">&lt;&lt;</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="keyword1">in</span>
      ucast <span class="bound">shifted</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">SHLD_flags</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'b</span><span class="main">::</span>len itself <span class="main">⇒</span> nat <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>len word <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">::</span>len word <span class="main">⇒</span> string <span class="main">⇒</span> bool<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">SHLD_flags</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">src</span></span></span> <span class="free"><span class="bound"><span class="entity">dst</span></span></span> <span class="free"><span class="bound"><span class="entity">flag</span></span></span> <span class="main">≡</span> <span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">flag</span></span></span> <span class="keyword1">of</span>
        <span class="inner_quoted">''cf''</span> <span class="main">⇒</span> <span class="free"><span class="bound"><span class="entity">dst</span></span></span> <span class="main">!!</span> <span class="main">(</span><span class="keyword1">LENGTH</span><span class="main">(</span><span class="tfree">'a</span><span class="main">)</span> <span class="main">-</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> 
      <span class="main">|</span> <span class="inner_quoted">''of''</span> <span class="main">⇒</span> <span class="free"><span class="bound"><span class="entity">dst</span></span></span> <span class="main">!!</span> <span class="main">(</span><span class="keyword1">LENGTH</span><span class="main">(</span><span class="tfree">'a</span><span class="main">)</span> <span class="main">-</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">≠</span> <span class="free"><span class="bound"><span class="entity">dst</span></span></span> <span class="main">!!</span> <span class="main">(</span><span class="keyword1">LENGTH</span><span class="main">(</span><span class="tfree">'a</span><span class="main">)</span> <span class="main">-</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span>
      <span class="main">|</span> <span class="inner_quoted">''zf''</span> <span class="main">⇒</span> shld <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">dst</span></span></span> <span class="free"><span class="bound"><span class="entity">src</span></span></span> <span class="main">=</span> <span class="main">0</span>
      <span class="main">|</span> <span class="inner_quoted">''sf''</span> <span class="main">⇒</span> <span class="free"><span class="bound"><span class="entity">dst</span></span></span> <span class="main">!!</span> <span class="main">(</span><span class="keyword1">LENGTH</span><span class="main">(</span><span class="tfree">'a</span><span class="main">)</span> <span class="main">-</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="comment1">― ‹msb (shld n dst src)›</span>
      <span class="main">|</span> <span class="bound">f</span>      <span class="main">⇒</span> <span class="free">unknown_flags</span> <span class="inner_quoted">''SHLD''</span> <span class="bound">f</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">semantics_SHLD</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"Operand <span class="main">⇒</span> Operand <span class="main">⇒</span> Operand <span class="main">⇒</span> state <span class="main">⇒</span> state"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">semantics_SHLD</span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="free"><span class="bound"><span class="entity">op2</span></span></span> <span class="free"><span class="bound"><span class="entity">op3</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">≡</span> 
    <span class="keyword1">let</span> <span class="bound">src2</span> <span class="main">=</span> unat <span class="main">(</span>operand_read <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">op3</span></span></span><span class="main">)</span> <span class="keyword1">in</span>
           <span class="keyword1">if</span> operand_size <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="main">=</span> <span class="numeral">32</span> <span class="keyword1">then</span> binop <span class="main">(</span>shld <span class="main">(</span><span class="keyword1">TYPE</span><span class="main">(</span><span class="numeral">512</span><span class="main">)</span><span class="main">)</span> <span class="bound">src2</span> <span class="main">::</span><span class="numeral">256</span> word <span class="main">⇒</span> <span class="main">_</span> <span class="main">⇒</span> <span class="main">_</span><span class="main">)</span> <span class="main">(</span>SHLD_flags <span class="main">(</span><span class="keyword1">TYPE</span><span class="main">(</span><span class="numeral">512</span><span class="main">)</span><span class="main">)</span> <span class="bound">src2</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="free"><span class="bound"><span class="entity">op2</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span>
      <span class="keyword1">else</span> <span class="keyword1">if</span> operand_size <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="main">=</span> <span class="numeral">16</span> <span class="keyword1">then</span> binop <span class="main">(</span>shld <span class="main">(</span><span class="keyword1">TYPE</span><span class="main">(</span><span class="numeral">256</span><span class="main">)</span><span class="main">)</span> <span class="bound">src2</span> <span class="main">::</span><span class="numeral">128</span> word <span class="main">⇒</span> <span class="main">_</span> <span class="main">⇒</span> <span class="main">_</span><span class="main">)</span> <span class="main">(</span>SHLD_flags <span class="main">(</span><span class="keyword1">TYPE</span><span class="main">(</span><span class="numeral">256</span><span class="main">)</span><span class="main">)</span> <span class="bound">src2</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="free"><span class="bound"><span class="entity">op2</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span>
      <span class="keyword1">else</span> <span class="keyword1">if</span> operand_size <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="main">=</span> <span class="numeral">8</span>  <span class="keyword1">then</span> binop <span class="main">(</span>shld <span class="main">(</span><span class="keyword1">TYPE</span><span class="main">(</span><span class="numeral">128</span><span class="main">)</span><span class="main">)</span> <span class="bound">src2</span> <span class="main">::</span><span class="numeral">64</span>  word <span class="main">⇒</span> <span class="main">_</span> <span class="main">⇒</span> <span class="main">_</span><span class="main">)</span> <span class="main">(</span>SHLD_flags <span class="main">(</span><span class="keyword1">TYPE</span><span class="main">(</span><span class="numeral">128</span><span class="main">)</span><span class="main">)</span> <span class="bound">src2</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="free"><span class="bound"><span class="entity">op2</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span>
      <span class="keyword1">else</span> <span class="keyword1">if</span> operand_size <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="main">=</span> <span class="numeral">4</span>  <span class="keyword1">then</span> binop <span class="main">(</span>shld <span class="main">(</span><span class="keyword1">TYPE</span><span class="main">(</span><span class="numeral">64</span><span class="main">)</span><span class="main">)</span>  <span class="bound">src2</span> <span class="main">::</span><span class="numeral">32</span>  word <span class="main">⇒</span> <span class="main">_</span> <span class="main">⇒</span> <span class="main">_</span><span class="main">)</span> <span class="main">(</span>SHLD_flags <span class="main">(</span><span class="keyword1">TYPE</span><span class="main">(</span><span class="numeral">64</span><span class="main">)</span><span class="main">)</span>  <span class="bound">src2</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="free"><span class="bound"><span class="entity">op2</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span>
      <span class="keyword1">else</span> <span class="keyword1">if</span> operand_size <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="main">=</span> <span class="numeral">2</span>  <span class="keyword1">then</span> binop <span class="main">(</span>shld <span class="main">(</span><span class="keyword1">TYPE</span><span class="main">(</span><span class="numeral">32</span><span class="main">)</span><span class="main">)</span>  <span class="bound">src2</span> <span class="main">::</span><span class="numeral">16</span>  word <span class="main">⇒</span> <span class="main">_</span> <span class="main">⇒</span> <span class="main">_</span><span class="main">)</span> <span class="main">(</span>SHLD_flags <span class="main">(</span><span class="keyword1">TYPE</span><span class="main">(</span><span class="numeral">32</span><span class="main">)</span><span class="main">)</span>  <span class="bound">src2</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="free"><span class="bound"><span class="entity">op2</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span>
      <span class="keyword1">else</span> <span class="keyword1">if</span> operand_size <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="main">=</span> <span class="main">1</span>  <span class="keyword1">then</span> binop <span class="main">(</span>shld <span class="main">(</span><span class="keyword1">TYPE</span><span class="main">(</span><span class="numeral">16</span><span class="main">)</span><span class="main">)</span>  <span class="bound">src2</span> <span class="main">::</span><span class="numeral">8</span>   word <span class="main">⇒</span> <span class="main">_</span> <span class="main">⇒</span> <span class="main">_</span><span class="main">)</span> <span class="main">(</span>SHLD_flags <span class="main">(</span><span class="keyword1">TYPE</span><span class="main">(</span><span class="numeral">16</span><span class="main">)</span><span class="main">)</span>  <span class="bound">src2</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="free"><span class="bound"><span class="entity">op2</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span>
      <span class="keyword1">else</span> undefined"</span></span>



<span class="keyword1"><span class="command">definition</span></span> <span class="entity">ROL_flags</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>len word <span class="main">⇒</span> string <span class="main">⇒</span> bool<span class="main">)</span>"</span></span> <span class="comment1">(*TODO check for unaffected flags *)</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">ROL_flags</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">dst</span></span></span> <span class="free"><span class="bound"><span class="entity">flag</span></span></span> <span class="main">≡</span> <span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">flag</span></span></span> <span class="keyword1">of</span>
        <span class="inner_quoted">''cf''</span> <span class="main">⇒</span> <span class="free"><span class="bound"><span class="entity">dst</span></span></span> <span class="main">!!</span> <span class="main">(</span><span class="keyword1">LENGTH</span><span class="main">(</span><span class="tfree">'a</span><span class="main">)</span> <span class="main">-</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> 
      <span class="main">|</span> <span class="inner_quoted">''of''</span> <span class="main">⇒</span> <span class="free"><span class="bound"><span class="entity">dst</span></span></span> <span class="main">!!</span> <span class="main">(</span><span class="keyword1">LENGTH</span><span class="main">(</span><span class="tfree">'a</span><span class="main">)</span> <span class="main">-</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">≠</span> <span class="free"><span class="bound"><span class="entity">dst</span></span></span> <span class="main">!!</span> <span class="main">(</span><span class="keyword1">LENGTH</span><span class="main">(</span><span class="tfree">'a</span><span class="main">)</span> <span class="main">-</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span>
      <span class="main">|</span> <span class="bound">f</span>      <span class="main">⇒</span> <span class="free">unknown_flags</span> <span class="inner_quoted">''ROL''</span> <span class="bound">f</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">semantics_ROL</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"Operand <span class="main">⇒</span> Operand <span class="main">⇒</span> state <span class="main">⇒</span> state"</span></span> 
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">semantics_ROL</span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="free"><span class="bound"><span class="entity">op2</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">≡</span> 
    <span class="keyword1">let</span> <span class="bound">src</span> <span class="main">=</span> unat <span class="main">(</span>operand_read <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">op2</span></span></span><span class="main">)</span> <span class="keyword1">in</span>
           <span class="keyword1">if</span> operand_size <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="main">=</span> <span class="numeral">32</span> <span class="keyword1">then</span> unop <span class="main">(</span>word_rotl <span class="bound">src</span><span class="main">::</span><span class="numeral">256</span> word<span class="main">⇒</span><span class="main">_</span><span class="main">)</span> <span class="main">(</span>ROL_flags <span class="bound">src</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span>
      <span class="keyword1">else</span> <span class="keyword1">if</span> operand_size <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="main">=</span> <span class="numeral">16</span> <span class="keyword1">then</span> unop <span class="main">(</span>word_rotl <span class="bound">src</span><span class="main">::</span><span class="numeral">128</span> word<span class="main">⇒</span><span class="main">_</span><span class="main">)</span> <span class="main">(</span>ROL_flags <span class="bound">src</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span>
      <span class="keyword1">else</span> <span class="keyword1">if</span> operand_size <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="main">=</span> <span class="numeral">8</span>  <span class="keyword1">then</span> unop <span class="main">(</span>word_rotl <span class="bound">src</span><span class="main">::</span><span class="numeral">64</span>  word<span class="main">⇒</span><span class="main">_</span><span class="main">)</span> <span class="main">(</span>ROL_flags <span class="bound">src</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span>
      <span class="keyword1">else</span> <span class="keyword1">if</span> operand_size <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="main">=</span> <span class="numeral">4</span>  <span class="keyword1">then</span> unop <span class="main">(</span>word_rotl <span class="bound">src</span><span class="main">::</span><span class="numeral">32</span>  word<span class="main">⇒</span><span class="main">_</span><span class="main">)</span> <span class="main">(</span>ROL_flags <span class="bound">src</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span>
      <span class="keyword1">else</span> <span class="keyword1">if</span> operand_size <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="main">=</span> <span class="numeral">2</span>  <span class="keyword1">then</span> unop <span class="main">(</span>word_rotl <span class="bound">src</span><span class="main">::</span><span class="numeral">16</span>  word<span class="main">⇒</span><span class="main">_</span><span class="main">)</span> <span class="main">(</span>ROL_flags <span class="bound">src</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span>
      <span class="keyword1">else</span> <span class="keyword1">if</span> operand_size <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="main">=</span> <span class="main">1</span>  <span class="keyword1">then</span> unop <span class="main">(</span>word_rotl <span class="bound">src</span><span class="main">::</span><span class="numeral">8</span>   word<span class="main">⇒</span><span class="main">_</span><span class="main">)</span> <span class="main">(</span>ROL_flags <span class="bound">src</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span>
      <span class="keyword1">else</span> undefined"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">ROL</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">ROL</span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="free"><span class="bound"><span class="entity">op2</span></span></span> <span class="main">≡</span> Instr <span class="inner_quoted">''rol''</span> <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">op1</span></span></span><span class="main">)</span> <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">op2</span></span></span><span class="main">)</span> None"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">ROR_flags</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>len word <span class="main">⇒</span> string <span class="main">⇒</span> bool<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">ROR_flags</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">dst</span></span></span> <span class="free"><span class="bound"><span class="entity">flag</span></span></span> <span class="main">≡</span> <span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">flag</span></span></span> <span class="keyword1">of</span>
        <span class="inner_quoted">''cf''</span> <span class="main">⇒</span> <span class="free"><span class="bound"><span class="entity">dst</span></span></span> <span class="main">!!</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> 
      <span class="main">|</span> <span class="inner_quoted">''of''</span> <span class="main">⇒</span> msb <span class="main">(</span>word_rotr <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">dst</span></span></span><span class="main">)</span> <span class="main">≠</span> <span class="main">(</span>word_rotr <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">dst</span></span></span> <span class="main">!!</span> <span class="main">(</span><span class="keyword1">LENGTH</span><span class="main">(</span><span class="tfree">'a</span><span class="main">)</span><span class="main">-</span><span class="numeral">2</span><span class="main">)</span><span class="main">)</span>
      <span class="main">|</span> <span class="bound">f</span>      <span class="main">⇒</span> <span class="free">unknown_flags</span> <span class="inner_quoted">''ROR''</span> <span class="bound">f</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">semantics_ROR</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"Operand <span class="main">⇒</span> Operand <span class="main">⇒</span> state <span class="main">⇒</span> state"</span></span> 
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">semantics_ROR</span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="free"><span class="bound"><span class="entity">op2</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">≡</span> 
    <span class="keyword1">let</span> <span class="bound">src</span> <span class="main">=</span> unat <span class="main">(</span>operand_read <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">op2</span></span></span><span class="main">)</span> <span class="keyword1">in</span>
           <span class="keyword1">if</span> operand_size <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="main">=</span> <span class="numeral">32</span> <span class="keyword1">then</span> unop <span class="main">(</span>word_rotr <span class="bound">src</span><span class="main">::</span><span class="numeral">256</span> word<span class="main">⇒</span><span class="main">_</span><span class="main">)</span> <span class="main">(</span>ROR_flags <span class="bound">src</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span>
      <span class="keyword1">else</span> <span class="keyword1">if</span> operand_size <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="main">=</span> <span class="numeral">16</span> <span class="keyword1">then</span> unop <span class="main">(</span>word_rotr <span class="bound">src</span><span class="main">::</span><span class="numeral">128</span> word<span class="main">⇒</span><span class="main">_</span><span class="main">)</span> <span class="main">(</span>ROR_flags <span class="bound">src</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span>
      <span class="keyword1">else</span> <span class="keyword1">if</span> operand_size <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="main">=</span> <span class="numeral">8</span>  <span class="keyword1">then</span> unop <span class="main">(</span>word_rotr <span class="bound">src</span><span class="main">::</span><span class="numeral">64</span>  word<span class="main">⇒</span><span class="main">_</span><span class="main">)</span> <span class="main">(</span>ROR_flags <span class="bound">src</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span>
      <span class="keyword1">else</span> <span class="keyword1">if</span> operand_size <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="main">=</span> <span class="numeral">4</span>  <span class="keyword1">then</span> unop <span class="main">(</span>word_rotr <span class="bound">src</span><span class="main">::</span><span class="numeral">32</span>  word<span class="main">⇒</span><span class="main">_</span><span class="main">)</span> <span class="main">(</span>ROR_flags <span class="bound">src</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span>
      <span class="keyword1">else</span> <span class="keyword1">if</span> operand_size <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="main">=</span> <span class="numeral">2</span>  <span class="keyword1">then</span> unop <span class="main">(</span>word_rotr <span class="bound">src</span><span class="main">::</span><span class="numeral">16</span>  word<span class="main">⇒</span><span class="main">_</span><span class="main">)</span> <span class="main">(</span>ROR_flags <span class="bound">src</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span>
      <span class="keyword1">else</span> <span class="keyword1">if</span> operand_size <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="main">=</span> <span class="main">1</span>  <span class="keyword1">then</span> unop <span class="main">(</span>word_rotr <span class="bound">src</span><span class="main">::</span><span class="numeral">8</span>   word<span class="main">⇒</span><span class="main">_</span><span class="main">)</span> <span class="main">(</span>ROR_flags <span class="bound">src</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span>
      <span class="keyword1">else</span> undefined"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">ROR</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">ROR</span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="free"><span class="bound"><span class="entity">op2</span></span></span> <span class="main">≡</span> Instr <span class="inner_quoted">''ror''</span> <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">op1</span></span></span><span class="main">)</span> <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">op2</span></span></span><span class="main">)</span> None"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹ flag-related ›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">semantics_CMP</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"Operand <span class="main">⇒</span> Operand <span class="main">⇒</span> state <span class="main">⇒</span> state"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">semantics_CMP</span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="main">≡</span> 
           <span class="keyword1">if</span> operand_size <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="main">=</span> <span class="numeral">32</span> <span class="keyword1">then</span> binop_flags <span class="main">(</span>SUB_flags<span class="main">::</span><span class="numeral">256</span> word <span class="main">⇒</span> <span class="main">_</span> <span class="main">⇒</span> <span class="main">_</span> <span class="main">⇒</span> <span class="main">_</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span>
      <span class="keyword1">else</span> <span class="keyword1">if</span> operand_size <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="main">=</span> <span class="numeral">16</span> <span class="keyword1">then</span> binop_flags <span class="main">(</span>SUB_flags<span class="main">::</span><span class="numeral">128</span> word <span class="main">⇒</span> <span class="main">_</span> <span class="main">⇒</span> <span class="main">_</span> <span class="main">⇒</span> <span class="main">_</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span>
      <span class="keyword1">else</span> <span class="keyword1">if</span> operand_size <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="main">=</span> <span class="numeral">8</span>  <span class="keyword1">then</span> binop_flags <span class="main">(</span>SUB_flags<span class="main">::</span><span class="numeral">64</span>  word <span class="main">⇒</span> <span class="main">_</span> <span class="main">⇒</span> <span class="main">_</span> <span class="main">⇒</span> <span class="main">_</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span>
      <span class="keyword1">else</span> <span class="keyword1">if</span> operand_size <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="main">=</span> <span class="numeral">4</span>  <span class="keyword1">then</span> binop_flags <span class="main">(</span>SUB_flags<span class="main">::</span><span class="numeral">32</span>  word <span class="main">⇒</span> <span class="main">_</span> <span class="main">⇒</span> <span class="main">_</span> <span class="main">⇒</span> <span class="main">_</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span>
      <span class="keyword1">else</span> <span class="keyword1">if</span> operand_size <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="main">=</span> <span class="numeral">2</span>  <span class="keyword1">then</span> binop_flags <span class="main">(</span>SUB_flags<span class="main">::</span><span class="numeral">16</span>  word <span class="main">⇒</span> <span class="main">_</span> <span class="main">⇒</span> <span class="main">_</span> <span class="main">⇒</span> <span class="main">_</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span>
      <span class="keyword1">else</span> <span class="keyword1">if</span> operand_size <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="main">=</span> <span class="main">1</span>  <span class="keyword1">then</span> binop_flags <span class="main">(</span>SUB_flags<span class="main">::</span><span class="numeral">8</span>   word <span class="main">⇒</span> <span class="main">_</span> <span class="main">⇒</span> <span class="main">_</span> <span class="main">⇒</span> <span class="main">_</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span>
      <span class="keyword1">else</span> undefined"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">CMP</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">CMP</span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="free"><span class="bound"><span class="entity">op2</span></span></span> <span class="main">≡</span> Instr <span class="inner_quoted">''cmp''</span> <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">op1</span></span></span><span class="main">)</span> <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">op2</span></span></span><span class="main">)</span> None"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">logic_flags</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>len word <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">::</span>len word <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">::</span>len word<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">::</span>len word <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">::</span>len word <span class="main">⇒</span> string  <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">logic_flags</span> <span class="free"><span class="bound"><span class="entity">logic_op</span></span></span> <span class="free"><span class="bound"><span class="entity">w0</span></span></span> <span class="free"><span class="bound"><span class="entity">w1</span></span></span> <span class="free"><span class="bound"><span class="entity">flag</span></span></span> <span class="main">≡</span> <span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">flag</span></span></span> <span class="keyword1">of</span>
    <span class="inner_quoted">''zf''</span> <span class="main">⇒</span> <span class="free"><span class="bound"><span class="entity">logic_op</span></span></span> <span class="free"><span class="bound"><span class="entity">w0</span></span></span> <span class="free"><span class="bound"><span class="entity">w1</span></span></span> <span class="main">=</span> <span class="main">0</span>
  <span class="main">|</span> <span class="inner_quoted">''cf''</span> <span class="main">⇒</span> False
  <span class="main">|</span> <span class="inner_quoted">''of''</span> <span class="main">⇒</span> False
  <span class="main">|</span> <span class="inner_quoted">''sf''</span> <span class="main">⇒</span> msb <span class="main">(</span><span class="free"><span class="bound"><span class="entity">logic_op</span></span></span> <span class="free"><span class="bound"><span class="entity">w0</span></span></span> <span class="free"><span class="bound"><span class="entity">w1</span></span></span><span class="main">)</span>
  <span class="main">|</span> <span class="bound">f</span>      <span class="main">⇒</span> <span class="free">unknown_flags</span> <span class="inner_quoted">''logic''</span> <span class="bound">f</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">semantics_TEST</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"Operand <span class="main">⇒</span> Operand <span class="main">⇒</span> state <span class="main">⇒</span> state"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">semantics_TEST</span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="main">≡</span> 
           <span class="keyword1">if</span> operand_size <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="main">=</span> <span class="numeral">32</span> <span class="keyword1">then</span> binop_flags <span class="main">(</span>logic_flags <span class="main">(</span><span class="keyword1">(AND)</span><span class="main">::</span><span class="numeral">256</span> word <span class="main">⇒</span> <span class="main">_</span> <span class="main">⇒</span> <span class="main">_</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span>
      <span class="keyword1">else</span> <span class="keyword1">if</span> operand_size <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="main">=</span> <span class="numeral">16</span> <span class="keyword1">then</span> binop_flags <span class="main">(</span>logic_flags <span class="main">(</span><span class="keyword1">(AND)</span><span class="main">::</span><span class="numeral">128</span> word <span class="main">⇒</span> <span class="main">_</span> <span class="main">⇒</span> <span class="main">_</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span>
      <span class="keyword1">else</span> <span class="keyword1">if</span> operand_size <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="main">=</span> <span class="numeral">8</span>  <span class="keyword1">then</span> binop_flags <span class="main">(</span>logic_flags <span class="main">(</span><span class="keyword1">(AND)</span><span class="main">::</span><span class="numeral">64</span>  word <span class="main">⇒</span> <span class="main">_</span> <span class="main">⇒</span> <span class="main">_</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span>
      <span class="keyword1">else</span> <span class="keyword1">if</span> operand_size <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="main">=</span> <span class="numeral">4</span>  <span class="keyword1">then</span> binop_flags <span class="main">(</span>logic_flags <span class="main">(</span><span class="keyword1">(AND)</span><span class="main">::</span><span class="numeral">32</span>  word <span class="main">⇒</span> <span class="main">_</span> <span class="main">⇒</span> <span class="main">_</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span>
      <span class="keyword1">else</span> <span class="keyword1">if</span> operand_size <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="main">=</span> <span class="numeral">2</span>  <span class="keyword1">then</span> binop_flags <span class="main">(</span>logic_flags <span class="main">(</span><span class="keyword1">(AND)</span><span class="main">::</span><span class="numeral">16</span>  word <span class="main">⇒</span> <span class="main">_</span> <span class="main">⇒</span> <span class="main">_</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span>
      <span class="keyword1">else</span> <span class="keyword1">if</span> operand_size <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="main">=</span> <span class="main">1</span>  <span class="keyword1">then</span> binop_flags <span class="main">(</span>logic_flags <span class="main">(</span><span class="keyword1">(AND)</span><span class="main">::</span><span class="numeral">8</span>   word <span class="main">⇒</span> <span class="main">_</span> <span class="main">⇒</span> <span class="main">_</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span>
      <span class="keyword1">else</span> undefined"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">TEST</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">TEST</span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="free"><span class="bound"><span class="entity">op2</span></span></span> <span class="main">≡</span> Instr <span class="inner_quoted">''test''</span> <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">op1</span></span></span><span class="main">)</span> <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">op2</span></span></span><span class="main">)</span> None"</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹ sign extension ›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">mov_sign_extension</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>len<span class="main">)</span> itself <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'b</span><span class="main">::</span>len<span class="main">)</span> itself <span class="main">⇒</span> Operand <span class="main">⇒</span> Operand <span class="main">⇒</span> state <span class="main">⇒</span> state"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">mov_sign_extension</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="free"><span class="bound"><span class="entity">op2</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">≡</span>
          <span class="keyword1">let</span> <span class="bound">src</span> <span class="main">=</span> ucast <span class="main">(</span>operand_read <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">op2</span></span></span><span class="main">)</span><span class="main">::</span><span class="tfree">'b</span> word <span class="keyword1">in</span>
             operand_write <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="main">(</span>ucast <span class="main">(</span>scast <span class="bound">src</span><span class="main">::</span><span class="tfree">'a</span> word<span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">semantics_MOVSXD</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"Operand <span class="main">⇒</span> Operand <span class="main">⇒</span> state <span class="main">⇒</span> state"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">semantics_MOVSXD</span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="free"><span class="bound"><span class="entity">op2</span></span></span> <span class="main">≡</span>
      <span class="keyword1">if</span> <span class="main">(</span>operand_size <span class="free"><span class="bound"><span class="entity">op1</span></span></span><span class="main">,</span> operand_size <span class="free"><span class="bound"><span class="entity">op2</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="numeral">8</span><span class="main">,</span><span class="numeral">4</span><span class="main">)</span> <span class="keyword1">then</span>
         mov_sign_extension <span class="main">(</span><span class="keyword1">TYPE</span><span class="main">(</span><span class="numeral">64</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">TYPE</span><span class="main">(</span><span class="numeral">32</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="free"><span class="bound"><span class="entity">op2</span></span></span>
      <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="main">(</span>operand_size <span class="free"><span class="bound"><span class="entity">op1</span></span></span><span class="main">,</span> operand_size <span class="free"><span class="bound"><span class="entity">op2</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="numeral">8</span><span class="main">,</span><span class="numeral">2</span><span class="main">)</span> <span class="keyword1">then</span>
         mov_sign_extension <span class="main">(</span><span class="keyword1">TYPE</span><span class="main">(</span><span class="numeral">64</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">TYPE</span><span class="main">(</span><span class="numeral">16</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="free"><span class="bound"><span class="entity">op2</span></span></span>
      <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="main">(</span>operand_size <span class="free"><span class="bound"><span class="entity">op1</span></span></span><span class="main">,</span> operand_size <span class="free"><span class="bound"><span class="entity">op2</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="numeral">8</span><span class="main">,</span><span class="main">1</span><span class="main">)</span> <span class="keyword1">then</span>
         mov_sign_extension <span class="main">(</span><span class="keyword1">TYPE</span><span class="main">(</span><span class="numeral">64</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">TYPE</span><span class="main">(</span><span class="numeral">8</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="free"><span class="bound"><span class="entity">op2</span></span></span>
      <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="main">(</span>operand_size <span class="free"><span class="bound"><span class="entity">op1</span></span></span><span class="main">,</span> operand_size <span class="free"><span class="bound"><span class="entity">op2</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="numeral">4</span><span class="main">,</span><span class="numeral">2</span><span class="main">)</span> <span class="keyword1">then</span>
         mov_sign_extension <span class="main">(</span><span class="keyword1">TYPE</span><span class="main">(</span><span class="numeral">32</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">TYPE</span><span class="main">(</span><span class="numeral">16</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="free"><span class="bound"><span class="entity">op2</span></span></span>
      <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="main">(</span>operand_size <span class="free"><span class="bound"><span class="entity">op1</span></span></span><span class="main">,</span> operand_size <span class="free"><span class="bound"><span class="entity">op2</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="numeral">4</span><span class="main">,</span><span class="main">1</span><span class="main">)</span> <span class="keyword1">then</span>
         mov_sign_extension <span class="main">(</span><span class="keyword1">TYPE</span><span class="main">(</span><span class="numeral">32</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">TYPE</span><span class="main">(</span><span class="numeral">8</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="free"><span class="bound"><span class="entity">op2</span></span></span>
      <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="main">(</span>operand_size <span class="free"><span class="bound"><span class="entity">op1</span></span></span><span class="main">,</span> operand_size <span class="free"><span class="bound"><span class="entity">op2</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="numeral">2</span><span class="main">,</span><span class="main">1</span><span class="main">)</span> <span class="keyword1">then</span>
         mov_sign_extension <span class="main">(</span><span class="keyword1">TYPE</span><span class="main">(</span><span class="numeral">16</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">TYPE</span><span class="main">(</span><span class="numeral">8</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="free"><span class="bound"><span class="entity">op2</span></span></span>
      <span class="keyword1">else</span>
        undefined"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">MOVSXD</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">MOVSXD</span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="free"><span class="bound"><span class="entity">op2</span></span></span> <span class="main">≡</span> Instr <span class="inner_quoted">''movsxd''</span> <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">op1</span></span></span><span class="main">)</span> <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">op2</span></span></span><span class="main">)</span> None"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">MOVSX</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">MOVSX</span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="free"><span class="bound"><span class="entity">op2</span></span></span> <span class="main">≡</span> Instr <span class="inner_quoted">''movsx''</span> <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">op1</span></span></span><span class="main">)</span> <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">op2</span></span></span><span class="main">)</span> None"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">semantics_CDQE</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"state <span class="main">⇒</span> state"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">semantics_CDQE</span> <span class="main">≡</span> semantics_MOVSXD <span class="main">(</span>Reg <span class="inner_quoted">''rax''</span><span class="main">)</span> <span class="main">(</span>Reg <span class="inner_quoted">''eax''</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">CDQE</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">CDQE</span> <span class="main">≡</span> Instr <span class="inner_quoted">''cdqe''</span> None None None"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">semantics_CDQ</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"state <span class="main">⇒</span> state"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">semantics_CDQ</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">≡</span>
          <span class="keyword1">let</span> <span class="bound">src</span> <span class="main">=</span> ucast <span class="main">(</span>operand_read <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">(</span>Reg <span class="inner_quoted">''eax''</span><span class="main">)</span><span class="main">)</span> <span class="main">::</span> <span class="numeral">32</span> word <span class="keyword1">in</span>
             operand_write <span class="main">(</span>Reg <span class="inner_quoted">''edx''</span><span class="main">)</span> <span class="main">(</span>ucast <span class="main">(</span><span class="main">⟨</span><span class="numeral">32</span><span class="main">,</span><span class="numeral">64</span><span class="main">⟩</span><span class="main">(</span>scast <span class="bound">src</span><span class="main">::</span><span class="numeral">64</span> word<span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">CDQ</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">CDQ</span> <span class="main">≡</span> Instr <span class="inner_quoted">''cdq''</span> None None None"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">semantics_CQO</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"state <span class="main">⇒</span> state"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">semantics_CQO</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">≡</span>
          <span class="keyword1">let</span> <span class="bound">src</span> <span class="main">=</span> ucast <span class="main">(</span>operand_read <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">(</span>Reg <span class="inner_quoted">''rax''</span><span class="main">)</span><span class="main">)</span> <span class="main">::</span> <span class="numeral">64</span> word <span class="keyword1">in</span>
             operand_write <span class="main">(</span>Reg <span class="inner_quoted">''rdx''</span><span class="main">)</span> <span class="main">(</span>ucast <span class="main">(</span><span class="main">⟨</span><span class="numeral">64</span><span class="main">,</span><span class="numeral">128</span><span class="main">⟩</span><span class="main">(</span>scast <span class="bound">src</span><span class="main">::</span><span class="numeral">128</span> word<span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">CQO</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">CQO</span> <span class="main">≡</span> Instr <span class="inner_quoted">''cqo''</span> None None None"</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹logic›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">semantics_AND</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"Operand <span class="main">⇒</span> Operand <span class="main">⇒</span> state <span class="main">⇒</span> state"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">semantics_AND</span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="free"><span class="bound"><span class="entity">op2</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">≡</span> 
           <span class="keyword1">if</span> operand_size <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="main">=</span> <span class="numeral">32</span> <span class="keyword1">then</span> binop <span class="main">(</span><span class="keyword1">(AND)</span><span class="main">::</span><span class="numeral">256</span> word <span class="main">⇒</span> <span class="main">_</span> <span class="main">⇒</span> <span class="main">_</span><span class="main">)</span> <span class="main">(</span>logic_flags <span class="main">(</span><span class="keyword1">(AND)</span><span class="main">::</span><span class="numeral">256</span> word <span class="main">⇒</span> <span class="main">_</span> <span class="main">⇒</span> <span class="main">_</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="free"><span class="bound"><span class="entity">op2</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span>
      <span class="keyword1">else</span> <span class="keyword1">if</span> operand_size <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="main">=</span> <span class="numeral">16</span> <span class="keyword1">then</span> binop <span class="main">(</span><span class="keyword1">(AND)</span><span class="main">::</span><span class="numeral">128</span> word <span class="main">⇒</span> <span class="main">_</span> <span class="main">⇒</span> <span class="main">_</span><span class="main">)</span> <span class="main">(</span>logic_flags <span class="main">(</span><span class="keyword1">(AND)</span><span class="main">::</span><span class="numeral">128</span> word <span class="main">⇒</span> <span class="main">_</span> <span class="main">⇒</span> <span class="main">_</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="free"><span class="bound"><span class="entity">op2</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span>
      <span class="keyword1">else</span> <span class="keyword1">if</span> operand_size <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="main">=</span> <span class="numeral">8</span>  <span class="keyword1">then</span> binop <span class="main">(</span><span class="keyword1">(AND)</span><span class="main">::</span><span class="numeral">64</span>  word <span class="main">⇒</span> <span class="main">_</span> <span class="main">⇒</span> <span class="main">_</span><span class="main">)</span> <span class="main">(</span>logic_flags <span class="main">(</span><span class="keyword1">(AND)</span><span class="main">::</span><span class="numeral">64</span>  word <span class="main">⇒</span> <span class="main">_</span> <span class="main">⇒</span> <span class="main">_</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="free"><span class="bound"><span class="entity">op2</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span>
      <span class="keyword1">else</span> <span class="keyword1">if</span> operand_size <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="main">=</span> <span class="numeral">4</span>  <span class="keyword1">then</span> binop <span class="main">(</span><span class="keyword1">(AND)</span><span class="main">::</span><span class="numeral">32</span>  word <span class="main">⇒</span> <span class="main">_</span> <span class="main">⇒</span> <span class="main">_</span><span class="main">)</span> <span class="main">(</span>logic_flags <span class="main">(</span><span class="keyword1">(AND)</span><span class="main">::</span><span class="numeral">32</span>  word <span class="main">⇒</span> <span class="main">_</span> <span class="main">⇒</span> <span class="main">_</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="free"><span class="bound"><span class="entity">op2</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span>
      <span class="keyword1">else</span> <span class="keyword1">if</span> operand_size <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="main">=</span> <span class="numeral">2</span>  <span class="keyword1">then</span> binop <span class="main">(</span><span class="keyword1">(AND)</span><span class="main">::</span><span class="numeral">16</span>  word <span class="main">⇒</span> <span class="main">_</span> <span class="main">⇒</span> <span class="main">_</span><span class="main">)</span> <span class="main">(</span>logic_flags <span class="main">(</span><span class="keyword1">(AND)</span><span class="main">::</span><span class="numeral">16</span>  word <span class="main">⇒</span> <span class="main">_</span> <span class="main">⇒</span> <span class="main">_</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="free"><span class="bound"><span class="entity">op2</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span>
      <span class="keyword1">else</span> <span class="keyword1">if</span> operand_size <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="main">=</span> <span class="main">1</span>  <span class="keyword1">then</span> binop <span class="main">(</span><span class="keyword1">(AND)</span><span class="main">::</span><span class="numeral">8</span>   word <span class="main">⇒</span> <span class="main">_</span> <span class="main">⇒</span> <span class="main">_</span><span class="main">)</span> <span class="main">(</span>logic_flags <span class="main">(</span><span class="keyword1">(AND)</span><span class="main">::</span><span class="numeral">8</span>   word <span class="main">⇒</span> <span class="main">_</span> <span class="main">⇒</span> <span class="main">_</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="free"><span class="bound"><span class="entity">op2</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span>
      <span class="keyword1">else</span> undefined"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">AND'</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">AND'</span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="free"><span class="bound"><span class="entity">op2</span></span></span> <span class="main">≡</span> Instr <span class="inner_quoted">''and''</span> <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">op1</span></span></span><span class="main">)</span> <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">op2</span></span></span><span class="main">)</span> None"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">semantics_OR</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"Operand <span class="main">⇒</span> Operand <span class="main">⇒</span> state <span class="main">⇒</span> state"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">semantics_OR</span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="free"><span class="bound"><span class="entity">op2</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">≡</span> 
           <span class="keyword1">if</span> operand_size <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="main">=</span> <span class="numeral">32</span> <span class="keyword1">then</span> binop <span class="main">(</span><span class="keyword1">(OR)</span><span class="main">::</span><span class="numeral">256</span> word <span class="main">⇒</span> <span class="main">_</span> <span class="main">⇒</span> <span class="main">_</span><span class="main">)</span> <span class="main">(</span>logic_flags <span class="main">(</span><span class="keyword1">(OR)</span><span class="main">::</span><span class="numeral">256</span> word <span class="main">⇒</span> <span class="main">_</span> <span class="main">⇒</span> <span class="main">_</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="free"><span class="bound"><span class="entity">op2</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span>
      <span class="keyword1">else</span> <span class="keyword1">if</span> operand_size <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="main">=</span> <span class="numeral">16</span> <span class="keyword1">then</span> binop <span class="main">(</span><span class="keyword1">(OR)</span><span class="main">::</span><span class="numeral">128</span> word <span class="main">⇒</span> <span class="main">_</span> <span class="main">⇒</span> <span class="main">_</span><span class="main">)</span> <span class="main">(</span>logic_flags <span class="main">(</span><span class="keyword1">(OR)</span><span class="main">::</span><span class="numeral">128</span> word <span class="main">⇒</span> <span class="main">_</span> <span class="main">⇒</span> <span class="main">_</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="free"><span class="bound"><span class="entity">op2</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span>
      <span class="keyword1">else</span> <span class="keyword1">if</span> operand_size <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="main">=</span> <span class="numeral">8</span>  <span class="keyword1">then</span> binop <span class="main">(</span><span class="keyword1">(OR)</span><span class="main">::</span><span class="numeral">64</span>  word <span class="main">⇒</span> <span class="main">_</span> <span class="main">⇒</span> <span class="main">_</span><span class="main">)</span> <span class="main">(</span>logic_flags <span class="main">(</span><span class="keyword1">(OR)</span><span class="main">::</span><span class="numeral">64</span>  word <span class="main">⇒</span> <span class="main">_</span> <span class="main">⇒</span> <span class="main">_</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="free"><span class="bound"><span class="entity">op2</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span>
      <span class="keyword1">else</span> <span class="keyword1">if</span> operand_size <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="main">=</span> <span class="numeral">4</span>  <span class="keyword1">then</span> binop <span class="main">(</span><span class="keyword1">(OR)</span><span class="main">::</span><span class="numeral">32</span>  word <span class="main">⇒</span> <span class="main">_</span> <span class="main">⇒</span> <span class="main">_</span><span class="main">)</span> <span class="main">(</span>logic_flags <span class="main">(</span><span class="keyword1">(OR)</span><span class="main">::</span><span class="numeral">32</span>  word <span class="main">⇒</span> <span class="main">_</span> <span class="main">⇒</span> <span class="main">_</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="free"><span class="bound"><span class="entity">op2</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span>
      <span class="keyword1">else</span> <span class="keyword1">if</span> operand_size <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="main">=</span> <span class="numeral">2</span>  <span class="keyword1">then</span> binop <span class="main">(</span><span class="keyword1">(OR)</span><span class="main">::</span><span class="numeral">16</span>  word <span class="main">⇒</span> <span class="main">_</span> <span class="main">⇒</span> <span class="main">_</span><span class="main">)</span> <span class="main">(</span>logic_flags <span class="main">(</span><span class="keyword1">(OR)</span><span class="main">::</span><span class="numeral">16</span>  word <span class="main">⇒</span> <span class="main">_</span> <span class="main">⇒</span> <span class="main">_</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="free"><span class="bound"><span class="entity">op2</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span>
      <span class="keyword1">else</span> <span class="keyword1">if</span> operand_size <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="main">=</span> <span class="main">1</span>  <span class="keyword1">then</span> binop <span class="main">(</span><span class="keyword1">(OR)</span><span class="main">::</span><span class="numeral">8</span>   word <span class="main">⇒</span> <span class="main">_</span> <span class="main">⇒</span> <span class="main">_</span><span class="main">)</span> <span class="main">(</span>logic_flags <span class="main">(</span><span class="keyword1">(OR)</span><span class="main">::</span><span class="numeral">8</span>   word <span class="main">⇒</span> <span class="main">_</span> <span class="main">⇒</span> <span class="main">_</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="free"><span class="bound"><span class="entity">op2</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span>
      <span class="keyword1">else</span> undefined"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">OR'</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">OR'</span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="free"><span class="bound"><span class="entity">op2</span></span></span> <span class="main">≡</span> Instr <span class="inner_quoted">''or''</span> <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">op1</span></span></span><span class="main">)</span> <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">op2</span></span></span><span class="main">)</span> None"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">semantics_XOR</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"Operand <span class="main">⇒</span> Operand <span class="main">⇒</span> state <span class="main">⇒</span> state"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">semantics_XOR</span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="free"><span class="bound"><span class="entity">op2</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">≡</span> 
           <span class="keyword1">if</span> operand_size <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="main">=</span> <span class="numeral">32</span> <span class="keyword1">then</span> binop <span class="main">(</span><span class="keyword1">(XOR)</span><span class="main">::</span><span class="numeral">256</span> word <span class="main">⇒</span> <span class="main">_</span> <span class="main">⇒</span> <span class="main">_</span><span class="main">)</span> <span class="main">(</span>logic_flags <span class="main">(</span><span class="keyword1">(XOR)</span><span class="main">::</span><span class="numeral">256</span> word <span class="main">⇒</span> <span class="main">_</span> <span class="main">⇒</span> <span class="main">_</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="free"><span class="bound"><span class="entity">op2</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span>
      <span class="keyword1">else</span> <span class="keyword1">if</span> operand_size <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="main">=</span> <span class="numeral">16</span> <span class="keyword1">then</span> binop <span class="main">(</span><span class="keyword1">(XOR)</span><span class="main">::</span><span class="numeral">128</span> word <span class="main">⇒</span> <span class="main">_</span> <span class="main">⇒</span> <span class="main">_</span><span class="main">)</span> <span class="main">(</span>logic_flags <span class="main">(</span><span class="keyword1">(XOR)</span><span class="main">::</span><span class="numeral">128</span> word <span class="main">⇒</span> <span class="main">_</span> <span class="main">⇒</span> <span class="main">_</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="free"><span class="bound"><span class="entity">op2</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span>
      <span class="keyword1">else</span> <span class="keyword1">if</span> operand_size <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="main">=</span> <span class="numeral">8</span>  <span class="keyword1">then</span> binop <span class="main">(</span><span class="keyword1">(XOR)</span><span class="main">::</span><span class="numeral">64</span>  word <span class="main">⇒</span> <span class="main">_</span> <span class="main">⇒</span> <span class="main">_</span><span class="main">)</span> <span class="main">(</span>logic_flags <span class="main">(</span><span class="keyword1">(XOR)</span><span class="main">::</span><span class="numeral">64</span>  word <span class="main">⇒</span> <span class="main">_</span> <span class="main">⇒</span> <span class="main">_</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="free"><span class="bound"><span class="entity">op2</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span>
      <span class="keyword1">else</span> <span class="keyword1">if</span> operand_size <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="main">=</span> <span class="numeral">4</span>  <span class="keyword1">then</span> binop <span class="main">(</span><span class="keyword1">(XOR)</span><span class="main">::</span><span class="numeral">32</span>  word <span class="main">⇒</span> <span class="main">_</span> <span class="main">⇒</span> <span class="main">_</span><span class="main">)</span> <span class="main">(</span>logic_flags <span class="main">(</span><span class="keyword1">(XOR)</span><span class="main">::</span><span class="numeral">32</span>  word <span class="main">⇒</span> <span class="main">_</span> <span class="main">⇒</span> <span class="main">_</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="free"><span class="bound"><span class="entity">op2</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span>
      <span class="keyword1">else</span> <span class="keyword1">if</span> operand_size <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="main">=</span> <span class="numeral">2</span>  <span class="keyword1">then</span> binop <span class="main">(</span><span class="keyword1">(XOR)</span><span class="main">::</span><span class="numeral">16</span>  word <span class="main">⇒</span> <span class="main">_</span> <span class="main">⇒</span> <span class="main">_</span><span class="main">)</span> <span class="main">(</span>logic_flags <span class="main">(</span><span class="keyword1">(XOR)</span><span class="main">::</span><span class="numeral">16</span>  word <span class="main">⇒</span> <span class="main">_</span> <span class="main">⇒</span> <span class="main">_</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="free"><span class="bound"><span class="entity">op2</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span>
      <span class="keyword1">else</span> <span class="keyword1">if</span> operand_size <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="main">=</span> <span class="main">1</span>  <span class="keyword1">then</span> binop <span class="main">(</span><span class="keyword1">(XOR)</span><span class="main">::</span><span class="numeral">8</span>   word <span class="main">⇒</span> <span class="main">_</span> <span class="main">⇒</span> <span class="main">_</span><span class="main">)</span> <span class="main">(</span>logic_flags <span class="main">(</span><span class="keyword1">(XOR)</span><span class="main">::</span><span class="numeral">8</span>   word <span class="main">⇒</span> <span class="main">_</span> <span class="main">⇒</span> <span class="main">_</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="free"><span class="bound"><span class="entity">op2</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span>
      <span class="keyword1">else</span> undefined"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">XOR'</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">XOR'</span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="free"><span class="bound"><span class="entity">op2</span></span></span> <span class="main">≡</span> Instr <span class="inner_quoted">''xor''</span> <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">op1</span></span></span><span class="main">)</span> <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">op2</span></span></span><span class="main">)</span> None"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">semantics_XORPS</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"Operand <span class="main">⇒</span> Operand <span class="main">⇒</span> state <span class="main">⇒</span> state"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">semantics_XORPS</span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="main">≡</span> 
           <span class="keyword1">if</span> operand_size <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="main">=</span> <span class="numeral">32</span> <span class="keyword1">then</span> binop_no_flags <span class="main">(</span><span class="keyword1">(XOR)</span><span class="main">::</span><span class="numeral">256</span> word <span class="main">⇒</span> <span class="main">_</span> <span class="main">⇒</span> <span class="main">_</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span>
      <span class="keyword1">else</span> <span class="keyword1">if</span> operand_size <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="main">=</span> <span class="numeral">16</span> <span class="keyword1">then</span> binop_no_flags <span class="main">(</span><span class="keyword1">(XOR)</span><span class="main">::</span><span class="numeral">128</span> word <span class="main">⇒</span> <span class="main">_</span> <span class="main">⇒</span> <span class="main">_</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span>
      <span class="keyword1">else</span> <span class="keyword1">if</span> operand_size <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="main">=</span> <span class="numeral">8</span>  <span class="keyword1">then</span> binop_no_flags <span class="main">(</span><span class="keyword1">(XOR)</span><span class="main">::</span><span class="numeral">64</span>  word <span class="main">⇒</span> <span class="main">_</span> <span class="main">⇒</span> <span class="main">_</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span>
      <span class="keyword1">else</span> <span class="keyword1">if</span> operand_size <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="main">=</span> <span class="numeral">4</span>  <span class="keyword1">then</span> binop_no_flags <span class="main">(</span><span class="keyword1">(XOR)</span><span class="main">::</span><span class="numeral">32</span>  word <span class="main">⇒</span> <span class="main">_</span> <span class="main">⇒</span> <span class="main">_</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span>
      <span class="keyword1">else</span> <span class="keyword1">if</span> operand_size <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="main">=</span> <span class="numeral">2</span>  <span class="keyword1">then</span> binop_no_flags <span class="main">(</span><span class="keyword1">(XOR)</span><span class="main">::</span><span class="numeral">16</span>  word <span class="main">⇒</span> <span class="main">_</span> <span class="main">⇒</span> <span class="main">_</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span>
      <span class="keyword1">else</span> <span class="keyword1">if</span> operand_size <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="main">=</span> <span class="main">1</span>  <span class="keyword1">then</span> binop_no_flags <span class="main">(</span><span class="keyword1">(XOR)</span><span class="main">::</span><span class="numeral">8</span>   word <span class="main">⇒</span> <span class="main">_</span> <span class="main">⇒</span> <span class="main">_</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span>
      <span class="keyword1">else</span> undefined"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">XORPS</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">XORPS</span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="free"><span class="bound"><span class="entity">op2</span></span></span> <span class="main">≡</span> Instr <span class="inner_quoted">''xorps''</span> <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">op1</span></span></span><span class="main">)</span> <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">op2</span></span></span><span class="main">)</span> None"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">semantics_NOT</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"Operand <span class="main">⇒</span> state <span class="main">⇒</span> state"</span></span> 
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">semantics_NOT</span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">≡</span> 
           <span class="keyword1">if</span> operand_size <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="main">=</span> <span class="numeral">32</span> <span class="keyword1">then</span> unop_no_flags <span class="main">(</span>not<span class="main">::</span><span class="numeral">256</span> word<span class="main">⇒</span><span class="main">_</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span>
      <span class="keyword1">else</span> <span class="keyword1">if</span> operand_size <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="main">=</span> <span class="numeral">16</span> <span class="keyword1">then</span> unop_no_flags <span class="main">(</span>not<span class="main">::</span><span class="numeral">128</span> word<span class="main">⇒</span><span class="main">_</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span>
      <span class="keyword1">else</span> <span class="keyword1">if</span> operand_size <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="main">=</span> <span class="numeral">8</span>  <span class="keyword1">then</span> unop_no_flags <span class="main">(</span>not<span class="main">::</span><span class="numeral">64</span>  word<span class="main">⇒</span><span class="main">_</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span>
      <span class="keyword1">else</span> <span class="keyword1">if</span> operand_size <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="main">=</span> <span class="numeral">4</span>  <span class="keyword1">then</span> unop_no_flags <span class="main">(</span>not<span class="main">::</span><span class="numeral">32</span>  word<span class="main">⇒</span><span class="main">_</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span>
      <span class="keyword1">else</span> <span class="keyword1">if</span> operand_size <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="main">=</span> <span class="numeral">2</span>  <span class="keyword1">then</span> unop_no_flags <span class="main">(</span>not<span class="main">::</span><span class="numeral">16</span>  word<span class="main">⇒</span><span class="main">_</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span>
      <span class="keyword1">else</span> <span class="keyword1">if</span> operand_size <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="main">=</span> <span class="main">1</span>  <span class="keyword1">then</span> unop_no_flags <span class="main">(</span>not<span class="main">::</span><span class="numeral">8</span>   word<span class="main">⇒</span><span class="main">_</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span>
      <span class="keyword1">else</span> undefined"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">NOT'</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">NOT'</span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="main">≡</span> Instr <span class="inner_quoted">''not''</span> <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">op1</span></span></span><span class="main">)</span> None None"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹ jumps ›</span></span>
<span class="keyword1"><span class="command">datatype</span></span> FlagExpr <span class="main">=</span> Flag <span class="quoted">string</span> <span class="main">|</span> FE_NOT <span class="quoted">FlagExpr</span> <span class="main">|</span> FE_AND <span class="quoted">FlagExpr</span> <span class="quoted">FlagExpr</span> <span class="main">|</span> FE_OR <span class="quoted">FlagExpr</span> <span class="quoted">FlagExpr</span> <span class="main">|</span> FE_EQ <span class="quoted">FlagExpr</span> <span class="quoted">FlagExpr</span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">readFlagExpr</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"FlagExpr <span class="main">⇒</span> state <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">readFlagExpr</span> <span class="main">(</span>Flag <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">=</span> <span class="main">(</span>flag_read <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">=</span> <span class="main">1</span><span class="main">)</span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">readFlagExpr</span> <span class="main">(</span>FE_NOT <span class="free"><span class="bound"><span class="entity">fe</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">¬</span><span class="free">readFlagExpr</span> <span class="free"><span class="bound"><span class="entity">fe</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span><span class="main">)</span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">readFlagExpr</span> <span class="main">(</span>FE_AND <span class="free"><span class="bound"><span class="entity">fe0</span></span></span> <span class="free"><span class="bound"><span class="entity">fe1</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="free">readFlagExpr</span> <span class="free"><span class="bound"><span class="entity">fe0</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">∧</span> <span class="free">readFlagExpr</span> <span class="free"><span class="bound"><span class="entity">fe1</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span><span class="main">)</span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">readFlagExpr</span> <span class="main">(</span>FE_OR <span class="free"><span class="bound"><span class="entity">fe0</span></span></span> <span class="free"><span class="bound"><span class="entity">fe1</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="free">readFlagExpr</span> <span class="free"><span class="bound"><span class="entity">fe0</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">∨</span> <span class="free">readFlagExpr</span> <span class="free"><span class="bound"><span class="entity">fe1</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span><span class="main">)</span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">readFlagExpr</span> <span class="main">(</span>FE_EQ <span class="free"><span class="bound"><span class="entity">fe0</span></span></span> <span class="free"><span class="bound"><span class="entity">fe1</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="free">readFlagExpr</span> <span class="free"><span class="bound"><span class="entity">fe0</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">⟷</span> <span class="free">readFlagExpr</span> <span class="free"><span class="bound"><span class="entity">fe1</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">semantics_cond_jump</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"FlagExpr <span class="main">⇒</span> <span class="numeral">64</span> word <span class="main">⇒</span> state <span class="main">⇒</span> state"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">semantics_cond_jump</span> <span class="free"><span class="bound"><span class="entity">fe</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">≡</span>
          <span class="keyword1">let</span> <span class="bound">fv</span> <span class="main">=</span> readFlagExpr <span class="free"><span class="bound"><span class="entity">fe</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="keyword1">in</span>
             <span class="keyword1">if</span> <span class="bound">fv</span> <span class="keyword1">then</span> state_update <span class="main">(</span><span class="keyword1">setRip</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="keyword1">else</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">semantics_JMP</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"Operand <span class="main">⇒</span> state <span class="main">⇒</span> state"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">semantics_JMP</span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">≡</span>
          <span class="keyword1">let</span> <span class="bound">a</span> <span class="main">=</span> ucast <span class="main">(</span>operand_read <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span><span class="main">)</span> <span class="keyword1">in</span>
            state_update <span class="main">(</span><span class="keyword1">setRip</span> <span class="bound">a</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">JMP</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">JMP</span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="main">≡</span> Instr <span class="inner_quoted">''jmp''</span> <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">op1</span></span></span><span class="main">)</span> None None"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">semantics_JO</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"Operand <span class="main">⇒</span> state <span class="main">⇒</span> state"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">semantics_JO</span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">≡</span>
          <span class="keyword1">let</span> <span class="bound">a</span> <span class="main">=</span> ucast <span class="main">(</span>operand_read <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span><span class="main">)</span> <span class="keyword1">in</span>
             semantics_cond_jump <span class="main">(</span>Flag <span class="inner_quoted">''of''</span><span class="main">)</span> <span class="bound">a</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">JO</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">JO</span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="main">≡</span> Instr <span class="inner_quoted">''jo''</span> <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">op1</span></span></span><span class="main">)</span> None None"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">semantics_JNO</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"Operand <span class="main">⇒</span> state <span class="main">⇒</span> state"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">semantics_JNO</span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">≡</span>
          <span class="keyword1">let</span> <span class="bound">a</span> <span class="main">=</span> ucast <span class="main">(</span>operand_read <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span><span class="main">)</span> <span class="keyword1">in</span>
             semantics_cond_jump <span class="main">(</span>FE_NOT <span class="main">(</span>Flag <span class="inner_quoted">''of''</span><span class="main">)</span><span class="main">)</span> <span class="bound">a</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">JNO</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">JNO</span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="main">≡</span> Instr <span class="inner_quoted">''jno''</span> <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">op1</span></span></span><span class="main">)</span> None None"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">semantics_JS</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"Operand <span class="main">⇒</span> state <span class="main">⇒</span> state"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">semantics_JS</span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">≡</span>
          <span class="keyword1">let</span> <span class="bound">a</span> <span class="main">=</span> ucast <span class="main">(</span>operand_read <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span><span class="main">)</span> <span class="keyword1">in</span>
             semantics_cond_jump <span class="main">(</span>Flag <span class="inner_quoted">''sf''</span><span class="main">)</span> <span class="bound">a</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">JS</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">JS</span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="main">≡</span> Instr <span class="inner_quoted">''js''</span> <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">op1</span></span></span><span class="main">)</span> None None"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">semantics_JNS</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"Operand <span class="main">⇒</span> state <span class="main">⇒</span> state"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">semantics_JNS</span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">≡</span>
          <span class="keyword1">let</span> <span class="bound">a</span> <span class="main">=</span> ucast <span class="main">(</span>operand_read <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span><span class="main">)</span> <span class="keyword1">in</span>
             semantics_cond_jump <span class="main">(</span>FE_NOT <span class="main">(</span>Flag <span class="inner_quoted">''sf''</span><span class="main">)</span><span class="main">)</span> <span class="bound">a</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">JNS</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">JNS</span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="main">≡</span> Instr <span class="inner_quoted">''jns''</span> <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">op1</span></span></span><span class="main">)</span> None None"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">semantics_JE</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"Operand <span class="main">⇒</span> state <span class="main">⇒</span> state"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">semantics_JE</span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">≡</span>
          <span class="keyword1">let</span> <span class="bound">a</span> <span class="main">=</span> ucast <span class="main">(</span>operand_read <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span><span class="main">)</span> <span class="keyword1">in</span>
             semantics_cond_jump <span class="main">(</span>Flag <span class="inner_quoted">''zf''</span><span class="main">)</span> <span class="bound">a</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">JE</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">JE</span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="main">≡</span> Instr <span class="inner_quoted">''je''</span> <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">op1</span></span></span><span class="main">)</span> None None"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">JZ</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">JZ</span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="main">≡</span> Instr <span class="inner_quoted">''jz''</span> <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">op1</span></span></span><span class="main">)</span> None None"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">semantics_JNE</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"Operand <span class="main">⇒</span> state <span class="main">⇒</span> state"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">semantics_JNE</span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">≡</span>
          <span class="keyword1">let</span> <span class="bound">a</span> <span class="main">=</span> ucast <span class="main">(</span>operand_read <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span><span class="main">)</span> <span class="keyword1">in</span>
             semantics_cond_jump <span class="main">(</span>FE_NOT <span class="main">(</span>Flag <span class="inner_quoted">''zf''</span><span class="main">)</span><span class="main">)</span> <span class="bound">a</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">JNE</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">JNE</span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="main">≡</span> Instr <span class="inner_quoted">''jne''</span> <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">op1</span></span></span><span class="main">)</span> None None"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">JNZ</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">JNZ</span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="main">≡</span> Instr <span class="inner_quoted">''jnz''</span> <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">op1</span></span></span><span class="main">)</span> None None"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">semantics_JB</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"Operand <span class="main">⇒</span> state <span class="main">⇒</span> state"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">semantics_JB</span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">≡</span>
          <span class="keyword1">let</span> <span class="bound">a</span> <span class="main">=</span> ucast <span class="main">(</span>operand_read <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span><span class="main">)</span> <span class="keyword1">in</span>
             semantics_cond_jump <span class="main">(</span>Flag <span class="inner_quoted">''cf''</span><span class="main">)</span> <span class="bound">a</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">JB</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">JB</span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="main">≡</span> Instr <span class="inner_quoted">''jb''</span> <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">op1</span></span></span><span class="main">)</span> None None"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">JNAE</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">JNAE</span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="main">≡</span> Instr <span class="inner_quoted">''jnae''</span> <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">op1</span></span></span><span class="main">)</span> None None"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">JC</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">JC</span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="main">≡</span> Instr <span class="inner_quoted">''jc''</span> <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">op1</span></span></span><span class="main">)</span> None None"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">semantics_JNB</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"Operand <span class="main">⇒</span> state <span class="main">⇒</span> state"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">semantics_JNB</span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">≡</span>
          <span class="keyword1">let</span> <span class="bound">a</span> <span class="main">=</span> ucast <span class="main">(</span>operand_read <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span><span class="main">)</span> <span class="keyword1">in</span>
             semantics_cond_jump <span class="main">(</span>FE_NOT <span class="main">(</span>Flag <span class="inner_quoted">''cf''</span><span class="main">)</span><span class="main">)</span> <span class="bound">a</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">JNB</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">JNB</span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="main">≡</span> Instr <span class="inner_quoted">''jnb''</span> <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">op1</span></span></span><span class="main">)</span> None None"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">JAE</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">JAE</span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="main">≡</span> Instr <span class="inner_quoted">''jae''</span> <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">op1</span></span></span><span class="main">)</span> None None"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">JNC</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">JNC</span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="main">≡</span> Instr <span class="inner_quoted">''jnc''</span> <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">op1</span></span></span><span class="main">)</span> None None"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">semantics_JBE</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"Operand <span class="main">⇒</span> state <span class="main">⇒</span> state"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">semantics_JBE</span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">≡</span>
          <span class="keyword1">let</span> <span class="bound">a</span> <span class="main">=</span> ucast <span class="main">(</span>operand_read <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span><span class="main">)</span> <span class="keyword1">in</span>
             semantics_cond_jump <span class="main">(</span>FE_OR <span class="main">(</span>Flag <span class="inner_quoted">''cf''</span><span class="main">)</span> <span class="main">(</span>Flag <span class="inner_quoted">''zf''</span><span class="main">)</span><span class="main">)</span> <span class="bound">a</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">JBE</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">JBE</span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="main">≡</span> Instr <span class="inner_quoted">''jbe''</span> <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">op1</span></span></span><span class="main">)</span> None None"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">JNA</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">JNA</span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="main">≡</span> Instr <span class="inner_quoted">''jna''</span> <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">op1</span></span></span><span class="main">)</span> None None"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">semantics_JA</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"Operand <span class="main">⇒</span> state <span class="main">⇒</span> state"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">semantics_JA</span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">≡</span>
          <span class="keyword1">let</span> <span class="bound">a</span> <span class="main">=</span> ucast <span class="main">(</span>operand_read <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span><span class="main">)</span> <span class="keyword1">in</span>
             semantics_cond_jump <span class="main">(</span>FE_AND <span class="main">(</span>FE_NOT <span class="main">(</span>Flag <span class="inner_quoted">''cf''</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>FE_NOT <span class="main">(</span>Flag <span class="inner_quoted">''zf''</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="bound">a</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">JA</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">JA</span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="main">≡</span> Instr <span class="inner_quoted">''ja''</span> <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">op1</span></span></span><span class="main">)</span> None None"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">JNBE</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">JNBE</span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="main">≡</span> Instr <span class="inner_quoted">''jnbe''</span> <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">op1</span></span></span><span class="main">)</span> None None"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">semantics_JL</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"Operand <span class="main">⇒</span> state <span class="main">⇒</span> state"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">semantics_JL</span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">≡</span>
          <span class="keyword1">let</span> <span class="bound">a</span> <span class="main">=</span> ucast <span class="main">(</span>operand_read <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span><span class="main">)</span> <span class="keyword1">in</span>
             semantics_cond_jump <span class="main">(</span>FE_NOT <span class="main">(</span>FE_EQ <span class="main">(</span>Flag <span class="inner_quoted">''sf''</span><span class="main">)</span> <span class="main">(</span>Flag <span class="inner_quoted">''of''</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="bound">a</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">JL</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">JL</span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="main">≡</span> Instr <span class="inner_quoted">''jl''</span> <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">op1</span></span></span><span class="main">)</span> None None"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">JNGE</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">JNGE</span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="main">≡</span> Instr <span class="inner_quoted">''jnge''</span> <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">op1</span></span></span><span class="main">)</span> None None"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">semantics_JGE</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"Operand <span class="main">⇒</span> state <span class="main">⇒</span> state"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">semantics_JGE</span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">≡</span>
          <span class="keyword1">let</span> <span class="bound">a</span> <span class="main">=</span> ucast <span class="main">(</span>operand_read <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span><span class="main">)</span> <span class="keyword1">in</span>
             semantics_cond_jump <span class="main">(</span>FE_EQ <span class="main">(</span>Flag <span class="inner_quoted">''sf''</span><span class="main">)</span> <span class="main">(</span>Flag <span class="inner_quoted">''of''</span><span class="main">)</span><span class="main">)</span> <span class="bound">a</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">JGE</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">JGE</span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="main">≡</span> Instr <span class="inner_quoted">''jge''</span> <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">op1</span></span></span><span class="main">)</span> None None"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">JNL</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">JNL</span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="main">≡</span> Instr <span class="inner_quoted">''jnl''</span> <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">op1</span></span></span><span class="main">)</span> None None"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">semantics_JLE</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"Operand <span class="main">⇒</span> state <span class="main">⇒</span> state"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">semantics_JLE</span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">≡</span>
          <span class="keyword1">let</span> <span class="bound">a</span> <span class="main">=</span> ucast <span class="main">(</span>operand_read <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span><span class="main">)</span> <span class="keyword1">in</span>
             semantics_cond_jump <span class="main">(</span>FE_OR <span class="main">(</span>Flag <span class="inner_quoted">''zf''</span><span class="main">)</span> <span class="main">(</span>FE_NOT <span class="main">(</span>FE_EQ <span class="main">(</span>Flag <span class="inner_quoted">''sf''</span><span class="main">)</span> <span class="main">(</span>Flag <span class="inner_quoted">''of''</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="bound">a</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">JLE</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">JLE</span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="main">≡</span> Instr <span class="inner_quoted">''jle''</span> <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">op1</span></span></span><span class="main">)</span> None None"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">JNG</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">JNG</span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="main">≡</span> Instr <span class="inner_quoted">''jng''</span> <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">op1</span></span></span><span class="main">)</span> None None"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">semantics_JG</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"Operand <span class="main">⇒</span> state <span class="main">⇒</span> state"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">semantics_JG</span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">≡</span>
          <span class="keyword1">let</span> <span class="bound">a</span> <span class="main">=</span> ucast <span class="main">(</span>operand_read <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span><span class="main">)</span> <span class="keyword1">in</span>
             semantics_cond_jump <span class="main">(</span>FE_AND <span class="main">(</span>FE_NOT <span class="main">(</span>Flag <span class="inner_quoted">''zf''</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>FE_EQ <span class="main">(</span>Flag <span class="inner_quoted">''sf''</span><span class="main">)</span> <span class="main">(</span>Flag <span class="inner_quoted">''of''</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="bound">a</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">JG</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">JG</span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="main">≡</span> Instr <span class="inner_quoted">''jg''</span> <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">op1</span></span></span><span class="main">)</span> None None"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">JNLE</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">JNLE</span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="main">≡</span> Instr <span class="inner_quoted">''jnle''</span> <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">op1</span></span></span><span class="main">)</span> None None"</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹ setXX ›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">semantics_setXX</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"FlagExpr <span class="main">⇒</span> Operand <span class="main">⇒</span> state <span class="main">⇒</span> state"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">semantics_setXX</span> <span class="free"><span class="bound"><span class="entity">fe</span></span></span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">≡</span>
          <span class="keyword1">let</span> <span class="bound">fv</span> <span class="main">=</span> readFlagExpr <span class="free"><span class="bound"><span class="entity">fe</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="keyword1">in</span>
             operand_write <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="main">(</span>fromBool <span class="bound">fv</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">semantics_SETO</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"Operand <span class="main">⇒</span> state <span class="main">⇒</span> state"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">semantics_SETO</span> <span class="main">≡</span> semantics_setXX <span class="main">(</span>Flag <span class="inner_quoted">''of''</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">SETO</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">SETO</span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="main">≡</span> Instr <span class="inner_quoted">''seto''</span> <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">op1</span></span></span><span class="main">)</span> None None"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">semantics_SETNO</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"Operand <span class="main">⇒</span> state <span class="main">⇒</span> state"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">semantics_SETNO</span> <span class="main">≡</span> semantics_setXX <span class="main">(</span>FE_NOT <span class="main">(</span>Flag <span class="inner_quoted">''of''</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">SETNO</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">SETNO</span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="main">≡</span> Instr <span class="inner_quoted">''setno''</span> <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">op1</span></span></span><span class="main">)</span> None None"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">semantics_SETS</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"Operand <span class="main">⇒</span> state <span class="main">⇒</span> state"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">semantics_SETS</span> <span class="main">≡</span> semantics_setXX <span class="main">(</span>Flag <span class="inner_quoted">''sf''</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">SETS</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">SETS</span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="main">≡</span> Instr <span class="inner_quoted">''sets''</span> <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">op1</span></span></span><span class="main">)</span> None None"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">semantics_SETNS</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"Operand <span class="main">⇒</span> state <span class="main">⇒</span> state"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">semantics_SETNS</span> <span class="main">≡</span> semantics_setXX <span class="main">(</span>FE_NOT <span class="main">(</span>Flag <span class="inner_quoted">''sf''</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">SETNS</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">SETNS</span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="main">≡</span> Instr <span class="inner_quoted">''setns''</span> <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">op1</span></span></span><span class="main">)</span> None None"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">semantics_SETE</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"Operand <span class="main">⇒</span> state <span class="main">⇒</span> state"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">semantics_SETE</span> <span class="main">≡</span> semantics_setXX <span class="main">(</span>Flag <span class="inner_quoted">''zf''</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">SETE</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">SETE</span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="main">≡</span> Instr <span class="inner_quoted">''sete''</span> <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">op1</span></span></span><span class="main">)</span> None None"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">SETZ</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">SETZ</span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="main">≡</span> Instr <span class="inner_quoted">''setz''</span> <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">op1</span></span></span><span class="main">)</span> None None"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">semantics_SETNE</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"Operand <span class="main">⇒</span> state <span class="main">⇒</span> state"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">semantics_SETNE</span> <span class="main">≡</span> semantics_setXX <span class="main">(</span>FE_NOT <span class="main">(</span>Flag <span class="inner_quoted">''zf''</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">SETNE</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">SETNE</span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="main">≡</span> Instr <span class="inner_quoted">''setne''</span> <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">op1</span></span></span><span class="main">)</span> None None"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">SETNZ</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">SETNZ</span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="main">≡</span> Instr <span class="inner_quoted">''setnz''</span> <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">op1</span></span></span><span class="main">)</span> None None"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">semantics_SETB</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"Operand <span class="main">⇒</span> state <span class="main">⇒</span> state"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">semantics_SETB</span> <span class="main">≡</span> semantics_setXX <span class="main">(</span>Flag <span class="inner_quoted">''cf''</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">SETB</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">SETB</span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="main">≡</span> Instr <span class="inner_quoted">''setb''</span> <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">op1</span></span></span><span class="main">)</span> None None"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">SETNAE</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">SETNAE</span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="main">≡</span> Instr <span class="inner_quoted">''setnae''</span> <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">op1</span></span></span><span class="main">)</span> None None"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">SETC</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">SETC</span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="main">≡</span> Instr <span class="inner_quoted">''setc''</span> <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">op1</span></span></span><span class="main">)</span> None None"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">semantics_SETNB</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"Operand <span class="main">⇒</span> state <span class="main">⇒</span> state"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">semantics_SETNB</span> <span class="main">≡</span> semantics_setXX <span class="main">(</span>FE_NOT <span class="main">(</span>Flag <span class="inner_quoted">''cf''</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">SETNB</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">SETNB</span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="main">≡</span> Instr <span class="inner_quoted">''setnb''</span> <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">op1</span></span></span><span class="main">)</span> None None"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">SETAE</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">SETAE</span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="main">≡</span> Instr <span class="inner_quoted">''setae''</span> <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">op1</span></span></span><span class="main">)</span> None None"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">SETNC</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">SETNC</span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="main">≡</span> Instr <span class="inner_quoted">''setnc''</span> <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">op1</span></span></span><span class="main">)</span> None None"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">semantics_SETBE</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"Operand <span class="main">⇒</span> state <span class="main">⇒</span> state"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">semantics_SETBE</span> <span class="main">≡</span> semantics_setXX <span class="main">(</span>FE_OR <span class="main">(</span>Flag <span class="inner_quoted">''cf''</span><span class="main">)</span> <span class="main">(</span>Flag <span class="inner_quoted">''zf''</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">SETBE</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">SETBE</span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="main">≡</span> Instr <span class="inner_quoted">''setbe''</span> <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">op1</span></span></span><span class="main">)</span> None None"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">SETNA</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">SETNA</span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="main">≡</span> Instr <span class="inner_quoted">''setna''</span> <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">op1</span></span></span><span class="main">)</span> None None"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">semantics_SETA</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"Operand <span class="main">⇒</span> state <span class="main">⇒</span> state"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">semantics_SETA</span> <span class="main">≡</span> semantics_setXX <span class="main">(</span>FE_AND <span class="main">(</span>FE_NOT <span class="main">(</span>Flag <span class="inner_quoted">''cf''</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>FE_NOT <span class="main">(</span>Flag <span class="inner_quoted">''zf''</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">SETA</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">SETA</span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="main">≡</span> Instr <span class="inner_quoted">''seta''</span> <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">op1</span></span></span><span class="main">)</span> None None"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">SETNBE</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">SETNBE</span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="main">≡</span> Instr <span class="inner_quoted">''setnbe''</span> <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">op1</span></span></span><span class="main">)</span> None None"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">semantics_SETL</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"Operand <span class="main">⇒</span> state <span class="main">⇒</span> state"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">semantics_SETL</span> <span class="main">≡</span> semantics_setXX <span class="main">(</span>FE_NOT <span class="main">(</span>FE_EQ <span class="main">(</span>Flag <span class="inner_quoted">''sf''</span><span class="main">)</span> <span class="main">(</span>Flag <span class="inner_quoted">''of''</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">SETL</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">SETL</span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="main">≡</span> Instr <span class="inner_quoted">''setl''</span> <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">op1</span></span></span><span class="main">)</span> None None"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">SETNGE</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">SETNGE</span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="main">≡</span> Instr <span class="inner_quoted">''setnge''</span> <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">op1</span></span></span><span class="main">)</span> None None"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">semantics_SETGE</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"Operand <span class="main">⇒</span> state <span class="main">⇒</span> state"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">semantics_SETGE</span> <span class="main">≡</span> semantics_setXX <span class="main">(</span>FE_EQ <span class="main">(</span>Flag <span class="inner_quoted">''sf''</span><span class="main">)</span> <span class="main">(</span>Flag <span class="inner_quoted">''of''</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">SETGE</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">SETGE</span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="main">≡</span> Instr <span class="inner_quoted">''setge''</span> <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">op1</span></span></span><span class="main">)</span> None None"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">SETNL</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">SETNL</span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="main">≡</span> Instr <span class="inner_quoted">''setnl''</span> <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">op1</span></span></span><span class="main">)</span> None None"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">semantics_SETLE</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"Operand <span class="main">⇒</span> state <span class="main">⇒</span> state"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">semantics_SETLE</span> <span class="main">≡</span> semantics_setXX <span class="main">(</span>FE_OR <span class="main">(</span>Flag <span class="inner_quoted">''zf''</span><span class="main">)</span> <span class="main">(</span>FE_NOT <span class="main">(</span>FE_EQ <span class="main">(</span>Flag <span class="inner_quoted">''sf''</span><span class="main">)</span> <span class="main">(</span>Flag <span class="inner_quoted">''of''</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">SETLE</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">SETLE</span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="main">≡</span> Instr <span class="inner_quoted">''setle''</span> <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">op1</span></span></span><span class="main">)</span> None None"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">SETNG</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">SETNG</span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="main">≡</span> Instr <span class="inner_quoted">''setng''</span> <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">op1</span></span></span><span class="main">)</span> None None"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">semantics_SETG</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"Operand <span class="main">⇒</span> state <span class="main">⇒</span> state"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">semantics_SETG</span> <span class="main">≡</span> semantics_setXX <span class="main">(</span>FE_AND <span class="main">(</span>FE_NOT <span class="main">(</span>Flag <span class="inner_quoted">''zf''</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>FE_EQ <span class="main">(</span>Flag <span class="inner_quoted">''sf''</span><span class="main">)</span> <span class="main">(</span>Flag <span class="inner_quoted">''of''</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">SETG</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">SETG</span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="main">≡</span> Instr <span class="inner_quoted">''setg''</span> <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">op1</span></span></span><span class="main">)</span> None None"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">SETNLE</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">SETNLE</span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="main">≡</span> Instr <span class="inner_quoted">''setnle''</span> <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">op1</span></span></span><span class="main">)</span> None None"</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹ conditional moves ›</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity"><span class="entity">cmov</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> 
    <span class="quoted"><span class="quoted"><span class="quoted">"<span class="free"><span class="free">cmov</span></span> True <span class="free"><span class="bound"><span class="entity"><span class="free"><span class="bound"><span class="entity">dst</span></span></span></span></span></span> <span class="free"><span class="bound"><span class="entity"><span class="free"><span class="bound"><span class="entity">src</span></span></span></span></span></span> <span class="main"><span class="main">=</span></span> <span class="free"><span class="bound"><span class="entity"><span class="free"><span class="bound"><span class="entity">src</span></span></span></span></span></span>"</span></span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="free"><span class="free">cmov</span></span> False <span class="free"><span class="bound"><span class="entity"><span class="free"><span class="bound"><span class="entity">dst</span></span></span></span></span></span> <span class="free"><span class="bound"><span class="entity"><span class="free"><span class="bound"><span class="entity">src</span></span></span></span></span></span> <span class="main"><span class="main">=</span></span> <span class="free"><span class="bound"><span class="entity"><span class="free"><span class="bound"><span class="entity">dst</span></span></span></span></span></span>"</span></span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">semantics_CMOV</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"FlagExpr <span class="main">⇒</span> Operand <span class="main">⇒</span> Operand <span class="main">⇒</span> state <span class="main">⇒</span> state"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">semantics_CMOV</span> <span class="free"><span class="bound"><span class="entity">fe</span></span></span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="free"><span class="bound"><span class="entity">op2</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">≡</span>
          <span class="keyword1">let</span> <span class="bound">fv</span> <span class="main">=</span> readFlagExpr <span class="free"><span class="bound"><span class="entity">fe</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span><span class="main">;</span>
              <span class="bound">dst</span> <span class="main">=</span> operand_read <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span><span class="main">;</span>
              <span class="bound">src</span> <span class="main">=</span> operand_read <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">op2</span></span></span> <span class="keyword1">in</span>
            operand_write <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="main">(</span>cmov <span class="bound">fv</span> <span class="bound">dst</span> <span class="bound">src</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">semantics_CMOVNE</span> <span class="main">≡</span> semantics_CMOV <span class="main">(</span>FE_NOT <span class="main">(</span>Flag <span class="inner_quoted">''zf''</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">CMOVNE</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">CMOVNE</span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="free"><span class="bound"><span class="entity">op2</span></span></span> <span class="main">≡</span> Instr <span class="inner_quoted">''movne''</span> <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">op1</span></span></span><span class="main">)</span> <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">op2</span></span></span><span class="main">)</span> None"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">semantics_CMOVNS</span> <span class="main">≡</span> semantics_CMOV <span class="main">(</span>FE_NOT <span class="main">(</span>Flag <span class="inner_quoted">''sf''</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">CMOVNS</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">CMOVNS</span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="free"><span class="bound"><span class="entity">op2</span></span></span> <span class="main">≡</span> Instr <span class="inner_quoted">''movns''</span> <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">op1</span></span></span><span class="main">)</span> <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">op2</span></span></span><span class="main">)</span> None"</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Floating Point›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">semantics_ADDSD</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"Operand <span class="main">⇒</span> Operand <span class="main">⇒</span> state <span class="main">⇒</span> state"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">semantics_ADDSD</span> <span class="main">≡</span> binop_XMM <span class="free">unknown_addsd</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">semantics_SUBSD</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"Operand <span class="main">⇒</span> Operand <span class="main">⇒</span> state <span class="main">⇒</span> state"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">semantics_SUBSD</span> <span class="main">≡</span> binop_XMM <span class="free">unknown_subsd</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">semantics_MULSD</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"Operand <span class="main">⇒</span> Operand <span class="main">⇒</span> state <span class="main">⇒</span> state"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">semantics_MULSD</span> <span class="main">≡</span> binop_XMM <span class="free">unknown_mulsd</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">semantics_DIVSD</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"Operand <span class="main">⇒</span> Operand <span class="main">⇒</span> state <span class="main">⇒</span> state"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">semantics_DIVSD</span> <span class="main">≡</span> binop_XMM <span class="free">unknown_divsd</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">UCOMISD_flags</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="numeral">64</span> word <span class="main">⇒</span> <span class="numeral">64</span> word <span class="main">⇒</span> string <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">UCOMISD_flags</span> <span class="free"><span class="bound"><span class="entity">w0</span></span></span> <span class="free"><span class="bound"><span class="entity">w1</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">≡</span> 
  <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">∈</span> <span class="main">{</span><span class="inner_quoted">''zf''</span><span class="main">,</span><span class="inner_quoted">''pf''</span><span class="main">,</span><span class="inner_quoted">''cf''</span><span class="main">}</span> <span class="keyword1">then</span> <span class="keyword1">case</span> <span class="free">unknown_ucomisd</span> <span class="free"><span class="bound"><span class="entity">w0</span></span></span> <span class="free"><span class="bound"><span class="entity">w1</span></span></span> <span class="keyword1">of</span>
      FP_Unordered <span class="main">⇒</span> True
    <span class="main">|</span> FP_GT        <span class="main">⇒</span> False
    <span class="main">|</span> FP_LT        <span class="main">⇒</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">=</span> <span class="inner_quoted">''cf''</span>
    <span class="main">|</span> FP_EQ        <span class="main">⇒</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">=</span> <span class="inner_quoted">''zf''</span>
  <span class="keyword1">else</span>
    <span class="free">unknown_flags</span> <span class="inner_quoted">''UCOMISD''</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">semantics_UCOMISD</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"Operand <span class="main">⇒</span> Operand <span class="main">⇒</span> state <span class="main">⇒</span> state"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">semantics_UCOMISD</span> <span class="main">≡</span> binop_flags UCOMISD_flags"</span></span>


<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">ADDSD</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">ADDSD</span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="free"><span class="bound"><span class="entity">op2</span></span></span> <span class="main">≡</span> Instr <span class="inner_quoted">''addsd''</span> <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">op1</span></span></span><span class="main">)</span> <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">op2</span></span></span><span class="main">)</span> None"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">SUBSD</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">SUBSD</span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="free"><span class="bound"><span class="entity">op2</span></span></span> <span class="main">≡</span> Instr <span class="inner_quoted">''subsd''</span> <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">op1</span></span></span><span class="main">)</span> <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">op2</span></span></span><span class="main">)</span> None"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">MULSD</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">MULSD</span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="free"><span class="bound"><span class="entity">op2</span></span></span> <span class="main">≡</span> Instr <span class="inner_quoted">''mulsd''</span> <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">op1</span></span></span><span class="main">)</span> <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">op2</span></span></span><span class="main">)</span> None"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">DIVSD</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">DIVSD</span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="free"><span class="bound"><span class="entity">op2</span></span></span> <span class="main">≡</span> Instr <span class="inner_quoted">''divsd''</span> <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">op1</span></span></span><span class="main">)</span> <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">op2</span></span></span><span class="main">)</span> None"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">UCOMISD</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">UCOMISD</span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="free"><span class="bound"><span class="entity">op2</span></span></span> <span class="main">≡</span> Instr <span class="inner_quoted">''ucomisd''</span> <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">op1</span></span></span><span class="main">)</span> <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">op2</span></span></span><span class="main">)</span> None"</span></span>



<span class="comment1">(* SIMD *)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">simd_32_128</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="numeral">32</span> word <span class="main">⇒</span> <span class="numeral">32</span> word <span class="main">⇒</span> <span class="numeral">32</span> word<span class="main">)</span> <span class="main">⇒</span> <span class="numeral">128</span> word <span class="main">⇒</span> <span class="numeral">128</span> word <span class="main">⇒</span> <span class="numeral">128</span> word"</span></span> 
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">simd_32_128</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">dst</span></span></span> <span class="free"><span class="bound"><span class="entity">src</span></span></span> <span class="main">≡</span> 
            <span class="main">(</span><span class="main">(</span>ucast <span class="main">(</span><span class="main">⟨</span><span class="main">0</span><span class="main">,</span><span class="numeral">32</span><span class="main">⟩</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>ucast <span class="main">(</span><span class="main">⟨</span><span class="numeral">96</span><span class="main">,</span><span class="numeral">128</span><span class="main">⟩</span><span class="free"><span class="bound"><span class="entity">dst</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>ucast <span class="main">(</span><span class="main">⟨</span><span class="numeral">96</span><span class="main">,</span><span class="numeral">128</span><span class="main">⟩</span><span class="free"><span class="bound"><span class="entity">src</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">&lt;&lt;</span> <span class="numeral">96</span><span class="main">)</span> <span class="keyword1">OR</span>
            <span class="main">(</span><span class="main">(</span>ucast <span class="main">(</span><span class="main">⟨</span><span class="main">0</span><span class="main">,</span><span class="numeral">32</span><span class="main">⟩</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>ucast <span class="main">(</span><span class="main">⟨</span><span class="numeral">64</span><span class="main">,</span><span class="numeral">96</span><span class="main">⟩</span><span class="free"><span class="bound"><span class="entity">dst</span></span></span><span class="main">)</span><span class="main">)</span>  <span class="main">(</span>ucast <span class="main">(</span><span class="main">⟨</span><span class="numeral">64</span><span class="main">,</span><span class="numeral">96</span><span class="main">⟩</span><span class="free"><span class="bound"><span class="entity">src</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">&lt;&lt;</span> <span class="numeral">64</span><span class="main">)</span>  <span class="keyword1">OR</span>
            <span class="main">(</span><span class="main">(</span>ucast <span class="main">(</span><span class="main">⟨</span><span class="main">0</span><span class="main">,</span><span class="numeral">32</span><span class="main">⟩</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>ucast <span class="main">(</span><span class="main">⟨</span><span class="numeral">32</span><span class="main">,</span><span class="numeral">64</span><span class="main">⟩</span><span class="free"><span class="bound"><span class="entity">dst</span></span></span><span class="main">)</span><span class="main">)</span>  <span class="main">(</span>ucast <span class="main">(</span><span class="main">⟨</span><span class="numeral">32</span><span class="main">,</span><span class="numeral">64</span><span class="main">⟩</span><span class="free"><span class="bound"><span class="entity">src</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">&lt;&lt;</span> <span class="numeral">32</span><span class="main">)</span>  <span class="keyword1">OR</span>
             <span class="main">(</span>ucast <span class="main">(</span><span class="main">⟨</span><span class="main">0</span><span class="main">,</span><span class="numeral">32</span><span class="main">⟩</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>ucast <span class="main">(</span><span class="main">⟨</span><span class="main">0</span><span class="main">,</span><span class="numeral">32</span><span class="main">⟩</span><span class="free"><span class="bound"><span class="entity">dst</span></span></span><span class="main">)</span><span class="main">)</span>   <span class="main">(</span>ucast <span class="main">(</span><span class="main">⟨</span><span class="main">0</span><span class="main">,</span><span class="numeral">32</span><span class="main">⟩</span><span class="free"><span class="bound"><span class="entity">src</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">semantics_PADDD</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"Operand <span class="main">⇒</span> Operand <span class="main">⇒</span> state <span class="main">⇒</span> state"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">semantics_PADDD</span> <span class="main">≡</span> binop_no_flags <span class="main">(</span>simd_32_128 <span class="main">(+)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">PADDD</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">PADDD</span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="free"><span class="bound"><span class="entity">op2</span></span></span> <span class="main">≡</span> Instr <span class="inner_quoted">''paddd''</span> <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">op1</span></span></span><span class="main">)</span> <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">op2</span></span></span><span class="main">)</span> None"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">pshufd</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="numeral">128</span> word <span class="main">⇒</span> <span class="numeral">8</span> word <span class="main">⇒</span> <span class="numeral">128</span> word"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">pshufd</span> <span class="free"><span class="bound"><span class="entity">src</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="main">(</span><span class="main">⟨</span><span class="main">0</span><span class="main">,</span><span class="numeral">32</span><span class="main">⟩</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">src</span></span></span> <span class="main">&gt;&gt;</span> <span class="main">(</span>unat <span class="main">(</span><span class="main">⟨</span><span class="numeral">6</span><span class="main">,</span><span class="numeral">8</span><span class="main">⟩</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span><span class="main">*</span><span class="numeral">32</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">&lt;&lt;</span> <span class="numeral">96</span><span class="main">)</span> <span class="keyword1">OR</span>
                        <span class="main">(</span><span class="main">(</span><span class="main">⟨</span><span class="main">0</span><span class="main">,</span><span class="numeral">32</span><span class="main">⟩</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">src</span></span></span> <span class="main">&gt;&gt;</span> <span class="main">(</span>unat <span class="main">(</span><span class="main">⟨</span><span class="numeral">4</span><span class="main">,</span><span class="numeral">6</span><span class="main">⟩</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span><span class="main">*</span><span class="numeral">32</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">&lt;&lt;</span> <span class="numeral">64</span><span class="main">)</span> <span class="keyword1">OR</span>
                        <span class="main">(</span><span class="main">(</span><span class="main">⟨</span><span class="main">0</span><span class="main">,</span><span class="numeral">32</span><span class="main">⟩</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">src</span></span></span> <span class="main">&gt;&gt;</span> <span class="main">(</span>unat <span class="main">(</span><span class="main">⟨</span><span class="numeral">2</span><span class="main">,</span><span class="numeral">4</span><span class="main">⟩</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span><span class="main">*</span><span class="numeral">32</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">&lt;&lt;</span> <span class="numeral">32</span><span class="main">)</span> <span class="keyword1">OR</span>
                        <span class="main">(</span><span class="main">(</span><span class="main">⟨</span><span class="main">0</span><span class="main">,</span><span class="numeral">32</span><span class="main">⟩</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">src</span></span></span> <span class="main">&gt;&gt;</span> <span class="main">(</span>unat <span class="main">(</span><span class="main">⟨</span><span class="main">0</span><span class="main">,</span><span class="numeral">2</span><span class="main">⟩</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span><span class="main">*</span><span class="numeral">32</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> pshufd_numeral<span class="main">[</span><span class="operator">simp</span><span class="main">]</span> <span class="main">=</span> pshufd_def<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"numeral <span class="free">n</span>"</span></span><span class="main">]</span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">n</span>
<span class="keyword1"><span class="command">lemmas</span></span> pshufd_0<span class="main">[</span><span class="operator">simp</span><span class="main">]</span> <span class="main">=</span> pshufd_def<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="main">0</span></span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> pshufd_1<span class="main">[</span><span class="operator">simp</span><span class="main">]</span> <span class="main">=</span> pshufd_def<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="main">1</span></span><span class="main">]</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">semantics_PSHUFD</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"Operand <span class="main">⇒</span> Operand <span class="main">⇒</span> Operand <span class="main">⇒</span> state <span class="main">⇒</span> state"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">semantics_PSHUFD</span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="free"><span class="bound"><span class="entity">op2</span></span></span> <span class="free"><span class="bound"><span class="entity">op3</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">≡</span> 
    <span class="keyword1">let</span> <span class="bound">src</span> <span class="main">=</span> ucast <span class="main">(</span>operand_read <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">op2</span></span></span><span class="main">)</span><span class="main">;</span>
        <span class="bound">n</span>   <span class="main">=</span> ucast <span class="main">(</span>operand_read <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">op3</span></span></span><span class="main">)</span> <span class="keyword1">in</span>
      operand_write <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="main">(</span>ucast <span class="main">(</span>pshufd <span class="bound">src</span> <span class="bound">n</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">PSHUFD</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">PSHUFD</span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="free"><span class="bound"><span class="entity">op2</span></span></span> <span class="free"><span class="bound"><span class="entity">op3</span></span></span> <span class="main">≡</span> Instr <span class="inner_quoted">''pshufd''</span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="free"><span class="bound"><span class="entity">op2</span></span></span> <span class="free"><span class="bound"><span class="entity">op3</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">semantics_PEXTRD</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"Operand <span class="main">⇒</span> Operand <span class="main">⇒</span> Operand <span class="main">⇒</span> state <span class="main">⇒</span> state"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">semantics_PEXTRD</span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="free"><span class="bound"><span class="entity">op2</span></span></span> <span class="free"><span class="bound"><span class="entity">op3</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">≡</span>
          <span class="keyword1">let</span> <span class="bound">src</span> <span class="main">=</span> operand_read <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">op2</span></span></span><span class="main">;</span>
              <span class="bound">n</span>   <span class="main">=</span> unat <span class="main">(</span>operand_read <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">op3</span></span></span><span class="main">)</span> <span class="keyword1">mod</span> <span class="numeral">4</span> <span class="keyword1">in</span>
             operand_write <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="main">(</span>ucast <span class="main">(</span><span class="main">(</span><span class="main">⟨</span><span class="main">0</span><span class="main">,</span><span class="numeral">32</span><span class="main">⟩</span><span class="main">(</span><span class="bound">src</span> <span class="main">&gt;&gt;</span> <span class="bound">n</span><span class="main">*</span><span class="numeral">32</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">PEXTRD</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">PEXTRD</span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="free"><span class="bound"><span class="entity">op2</span></span></span> <span class="free"><span class="bound"><span class="entity">op3</span></span></span> <span class="main">≡</span> Instr <span class="inner_quoted">''pextrd''</span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="free"><span class="bound"><span class="entity">op2</span></span></span> <span class="free"><span class="bound"><span class="entity">op3</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">semantics_PINSRD</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"Operand <span class="main">⇒</span> Operand <span class="main">⇒</span> Operand <span class="main">⇒</span> state <span class="main">⇒</span> state"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">semantics_PINSRD</span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="free"><span class="bound"><span class="entity">op2</span></span></span> <span class="free"><span class="bound"><span class="entity">op3</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">≡</span>
          <span class="keyword1">let</span> <span class="bound">dst</span> <span class="main">=</span> ucast <span class="main">(</span>operand_read <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span><span class="main">)</span><span class="main">::</span><span class="numeral">128</span> word<span class="main">;</span>
              <span class="bound">src</span> <span class="main">=</span> ucast <span class="main">(</span>operand_read <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">op2</span></span></span><span class="main">)</span><span class="main">::</span><span class="numeral">128</span> word<span class="main">;</span>
              <span class="bound">n</span>   <span class="main">=</span> unat <span class="main">(</span>operand_read <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">op3</span></span></span><span class="main">)</span> <span class="keyword1">mod</span> <span class="numeral">4</span><span class="main">;</span>
              <span class="bound">m</span>   <span class="main">=</span> <span class="numeral">0xFFFFFFFF</span> <span class="main">&lt;&lt;</span> <span class="main">(</span><span class="bound">n</span> <span class="main">*</span> <span class="numeral">32</span><span class="main">)</span> <span class="main">::</span> <span class="numeral">128</span> word<span class="main">;</span>
              <span class="bound">t</span>   <span class="main">=</span> <span class="main">(</span><span class="bound">src</span> <span class="main">&lt;&lt;</span> <span class="main">(</span><span class="bound">n</span> <span class="main">*</span><span class="numeral">32</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">AND</span> <span class="bound">m</span> <span class="keyword1">in</span>
             operand_write <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="main">(</span>ucast <span class="main">(</span><span class="main">(</span><span class="bound">dst</span> <span class="keyword1">AND</span> <span class="keyword1">NOT</span> <span class="bound">m</span><span class="main">)</span> <span class="keyword1">OR</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">PINSRD</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">PINSRD</span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="free"><span class="bound"><span class="entity">op2</span></span></span> <span class="free"><span class="bound"><span class="entity">op3</span></span></span> <span class="main">≡</span> Instr <span class="inner_quoted">''pinsrd''</span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="free"><span class="bound"><span class="entity">op2</span></span></span> <span class="free"><span class="bound"><span class="entity">op3</span></span></span>"</span></span>


<span class="comment1">(* remainder *)</span>



<span class="keyword1"><span class="command">definition</span></span> <span class="entity">bswap</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="numeral">32</span> word <span class="main">⇒</span> <span class="numeral">32</span> word"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">bswap</span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="main">(</span><span class="main">⟨</span><span class="main">0</span><span class="main">,</span><span class="numeral">8</span><span class="main">⟩</span><span class="free"><span class="bound"><span class="entity">w</span></span></span><span class="main">)</span> <span class="main">&lt;&lt;</span> <span class="numeral">24</span><span class="main">)</span> <span class="keyword1">OR</span> <span class="main">(</span><span class="main">(</span><span class="main">⟨</span><span class="numeral">8</span><span class="main">,</span><span class="numeral">16</span><span class="main">⟩</span><span class="free"><span class="bound"><span class="entity">w</span></span></span><span class="main">)</span> <span class="main">&lt;&lt;</span> <span class="numeral">16</span><span class="main">)</span> <span class="keyword1">OR</span> <span class="main">(</span><span class="main">(</span><span class="main">⟨</span><span class="numeral">16</span><span class="main">,</span><span class="numeral">24</span><span class="main">⟩</span><span class="free"><span class="bound"><span class="entity">w</span></span></span><span class="main">)</span> <span class="main">&lt;&lt;</span> <span class="numeral">8</span><span class="main">)</span> <span class="keyword1">OR</span> <span class="main">(</span><span class="main">⟨</span><span class="numeral">24</span><span class="main">,</span><span class="numeral">32</span><span class="main">⟩</span><span class="free"><span class="bound"><span class="entity">w</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> bswap_numeral<span class="main">[</span><span class="operator">simp</span><span class="main">]</span> <span class="main">=</span> bswap_def<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"numeral <span class="free">n</span>"</span></span><span class="main">]</span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">n</span>
<span class="keyword1"><span class="command">lemmas</span></span> bswap_0<span class="main">[</span><span class="operator">simp</span><span class="main">]</span> <span class="main">=</span> bswap_def<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="main">0</span></span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> bswap_1<span class="main">[</span><span class="operator">simp</span><span class="main">]</span> <span class="main">=</span> bswap_def<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="main">1</span></span><span class="main">]</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">semantics_BSWAP</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"Operand <span class="main">⇒</span> state <span class="main">⇒</span> state"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">semantics_BSWAP</span> <span class="main">≡</span> unop_no_flags bswap"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">BSWAP</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">BSWAP</span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="main">≡</span> Instr <span class="inner_quoted">''bswap''</span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span> None None"</span></span>



<span class="keyword1"><span class="command">definition</span></span> <span class="entity">semantics_NOP</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"state <span class="main">⇒</span> state"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">semantics_NOP</span> <span class="main">≡</span> id"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">NOP0</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">NOP0</span> <span class="main">≡</span> Instr <span class="inner_quoted">''nop''</span> None None None"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">NOP1</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">NOP1</span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="main">≡</span> Instr <span class="inner_quoted">''nop''</span> <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">op1</span></span></span><span class="main">)</span> None None"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">NOP2</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">NOP2</span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="free"><span class="bound"><span class="entity">op2</span></span></span> <span class="main">≡</span> Instr <span class="inner_quoted">''nop''</span> <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">op1</span></span></span><span class="main">)</span> <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">op2</span></span></span><span class="main">)</span> None"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">NOP3</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">NOP3</span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="free"><span class="bound"><span class="entity">op2</span></span></span> <span class="free"><span class="bound"><span class="entity">op3</span></span></span> <span class="main">≡</span> Instr <span class="inner_quoted">''nop''</span> <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">op1</span></span></span><span class="main">)</span> <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">op2</span></span></span><span class="main">)</span> <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">op3</span></span></span><span class="main">)</span>"</span></span>



<span class="keyword1"><span class="command">definition</span></span> <span class="entity">semantics</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">semantics</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">≡</span>
  <span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="keyword1">of</span>
    <span class="main">(</span>Instr <span class="inner_quoted">''mov''</span>     <span class="main">(</span>Some <span class="bound">op1</span><span class="main">)</span> <span class="main">(</span>Some <span class="bound">op2</span><span class="main">)</span> <span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span><span class="main">)</span>          <span class="main">⇒</span> semantics_MOV <span class="bound">op1</span> <span class="bound">op2</span>
  <span class="main">|</span> <span class="main">(</span>Instr <span class="inner_quoted">''movabs''</span>  <span class="main">(</span>Some <span class="bound">op1</span><span class="main">)</span> <span class="main">(</span>Some <span class="bound">op2</span><span class="main">)</span> <span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span><span class="main">)</span>          <span class="main">⇒</span> semantics_MOV <span class="bound">op1</span> <span class="bound">op2</span>
  <span class="main">|</span> <span class="main">(</span>Instr <span class="inner_quoted">''movaps''</span>  <span class="main">(</span>Some <span class="bound">op1</span><span class="main">)</span> <span class="main">(</span>Some <span class="bound">op2</span><span class="main">)</span> <span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span><span class="main">)</span>          <span class="main">⇒</span> semantics_MOV <span class="bound">op1</span> <span class="bound">op2</span>
  <span class="main">|</span> <span class="main">(</span>Instr <span class="inner_quoted">''movdqu''</span>  <span class="main">(</span>Some <span class="bound">op1</span><span class="main">)</span> <span class="main">(</span>Some <span class="bound">op2</span><span class="main">)</span> <span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span><span class="main">)</span>          <span class="main">⇒</span> semantics_MOV <span class="bound">op1</span> <span class="bound">op2</span>
  <span class="main">|</span> <span class="main">(</span>Instr <span class="inner_quoted">''movd''</span>    <span class="main">(</span>Some <span class="bound">op1</span><span class="main">)</span> <span class="main">(</span>Some <span class="bound">op2</span><span class="main">)</span> <span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span><span class="main">)</span>          <span class="main">⇒</span> semantics_MOVD <span class="bound">op1</span> <span class="bound">op2</span>
  <span class="main">|</span> <span class="main">(</span>Instr <span class="inner_quoted">''movzx''</span>   <span class="main">(</span>Some <span class="bound">op1</span><span class="main">)</span> <span class="main">(</span>Some <span class="bound">op2</span><span class="main">)</span> <span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span><span class="main">)</span>          <span class="main">⇒</span> semantics_MOV <span class="bound">op1</span> <span class="bound">op2</span>
  <span class="main">|</span> <span class="main">(</span>Instr <span class="inner_quoted">''movsd''</span>   <span class="main">(</span>Some <span class="bound">op1</span><span class="main">)</span> <span class="main">(</span>Some <span class="bound">op2</span><span class="main">)</span> <span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span><span class="main">)</span>          <span class="main">⇒</span> semantics_MOVSD <span class="bound">op1</span> <span class="bound">op2</span>
  <span class="main">|</span> <span class="main">(</span>Instr <span class="inner_quoted">''movq''</span>    <span class="main">(</span>Some <span class="bound">op1</span><span class="main">)</span> <span class="main">(</span>Some <span class="bound">op2</span><span class="main">)</span> <span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span><span class="main">)</span>          <span class="main">⇒</span> semantics_MOVSD <span class="bound">op1</span> <span class="bound">op2</span>
  <span class="main">|</span> <span class="main">(</span>Instr <span class="inner_quoted">''lea''</span>     <span class="main">(</span>Some <span class="bound">op1</span><span class="main">)</span> <span class="main">(</span>Some <span class="bound">op2</span><span class="main">)</span> <span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span><span class="main">)</span>          <span class="main">⇒</span> semantics_LEA <span class="bound">op1</span> <span class="bound">op2</span>
  <span class="main">|</span> <span class="main">(</span>Instr <span class="inner_quoted">''push''</span>    <span class="main">(</span>Some <span class="bound">op1</span><span class="main">)</span> <span class="main"><span class="bound">_</span></span>          <span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span><span class="main">)</span>          <span class="main">⇒</span> semantics_PUSH <span class="bound">op1</span>
  <span class="main">|</span> <span class="main">(</span>Instr <span class="inner_quoted">''pop''</span>     <span class="main">(</span>Some <span class="bound">op1</span><span class="main">)</span> <span class="main"><span class="bound">_</span></span>          <span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span><span class="main">)</span>          <span class="main">⇒</span> semantics_POP <span class="bound">op1</span>
  <span class="main">|</span> <span class="main">(</span>Instr <span class="inner_quoted">''ret''</span>     <span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span><span class="main">)</span>                            <span class="main">⇒</span> semantics_RET
  <span class="main">|</span> <span class="main">(</span>Instr <span class="inner_quoted">''call''</span>    <span class="main">(</span>Some <span class="bound">op1</span><span class="main">)</span> <span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span><span class="main">)</span>                   <span class="main">⇒</span> semantics_CALL <span class="bound">op1</span>
  <span class="main">|</span> <span class="main">(</span>Instr <span class="inner_quoted">''leave''</span>   <span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span><span class="main">)</span>                            <span class="main">⇒</span> semantics_LEAVE
  <span class="comment1">― ‹arithmetic›</span>                                           
  <span class="main">|</span> <span class="main">(</span>Instr <span class="inner_quoted">''add''</span>     <span class="main">(</span>Some <span class="bound">op1</span><span class="main">)</span> <span class="main">(</span>Some <span class="bound">op2</span><span class="main">)</span>  <span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span><span class="main">)</span>         <span class="main">⇒</span> semantics_ADD <span class="bound">op1</span> <span class="bound">op2</span>
  <span class="main">|</span> <span class="main">(</span>Instr <span class="inner_quoted">''inc''</span>     <span class="main">(</span>Some <span class="bound">op1</span><span class="main">)</span> <span class="main"><span class="bound">_</span></span>           <span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span><span class="main">)</span>         <span class="main">⇒</span> semantics_INC <span class="bound">op1</span>
  <span class="main">|</span> <span class="main">(</span>Instr <span class="inner_quoted">''dec''</span>     <span class="main">(</span>Some <span class="bound">op1</span><span class="main">)</span> <span class="main"><span class="bound">_</span></span>           <span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span><span class="main">)</span>         <span class="main">⇒</span> semantics_DEC <span class="bound">op1</span>
  <span class="main">|</span> <span class="main">(</span>Instr <span class="inner_quoted">''neg''</span>     <span class="main">(</span>Some <span class="bound">op1</span><span class="main">)</span> <span class="main"><span class="bound">_</span></span>           <span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span><span class="main">)</span>         <span class="main">⇒</span> semantics_NEG <span class="bound">op1</span>
  <span class="main">|</span> <span class="main">(</span>Instr <span class="inner_quoted">''sub''</span>     <span class="main">(</span>Some <span class="bound">op1</span><span class="main">)</span> <span class="main">(</span>Some <span class="bound">op2</span><span class="main">)</span>  <span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span><span class="main">)</span>         <span class="main">⇒</span> semantics_SUB <span class="bound">op1</span> <span class="bound">op2</span>
  <span class="main">|</span> <span class="main">(</span>Instr <span class="inner_quoted">''sbb''</span>     <span class="main">(</span>Some <span class="bound">op1</span><span class="main">)</span> <span class="main">(</span>Some <span class="bound">op2</span><span class="main">)</span>  <span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span><span class="main">)</span>         <span class="main">⇒</span> semantics_SBB <span class="bound">op1</span> <span class="bound">op2</span>
  <span class="main">|</span> <span class="main">(</span>Instr <span class="inner_quoted">''adc''</span>     <span class="main">(</span>Some <span class="bound">op1</span><span class="main">)</span> <span class="main">(</span>Some <span class="bound">op2</span><span class="main">)</span>  <span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span><span class="main">)</span>         <span class="main">⇒</span> semantics_ADC <span class="bound">op1</span> <span class="bound">op2</span>
  <span class="main">|</span> <span class="main">(</span>Instr <span class="inner_quoted">''mul''</span>     <span class="main">(</span>Some <span class="bound">op1</span><span class="main">)</span> <span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span><span class="main">)</span>                   <span class="main">⇒</span> semantics_MUL <span class="bound">op1</span> 
  <span class="main">|</span> <span class="main">(</span>Instr <span class="inner_quoted">''imul''</span>    <span class="main">(</span>Some <span class="bound">op1</span><span class="main">)</span> None <span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span><span class="main">)</span>                <span class="main">⇒</span> semantics_IMUL1 <span class="bound">op1</span> 
  <span class="main">|</span> <span class="main">(</span>Instr <span class="inner_quoted">''imul''</span>    <span class="main">(</span>Some <span class="bound">op1</span><span class="main">)</span> <span class="main">(</span>Some <span class="bound">op2</span><span class="main">)</span> None <span class="main"><span class="bound">_</span></span><span class="main">)</span>       <span class="main">⇒</span> semantics_IMUL2 <span class="bound">op1</span> <span class="bound">op2</span>
  <span class="main">|</span> <span class="main">(</span>Instr <span class="inner_quoted">''imul''</span>    <span class="main">(</span>Some <span class="bound">op1</span><span class="main">)</span> <span class="main">(</span>Some <span class="bound">op2</span><span class="main">)</span> <span class="main">(</span>Some <span class="bound">op3</span><span class="main">)</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span> <span class="main">⇒</span> semantics_IMUL3 <span class="bound">op1</span> <span class="bound">op2</span> <span class="bound">op3</span>
  <span class="main">|</span> <span class="main">(</span>Instr <span class="inner_quoted">''shl''</span>     <span class="main">(</span>Some <span class="bound">op1</span><span class="main">)</span> <span class="main">(</span>Some <span class="bound">op2</span><span class="main">)</span> None <span class="main"><span class="bound">_</span></span><span class="main">)</span>       <span class="main">⇒</span> semantics_SHL <span class="bound">op1</span> <span class="bound">op2</span>
  <span class="main">|</span> <span class="main">(</span>Instr <span class="inner_quoted">''sal''</span>     <span class="main">(</span>Some <span class="bound">op1</span><span class="main">)</span> <span class="main">(</span>Some <span class="bound">op2</span><span class="main">)</span> None <span class="main"><span class="bound">_</span></span><span class="main">)</span>       <span class="main">⇒</span> semantics_SHL <span class="bound">op1</span> <span class="bound">op2</span>
  <span class="main">|</span> <span class="main">(</span>Instr <span class="inner_quoted">''shr''</span>     <span class="main">(</span>Some <span class="bound">op1</span><span class="main">)</span> <span class="main">(</span>Some <span class="bound">op2</span><span class="main">)</span> None <span class="main"><span class="bound">_</span></span><span class="main">)</span>       <span class="main">⇒</span> semantics_SHR <span class="bound">op1</span> <span class="bound">op2</span>
  <span class="main">|</span> <span class="main">(</span>Instr <span class="inner_quoted">''sar''</span>     <span class="main">(</span>Some <span class="bound">op1</span><span class="main">)</span> <span class="main">(</span>Some <span class="bound">op2</span><span class="main">)</span> None <span class="main"><span class="bound">_</span></span><span class="main">)</span>       <span class="main">⇒</span> semantics_SAR <span class="bound">op1</span> <span class="bound">op2</span>
  <span class="main">|</span> <span class="main">(</span>Instr <span class="inner_quoted">''shld''</span>    <span class="main">(</span>Some <span class="bound">op1</span><span class="main">)</span> <span class="main">(</span>Some <span class="bound">op2</span><span class="main">)</span> <span class="main">(</span>Some <span class="bound">op3</span><span class="main">)</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span> <span class="main">⇒</span> semantics_SHLD <span class="bound">op1</span> <span class="bound">op2</span> <span class="bound">op3</span>
  <span class="main">|</span> <span class="main">(</span>Instr <span class="inner_quoted">''rol''</span>     <span class="main">(</span>Some <span class="bound">op1</span><span class="main">)</span> <span class="main">(</span>Some <span class="bound">op2</span><span class="main">)</span> None <span class="main"><span class="bound">_</span></span><span class="main">)</span>       <span class="main">⇒</span> semantics_ROL <span class="bound">op1</span> <span class="bound">op2</span>
  <span class="main">|</span> <span class="main">(</span>Instr <span class="inner_quoted">''ror''</span>     <span class="main">(</span>Some <span class="bound">op1</span><span class="main">)</span> <span class="main">(</span>Some <span class="bound">op2</span><span class="main">)</span> None <span class="main"><span class="bound">_</span></span><span class="main">)</span>       <span class="main">⇒</span> semantics_ROR <span class="bound">op1</span> <span class="bound">op2</span>
  <span class="comment1">― ‹flag-related›</span>
  <span class="main">|</span> <span class="main">(</span>Instr <span class="inner_quoted">''cmp''</span>     <span class="main">(</span>Some <span class="bound">op1</span><span class="main">)</span> <span class="main">(</span>Some <span class="bound">op2</span><span class="main">)</span>  <span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span><span class="main">)</span>         <span class="main">⇒</span> semantics_CMP <span class="bound">op1</span> <span class="bound">op2</span>
  <span class="main">|</span> <span class="main">(</span>Instr <span class="inner_quoted">''test''</span>    <span class="main">(</span>Some <span class="bound">op1</span><span class="main">)</span> <span class="main">(</span>Some <span class="bound">op2</span><span class="main">)</span>  <span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span><span class="main">)</span>         <span class="main">⇒</span> semantics_TEST <span class="bound">op1</span> <span class="bound">op2</span>
  <span class="comment1">― ‹sign-extension›</span>                                       
  <span class="main">|</span> <span class="main">(</span>Instr <span class="inner_quoted">''movsxd''</span>  <span class="main">(</span>Some <span class="bound">op1</span><span class="main">)</span> <span class="main">(</span>Some <span class="bound">op2</span><span class="main">)</span>  <span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span><span class="main">)</span>         <span class="main">⇒</span> semantics_MOVSXD <span class="bound">op1</span> <span class="bound">op2</span>
  <span class="main">|</span> <span class="main">(</span>Instr <span class="inner_quoted">''movsx''</span>   <span class="main">(</span>Some <span class="bound">op1</span><span class="main">)</span> <span class="main">(</span>Some <span class="bound">op2</span><span class="main">)</span>  <span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span><span class="main">)</span>         <span class="main">⇒</span> semantics_MOVSXD <span class="bound">op1</span> <span class="bound">op2</span>
  <span class="main">|</span> <span class="main">(</span>Instr <span class="inner_quoted">''cdqe''</span>    <span class="main">(</span>Some <span class="bound">op1</span><span class="main">)</span> <span class="main">(</span>Some <span class="bound">op2</span><span class="main">)</span>  <span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span><span class="main">)</span>         <span class="main">⇒</span> semantics_CDQE
  <span class="main">|</span> <span class="main">(</span>Instr <span class="inner_quoted">''cdq''</span>     <span class="main">(</span>Some <span class="bound">op1</span><span class="main">)</span> <span class="main">(</span>Some <span class="bound">op2</span><span class="main">)</span>  <span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span><span class="main">)</span>         <span class="main">⇒</span> semantics_CDQ
  <span class="main">|</span> <span class="main">(</span>Instr <span class="inner_quoted">''cqo''</span>     <span class="main">(</span>Some <span class="bound">op1</span><span class="main">)</span> <span class="main">(</span>Some <span class="bound">op2</span><span class="main">)</span>  <span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span><span class="main">)</span>         <span class="main">⇒</span> semantics_CQO
  <span class="comment1">― ‹logic›</span>
  <span class="main">|</span> <span class="main">(</span>Instr <span class="inner_quoted">''and''</span>     <span class="main">(</span>Some <span class="bound">op1</span><span class="main">)</span> <span class="main">(</span>Some <span class="bound">op2</span><span class="main">)</span>  <span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span><span class="main">)</span>         <span class="main">⇒</span> semantics_AND <span class="bound">op1</span> <span class="bound">op2</span>
  <span class="main">|</span> <span class="main">(</span>Instr <span class="inner_quoted">''or''</span>      <span class="main">(</span>Some <span class="bound">op1</span><span class="main">)</span> <span class="main">(</span>Some <span class="bound">op2</span><span class="main">)</span>  <span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span><span class="main">)</span>         <span class="main">⇒</span> semantics_OR  <span class="bound">op1</span> <span class="bound">op2</span>
  <span class="main">|</span> <span class="main">(</span>Instr <span class="inner_quoted">''xor''</span>     <span class="main">(</span>Some <span class="bound">op1</span><span class="main">)</span> <span class="main">(</span>Some <span class="bound">op2</span><span class="main">)</span>  <span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span><span class="main">)</span>         <span class="main">⇒</span> semantics_XOR <span class="bound">op1</span> <span class="bound">op2</span>
  <span class="main">|</span> <span class="main">(</span>Instr <span class="inner_quoted">''xorps''</span>   <span class="main">(</span>Some <span class="bound">op1</span><span class="main">)</span> <span class="main">(</span>Some <span class="bound">op2</span><span class="main">)</span>  <span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span><span class="main">)</span>         <span class="main">⇒</span> semantics_XORPS <span class="bound">op1</span> <span class="bound">op2</span>
  <span class="main">|</span> <span class="main">(</span>Instr <span class="inner_quoted">''not''</span>     <span class="main">(</span>Some <span class="bound">op1</span><span class="main">)</span> <span class="main"><span class="bound">_</span></span>  <span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span><span class="main">)</span>                  <span class="main">⇒</span> semantics_NOT <span class="bound">op1</span>
  <span class="comment1">― ‹jumps›</span>
  <span class="main">|</span> <span class="main">(</span>Instr <span class="inner_quoted">''jmp''</span>     <span class="main">(</span>Some <span class="bound">op1</span><span class="main">)</span> None  <span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span><span class="main">)</span>               <span class="main">⇒</span> semantics_JMP <span class="bound">op1</span>
  <span class="main">|</span> <span class="main">(</span>Instr <span class="inner_quoted">''jo''</span>      <span class="main">(</span>Some <span class="bound">op1</span><span class="main">)</span> None  <span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span><span class="main">)</span>               <span class="main">⇒</span> semantics_JO <span class="bound">op1</span>
  <span class="main">|</span> <span class="main">(</span>Instr <span class="inner_quoted">''jno''</span>     <span class="main">(</span>Some <span class="bound">op1</span><span class="main">)</span> None  <span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span><span class="main">)</span>               <span class="main">⇒</span> semantics_JNO <span class="bound">op1</span>
  <span class="main">|</span> <span class="main">(</span>Instr <span class="inner_quoted">''js''</span>      <span class="main">(</span>Some <span class="bound">op1</span><span class="main">)</span> None  <span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span><span class="main">)</span>               <span class="main">⇒</span> semantics_JS <span class="bound">op1</span>
  <span class="main">|</span> <span class="main">(</span>Instr <span class="inner_quoted">''jns''</span>     <span class="main">(</span>Some <span class="bound">op1</span><span class="main">)</span> None  <span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span><span class="main">)</span>               <span class="main">⇒</span> semantics_JNS <span class="bound">op1</span>
  <span class="main">|</span> <span class="main">(</span>Instr <span class="inner_quoted">''je''</span>      <span class="main">(</span>Some <span class="bound">op1</span><span class="main">)</span> None  <span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span><span class="main">)</span>               <span class="main">⇒</span> semantics_JE <span class="bound">op1</span>
  <span class="main">|</span> <span class="main">(</span>Instr <span class="inner_quoted">''jz''</span>      <span class="main">(</span>Some <span class="bound">op1</span><span class="main">)</span> None  <span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span><span class="main">)</span>               <span class="main">⇒</span> semantics_JE <span class="bound">op1</span>
  <span class="main">|</span> <span class="main">(</span>Instr <span class="inner_quoted">''jne''</span>     <span class="main">(</span>Some <span class="bound">op1</span><span class="main">)</span> None  <span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span><span class="main">)</span>               <span class="main">⇒</span> semantics_JNE <span class="bound">op1</span>
  <span class="main">|</span> <span class="main">(</span>Instr <span class="inner_quoted">''jnz''</span>     <span class="main">(</span>Some <span class="bound">op1</span><span class="main">)</span> None  <span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span><span class="main">)</span>               <span class="main">⇒</span> semantics_JNE <span class="bound">op1</span>
  <span class="main">|</span> <span class="main">(</span>Instr <span class="inner_quoted">''jb''</span>      <span class="main">(</span>Some <span class="bound">op1</span><span class="main">)</span> None  <span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span><span class="main">)</span>               <span class="main">⇒</span> semantics_JB <span class="bound">op1</span>
  <span class="main">|</span> <span class="main">(</span>Instr <span class="inner_quoted">''jnae''</span>    <span class="main">(</span>Some <span class="bound">op1</span><span class="main">)</span> None  <span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span><span class="main">)</span>               <span class="main">⇒</span> semantics_JB <span class="bound">op1</span>
  <span class="main">|</span> <span class="main">(</span>Instr <span class="inner_quoted">''jc''</span>      <span class="main">(</span>Some <span class="bound">op1</span><span class="main">)</span> None  <span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span><span class="main">)</span>               <span class="main">⇒</span> semantics_JB <span class="bound">op1</span>
  <span class="main">|</span> <span class="main">(</span>Instr <span class="inner_quoted">''jnb''</span>     <span class="main">(</span>Some <span class="bound">op1</span><span class="main">)</span> None  <span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span><span class="main">)</span>               <span class="main">⇒</span> semantics_JNB <span class="bound">op1</span>
  <span class="main">|</span> <span class="main">(</span>Instr <span class="inner_quoted">''jae''</span>     <span class="main">(</span>Some <span class="bound">op1</span><span class="main">)</span> None  <span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span><span class="main">)</span>               <span class="main">⇒</span> semantics_JNB <span class="bound">op1</span>
  <span class="main">|</span> <span class="main">(</span>Instr <span class="inner_quoted">''jnc''</span>     <span class="main">(</span>Some <span class="bound">op1</span><span class="main">)</span> None  <span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span><span class="main">)</span>               <span class="main">⇒</span> semantics_JNB <span class="bound">op1</span>
  <span class="main">|</span> <span class="main">(</span>Instr <span class="inner_quoted">''jbe''</span>     <span class="main">(</span>Some <span class="bound">op1</span><span class="main">)</span> None  <span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span><span class="main">)</span>               <span class="main">⇒</span> semantics_JBE <span class="bound">op1</span>
  <span class="main">|</span> <span class="main">(</span>Instr <span class="inner_quoted">''jna''</span>     <span class="main">(</span>Some <span class="bound">op1</span><span class="main">)</span> None  <span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span><span class="main">)</span>               <span class="main">⇒</span> semantics_JBE <span class="bound">op1</span>
  <span class="main">|</span> <span class="main">(</span>Instr <span class="inner_quoted">''ja''</span>      <span class="main">(</span>Some <span class="bound">op1</span><span class="main">)</span> None  <span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span><span class="main">)</span>               <span class="main">⇒</span> semantics_JA <span class="bound">op1</span>
  <span class="main">|</span> <span class="main">(</span>Instr <span class="inner_quoted">''jnbe''</span>    <span class="main">(</span>Some <span class="bound">op1</span><span class="main">)</span> None  <span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span><span class="main">)</span>               <span class="main">⇒</span> semantics_JA <span class="bound">op1</span>
  <span class="main">|</span> <span class="main">(</span>Instr <span class="inner_quoted">''jl''</span>      <span class="main">(</span>Some <span class="bound">op1</span><span class="main">)</span> None  <span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span><span class="main">)</span>               <span class="main">⇒</span> semantics_JL <span class="bound">op1</span>
  <span class="main">|</span> <span class="main">(</span>Instr <span class="inner_quoted">''jnge''</span>    <span class="main">(</span>Some <span class="bound">op1</span><span class="main">)</span> None  <span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span><span class="main">)</span>               <span class="main">⇒</span> semantics_JL <span class="bound">op1</span>
  <span class="main">|</span> <span class="main">(</span>Instr <span class="inner_quoted">''jge''</span>     <span class="main">(</span>Some <span class="bound">op1</span><span class="main">)</span> None  <span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span><span class="main">)</span>               <span class="main">⇒</span> semantics_JGE <span class="bound">op1</span>
  <span class="main">|</span> <span class="main">(</span>Instr <span class="inner_quoted">''jnl''</span>     <span class="main">(</span>Some <span class="bound">op1</span><span class="main">)</span> None  <span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span><span class="main">)</span>               <span class="main">⇒</span> semantics_JGE <span class="bound">op1</span>
  <span class="main">|</span> <span class="main">(</span>Instr <span class="inner_quoted">''jle''</span>     <span class="main">(</span>Some <span class="bound">op1</span><span class="main">)</span> None  <span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span><span class="main">)</span>               <span class="main">⇒</span> semantics_JLE <span class="bound">op1</span>
  <span class="main">|</span> <span class="main">(</span>Instr <span class="inner_quoted">''jng''</span>     <span class="main">(</span>Some <span class="bound">op1</span><span class="main">)</span> None  <span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span><span class="main">)</span>               <span class="main">⇒</span> semantics_JLE <span class="bound">op1</span>
  <span class="main">|</span> <span class="main">(</span>Instr <span class="inner_quoted">''jg''</span>      <span class="main">(</span>Some <span class="bound">op1</span><span class="main">)</span> None  <span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span><span class="main">)</span>               <span class="main">⇒</span> semantics_JG <span class="bound">op1</span>
  <span class="main">|</span> <span class="main">(</span>Instr <span class="inner_quoted">''jnle''</span>    <span class="main">(</span>Some <span class="bound">op1</span><span class="main">)</span> None  <span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span><span class="main">)</span>               <span class="main">⇒</span> semantics_JG <span class="bound">op1</span>
  <span class="comment1">― ‹setXX›</span>
  <span class="main">|</span> <span class="main">(</span>Instr <span class="inner_quoted">''seto''</span>    <span class="main">(</span>Some <span class="bound">op1</span><span class="main">)</span> None  <span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span><span class="main">)</span>               <span class="main">⇒</span> semantics_SETO <span class="bound">op1</span>
  <span class="main">|</span> <span class="main">(</span>Instr <span class="inner_quoted">''setno''</span>   <span class="main">(</span>Some <span class="bound">op1</span><span class="main">)</span> None  <span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span><span class="main">)</span>               <span class="main">⇒</span> semantics_SETNO <span class="bound">op1</span>
  <span class="main">|</span> <span class="main">(</span>Instr <span class="inner_quoted">''sets''</span>    <span class="main">(</span>Some <span class="bound">op1</span><span class="main">)</span> None  <span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span><span class="main">)</span>               <span class="main">⇒</span> semantics_SETS <span class="bound">op1</span>
  <span class="main">|</span> <span class="main">(</span>Instr <span class="inner_quoted">''setns''</span>   <span class="main">(</span>Some <span class="bound">op1</span><span class="main">)</span> None  <span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span><span class="main">)</span>               <span class="main">⇒</span> semantics_SETNS <span class="bound">op1</span>
  <span class="main">|</span> <span class="main">(</span>Instr <span class="inner_quoted">''sete''</span>    <span class="main">(</span>Some <span class="bound">op1</span><span class="main">)</span> None  <span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span><span class="main">)</span>               <span class="main">⇒</span> semantics_SETE <span class="bound">op1</span>
  <span class="main">|</span> <span class="main">(</span>Instr <span class="inner_quoted">''setz''</span>    <span class="main">(</span>Some <span class="bound">op1</span><span class="main">)</span> None  <span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span><span class="main">)</span>               <span class="main">⇒</span> semantics_SETE <span class="bound">op1</span>
  <span class="main">|</span> <span class="main">(</span>Instr <span class="inner_quoted">''setne''</span>   <span class="main">(</span>Some <span class="bound">op1</span><span class="main">)</span> None  <span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span><span class="main">)</span>               <span class="main">⇒</span> semantics_SETNE <span class="bound">op1</span>
  <span class="main">|</span> <span class="main">(</span>Instr <span class="inner_quoted">''setnz''</span>   <span class="main">(</span>Some <span class="bound">op1</span><span class="main">)</span> None  <span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span><span class="main">)</span>               <span class="main">⇒</span> semantics_SETNE <span class="bound">op1</span>
  <span class="main">|</span> <span class="main">(</span>Instr <span class="inner_quoted">''setb''</span>    <span class="main">(</span>Some <span class="bound">op1</span><span class="main">)</span> None  <span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span><span class="main">)</span>               <span class="main">⇒</span> semantics_SETB <span class="bound">op1</span>
  <span class="main">|</span> <span class="main">(</span>Instr <span class="inner_quoted">''setnae''</span>  <span class="main">(</span>Some <span class="bound">op1</span><span class="main">)</span> None  <span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span><span class="main">)</span>               <span class="main">⇒</span> semantics_SETB <span class="bound">op1</span>
  <span class="main">|</span> <span class="main">(</span>Instr <span class="inner_quoted">''setc''</span>    <span class="main">(</span>Some <span class="bound">op1</span><span class="main">)</span> None  <span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span><span class="main">)</span>               <span class="main">⇒</span> semantics_SETB <span class="bound">op1</span>
  <span class="main">|</span> <span class="main">(</span>Instr <span class="inner_quoted">''setnb''</span>   <span class="main">(</span>Some <span class="bound">op1</span><span class="main">)</span> None  <span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span><span class="main">)</span>               <span class="main">⇒</span> semantics_SETNB <span class="bound">op1</span>
  <span class="main">|</span> <span class="main">(</span>Instr <span class="inner_quoted">''setae''</span>   <span class="main">(</span>Some <span class="bound">op1</span><span class="main">)</span> None  <span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span><span class="main">)</span>               <span class="main">⇒</span> semantics_SETNB <span class="bound">op1</span>
  <span class="main">|</span> <span class="main">(</span>Instr <span class="inner_quoted">''setnc''</span>   <span class="main">(</span>Some <span class="bound">op1</span><span class="main">)</span> None  <span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span><span class="main">)</span>               <span class="main">⇒</span> semantics_SETNB <span class="bound">op1</span>
  <span class="main">|</span> <span class="main">(</span>Instr <span class="inner_quoted">''setbe''</span>   <span class="main">(</span>Some <span class="bound">op1</span><span class="main">)</span> None  <span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span><span class="main">)</span>               <span class="main">⇒</span> semantics_SETBE <span class="bound">op1</span>
  <span class="main">|</span> <span class="main">(</span>Instr <span class="inner_quoted">''setna''</span>   <span class="main">(</span>Some <span class="bound">op1</span><span class="main">)</span> None  <span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span><span class="main">)</span>               <span class="main">⇒</span> semantics_SETBE <span class="bound">op1</span>
  <span class="main">|</span> <span class="main">(</span>Instr <span class="inner_quoted">''seta''</span>    <span class="main">(</span>Some <span class="bound">op1</span><span class="main">)</span> None  <span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span><span class="main">)</span>               <span class="main">⇒</span> semantics_SETA <span class="bound">op1</span>
  <span class="main">|</span> <span class="main">(</span>Instr <span class="inner_quoted">''setnbe''</span>  <span class="main">(</span>Some <span class="bound">op1</span><span class="main">)</span> None  <span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span><span class="main">)</span>               <span class="main">⇒</span> semantics_SETA <span class="bound">op1</span>
  <span class="main">|</span> <span class="main">(</span>Instr <span class="inner_quoted">''setl''</span>    <span class="main">(</span>Some <span class="bound">op1</span><span class="main">)</span> None  <span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span><span class="main">)</span>               <span class="main">⇒</span> semantics_SETL <span class="bound">op1</span>
  <span class="main">|</span> <span class="main">(</span>Instr <span class="inner_quoted">''setnge''</span>  <span class="main">(</span>Some <span class="bound">op1</span><span class="main">)</span> None  <span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span><span class="main">)</span>               <span class="main">⇒</span> semantics_SETL <span class="bound">op1</span>
  <span class="main">|</span> <span class="main">(</span>Instr <span class="inner_quoted">''setge''</span>   <span class="main">(</span>Some <span class="bound">op1</span><span class="main">)</span> None  <span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span><span class="main">)</span>               <span class="main">⇒</span> semantics_SETGE <span class="bound">op1</span>
  <span class="main">|</span> <span class="main">(</span>Instr <span class="inner_quoted">''setnl''</span>   <span class="main">(</span>Some <span class="bound">op1</span><span class="main">)</span> None  <span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span><span class="main">)</span>               <span class="main">⇒</span> semantics_SETGE <span class="bound">op1</span>
  <span class="main">|</span> <span class="main">(</span>Instr <span class="inner_quoted">''setle''</span>   <span class="main">(</span>Some <span class="bound">op1</span><span class="main">)</span> None  <span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span><span class="main">)</span>               <span class="main">⇒</span> semantics_SETLE <span class="bound">op1</span>
  <span class="main">|</span> <span class="main">(</span>Instr <span class="inner_quoted">''setng''</span>   <span class="main">(</span>Some <span class="bound">op1</span><span class="main">)</span> None  <span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span><span class="main">)</span>               <span class="main">⇒</span> semantics_SETLE <span class="bound">op1</span>
  <span class="main">|</span> <span class="main">(</span>Instr <span class="inner_quoted">''setg''</span>    <span class="main">(</span>Some <span class="bound">op1</span><span class="main">)</span> None  <span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span><span class="main">)</span>               <span class="main">⇒</span> semantics_SETG <span class="bound">op1</span>
  <span class="main">|</span> <span class="main">(</span>Instr <span class="inner_quoted">''setnle''</span>  <span class="main">(</span>Some <span class="bound">op1</span><span class="main">)</span> None  <span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span><span class="main">)</span>               <span class="main">⇒</span> semantics_SETG <span class="bound">op1</span>
  <span class="comment1">― ‹conditional moves›</span>
  <span class="main">|</span> <span class="main">(</span>Instr <span class="inner_quoted">''cmovne''</span>  <span class="main">(</span>Some <span class="bound">op1</span><span class="main">)</span> <span class="main">(</span>Some <span class="bound">op2</span><span class="main">)</span>  <span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span><span class="main">)</span>         <span class="main">⇒</span> semantics_CMOVNE <span class="bound">op1</span> <span class="bound">op2</span>
  <span class="main">|</span> <span class="main">(</span>Instr <span class="inner_quoted">''cmovns''</span>  <span class="main">(</span>Some <span class="bound">op1</span><span class="main">)</span> <span class="main">(</span>Some <span class="bound">op2</span><span class="main">)</span>  <span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span><span class="main">)</span>         <span class="main">⇒</span> semantics_CMOVNS <span class="bound">op1</span> <span class="bound">op2</span>
  <span class="comment1">― ‹floating point (double)›</span>                                           
  <span class="main">|</span> <span class="main">(</span>Instr <span class="inner_quoted">''addsd''</span>   <span class="main">(</span>Some <span class="bound">op1</span><span class="main">)</span> <span class="main">(</span>Some <span class="bound">op2</span><span class="main">)</span>  <span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span><span class="main">)</span>         <span class="main">⇒</span> semantics_ADDSD <span class="bound">op1</span> <span class="bound">op2</span>
  <span class="main">|</span> <span class="main">(</span>Instr <span class="inner_quoted">''subsd''</span>   <span class="main">(</span>Some <span class="bound">op1</span><span class="main">)</span> <span class="main">(</span>Some <span class="bound">op2</span><span class="main">)</span>  <span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span><span class="main">)</span>         <span class="main">⇒</span> semantics_SUBSD <span class="bound">op1</span> <span class="bound">op2</span>
  <span class="main">|</span> <span class="main">(</span>Instr <span class="inner_quoted">''mulsd''</span>   <span class="main">(</span>Some <span class="bound">op1</span><span class="main">)</span> <span class="main">(</span>Some <span class="bound">op2</span><span class="main">)</span>  <span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span><span class="main">)</span>         <span class="main">⇒</span> semantics_MULSD <span class="bound">op1</span> <span class="bound">op2</span>
  <span class="main">|</span> <span class="main">(</span>Instr <span class="inner_quoted">''divsd''</span>   <span class="main">(</span>Some <span class="bound">op1</span><span class="main">)</span> <span class="main">(</span>Some <span class="bound">op2</span><span class="main">)</span>  <span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span><span class="main">)</span>         <span class="main">⇒</span> semantics_DIVSD <span class="bound">op1</span> <span class="bound">op2</span>
  <span class="main">|</span> <span class="main">(</span>Instr <span class="inner_quoted">''ucomisd''</span> <span class="main">(</span>Some <span class="bound">op1</span><span class="main">)</span> <span class="main">(</span>Some <span class="bound">op2</span><span class="main">)</span>  <span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span><span class="main">)</span>         <span class="main">⇒</span> semantics_UCOMISD <span class="bound">op1</span> <span class="bound">op2</span>
  <span class="comment1">― ‹simd›</span>
  <span class="main">|</span> <span class="main">(</span>Instr <span class="inner_quoted">''paddd''</span>   <span class="main">(</span>Some <span class="bound">op1</span><span class="main">)</span> <span class="main">(</span>Some <span class="bound">op2</span><span class="main">)</span> <span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span><span class="main">)</span>          <span class="main">⇒</span> semantics_PADDD <span class="bound">op1</span> <span class="bound">op2</span>
  <span class="main">|</span> <span class="main">(</span>Instr <span class="inner_quoted">''pshufd''</span>  <span class="main">(</span>Some <span class="bound">op1</span><span class="main">)</span> <span class="main">(</span>Some <span class="bound">op2</span><span class="main">)</span> <span class="main">(</span>Some <span class="bound">op3</span><span class="main">)</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span> <span class="main">⇒</span> semantics_PSHUFD <span class="bound">op1</span> <span class="bound">op2</span> <span class="bound">op3</span>
  <span class="main">|</span> <span class="main">(</span>Instr <span class="inner_quoted">''pextrd''</span>  <span class="main">(</span>Some <span class="bound">op1</span><span class="main">)</span> <span class="main">(</span>Some <span class="bound">op2</span><span class="main">)</span> <span class="main">(</span>Some <span class="bound">op3</span><span class="main">)</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span> <span class="main">⇒</span> semantics_PEXTRD <span class="bound">op1</span> <span class="bound">op2</span> <span class="bound">op3</span>
  <span class="main">|</span> <span class="main">(</span>Instr <span class="inner_quoted">''pinsrd''</span>  <span class="main">(</span>Some <span class="bound">op1</span><span class="main">)</span> <span class="main">(</span>Some <span class="bound">op2</span><span class="main">)</span> <span class="main">(</span>Some <span class="bound">op3</span><span class="main">)</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span> <span class="main">⇒</span> semantics_PINSRD <span class="bound">op1</span> <span class="bound">op2</span> <span class="bound">op3</span>
  <span class="comment1">― ‹remainder›</span>
  <span class="main">|</span> <span class="main">(</span>Instr <span class="inner_quoted">''nop''</span>     <span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span><span class="main">)</span>                            <span class="main">⇒</span> semantics_NOP
  <span class="main">|</span> <span class="main">(</span>Instr <span class="inner_quoted">''bswap''</span>   <span class="main">(</span>Some <span class="bound">op1</span><span class="main">)</span> <span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span><span class="main">)</span>                   <span class="main">⇒</span> semantics_BSWAP <span class="bound">op1</span>
  <span class="comment1">― ‹external function›</span>
  <span class="main">|</span> <span class="main">(</span>ExternalFunc <span class="bound">f</span><span class="main">)</span> <span class="main">⇒</span> <span class="bound">f</span>
  <span class="main">|</span> <span class="bound">i</span> <span class="main">⇒</span> <span class="free">unknown_semantics</span> <span class="bound">i</span>"</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹A step function. In X86. the RIP register is incremented before the instruction is executed.
      This is important, e.g., when RIP is used in a jump address.›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">step</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"I <span class="main">⇒</span> state <span class="main">⇒</span> state"</span></span> 
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">step</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">≡</span> 
    <span class="keyword1">let</span> <span class="bound">σ'</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="keyword1">with</span> <span class="main">[</span><span class="keyword1">setRip</span> <span class="main">(</span>instr_next <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span><span class="main">]</span> <span class="keyword1">in</span>
      semantics <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="bound">σ'</span>"</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹All simplification rules used during symbolic execution.›</span></span>
<span class="keyword1"><span class="command">lemmas</span></span> semantics_simps <span class="main">=</span> 
      Let_def unop_def unop_no_flags_def binop_def binop_flags_def binop_no_flags_def binop_XMM_def
      semantics_def mov_sign_extension_def simd_32_128_def
      write_MUL_result_def unop_MUL_def ternop_IMUL_def sbb_def adc_def shld_def

      semantics_MOV_def semantics_MOVSD_def semantics_MOVD_def semantics_CMOV_def
      semantics_LEA_def semantics_PUSH_def semantics_POP_def
      semantics_RET_def semantics_CALL_def semantics_LEAVE_def
      semantics_ADD_def semantics_INC_def semantics_DEC_def semantics_NEG_def semantics_SUB_def
      semantics_SBB_def semantics_ADC_def
      semantics_MUL_def semantics_IMUL1_def semantics_IMUL2_def semantics_IMUL3_def
      semantics_SHL_def semantics_SHR_def semantics_SAR_def semantics_SHLD_def
      semantics_ROL_def semantics_ROR_def
      semantics_CMP_def semantics_TEST_def
      semantics_MOVSXD_def semantics_CDQE_def semantics_CDQ_def semantics_CQO_def
      semantics_AND_def semantics_OR_def semantics_XOR_def semantics_XORPS_def semantics_NOT_def
      semantics_cond_jump_def semantics_JMP_def
      semantics_JO_def semantics_JNO_def semantics_JS_def semantics_JNS_def
      semantics_JE_def semantics_JNE_def semantics_JB_def semantics_JNB_def
      semantics_JBE_def semantics_JA_def semantics_JL_def semantics_JGE_def 
      semantics_JLE_def semantics_JG_def
      semantics_setXX_def 
      semantics_ADDSD_def semantics_SUBSD_def semantics_MULSD_def semantics_DIVSD_def semantics_UCOMISD_def
      semantics_NOP_def semantics_BSWAP_def semantics_PSHUFD_def semantics_PEXTRD_def semantics_PINSRD_def

      SUB_flags_def ADD_flags_def INC_flags_def DEC_flags_def NEG_flags_def MUL_flags_def IMUL_flags_def
      SHL_flags_def SHR_flags_def SAR_flags_def SHLD_flags_def logic_flags_def UCOMISD_flags_def


<span class="keyword2"><span class="keyword">end</span></span>
<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="StateCleanUp">
<div class="head">
<h1>Theory StateCleanUp</h1>
</div>
<pre class="source"><span class="comment1">(*  Title:       X86 instruction semantics and basic block symbolic execution
    Authors:     Freek Verbeek, Abhijith Bharadwaj, Joshua Bockenek, Ian Roessle, Timmy Weerwag, Binoy Ravindran
    Year:        2020
    Maintainer:  Freek Verbeek (freek@vt.edu)
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">"Removing superfluous memory writes"</span></span>

<span class="keyword1"><span class="command">theory</span></span> StateCleanUp
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="#State">State</a> <span class="quoted">"<a href="https://www.cl.cam.ac.uk/research/hvg/Isabelle/dist/library/HOL/HOL-Eisbach/Eisbach.html">HOL-Eisbach.Eisbach</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>


<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">assumptions</span> <span class="main">≡</span> id"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We are going to make schematic theorems of the form:
      \[
        <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">assumptions</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> ?A \implies \ldots 
      \]
      The assumptions will be generated on-the-fly. The seemingly weird lemmas below achieves that.›</span></span>


<span class="keyword1" id="StateCleanUp-assumptions_impI"><span class="command">lemma</span></span> assumptions_impI<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"assumptions <span class="main">(</span><span class="free">P</span> <span class="main">∧</span> <span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assumptions_def<span class="main">)</span>

<span class="keyword1" id="StateCleanUp-assumptions_conjE"><span class="command">lemma</span></span> assumptions_conjE<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"assumptions <span class="main">(</span><span class="free">P</span> <span class="main">∧</span> <span class="free">A</span><span class="main">)</span> <span class="main">⟷</span> <span class="free">P</span> <span class="main">∧</span> assumptions <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assumptions_def<span class="main">)</span>

<span class="keyword1" id="StateCleanUp-assumptionsI"><span class="command">lemma</span></span> assumptionsI<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"assumptions True"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assumptions_def<span class="main">)</span>



<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Consider two consecutive memory updates. If they write to the same memory locations, only one of these
      need to be kept. We formulate an Eisbach method to that end. ›</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Returns true if two states are equal except for a specific memory region.›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">eq_except_for_mem</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"state <span class="main">⇒</span> state <span class="main">⇒</span> <span class="numeral">64</span> word <span class="main">⇒</span> nat <span class="main">⇒</span> <span class="numeral">256</span> word <span class="main">⇒</span> bool <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">eq_except_for_mem</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">σ'</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">si</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="keyword1">with</span> <span class="main">[</span><span class="main">⟦</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">si</span></span></span><span class="main">⟧</span> <span class="keyword1">:=<span class="hidden">⇩</span><sub>m</sub></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">]</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">σ'</span></span></span> <span class="keyword1">else</span> <span class="free"><span class="bound"><span class="entity">σ'</span></span></span> <span class="keyword1">with</span> <span class="main">[</span><span class="main">⟦</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">si</span></span></span><span class="main">⟧</span> <span class="keyword1">:=<span class="hidden">⇩</span><sub>m</sub></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">]</span><span class="main">)</span>"</span></span>


<span class="keyword1" id="StateCleanUp-eefm_start"><span class="command">lemma</span></span> eefm_start<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"eq_except_for_mem <span class="main">(</span><span class="free">σ</span> <span class="keyword1">with</span> <span class="free">updates</span><span class="main">)</span> <span class="main">(</span><span class="free">σ</span> <span class="keyword1">with</span> <span class="free">updates'</span><span class="main">)</span> <span class="free">a</span> <span class="free">si</span> <span class="free">v</span> <span class="free">b</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">σ</span> <span class="keyword1">with</span> <span class="main">(</span><span class="main">(</span><span class="main">⟦</span><span class="free">a</span><span class="main">,</span><span class="free">si</span><span class="main">⟧</span> <span class="keyword1">:=<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">v</span><span class="main">)</span><span class="main">#</span><span class="free">updates</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">b</span> <span class="keyword1">then</span> <span class="free">σ</span> <span class="keyword1">with</span> <span class="free">updates'</span> <span class="keyword1">else</span> <span class="free">σ</span> <span class="keyword1">with</span> <span class="main">(</span><span class="main">(</span><span class="main">⟦</span><span class="free">a</span><span class="main">,</span><span class="free">si</span><span class="main">⟧</span> <span class="keyword1">:=<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">v</span><span class="main">)</span><span class="main">#</span><span class="free">updates'</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eq_except_for_mem_def region_addresses_def state_with_updates.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> state_update.simps<span class="main">)</span>

<span class="keyword1" id="StateCleanUp-eefm_clean_mem"><span class="command">lemma</span></span> eefm_clean_mem<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">si'</span> <span class="main">≤</span> <span class="free">si</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"eq_except_for_mem <span class="main">(</span><span class="free">σ</span> <span class="keyword1">with</span> <span class="free">updates</span><span class="main">)</span> <span class="main">(</span><span class="free">σ</span> <span class="keyword1">with</span> <span class="free">updates'</span><span class="main">)</span> <span class="free">a</span> <span class="free">si</span> <span class="free">v</span> <span class="free">b</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"eq_except_for_mem <span class="main">(</span><span class="free">σ</span> <span class="keyword1">with</span> <span class="main">(</span><span class="main">(</span><span class="main">⟦</span><span class="free">a</span><span class="main">,</span><span class="free">si'</span><span class="main">⟧</span> <span class="keyword1">:=<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">v'</span><span class="main">)</span><span class="main">#</span><span class="free">updates</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">σ</span> <span class="keyword1">with</span> <span class="free">updates'</span><span class="main">)</span> <span class="free">a</span> <span class="free">si</span> <span class="free">v</span> <span class="free">b</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eq_except_for_mem_def state_with_updates.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> state_update.simps<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">σ</span> <span class="keyword1">with</span> <span class="free">updates</span>"</span></span><span class="main"><span class="keyword3">;</span></span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">σ</span> <span class="keyword1">with</span> <span class="free">updates'</span>"</span></span><span class="main"><span class="keyword3">;</span></span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">σ</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> override_on_def region_addresses_iff<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">σ</span> <span class="keyword1">with</span> <span class="free">updates</span>"</span></span><span class="main"><span class="keyword3">;</span></span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">σ</span> <span class="keyword1">with</span> <span class="free">updates'</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> override_on_def region_addresses_iff<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">meson</span>

<span class="keyword1"><span class="command">method</span></span> eefm_clean_mem <span class="main">=</span> <span class="main">(</span><span class="operator">rule</span> eefm_clean_mem<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">no_asm</span><span class="main"><span class="main">)</span></span><span class="main"><span class="keyword3">;</span></span><span class="operator">fail</span><span class="main">)</span><span class="main">)</span>


<span class="keyword1" id="StateCleanUp-eefm_clean_mem_enclosed"><span class="command">lemma</span></span> eefm_clean_mem_enclosed<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">si</span> <span class="main">&lt;</span> <span class="numeral">32</span>"</span></span> <span class="comment1">(* due to 256 words being written to memory *)</span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"enclosed <span class="free">a'</span> <span class="free">si'</span> <span class="free">a</span> <span class="free">si</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"eq_except_for_mem <span class="main">(</span><span class="free">σ</span> <span class="keyword1">with</span> <span class="free">updates</span><span class="main">)</span> <span class="main">(</span><span class="free">σ</span> <span class="keyword1">with</span> <span class="free">updates'</span><span class="main">)</span> <span class="free">a'</span> <span class="free">si'</span> <span class="free">v'</span> <span class="free">b</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"eq_except_for_mem <span class="main">(</span><span class="free">σ</span> <span class="keyword1">with</span> <span class="main">(</span><span class="main">(</span><span class="main">⟦</span><span class="free">a</span><span class="main">,</span><span class="free">si</span><span class="main">⟧</span> <span class="keyword1">:=<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">v</span><span class="main">)</span><span class="main">#</span><span class="free">updates</span><span class="main">)</span><span class="main">)</span> 
                           <span class="main">(</span><span class="free">σ</span> <span class="keyword1">with</span> <span class="main">(</span><span class="main">(</span><span class="main">⟦</span><span class="free">a</span><span class="main">,</span><span class="free">si</span><span class="main">⟧</span> <span class="keyword1">:=<span class="hidden">⇩</span><sub>m</sub></span> overwrite <span class="main">(</span><span class="numeral">8</span> <span class="main">*</span> unat <span class="main">(</span><span class="free">a'</span> <span class="main">-</span> <span class="free">a</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="numeral">8</span> <span class="main">*</span> unat <span class="main">(</span><span class="free">a'</span> <span class="main">-</span> <span class="free">a</span><span class="main">)</span> <span class="main">+</span> <span class="numeral">8</span><span class="main">*</span><span class="free">si'</span><span class="main">)</span> <span class="free">v</span> <span class="main">(</span><span class="free">v'</span> <span class="main">&lt;&lt;</span> unat <span class="main">(</span><span class="free">a'</span><span class="main">-</span><span class="free">a</span><span class="main">)</span><span class="main">*</span><span class="numeral">8</span><span class="main">)</span><span class="main">)</span><span class="main">#</span><span class="free">updates'</span><span class="main">)</span><span class="main">)</span>
                           <span class="free">a'</span> <span class="free">si'</span> <span class="free">v'</span> True"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">b</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eq_except_for_mem_def state_with_updates.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> state_update.simps<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">σ</span> <span class="keyword1">with</span> <span class="free">updates</span>"</span></span><span class="main"><span class="keyword3">;</span></span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">σ</span> <span class="keyword1">with</span> <span class="free">updates'</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> override_on_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> word_eqI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">premises</span></span> prems <span class="keyword2"><span class="keyword">for</span></span> _ _ _ _ x n
    <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"unat <span class="main">(</span><span class="skolem">x</span> <span class="main">-</span> <span class="free">a</span><span class="main">)</span> <span class="main">-</span> unat <span class="main">(</span><span class="free">a'</span> <span class="main">-</span> <span class="free">a</span><span class="main">)</span> <span class="main">=</span> unat<span class="main">(</span><span class="skolem">x</span> <span class="main">-</span> <span class="free">a'</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> address_in_enclosed_region_as_linarith<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">,</span><span class="operator">of</span> <span class="quoted"><span class="skolem">x</span></span><span class="main">]</span>
              address_of_enclosed_region_ge<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span>
              word_le_nat_alt prems<span class="main">(</span>4-5<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> unat_sub_if_size word_size<span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> prems address_in_enclosed_region<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">a'</span></span> <span class="quoted"><span class="free">si'</span></span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="free">si</span></span> <span class="quoted"><span class="skolem">x</span></span><span class="main">,</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> assms<span class="main">(</span>1<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> word_size take_byte_shiftlr_256 nth_take_byte_overwrite<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>

    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> word_eqI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> _ _ _ _ x n
      <span class="keyword1"><span class="command">using</span></span> notin_region_addresses_sub<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">x</span></span> <span class="quoted"><span class="free">a'</span></span> <span class="quoted"><span class="free">si'</span></span> <span class="quoted"><span class="free">a</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> word_size nth_take_byte_overwrite<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eq_except_for_mem_def state_with_updates.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> state_update.simps<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">σ</span> <span class="keyword1">with</span> <span class="free">updates</span>"</span></span><span class="main"><span class="keyword3">;</span></span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">σ</span> <span class="keyword1">with</span> <span class="free">updates'</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> override_on_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> enclosed_spec<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">premises</span></span> prems <span class="keyword2"><span class="keyword">for</span></span> _ _ _ _ _ x 
    <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"unat <span class="main">(</span><span class="skolem">x</span> <span class="main">-</span> <span class="free">a</span><span class="main">)</span> <span class="main">-</span> unat <span class="main">(</span><span class="free">a'</span> <span class="main">-</span> <span class="free">a</span><span class="main">)</span> <span class="main">=</span> unat<span class="main">(</span><span class="skolem">x</span> <span class="main">-</span> <span class="free">a'</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> address_in_enclosed_region_as_linarith<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">,</span><span class="operator">of</span> <span class="quoted"><span class="skolem">x</span></span><span class="main">]</span>
              address_of_enclosed_region_ge<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span>
              word_le_nat_alt prems<span class="main">(</span>6<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> unat_sub_if_size word_size<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> word_eqI<span class="main">)</span>
        <span class="keyword1"><span class="command">using</span></span> 1 prems address_in_enclosed_region<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">a'</span></span> <span class="quoted"><span class="free">si'</span></span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="free">si</span></span> <span class="quoted"><span class="skolem">x</span></span><span class="main">,</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> assms<span class="main">(</span>1<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> word_size take_byte_shiftlr_256 nth_take_byte_overwrite<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>

     <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> _ _ _ _ _ x
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> word_eqI<span class="main">)</span>
       <span class="keyword1"><span class="command">using</span></span> notin_region_addresses_sub<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">x</span></span> <span class="quoted"><span class="free">a'</span></span> <span class="quoted"><span class="free">si'</span></span> <span class="quoted"><span class="free">a</span></span><span class="main">]</span>
       <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> word_size nth_take_byte_overwrite<span class="main">)</span>
     <span class="keyword1"><span class="command">by</span></span> <span class="operator">meson</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">lemmas</span></span> eefm_clean_mem_enclosed_plus  <span class="main">=</span> eefm_clean_mem_enclosed<span class="main">[</span><span class="operator">OF</span> _ enclosed_plus<span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> eefm_clean_mem_enclosed_minus_numeral <span class="main">=</span> eefm_clean_mem_enclosed<span class="main">[</span><span class="operator">OF</span> _ enclosed_minus_minus<span class="main">,</span> <span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="quoted">"numeral <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"numeral <span class="free">m</span>"</span></span><span class="main">]</span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">n</span> <span class="free">m</span>

<span class="keyword1"><span class="command">method</span></span> eefm_clean_mem_enclosed_plus <span class="main">=</span> 
        <span class="main">(</span><span class="operator">rule</span> eefm_clean_mem_enclosed_plus<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span>
            <span class="main">(</span><span class="operator">simp</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">no_asm</span><span class="main"><span class="main">)</span></span><span class="main"><span class="keyword3">;</span></span><span class="operator">fail</span><span class="main">)</span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">no_asm</span><span class="main"><span class="main">)</span></span><span class="main"><span class="keyword3">;</span></span><span class="operator">fail</span><span class="main">)</span><span class="main"><span class="keyword3">,</span></span>
            <span class="main">(</span>
             <span class="main">(</span><span class="operator">simp</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">no_asm_simp</span><span class="main"><span class="main">)</span></span><span class="main"><span class="keyword3">;</span></span><span class="operator">fail</span><span class="main">)</span> <span class="main"><span class="keyword3">|</span></span>
             <span class="main">(</span><span class="operator">rule</span> assumptions_impI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">+</span> <span class="main">_</span> <span class="main">&lt;</span> <span class="numeral">18446744073709551616</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span><span class="operator">simp</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">no_asm_simp</span><span class="main"><span class="main">)</span></span><span class="main"><span class="keyword3">,</span></span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> assumptions_conjE<span class="main">)</span><span class="main">)</span>
            <span class="main">)</span>
        <span class="main">)</span>

<span class="keyword1"><span class="command">method</span></span> eefm_clean_mem_enclosed_minus_numeral <span class="main">=</span> 
        <span class="main">(</span><span class="operator">rule</span> eefm_clean_mem_enclosed_minus_numeral<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span>
            <span class="main">(</span><span class="operator">simp</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">no_asm</span><span class="main"><span class="main">)</span></span><span class="main"><span class="keyword3">;</span></span><span class="operator">fail</span><span class="main">)</span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">no_asm</span><span class="main"><span class="main">)</span></span><span class="main"><span class="keyword3">;</span></span><span class="operator">fail</span><span class="main">)</span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">no_asm</span><span class="main"><span class="main">)</span></span><span class="main"><span class="keyword3">;</span></span><span class="operator">fail</span><span class="main">)</span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">no_asm</span><span class="main"><span class="main">)</span></span><span class="main"><span class="keyword3">;</span></span><span class="operator">fail</span><span class="main">)</span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">no_asm</span><span class="main"><span class="main">)</span></span><span class="main"><span class="keyword3">;</span></span><span class="operator">fail</span><span class="main">)</span><span class="main"><span class="keyword3">,</span></span>
            <span class="main">(</span>
             <span class="main">(</span><span class="operator">simp</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">no_asm_simp</span><span class="main"><span class="main">)</span></span><span class="main"><span class="keyword3">;</span></span><span class="operator">fail</span><span class="main">)</span> <span class="main"><span class="keyword3">|</span></span>           
             <span class="main">(</span><span class="operator">rule</span> assumptions_impI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">≤</span> <span class="main">_</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span><span class="operator">simp</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">no_asm_simp</span><span class="main"><span class="main">)</span></span><span class="main"><span class="keyword3">,</span></span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> assumptions_conjE<span class="main">)</span><span class="main">)</span>
            <span class="main">)</span> 
        <span class="main">)</span>

<span class="keyword1" id="StateCleanUp-eefm_next_mem"><span class="command">lemma</span></span> eefm_next_mem<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"separate <span class="free">a</span> <span class="free">si</span> <span class="free">a'</span> <span class="free">si'</span>"</span></span>
   <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"eq_except_for_mem <span class="main">(</span><span class="free">σ</span> <span class="keyword1">with</span> <span class="free">updates</span><span class="main">)</span> <span class="main">(</span><span class="free">σ</span> <span class="keyword1">with</span> <span class="free">updates'</span><span class="main">)</span> <span class="free">a</span> <span class="free">si</span> <span class="free">v</span> <span class="free">b</span>"</span></span>
 <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"eq_except_for_mem <span class="main">(</span><span class="free">σ</span> <span class="keyword1">with</span> <span class="main">(</span><span class="main">(</span><span class="main">⟦</span><span class="free">a'</span><span class="main">,</span><span class="free">si'</span><span class="main">⟧</span> <span class="keyword1">:=<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">v'</span><span class="main">)</span><span class="main">#</span><span class="free">updates</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">σ</span> <span class="keyword1">with</span> <span class="main">(</span><span class="main">(</span><span class="main">⟦</span><span class="free">a'</span><span class="main">,</span><span class="free">si'</span><span class="main">⟧</span> <span class="keyword1">:=<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">v'</span><span class="main">)</span><span class="main">#</span><span class="free">updates'</span><span class="main">)</span><span class="main">)</span> <span class="free">a</span> <span class="free">si</span> <span class="free">v</span> <span class="free">b</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eq_except_for_mem_def override_on_def separate_def state_with_updates.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> state_update.simps<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">σ</span> <span class="keyword1">with</span> <span class="free">updates</span>"</span></span><span class="main"><span class="keyword3">;</span></span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">σ</span> <span class="keyword1">with</span> <span class="free">updates'</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> override_on_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">σ</span> <span class="keyword1">with</span> <span class="free">updates</span>"</span></span><span class="main"><span class="keyword3">;</span></span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">σ</span> <span class="keyword1">with</span> <span class="free">updates'</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> override_on_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> select_convs<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">method</span></span> eefm_next_mem <span class="main">=</span>        
        <span class="main">(</span><span class="operator">rule</span> eefm_next_mem<span class="main"><span class="keyword3">,</span></span>
            <span class="main">(</span>  <span class="main">(</span><span class="operator">simp</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">no_asm_simp</span><span class="main"><span class="main">)</span></span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> separate_simps state_simps<span class="main"><span class="keyword3">;</span></span> <span class="operator">fail</span><span class="main">)</span> <span class="main"><span class="keyword3">|</span></span>
               <span class="main">(</span><span class="operator">rule</span> assumptions_impI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">"separate <span class="main">_</span> <span class="main">_</span> <span class="main">_</span> <span class="main">_</span> "</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span><span class="operator">simp</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">no_asm_simp</span><span class="main"><span class="main">)</span></span><span class="main"><span class="keyword3">,</span></span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> assumptions_conjE<span class="main">)</span><span class="main">)</span>
        <span class="main">)</span>

<span class="keyword1" id="StateCleanUp-eefm_end"><span class="command">lemma</span></span> eefm_end<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"eq_except_for_mem <span class="main">(</span><span class="free">σ</span> <span class="keyword1">with</span> <span class="free">updates</span><span class="main">)</span> <span class="main">(</span><span class="free">σ</span> <span class="keyword1">with</span> <span class="free">updates</span><span class="main">)</span> <span class="free">a</span> <span class="free">si</span> <span class="free">v</span> False"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eq_except_for_mem_def<span class="main">)</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We need a tactic exactly like ``subst'' but that applies to the outer most term.›</span></span>

<span class="keyword1"><span class="command">ML_file</span></span> <span class="quoted">‹MySubst.ML›</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The following method takes a goal with state with symbolic state updates.
      It first applies <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span> eefm_start<span class="antiquote"><span class="antiquote">}</span></span></span></span>, considering the outer-most memory update to some region $\llbracket a, si \rrbracket$.
      A list <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">updates'</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is generated that produces a similar state except for region $\llbracket a, si \rrbracket$.
      The list thus can have fewer updates since any update to a region that is enclosed in region $\llbracket a, si \rrbracket$ can be removed.
      Consecutively, this method applies rules to determine whether a state update can be kept, merged or removed.
      It may add assumptions to the goal, that assume no overflow.
›</span></span>

<span class="keyword1"><span class="command">method</span></span> clean_up_mem <span class="main">=</span> <span class="main">(</span>
    <span class="operator">mysubst</span> eefm_start<span class="main"><span class="keyword3">,</span></span>
    <span class="main">(</span> <span class="operator">eefm_clean_mem</span> <span class="main"><span class="keyword3">|</span></span> <span class="operator">eefm_clean_mem_enclosed_plus</span> <span class="main"><span class="keyword3">|</span></span> <span class="operator">eefm_clean_mem_enclosed_minus_numeral</span> <span class="main"><span class="keyword3">|</span></span> <span class="operator">eefm_next_mem</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span>
    <span class="operator">rule</span> eefm_end<span class="main"><span class="keyword3">,</span></span>
    <span class="operator">simp</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">no_asm</span><span class="main"><span class="main">)</span></span><span class="main"><span class="keyword3">,</span></span>
    <span class="main">(</span><span class="main">(</span><span class="operator">match</span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">premises</span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> A<span class="main"><span class="main">[</span></span><span class="operator">thin</span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">"assumptions <span class="main">(</span><span class="var">?A</span> <span class="main">∧</span> <span class="var">?B</span><span class="main">)</span>"</span></span> <span class="main"><span class="main">⇒</span></span> <span class="quoted">‹<span class="operator">cut_tac</span> A<span class="main"><span class="keyword3">;</span></span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> assumptions_conjE<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> conjE ›</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span><span class="main"><span class="keyword3">?</span></span>
  <span class="main">)</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The method above applies to one state update. This method can be repeated as long as modifies
      the goal, as it always makes the goal smaller. The method below repeats a given method until
      the goal is unchanged. In deterministic fashion (a la the REPEAT\_DETERM tactic).›</span></span>

<span class="keyword1"><span class="command">method_setup</span></span> repeat_until_unchanged <span class="main">=</span> <span class="quoted">‹
  <span class="entity">Method.text_closure</span> &gt;&gt;
    <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">text</span> <span class="main">=&gt;</span> <span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">ctxt</span> <span class="main">=&gt;</span> <span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">using</span> <span class="main">=&gt;</span> 
          <span class="comment1">― ‹parse the method supplied as parameter›</span>
      <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">ctxt_tac</span> <span class="main">=</span> <span class="entity">Method.evaluate_runtime</span> <span class="entity">text</span> <span class="entity">ctxt</span> <span class="entity">using</span>
          <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">repeat_until_unchanged</span> <span class="main">(</span><span class="entity">ctxt</span><span class="main">,</span><span class="entity">st</span><span class="main">)</span> <span class="main">=</span> 
            <span class="keyword2"><span class="keyword">case</span></span> Seq.pull <span class="main">(</span><span class="entity">ctxt_tac</span> <span class="main">(</span><span class="entity">ctxt</span><span class="main">,</span><span class="entity">st</span><span class="main">)</span><span class="main">)</span> <span class="keyword2"><span class="keyword">of</span></span>
                SOME <span class="main">(</span>Seq.Result <span class="main">(</span><span class="entity">ctxt'</span><span class="main">,</span><span class="entity">st'</span><span class="main">)</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> <span class="main">=&gt;</span> 
                  <span class="keyword2"><span class="keyword">if</span></span> Thm.eq_thm <span class="main">(</span><span class="entity">st</span><span class="main">,</span> <span class="entity">st'</span><span class="main">)</span> <span class="keyword2"><span class="keyword">then</span></span> 
                    Seq.make_results <span class="main">(</span>Seq.succeed <span class="main">(</span><span class="entity">ctxt'</span><span class="main">,</span><span class="entity">st'</span><span class="main">)</span><span class="main">)</span>
                  <span class="keyword2"><span class="keyword">else</span></span>
                    <span class="entity">repeat_until_unchanged</span> <span class="main">(</span><span class="entity">ctxt'</span><span class="main">,</span><span class="entity">st'</span><span class="main">)</span>
              <span class="main">|</span> <span class="main">_</span> <span class="main">=&gt;</span> Seq.make_results <span class="main">(</span>Seq.succeed <span class="main">(</span><span class="entity">ctxt</span><span class="main">,</span><span class="entity">st</span><span class="main">)</span><span class="main">)</span>
      <span class="keyword2"><span class="keyword">in</span></span>
        <span class="entity">repeat_until_unchanged</span> 
      <span class="keyword2"><span class="keyword">end</span></span><span class="main">)</span>
›</span>

<span class="keyword1"><span class="command">method</span></span> clean_up <span class="main">=</span> <span class="operator">repeat_until_unchanged</span> <span class="operator">clean_up_mem</span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="files/MySubst.ML">
<div class="head">
<h1>File ‹MySubst.ML›</h1>
</div>
<pre class="source"><span class="comment1">(* The original header of the file is:

    Title:      Tools/eqsubst.ML
    Author:     Lucas Dixon, University of Edinburgh

    Perform a substitution using an equation.


    We modified this so that subst applies to the outer most term. In order to do that, I copy-pasted
    all the code below and made one minor modification.
    Please do not use this in any other context, I can give no guarantees.
*)</span>

<span class="keyword1"><span class="keyword">signature</span></span> <span class="entity">EQMYSUBST</span> <span class="main">=</span>
<span class="keyword2"><span class="keyword">sig</span></span>
  <span class="keyword1"><span class="keyword">type</span></span> <span class="entity">match</span> <span class="main">=</span>
    <span class="main">(</span><span class="main">(</span>indexname * <span class="main">(</span>sort * typ<span class="main">)</span><span class="main">)</span> list <span class="comment1">(* type instantiations *)</span>
      * <span class="main">(</span>indexname * <span class="main">(</span>typ * term<span class="main">)</span><span class="main">)</span> list<span class="main">)</span> <span class="comment1">(* term instantiations *)</span>
    * <span class="main">(</span>string * typ<span class="main">)</span> list <span class="comment1">(* fake named type abs env *)</span>
    * <span class="main">(</span>string * typ<span class="main">)</span> list <span class="comment1">(* type abs env *)</span>
    * term <span class="comment1">(* outer term *)</span>

  <span class="keyword1"><span class="keyword">type</span></span> <span class="entity">searchinfo</span> <span class="main">=</span>
    <span class="entity">Proof.context</span>
    * int <span class="comment1">(* maxidx *)</span>
    * <span class="entity">Zipper.T</span> <span class="comment1">(* focusterm to search under *)</span>

  <span class="keyword1"><span class="keyword">datatype</span></span> 'a <span class="entity">skipseq</span> <span class="main">=</span> <span class="entity">SkipMore</span> <span class="keyword2"><span class="keyword">of</span></span> int <span class="main">|</span> <span class="entity">SkipSeq</span> <span class="keyword2"><span class="keyword">of</span></span> 'a Seq.seq Seq.seq

  <span class="keyword1"><span class="keyword">val</span></span> skip_first_asm_occs_search<span class="main">:</span> <span class="main">(</span>'a <span class="main">-&gt;</span> 'b <span class="main">-&gt;</span> 'c Seq.seq Seq.seq<span class="main">)</span> <span class="main">-&gt;</span> 'a <span class="main">-&gt;</span> int <span class="main">-&gt;</span> 'b <span class="main">-&gt;</span> 'c <span class="entity">skipseq</span>
  <span class="keyword1"><span class="keyword">val</span></span> skip_first_occs_search<span class="main">:</span> int <span class="main">-&gt;</span> <span class="main">(</span>'a <span class="main">-&gt;</span> 'b <span class="main">-&gt;</span> 'c Seq.seq Seq.seq<span class="main">)</span> <span class="main">-&gt;</span> 'a <span class="main">-&gt;</span> 'b <span class="main">-&gt;</span> 'c Seq.seq
  <span class="keyword1"><span class="keyword">val</span></span> skipto_skipseq<span class="main">:</span> int <span class="main">-&gt;</span> 'a Seq.seq Seq.seq <span class="main">-&gt;</span> 'a <span class="entity">skipseq</span>

  <span class="comment1">(* tactics *)</span>
  <span class="keyword1"><span class="keyword">val</span></span> eqsubst_tac<span class="main">:</span> <span class="entity">Proof.context</span> <span class="main">-&gt;</span> bool <span class="main">-&gt;</span> 
    thm list <span class="main">-&gt;</span> int <span class="main">-&gt;</span> tactic
  <span class="keyword1"><span class="keyword">val</span></span> eqsubst_tac'<span class="main">:</span> <span class="entity">Proof.context</span> <span class="main">-&gt;</span>
    <span class="main">(</span><span class="entity">searchinfo</span> <span class="main">-&gt;</span> term <span class="main">-&gt;</span> <span class="entity">match</span> Seq.seq<span class="main">)</span> <span class="comment1">(* search function *)</span>
    <span class="main">-&gt;</span> thm <span class="comment1">(* equation theorem to rewrite with *)</span>
    <span class="main">-&gt;</span> int <span class="comment1">(* subgoal number in goal theorem *)</span>
    <span class="main">-&gt;</span> thm <span class="comment1">(* goal theorem *)</span>
    <span class="main">-&gt;</span> thm Seq.seq <span class="comment1">(* rewritten goal theorem *)</span>

  <span class="comment1">(* search for substitutions *)</span>
  <span class="keyword1"><span class="keyword">val</span></span> valid_match_start<span class="main">:</span> <span class="entity">Zipper.T</span> <span class="main">-&gt;</span> bool
  <span class="keyword1"><span class="keyword">val</span></span> search_lr_all<span class="main">:</span> <span class="entity">Zipper.T</span> <span class="main">-&gt;</span> <span class="entity">Zipper.T</span> Seq.seq
  <span class="keyword1"><span class="keyword">val</span></span> search_lr_valid<span class="main">:</span> <span class="main">(</span><span class="entity">Zipper.T</span> <span class="main">-&gt;</span> bool<span class="main">)</span> <span class="main">-&gt;</span> <span class="entity">Zipper.T</span> <span class="main">-&gt;</span> <span class="entity">Zipper.T</span> Seq.seq
  <span class="keyword1"><span class="keyword">val</span></span> searchf_lr_unify_all<span class="main">:</span> <span class="entity">searchinfo</span> <span class="main">-&gt;</span> term <span class="main">-&gt;</span> <span class="entity">match</span> Seq.seq Seq.seq
  <span class="keyword1"><span class="keyword">val</span></span> searchf_lr_unify_valid<span class="main">:</span> <span class="entity">searchinfo</span> <span class="main">-&gt;</span> term <span class="main">-&gt;</span> <span class="entity">match</span> Seq.seq Seq.seq
  <span class="keyword1"><span class="keyword">val</span></span> searchf_bt_unify_valid<span class="main">:</span> <span class="entity">searchinfo</span> <span class="main">-&gt;</span> term <span class="main">-&gt;</span> <span class="entity">match</span> Seq.seq Seq.seq
<span class="keyword2"><span class="keyword">end</span></span><span class="main">;</span>

<span class="keyword1"><span class="keyword">structure</span></span> <span class="entity">EqMySubst</span><span class="main">:</span> <span class="entity">EQMYSUBST</span> <span class="main">=</span>
<span class="keyword2"><span class="keyword">struct</span></span>

<span class="comment1">(* changes object "=" to meta "==" which prepares a given rewrite rule *)</span>
<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">prep_meta_eq</span> <span class="entity">ctxt</span> <span class="main">=</span>
  <span class="entity">Simplifier.mksimps</span> <span class="entity">ctxt</span> #&gt; map Drule.zero_var_indexes<span class="main">;</span>

<span class="comment1">(* make free vars into schematic vars with index zero *)</span>
<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">unfix_frees</span> <span class="entity">frees</span> <span class="main">=</span>
   fold <span class="main">(</span>K <span class="main">(</span>Thm.forall_elim_var <span class="inner_numeral">0</span><span class="main">)</span><span class="main">)</span> <span class="entity">frees</span> o Drule.forall_intr_list <span class="entity">frees</span><span class="main">;</span>


<span class="keyword1"><span class="keyword">type</span></span> <span class="entity">match</span> <span class="main">=</span>
  <span class="main">(</span><span class="main">(</span>indexname * <span class="main">(</span>sort * typ<span class="main">)</span><span class="main">)</span> list <span class="comment1">(* type instantiations *)</span>
   * <span class="main">(</span>indexname * <span class="main">(</span>typ * term<span class="main">)</span><span class="main">)</span> list<span class="main">)</span> <span class="comment1">(* term instantiations *)</span>
  * <span class="main">(</span>string * typ<span class="main">)</span> list <span class="comment1">(* fake named type abs env *)</span>
  * <span class="main">(</span>string * typ<span class="main">)</span> list <span class="comment1">(* type abs env *)</span>
  * term<span class="main">;</span> <span class="comment1">(* outer term *)</span>

<span class="keyword1"><span class="keyword">type</span></span> <span class="entity">searchinfo</span> <span class="main">=</span>
  <span class="entity">Proof.context</span>
  * int <span class="comment1">(* maxidx *)</span>
  * <span class="entity">Zipper.T</span><span class="main">;</span> <span class="comment1">(* focusterm to search under *)</span>


<span class="comment1">(* skipping non-empty sub-sequences but when we reach the end
   of the seq, remembering how much we have left to skip. *)</span>
<span class="keyword1"><span class="keyword">datatype</span></span> 'a <span class="entity">skipseq</span> <span class="main">=</span>
  <span class="entity">SkipMore</span> <span class="keyword2"><span class="keyword">of</span></span> int <span class="main">|</span>
  <span class="entity">SkipSeq</span> <span class="keyword2"><span class="keyword">of</span></span> 'a Seq.seq Seq.seq<span class="main">;</span>

<span class="comment1">(* given a seqseq, skip the first m non-empty seq's, note deficit *)</span>
<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">skipto_skipseq</span> <span class="entity">m</span> <span class="entity">s</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span>
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">skip_occs</span> <span class="entity">n</span> <span class="entity">sq</span> <span class="main">=</span>
      <span class="main">(</span><span class="keyword2"><span class="keyword">case</span></span> Seq.pull <span class="entity">sq</span> <span class="keyword2"><span class="keyword">of</span></span>
        NONE <span class="main">=&gt;</span> <span class="entity">SkipMore</span> <span class="entity">n</span>
      <span class="main">|</span> SOME <span class="main">(</span><span class="entity">h</span><span class="main">,</span> <span class="entity">t</span><span class="main">)</span> <span class="main">=&gt;</span>
        <span class="main">(</span><span class="keyword2"><span class="keyword">case</span></span> Seq.pull <span class="entity">h</span> <span class="keyword2"><span class="keyword">of</span></span>
          NONE <span class="main">=&gt;</span> <span class="entity">skip_occs</span> <span class="entity">n</span> <span class="entity">t</span>
        <span class="main">|</span> SOME <span class="main">_</span> <span class="main">=&gt;</span> <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">n</span> &lt;= <span class="inner_numeral">1</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="entity">SkipSeq</span> <span class="main">(</span>Seq.cons <span class="entity">h</span> <span class="entity">t</span><span class="main">)</span> <span class="keyword2"><span class="keyword">else</span></span> <span class="entity">skip_occs</span> <span class="main">(</span><span class="entity">n</span> - <span class="inner_numeral">1</span><span class="main">)</span> <span class="entity">t</span><span class="main">)</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">in</span></span> <span class="entity">skip_occs</span> <span class="entity">m</span> <span class="entity">s</span> <span class="keyword2"><span class="keyword">end</span></span><span class="main">;</span>



<span class="comment1">(* note: outerterm is the taget with the match replaced by a bound
   variable : ie: "P lhs" beocmes "%x. P x"
   insts is the types of instantiations of vars in lhs
   and typinsts is the type instantiations of types in the lhs
   Note: Final rule is the rule lifted into the ontext of the
   taget thm. *)</span>
<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">mk_foo_match</span> <span class="entity">mkuptermfunc</span> <span class="entity">Ts</span> <span class="entity">t</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">ty</span> <span class="main">=</span> Term.type_of <span class="entity">t</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">bigtype</span> <span class="main">=</span> rev <span class="main">(</span>map snd <span class="entity">Ts</span><span class="main">)</span> ---&gt; <span class="entity">ty</span>
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">mk_foo</span> <span class="inner_numeral">0</span> <span class="entity">t</span> <span class="main">=</span> <span class="entity">t</span>
      <span class="main">|</span> <span class="entity">mk_foo</span> <span class="entity">i</span> <span class="entity">t</span> <span class="main">=</span> <span class="entity">mk_foo</span> <span class="main">(</span><span class="entity">i</span> - <span class="inner_numeral">1</span><span class="main">)</span> <span class="main">(</span><span class="entity">t</span> $ <span class="main">(</span>Bound <span class="main">(</span><span class="entity">i</span> - <span class="inner_numeral">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">num_of_bnds</span> <span class="main">=</span> length <span class="entity">Ts</span>
    <span class="comment1">(* foo_term = "fooabs y0 ... yn" where y's are local bounds *)</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">foo_term</span> <span class="main">=</span> <span class="entity">mk_foo</span> <span class="entity">num_of_bnds</span> <span class="main">(</span>Bound <span class="entity">num_of_bnds</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">in</span></span> Abs <span class="main">(</span><span class="inner_quoted">"fooabs"</span><span class="main">,</span> <span class="entity">bigtype</span><span class="main">,</span> <span class="entity">mkuptermfunc</span> <span class="entity">foo_term</span><span class="main">)</span> <span class="keyword2"><span class="keyword">end</span></span><span class="main">;</span>

<span class="comment1">(* T is outer bound vars, n is number of locally bound vars *)</span>
<span class="comment1">(* THINK: is order of Ts correct...? or reversed? *)</span>
<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">mk_fake_bound_name</span> <span class="entity">n</span> <span class="main">=</span> <span class="inner_quoted">":b_"</span> ^ <span class="entity">n</span><span class="main">;</span>
<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">fakefree_badbounds</span> <span class="entity">Ts</span> <span class="entity">t</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">FakeTs</span><span class="main">,</span> <span class="entity">Ts</span><span class="main">,</span> <span class="entity">newnames</span><span class="main">)</span> <span class="main">=</span>
    fold_rev <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="entity">n</span><span class="main">,</span> <span class="entity">ty</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="entity">FakeTs</span><span class="main">,</span> <span class="entity">Ts</span><span class="main">,</span> <span class="entity">usednames</span><span class="main">)</span> <span class="main">=&gt;</span>
      <span class="keyword2"><span class="keyword">let</span></span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">newname</span> <span class="main">=</span> singleton <span class="main">(</span>Name.variant_list <span class="entity">usednames</span><span class="main">)</span> <span class="entity">n</span>
      <span class="keyword2"><span class="keyword">in</span></span>
        <span class="main">(</span><span class="main">(</span><span class="entity">mk_fake_bound_name</span> <span class="entity">newname</span><span class="main">,</span> <span class="entity">ty</span><span class="main">)</span> :: <span class="entity">FakeTs</span><span class="main">,</span>
          <span class="main">(</span><span class="entity">newname</span><span class="main">,</span> <span class="entity">ty</span><span class="main">)</span> :: <span class="entity">Ts</span><span class="main">,</span>
          <span class="entity">newname</span> :: <span class="entity">usednames</span><span class="main">)</span>
      <span class="keyword2"><span class="keyword">end</span></span><span class="main">)</span> <span class="entity">Ts</span> <span class="main">(</span><span class="main">[</span><span class="main">]</span><span class="main">,</span> <span class="main">[</span><span class="main">]</span><span class="main">,</span> <span class="main">[</span><span class="main">]</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">in</span></span> <span class="main">(</span><span class="entity">FakeTs</span><span class="main">,</span> <span class="entity">Ts</span><span class="main">,</span> Term.subst_bounds <span class="main">(</span>map Free <span class="entity">FakeTs</span><span class="main">,</span> <span class="entity">t</span><span class="main">)</span><span class="main">)</span> <span class="keyword2"><span class="keyword">end</span></span><span class="main">;</span>

<span class="comment1">(* before matching we need to fake the bound vars that are missing an
   abstraction. In this function we additionally construct the
   abstraction environment, and an outer context term (with the focus
   abstracted out) for use in rewriting with RW_Inst.rw *)</span>
<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">prep_zipper_match</span> <span class="entity">z</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">t</span> <span class="main">=</span> <span class="entity">Zipper.trm</span> <span class="entity">z</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">c</span> <span class="main">=</span> <span class="entity">Zipper.ctxt</span> <span class="entity">z</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">Ts</span> <span class="main">=</span> <span class="entity">Zipper.C.nty_ctxt</span> <span class="entity">c</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">FakeTs'</span><span class="main">,</span> <span class="entity">Ts'</span><span class="main">,</span> <span class="entity">t'</span><span class="main">)</span> <span class="main">=</span> <span class="entity">fakefree_badbounds</span> <span class="entity">Ts</span> <span class="entity">t</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">absterm</span> <span class="main">=</span> <span class="entity">mk_foo_match</span> <span class="main">(</span><span class="entity">Zipper.C.apply</span> <span class="entity">c</span><span class="main">)</span> <span class="entity">Ts'</span> <span class="entity">t'</span>
  <span class="keyword2"><span class="keyword">in</span></span>
    <span class="main">(</span><span class="entity">t'</span><span class="main">,</span> <span class="main">(</span><span class="entity">FakeTs'</span><span class="main">,</span> <span class="entity">Ts'</span><span class="main">,</span> <span class="entity">absterm</span><span class="main">)</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">end</span></span><span class="main">;</span>

<span class="comment1">(* Unification with exception handled *)</span>
<span class="comment1">(* given context, max var index, pat, tgt; returns Seq of instantiations *)</span>
<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">clean_unify</span> <span class="entity">ctxt</span> <span class="entity">ix</span> <span class="main">(</span><span class="entity">a</span> <span class="keyword1"><span class="keyword">as</span></span> <span class="main">(</span><span class="entity">pat</span><span class="main">,</span> <span class="entity">tgt</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span>
    <span class="comment1">(* type info will be re-derived, maybe this can be cached
       for efficiency? *)</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">pat_ty</span> <span class="main">=</span> Term.type_of <span class="entity">pat</span><span class="main">;</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">tgt_ty</span> <span class="main">=</span> Term.type_of <span class="entity">tgt</span><span class="main">;</span>
    <span class="comment1">(* FIXME is it OK to ignore the type instantiation info?
       or should I be using it? *)</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">typs_unify</span> <span class="main">=</span>
      SOME <span class="main">(</span>Sign.typ_unify <span class="main">(</span>Proof_Context.theory_of <span class="entity">ctxt</span><span class="main">)</span> <span class="main">(</span><span class="entity">pat_ty</span><span class="main">,</span> <span class="entity">tgt_ty</span><span class="main">)</span> <span class="main">(</span>Vartab.empty<span class="main">,</span> <span class="entity">ix</span><span class="main">)</span><span class="main">)</span>
        <span class="keyword3"><span class="keyword">handle</span></span> Type.TUNIFY <span class="main">=&gt;</span> NONE<span class="main">;</span>
  <span class="keyword2"><span class="keyword">in</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">case</span></span> <span class="entity">typs_unify</span> <span class="keyword2"><span class="keyword">of</span></span>
      SOME <span class="main">(</span><span class="entity">typinsttab</span><span class="main">,</span> <span class="entity">ix2</span><span class="main">)</span> <span class="main">=&gt;</span>
        <span class="keyword2"><span class="keyword">let</span></span>
          <span class="comment1">(* FIXME is it right to throw away the flexes?
             or should I be using them somehow? *)</span>
          <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">mk_insts</span> <span class="entity">env</span> <span class="main">=</span>
            <span class="main">(</span>Vartab.dest <span class="main">(</span>Envir.type_env <span class="entity">env</span><span class="main">)</span><span class="main">,</span>
             Vartab.dest <span class="main">(</span>Envir.term_env <span class="entity">env</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
          <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">initenv</span> <span class="main">=</span>
            Envir.Envir <span class="main">{</span>maxidx <span class="main">=</span> <span class="entity">ix2</span><span class="main">,</span> tenv <span class="main">=</span> Vartab.empty<span class="main">,</span> tyenv <span class="main">=</span> <span class="entity">typinsttab</span><span class="main">}</span><span class="main">;</span>
          <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">useq</span> <span class="main">=</span> Unify.smash_unifiers <span class="main">(</span>Context.Proof <span class="entity">ctxt</span><span class="main">)</span> <span class="main">[</span><span class="entity">a</span><span class="main">]</span> <span class="entity">initenv</span>
            <span class="keyword3"><span class="keyword">handle</span></span> ListPair.UnequalLengths <span class="main">=&gt;</span> Seq.empty
              <span class="main">|</span> Term.TERM <span class="main">_</span> <span class="main">=&gt;</span> Seq.empty<span class="main">;</span>
          <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">clean_unify'</span> <span class="entity">useq</span> <span class="main">(</span><span class="main">)</span> <span class="main">=</span>
            <span class="main">(</span><span class="keyword2"><span class="keyword">case</span></span> <span class="main">(</span>Seq.pull <span class="entity">useq</span><span class="main">)</span> <span class="keyword2"><span class="keyword">of</span></span>
               NONE <span class="main">=&gt;</span> NONE
             <span class="main">|</span> SOME <span class="main">(</span><span class="entity">h</span><span class="main">,</span> <span class="entity">t</span><span class="main">)</span> <span class="main">=&gt;</span> SOME <span class="main">(</span><span class="entity">mk_insts</span> <span class="entity">h</span><span class="main">,</span> Seq.make <span class="main">(</span><span class="entity">clean_unify'</span> <span class="entity">t</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
            <span class="keyword3"><span class="keyword">handle</span></span> ListPair.UnequalLengths <span class="main">=&gt;</span> NONE
              <span class="main">|</span> Term.TERM <span class="main">_</span> <span class="main">=&gt;</span> NONE<span class="main">;</span>
        <span class="keyword2"><span class="keyword">in</span></span>
          <span class="main">(</span>Seq.make <span class="main">(</span><span class="entity">clean_unify'</span> <span class="entity">useq</span><span class="main">)</span><span class="main">)</span>
        <span class="keyword2"><span class="keyword">end</span></span>
    <span class="main">|</span> NONE <span class="main">=&gt;</span> Seq.empty<span class="main">)</span>
  <span class="keyword2"><span class="keyword">end</span></span><span class="main">;</span>

<span class="comment1">(* Unification for zippers *)</span>
<span class="comment1">(* Note: Ts is a modified version of the original names of the outer
   bound variables. New names have been introduced to make sure they are
   unique w.r.t all names in the term and each other. usednames' is
   oldnames + new names. *)</span>
<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">clean_unify_z</span> <span class="entity">ctxt</span> <span class="entity">maxidx</span> <span class="entity">pat</span> <span class="entity">z</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">t</span><span class="main">,</span> <span class="main">(</span><span class="entity">FakeTs</span><span class="main">,</span> <span class="entity">Ts</span><span class="main">,</span> <span class="entity">absterm</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="entity">prep_zipper_match</span> <span class="entity">z</span> <span class="keyword2"><span class="keyword">in</span></span>
    Seq.map <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">insts</span> <span class="main">=&gt;</span> <span class="main">(</span><span class="entity">insts</span><span class="main">,</span> <span class="entity">FakeTs</span><span class="main">,</span> <span class="entity">Ts</span><span class="main">,</span> <span class="entity">absterm</span><span class="main">)</span><span class="main">)</span>
      <span class="main">(</span><span class="entity">clean_unify</span> <span class="entity">ctxt</span> <span class="entity">maxidx</span> <span class="main">(</span><span class="entity">t</span><span class="main">,</span> <span class="entity">pat</span><span class="main">)</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">end</span></span><span class="main">;</span>


<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">bot_left_leaf_of</span> <span class="main">(</span><span class="entity">l</span> $ <span class="main">_</span><span class="main">)</span> <span class="main">=</span> <span class="entity">bot_left_leaf_of</span> <span class="entity">l</span>
  <span class="main">|</span> <span class="entity">bot_left_leaf_of</span> <span class="main">(</span>Abs <span class="main">(</span><span class="main">_</span><span class="main">,</span> <span class="main">_</span><span class="main">,</span> <span class="entity">t</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="entity">bot_left_leaf_of</span> <span class="entity">t</span>
  <span class="main">|</span> <span class="entity">bot_left_leaf_of</span> <span class="entity">x</span> <span class="main">=</span> <span class="entity">x</span><span class="main">;</span>

<span class="comment1">(* Avoid considering replacing terms which have a var at the head as
   they always succeed trivially, and uninterestingly. *)</span>
<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">valid_match_start</span> <span class="entity">z</span> <span class="main">=</span>
  <span class="main">(</span><span class="keyword2"><span class="keyword">case</span></span> <span class="entity">bot_left_leaf_of</span> <span class="main">(</span><span class="entity">Zipper.trm</span> <span class="entity">z</span><span class="main">)</span> <span class="keyword2"><span class="keyword">of</span></span>
    Var <span class="main">_</span> <span class="main">=&gt;</span> false
  <span class="main">|</span> <span class="main">_</span> <span class="main">=&gt;</span> true<span class="main">)</span><span class="main">;</span>

<span class="comment1">(* search from top, left to right, then down *)</span>
<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">search_lr_all</span> <span class="main">=</span> <span class="entity">ZipperSearch.all_bl_ur</span><span class="main">;</span>

<span class="comment1">(* search from top, left to right, then down *)</span>
<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">search_lr_valid</span> <span class="entity">validf</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span>
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">sf_valid_td_lr</span> <span class="entity">z</span> <span class="main">=</span>
      <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">here</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">validf</span> <span class="entity">z</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="main">[</span><span class="entity">Zipper.Here</span> <span class="entity">z</span><span class="main">]</span> <span class="keyword2"><span class="keyword">else</span></span> <span class="main">[</span><span class="main">]</span> <span class="keyword2"><span class="keyword">in</span></span>
        <span class="main">(</span><span class="keyword2"><span class="keyword">case</span></span> <span class="entity">Zipper.trm</span> <span class="entity">z</span> <span class="keyword2"><span class="keyword">of</span></span>
          <span class="main">_</span> $ <span class="main">_</span> <span class="main">=&gt;</span>
            <span class="main">[</span><span class="entity">Zipper.LookIn</span> <span class="main">(</span><span class="entity">Zipper.move_down_left</span> <span class="entity">z</span><span class="main">)</span><span class="main">]</span> @ <span class="entity">here</span> @
            <span class="main">[</span><span class="entity">Zipper.LookIn</span> <span class="main">(</span><span class="entity">Zipper.move_down_right</span> <span class="entity">z</span><span class="main">)</span><span class="main">]</span>
        <span class="main">|</span> Abs <span class="main">_</span> <span class="main">=&gt;</span> <span class="entity">here</span> @ <span class="main">[</span><span class="entity">Zipper.LookIn</span> <span class="main">(</span><span class="entity">Zipper.move_down_abs</span> <span class="entity">z</span><span class="main">)</span><span class="main">]</span>
        <span class="main">|</span> <span class="main">_</span> <span class="main">=&gt;</span> <span class="entity">here</span><span class="main">)</span>
      <span class="keyword2"><span class="keyword">end</span></span><span class="main">;</span>
  <span class="keyword2"><span class="keyword">in</span></span> <span class="entity">Zipper.lzy_search</span> <span class="entity">sf_valid_td_lr</span> <span class="keyword2"><span class="keyword">end</span></span><span class="main">;</span>

<span class="comment1">(* search from bottom to top, left to right *)</span>
<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">search_bt_valid</span> <span class="entity">validf</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span>
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">sf_valid_td_lr</span> <span class="entity">z</span> <span class="main">=</span>
      <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">here</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">validf</span> <span class="entity">z</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="main">[</span><span class="entity">Zipper.Here</span> <span class="entity">z</span><span class="main">]</span> <span class="keyword2"><span class="keyword">else</span></span> <span class="main">[</span><span class="main">]</span> <span class="keyword2"><span class="keyword">in</span></span>
        <span class="main">(</span><span class="keyword2"><span class="keyword">case</span></span> <span class="entity">Zipper.trm</span> <span class="entity">z</span> <span class="keyword2"><span class="keyword">of</span></span>
          <span class="main">_</span> $ <span class="main">_</span> <span class="main">=&gt;</span>
            <span class="main">[</span><span class="entity">Zipper.LookIn</span> <span class="main">(</span><span class="entity">Zipper.move_down_left</span> <span class="entity">z</span><span class="main">)</span><span class="main">,</span>
             <span class="entity">Zipper.LookIn</span> <span class="main">(</span><span class="entity">Zipper.move_down_right</span> <span class="entity">z</span><span class="main">)</span><span class="main">]</span> @ <span class="entity">here</span>
        <span class="main">|</span> Abs <span class="main">_</span> <span class="main">=&gt;</span> <span class="main">[</span><span class="entity">Zipper.LookIn</span> <span class="main">(</span><span class="entity">Zipper.move_down_abs</span> <span class="entity">z</span><span class="main">)</span><span class="main">]</span> @ <span class="entity">here</span>
        <span class="main">|</span> <span class="main">_</span> <span class="main">=&gt;</span> <span class="entity">here</span><span class="main">)</span>
      <span class="keyword2"><span class="keyword">end</span></span><span class="main">;</span>
  <span class="keyword2"><span class="keyword">in</span></span> <span class="entity">Zipper.lzy_search</span> <span class="entity">sf_valid_td_lr</span> <span class="keyword2"><span class="keyword">end</span></span><span class="main">;</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">searchf_unify_gen</span> <span class="entity">f</span> <span class="main">(</span><span class="entity">ctxt</span><span class="main">,</span> <span class="entity">maxidx</span><span class="main">,</span> <span class="entity">z</span><span class="main">)</span> <span class="entity">lhs</span> <span class="main">=</span>
  Seq.map <span class="main">(</span><span class="entity">clean_unify_z</span> <span class="entity">ctxt</span> <span class="entity">maxidx</span> <span class="entity">lhs</span><span class="main">)</span> <span class="main">(</span><span class="entity">Zipper.limit_apply</span> <span class="entity">f</span> <span class="entity">z</span><span class="main">)</span><span class="main">;</span>

<span class="comment1">(* search all unifications *)</span>
<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">searchf_lr_unify_all</span> <span class="main">=</span> <span class="entity">searchf_unify_gen</span> <span class="entity">search_lr_all</span><span class="main">;</span>

<span class="comment1">(* search only for 'valid' unifiers (non abs subterms and non vars) *)</span>
<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">searchf_lr_unify_valid</span> <span class="main">=</span> <span class="entity">searchf_unify_gen</span> <span class="main">(</span><span class="entity">search_lr_valid</span> <span class="entity">valid_match_start</span><span class="main">)</span><span class="main">;</span>

<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">searchf_bt_unify_valid</span> <span class="main">=</span> <span class="entity">searchf_unify_gen</span> <span class="main">(</span><span class="entity">search_bt_valid</span> <span class="entity">valid_match_start</span><span class="main">)</span><span class="main">;</span>

<span class="comment1">(* apply a substitution in the conclusion of the theorem *)</span>
<span class="comment1">(* cfvs are certified free var placeholders for goal params *)</span>
<span class="comment1">(* conclthm is a theorem of for just the conclusion *)</span>
<span class="comment1">(* m is instantiation/match information *)</span>
<span class="comment1">(* rule is the equation for substitution *)</span>
<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">apply_subst_in_concl</span> <span class="entity">ctxt</span> <span class="entity">i</span> <span class="entity">st</span> <span class="main">(</span><span class="entity">cfvs</span><span class="main">,</span> <span class="entity">conclthm</span><span class="main">)</span> <span class="entity">rule</span> <span class="entity">m</span> <span class="main">=</span>
  <span class="entity">RW_Inst.rw</span> <span class="entity">ctxt</span> <span class="entity">m</span> <span class="entity">rule</span> <span class="entity">conclthm</span>
  |&gt; <span class="entity">unfix_frees</span> <span class="entity">cfvs</span>
  |&gt; Conv.fconv_rule Drule.beta_eta_conversion
  |&gt; <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">r</span> <span class="main">=&gt;</span> resolve_tac <span class="entity">ctxt</span> <span class="main">[</span><span class="entity">r</span><span class="main">]</span> <span class="entity">i</span> <span class="entity">st</span><span class="main">)</span><span class="main">;</span>

<span class="comment1">(* substitute within the conclusion of goal i of gth, using a meta
equation rule. Note that we assume rule has var indicies zero'd *)</span>
<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">prep_concl_subst</span> <span class="entity">ctxt</span> <span class="entity">i</span> <span class="entity">gth</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">th</span> <span class="main">=</span> Thm.incr_indexes <span class="inner_numeral">1</span> <span class="entity">gth</span><span class="main">;</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">tgt_term</span> <span class="main">=</span> Thm.prop_of <span class="entity">th</span><span class="main">;</span>

    <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">fixedbody</span><span class="main">,</span> <span class="entity">fvs</span><span class="main">)</span> <span class="main">=</span> <span class="entity">IsaND.fix_alls_term</span> <span class="entity">ctxt</span> <span class="entity">i</span> <span class="entity">tgt_term</span><span class="main">;</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">cfvs</span> <span class="main">=</span> rev <span class="main">(</span>map <span class="main">(</span>Thm.cterm_of <span class="entity">ctxt</span><span class="main">)</span> <span class="entity">fvs</span><span class="main">)</span><span class="main">;</span>

    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">conclterm</span> <span class="main">=</span> Logic.strip_imp_concl <span class="entity">fixedbody</span><span class="main">;</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">conclthm</span> <span class="main">=</span> Thm.trivial <span class="main">(</span>Thm.cterm_of <span class="entity">ctxt</span> <span class="entity">conclterm</span><span class="main">)</span><span class="main">;</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">maxidx</span> <span class="main">=</span> Thm.maxidx_of <span class="entity">th</span><span class="main">;</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">ft</span> <span class="main">=</span>
      <span class="main">(</span><span class="entity">Zipper.move_down_right</span> <span class="comment1">(* ==&gt; *)</span>
       o <span class="entity">Zipper.move_down_left</span> <span class="comment1">(* Trueprop *)</span>
       o <span class="entity">Zipper.mktop</span>
       o Thm.prop_of<span class="main">)</span> <span class="entity">conclthm</span>
  <span class="keyword2"><span class="keyword">in</span></span>
    <span class="main">(</span><span class="main">(</span><span class="entity">cfvs</span><span class="main">,</span> <span class="entity">conclthm</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="entity">ctxt</span><span class="main">,</span> <span class="entity">maxidx</span><span class="main">,</span> <span class="entity">ft</span><span class="main">)</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">end</span></span><span class="main">;</span>

<span class="comment1">(* substitute using an object or meta level equality *)</span>
<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">eqsubst_tac'</span> <span class="entity">ctxt</span> <span class="entity">searchf</span> <span class="entity">instepthm</span> <span class="entity">i</span> <span class="entity">st</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">cvfsconclthm</span><span class="main">,</span> <span class="entity">searchinfo</span><span class="main">)</span> <span class="main">=</span> <span class="entity">prep_concl_subst</span> <span class="entity">ctxt</span> <span class="entity">i</span> <span class="entity">st</span><span class="main">;</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">stepthms</span> <span class="main">=</span> Seq.of_list <span class="main">(</span><span class="entity">prep_meta_eq</span> <span class="entity">ctxt</span> <span class="entity">instepthm</span><span class="main">)</span><span class="main">;</span>
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">rewrite_with_thm</span> <span class="entity">r</span> <span class="main">=</span>
      <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">lhs</span><span class="main">,</span><span class="main">_</span><span class="main">)</span> <span class="main">=</span> Logic.dest_equals <span class="main">(</span>Thm.concl_of <span class="entity">r</span><span class="main">)</span> <span class="keyword2"><span class="keyword">in</span></span>
        <span class="entity">searchf</span> <span class="entity">searchinfo</span> <span class="entity">lhs</span>
        |&gt; Seq.maps <span class="main">(</span><span class="entity">apply_subst_in_concl</span> <span class="entity">ctxt</span> <span class="entity">i</span> <span class="entity">st</span> <span class="entity">cvfsconclthm</span> <span class="entity">r</span><span class="main">)</span>
      <span class="keyword2"><span class="keyword">end</span></span><span class="main">;</span>
  <span class="keyword2"><span class="keyword">in</span></span> <span class="entity">stepthms</span> |&gt; Seq.maps <span class="entity">rewrite_with_thm</span> <span class="keyword2"><span class="keyword">end</span></span><span class="main">;</span>


<span class="comment1">(* General substitution of multiple occurrences using one of
   the given theorems *)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">skip_first_occs_search</span> <span class="entity">occ</span> <span class="entity">srchf</span> <span class="entity">sinfo</span> <span class="entity">lhs</span> <span class="main">=</span>
  <span class="main">(</span><span class="keyword2"><span class="keyword">case</span></span> <span class="entity">skipto_skipseq</span> <span class="entity">occ</span> <span class="main">(</span><span class="entity">srchf</span> <span class="entity">sinfo</span> <span class="entity">lhs</span><span class="main">)</span>  <span class="keyword2"><span class="keyword">of</span></span>
    <span class="entity">SkipMore</span> <span class="main">_</span> <span class="main">=&gt;</span> Seq.empty
  <span class="main">|</span> <span class="entity">SkipSeq</span> <span class="entity">ss</span> <span class="main">=&gt;</span> Seq.flat <span class="entity">ss</span><span class="main">)</span><span class="main">;</span>

<span class="comment1">(* The "occs" argument is a list of integers indicating which occurrence
w.r.t. the search order, to rewrite. Backtracking will also find later
occurrences, but all earlier ones are skipped. Thus you can use [0] to
just find all rewrites. *)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">eqsubst_tac</span> <span class="entity">ctxt</span> <span class="entity">butlast</span> <span class="entity">thms</span> <span class="entity">i</span> <span class="entity">st</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">nprems</span> <span class="main">=</span> Thm.nprems_of <span class="entity">st</span> <span class="keyword2"><span class="keyword">in</span></span>
    <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">nprems</span> &lt; <span class="entity">i</span> <span class="keyword2"><span class="keyword">then</span></span> Seq.empty <span class="keyword2"><span class="keyword">else</span></span>
    <span class="keyword2"><span class="keyword">let</span></span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">thmseq</span> <span class="main">=</span> Seq.of_list <span class="entity">thms</span><span class="main">;</span>
      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">apply_occ</span> <span class="entity">occ</span> <span class="entity">st</span> <span class="main">=</span>
        <span class="entity">thmseq</span> |&gt; Seq.maps <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">r</span> <span class="main">=&gt;</span>
          <span class="entity">eqsubst_tac'</span> <span class="entity">ctxt</span>
            <span class="main">(</span><span class="entity">skip_first_occs_search</span> <span class="entity">occ</span> <span class="entity">searchf_lr_unify_valid</span><span class="main">)</span> <span class="entity">r</span>
            <span class="main">(</span><span class="entity">i</span> + <span class="main">(</span>Thm.nprems_of <span class="entity">st</span> - <span class="entity">nprems</span><span class="main">)</span><span class="main">)</span> <span class="entity">st</span><span class="main">)</span><span class="main">;</span>
      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">max_occ</span> <span class="entity">occ</span> <span class="entity">st</span> <span class="main">=</span> 
        <span class="keyword2"><span class="keyword">case</span></span> Seq.pull <span class="main">(</span><span class="entity">apply_occ</span> <span class="entity">occ</span> <span class="entity">st</span><span class="main">)</span> <span class="keyword2"><span class="keyword">of</span></span>
          NONE <span class="main">=&gt;</span> <span class="entity">occ</span> - <span class="inner_numeral">1</span> 
          <span class="main">|</span> <span class="main">_</span> <span class="main">=&gt;</span> <span class="entity">max_occ</span> <span class="main">(</span><span class="entity">occ</span>+<span class="inner_numeral">1</span><span class="main">)</span> <span class="entity">st</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">sorted_occs</span> <span class="main">=</span> <span class="main">[</span><span class="entity">max_occ</span> <span class="inner_numeral">0</span> <span class="entity">st</span> - <span class="main">(</span><span class="keyword2"><span class="keyword">if</span></span> <span class="entity">butlast</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="inner_numeral">1</span> <span class="keyword2"><span class="keyword">else</span></span> <span class="inner_numeral">0</span><span class="main">)</span><span class="main">]</span><span class="main">;</span>
    <span class="keyword2"><span class="keyword">in</span></span>
      Seq.maps distinct_subgoals_tac <span class="main">(</span>Seq.EVERY <span class="main">(</span>map <span class="entity">apply_occ</span> <span class="entity">sorted_occs</span><span class="main">)</span> <span class="entity">st</span><span class="main">)</span>
    <span class="keyword2"><span class="keyword">end</span></span>
  <span class="keyword2"><span class="keyword">end</span></span><span class="main">;</span>


<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">skip_first_asm_occs_search</span> <span class="entity">searchf</span> <span class="entity">sinfo</span> <span class="entity">occ</span> <span class="entity">lhs</span> <span class="main">=</span>
  <span class="entity">skipto_skipseq</span> <span class="entity">occ</span> <span class="main">(</span><span class="entity">searchf</span> <span class="entity">sinfo</span> <span class="entity">lhs</span><span class="main">)</span><span class="main">;</span>


<span class="comment1">(* combination method that takes a flag (true indicates that subst
   should be done to an assumption, false = apply to the conclusion of
   the goal) as well as the theorems to use *)</span>
<span class="keyword1"><span class="keyword">val</span></span> <span class="main">_</span> <span class="main">=</span>
  Theory.setup
    <span class="main">(</span><span class="entity">Method.setup</span> <span class="antiquoted"><span class="entity"><span class="operator"><span class="hidden">\&lt;^</span><span class="control">binding</span><span class="hidden">&gt;</span></span>‹mysubst›</span></span>
      <span class="main">(</span>Scan.lift <span class="main">(</span>Args.mode <span class="inner_quoted">"butlast"</span><span class="main">)</span> --
        <span class="entity">Attrib.thms</span> &gt;&gt; <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="main">(</span><span class="entity">butlast</span><span class="main">)</span><span class="main">,</span> <span class="entity">inthms</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">ctxt</span> <span class="main">=&gt;</span>
          <span class="entity">SIMPLE_METHOD'</span> <span class="main">(</span><span class="entity">eqsubst_tac</span> <span class="entity">ctxt</span> <span class="entity">butlast</span> <span class="entity">inthms</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
      <span class="inner_quoted">"single-step substitution"</span><span class="main">)</span><span class="main">;</span>

<span class="keyword2"><span class="keyword">end</span></span><span class="main">;</span>
</pre>
</div><div id="SymbolicExecution">
<div class="head">
<h1>Theory SymbolicExecution</h1>
</div>
<pre class="source"><span class="comment1">(*  Title:       X86 instruction semantics and basic block symbolic execution
    Authors:     Freek Verbeek, Abhijith Bharadwaj, Joshua Bockenek, Ian Roessle, Timmy Weerwag, Binoy Ravindran
    Year:        2020
    Maintainer:  Freek Verbeek (freek@vt.edu)
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">"A symbolic execution engine"</span></span>


<span class="keyword1"><span class="command">theory</span></span> SymbolicExecution
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="#X86_InstructionSemantics">X86_InstructionSemantics</a> <a href="#StateCleanUp">StateCleanUp</a>
<span class="keyword2"><span class="keyword">begin</span></span>



<span class="keyword1"><span class="command">definition</span></span> <span class="entity">eq</span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">≜</span>"</span> 50<span class="main">)</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="free">(≜)</span></span> <span class="main">≡</span> <span class="main">(=)</span>"</span></span>

<span class="keyword1"><span class="command">context</span></span> unknowns
<span class="keyword2"><span class="keyword">begin</span></span> 


<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">run</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="numeral">64</span> word <span class="main">⇒</span> <span class="main">(</span><span class="numeral">64</span> word <span class="main">⇒</span> I<span class="main">)</span> <span class="main">⇒</span> state <span class="main">⇒</span> state <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> 
    <span class="quoted"><span class="quoted">"rip <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">a<span class="hidden">⇩</span><sub>f</sub></span></span></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">fetch</span></span></span> <span class="main">(</span>rip <span class="free"><span class="bound"><span class="entity">σ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">σ'</span></span></span> <span class="main">≜</span> step <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">⟹</span> <span class="free">run</span> <span class="free"><span class="bound"><span class="entity">a<span class="hidden">⇩</span><sub>f</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">fetch</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">σ'</span></span></span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"rip <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">≠</span> <span class="free"><span class="bound"><span class="entity">a<span class="hidden">⇩</span><sub>f</sub></span></span></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">fetch</span></span></span> <span class="main">(</span>rip <span class="free"><span class="bound"><span class="entity">σ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">⟹</span> <span class="free">run</span> <span class="free"><span class="bound"><span class="entity">a<span class="hidden">⇩</span><sub>f</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">fetch</span></span></span> <span class="main">(</span>step <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">σ'</span></span></span> <span class="main">⟹</span> <span class="free">run</span> <span class="free"><span class="bound"><span class="entity">a<span class="hidden">⇩</span><sub>f</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">fetch</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">σ'</span></span></span>"</span></span>


<span class="keyword1"><span class="command">method</span></span> fetch_and_execute <span class="main">=</span> <span class="main">(</span>
   <span class="main">(</span><span class="main">(</span><span class="operator">rule</span> run.intros<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="keyword3">,</span></span><span class="main">(</span><span class="operator">simp</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">no_asm</span><span class="main"><span class="main">)</span></span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> state_simps<span class="main"><span class="keyword3">;</span></span><span class="operator">fail</span><span class="main">)</span><span class="main">)</span>
    <span class="main"><span class="keyword3">|</span></span> <span class="main">(</span><span class="operator">rule</span> run.intros<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="keyword3">,</span></span><span class="main">(</span><span class="operator">simp</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">no_asm</span><span class="main"><span class="main">)</span></span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> state_simps<span class="main"><span class="keyword3">;</span></span><span class="operator">fail</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main"><span class="keyword3">,</span></span>
   <span class="main">(</span><span class="operator">simp</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">no_asm</span><span class="main"><span class="main">)</span></span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> state_simps<span class="main">)</span><span class="main"><span class="keyword3">,</span></span>                                             <span class="comment1">― ‹fetch instruction›</span>
   <span class="main">(</span><span class="operator">simp</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">no_asm_simp</span><span class="main"><span class="main">)</span></span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> step_def semantics_simps state_simps BitByte_simps<span class="main">)</span><span class="main"><span class="keyword3">,</span></span> <span class="comment1">― ‹simplification›</span>
   <span class="main">(</span><span class="operator">subst</span> clean_state_updates<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span><span class="operator">simp</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">no_asm</span><span class="main"><span class="main">)</span></span><span class="main">)</span>                          <span class="comment1">― ‹cleaning up›</span>
 <span class="main">)</span>

<span class="keyword1"><span class="command">method</span></span> resolve_mem_reads <span class="main">=</span> <span class="main">(</span>
  <span class="operator">subst</span> mem_read_mem_write_separate<span class="main"><span class="keyword3">,</span></span>
  <span class="main">(</span><span class="main">(</span><span class="operator">simp</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">no_asm_simp</span><span class="main"><span class="main">)</span></span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> separate_simps state_simps<span class="main"><span class="keyword3">;</span></span> <span class="operator">fail</span><span class="main">)</span> 
   <span class="main"><span class="keyword3">|</span></span> <span class="main">(</span><span class="operator">rule</span> assumptions_impI<span class="main"><span class="keyword3">,</span></span><span class="operator">simp</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">no_asm_simp</span><span class="main"><span class="main">)</span></span><span class="main"><span class="keyword3">,</span></span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> assumptions_conjE<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> conjE<span class="main">)</span><span class="main">)</span><span class="main"><span class="keyword3">,</span></span>
  <span class="main">(</span><span class="operator">simp</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">no_asm_simp</span><span class="main"><span class="main">)</span></span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> semantics_simps state_simps BitByte_simps separate_simps<span class="main">)</span><span class="main"><span class="keyword3">?</span></span>
 <span class="main">)</span>

<span class="keyword1"><span class="command">method</span></span> se_step <span class="main">=</span> 
  <span class="operator">fetch_and_execute</span><span class="main"><span class="keyword3">,</span></span>
  <span class="main">(</span><span class="main">(</span><span class="operator">resolve_mem_reads</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">;</span></span><span class="main">(</span><span class="operator">subst</span> clean_state_updates<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span><span class="operator">simp</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">no_asm</span><span class="main"><span class="main">)</span></span><span class="main">)</span><span class="main">)</span><span class="main"><span class="keyword3">?</span></span><span class="main"><span class="keyword3">,</span></span>
  <span class="operator">clean_up</span>

<span class="keyword1"><span class="command">method</span></span> se_step_no_clean <span class="main">=</span> 
  <span class="operator">fetch_and_execute</span><span class="main"><span class="keyword3">,</span></span>
  <span class="main">(</span><span class="main">(</span><span class="operator">resolve_mem_reads</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">;</span></span><span class="main">(</span><span class="operator">subst</span> clean_state_updates<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span><span class="operator">simp</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">no_asm</span><span class="main"><span class="main">)</span></span><span class="main">)</span><span class="main">)</span><span class="main"><span class="keyword3">?</span></span>

<span class="keyword2"><span class="keyword">end</span></span>


<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">RSP0</span> 
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">RSP0</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">≡</span> regs <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="inner_quoted">''rsp''</span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">RBP0</span> 
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">RBP0</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">≡</span> regs <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="inner_quoted">''rbp''</span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">RAX0</span> 
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">RAX0</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">≡</span> regs <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="inner_quoted">''rax''</span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">RBX0</span> 
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">RBX0</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">≡</span> regs <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="inner_quoted">''rbx''</span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">RCX0</span> 
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">RCX0</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">≡</span> regs <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="inner_quoted">''rcx''</span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">RDX0</span> 
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">RDX0</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">≡</span> regs <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="inner_quoted">''rdx''</span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">RDI0</span> 
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">RDI0</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">≡</span> regs <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="inner_quoted">''rdi''</span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">RSI0</span> 
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">RSI0</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">≡</span> regs <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="inner_quoted">''rsi''</span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">R150</span> 
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">R150</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">≡</span> regs <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="inner_quoted">''r15''</span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">R140</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">R140</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">≡</span> regs <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="inner_quoted">''r14''</span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">R130</span> 
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">R130</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">≡</span> regs <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="inner_quoted">''r13''</span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">R120</span> 
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">R120</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">≡</span> regs <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="inner_quoted">''r12''</span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">R110</span> 
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">R110</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">≡</span> regs <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="inner_quoted">''r11''</span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">R100</span> 
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">R100</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">≡</span> regs <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="inner_quoted">''r10''</span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">R90</span> 
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">R90</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">≡</span> regs <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="inner_quoted">''r9''</span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">R80</span> 
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">R80</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">≡</span> regs <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="inner_quoted">''r8''</span>"</span></span>



<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Repeat a command up to n times, in deterministic fashion (a la the REPEAT\_DETERM tactic).›</span></span>

<span class="keyword1"><span class="command">method_setup</span></span> repeat_n <span class="main">=</span> <span class="quoted">‹
  Scan.lift Parse.nat -- <span class="entity">Method.text_closure</span> &gt;&gt;
    <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="entity">n</span><span class="main">,</span><span class="entity">text</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">ctxt</span> <span class="main">=&gt;</span> <span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">using</span> <span class="main">=&gt;</span> 
      <span class="keyword2"><span class="keyword">let</span></span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">ctxt_tac</span> <span class="main">=</span> <span class="entity">Method.evaluate_runtime</span> <span class="entity">text</span> <span class="entity">ctxt</span> <span class="entity">using</span><span class="main">;</span>
        <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">repeat_n</span> <span class="inner_numeral">0</span> <span class="entity">ctxt_st</span> <span class="main">=</span> Seq.make_results <span class="main">(</span>Seq.succeed <span class="entity">ctxt_st</span><span class="main">)</span>
          <span class="main">|</span> <span class="entity">repeat_n</span> <span class="entity">i</span> <span class="entity">ctxt_st</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">case</span></span> Seq.pull <span class="main">(</span><span class="entity">ctxt_tac</span> <span class="entity">ctxt_st</span><span class="main">)</span> <span class="keyword2"><span class="keyword">of</span></span>
                            SOME <span class="main">(</span>Seq.Result <span class="entity">ctxt_st'</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="entity">repeat_n</span> <span class="main">(</span><span class="entity">i</span>-<span class="inner_numeral">1</span><span class="main">)</span> <span class="entity">ctxt_st'</span>
                          <span class="main">|</span> <span class="main">_</span> <span class="main">=&gt;</span> Seq.make_results <span class="main">(</span>Seq.succeed <span class="entity">ctxt_st</span><span class="main">)</span>
      <span class="keyword2"><span class="keyword">in</span></span>
        <span class="entity">repeat_n</span> <span class="entity">n</span>
      <span class="keyword2"><span class="keyword">end</span></span><span class="main">)</span>
›</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Examples">
<div class="head">
<h1>Theory Examples</h1>
</div>
<pre class="source"><span class="comment1">(*  Title:       X86 instruction semantics and basic block symbolic execution
    Authors:     Freek Verbeek, Abhijith Bharadwaj, Joshua Bockenek, Ian Roessle, Timmy Weerwag, Binoy Ravindran
    Year:        2020
    Maintainer:  Freek Verbeek (freek@vt.edu)
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">"Small examples"</span></span>

<span class="keyword1"><span class="command">theory</span></span> Examples
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="#SymbolicExecution">SymbolicExecution</a> 
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">context</span></span> unknowns
<span class="keyword2"><span class="keyword">begin</span></span>
  
  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  A simple hand-crafted example showing some basic instructions. 
›</span></span>


<span class="keyword1"><span class="command">schematic_goal</span></span> example1<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span><span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">fetch</span> <span class="numeral">0x0</span>  <span class="main">=</span> PUSH <span class="main">(</span>Reg <span class="inner_quoted">''rbp''</span><span class="main">)</span> <span class="main">1</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span><span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">fetch</span> <span class="numeral">0x1</span>  <span class="main">=</span> SUB  <span class="main">(</span>Reg <span class="inner_quoted">''rsp''</span><span class="main">)</span> <span class="main">(</span>Imm <span class="numeral">30</span><span class="main">)</span> <span class="numeral">2</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span><span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">fetch</span> <span class="numeral">0x2</span>  <span class="main">=</span> MOV  <span class="main">(</span><span class="keyword1">QWORD</span> <span class="keyword1">PTR</span> <span class="main">[</span><span class="numeral">22</span> <span class="main">+</span> <span class="inner_quoted">''rsp''</span><span class="main">]<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">(</span>Imm <span class="numeral">42</span><span class="main">)</span> <span class="numeral">3</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span><span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">fetch</span> <span class="numeral">0x3</span>  <span class="main">=</span> MOV  <span class="main">(</span><span class="keyword1">QWORD</span> <span class="keyword1">PTR</span> <span class="main">[</span><span class="numeral">30</span> <span class="main">+</span> <span class="inner_quoted">''rsp''</span><span class="main">]<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">(</span>Imm <span class="numeral">43</span><span class="main">)</span> <span class="numeral">4</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span><span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">fetch</span> <span class="numeral">0x4</span>  <span class="main">=</span> ADD  <span class="main">(</span>Reg <span class="inner_quoted">''rsp''</span><span class="main">)</span> <span class="main">(</span>Imm <span class="numeral">30</span><span class="main">)</span> <span class="numeral">5</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span><span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">fetch</span> <span class="numeral">0x5</span>  <span class="main">=</span> POP  <span class="main">(</span>Reg <span class="inner_quoted">''rbp''</span><span class="main">)</span> <span class="numeral">6</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span><span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">fetch</span> <span class="numeral">0x6</span>  <span class="main">=</span> RET <span class="main">1</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"run <span class="numeral">0x6</span> <span class="free">fetch</span> <span class="main">(</span><span class="free">σ</span> <span class="keyword1">with</span> <span class="main">[</span><span class="keyword1">setRip</span> <span class="numeral">0x0</span><span class="main">]</span><span class="main">)</span> <span class="var">?σ'</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">se_step</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> eq_def<span class="main"><span class="keyword3">,</span></span><span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">thm</span></span> example1




<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Demonstrates little-endian memory and register-aliasing›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹
\begin{verbatim}
  RAX +   0    1    2     3     4     5     6     7
        | FF | EE | DD  | CC  | BB  | AA  | 00  | 00  |
  
  EDI := 0xCCDDEEFF
  EBX := 0xAABB
  RCX := 0xAABBCCDDAABB
\end{verbatim}
›</span></span>

<span class="keyword1"><span class="command">schematic_goal</span></span> example2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span><span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">fetch</span> <span class="numeral">0x0</span>   <span class="main">=</span> MOV  <span class="main">(</span><span class="keyword1">QWORD</span> <span class="keyword1">PTR</span> <span class="main">[</span><span class="inner_quoted">''rax''</span><span class="main">]<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">(</span>Imm <span class="numeral">0xAABBCCDDEEFF</span><span class="main">)</span> <span class="main">1</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span><span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">fetch</span> <span class="numeral">0x1</span>   <span class="main">=</span> MOV  <span class="main">(</span>Reg <span class="inner_quoted">''edi''</span><span class="main">)</span>          <span class="main">(</span><span class="keyword1">DWORD</span> <span class="keyword1">PTR</span> <span class="main">[</span><span class="inner_quoted">''rax''</span><span class="main">]<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="numeral">2</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span><span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">fetch</span> <span class="numeral">0x2</span>   <span class="main">=</span> MOV  <span class="main">(</span>Reg <span class="inner_quoted">''ebx''</span><span class="main">)</span>          <span class="main">(</span><span class="keyword1">DWORD</span> <span class="keyword1">PTR</span> <span class="main">[</span><span class="numeral">4</span> <span class="main">+</span> <span class="inner_quoted">''rax''</span><span class="main">]<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="numeral">3</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span><span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">fetch</span> <span class="numeral">0x3</span>   <span class="main">=</span> MOV  <span class="main">(</span>Reg <span class="inner_quoted">''rcx''</span><span class="main">)</span>          <span class="main">(</span><span class="keyword1">QWORD</span> <span class="keyword1">PTR</span> <span class="main">[</span><span class="inner_quoted">''rax''</span><span class="main">]<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="numeral">4</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span><span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">fetch</span> <span class="numeral">0x4</span>   <span class="main">=</span> MOV   <span class="main">(</span>Reg <span class="inner_quoted">''cx''</span><span class="main">)</span>          <span class="main">(</span><span class="keyword1">WORD</span> <span class="keyword1">PTR</span>  <span class="main">[</span><span class="numeral">4</span> <span class="main">+</span> <span class="inner_quoted">''rax''</span><span class="main">]<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="numeral">5</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"run <span class="numeral">0x4</span> <span class="free">fetch</span> <span class="main">(</span><span class="free">σ</span> <span class="keyword1">with</span> <span class="main">[</span><span class="keyword1">setRip</span> <span class="numeral">0x0</span><span class="main">]</span><span class="main">)</span> <span class="var">?σ'</span>"</span></span> 
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">se_step</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> eq_def<span class="main"><span class="keyword3">,</span></span><span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">thm</span></span> example2

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  This example show how assumptions over regions are generated.
  Since no relation over rax and rbx is known in the initial state, they will be assumed to be
  separate by default.
›</span></span>
<span class="keyword1"><span class="command">schematic_goal</span></span> example3<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span><span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">fetch</span> <span class="numeral">0x0</span>   <span class="main">=</span> MOV  <span class="main">(</span><span class="keyword1">QWORD</span> <span class="keyword1">PTR</span> <span class="main">[</span><span class="inner_quoted">''rax''</span><span class="main">]<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">(</span>Imm <span class="numeral">0xAABBCCDDEEFF</span><span class="main">)</span> <span class="main">1</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span><span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">fetch</span> <span class="numeral">0x1</span>   <span class="main">=</span> MOV  <span class="main">(</span><span class="keyword1">QWORD</span> <span class="keyword1">PTR</span> <span class="main">[</span><span class="inner_quoted">''rbx''</span><span class="main">]<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">(</span>Imm <span class="numeral">0x112233445566</span><span class="main">)</span> <span class="numeral">2</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span><span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">fetch</span> <span class="numeral">0x2</span>   <span class="main">=</span> MOV  <span class="main">(</span>Reg <span class="inner_quoted">''rcx''</span><span class="main">)</span>          <span class="main">(</span><span class="keyword1">DWORD</span> <span class="keyword1">PTR</span> <span class="main">[</span><span class="numeral">2</span> <span class="main">+</span> <span class="inner_quoted">''rax''</span><span class="main">]<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="numeral">3</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span><span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">fetch</span> <span class="numeral">0x3</span>   <span class="main">=</span> MOV  <span class="main">(</span>Reg <span class="inner_quoted">''cx''</span><span class="main">)</span>           <span class="main">(</span><span class="keyword1">WORD</span> <span class="keyword1">PTR</span>  <span class="main">[</span><span class="numeral">4</span> <span class="main">+</span> <span class="inner_quoted">''rbx''</span><span class="main">]<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="numeral">4</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span><span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">fetch</span> <span class="numeral">0x4</span>   <span class="main">=</span> MOV  <span class="main">(</span>Reg <span class="inner_quoted">''cl''</span><span class="main">)</span>           <span class="main">(</span><span class="keyword1">BYTE</span> <span class="keyword1">PTR</span>  <span class="main">[</span><span class="inner_quoted">''rax''</span><span class="main">]<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="numeral">5</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"assumptions <span class="var">?A</span> <span class="main">⟹</span> run <span class="numeral">0x4</span> <span class="free">fetch</span> <span class="main">(</span><span class="free">σ</span> <span class="keyword1">with</span> <span class="main">[</span><span class="keyword1">setRip</span> <span class="numeral">0x0</span><span class="main">]</span><span class="main">)</span> <span class="var">?σ'</span>"</span></span> 
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">se_step</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> eq_def<span class="main"><span class="keyword3">,</span></span><span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">thm</span></span> example3

<span class="keyword2"><span class="keyword">end</span></span>







<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="X86_Parse">
<div class="head">
<h1>Theory X86_Parse</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Parser›</span></span>

<span class="keyword1"><span class="command">theory</span></span> X86_Parse
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="#X86_InstructionSemantics">X86_InstructionSemantics</a>
  <span class="keyword2"><span class="keyword">keywords</span></span> <span class="quoted">"x86_64_parser"</span> <span class="main">::</span> thy_decl
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">ML_file</span></span> <span class="quoted">‹X86_Parse.ML›</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="files/X86_Parse.ML">
<div class="head">
<h1>File ‹X86_Parse.ML›</h1>
</div>
<pre class="source">

<span class="comment1">(* TODO: segment registers *)</span>

<span class="keyword1"><span class="keyword">datatype</span></span> <span class="entity">Operand</span> <span class="main">=</span>
           <span class="comment1">(*  size (in bytes)   segment           offset   base     index    scale *)</span>
    <span class="entity">Mem</span> <span class="keyword2"><span class="keyword">of</span></span> <span class="main">(</span>   int             * string option   * int    * string * string * int<span class="main">)</span>
  <span class="main">|</span> <span class="entity">Reg</span> <span class="keyword2"><span class="keyword">of</span></span> string
  <span class="main">|</span> <span class="entity">Imm</span> <span class="keyword2"><span class="keyword">of</span></span> LargeInt.int

<span class="keyword1"><span class="keyword">datatype</span></span> <span class="entity">Instr</span> <span class="main">=</span> <span class="entity">Instr</span> <span class="keyword2"><span class="keyword">of</span></span> <span class="main">(</span>LargeInt.int * LargeInt.int * string * Operand option * Operand option * Operand option<span class="main">)</span>

<span class="comment1">(* PRETTY PRINTING *)</span>
<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">pp_option</span> NONE <span class="main">=</span> <span class="inner_quoted">""</span>
  <span class="main">|</span> <span class="entity">pp_option</span> <span class="main">(</span>SOME <span class="entity">s</span><span class="main">)</span> <span class="main">=</span> <span class="entity">s</span>

<span class="keyword1"><span class="keyword">fun</span></span>
  <span class="entity">pp_mem_size</span> <span class="inner_numeral">1</span> <span class="main">=</span> <span class="inner_quoted">"BYTE PTR"</span>
<span class="main">|</span> <span class="entity">pp_mem_size</span> <span class="inner_numeral">2</span> <span class="main">=</span> <span class="inner_quoted">"WORD PTR"</span>
<span class="main">|</span> <span class="entity">pp_mem_size</span> <span class="inner_numeral">4</span> <span class="main">=</span> <span class="inner_quoted">"DWORD PTR"</span>
<span class="main">|</span> <span class="entity">pp_mem_size</span> <span class="inner_numeral">8</span> <span class="main">=</span> <span class="inner_quoted">"QWORD PTR"</span>
<span class="main">|</span> <span class="entity">pp_mem_size</span> <span class="inner_numeral">16</span> <span class="main">=</span> <span class="inner_quoted">"XMMWORD PTR"</span>
<span class="main">|</span> <span class="entity">pp_mem_size</span> <span class="entity">n</span> <span class="main">=</span> <span class="inner_quoted">"SIZEDIR "</span> ^ Int.toString <span class="main">(</span><span class="entity">n</span>*<span class="inner_numeral">8</span><span class="main">)</span> ^ <span class="inner_quoted">" PTR"</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">pp_operand</span> <span class="main">(</span><span class="entity">Mem</span> <span class="main">(</span><span class="entity">si</span><span class="main">,</span><span class="entity">segment</span><span class="main">,</span><span class="entity">offset</span><span class="main">,</span><span class="entity">base</span><span class="main">,</span> <span class="entity">index</span><span class="main">,</span> <span class="entity">scale</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
    <span class="entity">pp_mem_size</span> <span class="entity">si</span> ^ <span class="inner_quoted">" "</span> ^ <span class="entity">pp_option</span> <span class="entity">segment</span> ^ <span class="inner_quoted">":["</span> ^ Int.toString <span class="entity">offset</span> ^ <span class="inner_quoted">" + "</span> ^ <span class="entity">base</span> ^ <span class="inner_quoted">" + "</span> ^ <span class="entity">index</span> ^ <span class="inner_quoted">" * "</span> ^ Int.toString <span class="entity">scale</span> ^ <span class="inner_quoted">"]"</span>
<span class="main">|</span> <span class="entity">pp_operand</span> <span class="main">(</span><span class="entity">Reg</span> <span class="entity">r</span><span class="main">)</span> <span class="main">=</span> <span class="entity">r</span>
<span class="main">|</span> <span class="entity">pp_operand</span> <span class="main">(</span><span class="entity">Imm</span> <span class="entity">i</span><span class="main">)</span> <span class="main">=</span> Int.toString <span class="entity">i</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">pp_operands</span> <span class="main">[</span><span class="main">]</span> <span class="main">=</span> <span class="inner_quoted">""</span>
  <span class="main">|</span> <span class="entity">pp_operands</span> <span class="main">(</span>NONE::<span class="main">_</span><span class="main">)</span> <span class="main">=</span> <span class="inner_quoted">""</span>
  <span class="main">|</span> <span class="entity">pp_operands</span> <span class="main">[</span>SOME <span class="entity">op1</span><span class="main">]</span> <span class="main">=</span> <span class="entity">pp_operand</span> <span class="entity">op1</span>
  <span class="main">|</span> <span class="entity">pp_operands</span> <span class="main">[</span>SOME <span class="entity">op1</span><span class="main">,</span>NONE<span class="main">]</span> <span class="main">=</span> <span class="entity">pp_operand</span> <span class="entity">op1</span>
  <span class="main">|</span> <span class="entity">pp_operands</span> <span class="main">(</span>SOME <span class="entity">op1</span>::<span class="entity">op2</span>::<span class="entity">ops</span><span class="main">)</span> <span class="main">=</span> <span class="entity">pp_operand</span> <span class="entity">op1</span> ^ <span class="inner_quoted">", "</span> ^ <span class="entity">pp_operands</span> <span class="main">(</span><span class="entity">op2</span>::<span class="entity">ops</span><span class="main">)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">pp_instr</span> <span class="main">(</span><span class="entity">Instr</span> <span class="main">(</span><span class="entity">a</span><span class="main">,</span><span class="entity">si</span><span class="main">,</span><span class="entity">m</span><span class="main">,</span><span class="entity">op1</span><span class="main">,</span><span class="entity">op2</span><span class="main">,</span><span class="entity">op3</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
  LargeInt.toString <span class="entity">a</span> ^ <span class="inner_quoted">": "</span> ^ <span class="entity">m</span> ^ <span class="inner_quoted">" "</span> ^ <span class="entity">pp_operands</span> <span class="main">[</span><span class="entity">op1</span><span class="main">,</span><span class="entity">op2</span><span class="main">,</span><span class="entity">op3</span><span class="main">]</span> ^ <span class="inner_quoted">"  ("</span> ^ LargeInt.toString <span class="entity">si</span> ^ <span class="inner_quoted">")"</span>

<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">intFromHexString</span> <span class="main">=</span> StringCvt.scanString <span class="main">(</span>LargeInt.scan StringCvt.HEX<span class="main">)</span> o Substring.string

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">intFromHexString_forced</span> <span class="entity">s</span> <span class="main">=</span>
    <span class="keyword2"><span class="keyword">case</span></span> <span class="entity">intFromHexString</span> <span class="entity">s</span> <span class="keyword2"><span class="keyword">of</span></span>
         SOME <span class="entity">i</span> <span class="main">=&gt;</span> <span class="entity">i</span>
       <span class="main">|</span> NONE <span class="main">=&gt;</span> <span class="keyword3"><span class="keyword">raise</span></span> Fail <span class="main">(</span><span class="inner_quoted">"Could not convert string '"</span> ^ Substring.string <span class="entity">s</span> ^ <span class="inner_quoted">"' to int."</span><span class="main">)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">is_whitespace</span> <span class="entity">c</span> <span class="main">=</span> <span class="main">(</span><span class="entity">c</span> <span class="main">=</span> <span class="inner_quoted">#" "</span> <span class="keyword1"><span class="keyword">orelse</span></span> <span class="entity">c</span> <span class="main">=</span> <span class="inner_quoted">#"\t"</span>  <span class="keyword1"><span class="keyword">orelse</span></span> <span class="entity">c</span> <span class="main">=</span> <span class="inner_quoted">#"\n"</span><span class="main">)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">trim</span> <span class="entity">str</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="main">_</span><span class="main">,</span><span class="entity">x</span><span class="main">)</span> <span class="main">=</span> Substring.splitl <span class="entity">is_whitespace</span> <span class="entity">str</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">y</span><span class="main">,</span><span class="main">_</span><span class="main">)</span> <span class="main">=</span> Substring.splitr <span class="entity">is_whitespace</span> <span class="entity">x</span> <span class="keyword2"><span class="keyword">in</span></span>
    <span class="entity">y</span>
  <span class="keyword2"><span class="keyword">end</span></span><span class="main">;</span>

<span class="comment1">(* PARSING *)</span>

<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">registers</span> <span class="main">=</span> <span class="main">[</span>
  <span class="inner_quoted">"rip"</span><span class="main">,</span>
  <span class="inner_quoted">"rax"</span><span class="main">,</span> <span class="inner_quoted">"eax"</span><span class="main">,</span> <span class="inner_quoted">"ax"</span><span class="main">,</span> <span class="inner_quoted">"ah"</span><span class="main">,</span> <span class="inner_quoted">"al"</span><span class="main">,</span>
  <span class="inner_quoted">"rbx"</span><span class="main">,</span> <span class="inner_quoted">"ebx"</span><span class="main">,</span> <span class="inner_quoted">"bx"</span><span class="main">,</span> <span class="inner_quoted">"bh"</span><span class="main">,</span> <span class="inner_quoted">"bl"</span><span class="main">,</span>
  <span class="inner_quoted">"rcx"</span><span class="main">,</span> <span class="inner_quoted">"ecx"</span><span class="main">,</span> <span class="inner_quoted">"cx"</span><span class="main">,</span> <span class="inner_quoted">"ch"</span><span class="main">,</span> <span class="inner_quoted">"cl"</span><span class="main">,</span>
  <span class="inner_quoted">"rdx"</span><span class="main">,</span> <span class="inner_quoted">"edx"</span><span class="main">,</span> <span class="inner_quoted">"dx"</span><span class="main">,</span> <span class="inner_quoted">"dh"</span><span class="main">,</span> <span class="inner_quoted">"dl"</span><span class="main">,</span>
  <span class="inner_quoted">"rbp"</span><span class="main">,</span> <span class="inner_quoted">"ebp"</span><span class="main">,</span> <span class="inner_quoted">"bp"</span><span class="main">,</span> <span class="inner_quoted">"bpl"</span><span class="main">,</span>
  <span class="inner_quoted">"rsp"</span><span class="main">,</span> <span class="inner_quoted">"esp"</span><span class="main">,</span> <span class="inner_quoted">"sp"</span><span class="main">,</span> <span class="inner_quoted">"spl"</span><span class="main">,</span>
  <span class="inner_quoted">"rdi"</span><span class="main">,</span> <span class="inner_quoted">"edi"</span><span class="main">,</span> <span class="inner_quoted">"di"</span><span class="main">,</span> <span class="inner_quoted">"dil"</span><span class="main">,</span>
  <span class="inner_quoted">"rsi"</span><span class="main">,</span> <span class="inner_quoted">"esi"</span><span class="main">,</span> <span class="inner_quoted">"si"</span><span class="main">,</span> <span class="inner_quoted">"sil"</span><span class="main">,</span>
  <span class="inner_quoted">"r15"</span><span class="main">,</span> <span class="inner_quoted">"r15d"</span><span class="main">,</span> <span class="inner_quoted">"r15w"</span><span class="main">,</span> <span class="inner_quoted">"r15b"</span><span class="main">,</span>
  <span class="inner_quoted">"r14"</span><span class="main">,</span> <span class="inner_quoted">"r14d"</span><span class="main">,</span> <span class="inner_quoted">"r14w"</span><span class="main">,</span> <span class="inner_quoted">"r14b"</span><span class="main">,</span>
  <span class="inner_quoted">"r13"</span><span class="main">,</span> <span class="inner_quoted">"r13d"</span><span class="main">,</span> <span class="inner_quoted">"r13w"</span><span class="main">,</span> <span class="inner_quoted">"r13b"</span><span class="main">,</span>
  <span class="inner_quoted">"r12"</span><span class="main">,</span> <span class="inner_quoted">"r12d"</span><span class="main">,</span> <span class="inner_quoted">"r12w"</span><span class="main">,</span> <span class="inner_quoted">"r12b"</span><span class="main">,</span>
  <span class="inner_quoted">"r11"</span><span class="main">,</span> <span class="inner_quoted">"r11d"</span><span class="main">,</span> <span class="inner_quoted">"r11w"</span><span class="main">,</span> <span class="inner_quoted">"r11b"</span><span class="main">,</span>
  <span class="inner_quoted">"r10"</span><span class="main">,</span> <span class="inner_quoted">"r10d"</span><span class="main">,</span> <span class="inner_quoted">"r10w"</span><span class="main">,</span> <span class="inner_quoted">"r10b"</span><span class="main">,</span>
  <span class="inner_quoted">"r9"</span><span class="main">,</span> <span class="inner_quoted">"r9d"</span><span class="main">,</span> <span class="inner_quoted">"r9w"</span><span class="main">,</span> <span class="inner_quoted">"r9b"</span><span class="main">,</span>
  <span class="inner_quoted">"r8"</span><span class="main">,</span> <span class="inner_quoted">"r8d"</span><span class="main">,</span> <span class="inner_quoted">"r8w"</span><span class="main">,</span> <span class="inner_quoted">"r8b"</span><span class="main">,</span>

  <span class="inner_quoted">"xmm0"</span><span class="main">,</span><span class="inner_quoted">"xmm1"</span><span class="main">,</span><span class="inner_quoted">"xmm2"</span><span class="main">,</span><span class="inner_quoted">"xmm3"</span><span class="main">,</span><span class="inner_quoted">"xmm4"</span><span class="main">,</span><span class="inner_quoted">"xmm5"</span><span class="main">,</span><span class="inner_quoted">"xmm6"</span><span class="main">,</span><span class="inner_quoted">"xmm7"</span><span class="main">,</span><span class="inner_quoted">"xmm8"</span><span class="main">,</span>
  <span class="inner_quoted">"xmm9"</span><span class="main">,</span><span class="inner_quoted">"xmm10"</span><span class="main">,</span><span class="inner_quoted">"xmm11"</span><span class="main">,</span><span class="inner_quoted">"xmm12"</span><span class="main">,</span><span class="inner_quoted">"xmm13"</span><span class="main">,</span><span class="inner_quoted">"xmm14"</span><span class="main">,</span><span class="inner_quoted">"xmm15"</span>
<span class="main">]</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">is_register</span> <span class="entity">str</span> <span class="main">=</span> List.find <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="entity">str'</span><span class="main">)</span> <span class="main">=&gt;</span> String.compare <span class="main">(</span>Substring.string <span class="entity">str</span><span class="main">,</span><span class="entity">str'</span><span class="main">)</span> <span class="main">=</span> EQUAL<span class="main">)</span> <span class="entity">registers</span> &lt;&gt; NONE

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">overwrite_str</span> <span class="inner_quoted">""</span> <span class="entity">s</span> <span class="main">=</span> <span class="entity">s</span>
<span class="main">|</span> <span class="entity">overwrite_str</span> <span class="entity">s</span> <span class="inner_quoted">""</span> <span class="main">=</span> <span class="entity">s</span>
<span class="main">|</span> <span class="entity">overwrite_str</span> <span class="main">_</span>  <span class="entity">s</span> <span class="main">=</span> <span class="entity">s</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">overwrite_str_option</span> NONE <span class="entity">s</span> <span class="main">=</span> <span class="entity">s</span>
<span class="main">|</span> <span class="entity">overwrite_str_option</span> <span class="entity">s</span> NONE <span class="main">=</span> <span class="entity">s</span>
<span class="main">|</span> <span class="entity">overwrite_str_option</span> <span class="main">_</span> <span class="entity">s</span>     <span class="main">=</span> <span class="entity">s</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">max</span> <span class="entity">x</span> <span class="entity">y</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">x</span> &gt;= <span class="entity">y</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="entity">x</span> <span class="keyword2"><span class="keyword">else</span></span> <span class="entity">y</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">overwrite_Mem</span> <span class="main">(</span><span class="entity">Mem</span> <span class="main">(</span><span class="entity">si</span><span class="main">,</span><span class="entity">seg</span><span class="main">,</span><span class="entity">off</span><span class="main">,</span><span class="entity">base</span><span class="main">,</span><span class="entity">ind</span><span class="main">,</span><span class="entity">sc</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="entity">Mem</span> <span class="main">(</span><span class="entity">si'</span><span class="main">,</span><span class="entity">seg'</span><span class="main">,</span><span class="entity">off'</span><span class="main">,</span><span class="entity">base'</span><span class="main">,</span><span class="entity">ind'</span><span class="main">,</span><span class="entity">sc'</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
  <span class="entity">Mem</span> <span class="main">(</span><span class="entity">max</span> <span class="entity">si</span> <span class="entity">si'</span><span class="main">,</span><span class="entity">overwrite_str_option</span> <span class="entity">seg</span> <span class="entity">seg'</span><span class="main">,</span><span class="entity">max</span> <span class="entity">off</span> <span class="entity">off'</span><span class="main">,</span><span class="entity">overwrite_str</span> <span class="entity">base</span> <span class="entity">base'</span><span class="main">,</span><span class="entity">overwrite_str</span> <span class="entity">ind</span> <span class="entity">ind'</span><span class="main">,</span><span class="entity">max</span> <span class="entity">sc</span> <span class="entity">sc'</span><span class="main">)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">parse_operand_address_between_brackets_inner</span> <span class="entity">str</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">is_register</span> <span class="entity">str</span> <span class="keyword2"><span class="keyword">then</span></span>
    <span class="entity">Mem</span> <span class="main">(</span><span class="inner_numeral">0</span><span class="main">,</span>NONE<span class="main">,</span><span class="inner_numeral">0</span><span class="main">,</span>Substring.string <span class="entity">str</span><span class="main">,</span><span class="inner_quoted">""</span><span class="main">,</span><span class="inner_numeral">0</span><span class="main">)</span> <span class="comment1">(* base *)</span>
  <span class="keyword2"><span class="keyword">else</span></span>
    <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">tokens</span> <span class="main">=</span> map <span class="entity">trim</span> <span class="main">(</span>Substring.tokens <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">c</span> <span class="main">=&gt;</span> <span class="entity">c</span> <span class="main">=</span> <span class="inner_quoted">#"*"</span><span class="main">)</span> <span class="entity">str</span><span class="main">)</span> <span class="keyword2"><span class="keyword">in</span></span>
      <span class="keyword2"><span class="keyword">if</span></span> length <span class="entity">tokens</span> <span class="main">=</span> <span class="inner_numeral">1</span> <span class="keyword2"><span class="keyword">then</span></span>
        <span class="keyword2"><span class="keyword">case</span></span> <span class="entity">intFromHexString</span> <span class="entity">str</span> <span class="keyword2"><span class="keyword">of</span></span>
          SOME <span class="entity">i</span> <span class="main">=&gt;</span> <span class="entity">Mem</span> <span class="main">(</span><span class="inner_numeral">0</span><span class="main">,</span>NONE<span class="main">,</span><span class="entity">i</span><span class="main">,</span><span class="inner_quoted">""</span><span class="main">,</span><span class="inner_quoted">""</span><span class="main">,</span><span class="inner_numeral">0</span><span class="main">)</span> <span class="comment1">(* offset *)</span>
          <span class="main">|</span> NONE <span class="main">=&gt;</span> <span class="keyword3"><span class="keyword">raise</span></span> Fail <span class="main">(</span><span class="inner_quoted">"Don't know how to parse operand part:"</span> ^ Substring.string <span class="entity">str</span><span class="main">)</span>
      <span class="keyword2"><span class="keyword">else</span></span> <span class="keyword2"><span class="keyword">if</span></span> length <span class="entity">tokens</span> <span class="main">=</span> <span class="inner_numeral">2</span> <span class="keyword2"><span class="keyword">then</span></span>
        <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">is_register</span> <span class="main">(</span>nth <span class="entity">tokens</span> <span class="inner_numeral">0</span><span class="main">)</span> <span class="keyword2"><span class="keyword">then</span></span>
          <span class="entity">Mem</span> <span class="main">(</span><span class="inner_numeral">0</span><span class="main">,</span>NONE<span class="main">,</span><span class="inner_numeral">0</span><span class="main">,</span><span class="inner_quoted">""</span><span class="main">,</span>Substring.string <span class="main">(</span>nth <span class="entity">tokens</span> <span class="inner_numeral">0</span><span class="main">)</span><span class="main">,</span><span class="entity">intFromHexString_forced</span> <span class="main">(</span>nth <span class="entity">tokens</span> <span class="inner_numeral">1</span><span class="main">)</span><span class="main">)</span> <span class="comment1">(* index * scale *)</span>
        <span class="keyword2"><span class="keyword">else</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">is_register</span> <span class="main">(</span>nth <span class="entity">tokens</span> <span class="inner_numeral">1</span><span class="main">)</span> <span class="keyword2"><span class="keyword">then</span></span>
          <span class="entity">Mem</span> <span class="main">(</span><span class="inner_numeral">0</span><span class="main">,</span>NONE<span class="main">,</span><span class="inner_numeral">0</span><span class="main">,</span><span class="inner_quoted">""</span><span class="main">,</span>Substring.string <span class="main">(</span>nth <span class="entity">tokens</span> <span class="inner_numeral">1</span><span class="main">)</span><span class="main">,</span><span class="entity">intFromHexString_forced</span> <span class="main">(</span>nth <span class="entity">tokens</span> <span class="inner_numeral">0</span><span class="main">)</span><span class="main">)</span> <span class="comment1">(* scale * index *)</span>
        <span class="keyword2"><span class="keyword">else</span></span>
          <span class="keyword3"><span class="keyword">raise</span></span> Fail <span class="main">(</span><span class="inner_quoted">"Don't know how to parse operand part:"</span> ^ Substring.string <span class="entity">str</span><span class="main">)</span>
      <span class="keyword2"><span class="keyword">else</span></span>
        <span class="keyword3"><span class="keyword">raise</span></span> Fail <span class="main">(</span><span class="inner_quoted">"Don't know how to parse operand part:"</span> ^ Substring.string <span class="entity">str</span><span class="main">)</span>
    <span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">parse_operand_address_between_brackets_sum</span> <span class="entity">si</span> <span class="entity">segment_reg</span> <span class="entity">str</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">tokens</span> <span class="main">=</span> map <span class="entity">trim</span> <span class="main">(</span>Substring.tokens <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">c</span> <span class="main">=&gt;</span> <span class="entity">c</span> <span class="main">=</span> <span class="inner_quoted">#"+"</span><span class="main">)</span> <span class="entity">str</span><span class="main">)</span> <span class="keyword2"><span class="keyword">in</span></span>
    fold <span class="main">(</span><span class="entity">overwrite_Mem</span> o <span class="entity">parse_operand_address_between_brackets_inner</span><span class="main">)</span>
         <span class="entity">tokens</span>
         <span class="main">(</span><span class="entity">Mem</span> <span class="main">(</span><span class="entity">si</span><span class="main">,</span><span class="entity">segment_reg</span> <span class="main">,</span><span class="inner_numeral">0</span><span class="main">,</span><span class="inner_quoted">""</span><span class="main">,</span><span class="inner_quoted">""</span><span class="main">,</span><span class="inner_numeral">0</span><span class="main">)</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">end</span></span><span class="main">;</span>


<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">parse_operand_address_between_brackets_sub</span> <span class="entity">si</span> <span class="entity">segment_reg</span> <span class="entity">str</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">lhs</span><span class="main">,</span><span class="entity">num</span><span class="main">)</span> <span class="main">=</span> Substring.splitl <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">c</span> <span class="main">=&gt;</span> <span class="entity">c</span> &lt;&gt; <span class="inner_quoted">#"-"</span><span class="main">)</span> <span class="entity">str</span><span class="main">;</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">Mem</span> <span class="main">(</span><span class="entity">x0</span><span class="main">,</span><span class="entity">x1</span><span class="main">,</span><span class="main">_</span><span class="main">,</span><span class="entity">x3</span><span class="main">,</span><span class="entity">x4</span><span class="main">,</span><span class="entity">x5</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="entity">parse_operand_address_between_brackets_sum</span> <span class="entity">si</span> <span class="entity">segment_reg</span> <span class="entity">lhs</span> <span class="keyword2"><span class="keyword">in</span></span>
    <span class="entity">Mem</span> <span class="main">(</span><span class="entity">x0</span><span class="main">,</span><span class="entity">x1</span><span class="main">,</span><span class="entity">intFromHexString_forced</span> <span class="entity">num</span><span class="main">,</span><span class="entity">x3</span><span class="main">,</span><span class="entity">x4</span><span class="main">,</span><span class="entity">x5</span><span class="main">)</span>
   <span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">parse_operand_address_between_brackets</span> <span class="entity">si</span> <span class="entity">segment_reg</span> <span class="entity">str</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="main">_</span><span class="main">,</span><span class="entity">num</span><span class="main">)</span> <span class="main">=</span> Substring.splitl <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">c</span> <span class="main">=&gt;</span> <span class="entity">c</span> &lt;&gt; <span class="inner_quoted">#"-"</span><span class="main">)</span> <span class="entity">str</span> <span class="keyword2"><span class="keyword">in</span></span>
    <span class="keyword2"><span class="keyword">if</span></span> Substring.isEmpty <span class="entity">num</span> <span class="keyword2"><span class="keyword">then</span></span>
      <span class="entity">parse_operand_address_between_brackets_sum</span> <span class="entity">si</span> <span class="entity">segment_reg</span> <span class="entity">str</span>
    <span class="keyword2"><span class="keyword">else</span></span>
      <span class="entity">parse_operand_address_between_brackets_sub</span> <span class="entity">si</span> <span class="entity">segment_reg</span> <span class="entity">str</span>
      <span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">skip_brackets</span> <span class="entity">str</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">x</span><span class="main">,</span><span class="entity">y</span><span class="main">)</span> <span class="main">=</span> Substring.splitAt <span class="main">(</span><span class="entity">trim</span> <span class="entity">str</span><span class="main">,</span><span class="inner_numeral">1</span><span class="main">)</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">z</span><span class="main">,</span><span class="main">_</span><span class="main">)</span> <span class="main">=</span> Substring.splitl <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">c</span> <span class="main">=&gt;</span> <span class="entity">c</span> &lt;&gt; <span class="inner_quoted">#"]"</span><span class="main">)</span> <span class="entity">y</span> <span class="keyword2"><span class="keyword">in</span></span>
    <span class="keyword2"><span class="keyword">if</span></span> Substring.compare <span class="main">(</span><span class="entity">x</span><span class="main">,</span>Substring.full <span class="inner_quoted">"["</span><span class="main">)</span> <span class="main">=</span> EQUAL <span class="keyword2"><span class="keyword">then</span></span>
      <span class="entity">z</span>
    <span class="keyword2"><span class="keyword">else</span></span>
      <span class="keyword3"><span class="keyword">raise</span></span> Fail <span class="main">(</span><span class="inner_quoted">"Expecting non-empty bracketed string preceded with colon or an immediate in hex-format, but got: "</span> ^ Substring.string <span class="entity">str</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">end</span></span><span class="main">;</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">parse_operand_address_bracketed</span> <span class="entity">si</span> <span class="entity">segment_reg</span> <span class="entity">str</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">case</span></span> <span class="entity">intFromHexString</span> <span class="entity">str</span> <span class="keyword2"><span class="keyword">of</span></span>
      SOME <span class="entity">imm</span> <span class="main">=&gt;</span> <span class="entity">Mem</span> <span class="main">(</span><span class="entity">si</span><span class="main">,</span><span class="entity">segment_reg</span><span class="main">,</span><span class="entity">imm</span><span class="main">,</span><span class="inner_quoted">""</span><span class="main">,</span> <span class="inner_quoted">""</span><span class="main">,</span><span class="inner_numeral">0</span><span class="main">)</span>
    <span class="main">|</span> NONE <span class="main">=&gt;</span> <span class="entity">parse_operand_address_between_brackets</span> <span class="entity">si</span> <span class="entity">segment_reg</span> <span class="main">(</span><span class="entity">skip_brackets</span> <span class="entity">str</span><span class="main">)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">tail</span> <span class="entity">str</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">case</span></span> Substring.getc <span class="entity">str</span> <span class="keyword2"><span class="keyword">of</span></span>
      NONE <span class="main">=&gt;</span> <span class="keyword3"><span class="keyword">raise</span></span> Fail <span class="main">(</span><span class="inner_quoted">"Expecting non-empty string, but got: "</span> ^ Substring.string <span class="entity">str</span><span class="main">)</span>
    <span class="main">|</span> SOME <span class="main">(</span><span class="main">_</span><span class="main">,</span><span class="entity">s</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="entity">s</span><span class="main">;</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">parse_operand_address</span> <span class="entity">si</span> <span class="entity">str</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">case</span></span> Substring.splitl <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">c</span> <span class="main">=&gt;</span> <span class="entity">c</span> &lt;&gt; <span class="inner_quoted">#":"</span><span class="main">)</span> <span class="entity">str</span> <span class="keyword2"><span class="keyword">of</span></span>
      <span class="main">(</span><span class="entity">before_colon</span><span class="main">,</span> <span class="entity">after_colon</span><span class="main">)</span> <span class="main">=&gt;</span>
          <span class="keyword2"><span class="keyword">if</span></span> Substring.isEmpty <span class="entity">after_colon</span> <span class="keyword2"><span class="keyword">then</span></span>
            <span class="entity">parse_operand_address_bracketed</span> <span class="entity">si</span> NONE <span class="entity">before_colon</span>
          <span class="keyword2"><span class="keyword">else</span></span>
            <span class="entity">parse_operand_address_bracketed</span> <span class="entity">si</span> <span class="main">(</span>SOME <span class="main">(</span>Substring.string <span class="main">(</span><span class="entity">trim</span> <span class="entity">before_colon</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="entity">tail</span> <span class="entity">after_colon</span><span class="main">)</span><span class="main">;</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">parse_operand</span> <span class="entity">str'</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">str</span> <span class="main">=</span> <span class="entity">trim</span> <span class="entity">str'</span> <span class="keyword2"><span class="keyword">in</span></span>
    <span class="keyword2"><span class="keyword">if</span></span> Substring.isPrefix <span class="inner_quoted">"BYTE PTR"</span> <span class="entity">str</span> <span class="keyword2"><span class="keyword">then</span></span>
      <span class="entity">parse_operand_address</span> <span class="inner_numeral">1</span> <span class="main">(</span>snd <span class="main">(</span>Substring.splitAt <span class="main">(</span><span class="entity">str</span><span class="main">,</span><span class="inner_numeral">8</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
    <span class="keyword2"><span class="keyword">else</span></span> <span class="keyword2"><span class="keyword">if</span></span> Substring.isPrefix <span class="inner_quoted">"WORD PTR"</span> <span class="entity">str</span> <span class="keyword2"><span class="keyword">then</span></span>
      <span class="entity">parse_operand_address</span> <span class="inner_numeral">2</span> <span class="main">(</span>snd <span class="main">(</span>Substring.splitAt <span class="main">(</span><span class="entity">str</span><span class="main">,</span><span class="inner_numeral">8</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
    <span class="keyword2"><span class="keyword">else</span></span> <span class="keyword2"><span class="keyword">if</span></span> Substring.isPrefix <span class="inner_quoted">"DWORD PTR"</span> <span class="entity">str</span> <span class="keyword2"><span class="keyword">then</span></span>
      <span class="entity">parse_operand_address</span> <span class="inner_numeral">4</span> <span class="main">(</span>snd <span class="main">(</span>Substring.splitAt <span class="main">(</span><span class="entity">str</span><span class="main">,</span><span class="inner_numeral">9</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
    <span class="keyword2"><span class="keyword">else</span></span> <span class="keyword2"><span class="keyword">if</span></span> Substring.isPrefix <span class="inner_quoted">"QWORD PTR"</span> <span class="entity">str</span> <span class="keyword2"><span class="keyword">then</span></span>
      <span class="entity">parse_operand_address</span> <span class="inner_numeral">8</span> <span class="main">(</span>snd <span class="main">(</span>Substring.splitAt <span class="main">(</span><span class="entity">str</span><span class="main">,</span><span class="inner_numeral">9</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
    <span class="keyword2"><span class="keyword">else</span></span> <span class="keyword2"><span class="keyword">if</span></span> Substring.isPrefix <span class="inner_quoted">"XMMWORD PTR"</span> <span class="entity">str</span> <span class="keyword2"><span class="keyword">then</span></span>
      <span class="entity">parse_operand_address</span> <span class="inner_numeral">16</span> <span class="main">(</span>snd <span class="main">(</span>Substring.splitAt <span class="main">(</span><span class="entity">str</span><span class="main">,</span><span class="inner_numeral">11</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
    <span class="keyword2"><span class="keyword">else</span></span> <span class="keyword2"><span class="keyword">if</span></span> Substring.isPrefix <span class="inner_quoted">"["</span> <span class="entity">str</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="comment1">(* happens in case of a LEA instruction *)</span>
      <span class="entity">parse_operand_address</span> <span class="inner_numeral">0</span> <span class="entity">str</span>
    <span class="keyword2"><span class="keyword">else</span></span> <span class="keyword2"><span class="keyword">if</span></span> List.find <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="entity">str'</span><span class="main">)</span> <span class="main">=&gt;</span> String.compare <span class="main">(</span>Substring.string <span class="entity">str</span><span class="main">,</span><span class="entity">str'</span><span class="main">)</span> <span class="main">=</span> EQUAL<span class="main">)</span> <span class="entity">registers</span> &lt;&gt; NONE <span class="keyword2"><span class="keyword">then</span></span>
      <span class="entity">Reg</span> <span class="main">(</span>Substring.string <span class="entity">str</span><span class="main">)</span>
    <span class="keyword2"><span class="keyword">else</span></span>
      <span class="keyword2"><span class="keyword">case</span></span> <span class="entity">intFromHexString</span> <span class="entity">str</span> <span class="keyword2"><span class="keyword">of</span></span>
          NONE <span class="main">=&gt;</span> <span class="keyword3"><span class="keyword">raise</span></span> Fail <span class="main">(</span><span class="inner_quoted">"Cannot read hex number in string: "</span> ^ <span class="main">(</span>Substring.string <span class="entity">str</span><span class="main">)</span><span class="main">)</span>
        <span class="main">|</span> SOME <span class="entity">imm</span> <span class="main">=&gt;</span> <span class="entity">Imm</span> <span class="entity">imm</span>
  <span class="keyword2"><span class="keyword">end</span></span><span class="main">;</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">parse_operands</span> <span class="entity">str</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">tokens</span> <span class="main">=</span> map <span class="entity">trim</span> <span class="main">(</span>Substring.tokens <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">c</span> <span class="main">=&gt;</span> <span class="entity">c</span> <span class="main">=</span> <span class="inner_quoted">#","</span><span class="main">)</span> <span class="main">(</span><span class="entity">trim</span> <span class="entity">str</span><span class="main">)</span><span class="main">)</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">ops</span> <span class="main">=</span> map <span class="entity">parse_operand</span> <span class="entity">tokens</span> <span class="keyword2"><span class="keyword">in</span></span>
    <span class="keyword2"><span class="keyword">case</span></span> <span class="entity">ops</span> <span class="keyword2"><span class="keyword">of</span></span>
        <span class="main">[</span><span class="main">]</span> <span class="main">=&gt;</span> <span class="main">(</span>NONE<span class="main">,</span>NONE<span class="main">,</span>NONE<span class="main">)</span>
      <span class="main">|</span> <span class="main">[</span><span class="entity">op1</span><span class="main">]</span> <span class="main">=&gt;</span> <span class="main">(</span>SOME <span class="entity">op1</span><span class="main">,</span>NONE<span class="main">,</span>NONE<span class="main">)</span>
      <span class="main">|</span> <span class="main">[</span><span class="entity">op1</span><span class="main">,</span><span class="entity">op2</span><span class="main">]</span> <span class="main">=&gt;</span> <span class="main">(</span>SOME <span class="entity">op1</span><span class="main">,</span>SOME <span class="entity">op2</span><span class="main">,</span>NONE<span class="main">)</span>
      <span class="main">|</span> <span class="main">[</span><span class="entity">op1</span><span class="main">,</span><span class="entity">op2</span><span class="main">,</span><span class="entity">op3</span><span class="main">]</span> <span class="main">=&gt;</span> <span class="main">(</span>SOME <span class="entity">op1</span><span class="main">,</span>SOME <span class="entity">op2</span><span class="main">,</span>SOME <span class="entity">op3</span><span class="main">)</span>
      <span class="main">|</span> <span class="main">_</span> <span class="main">=&gt;</span> <span class="keyword3"><span class="keyword">raise</span></span> Fail <span class="main">(</span><span class="inner_quoted">"Unexpected number of operands in : "</span> ^ Substring.string <span class="entity">str</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">end</span></span><span class="main">;</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">remove_comment</span> <span class="entity">str</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">str0</span><span class="main">,</span><span class="entity">str1</span><span class="main">)</span> <span class="main">=</span> Substring.splitl <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">c</span> <span class="main">=&gt;</span> <span class="entity">c</span> &lt;&gt; <span class="inner_quoted">#"#"</span> <span class="keyword1"><span class="keyword">andalso</span></span> <span class="entity">c</span> &lt;&gt; <span class="inner_quoted">#"&lt;"</span><span class="main">)</span> <span class="entity">str</span>
  <span class="keyword2"><span class="keyword">in</span></span>
    <span class="keyword2"><span class="keyword">if</span></span> Substring.isEmpty <span class="entity">str1</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="entity">str0</span> <span class="keyword2"><span class="keyword">else</span></span> Substring.trimr <span class="inner_numeral">1</span> <span class="entity">str0</span>
  <span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">parse_external_func</span> <span class="entity">a</span> <span class="entity">si</span> <span class="entity">str</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">m</span><span class="main">,</span><span class="entity">func</span><span class="main">)</span>  <span class="main">=</span> Substring.splitl <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">c</span> <span class="main">=&gt;</span> <span class="entity">c</span> &lt;&gt; <span class="inner_quoted">#" "</span><span class="main">)</span> <span class="entity">str</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">func_name</span> <span class="main">=</span>  Substring.string <span class="main">(</span><span class="entity">trim</span> <span class="entity">func</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">in</span></span>
    <span class="entity">Instr</span> <span class="main">(</span><span class="entity">a</span><span class="main">,</span> <span class="entity">si</span><span class="main">,</span> Substring.string <span class="entity">m</span><span class="main">,</span> SOME <span class="main">(</span><span class="entity">Reg</span> <span class="entity">func_name</span><span class="main">)</span><span class="main">,</span> NONE<span class="main">,</span> NONE<span class="main">)</span>
  <span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">parse_normal_instr</span> <span class="entity">a</span> <span class="entity">si</span> <span class="entity">str</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="main">_</span><span class="main">,</span><span class="entity">rem1</span><span class="main">)</span>      <span class="main">=</span> Substring.splitl <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">c</span> <span class="main">=&gt;</span> <span class="entity">c</span> <span class="main">=</span>  <span class="inner_quoted">#":"</span> <span class="keyword1"><span class="keyword">orelse</span></span> <span class="entity">c</span> <span class="main">=</span> <span class="inner_quoted">#" "</span><span class="main">)</span> <span class="entity">str</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">m</span><span class="main">,</span><span class="entity">rem2</span><span class="main">)</span>      <span class="main">=</span> Substring.splitl <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">c</span> <span class="main">=&gt;</span> <span class="entity">c</span> &lt;&gt; <span class="inner_quoted">#" "</span><span class="main">)</span> <span class="entity">rem1</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">op1</span><span class="main">,</span><span class="entity">op2</span><span class="main">,</span><span class="entity">op3</span><span class="main">)</span> <span class="main">=</span> <span class="entity">parse_operands</span> <span class="entity">rem2</span> <span class="keyword2"><span class="keyword">in</span></span>
    <span class="entity">Instr</span> <span class="main">(</span><span class="entity">a</span><span class="main">,</span> <span class="entity">si</span><span class="main">,</span> Substring.string <span class="entity">m</span><span class="main">,</span> <span class="entity">op1</span><span class="main">,</span><span class="entity">op2</span><span class="main">,</span><span class="entity">op3</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">end</span></span><span class="main">;</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">parse_instr</span> <span class="entity">si</span> <span class="entity">str</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">str'</span>          <span class="main">=</span> <span class="entity">remove_comment</span> <span class="main">(</span>Substring.full <span class="entity">str</span><span class="main">)</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">addr</span><span class="main">,</span><span class="entity">rem0</span><span class="main">)</span>   <span class="main">=</span> Substring.splitl <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">c</span> <span class="main">=&gt;</span> <span class="entity">c</span> &lt;&gt; <span class="inner_quoted">#":"</span><span class="main">)</span> <span class="entity">str'</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">a</span>             <span class="main">=</span> <span class="entity">intFromHexString_forced</span> <span class="main">(</span>Substring.full <span class="main">(</span><span class="inner_quoted">"0x"</span> ^ Substring.string <span class="main">(</span><span class="entity">trim</span> <span class="entity">addr</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">in</span></span>
    <span class="keyword2"><span class="keyword">if</span></span> Substring.isPrefix <span class="inner_quoted">"EXTERNAL_FUNCTION"</span> <span class="main">(</span><span class="entity">trim</span> <span class="main">(</span><span class="entity">tail</span> <span class="main">(</span><span class="entity">rem0</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="keyword2"><span class="keyword">then</span></span>
      <span class="entity">parse_external_func</span> <span class="entity">a</span> <span class="entity">si</span> <span class="main">(</span><span class="entity">trim</span> <span class="main">(</span><span class="entity">tail</span> <span class="main">(</span><span class="entity">rem0</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
    <span class="keyword2"><span class="keyword">else</span></span>
      <span class="entity">parse_normal_instr</span> <span class="entity">a</span> <span class="entity">si</span> <span class="entity">rem0</span>
  <span class="keyword2"><span class="keyword">end</span></span><span class="main">;</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">read_instr_addr</span> <span class="entity">str</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">instr</span> <span class="main">=</span> <span class="entity">parse_instr</span> <span class="inner_numeral">0</span> <span class="entity">str</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">Instr</span> <span class="main">(</span><span class="entity">a</span><span class="main">,</span><span class="main">_</span><span class="main">,</span><span class="main">_</span><span class="main">,</span><span class="main">_</span><span class="main">,</span><span class="main">_</span><span class="main">,</span><span class="main">_</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="entity">instr</span> <span class="keyword2"><span class="keyword">in</span></span>
    <span class="entity">a</span>
  <span class="keyword2"><span class="keyword">end</span></span>

<span class="comment1">(* EMBEDDING INTO HOL *)</span>

<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">mk_nat</span> <span class="main">=</span> <span class="entity">HOLogic.mk_number</span> <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">typ</span> <span class="quoted">nat</span><span class="antiquote">}</span></span>
<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">mk_string</span> <span class="main">=</span> <span class="entity">HOLogic.mk_string</span>
<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">mk_word_typ_from_num</span> <span class="entity">s</span> <span class="main">=</span> Syntax.read_typ <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">context</span><span class="antiquote">}</span></span></span> <span class="main">(</span><span class="inner_quoted">"num ⇒ "</span> ^ Int.toString <span class="entity">s</span> ^ <span class="inner_quoted">" word"</span><span class="main">)</span>
<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">mk_word_typ</span> <span class="entity">s</span> <span class="main">=</span> Syntax.read_typ <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">context</span><span class="antiquote">}</span></span></span> <span class="main">(</span>Int.toString <span class="entity">s</span> ^ <span class="inner_quoted">" word"</span><span class="main">)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">mk_word</span> <span class="entity">i</span> <span class="entity">b</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">i</span><span class="main">=</span><span class="inner_numeral">0</span> <span class="keyword2"><span class="keyword">then</span></span>
    Const <span class="main">(</span><span class="inner_quoted">"Groups.zero_class.zero"</span><span class="main">,</span> <span class="entity">mk_word_typ</span> <span class="entity">b</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">else</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">i</span><span class="main">=</span><span class="inner_numeral">1</span> <span class="keyword2"><span class="keyword">then</span></span>
    Const <span class="main">(</span><span class="inner_quoted">"Groups.one_class.one"</span><span class="main">,</span> <span class="entity">mk_word_typ</span> <span class="entity">b</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">else</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">i</span> &lt; <span class="inner_numeral">0</span> <span class="keyword2"><span class="keyword">then</span></span>
    Syntax.read_term <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">context</span><span class="antiquote">}</span></span></span> <span class="main">(</span><span class="inner_quoted">"uminus :: "</span> ^ Int.toString <span class="entity">b</span> ^ <span class="inner_quoted">" word ⇒ "</span> ^ Int.toString <span class="entity">b</span> ^ <span class="inner_quoted">" word"</span><span class="main">)</span>
      $ <span class="main">(</span>Const <span class="main">(</span><span class="inner_quoted">"Num.numeral_class.numeral"</span><span class="main">,</span> <span class="entity">mk_word_typ_from_num</span> <span class="entity">b</span><span class="main">)</span> $ <span class="entity">HOLogic.mk_numeral</span> <span class="main">(</span><span class="inner_numeral">0</span> - <span class="entity">i</span><span class="main">)</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">else</span></span>
    Const <span class="main">(</span><span class="inner_quoted">"Num.numeral_class.numeral"</span><span class="main">,</span> <span class="entity">mk_word_typ_from_num</span> <span class="entity">b</span><span class="main">)</span> $ <span class="entity">HOLogic.mk_numeral</span> <span class="entity">i</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">mk_operand</span> <span class="main">(</span><span class="entity">Mem</span> <span class="main">(</span><span class="inner_numeral">8</span><span class="main">,</span><span class="entity">segment</span><span class="main">,</span><span class="entity">offset</span><span class="main">,</span><span class="entity">base</span><span class="main">,</span><span class="entity">index</span><span class="main">,</span><span class="entity">scale</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
  <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">"qword_ptr"</span><span class="antiquote">}</span></span> $ <span class="entity">HOLogic.mk_prod</span> <span class="main">(</span><span class="entity">mk_word</span> <span class="entity">offset</span> <span class="inner_numeral">64</span><span class="main">,</span>
                         <span class="entity">HOLogic.mk_prod</span> <span class="main">(</span><span class="entity">mk_string</span> <span class="entity">base</span><span class="main">,</span>
                          <span class="entity">HOLogic.mk_prod</span> <span class="main">(</span><span class="entity">mk_string</span> <span class="entity">index</span><span class="main">,</span> <span class="entity">mk_nat</span> <span class="entity">scale</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
 <span class="main">|</span> <span class="entity">mk_operand</span> <span class="main">(</span><span class="entity">Mem</span> <span class="main">(</span><span class="inner_numeral">4</span><span class="main">,</span><span class="entity">segment</span><span class="main">,</span><span class="entity">offset</span><span class="main">,</span><span class="entity">base</span><span class="main">,</span><span class="entity">index</span><span class="main">,</span><span class="entity">scale</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
  <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">"dword_ptr"</span><span class="antiquote">}</span></span> $ <span class="entity">HOLogic.mk_prod</span> <span class="main">(</span><span class="entity">mk_word</span> <span class="entity">offset</span> <span class="inner_numeral">64</span><span class="main">,</span>
                         <span class="entity">HOLogic.mk_prod</span> <span class="main">(</span><span class="entity">mk_string</span> <span class="entity">base</span><span class="main">,</span>
                          <span class="entity">HOLogic.mk_prod</span> <span class="main">(</span><span class="entity">mk_string</span> <span class="entity">index</span><span class="main">,</span> <span class="entity">mk_nat</span> <span class="entity">scale</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
 <span class="main">|</span> <span class="entity">mk_operand</span> <span class="main">(</span><span class="entity">Mem</span> <span class="main">(</span><span class="inner_numeral">2</span><span class="main">,</span><span class="entity">segment</span><span class="main">,</span><span class="entity">offset</span><span class="main">,</span><span class="entity">base</span><span class="main">,</span><span class="entity">index</span><span class="main">,</span><span class="entity">scale</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
  <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">"word_ptr"</span><span class="antiquote">}</span></span> $ <span class="entity">HOLogic.mk_prod</span> <span class="main">(</span><span class="entity">mk_word</span> <span class="entity">offset</span> <span class="inner_numeral">64</span><span class="main">,</span>
                         <span class="entity">HOLogic.mk_prod</span> <span class="main">(</span><span class="entity">mk_string</span> <span class="entity">base</span><span class="main">,</span>
                          <span class="entity">HOLogic.mk_prod</span> <span class="main">(</span><span class="entity">mk_string</span> <span class="entity">index</span><span class="main">,</span> <span class="entity">mk_nat</span> <span class="entity">scale</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
 <span class="main">|</span> <span class="entity">mk_operand</span> <span class="main">(</span><span class="entity">Mem</span> <span class="main">(</span><span class="inner_numeral">1</span><span class="main">,</span><span class="entity">segment</span><span class="main">,</span><span class="entity">offset</span><span class="main">,</span><span class="entity">base</span><span class="main">,</span><span class="entity">index</span><span class="main">,</span><span class="entity">scale</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
  <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">"byte_ptr"</span><span class="antiquote">}</span></span> $ <span class="entity">HOLogic.mk_prod</span> <span class="main">(</span><span class="entity">mk_word</span> <span class="entity">offset</span> <span class="inner_numeral">64</span><span class="main">,</span>
                         <span class="entity">HOLogic.mk_prod</span> <span class="main">(</span><span class="entity">mk_string</span> <span class="entity">base</span><span class="main">,</span>
                          <span class="entity">HOLogic.mk_prod</span> <span class="main">(</span><span class="entity">mk_string</span> <span class="entity">index</span><span class="main">,</span> <span class="entity">mk_nat</span> <span class="entity">scale</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
 <span class="main">|</span> <span class="entity">mk_operand</span> <span class="main">(</span><span class="entity">Mem</span> <span class="main">(</span><span class="entity">si</span><span class="main">,</span><span class="entity">segment</span><span class="main">,</span><span class="entity">offset</span><span class="main">,</span><span class="entity">base</span><span class="main">,</span><span class="entity">index</span><span class="main">,</span><span class="entity">scale</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
  <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">Mem</span><span class="antiquote">}</span></span> $ <span class="entity">mk_nat</span> <span class="entity">si</span> $ <span class="entity">mk_word</span> <span class="entity">offset</span> <span class="inner_numeral">64</span> $ <span class="entity">mk_string</span> <span class="entity">base</span> $ <span class="entity">mk_string</span> <span class="entity">index</span> $ <span class="entity">mk_nat</span> <span class="entity">scale</span>
 <span class="main">|</span> <span class="entity">mk_operand</span> <span class="main">(</span><span class="entity">Reg</span> <span class="entity">reg</span><span class="main">)</span> <span class="main">=</span>
  <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">Reg</span><span class="antiquote">}</span></span> $ <span class="entity">mk_string</span> <span class="entity">reg</span>
 <span class="main">|</span> <span class="entity">mk_operand</span> <span class="main">(</span><span class="entity">Imm</span> <span class="entity">imm</span><span class="main">)</span> <span class="main">=</span>
  <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">Imm</span><span class="antiquote">}</span></span> $ <span class="entity">mk_word</span> <span class="entity">imm</span> <span class="inner_numeral">256</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">mk_operand_option</span> NONE       <span class="main">=</span> <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">"None <span class="main">::</span> Operand option"</span><span class="antiquote">}</span></span>
  <span class="main">|</span> <span class="entity">mk_operand_option</span> <span class="main">(</span>SOME <span class="entity">op1</span><span class="main">)</span> <span class="main">=</span> <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">"Some <span class="main">::</span> Operand <span class="main">⇒</span> Operand option"</span><span class="antiquote">}</span></span> $ <span class="entity">mk_operand</span> <span class="entity">op1</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">mk_instr</span> <span class="main">(</span><span class="entity">Instr</span> <span class="main">(</span><span class="main">_</span><span class="main">,</span><span class="main">_</span><span class="main">,</span><span class="inner_quoted">"EXTERNAL_FUNCTION"</span><span class="main">,</span>SOME <span class="main">(</span><span class="entity">Reg</span> <span class="entity">f</span><span class="main">)</span><span class="main">,</span>NONE<span class="main">,</span>NONE<span class="main">)</span><span class="main">)</span> <span class="entity">lthy</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">def</span> <span class="main">=</span> Syntax.read_term <span class="main">(</span>Local_Theory.target_of <span class="entity">lthy</span><span class="main">)</span> <span class="main">(</span><span class="inner_quoted">"EXTERNAL_FUNCTION_"</span> ^ <span class="entity">f</span><span class="main">)</span> <span class="keyword2"><span class="keyword">in</span></span>
    <span class="keyword2"><span class="keyword">if</span></span> fastype_of <span class="entity">def</span> <span class="main">=</span> <span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">typ</span> <span class="quoted">state</span><span class="antiquote">}</span></span> --&gt; <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">typ</span> <span class="quoted">state</span><span class="antiquote">}</span></span><span class="main">)</span> <span class="keyword2"><span class="keyword">then</span></span>
      <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">ExternalFunc</span><span class="antiquote">}</span></span> $ <span class="entity">def</span>
    <span class="keyword2"><span class="keyword">else</span></span>
      <span class="keyword3"><span class="keyword">raise</span></span> Fail <span class="main">(</span><span class="inner_quoted">"Unknown external function: "</span> ^ <span class="entity">f</span> ^ <span class="inner_quoted">"; expecting a function named EXTERNAL_FUNCTION_"</span> ^ <span class="entity">f</span> ^ <span class="inner_quoted">" in locale unknowns of type state ⇒ state"</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">end</span></span>
<span class="main">|</span> <span class="entity">mk_instr</span> <span class="main">(</span><span class="entity">Instr</span> <span class="main">(</span><span class="entity">a</span><span class="main">,</span><span class="entity">si</span><span class="main">,</span><span class="entity">m</span><span class="main">,</span><span class="entity">op1</span><span class="main">,</span><span class="entity">op2</span><span class="main">,</span><span class="entity">op3</span><span class="main">)</span><span class="main">)</span> <span class="main">_</span> <span class="main">=</span>
  <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">Instr</span><span class="antiquote">}</span></span> $ <span class="entity">mk_string</span> <span class="entity">m</span> $ <span class="entity">mk_operand_option</span> <span class="entity">op1</span> $ <span class="entity">mk_operand_option</span> <span class="entity">op2</span> $ <span class="entity">mk_operand_option</span> <span class="entity">op3</span> $ <span class="entity">mk_word</span> <span class="main">(</span><span class="entity">a</span>+<span class="entity">si</span><span class="main">)</span> <span class="inner_numeral">64</span>

<span class="comment1">(*
  Make a definition in HOL with name "name" and as body "value".
  Value can be any HOL term, e.g.,:
      HOLogic.mk_number @{typ nat} 42
  Note that HOL terms can be produced using antiquotations, e.g.,
      @{term "42::nat"}
  does the same as the above code.
*)</span>
<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">mk_definition</span> <span class="entity">name</span> <span class="entity">value</span> <span class="entity">lthy</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span>
  <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">binding</span> <span class="main">=</span> Binding.name <span class="entity">name</span>
  <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="main">_</span><span class="main">,</span> <span class="entity">lthy</span><span class="main">)</span> <span class="main">=</span> Local_Theory.define <span class="main">(</span><span class="main">(</span><span class="entity">binding</span><span class="main">,</span> NoSyn<span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="main">(</span>Thm.def_binding <span class="entity">binding</span><span class="main">,</span> <span class="main">[</span><span class="main">]</span><span class="main">)</span><span class="main">,</span> <span class="entity">value</span><span class="main">)</span><span class="main">)</span> <span class="entity">lthy</span>
  <span class="keyword1"><span class="keyword">val</span></span> <span class="main">_</span> <span class="main">=</span> tracing <span class="main">(</span><span class="inner_quoted">"Added definition: "</span> ^ <span class="main">(</span>Local_Theory.full_name <span class="entity">lthy</span> <span class="entity">binding</span><span class="main">)</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">in</span></span>
    <span class="entity">lthy</span>
  <span class="keyword2"><span class="keyword">end</span></span>


<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">main</span> <span class="entity">localename</span> <span class="entity">assembly</span> <span class="entity">lthy</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span>
  <span class="comment1">(* Build a locale name *)</span>
  <span class="keyword1"><span class="keyword">val</span></span> <span class="main">_</span> <span class="main">=</span> not <span class="main">(</span>Long_Name.is_qualified <span class="entity">localename</span><span class="main">)</span> <span class="keyword1"><span class="keyword">orelse</span></span> <span class="keyword3"><span class="keyword">raise</span></span> Fail <span class="main">(</span><span class="inner_quoted">"Given localename looks like qualified Isabelle ID: "</span> ^ <span class="entity">localename</span><span class="main">)</span>
  <span class="keyword1"><span class="keyword">val</span></span> <span class="main">_</span> <span class="main">=</span> <span class="entity">localename</span> &lt;&gt; <span class="inner_quoted">""</span> <span class="keyword1"><span class="keyword">orelse</span></span> <span class="keyword3"><span class="keyword">raise</span></span> Fail <span class="main">(</span><span class="inner_quoted">"Given localename is illegal"</span><span class="main">)</span>

  <span class="comment1">(* The locale fixes a variable called "fetch" of type "64 word ⟹ I" *)</span>
  <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">fixes_fetch</span> <span class="main">=</span> <span class="entity">Element.Fixes</span> <span class="main">[</span><span class="main">(</span> Binding.name <span class="inner_quoted">"fetch"</span> <span class="main">,</span> SOME <span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">typ</span> <span class="quoted">"<span class="numeral">64</span> word <span class="main">=&gt;</span> I"</span><span class="antiquote">}</span></span><span class="main">)</span><span class="main">,</span> NoSyn<span class="main">)</span><span class="main">]</span>

  <span class="comment1">(* the locale contains a list of assumptions, one for each instruction. They are given the [simp] attribute. *)</span>
  <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">simp_attrib</span> <span class="main">=</span> <span class="entity">Attrib.internal</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="main">_</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="entity">Simplifier.simp_add</span><span class="main">)</span>
  <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">mk_assume</span> <span class="entity">thm_name</span> <span class="entity">term</span> <span class="main">=</span>  <span class="main">(</span><span class="main">(</span>Binding.name <span class="entity">thm_name</span><span class="main">,</span> <span class="main">[</span><span class="entity">simp_attrib</span><span class="main">]</span><span class="main">)</span><span class="main">,</span> <span class="main">[</span><span class="entity">term</span><span class="main">]</span><span class="main">)</span><span class="main">;</span>
  <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">mk_fetch</span> <span class="main">=</span> Free <span class="main">(</span><span class="inner_quoted">"fetch"</span><span class="main">,</span> <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">typ</span> <span class="quoted">"<span class="numeral">64</span> word <span class="main">=&gt;</span> I"</span><span class="antiquote">}</span></span><span class="main">)</span>
  <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">mk_fetch_equality_assume</span> <span class="entity">si</span> <span class="entity">str</span> <span class="main">=</span>
    <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">instr</span> <span class="main">=</span> <span class="entity">parse_instr</span> <span class="entity">si</span> <span class="entity">str</span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">Instr</span> <span class="main">(</span><span class="entity">a</span><span class="main">,</span><span class="main">_</span><span class="main">,</span><span class="main">_</span><span class="main">,</span><span class="main">_</span><span class="main">,</span><span class="main">_</span><span class="main">,</span><span class="main">_</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="entity">instr</span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">asm_name</span> <span class="main">=</span> <span class="inner_quoted">"fetch_"</span> ^ LargeInt.toString <span class="entity">a</span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">eq_term</span> <span class="main">=</span> <span class="entity">HOLogic.mk_eq</span> <span class="main">(</span><span class="entity">mk_fetch</span> $ <span class="entity">mk_word</span> <span class="entity">a</span> <span class="inner_numeral">64</span><span class="main">,</span> <span class="entity">mk_instr</span> <span class="entity">instr</span> <span class="entity">lthy</span><span class="main">)</span>
    <span class="keyword2"><span class="keyword">in</span></span>
      <span class="entity">mk_assume</span> <span class="entity">asm_name</span> <span class="main">(</span><span class="entity">HOLogic.Trueprop</span> $ <span class="entity">eq_term</span><span class="main">,</span> <span class="main">[</span><span class="main">]</span><span class="main">)</span>
    <span class="keyword2"><span class="keyword">end</span></span>

  <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">mk_fetch_equality_assumes</span> <span class="main">[</span><span class="main">]</span> <span class="main">=</span> <span class="main">[</span><span class="main">]</span>
    <span class="main">|</span> <span class="entity">mk_fetch_equality_assumes</span> <span class="main">[</span><span class="entity">str</span><span class="main">]</span> <span class="main">=</span> <span class="main">[</span><span class="entity">mk_fetch_equality_assume</span> <span class="inner_numeral">1</span> <span class="entity">str</span><span class="main">]</span>
    <span class="main">|</span> <span class="entity">mk_fetch_equality_assumes</span> <span class="main">(</span><span class="entity">str0</span>::<span class="entity">str1</span>::<span class="entity">strs</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="entity">mk_fetch_equality_assume</span> <span class="main">(</span><span class="entity">read_instr_addr</span> <span class="entity">str1</span> - <span class="entity">read_instr_addr</span> <span class="entity">str0</span><span class="main">)</span> <span class="entity">str0</span><span class="main">)</span> :: <span class="entity">mk_fetch_equality_assumes</span> <span class="main">(</span><span class="entity">str1</span>::<span class="entity">strs</span><span class="main">)</span>


  <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">assembly</span> <span class="main">=</span> String.tokens <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">c</span> <span class="main">=&gt;</span> <span class="entity">c</span> <span class="main">=</span> <span class="inner_quoted">#"\n"</span><span class="main">)</span> <span class="entity">assembly</span> |&gt;
    List.filter <span class="main">(</span>Substring.full #&gt; <span class="entity">remove_comment</span> #&gt; Substring.explode #&gt; List.all Char.isSpace #&gt; not<span class="main">)</span>
  <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">loc_bindings</span> <span class="main">=</span> Binding.name <span class="entity">localename</span>
  <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">loc_elems</span> <span class="main">=</span> <span class="main">[</span><span class="entity">fixes_fetch</span><span class="main">,</span><span class="entity">Element.Assumes</span> <span class="main">(</span><span class="entity">mk_fetch_equality_assumes</span> <span class="entity">assembly</span><span class="main">)</span><span class="main">]</span>
  <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">thy</span> <span class="main">=</span> Local_Theory.exit_global <span class="entity">lthy</span>
  <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">loc_expr</span> <span class="main">:</span> <span class="main">(</span>string<span class="main">,</span> term<span class="main">)</span> <span class="entity">Expression.expr</span> <span class="main">=</span> <span class="main">[</span><span class="main">(</span><span class="entity">Locale.intern</span> <span class="entity">thy</span> <span class="inner_quoted">"unknowns"</span><span class="main">,</span><span class="main">(</span><span class="main">(</span><span class="inner_quoted">""</span><span class="main">,</span>false<span class="main">)</span><span class="main">,</span><span class="main">(</span><span class="entity">Expression.Named</span> <span class="main">[</span><span class="main">]</span><span class="main">,</span> <span class="main">[</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">]</span>
  <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="main">_</span><span class="main">,</span><span class="entity">lthy</span><span class="main">)</span> <span class="main">=</span> <span class="entity">Expression.add_locale</span> <span class="entity">loc_bindings</span> <span class="entity">loc_bindings</span> <span class="main">[</span><span class="main">]</span> <span class="main">(</span><span class="entity">loc_expr</span><span class="main">,</span><span class="main">[</span><span class="main">]</span><span class="main">)</span> <span class="entity">loc_elems</span> <span class="entity">thy</span>
  <span class="keyword1"><span class="keyword">val</span></span> <span class="main">_</span> <span class="main">=</span> tracing <span class="main">(</span><span class="inner_quoted">"Added locale: "</span> ^ <span class="entity">localename</span> ^ <span class="inner_quoted">" with a fetch function for "</span> ^ Int.toString <span class="main">(</span>length <span class="entity">assembly</span><span class="main">)</span> ^ <span class="inner_quoted">" instructions. To get started, execute:\n\ncontext "</span> ^ <span class="entity">localename</span> ^ <span class="inner_quoted">"\nbegin\n   find_theorems fetch\nend\n"</span><span class="main">)</span>

  <span class="keyword2"><span class="keyword">in</span></span>
   <span class="entity">lthy</span>
  <span class="keyword2"><span class="keyword">end</span></span>




<span class="comment1">(*
  Add the command "x86_64_parser" to the Isabelle syntax.
  Its argument is parsed by Parse.text, which simply returns
  the text. The parsed text is given to the "main" function.
*)</span>

<span class="keyword1"><span class="keyword">val</span></span> <span class="main">_</span> <span class="main">=</span>
    <span class="entity">Outer_Syntax.local_theory</span>
      <span class="antiquoted"><span class="entity"><span class="operator"><span class="hidden">\&lt;^</span><span class="control">command_keyword</span><span class="hidden">&gt;</span></span>‹<span class="keyword1">x86_64_parser</span>›</span></span>
      <span class="inner_quoted">"Generate a locale from a list of assembly instructions."</span>
      <span class="main">(</span>Parse.text -- Parse.text &gt;&gt; <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="entity">localename</span><span class="main">,</span> <span class="entity">assembly</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="entity">main</span> <span class="entity">localename</span> <span class="entity">assembly</span><span class="main">)</span><span class="main">)</span>
</pre>
</div><div id="Example_WC">
<div class="head">
<h1>Theory Example_WC</h1>
</div>
<pre class="source"><span class="comment1">(*  Title:       X86 instruction semantics and basic block symbolic execution
    Authors:     Freek Verbeek, Abhijith Bharadwaj, Joshua Bockenek, Ian Roessle, Timmy Weerwag, Binoy Ravindran
    Year:        2020
    Maintainer:  Freek Verbeek (freek@vt.edu)
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">"Example: word count program from GNU"</span></span>

<span class="keyword1"><span class="command">theory</span></span> Example_WC
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="#SymbolicExecution">SymbolicExecution</a> <a href="#X86_Parse">X86_Parse</a>
<span class="keyword2"><span class="keyword">begin</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The wordcount (wc) program, specifically, the functions getword and counter.
  We compiled the source code found here:\\ 
  
      \url{https://www.gnu.org/software/cflow/manual/html_node/Source-of-wc-command.html}\\

  The source code is also found in the directory \texttt{./examples/wc}.

  The assembly below has been obtained by running in \texttt{./examples/wc}:
  \begin{verbatim}
    gcc wc.c -o wc
    objdump -M intel -d --no-show-raw-insn wc
  \end{verbatim}


  This example:
  \begin{itemize}
  \item contains a lot of memory accesses and demonstrates how a memory model is generated through assumptions;
  \item contains external function calls and demonstrates how to deal with that.
  \end{itemize}


  First, we define definitions named ``EXTERNAL\_FUNCTION\_*'' for each external function. The definitions
  are added to the simplifier.

  We model a C file (of C-type ``FILE'') as a pointer to a part of memory that contains the contents.
  We assume the contents are 0-terminated.

  Function \texttt{feof} takes as input (via \texttt{rdi}) a FILE*. It reads one byte from **rdi, i.e., the next byte of the file.
  It returns true iff the byte equals 0.\\

  Function \texttt{fopen} writes into memory both 1.) the contents of a file (the string "Hello"), and 2.) a pointer to the
  beginning of that file. It returns a pointer to that pointer.\\

  Function \texttt{getc} reads the next byte of the FILE (same is feof) and increments the pointer.\\
 
  Function \texttt{isword} simply returns true, and functions report and fclose simply do nothing.\\
›</span></span>


<span class="keyword1"><span class="command">context</span></span> unknowns
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">EXTERNAL_FUNCTION_feof</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"state <span class="main">⇒</span> state"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">EXTERNAL_FUNCTION_feof</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">≡</span> 
          <span class="keyword1">let</span> <span class="bound">ptr</span> <span class="main">=</span> ucast <span class="main">(</span>operand_read <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">(</span><span class="keyword1">QWORD</span> <span class="keyword1">PTR</span> <span class="main">[</span><span class="inner_quoted">''rdi''</span><span class="main">]<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
              <span class="bound">val</span> <span class="main">=</span> mem_read <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="bound">ptr</span> <span class="main">1</span> <span class="keyword1">in</span>
            <span class="main">(</span>semantics_RET  <span class="keyword1">o</span> 
             semantics_MOV <span class="main">(</span>Reg <span class="inner_quoted">''eax''</span><span class="main">)</span> <span class="main">(</span>Imm <span class="main">(</span>fromBool <span class="main">(</span><span class="bound">val</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
              <span class="free"><span class="bound"><span class="entity">σ</span></span></span>"</span></span>

<span class="keyword1"><span class="command">declare</span></span> EXTERNAL_FUNCTION_feof_def <span class="main">[</span><span class="operator">simp</span><span class="main">]</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">EXTERNAL_FUNCTION__IO_getc</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"state <span class="main">⇒</span> state"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">EXTERNAL_FUNCTION__IO_getc</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">≡</span>
          <span class="keyword1">let</span> <span class="bound">ptr</span> <span class="main">=</span> ucast <span class="main">(</span>operand_read <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">(</span><span class="keyword1">QWORD</span> <span class="keyword1">PTR</span> <span class="main">[</span><span class="inner_quoted">''rdi''</span><span class="main">]<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
              <span class="bound">val</span> <span class="main">=</span> mem_read <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="bound">ptr</span> <span class="main">1</span> <span class="keyword1">in</span>
            <span class="main">(</span>semantics_RET  <span class="keyword1">o</span> 
              semantics_MOV <span class="main">(</span>Reg <span class="inner_quoted">''rax''</span><span class="main">)</span> <span class="main">(</span>Imm <span class="main">(</span><span class="keyword1">if</span> <span class="bound">val</span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="main">-</span><span class="main">1</span> <span class="keyword1">else</span> <span class="bound">val</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">o</span>
              semantics_INC <span class="main">(</span><span class="keyword1">QWORD</span> <span class="keyword1">PTR</span> <span class="main">[</span><span class="inner_quoted">''rdi''</span><span class="main">]<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span><span class="main">)</span>
              <span class="free"><span class="bound"><span class="entity">σ</span></span></span>"</span></span>

<span class="keyword1"><span class="command">declare</span></span> EXTERNAL_FUNCTION__IO_getc_def <span class="main">[</span><span class="operator">simp</span><span class="main">]</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">EXTERNAL_FUNCTION_fopen</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">=</span> 
      semantics_RET <span class="main">(</span><span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="keyword1">with</span> <span class="main">[</span><span class="inner_quoted">''rax''</span> <span class="keyword1">:=<span class="hidden">⇩</span><sub>r</sub></span> <span class="numeral">100</span><span class="main">,</span>
                             <span class="main">⟦</span><span class="numeral">100</span><span class="main">,</span><span class="numeral">8</span><span class="main">⟧</span> <span class="keyword1">:=<span class="hidden">⇩</span><sub>m</sub></span> <span class="numeral">108</span><span class="main">,</span>
                             <span class="main">⟦</span><span class="numeral">108</span><span class="main">,</span><span class="numeral">6</span><span class="main">⟧</span> <span class="keyword1">:=<span class="hidden">⇩</span><sub>m</sub></span> <span class="numeral">0x006E6C6C6548</span><span class="main">]</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">declare</span></span> EXTERNAL_FUNCTION_fopen_def <span class="main">[</span><span class="operator">simp</span><span class="main">]</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">EXTERNAL_FUNCTION_isword</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"state <span class="main">⇒</span> state"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">EXTERNAL_FUNCTION_isword</span> <span class="main">=</span> operand_write <span class="main">(</span>Reg <span class="inner_quoted">''rax''</span><span class="main">)</span> <span class="main">1</span> <span class="keyword1">o</span> semantics_RET"</span></span>

<span class="keyword1"><span class="command">declare</span></span> EXTERNAL_FUNCTION_isword_def <span class="main">[</span><span class="operator">simp</span><span class="main">]</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">EXTERNAL_FUNCTION_fclose</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"state <span class="main">⇒</span> state"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">EXTERNAL_FUNCTION_fclose</span> <span class="main">=</span> semantics_RET"</span></span>

<span class="keyword1"><span class="command">declare</span></span> EXTERNAL_FUNCTION_fclose_def <span class="main">[</span><span class="operator">simp</span><span class="main">]</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">EXTERNAL_FUNCTION_report</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"state <span class="main">⇒</span> state"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">EXTERNAL_FUNCTION_report</span> <span class="main">=</span> semantics_RET"</span></span>

<span class="keyword1"><span class="command">declare</span></span> EXTERNAL_FUNCTION_report_def <span class="main">[</span><span class="operator">simp</span><span class="main">]</span>

<span class="keyword2"><span class="keyword">end</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Below, one can see that, e.g. 810 denotes an external call (see address 0xc1b).
  For each external call, we replace the actual .got.plt section with a special
  instruction <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">ExternalFunc</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> followed by a name. These special instructions
  are interpreted as executing the related definition above.
›</span></span>

<span class="keyword1"><span class="command">context</span></span> unknowns
<span class="keyword2"><span class="keyword">begin</span></span>
  <span class="keyword1"><span class="command">x86_64_parser</span></span> wc_objdump <span class="quoted">‹
    7d0: EXTERNAL_FUNCTION fclose
    810: EXTERNAL_FUNCTION feof
    820: EXTERNAL_FUNCTION _IO_getc
    830: EXTERNAL_FUNCTION fopen
    bd5: EXTERNAL_FUNCTION isword
    b93: EXTERNAL_FUNCTION report

    c01: push   rbp
    c02: mov    rbp,rsp
    c05: sub    rsp,0x20
    c09: mov    QWORD PTR [rbp-0x18],rdi
    c0d: mov    DWORD PTR [rbp-0x4],0x0
    c14: mov    rax,QWORD PTR [rbp-0x18]
    c18: mov    rdi,rax
    c1b: call   810 &lt;feof@plt&gt;
    c20: test   eax,eax
    c22: je     c7d &lt;getword+0x7c&gt;
    c24: mov    eax,0x0
    c29: jmp    cf1 &lt;getword+0xf0&gt;
    c2e: mov    eax,DWORD PTR [rbp-0x8]
    c31: movzx  eax,al
    c34: mov    edi,eax
    c36: call   bd5 &lt;isword&gt;
    c3b: test   eax,eax
    c3d: je     c53 &lt;getword+0x52&gt;
    c3f: mov    rax,QWORD PTR [rip+0x201402]        # 202048 &lt;wcount&gt;
    c46: add    rax,0x1
    c4a: mov    QWORD PTR [rip+0x2013f7],rax        # 202048 &lt;wcount&gt;
    c51: jmp    c92 &lt;getword+0x91&gt;
    c53: mov    rax,QWORD PTR [rip+0x2013f6]        # 202050 &lt;ccount&gt;
    c5a: add    rax,0x1
    c5e: mov    QWORD PTR [rip+0x2013eb],rax        # 202050 &lt;ccount&gt;
    c65: cmp    DWORD PTR [rbp-0x8],0xa
    c69: jne    c7d &lt;getword+0x7c&gt;
    c6b: mov    rax,QWORD PTR [rip+0x2013e6]        # 202058 &lt;lcount&gt;
    c72: add    rax,0x1
    c76: mov    QWORD PTR [rip+0x2013db],rax        # 202058 &lt;lcount&gt;
    c7d: mov    rax,QWORD PTR [rbp-0x18]
    c81: mov    rdi,rax
    c84: call   820 &lt;_IO_getc@plt&gt;
    c89: mov    DWORD PTR [rbp-0x8],eax
    c8c: cmp    DWORD PTR [rbp-0x8],0xffffffff
    c90: jne    c2e &lt;getword+0x2d&gt;
    c92: jmp    cde &lt;getword+0xdd&gt;
    c94: mov    rax,QWORD PTR [rip+0x2013b5]        # 202050 &lt;ccount&gt;
    c9b: add    rax,0x1
    c9f: mov    QWORD PTR [rip+0x2013aa],rax        # 202050 &lt;ccount&gt;
    ca6: cmp    DWORD PTR [rbp-0x8],0xa
    caa: jne    cbe &lt;getword+0xbd&gt;
    cac: mov    rax,QWORD PTR [rip+0x2013a5]        # 202058 &lt;lcount&gt;
    cb3: add    rax,0x1
    cb7: mov    QWORD PTR [rip+0x20139a],rax        # 202058 &lt;lcount&gt;
    cbe: mov    eax,DWORD PTR [rbp-0x8]
    cc1: movzx  eax,al
    cc4: mov    edi,eax
    cc6: call   bd5 &lt;isword&gt;
    ccb: test   eax,eax
    ccd: je     ce6 &lt;getword+0xe5&gt;
    ccf: mov    rax,QWORD PTR [rbp-0x18]
    cd3: mov    rdi,rax
    cd6: call   820 &lt;_IO_getc@plt&gt;
    cdb: mov    DWORD PTR [rbp-0x8],eax
    cde: cmp    DWORD PTR [rbp-0x8],0xffffffff
    ce2: jne    c94 &lt;getword+0x93&gt;
    ce4: jmp    ce7 &lt;getword+0xe6&gt;
    ce6: nop
    ce7: cmp    DWORD PTR [rbp-0x8],0xffffffff
    ceb: setne  al
    cee: movzx  eax,al
    cf1: leave  
    cf2: ret


    cf3: push   rbp
    cf4: mov    rbp,rsp
    cf7: sub    rsp,0x20
    cfb: mov    QWORD PTR [rbp-0x18],rdi
    cff: mov    rax,QWORD PTR [rbp-0x18]
    d03: lea    rsi,[rip+0x1ff]        # f09 &lt;_IO_stdin_used+0x19&gt;
    d0a: mov    rdi,rax
    d0d: call   830 &lt;fopen@plt&gt;
    d12: mov    QWORD PTR [rbp-0x8],rax
    d16: cmp    QWORD PTR [rbp-0x8],0x0
    d1b: jne    d35 &lt;counter+0x42&gt;
    d1d: mov    rax,QWORD PTR [rbp-0x18]
    d21: mov    rsi,rax
    d24: lea    rdi,[rip+0x1e0]        # f0b &lt;_IO_stdin_used+0x1b&gt;
    d2b: mov    eax,0x0
    d30: call   ac6 &lt;perrf&gt;
    d35: mov    QWORD PTR [rip+0x201318],0x0        # 202058 &lt;lcount&gt;
    d40: mov    rax,QWORD PTR [rip+0x201311]        # 202058 &lt;lcount&gt;
    d47: mov    QWORD PTR [rip+0x2012fa],rax        # 202048 &lt;wcount&gt;
    d4e: mov    rax,QWORD PTR [rip+0x2012f3]        # 202048 &lt;wcount&gt;
    d55: mov    QWORD PTR [rip+0x2012f4],rax        # 202050 &lt;ccount&gt;
    d5c: nop
    d5d: mov    rax,QWORD PTR [rbp-0x8]
    d61: mov    rdi,rax
    d64: call   c01 &lt;getword&gt;
    d69: test   eax,eax
    d6b: jne    d5d &lt;counter+0x6a&gt;
    d6d: mov    rax,QWORD PTR [rbp-0x8]
    d71: mov    rdi,rax
    d74: call   7d0 &lt;fclose@plt&gt;
    d79: mov    rcx,QWORD PTR [rip+0x2012d8]        # 202058 &lt;lcount&gt;
    d80: mov    rdx,QWORD PTR [rip+0x2012c1]        # 202048 &lt;wcount&gt;
    d87: mov    rsi,QWORD PTR [rip+0x2012c2]        # 202050 &lt;ccount&gt;
    d8e: mov    rax,QWORD PTR [rbp-0x18]
    d92: mov    rdi,rax
    d95: call   b93 &lt;report&gt;
    d9a: mov    rdx,QWORD PTR [rip+0x20128f]        # 202030 &lt;total_ccount&gt;
    da1: mov    rax,QWORD PTR [rip+0x2012a8]        # 202050 &lt;ccount&gt;
    da8: add    rax,rdx
    dab: mov    QWORD PTR [rip+0x20127e],rax        # 202030 &lt;total_ccount&gt;
    db2: mov    rdx,QWORD PTR [rip+0x20127f]        # 202038 &lt;total_wcount&gt;
    db9: mov    rax,QWORD PTR [rip+0x201288]        # 202048 &lt;wcount&gt;
    dc0: add    rax,rdx
    dc3: mov    QWORD PTR [rip+0x20126e],rax        # 202038 &lt;total_wcount&gt;
    dca: mov    rdx,QWORD PTR [rip+0x20126f]        # 202040 &lt;total_lcount&gt;
    dd1: mov    rax,QWORD PTR [rip+0x201280]        # 202058 &lt;lcount&gt;
    dd8: add    rax,rdx
    ddb: mov    QWORD PTR [rip+0x20125e],rax        # 202040 &lt;total_lcount&gt;
    de2: nop
    de3: leave  
    de4: ret
  ›</span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">context</span></span> wc_objdump
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword1"><span class="command">find_theorems</span></span> <span class="quoted"><span class="free">fetch</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Note: this theorems takes roughly 15 minutes to prove.›</span></span>
<span class="keyword1"><span class="command">schematic_goal</span></span> counter<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">σ<span class="hidden">⇩</span><sub>I</sub></span> <span class="main">=</span> <span class="free">σ</span> <span class="keyword1">with</span> <span class="main">[</span><span class="keyword1">setRip</span> <span class="numeral">0xcf3</span><span class="main">]</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"assumptions <span class="var">?A</span> <span class="main">⟹</span> run <span class="numeral">0xde4</span> <span class="free">fetch</span> <span class="free">σ<span class="hidden">⇩</span><sub>I</sub></span> <span class="var">?σ'</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> assms<span class="main">)</span>
  <span class="comment1">(* you can simply run 

  apply (se_step)+

  However, we have broken it down so that some intermediate states are visible.
  Specifically, one can see the result of running getc, which fetches the next character.
  *)</span>

  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">repeat_n</span> 8 <span class="operator">se_step</span><span class="main">)</span>
  <span class="comment1">― ‹rip = 0x830 (2096), calling fopen›</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">se_step</span>

  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">repeat_n</span> 12 <span class="operator">se_step</span><span class="main">)</span>
  <span class="comment1">― ‹rip = 0xc01 (3073), calling getword›</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">se_step</span>


  <span class="comment1">(* GETWORD BEGIN *)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">repeat_n</span> 13 <span class="operator">se_step</span><span class="main">)</span>
  <span class="comment1">― ‹rip = 0xc84 (2080), calling getc›</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">se_step</span>

  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">repeat_n</span> 32 <span class="operator">se_step</span><span class="main">)</span>
  <span class="comment1">― ‹rip = 0xc84 (2080), calling getc›</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">se_step</span>

  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">repeat_n</span> 18 <span class="operator">se_step</span><span class="main">)</span>
  <span class="comment1">― ‹rip = 0xc84 (2080), calling getc›</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">se_step</span>

  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">repeat_n</span> 18 <span class="operator">se_step</span><span class="main">)</span>
  <span class="comment1">― ‹rip = 0xc84 (2080), calling getc›</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">se_step</span>

  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">repeat_n</span> 18 <span class="operator">se_step</span><span class="main">)</span>
  <span class="comment1">― ‹rip = 0xc84 (2080), calling getc›</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">se_step</span>

  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">repeat_n</span> 18 <span class="operator">se_step</span><span class="main">)</span>
  <span class="comment1">― ‹rip = 0xc84 (2080), calling getc›</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">se_step</span>

  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">repeat_n</span> 9 <span class="operator">se_step</span><span class="main">)</span>
  <span class="comment1">(* GETWORD END*)</span>

  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">repeat_n</span> 5 <span class="operator">se_step</span><span class="main">)</span>
  <span class="comment1">― ‹rip = 0x7d0 (2000), calling fclose›</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">se_step</span>

  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">repeat_n</span> 6 <span class="operator">se_step</span><span class="main">)</span>
  <span class="comment1">― ‹rip = 0xb93 (2963), calling report›</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">se_step</span>

  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">repeat_n</span> 15 <span class="operator">se_step</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> eq_def<span class="main"><span class="keyword3">,</span></span><span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">thm</span></span> counter


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
The file opened by "fopen" contains the zero-terminated string "Hello": 0x006E6C6C6548.
After each call of getc, register RAX contains the read characters' ASCII code.

After termination, we can see the contents of the following global variables, set by function getword:
\begin{verbatim}
  Word count:      wcount = 1      (0x202048 = 2105416) 
  Character count: ccount = 5      (0x202050 = 2105424) 
  Line count:      lcount = lcount (0x202058 = 2105432) 
\end{verbatim}

  The totals accumulate to:
\begin{verbatim}
  Word count:      total_wcount = total_wcount + 5 (0x202038 = 2105400) 
  Character count: total_ccount = total_ccount + 5 (0x202030 = 2105392) 
  Line count:      total_lcount = total_lcount     (0x202040 = 2105408) 
\end{verbatim}
›</span></span>



<span class="keyword2"><span class="keyword">end</span></span>
<span class="keyword2"><span class="keyword">end</span></span></pre>
</div>