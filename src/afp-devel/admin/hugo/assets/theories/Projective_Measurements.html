<div id="Linear_Algebra_Complements">
<div class="head">
<h1>Theory Linear_Algebra_Complements</h1>
</div>
<pre class="source"><span class="comment1">(*
Author: 
  Mnacho Echenim, Université Grenoble Alpes
*)</span>

<span class="keyword1"><span class="command">theory</span></span> Linear_Algebra_Complements <span class="keyword2"><span class="keyword">imports</span></span> 
  <span class="quoted">"<a href="../../isabelle_marries_dirac/theories/#Tensor">Isabelle_Marries_Dirac.Tensor</a>"</span> 
  <span class="quoted">"<a href="../../isabelle_marries_dirac/theories/#More_Tensor">Isabelle_Marries_Dirac.More_Tensor</a>"</span>
  <span class="quoted">"<a href="../../qhlprover/theories/#Gates">QHLProver.Gates</a>"</span> 
  <span class="quoted">"<a href="https://www.cl.cam.ac.uk/research/hvg/Isabelle/dist/library/HOL/HOL-Types_To_Sets/Group_On_With.html">HOL-Types_To_Sets.Group_On_With</a>"</span> 
  <span class="quoted">"<a href="https://www.cl.cam.ac.uk/research/hvg/Isabelle/dist/library/HOL/HOL-Probability/Probability.html">HOL-Probability.Probability</a>"</span> 


<span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword1"><span class="command">hide_const</span></span><span class="main">(</span><span class="keyword2"><span class="keyword">open</span></span><span class="main">)</span> S
<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Preliminaries›</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Misc›</span></span>

<span class="keyword1" id="Linear_Algebra_Complements-mult_real_cpx"><span class="command">lemma</span></span> mult_real_cpx<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">a</span><span class="main">::</span><span class="quoted">complex</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">b</span><span class="main">::</span><span class="quoted">complex</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span><span class="main">∈</span> Reals"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span><span class="main">*</span> <span class="main">(</span>Re <span class="free">b</span><span class="main">)</span> <span class="main">=</span> Re <span class="main">(</span><span class="free">a</span> <span class="main">*</span> <span class="free">b</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Reals_cases complex.exhaust complex.sel<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> complex_of_real_mult_Complex of_real_mult<span class="main">)</span>

<span class="keyword1" id="Linear_Algebra_Complements-fct_bound"><span class="command">lemma</span></span> fct_bound<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span><span class="main">::</span><span class="quoted"><span class="quoted">"complex<span class="main">⇒</span> real"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span><span class="main">(</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">+</span> <span class="free">f</span> <span class="main">1</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="free">f</span> <span class="main">1</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="free">f</span> <span class="main">(</span><span class="main">-</span><span class="main">1</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">-</span><span class="main">1</span> <span class="main">≤</span> <span class="free">f</span> <span class="main">1</span>  <span class="main">-</span> <span class="free">f</span><span class="main">(</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">∧</span> <span class="free">f</span> <span class="main">1</span>  <span class="main">-</span> <span class="free">f</span><span class="main">(</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">≤</span> <span class="main">1</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">1</span>  <span class="main">-</span> <span class="free">f</span><span class="main">(</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span> <span class="main">-</span> <span class="free">f</span><span class="main">(</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">-</span> <span class="free">f</span><span class="main">(</span><span class="main">-</span><span class="main">1</span><span class="main">)</span>"</span></span>  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span><span class="main">≥</span> <span class="main">-</span><span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">-</span><span class="main">1</span> <span class="main">≤</span> <span class="free">f</span> <span class="main">1</span>  <span class="main">-</span> <span class="free">f</span><span class="main">(</span><span class="main">-</span><span class="main">1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span><span class="main">(</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">-</span> <span class="free">f</span> <span class="main">1</span>  <span class="main">=</span> <span class="main">1</span> <span class="main">-</span> <span class="free">f</span> <span class="main">1</span>  <span class="main">-</span> <span class="free">f</span> <span class="main">1</span> "</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">≥</span> <span class="main">-</span><span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">-</span><span class="main">1</span> <span class="main">≤</span> <span class="free">f</span><span class="main">(</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">-</span> <span class="free">f</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">1</span> <span class="main">-</span> <span class="free">f</span> <span class="main">(</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">≤</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Linear_Algebra_Complements-fct_bound'"><span class="command">lemma</span></span> fct_bound'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span><span class="main">::</span><span class="quoted"><span class="quoted">"complex<span class="main">⇒</span> real"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span><span class="main">(</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">+</span> <span class="free">f</span> <span class="main">1</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="free">f</span> <span class="main">1</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="free">f</span> <span class="main">(</span><span class="main">-</span><span class="main">1</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">¦</span><span class="free">f</span> <span class="main">1</span>  <span class="main">-</span> <span class="free">f</span><span class="main">(</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">¦</span> <span class="main">≤</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms fct_bound <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Linear_Algebra_Complements-pos_sum_1_le"><span class="command">lemma</span></span> pos_sum_1_le<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">I</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">i</span> <span class="main">∈</span> <span class="free">I</span><span class="main">.</span> <span class="main">(</span><span class="main">0</span><span class="main">::</span>real<span class="main">)</span> <span class="main">≤</span> <span class="free">f</span> <span class="bound">i</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">∈</span> <span class="free">I</span><span class="main">.</span> <span class="free">f</span> <span class="bound">i</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span><span class="main">∈</span> <span class="free">I</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="free">j</span> <span class="main">≤</span> <span class="main">1</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="free">f</span> <span class="free">j</span> <span class="main">≤</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">&lt;</span> <span class="free">f</span> <span class="free">j</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">&lt;</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">∈</span> <span class="free">I</span><span class="main">.</span> <span class="free">f</span> <span class="bound">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="free">f</span> <span class="free">j</span> <span class="main">≤</span> <span class="main">1</span>›</span></span> sum_nonneg_leq_bound<span class="main">)</span> 
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Linear_Algebra_Complements-last_subset"><span class="command">lemma</span></span> last_subset<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">⊆</span> <span class="main">{</span><span class="free">a</span><span class="main">,</span><span class="free">b</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span><span class="main">≠</span> <span class="free">b</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">≠</span> <span class="main">{</span><span class="free">a</span><span class="main">,</span> <span class="free">b</span><span class="main">}</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span><span class="main">≠</span> <span class="main">{}</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">≠</span> <span class="main">{</span><span class="free">a</span><span class="main">}</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">=</span> <span class="main">{</span><span class="free">b</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="Linear_Algebra_Complements-disjoint_Un"><span class="command">lemma</span></span> disjoint_Un<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"disjoint_family_on <span class="free">A</span> <span class="main">(</span>insert <span class="free">x</span> <span class="free">F</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main">∉</span> <span class="free">F</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">A</span> <span class="free">x</span><span class="main">)</span> <span class="main">∩</span> <span class="main">(</span><span class="main">⋃</span> <span class="bound">a</span><span class="main">∈</span> <span class="free">F</span><span class="main">.</span> <span class="free">A</span> <span class="bound">a</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">A</span> <span class="free">x</span><span class="main">)</span> <span class="main">∩</span> <span class="main">(</span><span class="main">⋃</span> <span class="bound">a</span><span class="main">∈</span> <span class="free">F</span><span class="main">.</span> <span class="free">A</span> <span class="bound">a</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">i</span><span class="main">∈</span><span class="free">F</span><span class="main">.</span> <span class="main">(</span><span class="free">A</span> <span class="free">x</span><span class="main">)</span> <span class="main">∩</span> <span class="free">A</span> <span class="bound">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Int_UN_distrib <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">i</span><span class="main">∈</span><span class="free">F</span><span class="main">.</span> <span class="main">{}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms disjoint_family_onD <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> SUP_bot_conv<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Linear_Algebra_Complements-sum_but_one"><span class="command">lemma</span></span> sum_but_one<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">j</span></span> <span class="main">&lt;</span> <span class="main">(</span><span class="free">n</span><span class="main">::</span>nat<span class="main">)</span><span class="main">.</span> <span class="bound">j</span> <span class="main">≠</span><span class="free">i</span> <span class="main">⟶</span> <span class="free">f</span> <span class="bound">j</span> <span class="main">=</span> <span class="main">(</span><span class="main">0</span><span class="main">::</span><span class="tfree">'a</span><span class="main">::</span>ring<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span> <span class="bound">j</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span> <span class="main">..&lt;</span> <span class="free">n</span><span class="main">}</span><span class="main">.</span> <span class="free">f</span> <span class="bound">j</span> <span class="main">*</span> <span class="free">g</span> <span class="bound">j</span><span class="main">)</span> <span class="main">=</span> <span class="free">f</span> <span class="free">i</span> <span class="main">*</span> <span class="free">g</span> <span class="free">i</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sum <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">*</span> <span class="free">g</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="main">{</span><span class="main">0</span> <span class="main">..&lt;</span> <span class="free">n</span><span class="main">}</span> <span class="main">-</span> <span class="main">{</span><span class="free">i</span><span class="main">}</span><span class="main">)</span> <span class="main">∪</span> <span class="main">{</span><span class="free">i</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> sum <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">*</span> <span class="free">g</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="main">{</span><span class="main">0</span> <span class="main">..&lt;</span> <span class="free">n</span><span class="main">}</span> <span class="main">-</span> <span class="main">{</span><span class="free">i</span><span class="main">}</span><span class="main">)</span> <span class="main">+</span> 
    sum <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">*</span> <span class="free">g</span> <span class="bound">x</span><span class="main">)</span> <span class="main">{</span><span class="free">i</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sum.union_disjoint<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> sum <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">*</span> <span class="free">g</span> <span class="bound">x</span><span class="main">)</span> <span class="main">{</span><span class="free">i</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="free">f</span> <span class="free">i</span> <span class="main">*</span> <span class="free">g</span> <span class="free">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sum <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">*</span> <span class="free">g</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="main">{</span><span class="main">0</span> <span class="main">..&lt;</span> <span class="free">n</span><span class="main">}</span> <span class="main">-</span> <span class="main">{</span><span class="free">i</span><span class="main">}</span><span class="main">)</span> <span class="main">∪</span> <span class="main">{</span><span class="free">i</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> <span class="free">f</span> <span class="free">i</span> <span class="main">*</span> <span class="free">g</span> <span class="free">i</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">0</span> <span class="main">..&lt;</span> <span class="free">n</span><span class="main">}</span> <span class="main">=</span> <span class="main">(</span><span class="main">{</span><span class="main">0</span> <span class="main">..&lt;</span> <span class="free">n</span><span class="main">}</span> <span class="main">-</span> <span class="main">{</span><span class="free">i</span><span class="main">}</span><span class="main">)</span> <span class="main">∪</span> <span class="main">{</span><span class="free">i</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Linear_Algebra_Complements-sum_2_elems"><span class="command">lemma</span></span> sum_2_elems<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="main">=</span> <span class="main">{</span><span class="free">a</span><span class="main">,</span><span class="free">b</span><span class="main">}</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span><span class="main">≠</span> <span class="free">b</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">a</span><span class="main">∈</span><span class="free">I</span><span class="main">.</span> <span class="free">f</span> <span class="bound">a</span><span class="main">)</span> <span class="main">=</span> <span class="free">f</span> <span class="free">a</span> <span class="main">+</span> <span class="free">f</span> <span class="free">b</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">a</span><span class="main">∈</span><span class="free">I</span><span class="main">.</span> <span class="free">f</span> <span class="bound">a</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">a</span><span class="main">∈</span><span class="main">(</span>insert <span class="free">a</span> <span class="main">{</span><span class="free">b</span><span class="main">}</span><span class="main">)</span><span class="main">.</span> <span class="free">f</span> <span class="bound">a</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="free">f</span> <span class="free">a</span> <span class="main">+</span> <span class="main">(</span><span class="main">∑</span><span class="bound">a</span><span class="main">∈</span><span class="main">{</span><span class="free">b</span><span class="main">}</span><span class="main">.</span> <span class="free">f</span> <span class="bound">a</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> sum.insert<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="free">b</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span><span class="main">∉</span> <span class="main">{</span><span class="free">b</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="free">f</span> <span class="free">a</span> <span class="main">+</span> <span class="free">f</span> <span class="free">b</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Linear_Algebra_Complements-sum_4_elems"><span class="command">lemma</span></span> sum_4_elems<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">&lt;</span><span class="main">(</span><span class="numeral">4</span><span class="main">::</span>nat<span class="main">)</span><span class="main">.</span> <span class="free">f</span> <span class="bound">i</span><span class="main">)</span> <span class="main">=</span> <span class="free">f</span> <span class="main">0</span> <span class="main">+</span> <span class="free">f</span> <span class="main">1</span> <span class="main">+</span> <span class="free">f</span> <span class="numeral">2</span> <span class="main">+</span> <span class="free">f</span> <span class="numeral">3</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">&lt;</span><span class="main">(</span><span class="numeral">4</span><span class="main">::</span>nat<span class="main">)</span><span class="main">.</span> <span class="free">f</span> <span class="bound">i</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">&lt;</span><span class="main">(</span><span class="numeral">3</span><span class="main">::</span>nat<span class="main">)</span><span class="main">.</span> <span class="free">f</span> <span class="bound">i</span><span class="main">)</span>  <span class="main">+</span> <span class="free">f</span> <span class="numeral">3</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Suc_numeral semiring_norm<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> semiring_norm<span class="main"><span class="main">(</span></span>8<span class="main"><span class="main">)</span></span> sum.lessThan_Suc<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">&lt;</span><span class="main">(</span><span class="numeral">3</span><span class="main">::</span>nat<span class="main">)</span><span class="main">.</span> <span class="free">f</span> <span class="bound">i</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">&lt;</span><span class="main">(</span><span class="numeral">2</span><span class="main">::</span>nat<span class="main">)</span><span class="main">.</span> <span class="free">f</span> <span class="bound">i</span><span class="main">)</span> <span class="main">+</span> <span class="free">f</span> <span class="numeral">2</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Suc_1 add_2_eq_Suc' nat_1_add_1 numeral_code<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> numerals<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> 
        one_plus_numeral_commute sum.lessThan_Suc<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">&lt;</span><span class="main">(</span><span class="numeral">2</span><span class="main">::</span>nat<span class="main">)</span><span class="main">.</span> <span class="free">f</span> <span class="bound">i</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">&lt;</span><span class="main">(</span><span class="main">1</span><span class="main">::</span>nat<span class="main">)</span><span class="main">.</span> <span class="free">f</span> <span class="bound">i</span><span class="main">)</span> <span class="main">+</span> <span class="free">f</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Suc_1 sum.lessThan_Suc<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Linear_Algebra_Complements-disj_family_sum"><span class="command">lemma</span></span> disj_family_sum<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">I</span> <span class="main">⟹</span> disjoint_family_on <span class="free">A</span> <span class="free">I</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∈</span> <span class="free">I</span> <span class="main">⟹</span> finite <span class="main">(</span><span class="free">A</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>  <span class="main">⟹</span> 
  <span class="main">(</span><span class="main">∑</span> <span class="bound">i</span> <span class="main">∈</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">n</span> <span class="main">∈</span> <span class="free">I</span><span class="main">.</span> <span class="free">A</span> <span class="bound">n</span><span class="main">)</span><span class="main">.</span> <span class="free">f</span> <span class="bound">i</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span> <span class="bound">n</span><span class="main">∈</span> <span class="free">I</span><span class="main">.</span> <span class="main">(</span><span class="main">∑</span> <span class="bound">i</span> <span class="main">∈</span> <span class="free">A</span> <span class="bound">n</span><span class="main">.</span> <span class="free">f</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>finite_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> empty
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>insert <span class="skolem">x</span> <span class="skolem">F</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"disjoint_family_on <span class="free">A</span> <span class="skolem">F</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> disjoint_family_on_mono subset_insertI<span class="main">)</span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋃</span><span class="bound">n</span> <span class="main">∈</span> <span class="main">(</span>insert <span class="skolem">x</span> <span class="skolem">F</span><span class="main">)</span><span class="main">.</span> <span class="free">A</span> <span class="bound">n</span><span class="main">)</span> <span class="main">=</span> <span class="free">A</span> <span class="skolem">x</span> <span class="main">∪</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">n</span> <span class="main">∈</span> <span class="skolem">F</span><span class="main">.</span> <span class="free">A</span> <span class="bound">n</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> insert <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span> <span class="bound">i</span> <span class="main">∈</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">n</span> <span class="main">∈</span> <span class="main">(</span>insert <span class="skolem">x</span> <span class="skolem">F</span><span class="main">)</span><span class="main">.</span> <span class="free">A</span> <span class="bound">n</span><span class="main">)</span><span class="main">.</span> <span class="free">f</span> <span class="bound">i</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span> <span class="bound">i</span> <span class="main">∈</span> <span class="main">(</span><span class="free">A</span> <span class="skolem">x</span> <span class="main">∪</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">n</span> <span class="main">∈</span> <span class="skolem">F</span><span class="main">.</span> <span class="free">A</span> <span class="bound">n</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> <span class="free">f</span> <span class="bound">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span> <span class="bound">i</span> <span class="main">∈</span>  <span class="free">A</span> <span class="skolem">x</span><span class="main">.</span> <span class="free">f</span> <span class="bound">i</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="main">∑</span> <span class="bound">i</span> <span class="main">∈</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">n</span> <span class="main">∈</span> <span class="skolem">F</span><span class="main">.</span> <span class="free">A</span> <span class="bound">n</span><span class="main">)</span><span class="main">.</span> <span class="free">f</span> <span class="bound">i</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sum.union_disjoint<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> insert disjoint_Un<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span> <span class="bound">i</span> <span class="main">∈</span>  <span class="free">A</span> <span class="skolem">x</span><span class="main">.</span> <span class="free">f</span> <span class="bound">i</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="main">∑</span><span class="bound">n</span><span class="main">∈</span><span class="skolem">F</span><span class="main">.</span> sum <span class="free">f</span> <span class="main">(</span><span class="free">A</span> <span class="bound">n</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span>  <span class="quoted"><span class="quoted">‹disjoint_family_on <span class="free">A</span> <span class="skolem">F</span>›</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> insert<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">n</span><span class="main">∈</span><span class="main">(</span>insert <span class="skolem">x</span> <span class="skolem">F</span><span class="main">)</span><span class="main">.</span> sum <span class="free">f</span> <span class="main">(</span><span class="free">A</span> <span class="bound">n</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> insert <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Linear_Algebra_Complements-integrable_real_mult_right"><span class="command">lemma</span></span> integrable_real_mult_right<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">c</span><span class="main">::</span><span class="quoted">real</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"integrable <span class="free">M</span> <span class="free">f</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"integrable <span class="free">M</span> <span class="main">(</span><span class="main">λ</span><span class="bound">w</span><span class="main">.</span> <span class="free">c</span> <span class="main">*</span> <span class="free">f</span> <span class="bound">w</span><span class="main">)</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> integrable_mult_right<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">c</span></span><span class="main">]</span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Unifying notions between Isabelle Marries Dirac and QHLProver›</span></span>

<span class="keyword1" id="Linear_Algebra_Complements-mult_conj_cmod_square"><span class="command">lemma</span></span> mult_conj_cmod_square<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">z</span><span class="main">::</span><span class="quoted">complex</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">z</span> <span class="main">*</span> conjugate <span class="free">z</span> <span class="main">=</span> <span class="main">(</span>cmod <span class="free">z</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">z</span> <span class="main">*</span> conjugate <span class="free">z</span> <span class="main">=</span> <span class="main">(</span>Re <span class="free">z</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">+</span> <span class="main">(</span>Im <span class="free">z</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span>"</span></span> <span class="keyword1"><span class="command">using</span></span>  complex_mult_cnj <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span>cmod <span class="free">z</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> cmod_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Linear_Algebra_Complements-vec_norm_sq_cpx_vec_length_sq"><span class="command">lemma</span></span> vec_norm_sq_cpx_vec_length_sq<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>vec_norm <span class="free">v</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">=</span> <span class="main">(</span>cpx_vec_length <span class="free">v</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>vec_norm <span class="free">v</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">=</span> inner_prod <span class="free">v</span> <span class="free">v</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> vec_norm_def <span class="keyword1"><span class="command">using</span></span> power2_csqrt <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">&lt;</span>dim_vec <span class="free">v</span><span class="main">.</span> <span class="main">(</span>cmod <span class="main">(</span>Matrix.vec_index <span class="free">v</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> Matrix.scalar_prod_def
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> dim_vec <span class="free">v</span> <span class="main">⟹</span> Matrix.vec_index <span class="free">v</span>  <span class="bound">i</span> <span class="main">*</span> conjugate <span class="main">(</span>Matrix.vec_index <span class="free">v</span> <span class="bound">i</span><span class="main">)</span> <span class="main">=</span> 
      <span class="main">(</span>cmod <span class="main">(</span>Matrix.vec_index <span class="free">v</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span>"</span></span> <span class="keyword1"><span class="command">using</span></span> mult_conj_cmod_square <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">i</span> <span class="main">=</span> <span class="main">0</span><span class="main">..&lt;</span>dim_vec <span class="main">(</span>conjugate <span class="free">v</span><span class="main">)</span><span class="main">.</span> Matrix.vec_index <span class="free">v</span> <span class="bound">i</span> <span class="main">*</span> 
      Matrix.vec_index <span class="main">(</span>conjugate <span class="free">v</span><span class="main">)</span> <span class="bound">i</span><span class="main">)</span> <span class="main">=</span>  <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">&lt;</span>dim_vec <span class="free">v</span><span class="main">.</span> <span class="main">(</span>cmod <span class="main">(</span>Matrix.vec_index <span class="free">v</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lessThan_atLeast0<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>vec_norm <span class="free">v</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">=</span> <span class="main">(</span>cpx_vec_length <span class="free">v</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> cpx_vec_length_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sum_nonneg<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Linear_Algebra_Complements-vec_norm_eq_cpx_vec_length"><span class="command">lemma</span></span> vec_norm_eq_cpx_vec_length<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"vec_norm <span class="free">v</span> <span class="main">=</span> cpx_vec_length <span class="free">v</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> vec_norm_sq_cpx_vec_length_sq
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> cpx_vec_length_inner_prod inner_prod_csqrt power2_csqrt vec_norm_def<span class="main">)</span> 

<span class="keyword1" id="Linear_Algebra_Complements-cpx_vec_length_square"><span class="command">lemma</span></span> cpx_vec_length_square<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∥</span><span class="free">v</span><span class="main">∥</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span> <span class="main">=</span> <span class="main">0</span><span class="main">..&lt;</span>dim_vec <span class="free">v</span><span class="main">.</span> <span class="main">(</span>cmod <span class="main">(</span>Matrix.vec_index <span class="free">v</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> cpx_vec_length_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lessThan_atLeast0 sum_nonneg<span class="main">)</span>

<span class="keyword1" id="Linear_Algebra_Complements-state_qbit_norm_sq"><span class="command">lemma</span></span> state_qbit_norm_sq<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span><span class="main">∈</span> state_qbit <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>cpx_vec_length <span class="free">v</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">=</span> <span class="main">1</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"cpx_vec_length <span class="free">v</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> state_qbit_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Linear_Algebra_Complements-dagger_adjoint"><span class="command">lemma</span></span> dagger_adjoint<span class="main">:</span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"dagger <span class="free">M</span> <span class="main">=</span> Complex_Matrix.adjoint <span class="free">M</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> dagger_def Complex_Matrix.adjoint_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cong_mat<span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Types to sets lemmata transfers›</span></span>

<span class="keyword1"><span class="command">context</span></span> ab_group_add_on_with <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">context</span></span> <span class="keyword2"><span class="keyword">includes</span></span> lifting_syntax <span class="keyword2"><span class="keyword">assumes</span></span> ltd<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="main">(</span><span class="bound">Rep</span><span class="main">::</span><span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">)</span> <span class="main">(</span><span class="bound">Abs</span><span class="main">::</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'s</span><span class="main">)</span><span class="main">.</span> 
  type_definition <span class="bound">Rep</span> <span class="bound">Abs</span> <span class="free">S</span>"</span></span> <span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword1"><span class="command">interpretation</span></span> local_typedef_ab_group_add_on_with <span class="quoted"><span class="free">pls</span></span> <span class="quoted"><span class="free">z</span></span> <span class="quoted"><span class="free">mns</span></span> <span class="quoted"><span class="free">um</span></span> <span class="quoted"><span class="free">S</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">TYPE</span><span class="main">(</span><span class="tfree">'s</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span> <span class="operator">fact</span>

<span class="keyword1"><span class="command">lemmas</span></span> lt_sum_union_disjoint <span class="main">=</span> sum.union_disjoint
  <span class="main">[</span><span class="operator">var_simplified</span> <span class="dynamic"><span class="dynamic">explicit_ab_group_add</span></span><span class="main">,</span>
    <span class="operator">unoverload_type</span> <span class="tfree">'c</span><span class="main">,</span>
    <span class="operator">OF</span> type.comm_monoid_add_axioms<span class="main">,</span>
    <span class="operator">untransferred</span><span class="main">]</span>

<span class="keyword1"><span class="command">lemmas</span></span> lt_disj_family_sum <span class="main">=</span> disj_family_sum
  <span class="main">[</span><span class="operator">var_simplified</span> <span class="dynamic"><span class="dynamic">explicit_ab_group_add</span></span><span class="main">,</span>
    <span class="operator">unoverload_type</span> <span class="tfree">'d</span><span class="main">,</span>
<span class="operator">OF</span> type.comm_monoid_add_axioms<span class="main">,</span>
    <span class="operator">untransferred</span><span class="main">]</span>

<span class="keyword1"><span class="command">lemmas</span></span> lt_sum_reindex_cong <span class="main">=</span> sum.reindex_cong
  <span class="main">[</span><span class="operator">var_simplified</span> <span class="dynamic"><span class="dynamic">explicit_ab_group_add</span></span><span class="main">,</span>
    <span class="operator">unoverload_type</span> <span class="tfree">'d</span><span class="main">,</span>
<span class="operator">OF</span> type.comm_monoid_add_axioms<span class="main">,</span>
    <span class="operator">untransferred</span><span class="main">]</span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> sum_with_union_disjoint <span class="main">=</span>
  lt_sum_union_disjoint
    <span class="main">[</span><span class="operator">cancel_type_definition</span><span class="main">,</span>
    <span class="operator">OF</span> carrier_ne<span class="main">,</span>
    <span class="operator">simplified</span> pred_fun_def<span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>

<span class="keyword1"><span class="command">lemmas</span></span> disj_family_sum_with <span class="main">=</span>
  lt_disj_family_sum
    <span class="main">[</span><span class="operator">cancel_type_definition</span><span class="main">,</span>
    <span class="operator">OF</span> carrier_ne<span class="main">,</span>
    <span class="operator">simplified</span> pred_fun_def<span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>

<span class="keyword1"><span class="command">lemmas</span></span> sum_with_reindex_cong <span class="main">=</span> 
  lt_sum_reindex_cong
    <span class="main">[</span><span class="operator">cancel_type_definition</span><span class="main">,</span>
    <span class="operator">OF</span> carrier_ne<span class="main">,</span>
    <span class="operator">simplified</span> pred_fun_def<span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> comm_monoid_add_on_with<span class="main">)</span> sum_with_cong'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">I</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span><span class="main">∈</span> <span class="free">I</span> <span class="main">⟹</span> <span class="free">A</span> <span class="bound">i</span> <span class="main">=</span> <span class="free">B</span> <span class="bound">i</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span><span class="main">∈</span> <span class="free">I</span> <span class="main">⟹</span> <span class="free">A</span> <span class="bound">i</span> <span class="main">∈</span> <span class="free">S</span><span class="main">)</span> <span class="main">⟹</span> 
    <span class="main">(</span><span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span><span class="main">∈</span> <span class="free">I</span> <span class="main">⟹</span> <span class="free">B</span> <span class="bound">i</span> <span class="main">∈</span> <span class="free">S</span><span class="main">)</span> <span class="main">⟹</span> sum_with <span class="free">pls</span> <span class="free">z</span> <span class="free">A</span> <span class="free">I</span> <span class="main">=</span> sum_with <span class="free">pls</span> <span class="free">z</span> <span class="free">B</span> <span class="free">I</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> finite_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> empty
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>insert <span class="skolem">x</span> <span class="skolem">F</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sum_with <span class="free">pls</span> <span class="free">z</span> <span class="free">A</span> <span class="main">(</span>insert <span class="skolem">x</span> <span class="skolem">F</span><span class="main">)</span> <span class="main">=</span> <span class="free">pls</span> <span class="main">(</span><span class="free">A</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">(</span>sum_with <span class="free">pls</span> <span class="free">z</span> <span class="free">A</span> <span class="skolem">F</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> insert 
      sum_with_insert<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">A</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>  image_subset_iff<span class="main">)</span> 
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="free">pls</span> <span class="main">(</span><span class="free">B</span> <span class="skolem">x</span><span class="main">)</span>  <span class="main">(</span>sum_with <span class="free">pls</span> <span class="free">z</span> <span class="free">B</span> <span class="skolem">F</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> insert <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> sum_with <span class="free">pls</span> <span class="free">z</span> <span class="free">B</span> <span class="main">(</span>insert <span class="skolem">x</span> <span class="skolem">F</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> insert sum_with_insert<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">B</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>  image_subset_iff<span class="main">)</span> 
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Linear algebra complements›</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Additional properties of matrices›</span></span>

<span class="keyword1" id="Linear_Algebra_Complements-smult_one"><span class="command">lemma</span></span> smult_one<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">1</span><span class="main">::</span><span class="tfree">'a</span><span class="main">::</span>monoid_mult<span class="main">)</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">A</span> <span class="main">=</span> <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>eq_matI<span class="main">)</span>

<span class="keyword1" id="Linear_Algebra_Complements-times_diag_index"><span class="command">lemma</span></span> times_diag_index<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>comm_ring Matrix.mat"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">∈</span> carrier_mat <span class="free">n</span> <span class="free">n</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">B</span><span class="main">∈</span> carrier_mat <span class="free">n</span> <span class="free">n</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"diagonal_mat <span class="free">B</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Matrix.vec_index <span class="main">(</span>Matrix.row <span class="main">(</span><span class="free">A</span><span class="main">*</span><span class="free">B</span><span class="main">)</span> <span class="free">j</span><span class="main">)</span> <span class="free">i</span> <span class="main">=</span> diag_mat <span class="free">B</span> <span class="main">!</span> <span class="free">i</span> <span class="main">*</span><span class="free">A</span> <span class="main">$$</span> <span class="main">(</span><span class="free">j</span><span class="main">,</span> <span class="free">i</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Matrix.vec_index <span class="main">(</span>Matrix.row <span class="main">(</span><span class="free">A</span><span class="main">*</span><span class="free">B</span><span class="main">)</span> <span class="free">j</span><span class="main">)</span> <span class="free">i</span> <span class="main">=</span> <span class="main">(</span><span class="free">A</span><span class="main">*</span><span class="free">B</span><span class="main">)</span> <span class="main">$$</span> <span class="main">(</span><span class="free">j</span><span class="main">,</span><span class="free">i</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> Matrix.row_def<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">A</span><span class="main">*</span><span class="free">B</span>"</span></span> <span class="main">]</span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> Matrix.scalar_prod <span class="main">(</span>Matrix.row <span class="free">A</span> <span class="free">j</span><span class="main">)</span> <span class="main">(</span>Matrix.col <span class="free">B</span> <span class="free">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms 
      times_mat_def<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">A</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> Matrix.scalar_prod <span class="main">(</span>Matrix.col <span class="free">B</span> <span class="free">i</span><span class="main">)</span> <span class="main">(</span>Matrix.row <span class="free">A</span> <span class="free">j</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> comm_scalar_prod<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"Matrix.row <span class="free">A</span> <span class="free">j</span>"</span></span> <span class="quoted"><span class="free">n</span></span><span class="main">]</span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span>Matrix.vec_index <span class="main">(</span>Matrix.col <span class="free">B</span> <span class="free">i</span><span class="main">)</span> <span class="free">i</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span>Matrix.vec_index  <span class="main">(</span>Matrix.row <span class="free">A</span> <span class="free">j</span><span class="main">)</span> <span class="free">i</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">unfolding</span></span> Matrix.scalar_prod_def 
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> sum_but_one<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> dim_vec <span class="main">(</span>Matrix.row <span class="free">A</span> <span class="free">j</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">ia</span></span><span class="main">&lt;</span>dim_vec <span class="main">(</span>Matrix.row <span class="free">A</span> <span class="free">j</span><span class="main">)</span><span class="main">.</span> <span class="bound">ia</span> <span class="main">≠</span> <span class="free">i</span> <span class="main">⟶</span> Matrix.vec_index <span class="main">(</span>Matrix.col <span class="free">B</span> <span class="free">i</span><span class="main">)</span> <span class="bound">ia</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> carrier_matD<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> carrier_matD<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> diagonal_mat_def index_col index_row<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="free">B</span> <span class="main">$$</span><span class="main">(</span><span class="free">i</span><span class="main">,</span><span class="free">i</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span>Matrix.vec_index  <span class="main">(</span>Matrix.row <span class="free">A</span> <span class="free">j</span><span class="main">)</span> <span class="free">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> diag_mat <span class="free">B</span> <span class="main">!</span> <span class="free">i</span> <span class="main">*</span> <span class="main">(</span>Matrix.vec_index  <span class="main">(</span>Matrix.row <span class="free">A</span> <span class="free">j</span><span class="main">)</span> <span class="free">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> diag_mat_def 
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> diag_mat <span class="free">B</span> <span class="main">!</span> <span class="free">i</span> <span class="main">*</span> <span class="free">A</span> <span class="main">$$</span> <span class="main">(</span><span class="free">j</span><span class="main">,</span> <span class="free">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Linear_Algebra_Complements-inner_prod_adjoint_comp"><span class="command">lemma</span></span> inner_prod_adjoint_comp<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">U</span><span class="main">::</span><span class="tfree">'a</span><span class="main">::</span>conjugatable_field Matrix.mat<span class="main">)</span> <span class="main">∈</span> carrier_mat <span class="free">n</span> <span class="free">n</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">V</span><span class="main">::</span><span class="tfree">'a</span><span class="main">::</span>conjugatable_field Matrix.mat<span class="main">)</span> <span class="main">∈</span> carrier_mat <span class="free">n</span> <span class="free">n</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Complex_Matrix.inner_prod  <span class="main">(</span>Matrix.col <span class="free">V</span> <span class="free">i</span><span class="main">)</span> <span class="main">(</span>Matrix.col <span class="free">U</span> <span class="free">j</span><span class="main">)</span> <span class="main">=</span> 
  <span class="main">(</span><span class="main">(</span>Complex_Matrix.adjoint <span class="free">V</span><span class="main">)</span> <span class="main">*</span> <span class="free">U</span><span class="main">)</span> <span class="main">$$</span> <span class="main">(</span><span class="free">i</span><span class="main">,</span> <span class="free">j</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Complex_Matrix.inner_prod <span class="main">(</span>Matrix.col <span class="free">V</span> <span class="free">i</span><span class="main">)</span> <span class="main">(</span>Matrix.col <span class="free">U</span> <span class="free">j</span><span class="main">)</span> <span class="main">=</span> 
    Matrix.scalar_prod <span class="main">(</span>Matrix.col <span class="free">U</span> <span class="free">j</span><span class="main">)</span> <span class="main">(</span>Matrix.row <span class="main">(</span>Complex_Matrix.adjoint <span class="free">V</span><span class="main">)</span> <span class="free">i</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> adjoint_row<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">V</span></span><span class="main">]</span> assms  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>  
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> Matrix.scalar_prod <span class="main">(</span>Matrix.row <span class="main">(</span>Complex_Matrix.adjoint <span class="free">V</span><span class="main">)</span> <span class="free">i</span><span class="main">)</span> <span class="main">(</span>Matrix.col <span class="free">U</span> <span class="free">j</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> adjoint_row assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> carrier_matD<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> carrier_matD<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> Matrix.col_dim 
        conjugate_vec_sprod_comm<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span>Complex_Matrix.adjoint <span class="free">V</span><span class="main">)</span> <span class="main">*</span> <span class="free">U</span><span class="main">)</span> <span class="main">$$</span> <span class="main">(</span><span class="free">i</span><span class="main">,</span> <span class="free">j</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>times_mat_def<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Linear_Algebra_Complements-mat_unit_vec_col"><span class="command">lemma</span></span> mat_unit_vec_col<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">A</span><span class="main">::</span><span class="tfree">'a</span><span class="main">::</span>conjugatable_field Matrix.mat<span class="main">)</span> <span class="main">∈</span> carrier_mat <span class="free">n</span> <span class="free">n</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>v</sub></span> <span class="main">(</span>unit_vec <span class="free">n</span> <span class="free">i</span><span class="main">)</span> <span class="main">=</span> Matrix.col <span class="free">A</span> <span class="free">i</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"dim_vec <span class="main">(</span><span class="free">A</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>v</sub></span> unit_vec <span class="free">n</span> <span class="free">i</span><span class="main">)</span> <span class="main">=</span> dim_vec <span class="main">(</span>Matrix.col <span class="free">A</span> <span class="free">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">j</span><span class="main">.</span> <span class="bound">j</span> <span class="main">&lt;</span> dim_vec <span class="main">(</span>Matrix.col <span class="free">A</span> <span class="free">i</span><span class="main">)</span> <span class="main">⟹</span> Matrix.vec_index <span class="main">(</span><span class="free">A</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>v</sub></span> unit_vec <span class="free">n</span> <span class="free">i</span><span class="main">)</span>  <span class="bound">j</span> <span class="main">=</span> 
    Matrix.vec_index <span class="main">(</span>Matrix.col <span class="free">A</span> <span class="free">i</span><span class="main">)</span>  <span class="bound">j</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">j</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> dim_vec <span class="main">(</span>Matrix.col <span class="free">A</span> <span class="free">i</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"Matrix.vec_index <span class="main">(</span><span class="free">A</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>v</sub></span> unit_vec <span class="free">n</span> <span class="free">i</span><span class="main">)</span>  <span class="skolem">j</span> <span class="main">=</span> 
      Matrix.scalar_prod <span class="main">(</span>Matrix.row <span class="free">A</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">(</span>unit_vec <span class="free">n</span> <span class="free">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> mult_mat_vec_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> Matrix.scalar_prod  <span class="main">(</span>unit_vec <span class="free">n</span> <span class="free">i</span><span class="main">)</span> <span class="main">(</span>Matrix.row <span class="free">A</span> <span class="skolem">j</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> comm_scalar_prod
        assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span>Matrix.vec_index <span class="main">(</span>unit_vec <span class="free">n</span> <span class="free">i</span><span class="main">)</span> <span class="free">i</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span>Matrix.vec_index <span class="main">(</span>Matrix.row <span class="free">A</span> <span class="skolem">j</span><span class="main">)</span> <span class="free">i</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> Matrix.scalar_prod_def 
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> sum_but_one<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> dim_vec <span class="main">(</span>Matrix.row <span class="free">A</span> <span class="skolem">j</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">ia</span></span><span class="main">&lt;</span>dim_vec <span class="main">(</span>Matrix.row <span class="free">A</span> <span class="skolem">j</span><span class="main">)</span><span class="main">.</span> <span class="bound">ia</span> <span class="main">≠</span> <span class="free">i</span> <span class="main">⟶</span> Matrix.vec_index <span class="main">(</span>unit_vec <span class="free">n</span> <span class="free">i</span><span class="main">)</span> <span class="bound">ia</span> <span class="main">=</span> <span class="main">0</span>"</span></span> 
        <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> unit_vec_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span>Matrix.vec_index <span class="main">(</span>Matrix.row <span class="free">A</span> <span class="skolem">j</span><span class="main">)</span> <span class="free">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="free">A</span> <span class="main">$$</span> <span class="main">(</span><span class="skolem">j</span><span class="main">,</span> <span class="free">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="quoted"><span class="quoted">‹<span class="skolem">j</span> <span class="main">&lt;</span> dim_vec <span class="main">(</span>Matrix.col <span class="free">A</span> <span class="free">i</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> Matrix.vec_index <span class="main">(</span>Matrix.col <span class="free">A</span> <span class="free">i</span><span class="main">)</span>  <span class="skolem">j</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="quoted"><span class="quoted">‹<span class="skolem">j</span> <span class="main">&lt;</span> dim_vec <span class="main">(</span>Matrix.col <span class="free">A</span> <span class="free">i</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Matrix.vec_index <span class="main">(</span><span class="free">A</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>v</sub></span> unit_vec <span class="free">n</span> <span class="free">i</span><span class="main">)</span>  <span class="skolem">j</span> <span class="main">=</span> 
      Matrix.vec_index <span class="main">(</span>Matrix.col <span class="free">A</span> <span class="free">i</span><span class="main">)</span>  <span class="skolem">j</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Linear_Algebra_Complements-mat_prod_unit_vec_cong"><span class="command">lemma</span></span> mat_prod_unit_vec_cong<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">A</span><span class="main">::</span><span class="tfree">'a</span><span class="main">::</span>conjugatable_field Matrix.mat<span class="main">)</span> <span class="main">∈</span> carrier_mat <span class="free">n</span> <span class="free">n</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">B</span><span class="main">∈</span> carrier_mat <span class="free">n</span> <span class="free">n</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="free">n</span> <span class="main">⟹</span> <span class="free">A</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>v</sub></span> <span class="main">(</span>unit_vec <span class="free">n</span> <span class="bound">i</span><span class="main">)</span> <span class="main">=</span> <span class="free">B</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>v</sub></span> <span class="main">(</span>unit_vec <span class="free">n</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">=</span> <span class="free">B</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"dim_row <span class="free">A</span> <span class="main">=</span> dim_row <span class="free">B</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"dim_col <span class="free">A</span> <span class="main">=</span> dim_col <span class="free">B</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> dim_row <span class="free">B</span> <span class="main">⟹</span> <span class="bound">j</span> <span class="main">&lt;</span> dim_col <span class="free">B</span> <span class="main">⟹</span> <span class="free">A</span> <span class="main">$$</span> <span class="main">(</span><span class="bound">i</span><span class="main">,</span> <span class="bound">j</span><span class="main">)</span> <span class="main">=</span> <span class="free">B</span> <span class="main">$$</span> <span class="main">(</span><span class="bound">i</span><span class="main">,</span> <span class="bound">j</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="skolem">j</span>
    <span class="keyword3"><span class="command">assume</span></span> ij<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> dim_row <span class="free">B</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> dim_col <span class="free">B</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">$$</span> <span class="main">(</span><span class="skolem">i</span><span class="main">,</span><span class="skolem">j</span><span class="main">)</span> <span class="main">=</span> Matrix.vec_index <span class="main">(</span>Matrix.col <span class="free">A</span> <span class="skolem">j</span><span class="main">)</span> <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> Matrix.vec_index <span class="main">(</span><span class="free">A</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>v</sub></span> <span class="main">(</span>unit_vec <span class="free">n</span> <span class="skolem">j</span><span class="main">)</span><span class="main">)</span> <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> mat_unit_vec_col<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">A</span></span><span class="main">]</span> ij assms 
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> Matrix.vec_index <span class="main">(</span><span class="free">B</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>v</sub></span> <span class="main">(</span>unit_vec <span class="free">n</span> <span class="skolem">j</span><span class="main">)</span><span class="main">)</span> <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms ij <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> Matrix.vec_index <span class="main">(</span>Matrix.col <span class="free">B</span> <span class="skolem">j</span><span class="main">)</span> <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> mat_unit_vec_col ij assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="free">B</span> <span class="main">$$</span> <span class="main">(</span><span class="skolem">i</span><span class="main">,</span><span class="skolem">j</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms ij <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">$$</span> <span class="main">(</span><span class="skolem">i</span><span class="main">,</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">=</span> <span class="free">B</span> <span class="main">$$</span> <span class="main">(</span><span class="skolem">i</span><span class="main">,</span> <span class="skolem">j</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Linear_Algebra_Complements-smult_smult_times"><span class="command">lemma</span></span> smult_smult_times<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">a</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>semigroup_mult"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span><span class="keyword1">⋅<span class="hidden">⇩</span><sub>m</sub></span> <span class="main">(</span><span class="free">k</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">A</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">a</span> <span class="main">*</span> <span class="free">k</span><span class="main">)</span><span class="keyword1">⋅<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">A</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">show</span></span> r<span class="main">:</span><span class="quoted"><span class="quoted">"dim_row <span class="main">(</span><span class="free">a</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>m</sub></span> <span class="main">(</span><span class="free">k</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> dim_row <span class="main">(</span><span class="free">a</span> <span class="main">*</span> <span class="free">k</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">A</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">show</span></span> c<span class="main">:</span><span class="quoted"><span class="quoted">"dim_col <span class="main">(</span><span class="free">a</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>m</sub></span> <span class="main">(</span><span class="free">k</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> dim_col <span class="main">(</span><span class="free">a</span> <span class="main">*</span> <span class="free">k</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">A</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> dim_row <span class="main">(</span><span class="free">a</span> <span class="main">*</span> <span class="free">k</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">A</span><span class="main">)</span> <span class="main">⟹</span>
           <span class="bound">j</span> <span class="main">&lt;</span> dim_col <span class="main">(</span><span class="free">a</span> <span class="main">*</span> <span class="free">k</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">A</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">a</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>m</sub></span> <span class="main">(</span><span class="free">k</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">$$</span> <span class="main">(</span><span class="bound">i</span><span class="main">,</span> <span class="bound">j</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">a</span> <span class="main">*</span> <span class="free">k</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">A</span><span class="main">)</span> <span class="main">$$</span> <span class="main">(</span><span class="bound">i</span><span class="main">,</span> <span class="bound">j</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="skolem">j</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> dim_row <span class="main">(</span><span class="free">a</span> <span class="main">*</span> <span class="free">k</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">A</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> dim_col <span class="main">(</span><span class="free">a</span> <span class="main">*</span> <span class="free">k</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">A</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">note</span></span> ij <span class="main">=</span> this
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">a</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>m</sub></span> <span class="main">(</span><span class="free">k</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">$$</span> <span class="main">(</span><span class="skolem">i</span><span class="main">,</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">=</span> <span class="free">a</span> <span class="main">*</span> <span class="main">(</span><span class="free">k</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">A</span><span class="main">)</span> <span class="main">$$</span> <span class="main">(</span><span class="skolem">i</span><span class="main">,</span> <span class="skolem">j</span><span class="main">)</span>"</span></span>  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="free">a</span> <span class="main">*</span> <span class="main">(</span><span class="free">k</span> <span class="main">*</span> <span class="free">A</span> <span class="main">$$</span> <span class="main">(</span><span class="skolem">i</span><span class="main">,</span><span class="skolem">j</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ij <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="free">a</span> <span class="main">*</span> <span class="free">k</span><span class="main">)</span> <span class="main">*</span> <span class="free">A</span> <span class="main">$$</span> <span class="main">(</span><span class="skolem">i</span><span class="main">,</span><span class="skolem">j</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> semigroup_mult_class.mult.assoc<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="free">a</span> <span class="main">*</span> <span class="free">k</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">A</span><span class="main">)</span> <span class="main">$$</span> <span class="main">(</span><span class="skolem">i</span><span class="main">,</span> <span class="skolem">j</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> r c ij <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">a</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>m</sub></span> <span class="main">(</span><span class="free">k</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">$$</span> <span class="main">(</span><span class="skolem">i</span><span class="main">,</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">a</span> <span class="main">*</span> <span class="free">k</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">A</span><span class="main">)</span> <span class="main">$$</span> <span class="main">(</span><span class="skolem">i</span><span class="main">,</span> <span class="skolem">j</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Linear_Algebra_Complements-mat_minus_minus"><span class="command">lemma</span></span> mat_minus_minus<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> ab_group_add Matrix.mat"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">∈</span> carrier_mat <span class="free">n</span> <span class="free">m</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">B</span><span class="main">∈</span> carrier_mat <span class="free">n</span> <span class="free">m</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">C</span><span class="main">∈</span> carrier_mat <span class="free">n</span> <span class="free">m</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">-</span> <span class="main">(</span><span class="free">B</span> <span class="main">-</span> <span class="free">C</span><span class="main">)</span> <span class="main">=</span> <span class="free">A</span> <span class="main">-</span> <span class="free">B</span> <span class="main">+</span> <span class="free">C</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"dim_row <span class="main">(</span><span class="free">A</span> <span class="main">-</span> <span class="main">(</span><span class="free">B</span> <span class="main">-</span> <span class="free">C</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> dim_row <span class="main">(</span><span class="free">A</span> <span class="main">-</span> <span class="free">B</span> <span class="main">+</span> <span class="free">C</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"dim_col <span class="main">(</span><span class="free">A</span> <span class="main">-</span> <span class="main">(</span><span class="free">B</span> <span class="main">-</span> <span class="free">C</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> dim_col <span class="main">(</span><span class="free">A</span> <span class="main">-</span> <span class="free">B</span> <span class="main">+</span> <span class="free">C</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> dim_row <span class="main">(</span><span class="free">A</span> <span class="main">-</span> <span class="free">B</span> <span class="main">+</span> <span class="free">C</span><span class="main">)</span> <span class="main">⟹</span> <span class="bound">j</span> <span class="main">&lt;</span> dim_col <span class="main">(</span><span class="free">A</span> <span class="main">-</span> <span class="free">B</span> <span class="main">+</span> <span class="free">C</span><span class="main">)</span> <span class="main">⟹</span> 
    <span class="main">(</span><span class="free">A</span> <span class="main">-</span> <span class="main">(</span><span class="free">B</span> <span class="main">-</span> <span class="free">C</span><span class="main">)</span><span class="main">)</span> <span class="main">$$</span> <span class="main">(</span><span class="bound">i</span><span class="main">,</span> <span class="bound">j</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">A</span> <span class="main">-</span> <span class="free">B</span> <span class="main">+</span> <span class="free">C</span><span class="main">)</span> <span class="main">$$</span> <span class="main">(</span><span class="bound">i</span><span class="main">,</span> <span class="bound">j</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="skolem">j</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> dim_row <span class="main">(</span><span class="free">A</span> <span class="main">-</span> <span class="free">B</span> <span class="main">+</span> <span class="free">C</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> dim_col <span class="main">(</span><span class="free">A</span> <span class="main">-</span> <span class="free">B</span> <span class="main">+</span> <span class="free">C</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">note</span></span> ij <span class="main">=</span> this
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">A</span> <span class="main">-</span> <span class="main">(</span><span class="free">B</span> <span class="main">-</span> <span class="free">C</span><span class="main">)</span><span class="main">)</span> <span class="main">$$</span> <span class="main">(</span><span class="skolem">i</span><span class="main">,</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">A</span> <span class="main">$$</span> <span class="main">(</span><span class="skolem">i</span><span class="main">,</span><span class="skolem">j</span><span class="main">)</span> <span class="main">-</span> <span class="free">B</span> <span class="main">$$</span> <span class="main">(</span><span class="skolem">i</span><span class="main">,</span><span class="skolem">j</span><span class="main">)</span> <span class="main">+</span> <span class="free">C</span> <span class="main">$$</span> <span class="main">(</span><span class="skolem">i</span><span class="main">,</span><span class="skolem">j</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ij assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="free">A</span> <span class="main">-</span> <span class="free">B</span> <span class="main">+</span> <span class="free">C</span><span class="main">)</span> <span class="main">$$</span> <span class="main">(</span><span class="skolem">i</span><span class="main">,</span> <span class="skolem">j</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms ij <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">A</span> <span class="main">-</span> <span class="main">(</span><span class="free">B</span> <span class="main">-</span> <span class="free">C</span><span class="main">)</span><span class="main">)</span> <span class="main">$$</span> <span class="main">(</span><span class="skolem">i</span><span class="main">,</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">A</span> <span class="main">-</span> <span class="free">B</span> <span class="main">+</span> <span class="free">C</span><span class="main">)</span> <span class="main">$$</span> <span class="main">(</span><span class="skolem">i</span><span class="main">,</span> <span class="skolem">j</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Complements on complex matrices›</span></span>

<span class="keyword1" id="Linear_Algebra_Complements-hermitian_square"><span class="command">lemma</span></span> hermitian_square<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"hermitian <span class="free">M</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">∈</span> carrier_mat <span class="main">(</span>dim_row <span class="free">M</span><span class="main">)</span> <span class="main">(</span>dim_row <span class="free">M</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"dim_col <span class="free">M</span> <span class="main">=</span> dim_row <span class="free">M</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> hermitian_def adjoint_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> adjoint_dim_col<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Linear_Algebra_Complements-hermitian_add"><span class="command">lemma</span></span> hermitian_add<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span><span class="main">∈</span> carrier_mat <span class="free">n</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">B</span><span class="main">∈</span> carrier_mat <span class="free">n</span> <span class="free">n</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"hermitian <span class="free">A</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"hermitian <span class="free">B</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"hermitian <span class="main">(</span><span class="free">A</span> <span class="main">+</span> <span class="free">B</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> hermitian_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> adjoint_add assms hermitian_def<span class="main">)</span>

<span class="keyword1" id="Linear_Algebra_Complements-hermitian_minus"><span class="command">lemma</span></span> hermitian_minus<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span><span class="main">∈</span> carrier_mat <span class="free">n</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">B</span><span class="main">∈</span> carrier_mat <span class="free">n</span> <span class="free">n</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"hermitian <span class="free">A</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"hermitian <span class="free">B</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"hermitian <span class="main">(</span><span class="free">A</span> <span class="main">-</span> <span class="free">B</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> hermitian_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> adjoint_minus assms hermitian_def<span class="main">)</span>

<span class="keyword1" id="Linear_Algebra_Complements-hermitian_smult"><span class="command">lemma</span></span> hermitian_smult<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">a</span><span class="main">::</span><span class="quoted">real</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span><span class="main">::</span><span class="quoted"><span class="quoted">"complex Matrix.mat"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">∈</span> carrier_mat <span class="free">n</span> <span class="free">n</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"hermitian <span class="free">A</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"hermitian <span class="main">(</span><span class="free">a</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>m</sub></span>  <span class="free">A</span><span class="main">)</span>"</span></span>    
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> dim<span class="main">:</span> <span class="quoted"><span class="quoted">"Complex_Matrix.adjoint <span class="free">A</span> <span class="main">∈</span> carrier_mat <span class="free">n</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> adjoint_dim<span class="main">)</span> 
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="skolem">j</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"Complex_Matrix.adjoint <span class="main">(</span><span class="free">a</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">A</span><span class="main">)</span> <span class="main">$$</span> <span class="main">(</span><span class="skolem">i</span><span class="main">,</span><span class="skolem">j</span><span class="main">)</span> <span class="main">=</span> <span class="free">a</span> <span class="main">*</span> <span class="main">(</span>Complex_Matrix.adjoint <span class="free">A</span> <span class="main">$$</span> <span class="main">(</span><span class="skolem">i</span><span class="main">,</span><span class="skolem">j</span><span class="main">)</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> adjoint_scale<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="free">A</span></span><span class="main">]</span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="free">a</span> <span class="main">*</span> <span class="main">(</span><span class="free">A</span> <span class="main">$$</span> <span class="main">(</span><span class="skolem">i</span><span class="main">,</span><span class="skolem">j</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> hermitian_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="free">a</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">A</span><span class="main">)</span> <span class="main">$$</span> <span class="main">(</span><span class="skolem">i</span><span class="main">,</span><span class="skolem">j</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">&lt;</span> <span class="free">n</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">j</span> <span class="main">&lt;</span> <span class="free">n</span>›</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Complex_Matrix.adjoint <span class="main">(</span><span class="free">a</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">A</span><span class="main">)</span> <span class="main">$$</span> <span class="main">(</span><span class="skolem">i</span><span class="main">,</span><span class="skolem">j</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">a</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">A</span><span class="main">)</span> <span class="main">$$</span> <span class="main">(</span><span class="skolem">i</span><span class="main">,</span><span class="skolem">j</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> dim assms <span class="keyword1"><span class="command">unfolding</span></span> hermitian_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Linear_Algebra_Complements-unitary_eigenvalues_norm_square"><span class="command">lemma</span></span> unitary_eigenvalues_norm_square<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">U</span><span class="main">::</span><span class="quoted"><span class="quoted">"complex Matrix.mat"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"unitary <span class="free">U</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">U</span> <span class="main">∈</span> carrier_mat <span class="free">n</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"eigenvalue <span class="free">U</span> <span class="free">k</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"conjugate <span class="free">k</span> <span class="main">*</span> <span class="free">k</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">v</span><span class="main">.</span> eigenvector <span class="free">U</span> <span class="bound">v</span> <span class="free">k</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> eigenvalue_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"eigenvector <span class="free">U</span> <span class="skolem">v</span> <span class="free">k</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">vn</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">vn</span> <span class="main">=</span> vec_normalize <span class="skolem">v</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eigenvector <span class="free">U</span> <span class="skolem">vn</span> <span class="free">k</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> normalize_keep_eigenvector <span class="quoted"><span class="quoted">‹eigenvector <span class="free">U</span> <span class="skolem">v</span> <span class="free">k</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> eigenvector_def vn_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">vn</span> <span class="main">∈</span> carrier_vec <span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹eigenvector <span class="free">U</span> <span class="skolem">v</span> <span class="free">k</span>›</span></span> assms<span class="main">(</span>2<span class="main">)</span> eigenvector_def normalized_vec_dim vn_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Complex_Matrix.inner_prod <span class="skolem">vn</span> <span class="skolem">vn</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">vn</span> <span class="main">=</span> vec_normalize <span class="skolem">v</span>›</span></span> <span class="quoted"><span class="quoted">‹eigenvector <span class="free">U</span> <span class="skolem">v</span> <span class="free">k</span>›</span></span> 
        eigenvector_def normalized_vec_norm <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"conjugate <span class="free">k</span> <span class="main">*</span> <span class="free">k</span> <span class="main">=</span> conjugate <span class="free">k</span> <span class="main">*</span> <span class="free">k</span> <span class="main">*</span> Complex_Matrix.inner_prod <span class="skolem">vn</span> <span class="skolem">vn</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> conjugate <span class="free">k</span> <span class="main">*</span> Complex_Matrix.inner_prod <span class="skolem">vn</span> <span class="main">(</span><span class="free">k</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="skolem">vn</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">*</span> Complex_Matrix.inner_prod <span class="skolem">vn</span> <span class="skolem">vn</span> <span class="main">=</span> Complex_Matrix.inner_prod <span class="skolem">vn</span> <span class="main">(</span><span class="free">k</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="skolem">vn</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> inner_prod_smult_left<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">vn</span></span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="skolem">vn</span></span> <span class="quoted"><span class="free">k</span></span><span class="main">]</span> <span class="quoted"><span class="quoted">‹<span class="skolem">vn</span> <span class="main">∈</span> carrier_vec <span class="free">n</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> Complex_Matrix.inner_prod <span class="main">(</span><span class="free">k</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="skolem">vn</span><span class="main">)</span> <span class="main">(</span><span class="free">k</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="skolem">vn</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> inner_prod_smult_right<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">vn</span></span> <span class="quoted"><span class="free">n</span></span> <span class="main">_</span> <span class="quoted"><span class="free">k</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">vn</span> <span class="main">∈</span> carrier_vec <span class="free">n</span>›</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> Complex_Matrix.inner_prod <span class="main">(</span><span class="free">U</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>v</sub></span> <span class="skolem">vn</span><span class="main">)</span> <span class="main">(</span><span class="free">U</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>v</sub></span> <span class="skolem">vn</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹eigenvector <span class="free">U</span> <span class="skolem">vn</span> <span class="free">k</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> eigenvector_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span>  
    Complex_Matrix.inner_prod <span class="main">(</span>Complex_Matrix.adjoint <span class="free">U</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>v</sub></span> <span class="main">(</span><span class="free">U</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>v</sub></span> <span class="skolem">vn</span><span class="main">)</span><span class="main">)</span> <span class="skolem">vn</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> adjoint_def_alter<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">U</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>v</sub></span> <span class="skolem">vn</span>"</span></span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="skolem">vn</span></span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="free">U</span></span><span class="main">]</span> assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹eigenvector <span class="free">U</span> <span class="skolem">vn</span> <span class="free">k</span>›</span></span> carrier_matD<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> carrier_vec_dim_vec dim_mult_mat_vec 
        eigenvector_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> Complex_Matrix.inner_prod <span class="skolem">vn</span> <span class="skolem">vn</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Complex_Matrix.adjoint <span class="free">U</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>v</sub></span> <span class="main">(</span><span class="free">U</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>v</sub></span> <span class="skolem">vn</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>Complex_Matrix.adjoint <span class="free">U</span> <span class="main">*</span> <span class="free">U</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>v</sub></span> <span class="skolem">vn</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹eigenvector <span class="free">U</span> <span class="skolem">vn</span> <span class="free">k</span>›</span></span> adjoint_dim assoc_mult_mat_vec carrier_matD<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> eigenvector_def<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="skolem">vn</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> unitary_def inverts_mat_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹eigenvector <span class="free">U</span> <span class="skolem">vn</span> <span class="free">k</span>›</span></span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> eigenvector_def one_mult_mat_vec unitary_simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">vn</span> <span class="main">=</span> vec_normalize <span class="skolem">v</span>›</span></span> <span class="quoted"><span class="quoted">‹eigenvector <span class="free">U</span> <span class="skolem">v</span> <span class="free">k</span>›</span></span> eigenvector_def 
      normalized_vec_norm <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Linear_Algebra_Complements-outer_prod_smult_left"><span class="command">lemma</span></span> outer_prod_smult_left<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">v</span><span class="main">::</span><span class="quoted"><span class="quoted">"complex Matrix.vec"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"outer_prod <span class="main">(</span><span class="free">a</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">v</span><span class="main">)</span> <span class="free">w</span> <span class="main">=</span> <span class="free">a</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>m</sub></span> outer_prod <span class="free">v</span> <span class="free">w</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">paw</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">paw</span> <span class="main">=</span> outer_prod <span class="main">(</span><span class="free">a</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">v</span><span class="main">)</span> <span class="free">w</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">apw</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">apw</span> <span class="main">=</span> <span class="free">a</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>m</sub></span> outer_prod <span class="free">v</span> <span class="free">w</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">paw</span> <span class="main">=</span> <span class="skolem">apw</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"dim_row <span class="skolem">paw</span> <span class="main">=</span> dim_vec <span class="free">v</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> paw_def <span class="keyword1"><span class="command">using</span></span> outer_prod_dim
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> carrier_matD<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> carrier_vec_dim_vec index_smult_vec<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> dim_row <span class="skolem">apw</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> apw_def <span class="keyword1"><span class="command">using</span></span> outer_prod_dim
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> carrier_matD<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> carrier_vec_dim_vec index_smult_mat<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> dr<span class="main">:</span> <span class="quoted"><span class="quoted">"dim_row <span class="skolem">paw</span> <span class="main">=</span> dim_row <span class="skolem">apw</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"dim_col <span class="skolem">paw</span> <span class="main">=</span> dim_vec <span class="free">w</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> paw_def <span class="keyword1"><span class="command">using</span></span> outer_prod_dim
      <span class="keyword1"><span class="command">using</span></span> carrier_vec_dim_vec <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> dim_col <span class="skolem">apw</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> apw_def <span class="keyword1"><span class="command">using</span></span> outer_prod_dim
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> apw_def carrier_matD<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> carrier_vec_dim_vec smult_carrier_mat<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> dc<span class="main">:</span> <span class="quoted"><span class="quoted">"dim_col <span class="skolem">paw</span> <span class="main">=</span> dim_col <span class="skolem">apw</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> dim_row <span class="skolem">apw</span> <span class="main">⟹</span> <span class="bound">j</span> <span class="main">&lt;</span> dim_col <span class="skolem">apw</span> <span class="main">⟹</span> <span class="skolem">paw</span> <span class="main">$$</span> <span class="main">(</span><span class="bound">i</span><span class="main">,</span> <span class="bound">j</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">apw</span> <span class="main">$$</span> <span class="main">(</span><span class="bound">i</span><span class="main">,</span> <span class="bound">j</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="skolem">j</span>
      <span class="keyword3"><span class="command">assume</span></span>  <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> dim_row <span class="skolem">apw</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> dim_col <span class="skolem">apw</span>"</span></span> <span class="keyword1"><span class="command">note</span></span> ij <span class="main">=</span> this
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">paw</span> <span class="main">$$</span> <span class="main">(</span><span class="skolem">i</span><span class="main">,</span><span class="skolem">j</span><span class="main">)</span> <span class="main">=</span> <span class="free">a</span> <span class="main">*</span> <span class="main">(</span>Matrix.vec_index <span class="free">v</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">*</span> cnj <span class="main">(</span>Matrix.vec_index <span class="free">w</span> <span class="skolem">j</span><span class="main">)</span>"</span></span> 
        <span class="keyword1"><span class="command">using</span></span> dr dc <span class="keyword1"><span class="command">unfolding</span></span>  paw_def outer_prod_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="skolem">apw</span> <span class="main">$$</span> <span class="main">(</span><span class="skolem">i</span><span class="main">,</span><span class="skolem">j</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> dr dc ij <span class="keyword1"><span class="command">unfolding</span></span> apw_def outer_prod_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">paw</span> <span class="main">$$</span> <span class="main">(</span><span class="skolem">i</span><span class="main">,</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">apw</span> <span class="main">$$</span> <span class="main">(</span><span class="skolem">i</span><span class="main">,</span> <span class="skolem">j</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> paw_def apw_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Linear_Algebra_Complements-outer_prod_smult_right"><span class="command">lemma</span></span> outer_prod_smult_right<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">v</span><span class="main">::</span><span class="quoted"><span class="quoted">"complex Matrix.vec"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"outer_prod <span class="free">v</span> <span class="main">(</span><span class="free">a</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">w</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>conjugate <span class="free">a</span><span class="main">)</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>m</sub></span> outer_prod <span class="free">v</span> <span class="free">w</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">paw</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">paw</span> <span class="main">=</span> outer_prod <span class="free">v</span> <span class="main">(</span><span class="free">a</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">w</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">apw</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">apw</span> <span class="main">=</span> <span class="main">(</span>conjugate <span class="free">a</span><span class="main">)</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>m</sub></span> outer_prod <span class="free">v</span> <span class="free">w</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">paw</span> <span class="main">=</span> <span class="skolem">apw</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"dim_row <span class="skolem">paw</span> <span class="main">=</span> dim_vec <span class="free">v</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> paw_def <span class="keyword1"><span class="command">using</span></span> outer_prod_dim
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> carrier_matD<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> carrier_vec_dim_vec<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> dim_row <span class="skolem">apw</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> apw_def <span class="keyword1"><span class="command">using</span></span> outer_prod_dim
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> carrier_matD<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> carrier_vec_dim_vec index_smult_mat<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> dr<span class="main">:</span> <span class="quoted"><span class="quoted">"dim_row <span class="skolem">paw</span> <span class="main">=</span> dim_row <span class="skolem">apw</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"dim_col <span class="skolem">paw</span> <span class="main">=</span> dim_vec <span class="free">w</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> paw_def <span class="keyword1"><span class="command">using</span></span> outer_prod_dim
      <span class="keyword1"><span class="command">using</span></span> carrier_vec_dim_vec <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> carrier_matD<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> index_smult_vec<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span> 
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> dim_col <span class="skolem">apw</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> apw_def <span class="keyword1"><span class="command">using</span></span> outer_prod_dim
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> apw_def carrier_matD<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> carrier_vec_dim_vec smult_carrier_mat<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> dc<span class="main">:</span> <span class="quoted"><span class="quoted">"dim_col <span class="skolem">paw</span> <span class="main">=</span> dim_col <span class="skolem">apw</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> dim_row <span class="skolem">apw</span> <span class="main">⟹</span> <span class="bound">j</span> <span class="main">&lt;</span> dim_col <span class="skolem">apw</span> <span class="main">⟹</span> <span class="skolem">paw</span> <span class="main">$$</span> <span class="main">(</span><span class="bound">i</span><span class="main">,</span> <span class="bound">j</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">apw</span> <span class="main">$$</span> <span class="main">(</span><span class="bound">i</span><span class="main">,</span> <span class="bound">j</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="skolem">j</span>
      <span class="keyword3"><span class="command">assume</span></span>  <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> dim_row <span class="skolem">apw</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> dim_col <span class="skolem">apw</span>"</span></span> <span class="keyword1"><span class="command">note</span></span> ij <span class="main">=</span> this
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">paw</span> <span class="main">$$</span> <span class="main">(</span><span class="skolem">i</span><span class="main">,</span><span class="skolem">j</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>conjugate <span class="free">a</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span>Matrix.vec_index <span class="free">v</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">*</span> cnj <span class="main">(</span>Matrix.vec_index <span class="free">w</span> <span class="skolem">j</span><span class="main">)</span>"</span></span> 
        <span class="keyword1"><span class="command">using</span></span> dr dc <span class="keyword1"><span class="command">unfolding</span></span>  paw_def outer_prod_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="skolem">apw</span> <span class="main">$$</span> <span class="main">(</span><span class="skolem">i</span><span class="main">,</span><span class="skolem">j</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> dr dc ij <span class="keyword1"><span class="command">unfolding</span></span> apw_def outer_prod_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">paw</span> <span class="main">$$</span> <span class="main">(</span><span class="skolem">i</span><span class="main">,</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">apw</span> <span class="main">$$</span> <span class="main">(</span><span class="skolem">i</span><span class="main">,</span> <span class="skolem">j</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> paw_def apw_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Linear_Algebra_Complements-outer_prod_add_left"><span class="command">lemma</span></span> outer_prod_add_left<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">v</span><span class="main">::</span><span class="quoted"><span class="quoted">"complex Matrix.vec"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"dim_vec <span class="free">v</span> <span class="main">=</span> dim_vec <span class="free">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"outer_prod <span class="main">(</span><span class="free">v</span> <span class="main">+</span> <span class="free">x</span><span class="main">)</span> <span class="free">w</span> <span class="main">=</span> outer_prod <span class="free">v</span> <span class="free">w</span> <span class="main">+</span> <span class="main">(</span>outer_prod <span class="free">x</span> <span class="free">w</span><span class="main">)</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">paw</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">paw</span> <span class="main">=</span> outer_prod <span class="main">(</span><span class="free">v</span><span class="main">+</span><span class="free">x</span><span class="main">)</span> <span class="free">w</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">apw</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">apw</span> <span class="main">=</span> outer_prod <span class="free">v</span> <span class="free">w</span> <span class="main">+</span> <span class="main">(</span>outer_prod <span class="free">x</span> <span class="free">w</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">paw</span> <span class="main">=</span> <span class="skolem">apw</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword1"><span class="command">have</span></span> rv<span class="main">:</span> <span class="quoted"><span class="quoted">"dim_row <span class="skolem">paw</span> <span class="main">=</span> dim_vec <span class="free">v</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> paw_def <span class="keyword1"><span class="command">using</span></span> outer_prod_dim assms
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> carrier_matD<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> carrier_vec_dim_vec index_add_vec<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> paw_def<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> dim_row <span class="skolem">apw</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> apw_def <span class="keyword1"><span class="command">using</span></span> outer_prod_dim assms
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> carrier_matD<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> carrier_vec_dim_vec index_add_mat<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> dr<span class="main">:</span> <span class="quoted"><span class="quoted">"dim_row <span class="skolem">paw</span> <span class="main">=</span> dim_row <span class="skolem">apw</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">have</span></span> cw<span class="main">:</span> <span class="quoted"><span class="quoted">"dim_col <span class="skolem">paw</span> <span class="main">=</span> dim_vec <span class="free">w</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> paw_def <span class="keyword1"><span class="command">using</span></span> outer_prod_dim assms
      <span class="keyword1"><span class="command">using</span></span> carrier_vec_dim_vec <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> carrier_matD<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span> 
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> dim_col <span class="skolem">apw</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> apw_def <span class="keyword1"><span class="command">using</span></span> outer_prod_dim
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> apw_def carrier_matD<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> carrier_vec_dim_vec add_carrier_mat<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> dc<span class="main">:</span> <span class="quoted"><span class="quoted">"dim_col <span class="skolem">paw</span> <span class="main">=</span> dim_col <span class="skolem">apw</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> dim_row <span class="skolem">apw</span> <span class="main">⟹</span> <span class="bound">j</span> <span class="main">&lt;</span> dim_col <span class="skolem">apw</span> <span class="main">⟹</span> <span class="skolem">paw</span> <span class="main">$$</span> <span class="main">(</span><span class="bound">i</span><span class="main">,</span> <span class="bound">j</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">apw</span> <span class="main">$$</span> <span class="main">(</span><span class="bound">i</span><span class="main">,</span> <span class="bound">j</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="skolem">j</span>
      <span class="keyword3"><span class="command">assume</span></span>  <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> dim_row <span class="skolem">apw</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> dim_col <span class="skolem">apw</span>"</span></span> <span class="keyword1"><span class="command">note</span></span> ij <span class="main">=</span> this
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">paw</span> <span class="main">$$</span> <span class="main">(</span><span class="skolem">i</span><span class="main">,</span><span class="skolem">j</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>Matrix.vec_index <span class="free">v</span> <span class="skolem">i</span> <span class="main">+</span> Matrix.vec_index <span class="free">x</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">*</span> 
        cnj <span class="main">(</span>Matrix.vec_index <span class="free">w</span> <span class="skolem">j</span><span class="main">)</span>"</span></span> 
        <span class="keyword1"><span class="command">using</span></span> dr dc <span class="keyword1"><span class="command">unfolding</span></span>  paw_def outer_prod_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> Matrix.vec_index <span class="free">v</span> <span class="skolem">i</span> <span class="main">*</span> cnj <span class="main">(</span>Matrix.vec_index <span class="free">w</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">+</span> 
        Matrix.vec_index <span class="free">x</span> <span class="skolem">i</span> <span class="main">*</span> cnj <span class="main">(</span>Matrix.vec_index <span class="free">w</span> <span class="skolem">j</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ring_class.ring_distribs<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span>outer_prod <span class="free">v</span> <span class="free">w</span><span class="main">)</span> <span class="main">$$</span> <span class="main">(</span><span class="skolem">i</span><span class="main">,</span><span class="skolem">j</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span>outer_prod <span class="free">x</span> <span class="free">w</span><span class="main">)</span> <span class="main">$$</span> <span class="main">(</span><span class="skolem">i</span><span class="main">,</span><span class="skolem">j</span><span class="main">)</span>"</span></span> 
        <span class="keyword1"><span class="command">using</span></span> rv cw dr dc ij assms <span class="keyword1"><span class="command">unfolding</span></span> outer_prod_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="skolem">apw</span> <span class="main">$$</span> <span class="main">(</span><span class="skolem">i</span><span class="main">,</span><span class="skolem">j</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> dr dc ij <span class="keyword1"><span class="command">unfolding</span></span> apw_def outer_prod_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">paw</span> <span class="main">$$</span> <span class="main">(</span><span class="skolem">i</span><span class="main">,</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">apw</span> <span class="main">$$</span> <span class="main">(</span><span class="skolem">i</span><span class="main">,</span> <span class="skolem">j</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> paw_def apw_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Linear_Algebra_Complements-outer_prod_add_right"><span class="command">lemma</span></span> outer_prod_add_right<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">v</span><span class="main">::</span><span class="quoted"><span class="quoted">"complex Matrix.vec"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"dim_vec <span class="free">w</span> <span class="main">=</span> dim_vec <span class="free">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"outer_prod <span class="free">v</span> <span class="main">(</span><span class="free">w</span> <span class="main">+</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> outer_prod <span class="free">v</span> <span class="free">w</span> <span class="main">+</span> <span class="main">(</span>outer_prod <span class="free">v</span> <span class="free">x</span><span class="main">)</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">paw</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">paw</span> <span class="main">=</span> outer_prod <span class="free">v</span> <span class="main">(</span><span class="free">w</span><span class="main">+</span><span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">apw</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">apw</span> <span class="main">=</span> outer_prod <span class="free">v</span> <span class="free">w</span> <span class="main">+</span> <span class="main">(</span>outer_prod <span class="free">v</span> <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">paw</span> <span class="main">=</span> <span class="skolem">apw</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword1"><span class="command">have</span></span> rv<span class="main">:</span> <span class="quoted"><span class="quoted">"dim_row <span class="skolem">paw</span> <span class="main">=</span> dim_vec <span class="free">v</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> paw_def <span class="keyword1"><span class="command">using</span></span> outer_prod_dim assms
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> carrier_matD<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> carrier_vec_dim_vec index_add_vec<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> paw_def<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> dim_row <span class="skolem">apw</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> apw_def <span class="keyword1"><span class="command">using</span></span> outer_prod_dim assms
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> carrier_matD<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> carrier_vec_dim_vec index_add_mat<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> dr<span class="main">:</span> <span class="quoted"><span class="quoted">"dim_row <span class="skolem">paw</span> <span class="main">=</span> dim_row <span class="skolem">apw</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">have</span></span> cw<span class="main">:</span> <span class="quoted"><span class="quoted">"dim_col <span class="skolem">paw</span> <span class="main">=</span> dim_vec <span class="free">w</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> paw_def <span class="keyword1"><span class="command">using</span></span> outer_prod_dim assms
      <span class="keyword1"><span class="command">using</span></span> carrier_vec_dim_vec
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> carrier_matD<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> index_add_vec<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> paw_def<span class="main">)</span> 
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> dim_col <span class="skolem">apw</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> apw_def <span class="keyword1"><span class="command">using</span></span> outer_prod_dim
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms carrier_matD<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> carrier_vec_dim_vec index_add_mat<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> dc<span class="main">:</span> <span class="quoted"><span class="quoted">"dim_col <span class="skolem">paw</span> <span class="main">=</span> dim_col <span class="skolem">apw</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> dim_row <span class="skolem">apw</span> <span class="main">⟹</span> <span class="bound">j</span> <span class="main">&lt;</span> dim_col <span class="skolem">apw</span> <span class="main">⟹</span> <span class="skolem">paw</span> <span class="main">$$</span> <span class="main">(</span><span class="bound">i</span><span class="main">,</span> <span class="bound">j</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">apw</span> <span class="main">$$</span> <span class="main">(</span><span class="bound">i</span><span class="main">,</span> <span class="bound">j</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="skolem">j</span>
      <span class="keyword3"><span class="command">assume</span></span>  <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> dim_row <span class="skolem">apw</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> dim_col <span class="skolem">apw</span>"</span></span> <span class="keyword1"><span class="command">note</span></span> ij <span class="main">=</span> this
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">paw</span> <span class="main">$$</span> <span class="main">(</span><span class="skolem">i</span><span class="main">,</span><span class="skolem">j</span><span class="main">)</span> <span class="main">=</span> Matrix.vec_index <span class="free">v</span> <span class="skolem">i</span> <span class="main">*</span> 
        <span class="main">(</span>cnj <span class="main">(</span>Matrix.vec_index <span class="free">w</span> <span class="skolem">j</span> <span class="main">+</span> <span class="main">(</span>Matrix.vec_index <span class="free">x</span> <span class="skolem">j</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> 
        <span class="keyword1"><span class="command">using</span></span> dr dc <span class="keyword1"><span class="command">unfolding</span></span>  paw_def outer_prod_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> Matrix.vec_index <span class="free">v</span> <span class="skolem">i</span> <span class="main">*</span> cnj <span class="main">(</span>Matrix.vec_index <span class="free">w</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">+</span> 
        Matrix.vec_index <span class="free">v</span> <span class="skolem">i</span> <span class="main">*</span> cnj <span class="main">(</span>Matrix.vec_index <span class="free">x</span> <span class="skolem">j</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ring_class.ring_distribs<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span>outer_prod <span class="free">v</span> <span class="free">w</span><span class="main">)</span> <span class="main">$$</span> <span class="main">(</span><span class="skolem">i</span><span class="main">,</span><span class="skolem">j</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span>outer_prod <span class="free">v</span> <span class="free">x</span><span class="main">)</span> <span class="main">$$</span> <span class="main">(</span><span class="skolem">i</span><span class="main">,</span><span class="skolem">j</span><span class="main">)</span>"</span></span> 
        <span class="keyword1"><span class="command">using</span></span> rv cw dr dc ij assms <span class="keyword1"><span class="command">unfolding</span></span> outer_prod_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="skolem">apw</span> <span class="main">$$</span> <span class="main">(</span><span class="skolem">i</span><span class="main">,</span><span class="skolem">j</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> dr dc ij <span class="keyword1"><span class="command">unfolding</span></span> apw_def outer_prod_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">paw</span> <span class="main">$$</span> <span class="main">(</span><span class="skolem">i</span><span class="main">,</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">apw</span> <span class="main">$$</span> <span class="main">(</span><span class="skolem">i</span><span class="main">,</span> <span class="skolem">j</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> paw_def apw_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Linear_Algebra_Complements-outer_prod_minus_left"><span class="command">lemma</span></span> outer_prod_minus_left<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">v</span><span class="main">::</span><span class="quoted"><span class="quoted">"complex Matrix.vec"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"dim_vec <span class="free">v</span> <span class="main">=</span> dim_vec <span class="free">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"outer_prod <span class="main">(</span><span class="free">v</span> <span class="main">-</span> <span class="free">x</span><span class="main">)</span> <span class="free">w</span> <span class="main">=</span> outer_prod <span class="free">v</span> <span class="free">w</span> <span class="main">-</span> <span class="main">(</span>outer_prod <span class="free">x</span> <span class="free">w</span><span class="main">)</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">paw</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">paw</span> <span class="main">=</span> outer_prod <span class="main">(</span><span class="free">v</span><span class="main">-</span><span class="free">x</span><span class="main">)</span> <span class="free">w</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">apw</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">apw</span> <span class="main">=</span> outer_prod <span class="free">v</span> <span class="free">w</span> <span class="main">-</span> <span class="main">(</span>outer_prod <span class="free">x</span> <span class="free">w</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">paw</span> <span class="main">=</span> <span class="skolem">apw</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword1"><span class="command">have</span></span> rv<span class="main">:</span> <span class="quoted"><span class="quoted">"dim_row <span class="skolem">paw</span> <span class="main">=</span> dim_vec <span class="free">v</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> paw_def <span class="keyword1"><span class="command">using</span></span> outer_prod_dim assms
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> carrier_matD<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> carrier_vec_dim_vec index_minus_vec<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> paw_def<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> dim_row <span class="skolem">apw</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> apw_def <span class="keyword1"><span class="command">using</span></span> outer_prod_dim assms
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> carrier_matD<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> carrier_vec_dim_vec index_minus_mat<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> dr<span class="main">:</span> <span class="quoted"><span class="quoted">"dim_row <span class="skolem">paw</span> <span class="main">=</span> dim_row <span class="skolem">apw</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">have</span></span> cw<span class="main">:</span> <span class="quoted"><span class="quoted">"dim_col <span class="skolem">paw</span> <span class="main">=</span> dim_vec <span class="free">w</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> paw_def <span class="keyword1"><span class="command">using</span></span> outer_prod_dim assms
      <span class="keyword1"><span class="command">using</span></span> carrier_vec_dim_vec <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> carrier_matD<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span> 
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> dim_col <span class="skolem">apw</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> apw_def <span class="keyword1"><span class="command">using</span></span> outer_prod_dim
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> apw_def carrier_matD<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> carrier_vec_dim_vec minus_carrier_mat<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> dc<span class="main">:</span> <span class="quoted"><span class="quoted">"dim_col <span class="skolem">paw</span> <span class="main">=</span> dim_col <span class="skolem">apw</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> dim_row <span class="skolem">apw</span> <span class="main">⟹</span> <span class="bound">j</span> <span class="main">&lt;</span> dim_col <span class="skolem">apw</span> <span class="main">⟹</span> <span class="skolem">paw</span> <span class="main">$$</span> <span class="main">(</span><span class="bound">i</span><span class="main">,</span> <span class="bound">j</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">apw</span> <span class="main">$$</span> <span class="main">(</span><span class="bound">i</span><span class="main">,</span> <span class="bound">j</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="skolem">j</span>
      <span class="keyword3"><span class="command">assume</span></span>  <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> dim_row <span class="skolem">apw</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> dim_col <span class="skolem">apw</span>"</span></span> <span class="keyword1"><span class="command">note</span></span> ij <span class="main">=</span> this
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">paw</span> <span class="main">$$</span> <span class="main">(</span><span class="skolem">i</span><span class="main">,</span><span class="skolem">j</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>Matrix.vec_index <span class="free">v</span> <span class="skolem">i</span> <span class="main">-</span> Matrix.vec_index <span class="free">x</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">*</span> 
        cnj <span class="main">(</span>Matrix.vec_index <span class="free">w</span> <span class="skolem">j</span><span class="main">)</span>"</span></span> 
        <span class="keyword1"><span class="command">using</span></span> dr dc <span class="keyword1"><span class="command">unfolding</span></span>  paw_def outer_prod_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> Matrix.vec_index <span class="free">v</span> <span class="skolem">i</span> <span class="main">*</span> cnj <span class="main">(</span>Matrix.vec_index <span class="free">w</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">-</span> 
        Matrix.vec_index <span class="free">x</span> <span class="skolem">i</span> <span class="main">*</span> cnj <span class="main">(</span>Matrix.vec_index <span class="free">w</span> <span class="skolem">j</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ring_class.ring_distribs<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span>outer_prod <span class="free">v</span> <span class="free">w</span><span class="main">)</span> <span class="main">$$</span> <span class="main">(</span><span class="skolem">i</span><span class="main">,</span><span class="skolem">j</span><span class="main">)</span> <span class="main">-</span> <span class="main">(</span>outer_prod <span class="free">x</span> <span class="free">w</span><span class="main">)</span> <span class="main">$$</span> <span class="main">(</span><span class="skolem">i</span><span class="main">,</span><span class="skolem">j</span><span class="main">)</span>"</span></span> 
        <span class="keyword1"><span class="command">using</span></span> rv cw dr dc ij assms <span class="keyword1"><span class="command">unfolding</span></span> outer_prod_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="skolem">apw</span> <span class="main">$$</span> <span class="main">(</span><span class="skolem">i</span><span class="main">,</span><span class="skolem">j</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> dr dc ij <span class="keyword1"><span class="command">unfolding</span></span> apw_def outer_prod_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">paw</span> <span class="main">$$</span> <span class="main">(</span><span class="skolem">i</span><span class="main">,</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">apw</span> <span class="main">$$</span> <span class="main">(</span><span class="skolem">i</span><span class="main">,</span> <span class="skolem">j</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> paw_def apw_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Linear_Algebra_Complements-outer_prod_minus_right"><span class="command">lemma</span></span> outer_prod_minus_right<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">v</span><span class="main">::</span><span class="quoted"><span class="quoted">"complex Matrix.vec"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"dim_vec <span class="free">w</span> <span class="main">=</span> dim_vec <span class="free">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"outer_prod <span class="free">v</span> <span class="main">(</span><span class="free">w</span> <span class="main">-</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> outer_prod <span class="free">v</span> <span class="free">w</span> <span class="main">-</span> <span class="main">(</span>outer_prod <span class="free">v</span> <span class="free">x</span><span class="main">)</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">paw</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">paw</span> <span class="main">=</span> outer_prod <span class="free">v</span> <span class="main">(</span><span class="free">w</span><span class="main">-</span><span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">apw</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">apw</span> <span class="main">=</span> outer_prod <span class="free">v</span> <span class="free">w</span> <span class="main">-</span> <span class="main">(</span>outer_prod <span class="free">v</span> <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">paw</span> <span class="main">=</span> <span class="skolem">apw</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword1"><span class="command">have</span></span> rv<span class="main">:</span> <span class="quoted"><span class="quoted">"dim_row <span class="skolem">paw</span> <span class="main">=</span> dim_vec <span class="free">v</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> paw_def <span class="keyword1"><span class="command">using</span></span> outer_prod_dim assms
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> carrier_matD<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> carrier_vec_dim_vec paw_def<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> dim_row <span class="skolem">apw</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> apw_def <span class="keyword1"><span class="command">using</span></span> outer_prod_dim assms
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> carrier_matD<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> carrier_vec_dim_vec index_minus_mat<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> dr<span class="main">:</span> <span class="quoted"><span class="quoted">"dim_row <span class="skolem">paw</span> <span class="main">=</span> dim_row <span class="skolem">apw</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">have</span></span> cw<span class="main">:</span> <span class="quoted"><span class="quoted">"dim_col <span class="skolem">paw</span> <span class="main">=</span> dim_vec <span class="free">w</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> paw_def <span class="keyword1"><span class="command">using</span></span> outer_prod_dim assms
      <span class="keyword1"><span class="command">using</span></span> carrier_vec_dim_vec
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> carrier_matD<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> index_minus_vec<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> paw_def<span class="main">)</span> 
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> dim_col <span class="skolem">apw</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> apw_def <span class="keyword1"><span class="command">using</span></span> outer_prod_dim
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms carrier_matD<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> carrier_vec_dim_vec index_minus_mat<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> dc<span class="main">:</span> <span class="quoted"><span class="quoted">"dim_col <span class="skolem">paw</span> <span class="main">=</span> dim_col <span class="skolem">apw</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> dim_row <span class="skolem">apw</span> <span class="main">⟹</span> <span class="bound">j</span> <span class="main">&lt;</span> dim_col <span class="skolem">apw</span> <span class="main">⟹</span> <span class="skolem">paw</span> <span class="main">$$</span> <span class="main">(</span><span class="bound">i</span><span class="main">,</span> <span class="bound">j</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">apw</span> <span class="main">$$</span> <span class="main">(</span><span class="bound">i</span><span class="main">,</span> <span class="bound">j</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="skolem">j</span>
      <span class="keyword3"><span class="command">assume</span></span>  <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> dim_row <span class="skolem">apw</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> dim_col <span class="skolem">apw</span>"</span></span> <span class="keyword1"><span class="command">note</span></span> ij <span class="main">=</span> this
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">paw</span> <span class="main">$$</span> <span class="main">(</span><span class="skolem">i</span><span class="main">,</span><span class="skolem">j</span><span class="main">)</span> <span class="main">=</span> Matrix.vec_index <span class="free">v</span> <span class="skolem">i</span> <span class="main">*</span> 
        <span class="main">(</span>cnj <span class="main">(</span>Matrix.vec_index <span class="free">w</span> <span class="skolem">j</span> <span class="main">-</span> <span class="main">(</span>Matrix.vec_index <span class="free">x</span> <span class="skolem">j</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> 
        <span class="keyword1"><span class="command">using</span></span> dr dc <span class="keyword1"><span class="command">unfolding</span></span>  paw_def outer_prod_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> Matrix.vec_index <span class="free">v</span> <span class="skolem">i</span> <span class="main">*</span> cnj <span class="main">(</span>Matrix.vec_index <span class="free">w</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">-</span> 
        Matrix.vec_index <span class="free">v</span> <span class="skolem">i</span> <span class="main">*</span> cnj <span class="main">(</span>Matrix.vec_index <span class="free">x</span> <span class="skolem">j</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ring_class.ring_distribs<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span>outer_prod <span class="free">v</span> <span class="free">w</span><span class="main">)</span> <span class="main">$$</span> <span class="main">(</span><span class="skolem">i</span><span class="main">,</span><span class="skolem">j</span><span class="main">)</span> <span class="main">-</span> <span class="main">(</span>outer_prod <span class="free">v</span> <span class="free">x</span><span class="main">)</span> <span class="main">$$</span> <span class="main">(</span><span class="skolem">i</span><span class="main">,</span><span class="skolem">j</span><span class="main">)</span>"</span></span> 
        <span class="keyword1"><span class="command">using</span></span> rv cw dr dc ij assms <span class="keyword1"><span class="command">unfolding</span></span> outer_prod_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="skolem">apw</span> <span class="main">$$</span> <span class="main">(</span><span class="skolem">i</span><span class="main">,</span><span class="skolem">j</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> dr dc ij <span class="keyword1"><span class="command">unfolding</span></span> apw_def outer_prod_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">paw</span> <span class="main">$$</span> <span class="main">(</span><span class="skolem">i</span><span class="main">,</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">apw</span> <span class="main">$$</span> <span class="main">(</span><span class="skolem">i</span><span class="main">,</span> <span class="skolem">j</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> paw_def apw_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Linear_Algebra_Complements-outer_minus_minus"><span class="command">lemma</span></span> outer_minus_minus<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">a</span><span class="main">::</span><span class="quoted"><span class="quoted">"complex Matrix.vec"</span></span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"dim_vec <span class="free">a</span> <span class="main">=</span> dim_vec <span class="free">b</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"dim_vec <span class="free">u</span> <span class="main">=</span> dim_vec <span class="free">v</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"outer_prod <span class="main">(</span><span class="free">a</span> <span class="main">-</span> <span class="free">b</span><span class="main">)</span> <span class="main">(</span><span class="free">u</span> <span class="main">-</span> <span class="free">v</span><span class="main">)</span> <span class="main">=</span> outer_prod <span class="free">a</span> <span class="free">u</span> <span class="main">-</span> outer_prod <span class="free">a</span> <span class="free">v</span> <span class="main">-</span>
      outer_prod <span class="free">b</span> <span class="free">u</span> <span class="main">+</span>  outer_prod <span class="free">b</span> <span class="free">v</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"outer_prod <span class="main">(</span><span class="free">a</span> <span class="main">-</span> <span class="free">b</span><span class="main">)</span> <span class="main">(</span><span class="free">u</span> <span class="main">-</span> <span class="free">v</span><span class="main">)</span> <span class="main">=</span> outer_prod <span class="free">a</span> <span class="main">(</span><span class="free">u</span> <span class="main">-</span> <span class="free">v</span><span class="main">)</span>
    <span class="main">-</span> outer_prod <span class="free">b</span> <span class="main">(</span><span class="free">u</span> <span class="main">-</span> <span class="free">v</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span>  outer_prod_minus_left assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> 
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> outer_prod <span class="free">a</span> <span class="free">u</span> <span class="main">-</span> outer_prod <span class="free">a</span> <span class="free">v</span> <span class="main">-</span>
    outer_prod <span class="free">b</span> <span class="main">(</span><span class="free">u</span> <span class="main">-</span> <span class="free">v</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms outer_prod_minus_right <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>  
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> outer_prod <span class="free">a</span> <span class="free">u</span> <span class="main">-</span> outer_prod <span class="free">a</span> <span class="free">v</span> <span class="main">-</span>
    <span class="main">(</span>outer_prod <span class="free">b</span> <span class="free">u</span> <span class="main">-</span> outer_prod <span class="free">b</span> <span class="free">v</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms outer_prod_minus_right <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>  
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span>  <span class="main">=</span> outer_prod <span class="free">a</span> <span class="free">u</span> <span class="main">-</span> outer_prod <span class="free">a</span> <span class="free">v</span> <span class="main">-</span>
    outer_prod <span class="free">b</span> <span class="free">u</span> <span class="main">+</span>  outer_prod <span class="free">b</span> <span class="free">v</span>"</span></span>  
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> mat_minus_minus<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"outer_prod <span class="free">b</span> <span class="free">u</span> <span class="main">∈</span> carrier_mat <span class="main">(</span>dim_vec <span class="free">b</span><span class="main">)</span> <span class="main">(</span>dim_vec <span class="free">u</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"outer_prod <span class="free">b</span> <span class="free">v</span> <span class="main">∈</span> carrier_mat <span class="main">(</span>dim_vec <span class="free">b</span><span class="main">)</span> <span class="main">(</span>dim_vec <span class="free">u</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"outer_prod <span class="free">a</span> <span class="free">u</span> <span class="main">-</span> outer_prod <span class="free">a</span> <span class="free">v</span> <span class="main">∈</span> carrier_mat <span class="main">(</span>dim_vec <span class="free">b</span><span class="main">)</span> <span class="main">(</span>dim_vec <span class="free">u</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> carrier_vecI minus_carrier_mat outer_prod_dim<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Linear_Algebra_Complements-outer_trace_inner"><span class="command">lemma</span></span>  outer_trace_inner<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">∈</span> carrier_mat <span class="free">n</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"dim_vec <span class="free">u</span> <span class="main">=</span> <span class="free">n</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"dim_vec <span class="free">v</span> <span class="main">=</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Complex_Matrix.trace <span class="main">(</span>outer_prod <span class="free">u</span> <span class="free">v</span> <span class="main">*</span> <span class="free">A</span><span class="main">)</span> <span class="main">=</span> Complex_Matrix.inner_prod <span class="free">v</span> <span class="main">(</span><span class="free">A</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">u</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Complex_Matrix.trace <span class="main">(</span>outer_prod <span class="free">u</span> <span class="free">v</span> <span class="main">*</span> <span class="free">A</span><span class="main">)</span> <span class="main">=</span> Complex_Matrix.trace <span class="main">(</span><span class="free">A</span> <span class="main">*</span> outer_prod <span class="free">u</span> <span class="free">v</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> trace_comm<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">∈</span> carrier_mat <span class="free">n</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"outer_prod <span class="free">u</span> <span class="free">v</span> <span class="main">∈</span> carrier_mat <span class="free">n</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">using</span></span>  assms
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> carrier_vec_dim_vec outer_prod_dim<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> Complex_Matrix.inner_prod <span class="free">v</span> <span class="main">(</span><span class="free">A</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">u</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> trace_outer_prod_right<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">A</span></span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="free">u</span></span> <span class="quoted"><span class="free">v</span></span><span class="main">]</span>
    assms   carrier_vec_dim_vec  <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Linear_Algebra_Complements-zero_hermitian"><span class="command">lemma</span></span> zero_hermitian<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"hermitian <span class="main">(</span><span class="keyword1">0<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">n</span> <span class="free">n</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> hermitian_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> adjoint_minus hermitian_def hermitian_one minus_r_inv_mat one_carrier_mat<span class="main">)</span>

<span class="keyword1" id="Linear_Algebra_Complements-trace_1"><span class="command">lemma</span></span>  trace_1<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Complex_Matrix.trace <span class="main">(</span><span class="main">(</span><span class="keyword1">1<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">n</span><span class="main">)</span><span class="main">::</span>complex Matrix.mat<span class="main">)</span> <span class="main">=</span><span class="main">(</span><span class="free">n</span><span class="main">::</span>complex<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> one_mat_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Complex_Matrix.trace_def Matrix.mat_def<span class="main">)</span>

<span class="keyword1" id="Linear_Algebra_Complements-trace_add"><span class="command">lemma</span></span>  trace_add<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"square_mat <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"square_mat <span class="free">B</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"dim_row <span class="free">A</span> <span class="main">=</span> dim_row <span class="free">B</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Complex_Matrix.trace <span class="main">(</span><span class="free">A</span> <span class="main">+</span> <span class="free">B</span><span class="main">)</span> <span class="main">=</span> Complex_Matrix.trace <span class="free">A</span> <span class="main">+</span> Complex_Matrix.trace <span class="free">B</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span>  assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Complex_Matrix.trace_def sum.distrib<span class="main">)</span>

<span class="keyword1" id="Linear_Algebra_Complements-bra_vec_carrier"><span class="command">lemma</span></span> bra_vec_carrier<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"bra_vec <span class="free">v</span> <span class="main">∈</span> carrier_mat <span class="main">1</span> <span class="main">(</span>dim_vec <span class="free">v</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"dim_row <span class="main">(</span>ket_vec <span class="free">v</span><span class="main">)</span> <span class="main">=</span> dim_vec <span class="free">v</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> ket_vec_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> bra_bra_vec<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">v</span></span><span class="main">]</span> bra_def<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"ket_vec <span class="free">v</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Linear_Algebra_Complements-mat_mult_ket_carrier"><span class="command">lemma</span></span> mat_mult_ket_carrier<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span><span class="main">∈</span> carrier_mat <span class="free">n</span> <span class="free">m</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">*</span> <span class="main">|</span><span class="free">v</span><span class="main">⟩</span> <span class="main">∈</span> carrier_mat <span class="free">n</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> bra_bra_vec bra_vec_carrier carrier_matD<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> carrier_matI dagger_of_ket_is_bra 
          dim_row_of_dagger index_mult_mat<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> index_mult_mat<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span> 

<span class="keyword1" id="Linear_Algebra_Complements-mat_mult_ket"><span class="command">lemma</span></span> mat_mult_ket<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">∈</span> carrier_mat <span class="free">n</span> <span class="free">m</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"dim_vec <span class="free">v</span> <span class="main">=</span> <span class="free">m</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">*</span> <span class="main">|</span><span class="free">v</span><span class="main">⟩</span> <span class="main">=</span> <span class="main">|</span><span class="free">A</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">v</span><span class="main">⟩</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> rn<span class="main">:</span> <span class="quoted"><span class="quoted">"dim_row <span class="main">(</span><span class="free">A</span> <span class="main">*</span> <span class="main">|</span><span class="free">v</span><span class="main">⟩</span><span class="main">)</span> <span class="main">=</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> times_mat_def <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> co<span class="main">:</span> <span class="quoted"><span class="quoted">"dim_col <span class="main">|</span><span class="free">A</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">v</span><span class="main">⟩</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> ket_vec_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> cov<span class="main">:</span> <span class="quoted"><span class="quoted">"dim_col <span class="main">|</span><span class="free">v</span><span class="main">⟩</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> ket_vec_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> er<span class="main">:</span> <span class="quoted"><span class="quoted">"dim_row <span class="main">(</span><span class="free">A</span> <span class="main">*</span> <span class="main">|</span><span class="free">v</span><span class="main">⟩</span><span class="main">)</span> <span class="main">=</span> dim_row <span class="main">|</span><span class="free">A</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">v</span><span class="main">⟩</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> bra_bra_vec bra_vec_carrier carrier_matD<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> dagger_of_ket_is_bra dim_col_of_dagger 
        dim_mult_mat_vec index_mult_mat<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span> 
  <span class="keyword1"><span class="command">have</span></span> ec<span class="main">:</span> <span class="quoted"><span class="quoted">"dim_col <span class="main">(</span><span class="free">A</span> <span class="main">*</span> <span class="main">|</span><span class="free">v</span><span class="main">⟩</span><span class="main">)</span> <span class="main">=</span> dim_col <span class="main">|</span><span class="free">A</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">v</span><span class="main">⟩</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> carrier_matD<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> index_mult_mat<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> mat_mult_ket_carrier<span class="main">)</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span><span class="main">::</span><span class="quoted">nat</span> 
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">j</span><span class="main">::</span><span class="quoted">nat</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">A</span> <span class="main">*</span> <span class="main">|</span><span class="free">v</span><span class="main">⟩</span><span class="main">)</span> <span class="main">$$</span> <span class="main">(</span><span class="skolem">i</span><span class="main">,</span><span class="main">0</span><span class="main">)</span> <span class="main">=</span> Matrix.scalar_prod <span class="main">(</span>Matrix.row <span class="free">A</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">(</span>Matrix.col <span class="main">|</span><span class="free">v</span><span class="main">⟩</span> <span class="main">0</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> times_mat_def<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">A</span></span><span class="main">]</span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">&lt;</span> <span class="free">n</span>›</span></span> rn cov <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> Matrix.scalar_prod <span class="main">(</span>Matrix.row <span class="free">A</span> <span class="skolem">i</span><span class="main">)</span> <span class="free">v</span>"</span></span>  <span class="keyword1"><span class="command">using</span></span> ket_vec_col  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span>  <span class="main">|</span><span class="free">A</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">v</span><span class="main">⟩</span> <span class="main">$$</span> <span class="main">(</span><span class="skolem">i</span><span class="main">,</span><span class="skolem">j</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> mult_mat_vec_def
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">&lt;</span> <span class="free">n</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">j</span> <span class="main">=</span> <span class="main">0</span>›</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> idx <span class="main">=</span> this
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">*</span> <span class="main">|</span><span class="free">v</span><span class="main">⟩</span> <span class="main">=</span> Matrix.mat <span class="free">n</span> <span class="main">1</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">i</span><span class="main">,</span> <span class="bound">j</span><span class="main">)</span><span class="main">.</span> Matrix.scalar_prod <span class="main">(</span>Matrix.row <span class="free">A</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span>Matrix.col <span class="main">|</span><span class="free">v</span><span class="main">⟩</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> times_mat_def ket_vec_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">|</span><span class="free">A</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">v</span><span class="main">⟩</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> er ec idx rn co <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Linear_Algebra_Complements-unitary_density"><span class="command">lemma</span></span> unitary_density<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"density_operator <span class="free">R</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"unitary <span class="free">U</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">R</span><span class="main">∈</span> carrier_mat <span class="free">n</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">U</span><span class="main">∈</span> carrier_mat <span class="free">n</span> <span class="free">n</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"density_operator <span class="main">(</span><span class="free">U</span> <span class="main">*</span> <span class="free">R</span> <span class="main">*</span> <span class="main">(</span>Complex_Matrix.adjoint <span class="free">U</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> density_operator_def
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> conjI<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Complex_Matrix.positive <span class="main">(</span><span class="free">U</span> <span class="main">*</span> <span class="free">R</span> <span class="main">*</span> Complex_Matrix.adjoint <span class="free">U</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> positive_close_under_left_right_mult_adjoint<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">U</span> <span class="main">∈</span> carrier_mat <span class="free">n</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="main">∈</span> carrier_mat <span class="free">n</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Complex_Matrix.positive <span class="free">R</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> density_operator_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Complex_Matrix.trace <span class="main">(</span><span class="free">U</span> <span class="main">*</span> <span class="free">R</span> <span class="main">*</span> Complex_Matrix.adjoint <span class="free">U</span><span class="main">)</span> <span class="main">=</span> 
    Complex_Matrix.trace <span class="main">(</span>Complex_Matrix.adjoint <span class="free">U</span> <span class="main">*</span> <span class="free">U</span> <span class="main">*</span> <span class="free">R</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> trace_comm<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">U</span> <span class="main">*</span> <span class="free">R</span>"</span></span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="quoted">"Complex_Matrix.adjoint <span class="free">U</span>"</span></span><span class="main">]</span> assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> adjoint_dim  mat_assoc_test<span class="main"><span class="main">(</span></span>10<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> Complex_Matrix.trace <span class="free">R</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> 
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> density_operator_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Complex_Matrix.trace <span class="main">(</span><span class="free">U</span> <span class="main">*</span> <span class="free">R</span> <span class="main">*</span> Complex_Matrix.adjoint <span class="free">U</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Tensor product complements›</span></span>

<span class="keyword1" id="Linear_Algebra_Complements-tensor_vec_dim"><span class="command">lemma</span></span> tensor_vec_dim<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"dim_vec <span class="main">(</span>tensor_vec <span class="free">u</span> <span class="free">v</span><span class="main">)</span> <span class="main">=</span> dim_vec <span class="free">u</span> <span class="main">*</span> <span class="main">(</span>dim_vec <span class="free">v</span><span class="main">)</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>mult.vec_vec_Tensor <span class="main">(*)</span> <span class="main">(</span>list_of_vec <span class="free">u</span><span class="main">)</span> <span class="main">(</span>list_of_vec <span class="free">v</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
    length <span class="main">(</span>list_of_vec <span class="free">u</span><span class="main">)</span> <span class="main">*</span> length <span class="main">(</span>list_of_vec <span class="free">v</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span>  mult.vec_vec_Tensor_length<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">1</span><span class="main">::</span>real"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(*)</span>"</span></span> <span class="quoted"><span class="quoted">"list_of_vec <span class="free">u</span>"</span></span> <span class="quoted"><span class="quoted">"list_of_vec <span class="free">v</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Matrix_Tensor.mult_def<span class="main">)</span>  
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> tensor_vec_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Linear_Algebra_Complements-index_tensor_vec"><span class="command">lemma</span></span> index_tensor_vec<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> dim_vec <span class="free">v</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> dim_vec <span class="free">u</span> <span class="main">*</span> dim_vec <span class="free">v</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"vec_index <span class="main">(</span>tensor_vec <span class="free">u</span> <span class="free">v</span><span class="main">)</span> <span class="free">i</span> <span class="main">=</span> 
  vec_index <span class="free">u</span> <span class="main">(</span><span class="free">i</span> <span class="keyword1">div</span> <span class="main">(</span>dim_vec <span class="free">v</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> vec_index <span class="free">v</span> <span class="main">(</span><span class="free">i</span> <span class="keyword1">mod</span> dim_vec <span class="free">v</span><span class="main">)</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> m<span class="main">:</span> <span class="quoted"><span class="quoted">"Matrix_Tensor.mult <span class="main">(</span><span class="main">1</span><span class="main">::</span>complex<span class="main">)</span> <span class="main">(*)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Matrix_Tensor.mult_def<span class="main">)</span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>list_of_vec <span class="free">v</span><span class="main">)</span> <span class="main">=</span> dim_vec <span class="free">v</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"vec_index <span class="main">(</span>tensor_vec <span class="free">u</span> <span class="free">v</span><span class="main">)</span> <span class="free">i</span> <span class="main">=</span> <span class="main">(*)</span> <span class="main">(</span>vec_index <span class="free">u</span> <span class="main">(</span><span class="free">i</span> <span class="keyword1">div</span> dim_vec <span class="free">v</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>vec_index <span class="free">v</span> <span class="main">(</span><span class="free">i</span> <span class="keyword1">mod</span> dim_vec <span class="free">v</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> tensor_vec_def <span class="keyword1"><span class="command">using</span></span> mult.vec_vec_Tensor_elements assms m
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> length_greater_0_conv length_list_of_vec list_of_vec_index 
        mult.vec_vec_Tensor_elements vec_of_list_index<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Linear_Algebra_Complements-outer_prod_tensor_comm"><span class="command">lemma</span></span>  outer_prod_tensor_comm<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">a</span><span class="main">::</span><span class="quoted"><span class="quoted">"complex Matrix.vec"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">u</span><span class="main">::</span><span class="quoted"><span class="quoted">"complex Matrix.vec"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> dim_vec <span class="free">a</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> dim_vec <span class="free">b</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"outer_prod <span class="main">(</span>tensor_vec <span class="free">u</span> <span class="free">v</span><span class="main">)</span> <span class="main">(</span>tensor_vec <span class="free">a</span> <span class="free">b</span><span class="main">)</span> <span class="main">=</span> tensor_mat <span class="main">(</span>outer_prod <span class="free">u</span> <span class="free">a</span><span class="main">)</span> <span class="main">(</span>outer_prod <span class="free">v</span> <span class="free">b</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">ot</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ot</span> <span class="main">=</span> outer_prod <span class="main">(</span>tensor_vec <span class="free">u</span> <span class="free">v</span><span class="main">)</span> <span class="main">(</span>tensor_vec <span class="free">a</span> <span class="free">b</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">to</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">to</span> <span class="main">=</span> tensor_mat <span class="main">(</span>outer_prod <span class="free">u</span> <span class="free">a</span><span class="main">)</span> <span class="main">(</span>outer_prod <span class="free">v</span> <span class="free">b</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">dv</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">dv</span> <span class="main">=</span> dim_vec <span class="free">v</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">db</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">db</span> <span class="main">=</span> dim_vec <span class="free">b</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ot</span> <span class="main">=</span> <span class="skolem">to</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword1"><span class="command">have</span></span> ro<span class="main">:</span> <span class="quoted"><span class="quoted">"dim_row <span class="skolem">ot</span> <span class="main">=</span> dim_vec <span class="free">u</span> <span class="main">*</span> dim_vec <span class="free">v</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> ot_def outer_prod_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"dim_row <span class="skolem">to</span> <span class="main">=</span> dim_row <span class="main">(</span>outer_prod <span class="free">u</span> <span class="free">a</span><span class="main">)</span> <span class="main">*</span> dim_row <span class="main">(</span>outer_prod <span class="free">v</span> <span class="free">b</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">unfolding</span></span> to_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> 
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> dim_vec <span class="free">u</span> <span class="main">*</span> dim_vec <span class="free">v</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> outer_prod_dim
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> carrier_matD<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> carrier_vec_dim_vec<span class="main">)</span> 
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> rt<span class="main">:</span> <span class="quoted"><span class="quoted">"dim_row <span class="skolem">to</span> <span class="main">=</span> dim_vec <span class="free">u</span> <span class="main">*</span> dim_vec <span class="free">v</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"dim_row <span class="skolem">ot</span> <span class="main">=</span> dim_row <span class="skolem">to</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ro rt <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">have</span></span> co<span class="main">:</span> <span class="quoted"><span class="quoted">"dim_col <span class="skolem">ot</span> <span class="main">=</span> dim_vec <span class="free">a</span> <span class="main">*</span> dim_vec <span class="free">b</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> ot_def outer_prod_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"dim_col <span class="skolem">to</span> <span class="main">=</span> dim_col <span class="main">(</span>outer_prod <span class="free">u</span> <span class="free">a</span><span class="main">)</span> <span class="main">*</span> dim_col <span class="main">(</span>outer_prod <span class="free">v</span> <span class="free">b</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> to_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> dim_vec <span class="free">a</span> <span class="main">*</span> dim_vec <span class="free">b</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> outer_prod_dim
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> carrier_matD<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> carrier_vec_dim_vec<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> ct<span class="main">:</span> <span class="quoted"><span class="quoted">"dim_col <span class="skolem">to</span> <span class="main">=</span> dim_vec <span class="free">a</span> <span class="main">*</span> dim_vec <span class="free">b</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"dim_col <span class="skolem">ot</span> <span class="main">=</span> dim_col <span class="skolem">to</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> co ct <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> dim_row <span class="skolem">to</span> <span class="main">⟹</span> <span class="bound">j</span> <span class="main">&lt;</span> dim_col <span class="skolem">to</span> <span class="main">⟹</span> <span class="skolem">ot</span> <span class="main">$$</span> <span class="main">(</span><span class="bound">i</span><span class="main">,</span> <span class="bound">j</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">to</span> <span class="main">$$</span> <span class="main">(</span><span class="bound">i</span><span class="main">,</span> <span class="bound">j</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="skolem">j</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> dim_row <span class="skolem">to</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> dim_col <span class="skolem">to</span>"</span></span> <span class="keyword1"><span class="command">note</span></span> ij <span class="main">=</span> this
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ot</span> <span class="main">$$</span> <span class="main">(</span><span class="skolem">i</span><span class="main">,</span><span class="skolem">j</span><span class="main">)</span> <span class="main">=</span> Matrix.vec_index <span class="main">(</span>tensor_vec <span class="free">u</span> <span class="free">v</span><span class="main">)</span> <span class="skolem">i</span> <span class="main">*</span> 
        <span class="main">(</span>conjugate <span class="main">(</span>Matrix.vec_index <span class="main">(</span>tensor_vec <span class="free">a</span> <span class="free">b</span><span class="main">)</span> <span class="skolem">j</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> ot_def outer_prod_def <span class="keyword1"><span class="command">using</span></span> ij rt ct <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> vec_index <span class="free">u</span> <span class="main">(</span><span class="skolem">i</span> <span class="keyword1">div</span> <span class="skolem">dv</span><span class="main">)</span> <span class="main">*</span> vec_index <span class="free">v</span> <span class="main">(</span><span class="skolem">i</span> <span class="keyword1">mod</span> <span class="skolem">dv</span><span class="main">)</span>  <span class="main">*</span> 
        <span class="main">(</span>conjugate <span class="main">(</span>Matrix.vec_index <span class="main">(</span>tensor_vec <span class="free">a</span> <span class="free">b</span><span class="main">)</span> <span class="skolem">j</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ij rt assms 
        <span class="keyword1"><span class="command">unfolding</span></span> dv_def
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> index_tensor_vec less_nat_zero_code nat_0_less_mult_iff neq0_conv<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> vec_index <span class="free">u</span> <span class="main">(</span><span class="skolem">i</span> <span class="keyword1">div</span> <span class="skolem">dv</span><span class="main">)</span> <span class="main">*</span> vec_index <span class="free">v</span> <span class="main">(</span><span class="skolem">i</span> <span class="keyword1">mod</span> <span class="skolem">dv</span><span class="main">)</span>  <span class="main">*</span>
        <span class="main">(</span>conjugate <span class="main">(</span>vec_index <span class="free">a</span> <span class="main">(</span><span class="skolem">j</span> <span class="keyword1">div</span> <span class="skolem">db</span><span class="main">)</span> <span class="main">*</span> vec_index <span class="free">b</span> <span class="main">(</span><span class="skolem">j</span> <span class="keyword1">mod</span> <span class="skolem">db</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ij ct assms 
        <span class="keyword1"><span class="command">unfolding</span></span> db_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> vec_index <span class="free">u</span> <span class="main">(</span><span class="skolem">i</span> <span class="keyword1">div</span> <span class="skolem">dv</span><span class="main">)</span> <span class="main">*</span> vec_index <span class="free">v</span> <span class="main">(</span><span class="skolem">i</span> <span class="keyword1">mod</span> <span class="skolem">dv</span><span class="main">)</span>  <span class="main">*</span>
        <span class="main">(</span>conjugate <span class="main">(</span>vec_index <span class="free">a</span> <span class="main">(</span><span class="skolem">j</span> <span class="keyword1">div</span> <span class="skolem">db</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span>conjugate <span class="main">(</span>vec_index <span class="free">b</span> <span class="main">(</span><span class="skolem">j</span> <span class="keyword1">mod</span> <span class="skolem">db</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> vec_index <span class="free">u</span> <span class="main">(</span><span class="skolem">i</span> <span class="keyword1">div</span> <span class="skolem">dv</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span>conjugate <span class="main">(</span>vec_index <span class="free">a</span> <span class="main">(</span><span class="skolem">j</span> <span class="keyword1">div</span> <span class="skolem">db</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> 
        vec_index <span class="free">v</span> <span class="main">(</span><span class="skolem">i</span> <span class="keyword1">mod</span> <span class="skolem">dv</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span>conjugate <span class="main">(</span>vec_index <span class="free">b</span> <span class="main">(</span><span class="skolem">j</span> <span class="keyword1">mod</span> <span class="skolem">db</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span>outer_prod <span class="free">u</span> <span class="free">a</span><span class="main">)</span> <span class="main">$$</span> <span class="main">(</span><span class="skolem">i</span> <span class="keyword1">div</span> <span class="skolem">dv</span><span class="main">,</span> <span class="skolem">j</span> <span class="keyword1">div</span> <span class="skolem">db</span><span class="main">)</span> <span class="main">*</span> 
        vec_index <span class="free">v</span> <span class="main">(</span><span class="skolem">i</span> <span class="keyword1">mod</span> <span class="skolem">dv</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span>conjugate <span class="main">(</span>vec_index <span class="free">b</span> <span class="main">(</span><span class="skolem">j</span> <span class="keyword1">mod</span> <span class="skolem">db</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="keyword1">div</span> <span class="skolem">dv</span> <span class="main">&lt;</span> dim_vec <span class="free">u</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ij rt <span class="keyword1"><span class="command">unfolding</span></span> dv_def
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> less_mult_imp_div_less<span class="main">)</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="keyword1">div</span> <span class="skolem">db</span> <span class="main">&lt;</span> dim_vec <span class="free">a</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ij ct assms <span class="keyword1"><span class="command">unfolding</span></span> db_def
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> less_mult_imp_div_less<span class="main">)</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"vec_index <span class="free">u</span> <span class="main">(</span><span class="skolem">i</span> <span class="keyword1">div</span> <span class="skolem">dv</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span>conjugate <span class="main">(</span>vec_index <span class="free">a</span> <span class="main">(</span><span class="skolem">j</span> <span class="keyword1">div</span> <span class="skolem">db</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
          <span class="main">(</span>outer_prod <span class="free">u</span> <span class="free">a</span><span class="main">)</span> <span class="main">$$</span> <span class="main">(</span><span class="skolem">i</span> <span class="keyword1">div</span> <span class="skolem">dv</span><span class="main">,</span> <span class="skolem">j</span> <span class="keyword1">div</span> <span class="skolem">db</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> outer_prod_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span>outer_prod <span class="free">u</span> <span class="free">a</span><span class="main">)</span> <span class="main">$$</span> <span class="main">(</span><span class="skolem">i</span> <span class="keyword1">div</span> <span class="skolem">dv</span><span class="main">,</span> <span class="skolem">j</span> <span class="keyword1">div</span> <span class="skolem">db</span><span class="main">)</span> <span class="main">*</span> 
        <span class="main">(</span>outer_prod <span class="free">v</span> <span class="free">b</span><span class="main">)</span> <span class="main">$$</span> <span class="main">(</span><span class="skolem">i</span> <span class="keyword1">mod</span> <span class="skolem">dv</span><span class="main">,</span> <span class="skolem">j</span> <span class="keyword1">mod</span> <span class="skolem">db</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="keyword1">mod</span> <span class="skolem">dv</span> <span class="main">&lt;</span> dim_vec <span class="free">v</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ij rt <span class="keyword1"><span class="command">unfolding</span></span> dv_def
          <span class="keyword1"><span class="command">using</span></span> assms mod_less_divisor
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> less_nat_zero_code mult.commute neq0_conv times_nat.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="keyword1">mod</span> <span class="skolem">db</span> <span class="main">&lt;</span> dim_vec <span class="free">b</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ij ct assms <span class="keyword1"><span class="command">unfolding</span></span> db_def
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> less_mult_imp_div_less<span class="main">)</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"vec_index <span class="free">v</span> <span class="main">(</span><span class="skolem">i</span> <span class="keyword1">mod</span> <span class="skolem">dv</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span>conjugate <span class="main">(</span>vec_index <span class="free">b</span> <span class="main">(</span><span class="skolem">j</span> <span class="keyword1">mod</span> <span class="skolem">db</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
          <span class="main">(</span>outer_prod <span class="free">v</span> <span class="free">b</span><span class="main">)</span> <span class="main">$$</span> <span class="main">(</span><span class="skolem">i</span> <span class="keyword1">mod</span> <span class="skolem">dv</span><span class="main">,</span> <span class="skolem">j</span> <span class="keyword1">mod</span> <span class="skolem">db</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> outer_prod_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> tensor_mat <span class="main">(</span>outer_prod <span class="free">u</span> <span class="free">a</span><span class="main">)</span> <span class="main">(</span>outer_prod <span class="free">v</span> <span class="free">b</span><span class="main">)</span> <span class="main">$$</span> <span class="main">(</span><span class="skolem">i</span><span class="main">,</span> <span class="skolem">j</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> index_tensor_mat<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"dim_row <span class="main">(</span>outer_prod <span class="free">u</span> <span class="free">a</span><span class="main">)</span> <span class="main">=</span> dim_vec <span class="free">u</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> outer_prod_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"dim_row <span class="main">(</span>outer_prod <span class="free">v</span> <span class="free">b</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">dv</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> outer_prod_def dv_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"dim_col <span class="main">(</span>outer_prod <span class="free">v</span> <span class="free">b</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">db</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> db_def outer_prod_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> dim_vec <span class="free">u</span> <span class="main">*</span> <span class="skolem">dv</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> dv_def <span class="keyword1"><span class="command">using</span></span> ij rt <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"dim_col <span class="main">(</span>outer_prod <span class="free">u</span> <span class="free">a</span><span class="main">)</span> <span class="main">=</span> dim_vec <span class="free">a</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> outer_prod_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> dim_vec <span class="free">a</span> <span class="main">*</span> <span class="skolem">db</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> db_def <span class="keyword1"><span class="command">using</span></span> ij ct <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> dim_vec <span class="free">a</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="skolem">db</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> db_def <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ot</span> <span class="main">$$</span> <span class="main">(</span><span class="skolem">i</span><span class="main">,</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">to</span> <span class="main">$$</span> <span class="main">(</span><span class="skolem">i</span><span class="main">,</span> <span class="skolem">j</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> to_def <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> ot_def to_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Linear_Algebra_Complements-tensor_mat_adjoint"><span class="command">lemma</span></span> tensor_mat_adjoint<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">m1</span> <span class="main">∈</span> carrier_mat <span class="free">r1</span> <span class="free">c1</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">m2</span> <span class="main">∈</span> carrier_mat <span class="free">r2</span> <span class="free">c2</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="free">c1</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="free">c2</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="free">r1</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="free">r2</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Complex_Matrix.adjoint <span class="main">(</span>tensor_mat <span class="free">m1</span> <span class="free">m2</span><span class="main">)</span> <span class="main">=</span> 
  tensor_mat <span class="main">(</span>Complex_Matrix.adjoint <span class="free">m1</span><span class="main">)</span> <span class="main">(</span>Complex_Matrix.adjoint <span class="free">m2</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> eq_matI<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="skolem">j</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> dim_col <span class="free">m1</span> <span class="main">*</span> dim_col <span class="free">m2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> dim_row <span class="free">m1</span> <span class="main">*</span> dim_row <span class="free">m2</span>"</span></span> <span class="keyword1"><span class="command">note</span></span> ij <span class="main">=</span> this
  <span class="keyword1"><span class="command">have</span></span> c1<span class="main">:</span> <span class="quoted"><span class="quoted">"dim_col <span class="free">m1</span> <span class="main">=</span> <span class="free">c1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> r1<span class="main">:</span> <span class="quoted"><span class="quoted">"dim_row <span class="free">m1</span> <span class="main">=</span> <span class="free">r1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> c2<span class="main">:</span> <span class="quoted"><span class="quoted">"dim_col <span class="free">m2</span> <span class="main">=</span> <span class="free">c2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> r2<span class="main">:</span> <span class="quoted"><span class="quoted">"dim_row <span class="free">m2</span> <span class="main">=</span> <span class="free">r2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Complex_Matrix.adjoint <span class="main">(</span><span class="free">m1</span> <span class="main">⨂</span> <span class="free">m2</span><span class="main">)</span> <span class="main">$$</span> <span class="main">(</span><span class="skolem">i</span><span class="main">,</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">=</span> conjugate <span class="main">(</span><span class="main">(</span><span class="free">m1</span> <span class="main">⨂</span> <span class="free">m2</span><span class="main">)</span> <span class="main">$$</span> <span class="main">(</span><span class="skolem">j</span><span class="main">,</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span>  ij <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> adjoint_eval<span class="main">)</span> 
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> conjugate <span class="main">(</span><span class="free">m1</span> <span class="main">$$</span> <span class="main">(</span><span class="skolem">j</span> <span class="keyword1">div</span> <span class="free">r2</span><span class="main">,</span> <span class="skolem">i</span> <span class="keyword1">div</span> <span class="free">c2</span><span class="main">)</span> <span class="main">*</span> <span class="free">m2</span> <span class="main">$$</span> <span class="main">(</span><span class="skolem">j</span> <span class="keyword1">mod</span> <span class="free">r2</span><span class="main">,</span> <span class="skolem">i</span> <span class="keyword1">mod</span> <span class="free">c2</span><span class="main">)</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">m1</span> <span class="main">⨂</span> <span class="free">m2</span><span class="main">)</span> <span class="main">$$</span> <span class="main">(</span><span class="skolem">j</span><span class="main">,</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">=</span> <span class="free">m1</span> <span class="main">$$</span> <span class="main">(</span><span class="skolem">j</span> <span class="keyword1">div</span> <span class="free">r2</span><span class="main">,</span> <span class="skolem">i</span> <span class="keyword1">div</span> <span class="free">c2</span><span class="main">)</span> <span class="main">*</span> <span class="free">m2</span> <span class="main">$$</span> <span class="main">(</span><span class="skolem">j</span> <span class="keyword1">mod</span> <span class="free">r2</span><span class="main">,</span> <span class="skolem">i</span> <span class="keyword1">mod</span> <span class="free">c2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> index_tensor_mat<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">m1</span></span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">r1</span></span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">c1</span></span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">m2</span></span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">r2</span></span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">c2</span></span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">j</span></span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">i</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms ij c1 c2 r1 r2<span class="main">)</span><span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> <span class="free">r1</span> <span class="main">*</span> <span class="free">r2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ij r1 r2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> <span class="free">c1</span> <span class="main">*</span> <span class="free">c2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ij c1 c2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> conjugate <span class="main">(</span><span class="free">m1</span> <span class="main">$$</span> <span class="main">(</span><span class="skolem">j</span> <span class="keyword1">div</span> <span class="free">r2</span><span class="main">,</span> <span class="skolem">i</span> <span class="keyword1">div</span> <span class="free">c2</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> conjugate <span class="main">(</span> <span class="free">m2</span> <span class="main">$$</span> <span class="main">(</span><span class="skolem">j</span> <span class="keyword1">mod</span> <span class="free">r2</span><span class="main">,</span> <span class="skolem">i</span> <span class="keyword1">mod</span> <span class="free">c2</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span>Complex_Matrix.adjoint <span class="free">m1</span><span class="main">)</span> <span class="main">$$</span> <span class="main">(</span><span class="skolem">i</span> <span class="keyword1">div</span> <span class="free">c2</span><span class="main">,</span> <span class="skolem">j</span> <span class="keyword1">div</span> <span class="free">r2</span><span class="main">)</span> <span class="main">*</span> 
    conjugate <span class="main">(</span> <span class="free">m2</span> <span class="main">$$</span> <span class="main">(</span><span class="skolem">j</span> <span class="keyword1">mod</span> <span class="free">r2</span><span class="main">,</span> <span class="skolem">i</span> <span class="keyword1">mod</span> <span class="free">c2</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> adjoint_eval c2 ij less_mult_imp_div_less r2<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span>Complex_Matrix.adjoint <span class="free">m1</span><span class="main">)</span> <span class="main">$$</span> <span class="main">(</span><span class="skolem">i</span> <span class="keyword1">div</span> <span class="free">c2</span><span class="main">,</span> <span class="skolem">j</span> <span class="keyword1">div</span> <span class="free">r2</span><span class="main">)</span> <span class="main">*</span>
    <span class="main">(</span>Complex_Matrix.adjoint <span class="free">m2</span><span class="main">)</span> <span class="main">$$</span> <span class="main">(</span><span class="skolem">i</span> <span class="keyword1">mod</span> <span class="free">c2</span><span class="main">,</span> <span class="skolem">j</span> <span class="keyword1">mod</span> <span class="free">r2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Euclidean_Division.div_eq_0_iff adjoint_eval assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> bits_mod_div_trivial c2 
        gr_implies_not_zero ij<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> mult_not_zero r2<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span>tensor_mat <span class="main">(</span>Complex_Matrix.adjoint <span class="free">m1</span><span class="main">)</span> <span class="main">(</span>Complex_Matrix.adjoint <span class="free">m2</span><span class="main">)</span><span class="main">)</span> <span class="main">$$</span> <span class="main">(</span><span class="skolem">i</span><span class="main">,</span><span class="skolem">j</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> index_tensor_mat<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ij c1 c2 r1 r2<span class="main">)</span> <span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> <span class="free">c1</span> <span class="main">*</span> <span class="free">c2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ij c1 c2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> <span class="free">r1</span> <span class="main">*</span> <span class="free">r2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ij r1 r2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="free">r1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="free">r2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Complex_Matrix.adjoint <span class="main">(</span><span class="free">m1</span> <span class="main">⨂</span> <span class="free">m2</span><span class="main">)</span> <span class="main">$$</span> <span class="main">(</span><span class="skolem">i</span><span class="main">,</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">=</span>
           <span class="main">(</span>Complex_Matrix.adjoint <span class="free">m1</span> <span class="main">⨂</span> Complex_Matrix.adjoint <span class="free">m2</span><span class="main">)</span> <span class="main">$$</span> <span class="main">(</span><span class="skolem">i</span><span class="main">,</span> <span class="skolem">j</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Linear_Algebra_Complements-index_tensor_mat'"><span class="command">lemma</span></span> index_tensor_mat'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> dim_col <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> dim_col <span class="free">B</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> dim_row <span class="free">A</span> <span class="main">*</span> dim_row <span class="free">B</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">&lt;</span> dim_col <span class="free">A</span> <span class="main">*</span> dim_col <span class="free">B</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">A</span> <span class="main">⨂</span> <span class="free">B</span><span class="main">)</span> <span class="main">$$</span> <span class="main">(</span><span class="free">i</span><span class="main">,</span> <span class="free">j</span><span class="main">)</span> <span class="main">=</span> 
    <span class="free">A</span> <span class="main">$$</span> <span class="main">(</span><span class="free">i</span> <span class="keyword1">div</span> <span class="main">(</span>dim_row <span class="free">B</span><span class="main">)</span><span class="main">,</span> <span class="free">j</span> <span class="keyword1">div</span> <span class="main">(</span>dim_col <span class="free">B</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="free">B</span> <span class="main">$$</span> <span class="main">(</span><span class="free">i</span> <span class="keyword1">mod</span> <span class="main">(</span>dim_row <span class="free">B</span><span class="main">)</span><span class="main">,</span> <span class="free">j</span> <span class="keyword1">mod</span> <span class="main">(</span>dim_col <span class="free">B</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> index_tensor_mat<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>

<span class="keyword1" id="Linear_Algebra_Complements-tensor_mat_carrier"><span class="command">lemma</span></span> tensor_mat_carrier<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"tensor_mat <span class="free">U</span> <span class="free">V</span> <span class="main">∈</span> carrier_mat <span class="main">(</span>dim_row <span class="free">U</span> <span class="main">*</span> dim_row <span class="free">V</span><span class="main">)</span> <span class="main">(</span>dim_col <span class="free">U</span> <span class="main">*</span> dim_col <span class="free">V</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Linear_Algebra_Complements-tensor_mat_id"><span class="command">lemma</span></span> tensor_mat_id<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="free">d1</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="free">d2</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"tensor_mat <span class="main">(</span><span class="keyword1">1<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">d1</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">1<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">d2</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">1<span class="hidden">⇩</span><sub>m</sub></span> <span class="main">(</span><span class="free">d1</span> <span class="main">*</span> <span class="free">d2</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> eq_matI<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"tensor_mat <span class="main">(</span><span class="keyword1">1<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">d1</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">1<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">d2</span><span class="main">)</span> <span class="main">$$</span> <span class="main">(</span><span class="skolem">i</span><span class="main">,</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> <span class="main">(</span><span class="free">d1</span> <span class="main">*</span> <span class="free">d2</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span>
    <span class="keyword1"><span class="command">using</span></span> that index_tensor_mat'<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="keyword1">1<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">d1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">1<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">d2</span>"</span></span><span class="main">]</span>   
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms less_mult_imp_div_less<span class="main">)</span>  
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"tensor_mat <span class="main">(</span><span class="keyword1">1<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">d1</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">1<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">d2</span><span class="main">)</span> <span class="main">$$</span> <span class="main">(</span><span class="skolem">i</span><span class="main">,</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> <span class="free">d1</span> <span class="main">*</span> <span class="free">d2</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> <span class="free">d1</span> <span class="main">*</span> <span class="free">d2</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">≠</span> <span class="skolem">j</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span> <span class="skolem">j</span>
    <span class="keyword1"><span class="command">using</span></span> that index_tensor_mat<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="keyword1">1<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">d1</span>"</span></span> <span class="quoted"><span class="free">d1</span></span> <span class="quoted"><span class="free">d1</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">1<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">d2</span>"</span></span> <span class="quoted"><span class="free">d2</span></span> <span class="quoted"><span class="free">d2</span></span> <span class="quoted"><span class="skolem">i</span></span> <span class="quoted"><span class="skolem">j</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> index_one_mat<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> index_one_mat<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> index_one_mat<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> 
        less_mult_imp_div_less mod_less_divisor mult_div_mod_eq mult_not_zero<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Linear_Algebra_Complements-tensor_mat_hermitian"><span class="command">lemma</span></span> tensor_mat_hermitian<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">∈</span> carrier_mat <span class="free">n</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">B</span> <span class="main">∈</span> carrier_mat <span class="free">n'</span> <span class="free">n'</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="free">n'</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"hermitian <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"hermitian <span class="free">B</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"hermitian <span class="main">(</span>tensor_mat <span class="free">A</span> <span class="free">B</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> hermitian_def tensor_mat_adjoint<span class="main">)</span>

<span class="keyword1" id="Linear_Algebra_Complements-tensor_mat_unitary"><span class="command">lemma</span></span>  tensor_mat_unitary<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"Complex_Matrix.unitary <span class="free">U</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"Complex_Matrix.unitary <span class="free">V</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> dim_row <span class="free">U</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> dim_row <span class="free">V</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Complex_Matrix.unitary <span class="main">(</span>tensor_mat <span class="free">U</span> <span class="free">V</span><span class="main">)</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">UI</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">UI</span> <span class="main">=</span> tensor_mat <span class="free">U</span> <span class="free">V</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Complex_Matrix.adjoint <span class="skolem">UI</span> <span class="main">=</span> 
    tensor_mat <span class="main">(</span>Complex_Matrix.adjoint <span class="free">U</span><span class="main">)</span> <span class="main">(</span>Complex_Matrix.adjoint <span class="free">V</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> UI_def
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> tensor_mat_adjoint<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">U</span> <span class="main">∈</span> carrier_mat <span class="main">(</span>dim_row <span class="free">U</span><span class="main">)</span> <span class="main">(</span>dim_row <span class="free">U</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> Complex_Matrix.unitary_def 
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">V</span> <span class="main">∈</span> carrier_mat <span class="main">(</span>dim_row <span class="free">V</span><span class="main">)</span> <span class="main">(</span>dim_row <span class="free">V</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> Complex_Matrix.unitary_def 
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> dim_row <span class="free">V</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> dim_row <span class="free">U</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> dim_row <span class="free">V</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> dim_row <span class="free">U</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">UI</span> <span class="main">*</span> <span class="main">(</span>Complex_Matrix.adjoint <span class="skolem">UI</span><span class="main">)</span> <span class="main">=</span> 
    tensor_mat <span class="main">(</span><span class="free">U</span> <span class="main">*</span> Complex_Matrix.adjoint <span class="free">U</span><span class="main">)</span> <span class="main">(</span><span class="free">V</span> <span class="main">*</span> Complex_Matrix.adjoint <span class="free">V</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> mult_distr_tensor<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">U</span></span> <span class="quoted"><span class="quoted">"Complex_Matrix.adjoint <span class="free">U</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">V</span>"</span></span> <span class="quoted"><span class="quoted">"Complex_Matrix.adjoint <span class="free">V</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">unfolding</span></span> UI_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> Complex_Matrix.unitary_def adjoint_dim_col adjoint_dim_row 
        assms carrier_matD<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> <span class="main">)</span>    
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> tensor_mat <span class="main">(</span><span class="keyword1">1<span class="hidden">⇩</span><sub>m</sub></span> <span class="main">(</span>dim_row <span class="free">U</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">1<span class="hidden">⇩</span><sub>m</sub></span> <span class="main">(</span>dim_row <span class="free">V</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms unitary_simps<span class="main">(</span>2<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Complex_Matrix.unitary_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">1<span class="hidden">⇩</span><sub>m</sub></span> <span class="main">(</span>dim_row <span class="free">U</span> <span class="main">*</span> dim_row <span class="free">V</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> tensor_mat_id assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">UI</span> <span class="main">*</span> <span class="main">(</span>Complex_Matrix.adjoint <span class="skolem">UI</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">1<span class="hidden">⇩</span><sub>m</sub></span> <span class="main">(</span>dim_row <span class="free">U</span> <span class="main">*</span> dim_row <span class="free">V</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"inverts_mat <span class="skolem">UI</span> <span class="main">(</span>Complex_Matrix.adjoint <span class="skolem">UI</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> inverts_mat_def UI_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> Complex_Matrix.unitary_def UI_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> carrier_matD<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> carrier_matI dim_col_tensor_mat dim_row_tensor_mat<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Fixed carrier matrices locale›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We define a locale for matrices with a fixed number of rows and columns, and define a
finite sum operation on this locale. The \verb+Type_To_Sets+ transfer tools then permits to obtain
lemmata on the locale for free. ›</span></span>

<span class="keyword1"><span class="command">locale</span></span> fixed_carrier_mat <span class="main">=</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">fc_mats</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>field Matrix.mat set"</span></span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">dimR</span> <span class="free">dimC</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> fc_mats_carrier<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">fc_mats</span> <span class="main">=</span> carrier_mat <span class="free">dimR</span> <span class="free">dimC</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">sublocale</span></span> semigroup_add_on_with <span class="quoted"><span class="free">fc_mats</span></span> <span class="quoted"><span class="quoted">"<span class="main">(+)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> <span class="bound">a</span> <span class="main">∈</span> <span class="free">fc_mats</span> <span class="main">⟹</span> <span class="bound">b</span> <span class="main">∈</span> <span class="free">fc_mats</span> <span class="main">⟹</span> <span class="bound">a</span> <span class="main">+</span> <span class="bound">b</span> <span class="main">∈</span> <span class="free">fc_mats</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> fc_mats_carrier <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">a</span> <span class="bound">b</span> <span class="bound">c</span><span class="main">.</span> <span class="bound">a</span> <span class="main">∈</span> <span class="free">fc_mats</span> <span class="main">⟹</span> <span class="bound">b</span> <span class="main">∈</span> <span class="free">fc_mats</span> <span class="main">⟹</span> <span class="bound">c</span> <span class="main">∈</span> <span class="free">fc_mats</span> <span class="main">⟹</span> <span class="bound">a</span> <span class="main">+</span> <span class="bound">b</span> <span class="main">+</span> <span class="bound">c</span> <span class="main">=</span> <span class="bound">a</span> <span class="main">+</span> <span class="main">(</span><span class="bound">b</span> <span class="main">+</span> <span class="bound">c</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> fc_mats_carrier <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">sublocale</span></span> ab_semigroup_add_on_with <span class="quoted"><span class="free">fc_mats</span></span> <span class="quoted"><span class="quoted">"<span class="main">(+)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> <span class="bound">a</span> <span class="main">∈</span> <span class="free">fc_mats</span> <span class="main">⟹</span> <span class="bound">b</span> <span class="main">∈</span> <span class="free">fc_mats</span> <span class="main">⟹</span> <span class="bound">a</span> <span class="main">+</span> <span class="bound">b</span> <span class="main">=</span> <span class="bound">b</span> <span class="main">+</span> <span class="bound">a</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> fc_mats_carrier 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> comm_add_mat<span class="main">)</span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">sublocale</span></span> comm_monoid_add_on_with <span class="quoted"><span class="free">fc_mats</span></span> <span class="quoted"><span class="quoted">"<span class="main">(+)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">0<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">dimR</span> <span class="free">dimC</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">0<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">dimR</span> <span class="free">dimC</span> <span class="main">∈</span> <span class="free">fc_mats</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> fc_mats_carrier <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">a</span><span class="main">.</span> <span class="bound">a</span> <span class="main">∈</span> <span class="free">fc_mats</span> <span class="main">⟹</span> <span class="keyword1">0<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">dimR</span> <span class="free">dimC</span> <span class="main">+</span> <span class="bound">a</span> <span class="main">=</span> <span class="bound">a</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> fc_mats_carrier <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">sublocale</span></span> ab_group_add_on_with <span class="quoted"><span class="free">fc_mats</span></span> <span class="quoted"><span class="quoted">"<span class="main">(+)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">0<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">dimR</span> <span class="free">dimC</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(-)</span>"</span></span> <span class="quoted"><span class="quoted">"uminus"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">a</span><span class="main">.</span> <span class="bound">a</span> <span class="main">∈</span> <span class="free">fc_mats</span> <span class="main">⟹</span> <span class="main">-</span> <span class="bound">a</span> <span class="main">+</span> <span class="bound">a</span> <span class="main">=</span> <span class="keyword1">0<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">dimR</span> <span class="free">dimC</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> fc_mats_carrier <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> <span class="bound">a</span> <span class="main">∈</span> <span class="free">fc_mats</span> <span class="main">⟹</span> <span class="bound">b</span> <span class="main">∈</span> <span class="free">fc_mats</span> <span class="main">⟹</span> <span class="bound">a</span> <span class="main">-</span> <span class="bound">b</span> <span class="main">=</span> <span class="bound">a</span> <span class="main">+</span> <span class="main">-</span> <span class="bound">b</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> fc_mats_carrier
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> add_uminus_minus_mat<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">a</span><span class="main">.</span> <span class="bound">a</span> <span class="main">∈</span> <span class="free">fc_mats</span> <span class="main">⟹</span> <span class="main">-</span> <span class="bound">a</span> <span class="main">∈</span> <span class="free">fc_mats</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> fc_mats_carrier <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> fixed_carrier_mat<span class="main">)</span> smult_mem<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">∈</span> <span class="free">fc_mats</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">A</span> <span class="main">∈</span> <span class="free">fc_mats</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> fc_mats_carrier assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> fixed_carrier_mat<span class="main">)</span> <span class="entity">sum_mat</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">sum_mat</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="main">=</span> sum_with <span class="main">(+)</span> <span class="main">(</span><span class="keyword1">0<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">dimR</span> <span class="free">dimC</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> fixed_carrier_mat<span class="main">)</span> sum_mat_empty<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sum_mat <span class="free">A</span> <span class="main">{}</span> <span class="main">=</span> <span class="keyword1">0<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">dimR</span> <span class="free">dimC</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> sum_mat_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> fixed_carrier_mat<span class="main">)</span> sum_mat_carrier<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∈</span> <span class="free">I</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">A</span> <span class="bound">i</span><span class="main">)</span><span class="main">∈</span> <span class="free">fc_mats</span><span class="main">)</span> <span class="main">⟹</span> sum_mat <span class="free">A</span> <span class="free">I</span> <span class="main">∈</span> carrier_mat <span class="free">dimR</span> <span class="free">dimC</span>"</span></span> 
  <span class="keyword1"><span class="command">unfolding</span></span> sum_mat_def <span class="keyword1"><span class="command">using</span></span> sum_with_mem<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">A</span></span> <span class="quoted"><span class="free">I</span></span><span class="main">]</span> fc_mats_carrier <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> fixed_carrier_mat<span class="main">)</span> sum_mat_insert<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="free">x</span> <span class="main">∈</span> <span class="free">fc_mats</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">`</span> <span class="free">I</span> <span class="main">⊆</span> <span class="free">fc_mats</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">I</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> <span class="free">I</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sum_mat <span class="free">A</span> <span class="main">(</span>insert <span class="free">x</span> <span class="free">I</span><span class="main">)</span> <span class="main">=</span> <span class="free">A</span> <span class="free">x</span> <span class="main">+</span> sum_mat <span class="free">A</span> <span class="free">I</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> sum_mat_def
  <span class="keyword1"><span class="command">using</span></span> assms sum_with_insert<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">A</span></span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">I</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹A locale for square matrices›</span></span>

<span class="keyword1"><span class="command">locale</span></span> cpx_sq_mat <span class="main">=</span> fixed_carrier_mat <span class="quoted"><span class="quoted">"<span class="free">fc_mats</span><span class="main">::</span>complex Matrix.mat set"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">fc_mats</span> <span class="main">+</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> dim_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">dimR</span> <span class="main">=</span> <span class="free">dimC</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> npos<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="free">dimR</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> cpx_sq_mat<span class="main">)</span> one_mem<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">1<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">dimR</span> <span class="main">∈</span> <span class="free">fc_mats</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> fc_mats_carrier dim_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> cpx_sq_mat<span class="main">)</span> square_mats<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">∈</span> <span class="free">fc_mats</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"square_mat <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> fc_mats_carrier dim_eq assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> cpx_sq_mat<span class="main">)</span> cpx_sq_mat_mult<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">∈</span> <span class="free">fc_mats</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">B</span> <span class="main">∈</span> <span class="free">fc_mats</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">*</span> <span class="free">B</span> <span class="main">∈</span> <span class="free">fc_mats</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"dim_row <span class="main">(</span><span class="free">A</span> <span class="main">*</span> <span class="free">B</span><span class="main">)</span> <span class="main">=</span> <span class="free">dimR</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms fc_mats_carrier <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"dim_col <span class="main">(</span><span class="free">A</span> <span class="main">*</span> <span class="free">B</span><span class="main">)</span> <span class="main">=</span> <span class="free">dimR</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms fc_mats_carrier dim_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> fc_mats_carrier carrier_mat_def dim_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> cpx_sq_mat<span class="main">)</span> sum_mat_distrib_left<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">I</span> <span class="main">⟹</span> <span class="free">R</span><span class="main">∈</span> <span class="free">fc_mats</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∈</span> <span class="free">I</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">A</span> <span class="bound">i</span><span class="main">)</span><span class="main">∈</span> <span class="free">fc_mats</span><span class="main">)</span> <span class="main">⟹</span> 
    sum_mat <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="free">R</span> <span class="main">*</span> <span class="main">(</span><span class="free">A</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="free">I</span> <span class="main">=</span> <span class="free">R</span> <span class="main">*</span> <span class="main">(</span>sum_mat <span class="free">A</span> <span class="free">I</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> finite_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> empty
  <span class="keyword1"><span class="command">hence</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"sum_mat <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="free">R</span> <span class="main">*</span> <span class="main">(</span><span class="free">A</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">{}</span> <span class="main">=</span> <span class="keyword1">0<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">dimR</span> <span class="free">dimC</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> sum_mat_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sum_mat <span class="free">A</span> <span class="main">{}</span> <span class="main">=</span> <span class="keyword1">0<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">dimR</span> <span class="free">dimC</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> sum_mat_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="main">*</span> <span class="main">(</span>sum_mat <span class="free">A</span> <span class="main">{}</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">0<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">dimR</span> <span class="free">dimC</span>"</span></span> <span class="keyword1"><span class="command">using</span></span>  fc_mats_carrier
      right_mult_zero_mat<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">R</span></span> <span class="quoted"><span class="free">dimR</span></span> <span class="quoted"><span class="free">dimC</span></span> <span class="quoted"><span class="free">dimC</span></span><span class="main">]</span> empty dim_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> a <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>insert <span class="skolem">x</span> <span class="skolem">F</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"sum_mat <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="free">R</span> <span class="main">*</span> <span class="free">A</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span>insert <span class="skolem">x</span> <span class="skolem">F</span><span class="main">)</span> <span class="main">=</span> <span class="free">R</span> <span class="main">*</span> <span class="main">(</span><span class="free">A</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">+</span> sum_mat <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="free">R</span> <span class="main">*</span> <span class="free">A</span> <span class="bound">i</span><span class="main">)</span> <span class="skolem">F</span>"</span></span>  
    <span class="keyword1"><span class="command">using</span></span> sum_mat_insert<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="free">R</span> <span class="main">*</span> <span class="free">A</span> <span class="bound">i</span>"</span></span> <span class="quoted"><span class="skolem">x</span></span> <span class="quoted"><span class="skolem">F</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> image_subsetI fc_mats_carrier dim_eq<span class="main">)</span> 
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="free">R</span> <span class="main">*</span> <span class="main">(</span><span class="free">A</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">+</span> <span class="free">R</span> <span class="main">*</span> <span class="main">(</span>sum_mat <span class="free">A</span> <span class="skolem">F</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> insert <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="free">R</span> <span class="main">*</span> <span class="main">(</span><span class="free">A</span> <span class="skolem">x</span> <span class="main">+</span> <span class="main">(</span>sum_mat <span class="free">A</span> <span class="skolem">F</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> dim_eq fc_mats_carrier insert.prems<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> insert.prems<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> insertCI mult_add_distrib_mat 
        sum_mat_carrier<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="free">R</span> <span class="main">*</span> sum_mat <span class="free">A</span> <span class="main">(</span>insert <span class="skolem">x</span> <span class="skolem">F</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="skolem">x</span> <span class="main">+</span> <span class="main">(</span>sum_mat <span class="free">A</span> <span class="skolem">F</span><span class="main">)</span> <span class="main">=</span> sum_mat <span class="free">A</span> <span class="main">(</span>insert <span class="skolem">x</span> <span class="skolem">F</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sum_mat_insert<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> insert<span class="main">)</span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> cpx_sq_mat<span class="main">)</span> sum_mat_distrib_right<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">I</span> <span class="main">⟹</span> <span class="free">R</span><span class="main">∈</span> <span class="free">fc_mats</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∈</span> <span class="free">I</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">A</span> <span class="bound">i</span><span class="main">)</span><span class="main">∈</span> <span class="free">fc_mats</span><span class="main">)</span> <span class="main">⟹</span> 
    sum_mat <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="main">(</span><span class="free">A</span> <span class="bound">i</span><span class="main">)</span> <span class="main">*</span> <span class="free">R</span><span class="main">)</span> <span class="free">I</span> <span class="main">=</span> <span class="main">(</span>sum_mat <span class="free">A</span> <span class="free">I</span><span class="main">)</span> <span class="main">*</span> <span class="free">R</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> finite_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> empty
  <span class="keyword1"><span class="command">hence</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"sum_mat <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="main">(</span><span class="free">A</span> <span class="bound">i</span><span class="main">)</span> <span class="main">*</span> <span class="free">R</span><span class="main">)</span> <span class="main">{}</span> <span class="main">=</span> <span class="keyword1">0<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">dimR</span> <span class="free">dimC</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> sum_mat_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sum_mat <span class="free">A</span> <span class="main">{}</span> <span class="main">=</span> <span class="keyword1">0<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">dimR</span> <span class="free">dimC</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> sum_mat_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>sum_mat <span class="free">A</span> <span class="main">{}</span><span class="main">)</span> <span class="main">*</span> <span class="free">R</span> <span class="main">=</span> <span class="keyword1">0<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">dimR</span> <span class="free">dimC</span>"</span></span> <span class="keyword1"><span class="command">using</span></span>  fc_mats_carrier right_mult_zero_mat<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">R</span></span> <span class="main">]</span> 
      dim_eq empty <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> a <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>insert <span class="skolem">x</span> <span class="skolem">F</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="free">A</span> <span class="bound">i</span> <span class="main">*</span> <span class="free">R</span><span class="main">)</span> <span class="main">`</span> <span class="skolem">F</span> <span class="main">⊆</span> <span class="free">fc_mats</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> insert cpx_sq_mat_mult
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> image_subsetI<span class="main">)</span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="skolem">x</span> <span class="main">*</span> <span class="free">R</span> <span class="main">∈</span> <span class="free">fc_mats</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> insert 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> insertI1 local.fc_mats_carrier mult_carrier_mat dim_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"sum_mat <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="free">A</span> <span class="bound">i</span> <span class="main">*</span> <span class="free">R</span><span class="main">)</span> <span class="main">(</span>insert <span class="skolem">x</span> <span class="skolem">F</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">A</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">*</span> <span class="free">R</span> <span class="main">+</span> sum_mat <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="free">A</span> <span class="bound">i</span> <span class="main">*</span> <span class="free">R</span><span class="main">)</span> <span class="skolem">F</span>"</span></span>  <span class="keyword1"><span class="command">using</span></span> insert a
    <span class="keyword1"><span class="command">using</span></span> sum_mat_insert<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="free">A</span> <span class="bound">i</span> <span class="main">*</span> <span class="free">R</span>"</span></span> <span class="quoted"><span class="skolem">x</span></span> <span class="quoted"><span class="skolem">F</span></span><span class="main">]</span>  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> image_subsetI local.fc_mats_carrier<span class="main">)</span> 
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="free">A</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">*</span> <span class="free">R</span> <span class="main">+</span> <span class="main">(</span>sum_mat <span class="free">A</span> <span class="skolem">F</span><span class="main">)</span> <span class="main">*</span> <span class="free">R</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> insert <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="free">A</span> <span class="skolem">x</span> <span class="main">+</span> <span class="main">(</span>sum_mat <span class="free">A</span> <span class="skolem">F</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="free">R</span>"</span></span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> add_mult_distrib_mat<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="skolem">x</span> <span class="main">∈</span> carrier_mat <span class="free">dimR</span> <span class="free">dimC</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> insert fc_mats_carrier <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"sum_mat <span class="free">A</span> <span class="skolem">F</span> <span class="main">∈</span> carrier_mat <span class="free">dimR</span> <span class="free">dimC</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> insert fc_mats_carrier sum_mat_carrier <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="main">∈</span> carrier_mat <span class="free">dimC</span> <span class="free">dimC</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> insert fc_mats_carrier dim_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>    
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> sum_mat <span class="free">A</span> <span class="main">(</span>insert <span class="skolem">x</span> <span class="skolem">F</span><span class="main">)</span> <span class="main">*</span> <span class="free">R</span>"</span></span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="skolem">x</span> <span class="main">+</span> <span class="main">(</span>sum_mat <span class="free">A</span> <span class="skolem">F</span><span class="main">)</span> <span class="main">=</span> sum_mat <span class="free">A</span> <span class="main">(</span>insert <span class="skolem">x</span> <span class="skolem">F</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sum_mat_insert<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> insert<span class="main">)</span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> cpx_sq_mat<span class="main">)</span>  trace_sum_mat<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'b</span> <span class="main">⇒</span> complex Matrix.mat"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">I</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∈</span> <span class="free">I</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">A</span> <span class="bound">i</span><span class="main">)</span><span class="main">∈</span> <span class="free">fc_mats</span><span class="main">)</span> <span class="main">⟹</span>
  Complex_Matrix.trace <span class="main">(</span>sum_mat <span class="free">A</span> <span class="free">I</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span> <span class="bound">i</span><span class="main">∈</span> <span class="free">I</span><span class="main">.</span> Complex_Matrix.trace <span class="main">(</span><span class="free">A</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> sum_mat_def
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> finite_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> empty
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> trace_zero dim_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>insert <span class="skolem">x</span> <span class="skolem">F</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Complex_Matrix.trace <span class="main">(</span>sum_with <span class="main">(+)</span> <span class="main">(</span><span class="keyword1">0<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">dimR</span> <span class="free">dimC</span><span class="main">)</span> <span class="free">A</span> <span class="main">(</span>insert <span class="skolem">x</span> <span class="skolem">F</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
    Complex_Matrix.trace <span class="main">(</span><span class="free">A</span> <span class="skolem">x</span> <span class="main">+</span> sum_with <span class="main">(+)</span> <span class="main">(</span><span class="keyword1">0<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">dimR</span> <span class="free">dimC</span><span class="main">)</span> <span class="free">A</span> <span class="skolem">F</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> sum_with_insert<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">A</span></span> <span class="quoted"><span class="skolem">x</span></span> <span class="quoted"><span class="skolem">F</span></span><span class="main">]</span> insert <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> image_subset_iff dim_eq<span class="main">)</span> 
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> Complex_Matrix.trace <span class="main">(</span><span class="free">A</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">+</span> 
    Complex_Matrix.trace <span class="main">(</span>sum_with <span class="main">(+)</span> <span class="main">(</span><span class="keyword1">0<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">dimR</span> <span class="free">dimC</span><span class="main">)</span> <span class="free">A</span> <span class="skolem">F</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> trace_add square_mats insert 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> carrier_matD<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> fc_mats_carrier image_subset_iff insert_iff sum_with_mem<span class="main">)</span> 
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> Complex_Matrix.trace <span class="main">(</span><span class="free">A</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="main">∑</span> <span class="bound">i</span><span class="main">∈</span> <span class="skolem">F</span><span class="main">.</span> Complex_Matrix.trace <span class="main">(</span><span class="free">A</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> insert <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span> <span class="bound">i</span><span class="main">∈</span> <span class="main">(</span>insert <span class="skolem">x</span> <span class="skolem">F</span><span class="main">)</span><span class="main">.</span> Complex_Matrix.trace <span class="main">(</span><span class="free">A</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> sum_with_insert<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">A</span></span> <span class="quoted"><span class="skolem">x</span></span> <span class="quoted"><span class="skolem">F</span></span><span class="main">]</span> insert <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> image_subset_iff<span class="main">)</span> 
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> cpx_sq_mat<span class="main">)</span> cpx_sq_mat_smult<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">∈</span> <span class="free">fc_mats</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span>  <span class="keyword1">⋅<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">A</span> <span class="main">∈</span> <span class="free">fc_mats</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms fc_mats_carrier <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> cpx_sq_mat<span class="main">)</span> mult_add_distrib_right<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span><span class="main">∈</span> <span class="free">fc_mats</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">B</span><span class="main">∈</span> <span class="free">fc_mats</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">C</span><span class="main">∈</span> <span class="free">fc_mats</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">*</span> <span class="main">(</span><span class="free">B</span> <span class="main">+</span> <span class="free">C</span><span class="main">)</span> <span class="main">=</span> <span class="free">A</span> <span class="main">*</span> <span class="free">B</span> <span class="main">+</span> <span class="free">A</span> <span class="main">*</span> <span class="free">C</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms fc_mats_carrier mult_add_distrib_mat dim_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> cpx_sq_mat<span class="main">)</span> mult_add_distrib_left<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span><span class="main">∈</span> <span class="free">fc_mats</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">B</span><span class="main">∈</span> <span class="free">fc_mats</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">C</span><span class="main">∈</span> <span class="free">fc_mats</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">B</span> <span class="main">+</span> <span class="free">C</span><span class="main">)</span> <span class="main">*</span> <span class="free">A</span> <span class="main">=</span> <span class="free">B</span> <span class="main">*</span> <span class="free">A</span> <span class="main">+</span> <span class="free">C</span> <span class="main">*</span> <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms fc_mats_carrier add_mult_distrib_mat dim_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> cpx_sq_mat<span class="main">)</span>  mult_sum_mat_distrib_left<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">I</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∈</span> <span class="free">I</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">A</span> <span class="bound">i</span><span class="main">)</span><span class="main">∈</span> <span class="free">fc_mats</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">B</span> <span class="main">∈</span> <span class="free">fc_mats</span> <span class="main">⟹</span>
  <span class="main">(</span>sum_mat <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="free">B</span> <span class="main">*</span> <span class="main">(</span><span class="free">A</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="free">I</span><span class="main">)</span> <span class="main">=</span> <span class="free">B</span> <span class="main">*</span> <span class="main">(</span>sum_mat <span class="free">A</span> <span class="free">I</span><span class="main">)</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> finite_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> empty
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"sum_mat <span class="free">A</span> <span class="main">{}</span> <span class="main">=</span> <span class="keyword1">0<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">dimR</span> <span class="free">dimC</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> sum_mat_empty <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">B</span> <span class="main">*</span> <span class="main">(</span>sum_mat <span class="free">A</span> <span class="main">{}</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">0<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">dimR</span> <span class="free">dimC</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> empty <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fc_mats_carrier dim_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sum_mat <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="free">B</span> <span class="main">*</span> <span class="main">(</span><span class="free">A</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">{}</span> <span class="main">=</span> <span class="keyword1">0<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">dimR</span> <span class="free">dimC</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> sum_mat_empty<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="free">B</span> <span class="main">*</span> <span class="main">(</span><span class="free">A</span> <span class="bound">i</span><span class="main">)</span>"</span></span><span class="main">]</span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>insert <span class="skolem">x</span> <span class="skolem">F</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sum_mat <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="free">B</span> <span class="main">*</span> <span class="main">(</span><span class="free">A</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>insert <span class="skolem">x</span> <span class="skolem">F</span><span class="main">)</span> <span class="main">=</span> <span class="free">B</span> <span class="main">*</span> <span class="main">(</span><span class="free">A</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">+</span> sum_mat <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="free">B</span> <span class="main">*</span> <span class="main">(</span><span class="free">A</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="skolem">F</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> sum_with_insert<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="free">B</span> <span class="main">*</span> <span class="main">(</span><span class="free">A</span> <span class="bound">i</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="skolem">x</span></span> <span class="quoted"><span class="skolem">F</span></span><span class="main">]</span> insert
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> image_subset_iff local.sum_mat_def cpx_sq_mat_mult<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="free">B</span> <span class="main">*</span> <span class="main">(</span><span class="free">A</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">+</span> <span class="free">B</span> <span class="main">*</span> <span class="main">(</span>sum_mat <span class="free">A</span> <span class="skolem">F</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> insert <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="free">B</span> <span class="main">*</span> <span class="main">(</span><span class="free">A</span> <span class="skolem">x</span> <span class="main">+</span> <span class="main">(</span>sum_mat <span class="free">A</span> <span class="skolem">F</span><span class="main">)</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> mult_add_distrib_right<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">B</span><span class="main">∈</span> <span class="free">fc_mats</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> insert <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="skolem">x</span> <span class="main">∈</span> <span class="free">fc_mats</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> insert <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"sum_mat <span class="free">A</span> <span class="skolem">F</span> <span class="main">∈</span> <span class="free">fc_mats</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> insert <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fc_mats_carrier sum_mat_carrier<span class="main">)</span> 
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="free">B</span> <span class="main">*</span> <span class="main">(</span>sum_mat <span class="free">A</span> <span class="main">(</span>insert <span class="skolem">x</span> <span class="skolem">F</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> sum_with_insert<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">A</span></span> <span class="quoted"><span class="skolem">x</span></span> <span class="quoted"><span class="skolem">F</span></span><span class="main">]</span> insert 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> image_subset_iff sum_mat_def<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> cpx_sq_mat<span class="main">)</span>  mult_sum_mat_distrib_right<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">I</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∈</span> <span class="free">I</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">A</span> <span class="bound">i</span><span class="main">)</span><span class="main">∈</span> <span class="free">fc_mats</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">B</span> <span class="main">∈</span> <span class="free">fc_mats</span> <span class="main">⟹</span>
  <span class="main">(</span>sum_mat <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="main">(</span><span class="free">A</span> <span class="bound">i</span><span class="main">)</span> <span class="main">*</span> <span class="free">B</span><span class="main">)</span> <span class="free">I</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>sum_mat <span class="free">A</span> <span class="free">I</span><span class="main">)</span> <span class="main">*</span> <span class="free">B</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> finite_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> empty
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"sum_mat <span class="free">A</span> <span class="main">{}</span> <span class="main">=</span> <span class="keyword1">0<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">dimR</span> <span class="free">dimC</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> sum_mat_empty <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>sum_mat <span class="free">A</span> <span class="main">{}</span><span class="main">)</span> <span class="main">*</span> <span class="free">B</span> <span class="main">=</span> <span class="keyword1">0<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">dimR</span> <span class="free">dimC</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> empty <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fc_mats_carrier dim_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sum_mat <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="main">(</span><span class="free">A</span> <span class="bound">i</span><span class="main">)</span> <span class="main">*</span> <span class="free">B</span><span class="main">)</span> <span class="main">{}</span> <span class="main">=</span> <span class="keyword1">0<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">dimR</span> <span class="free">dimC</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>insert <span class="skolem">x</span> <span class="skolem">F</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sum_mat <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="main">(</span><span class="free">A</span> <span class="bound">i</span><span class="main">)</span> <span class="main">*</span> <span class="free">B</span><span class="main">)</span> <span class="main">(</span>insert <span class="skolem">x</span> <span class="skolem">F</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">A</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">*</span> <span class="free">B</span> <span class="main">+</span> sum_mat <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="main">(</span><span class="free">A</span> <span class="bound">i</span><span class="main">)</span> <span class="main">*</span> <span class="free">B</span><span class="main">)</span> <span class="skolem">F</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> sum_with_insert<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="main">(</span><span class="free">A</span> <span class="bound">i</span><span class="main">)</span> <span class="main">*</span> <span class="free">B</span>"</span></span> <span class="quoted"><span class="skolem">x</span></span> <span class="quoted"><span class="skolem">F</span></span><span class="main">]</span> insert
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> image_subset_iff local.sum_mat_def cpx_sq_mat_mult<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="free">A</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">*</span> <span class="free">B</span> <span class="main">+</span> <span class="main">(</span>sum_mat <span class="free">A</span> <span class="skolem">F</span><span class="main">)</span> <span class="main">*</span> <span class="free">B</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> insert <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="free">A</span> <span class="skolem">x</span> <span class="main">+</span> <span class="main">(</span>sum_mat <span class="free">A</span> <span class="skolem">F</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="free">B</span>"</span></span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> mult_add_distrib_left<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">B</span><span class="main">∈</span> <span class="free">fc_mats</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> insert <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="skolem">x</span> <span class="main">∈</span> <span class="free">fc_mats</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> insert <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"sum_mat <span class="free">A</span> <span class="skolem">F</span> <span class="main">∈</span> <span class="free">fc_mats</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> insert <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fc_mats_carrier sum_mat_carrier<span class="main">)</span> 
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span>sum_mat <span class="free">A</span> <span class="main">(</span>insert <span class="skolem">x</span> <span class="skolem">F</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="free">B</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> sum_with_insert<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">A</span></span> <span class="quoted"><span class="skolem">x</span></span> <span class="quoted"><span class="skolem">F</span></span><span class="main">]</span> insert 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> image_subset_iff sum_mat_def<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> cpx_sq_mat<span class="main">)</span> trace_sum_mat_mat_distrib<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">I</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span><span class="main">∈</span> <span class="free">I</span> <span class="main">⟹</span> <span class="free">B</span> <span class="bound">i</span> <span class="main">∈</span> <span class="free">fc_mats</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span><span class="main">∈</span> <span class="free">fc_mats</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">C</span> <span class="main">∈</span> <span class="free">fc_mats</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span> <span class="bound">i</span><span class="main">∈</span> <span class="free">I</span><span class="main">.</span> Complex_Matrix.trace<span class="main">(</span><span class="free">A</span> <span class="main">*</span> <span class="main">(</span><span class="free">B</span> <span class="bound">i</span><span class="main">)</span> <span class="main">*</span> <span class="free">C</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
  Complex_Matrix.trace <span class="main">(</span><span class="free">A</span> <span class="main">*</span> <span class="main">(</span>sum_mat <span class="free">B</span> <span class="free">I</span><span class="main">)</span> <span class="main">*</span> <span class="free">C</span><span class="main">)</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> seq<span class="main">:</span> <span class="quoted"><span class="quoted">"sum_mat <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="free">A</span> <span class="main">*</span> <span class="main">(</span><span class="free">B</span> <span class="bound">i</span><span class="main">)</span> <span class="main">*</span> <span class="free">C</span><span class="main">)</span> <span class="free">I</span> <span class="main">=</span> <span class="free">A</span> <span class="main">*</span> <span class="main">(</span>sum_mat <span class="free">B</span> <span class="free">I</span><span class="main">)</span> <span class="main">*</span> <span class="free">C</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sum_mat <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="free">A</span> <span class="main">*</span> <span class="main">(</span><span class="free">B</span> <span class="bound">i</span><span class="main">)</span> <span class="main">*</span> <span class="free">C</span><span class="main">)</span> <span class="free">I</span> <span class="main">=</span> <span class="main">(</span>sum_mat <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="free">A</span> <span class="main">*</span> <span class="main">(</span><span class="free">B</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="free">I</span><span class="main">)</span> <span class="main">*</span> <span class="free">C</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> mult_sum_mat_distrib_right<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">I</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">C</span><span class="main">∈</span> <span class="free">fc_mats</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∈</span> <span class="free">I</span> <span class="main">⟹</span> <span class="free">A</span> <span class="main">*</span> <span class="free">B</span> <span class="bound">i</span> <span class="main">∈</span> <span class="free">fc_mats</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms cpx_sq_mat_mult <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sum_mat <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="free">A</span> <span class="main">*</span> <span class="main">(</span><span class="free">B</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="free">I</span> <span class="main">=</span> <span class="free">A</span> <span class="main">*</span> <span class="main">(</span>sum_mat <span class="free">B</span> <span class="free">I</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> mult_sum_mat_distrib_left<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main">)</span><span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"sum_mat <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="free">A</span> <span class="main">*</span> <span class="main">(</span><span class="free">B</span> <span class="bound">i</span><span class="main">)</span> <span class="main">*</span> <span class="free">C</span><span class="main">)</span> <span class="free">I</span> <span class="main">=</span> <span class="free">A</span> <span class="main">*</span> <span class="main">(</span>sum_mat <span class="free">B</span> <span class="free">I</span><span class="main">)</span>  <span class="main">*</span> <span class="free">C</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span> <span class="bound">i</span><span class="main">∈</span> <span class="free">I</span><span class="main">.</span> Complex_Matrix.trace<span class="main">(</span><span class="free">A</span> <span class="main">*</span> <span class="main">(</span><span class="free">B</span> <span class="bound">i</span><span class="main">)</span> <span class="main">*</span> <span class="free">C</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
    Complex_Matrix.trace <span class="main">(</span>sum_mat <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="free">A</span> <span class="main">*</span> <span class="main">(</span><span class="free">B</span> <span class="bound">i</span><span class="main">)</span> <span class="main">*</span> <span class="free">C</span><span class="main">)</span> <span class="free">I</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> trace_sum_mat<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">I</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span><span class="main">∈</span> <span class="free">I</span>"</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">*</span> <span class="free">B</span> <span class="skolem">i</span> <span class="main">*</span> <span class="free">C</span> <span class="main">∈</span> <span class="free">fc_mats</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cpx_sq_mat_mult<span class="main">)</span> 
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> Complex_Matrix.trace <span class="main">(</span><span class="free">A</span> <span class="main">*</span> <span class="main">(</span>sum_mat <span class="free">B</span> <span class="free">I</span><span class="main">)</span> <span class="main">*</span> <span class="free">C</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> seq <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> cpx_sq_mat<span class="main">)</span> <span class="entity">zero_col</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">zero_col</span> <span class="free"><span class="bound"><span class="entity">U</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="free">dimR</span> <span class="keyword1">then</span> Matrix.col <span class="free"><span class="bound"><span class="entity">U</span></span></span> <span class="bound">i</span> <span class="keyword1">else</span> <span class="keyword1">0<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">dimR</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> cpx_sq_mat<span class="main">)</span> zero_col_dim<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">U</span> <span class="main">∈</span> <span class="free">fc_mats</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"dim_vec <span class="main">(</span>zero_col <span class="free">U</span> <span class="free">i</span><span class="main">)</span> <span class="main">=</span> <span class="free">dimR</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms fc_mats_carrier <span class="keyword1"><span class="command">unfolding</span></span> zero_col_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> cpx_sq_mat<span class="main">)</span> zero_col_col<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> <span class="free">dimR</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"zero_col <span class="free">U</span> <span class="free">i</span> <span class="main">=</span> Matrix.col <span class="free">U</span> <span class="free">i</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> zero_col_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> cpx_sq_mat<span class="main">)</span> sum_mat_index<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">I</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∈</span> <span class="free">I</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">A</span> <span class="bound">i</span><span class="main">)</span><span class="main">∈</span> <span class="free">fc_mats</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">i</span> <span class="main">&lt;</span> <span class="free">dimR</span> <span class="main">⟹</span> <span class="free">j</span> <span class="main">&lt;</span> <span class="free">dimC</span> <span class="main">⟹</span> 
    <span class="main">(</span>sum_mat <span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> <span class="main">(</span><span class="free">A</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span> <span class="free">I</span><span class="main">)</span> <span class="main">$$</span> <span class="main">(</span><span class="free">i</span><span class="main">,</span><span class="free">j</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span> <span class="bound">k</span><span class="main">∈</span><span class="free">I</span><span class="main">.</span> <span class="main">(</span><span class="free">A</span> <span class="bound">k</span><span class="main">)</span> <span class="main">$$</span> <span class="main">(</span><span class="free">i</span><span class="main">,</span><span class="free">j</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> finite_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> empty
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> sum_mat_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>insert <span class="skolem">x</span> <span class="skolem">F</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>sum_mat <span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> <span class="main">(</span><span class="free">A</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>insert <span class="skolem">x</span> <span class="skolem">F</span><span class="main">)</span><span class="main">)</span> <span class="main">$$</span> <span class="main">(</span><span class="free">i</span><span class="main">,</span><span class="free">j</span><span class="main">)</span> <span class="main">=</span> 
    <span class="main">(</span><span class="free">A</span> <span class="skolem">x</span> <span class="main">+</span> <span class="main">(</span>sum_mat <span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> <span class="main">(</span><span class="free">A</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span> <span class="skolem">F</span><span class="main">)</span><span class="main">)</span> <span class="main">$$</span> <span class="main">(</span><span class="free">i</span><span class="main">,</span><span class="free">j</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> insert sum_mat_insert<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">A</span></span><span class="main">]</span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> image_subsetI local.fc_mats_carrier<span class="main">)</span> 
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="free">A</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">$$</span> <span class="main">(</span><span class="free">i</span><span class="main">,</span><span class="free">j</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span>sum_mat <span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> <span class="main">(</span><span class="free">A</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span> <span class="skolem">F</span><span class="main">)</span> <span class="main">$$</span> <span class="main">(</span><span class="free">i</span><span class="main">,</span><span class="free">j</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> insert       
      sum_mat_carrier<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">F</span></span> <span class="quoted"><span class="free">A</span></span><span class="main">]</span> fc_mats_carrier <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="free">A</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">$$</span> <span class="main">(</span><span class="free">i</span><span class="main">,</span><span class="free">j</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="main">∑</span> <span class="bound">k</span><span class="main">∈</span><span class="skolem">F</span><span class="main">.</span> <span class="main">(</span><span class="free">A</span> <span class="bound">k</span><span class="main">)</span> <span class="main">$$</span> <span class="main">(</span><span class="free">i</span><span class="main">,</span><span class="free">j</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> insert <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span> <span class="bound">k</span><span class="main">∈</span><span class="main">(</span>insert <span class="skolem">x</span> <span class="skolem">F</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="free">A</span> <span class="bound">k</span><span class="main">)</span> <span class="main">$$</span> <span class="main">(</span><span class="free">i</span><span class="main">,</span><span class="free">j</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> insert <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> cpx_sq_mat<span class="main">)</span> sum_mat_cong<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">I</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span><span class="main">∈</span> <span class="free">I</span> <span class="main">⟹</span> <span class="free">A</span> <span class="bound">i</span> <span class="main">=</span> <span class="free">B</span> <span class="bound">i</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span><span class="main">∈</span> <span class="free">I</span> <span class="main">⟹</span> <span class="free">A</span> <span class="bound">i</span> <span class="main">∈</span> <span class="free">fc_mats</span><span class="main">)</span> <span class="main">⟹</span> 
    <span class="main">(</span><span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span><span class="main">∈</span> <span class="free">I</span> <span class="main">⟹</span> <span class="free">B</span> <span class="bound">i</span> <span class="main">∈</span> <span class="free">fc_mats</span><span class="main">)</span> <span class="main">⟹</span> sum_mat <span class="free">A</span> <span class="free">I</span> <span class="main">=</span> sum_mat <span class="free">B</span> <span class="free">I</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> finite_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> empty
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>insert <span class="skolem">x</span> <span class="skolem">F</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sum_mat <span class="free">A</span> <span class="main">(</span>insert <span class="skolem">x</span> <span class="skolem">F</span><span class="main">)</span> <span class="main">=</span> <span class="free">A</span> <span class="skolem">x</span> <span class="main">+</span> sum_mat <span class="free">A</span> <span class="skolem">F</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> insert sum_mat_insert<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">A</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>  image_subset_iff<span class="main">)</span> 
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="free">B</span> <span class="skolem">x</span> <span class="main">+</span> sum_mat <span class="free">B</span> <span class="skolem">F</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> insert <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> sum_mat <span class="free">B</span> <span class="main">(</span>insert <span class="skolem">x</span> <span class="skolem">F</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> insert sum_mat_insert<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">B</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>  image_subset_iff<span class="main">)</span> 
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> cpx_sq_mat<span class="main">)</span> smult_sum_mat<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">I</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span><span class="main">∈</span> <span class="free">I</span> <span class="main">⟹</span> <span class="free">A</span> <span class="bound">i</span> <span class="main">∈</span> <span class="free">fc_mats</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">a</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>m</sub></span> sum_mat <span class="free">A</span> <span class="free">I</span> <span class="main">=</span> sum_mat <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="free">a</span>  <span class="keyword1">⋅<span class="hidden">⇩</span><sub>m</sub></span> <span class="main">(</span><span class="free">A</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="free">I</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> finite_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> empty
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>insert <span class="skolem">x</span> <span class="skolem">F</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>m</sub></span> sum_mat <span class="free">A</span> <span class="main">(</span>insert <span class="skolem">x</span> <span class="skolem">F</span><span class="main">)</span> <span class="main">=</span> <span class="free">a</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>m</sub></span> <span class="main">(</span><span class="free">A</span> <span class="skolem">x</span> <span class="main">+</span> sum_mat <span class="free">A</span> <span class="skolem">F</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> insert sum_mat_insert<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">A</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>  image_subset_iff<span class="main">)</span> 
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="free">a</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">A</span> <span class="skolem">x</span> <span class="main">+</span> <span class="free">a</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>m</sub></span> <span class="main">(</span>sum_mat <span class="free">A</span> <span class="skolem">F</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> insert
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> add_smult_distrib_left_mat fc_mats_carrier insert_iff sum_mat_carrier<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="free">a</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>m</sub></span>  <span class="free">A</span> <span class="skolem">x</span> <span class="main">+</span> sum_mat <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="free">a</span>  <span class="keyword1">⋅<span class="hidden">⇩</span><sub>m</sub></span> <span class="main">(</span><span class="free">A</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="skolem">F</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> insert <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> sum_mat <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="free">a</span>  <span class="keyword1">⋅<span class="hidden">⇩</span><sub>m</sub></span> <span class="main">(</span><span class="free">A</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>insert <span class="skolem">x</span> <span class="skolem">F</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> insert 
      sum_mat_insert<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="free">a</span>  <span class="keyword1">⋅<span class="hidden">⇩</span><sub>m</sub></span> <span class="main">(</span><span class="free">A</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> image_subset_iff cpx_sq_mat_smult<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> cpx_sq_mat<span class="main">)</span> zero_sum_mat<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">I</span> <span class="main">⟹</span> sum_mat <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="keyword1">0<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">dimR</span> <span class="free">dimR</span><span class="main">)</span><span class="main">::</span>complex Matrix.mat<span class="main">)</span><span class="main">)</span> <span class="free">I</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="keyword1">0<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">dimR</span> <span class="free">dimR</span><span class="main">)</span><span class="main">::</span>complex Matrix.mat<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>finite_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> empty
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> dim_eq sum_mat_empty <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>insert <span class="skolem">x</span> <span class="skolem">F</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sum_mat <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="keyword1">0<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">dimR</span> <span class="free">dimR</span><span class="main">)</span><span class="main">::</span>complex Matrix.mat<span class="main">)</span><span class="main">)</span> <span class="main">(</span>insert <span class="skolem">x</span> <span class="skolem">F</span><span class="main">)</span> <span class="main">=</span> 
    <span class="keyword1">0<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">dimR</span> <span class="free">dimR</span> <span class="main">+</span> sum_mat <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="keyword1">0<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">dimR</span> <span class="free">dimR</span><span class="main">)</span> <span class="skolem">F</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> insert dim_eq zero_mem sum_mat_insert<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="keyword1">0<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">dimR</span> <span class="free">dimR</span><span class="main">)</span><span class="main">::</span>complex Matrix.mat<span class="main">)</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="keyword1">0<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">dimR</span> <span class="free">dimR</span><span class="main">)</span><span class="main">::</span>complex Matrix.mat<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> insert <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> cpx_sq_mat<span class="main">)</span> sum_mat_adjoint<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">I</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span><span class="main">∈</span> <span class="free">I</span> <span class="main">⟹</span> <span class="free">A</span> <span class="bound">i</span> <span class="main">∈</span> <span class="free">fc_mats</span><span class="main">)</span> <span class="main">⟹</span> 
    Complex_Matrix.adjoint <span class="main">(</span>sum_mat <span class="free">A</span> <span class="free">I</span><span class="main">)</span> <span class="main">=</span> sum_mat <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> Complex_Matrix.adjoint <span class="main">(</span><span class="free">A</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="free">I</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> finite_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> empty
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> zero_hermitian<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">dimR</span></span><span class="main">]</span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> dim_eq hermitian_def sum_mat_empty<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>insert <span class="skolem">x</span> <span class="skolem">F</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Complex_Matrix.adjoint <span class="main">(</span>sum_mat <span class="free">A</span> <span class="main">(</span>insert <span class="skolem">x</span> <span class="skolem">F</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
    Complex_Matrix.adjoint <span class="main">(</span><span class="free">A</span> <span class="skolem">x</span> <span class="main">+</span> sum_mat <span class="free">A</span> <span class="skolem">F</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> insert sum_mat_insert<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">A</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>  image_subset_iff<span class="main">)</span> 
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> Complex_Matrix.adjoint <span class="main">(</span><span class="free">A</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">+</span> Complex_Matrix.adjoint <span class="main">(</span>sum_mat <span class="free">A</span> <span class="skolem">F</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> adjoint_add<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="skolem">x</span> <span class="main">∈</span> carrier_mat <span class="free">dimR</span> <span class="free">dimC</span>"</span></span> <span class="keyword1"><span class="command">using</span></span>  insert fc_mats_carrier  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"sum_mat <span class="free">A</span> <span class="skolem">F</span> <span class="main">∈</span> carrier_mat <span class="free">dimR</span> <span class="free">dimC</span>"</span></span> <span class="keyword1"><span class="command">using</span></span>  insert fc_mats_carrier sum_mat_carrier<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">F</span></span><span class="main">]</span>  
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> Complex_Matrix.adjoint <span class="main">(</span><span class="free">A</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">+</span> sum_mat <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> Complex_Matrix.adjoint <span class="main">(</span><span class="free">A</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="skolem">F</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> insert <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> sum_mat <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> Complex_Matrix.adjoint <span class="main">(</span><span class="free">A</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>insert <span class="skolem">x</span> <span class="skolem">F</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> sum_mat_insert<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> insert<span class="main">)</span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Complex_Matrix.adjoint <span class="main">(</span><span class="free">A</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">∈</span> <span class="free">fc_mats</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> insert fc_mats_carrier dim_eq 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> adjoint_dim<span class="main">)</span> 
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∈</span> <span class="skolem">F</span> <span class="main">⟹</span> Complex_Matrix.adjoint <span class="main">(</span><span class="free">A</span> <span class="bound">i</span><span class="main">)</span> <span class="main">∈</span> <span class="free">fc_mats</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> insert fc_mats_carrier dim_eq 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> adjoint_dim<span class="main">)</span> 
  <span class="keyword1"><span class="command">qed</span></span> 
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> cpx_sq_mat<span class="main">)</span> sum_mat_hermitian<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">I</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">∈</span> <span class="free">I</span><span class="main">.</span> hermitian <span class="main">(</span><span class="free">A</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">∈</span> <span class="free">I</span><span class="main">.</span> <span class="free">A</span> <span class="bound">i</span><span class="main">∈</span> <span class="free">fc_mats</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"hermitian <span class="main">(</span>sum_mat <span class="free">A</span> <span class="free">I</span><span class="main">)</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Complex_Matrix.adjoint <span class="main">(</span>sum_mat <span class="free">A</span> <span class="free">I</span><span class="main">)</span> <span class="main">=</span> sum_mat <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> Complex_Matrix.adjoint <span class="main">(</span><span class="free">A</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="free">I</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms sum_mat_adjoint<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">I</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> sum_mat <span class="free">A</span> <span class="free">I</span>"</span></span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> sum_mat_cong<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main">)</span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∈</span> <span class="free">I</span> <span class="main">⟹</span> Complex_Matrix.adjoint <span class="main">(</span><span class="free">A</span> <span class="bound">i</span><span class="main">)</span> <span class="main">=</span> <span class="free">A</span> <span class="bound">i</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms 
      <span class="keyword1"><span class="command">unfolding</span></span> hermitian_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∈</span> <span class="free">I</span> <span class="main">⟹</span> Complex_Matrix.adjoint <span class="main">(</span><span class="free">A</span> <span class="bound">i</span><span class="main">)</span> <span class="main">∈</span> <span class="free">fc_mats</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms fc_mats_carrier dim_eq
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> adjoint_dim<span class="main">)</span> 
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> hermitian_def <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> cpx_sq_mat<span class="main">)</span> sum_mat_positive<span class="main">:</span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">I</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span><span class="main">∈</span> <span class="free">I</span> <span class="main">⟹</span> Complex_Matrix.positive <span class="main">(</span><span class="free">A</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> 
  <span class="main">(</span><span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∈</span> <span class="free">I</span> <span class="main">⟹</span> <span class="free">A</span> <span class="bound">i</span> <span class="main">∈</span> <span class="free">fc_mats</span><span class="main">)</span> <span class="main">⟹</span> Complex_Matrix.positive <span class="main">(</span>sum_mat <span class="free">A</span> <span class="free">I</span><span class="main">)</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> finite_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> empty
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> positive_zero<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">dimR</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> dim_eq sum_mat_empty<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>insert <span class="skolem">x</span> <span class="skolem">F</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"sum_mat <span class="free">A</span> <span class="main">(</span>insert <span class="skolem">x</span> <span class="skolem">F</span><span class="main">)</span> <span class="main">=</span> <span class="free">A</span> <span class="skolem">x</span> <span class="main">+</span> <span class="main">(</span>sum_mat <span class="free">A</span> <span class="skolem">F</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> sum_mat_insert<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">A</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>  image_subset_iff<span class="main">)</span> 
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Complex_Matrix.positive <span class="main">(</span><span class="free">A</span> <span class="skolem">x</span> <span class="main">+</span> <span class="main">(</span>sum_mat <span class="free">A</span> <span class="skolem">F</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> positive_add<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> insert<span class="main">)</span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="skolem">x</span> <span class="main">∈</span> carrier_mat <span class="free">dimR</span> <span class="free">dimR</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> insert fc_mats_carrier dim_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"sum_mat <span class="free">A</span> <span class="skolem">F</span> <span class="main">∈</span> carrier_mat <span class="free">dimR</span> <span class="free">dimR</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> insert sum_mat_carrier dim_eq
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> insertCI<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Complex_Matrix.positive <span class="main">(</span>sum_mat <span class="free">A</span> <span class="main">(</span>insert <span class="skolem">x</span> <span class="skolem">F</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> cpx_sq_mat<span class="main">)</span> sum_mat_left_ortho_zero<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">I</span> <span class="main">⟹</span> 
    <span class="main">(</span><span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span><span class="main">∈</span> <span class="free">I</span> <span class="main">⟹</span> <span class="free">A</span> <span class="bound">i</span> <span class="main">∈</span> <span class="free">fc_mats</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">B</span> <span class="main">∈</span> <span class="free">fc_mats</span><span class="main">)</span> <span class="main">⟹</span>
    <span class="main">(</span><span class="main">⋀</span> <span class="bound">i</span><span class="main">.</span> <span class="bound">i</span><span class="main">∈</span> <span class="free">I</span> <span class="main">⟹</span> <span class="free">A</span> <span class="bound">i</span> <span class="main">*</span> <span class="free">B</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">0<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">dimR</span> <span class="free">dimR</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> 
    <span class="main">(</span>sum_mat <span class="free">A</span> <span class="free">I</span><span class="main">)</span> <span class="main">*</span> <span class="free">B</span> <span class="main">=</span> <span class="keyword1">0<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">dimR</span> <span class="free">dimR</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>finite_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> empty
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> dim_eq
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span>  finite.intros<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> sum_mat_empty mult_sum_mat_distrib_right<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>insert <span class="skolem">x</span> <span class="skolem">F</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>sum_mat <span class="free">A</span> <span class="main">(</span>insert <span class="skolem">x</span> <span class="skolem">F</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="free">B</span> <span class="main">=</span> 
    <span class="main">(</span><span class="free">A</span> <span class="skolem">x</span> <span class="main">+</span> sum_mat <span class="free">A</span> <span class="skolem">F</span><span class="main">)</span> <span class="main">*</span> <span class="free">B</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> insert sum_mat_insert<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">A</span></span><span class="main">]</span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> image_subset_iff<span class="main">)</span> 
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="free">A</span> <span class="skolem">x</span> <span class="main">*</span> <span class="free">B</span> <span class="main">+</span> sum_mat <span class="free">A</span> <span class="skolem">F</span> <span class="main">*</span> <span class="free">B</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> add_mult_distrib_mat<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="skolem">x</span> <span class="main">∈</span> carrier_mat <span class="free">dimR</span> <span class="free">dimC</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> insert fc_mats_carrier <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"sum_mat <span class="free">A</span> <span class="skolem">F</span> <span class="main">∈</span> carrier_mat <span class="free">dimR</span> <span class="free">dimC</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> insert
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> insert_iff local.fc_mats_carrier sum_mat_carrier<span class="main">)</span> 
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">B</span> <span class="main">∈</span> carrier_mat <span class="free">dimC</span> <span class="free">dimR</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> insert fc_mats_carrier dim_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="free">A</span> <span class="skolem">x</span> <span class="main">*</span> <span class="free">B</span> <span class="main">+</span> <span class="main">(</span><span class="keyword1">0<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">dimR</span> <span class="free">dimR</span><span class="main">)</span>"</span></span>  <span class="keyword1"><span class="command">using</span></span> insert <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="keyword1">0<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">dimR</span> <span class="free">dimR</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> insert <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> cpx_sq_mat<span class="main">)</span> sum_mat_right_ortho_zero<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">I</span> <span class="main">⟹</span> 
    <span class="main">(</span><span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span><span class="main">∈</span> <span class="free">I</span> <span class="main">⟹</span> <span class="free">A</span> <span class="bound">i</span> <span class="main">∈</span> <span class="free">fc_mats</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">B</span> <span class="main">∈</span> <span class="free">fc_mats</span><span class="main">)</span> <span class="main">⟹</span>
    <span class="main">(</span><span class="main">⋀</span> <span class="bound">i</span><span class="main">.</span> <span class="bound">i</span><span class="main">∈</span> <span class="free">I</span> <span class="main">⟹</span> <span class="free">B</span> <span class="main">*</span> <span class="free">A</span> <span class="bound">i</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">0<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">dimR</span> <span class="free">dimR</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> 
    <span class="free">B</span> <span class="main">*</span> <span class="main">(</span>sum_mat <span class="free">A</span> <span class="free">I</span><span class="main">)</span>  <span class="main">=</span> <span class="keyword1">0<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">dimR</span> <span class="free">dimR</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>finite_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> empty
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> dim_eq
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span>  finite.intros<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> sum_mat_empty mult_sum_mat_distrib_left<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>insert <span class="skolem">x</span> <span class="skolem">F</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">B</span> <span class="main">*</span> <span class="main">(</span>sum_mat <span class="free">A</span> <span class="main">(</span>insert <span class="skolem">x</span> <span class="skolem">F</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
    <span class="free">B</span> <span class="main">*</span> <span class="main">(</span><span class="free">A</span> <span class="skolem">x</span> <span class="main">+</span> sum_mat <span class="free">A</span> <span class="skolem">F</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> insert sum_mat_insert<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">A</span></span><span class="main">]</span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> image_subset_iff<span class="main">)</span> 
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="free">B</span> <span class="main">*</span> <span class="free">A</span> <span class="skolem">x</span> <span class="main">+</span> <span class="free">B</span> <span class="main">*</span> sum_mat <span class="free">A</span> <span class="skolem">F</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> mult_add_distrib_mat<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="skolem">x</span> <span class="main">∈</span> carrier_mat <span class="free">dimR</span> <span class="free">dimC</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> insert fc_mats_carrier <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"sum_mat <span class="free">A</span> <span class="skolem">F</span> <span class="main">∈</span> carrier_mat <span class="free">dimR</span> <span class="free">dimC</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> insert
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> insert_iff local.fc_mats_carrier sum_mat_carrier<span class="main">)</span> 
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">B</span> <span class="main">∈</span> carrier_mat <span class="free">dimC</span> <span class="free">dimR</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> insert fc_mats_carrier dim_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="free">B</span> <span class="main">*</span> <span class="free">A</span> <span class="skolem">x</span> <span class="main">+</span> <span class="main">(</span><span class="keyword1">0<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">dimR</span> <span class="free">dimR</span><span class="main">)</span>"</span></span>  <span class="keyword1"><span class="command">using</span></span> insert <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="keyword1">0<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">dimR</span> <span class="free">dimR</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> insert <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>
 
<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> cpx_sq_mat<span class="main">)</span> sum_mat_ortho_square<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">I</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span><span class="main">∈</span> <span class="free">I</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">(</span><span class="free">A</span> <span class="bound">i</span><span class="main">)</span><span class="main">::</span>complex Matrix.mat<span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="free">A</span> <span class="bound">i</span><span class="main">)</span> <span class="main">=</span> <span class="free">A</span> <span class="bound">i</span><span class="main">)</span> <span class="main">⟹</span> 
    <span class="main">(</span><span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span><span class="main">∈</span> <span class="free">I</span> <span class="main">⟹</span> <span class="free">A</span> <span class="bound">i</span> <span class="main">∈</span> <span class="free">fc_mats</span><span class="main">)</span> <span class="main">⟹</span>
    <span class="main">(</span><span class="main">⋀</span> <span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> <span class="bound">i</span><span class="main">∈</span> <span class="free">I</span> <span class="main">⟹</span> <span class="bound">j</span><span class="main">∈</span> <span class="free">I</span> <span class="main">⟹</span> <span class="bound">i</span><span class="main">≠</span> <span class="bound">j</span> <span class="main">⟹</span> <span class="free">A</span> <span class="bound">i</span> <span class="main">*</span> <span class="main">(</span><span class="free">A</span> <span class="bound">j</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">0<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">dimR</span> <span class="free">dimR</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> 
    <span class="main">(</span>sum_mat <span class="free">A</span> <span class="free">I</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span>sum_mat <span class="free">A</span> <span class="free">I</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>sum_mat <span class="free">A</span> <span class="free">I</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>finite_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> empty
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> dim_eq
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> fc_mats_carrier right_mult_zero_mat sum_mat_empty zero_mem<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>insert <span class="skolem">x</span> <span class="skolem">F</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>sum_mat <span class="free">A</span> <span class="main">(</span>insert <span class="skolem">x</span> <span class="skolem">F</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span>sum_mat <span class="free">A</span> <span class="main">(</span>insert <span class="skolem">x</span> <span class="skolem">F</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
    <span class="main">(</span><span class="free">A</span> <span class="skolem">x</span> <span class="main">+</span> sum_mat <span class="free">A</span> <span class="skolem">F</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="free">A</span> <span class="skolem">x</span> <span class="main">+</span> sum_mat <span class="free">A</span> <span class="skolem">F</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> insert sum_mat_insert<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">A</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∈</span> insert <span class="skolem">x</span> <span class="skolem">F</span> <span class="main">⟹</span> <span class="free">A</span> <span class="bound">i</span> <span class="main">*</span> <span class="free">A</span> <span class="bound">i</span> <span class="main">=</span> <span class="free">A</span> <span class="bound">i</span>›</span></span> image_subset_iff<span class="main">)</span> 
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="free">A</span> <span class="skolem">x</span> <span class="main">*</span> <span class="main">(</span><span class="free">A</span> <span class="skolem">x</span> <span class="main">+</span> sum_mat <span class="free">A</span> <span class="skolem">F</span><span class="main">)</span> <span class="main">+</span> sum_mat <span class="free">A</span> <span class="skolem">F</span> <span class="main">*</span> <span class="main">(</span><span class="free">A</span> <span class="skolem">x</span> <span class="main">+</span> sum_mat <span class="free">A</span> <span class="skolem">F</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> add_mult_distrib_mat<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="skolem">x</span> <span class="main">∈</span> carrier_mat <span class="free">dimR</span> <span class="free">dimC</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> insert fc_mats_carrier <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"sum_mat <span class="free">A</span> <span class="skolem">F</span> <span class="main">∈</span> carrier_mat <span class="free">dimR</span> <span class="free">dimC</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> insert
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> insert_iff local.fc_mats_carrier sum_mat_carrier<span class="main">)</span> 
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="skolem">x</span> <span class="main">+</span> sum_mat <span class="free">A</span> <span class="skolem">F</span> <span class="main">∈</span> carrier_mat <span class="free">dimC</span> <span class="free">dimC</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> insert dim_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="free">A</span> <span class="skolem">x</span> <span class="main">*</span> <span class="free">A</span> <span class="skolem">x</span> <span class="main">+</span> <span class="free">A</span> <span class="skolem">x</span> <span class="main">*</span> <span class="main">(</span>sum_mat <span class="free">A</span> <span class="skolem">F</span><span class="main">)</span> <span class="main">+</span> sum_mat <span class="free">A</span> <span class="skolem">F</span> <span class="main">*</span> <span class="main">(</span><span class="free">A</span> <span class="skolem">x</span> <span class="main">+</span> sum_mat <span class="free">A</span> <span class="skolem">F</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="skolem">x</span> <span class="main">*</span> <span class="main">(</span><span class="free">A</span> <span class="skolem">x</span> <span class="main">+</span> sum_mat <span class="free">A</span> <span class="skolem">F</span><span class="main">)</span> <span class="main">=</span> <span class="free">A</span> <span class="skolem">x</span> <span class="main">*</span> <span class="free">A</span> <span class="skolem">x</span> <span class="main">+</span> <span class="free">A</span> <span class="skolem">x</span> <span class="main">*</span> <span class="main">(</span>sum_mat <span class="free">A</span> <span class="skolem">F</span><span class="main">)</span>"</span></span>  
      <span class="keyword1"><span class="command">using</span></span> dim_eq insert.prems<span class="main">(</span>2<span class="main">)</span> mult_add_distrib_right sum_mat_carrier
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> fc_mats_carrier insertI1 subsetD subset_insertI<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="free">A</span> <span class="skolem">x</span> <span class="main">*</span> <span class="free">A</span> <span class="skolem">x</span> <span class="main">+</span> <span class="free">A</span> <span class="skolem">x</span> <span class="main">*</span> <span class="main">(</span>sum_mat <span class="free">A</span> <span class="skolem">F</span><span class="main">)</span> <span class="main">+</span> sum_mat <span class="free">A</span> <span class="skolem">F</span> <span class="main">*</span> <span class="free">A</span> <span class="skolem">x</span> <span class="main">+</span> 
    sum_mat <span class="free">A</span> <span class="skolem">F</span> <span class="main">*</span> <span class="main">(</span>sum_mat <span class="free">A</span> <span class="skolem">F</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sum_mat <span class="free">A</span> <span class="skolem">F</span> <span class="main">*</span> <span class="main">(</span><span class="free">A</span> <span class="skolem">x</span> <span class="main">+</span> local.sum_mat <span class="free">A</span> <span class="skolem">F</span><span class="main">)</span> <span class="main">=</span> 
      sum_mat <span class="free">A</span> <span class="skolem">F</span> <span class="main">*</span> <span class="free">A</span> <span class="skolem">x</span> <span class="main">+</span> local.sum_mat <span class="free">A</span> <span class="skolem">F</span> <span class="main">*</span> local.sum_mat <span class="free">A</span> <span class="skolem">F</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> insert dim_eq add_assoc add_mem mult_add_distrib_right cpx_sq_mat_mult sum_mat_carrier
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> fc_mats_carrier insertI1 subsetD subset_insertI<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="skolem">x</span> <span class="main">*</span> <span class="free">A</span> <span class="skolem">x</span> <span class="main">+</span> <span class="free">A</span> <span class="skolem">x</span> <span class="main">*</span> sum_mat <span class="free">A</span> <span class="skolem">F</span> <span class="main">+</span> sum_mat <span class="free">A</span> <span class="skolem">F</span> <span class="main">*</span> <span class="main">(</span><span class="free">A</span> <span class="skolem">x</span> <span class="main">+</span> sum_mat <span class="free">A</span> <span class="skolem">F</span><span class="main">)</span> <span class="main">=</span>
      <span class="free">A</span> <span class="skolem">x</span> <span class="main">*</span> <span class="free">A</span> <span class="skolem">x</span> <span class="main">+</span> <span class="free">A</span> <span class="skolem">x</span> <span class="main">*</span> sum_mat <span class="free">A</span> <span class="skolem">F</span> <span class="main">+</span> <span class="main">(</span>sum_mat <span class="free">A</span> <span class="skolem">F</span> <span class="main">*</span> <span class="free">A</span> <span class="skolem">x</span> <span class="main">+</span> sum_mat <span class="free">A</span> <span class="skolem">F</span> <span class="main">*</span> sum_mat <span class="free">A</span> <span class="skolem">F</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="free">A</span> <span class="skolem">x</span> <span class="main">*</span> <span class="free">A</span> <span class="skolem">x</span> <span class="main">+</span> <span class="free">A</span> <span class="skolem">x</span> <span class="main">*</span> sum_mat <span class="free">A</span> <span class="skolem">F</span> <span class="main">+</span> sum_mat <span class="free">A</span> <span class="skolem">F</span> <span class="main">*</span> <span class="free">A</span> <span class="skolem">x</span> <span class="main">+</span> sum_mat <span class="free">A</span> <span class="skolem">F</span> <span class="main">*</span> sum_mat <span class="free">A</span> <span class="skolem">F</span>"</span></span>     
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> assoc_add_mat<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="skolem">x</span> <span class="main">*</span> <span class="free">A</span> <span class="skolem">x</span> <span class="main">+</span> <span class="free">A</span> <span class="skolem">x</span> <span class="main">*</span> sum_mat <span class="free">A</span> <span class="skolem">F</span> <span class="main">∈</span> carrier_mat <span class="free">dimR</span> <span class="free">dimR</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> sum_mat_carrier insert 
        dim_eq fc_mats_carrier <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> add_mem cpx_sq_mat_mult insertCI<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"sum_mat <span class="free">A</span> <span class="skolem">F</span> <span class="main">*</span> <span class="free">A</span> <span class="skolem">x</span> <span class="main">∈</span> carrier_mat <span class="free">dimR</span> <span class="free">dimR</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> sum_mat_carrier insert 
        dim_eq fc_mats_carrier <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> cpx_sq_mat_mult insertCI<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"sum_mat <span class="free">A</span> <span class="skolem">F</span> <span class="main">*</span> sum_mat <span class="free">A</span> <span class="skolem">F</span> <span class="main">∈</span> carrier_mat <span class="free">dimR</span> <span class="free">dimR</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> sum_mat_carrier insert 
        dim_eq fc_mats_carrier <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> cpx_sq_mat_mult insertCI<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span> 
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="free">A</span> <span class="skolem">x</span> <span class="main">+</span>  sum_mat <span class="free">A</span> <span class="skolem">F</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="skolem">x</span> <span class="main">*</span> <span class="free">A</span> <span class="skolem">x</span> <span class="main">=</span> <span class="free">A</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> insert <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sum_mat <span class="free">A</span> <span class="skolem">F</span> <span class="main">*</span> sum_mat <span class="free">A</span> <span class="skolem">F</span> <span class="main">=</span> sum_mat <span class="free">A</span> <span class="skolem">F</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> insert <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="skolem">x</span> <span class="main">*</span> <span class="main">(</span>sum_mat <span class="free">A</span> <span class="skolem">F</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">0<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">dimR</span> <span class="free">dimR</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="skolem">x</span> <span class="main">*</span> <span class="main">(</span>sum_mat <span class="free">A</span> <span class="skolem">F</span><span class="main">)</span> <span class="main">=</span> sum_mat <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="free">A</span> <span class="skolem">x</span> <span class="main">*</span> <span class="main">(</span><span class="free">A</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="skolem">F</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sum_mat_distrib_left<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> insert<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> sum_mat <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="keyword1">0<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">dimR</span> <span class="free">dimR</span><span class="main">)</span> <span class="skolem">F</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> sum_mat_cong<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> insert zero_mem<span class="main">)</span><span class="main">)</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∈</span> <span class="skolem">F</span> <span class="main">⟹</span> <span class="free">A</span> <span class="skolem">x</span> <span class="main">*</span> <span class="free">A</span> <span class="bound">i</span> <span class="main">=</span> <span class="keyword1">0<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">dimR</span> <span class="free">dimR</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> insert <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∈</span> <span class="skolem">F</span> <span class="main">⟹</span> <span class="free">A</span> <span class="skolem">x</span> <span class="main">*</span> <span class="free">A</span> <span class="bound">i</span> <span class="main">∈</span> <span class="free">fc_mats</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> insert cpx_sq_mat_mult <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∈</span> <span class="skolem">F</span> <span class="main">⟹</span> <span class="keyword1">0<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">dimR</span> <span class="free">dimR</span> <span class="main">∈</span> <span class="free">fc_mats</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> zero_mem dim_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="keyword1">0<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">dimR</span> <span class="free">dimR</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> zero_sum_mat insert <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sum_mat <span class="free">A</span> <span class="skolem">F</span> <span class="main">*</span> <span class="free">A</span> <span class="skolem">x</span> <span class="main">=</span> <span class="keyword1">0<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">dimR</span> <span class="free">dimR</span>"</span></span> 
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sum_mat <span class="free">A</span> <span class="skolem">F</span> <span class="main">*</span> <span class="free">A</span> <span class="skolem">x</span> <span class="main">=</span> sum_mat <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="free">A</span> <span class="bound">i</span> <span class="main">*</span> <span class="main">(</span><span class="free">A</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span> <span class="skolem">F</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sum_mat_distrib_right<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> insert<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> sum_mat <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="keyword1">0<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">dimR</span> <span class="free">dimR</span><span class="main">)</span> <span class="skolem">F</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> sum_mat_cong<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> insert zero_mem<span class="main">)</span><span class="main">)</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∈</span> <span class="skolem">F</span> <span class="main">⟹</span> <span class="free">A</span> <span class="bound">i</span> <span class="main">*</span> <span class="free">A</span> <span class="skolem">x</span> <span class="main">=</span> <span class="keyword1">0<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">dimR</span> <span class="free">dimR</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> insert <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∈</span> <span class="skolem">F</span> <span class="main">⟹</span> <span class="free">A</span> <span class="bound">i</span> <span class="main">*</span> <span class="free">A</span> <span class="skolem">x</span> <span class="main">∈</span> <span class="free">fc_mats</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> insert cpx_sq_mat_mult <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∈</span> <span class="skolem">F</span> <span class="main">⟹</span> <span class="keyword1">0<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">dimR</span> <span class="free">dimR</span> <span class="main">∈</span> <span class="free">fc_mats</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> zero_mem dim_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="keyword1">0<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">dimR</span> <span class="free">dimR</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> zero_sum_mat insert <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> add_commute add_zero insert.prems<span class="main">(</span>2<span class="main">)</span> zero_mem dim_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> sum_mat <span class="free">A</span> <span class="main">(</span>insert <span class="skolem">x</span> <span class="skolem">F</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> insert sum_mat_insert<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">A</span></span> <span class="quoted"><span class="skolem">x</span></span> <span class="quoted"><span class="skolem">F</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∈</span> insert <span class="skolem">x</span> <span class="skolem">F</span> <span class="main">⟹</span> <span class="free">A</span> <span class="bound">i</span> <span class="main">*</span> <span class="free">A</span> <span class="bound">i</span> <span class="main">=</span> <span class="free">A</span> <span class="bound">i</span>›</span></span> image_subsetI<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Linear_Algebra_Complements-diagonal_unit_vec"><span class="command">lemma</span></span> diagonal_unit_vec<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">B</span> <span class="main">∈</span> carrier_mat <span class="free">n</span> <span class="free">n</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"diagonal_mat <span class="main">(</span><span class="free">B</span><span class="main">::</span>complex Matrix.mat<span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">B</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>v</sub></span> <span class="main">(</span>unit_vec <span class="free">n</span> <span class="free">i</span><span class="main">)</span> <span class="main">=</span> <span class="free">B</span> <span class="main">$$</span> <span class="main">(</span><span class="free">i</span><span class="main">,</span><span class="free">i</span><span class="main">)</span>  <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="main">(</span>unit_vec <span class="free">n</span> <span class="free">i</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">v</span></span><span class="main">::</span><span class="quoted"><span class="quoted">"complex Matrix.vec"</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">=</span> unit_vec <span class="free">n</span> <span class="free">i</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">B</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>v</sub></span> <span class="skolem">v</span> <span class="main">=</span> Matrix.vec <span class="free">n</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">i</span><span class="main">.</span> Matrix.scalar_prod <span class="main">(</span>Matrix.row <span class="free">B</span> <span class="bound">i</span><span class="main">)</span> <span class="skolem">v</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> mult_mat_vec_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> Matrix.vec <span class="free">n</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">i</span><span class="main">.</span> <span class="free">B</span> <span class="main">$$</span><span class="main">(</span><span class="bound">i</span><span class="main">,</span><span class="bound">i</span><span class="main">)</span> <span class="main">*</span> Matrix.vec_index <span class="skolem">v</span> <span class="bound">i</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> <span class="free">n</span><span class="main">.</span> <span class="main">(</span>Matrix.scalar_prod <span class="main">(</span>Matrix.row <span class="free">B</span> <span class="bound">i</span><span class="main">)</span> <span class="skolem">v</span> <span class="main">=</span> <span class="free">B</span> <span class="main">$$</span><span class="main">(</span><span class="bound">i</span><span class="main">,</span><span class="bound">i</span><span class="main">)</span> <span class="main">*</span> Matrix.vec_index <span class="skolem">v</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> allI impI<span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Matrix.scalar_prod <span class="main">(</span>Matrix.row <span class="free">B</span> <span class="skolem">i</span><span class="main">)</span> <span class="skolem">v</span><span class="main">)</span> <span class="main">=</span> 
        <span class="main">(</span><span class="main">∑</span> <span class="bound">j</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span> <span class="main">..&lt;</span> <span class="free">n</span><span class="main">}</span><span class="main">.</span> Matrix.vec_index <span class="main">(</span>Matrix.row <span class="free">B</span> <span class="skolem">i</span><span class="main">)</span> <span class="bound">j</span> <span class="main">*</span> Matrix.vec_index <span class="skolem">v</span> <span class="bound">j</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms
        <span class="keyword1"><span class="command">unfolding</span></span> Matrix.scalar_prod_def v_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> Matrix.vec_index <span class="main">(</span>Matrix.row <span class="free">B</span> <span class="skolem">i</span><span class="main">)</span> <span class="skolem">i</span> <span class="main">*</span> Matrix.vec_index <span class="skolem">v</span> <span class="skolem">i</span>"</span></span> 
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> sum_but_one<span class="main">)</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">j</span></span> <span class="main">&lt;</span> <span class="free">n</span><span class="main">.</span> <span class="bound">j</span> <span class="main">≠</span> <span class="skolem">i</span> <span class="main">⟶</span> Matrix.vec_index <span class="main">(</span>Matrix.row <span class="free">B</span> <span class="skolem">i</span><span class="main">)</span> <span class="bound">j</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> allI impI<span class="main">)</span>
          <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">j</span>
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">≠</span> <span class="skolem">i</span>"</span></span>
          <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"Matrix.vec_index <span class="main">(</span>Matrix.row <span class="free">B</span> <span class="skolem">i</span><span class="main">)</span> <span class="skolem">j</span> <span class="main">=</span> <span class="free">B</span> <span class="main">$$</span> <span class="main">(</span><span class="skolem">i</span><span class="main">,</span><span class="skolem">j</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">&lt;</span> <span class="free">n</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">j</span> <span class="main">&lt;</span> <span class="free">n</span>›</span></span> assms 
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">&lt;</span> <span class="free">n</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">j</span> <span class="main">&lt;</span> <span class="free">n</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">j</span><span class="main">≠</span> <span class="skolem">i</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> diagonal_mat_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Matrix.vec_index <span class="main">(</span>Matrix.row <span class="free">B</span> <span class="skolem">i</span><span class="main">)</span> <span class="skolem">j</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">&lt;</span> <span class="free">n</span>›</span></span> <span class="keyword1"><span class="command">.</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="free">B</span> <span class="main">$$</span><span class="main">(</span><span class="skolem">i</span><span class="main">,</span><span class="skolem">i</span><span class="main">)</span> <span class="main">*</span> Matrix.vec_index <span class="skolem">v</span> <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">&lt;</span> <span class="free">n</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Matrix.scalar_prod <span class="main">(</span>Matrix.row <span class="free">B</span> <span class="skolem">i</span><span class="main">)</span> <span class="skolem">v</span><span class="main">)</span> <span class="main">=</span> <span class="free">B</span> <span class="main">$$</span><span class="main">(</span><span class="skolem">i</span><span class="main">,</span><span class="skolem">i</span><span class="main">)</span> <span class="main">*</span> Matrix.vec_index <span class="skolem">v</span> <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="free">B</span> <span class="main">$$</span> <span class="main">(</span><span class="free">i</span><span class="main">,</span><span class="free">i</span><span class="main">)</span>  <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="skolem">v</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> v_def unit_vec_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">B</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>v</sub></span> <span class="skolem">v</span> <span class="main">=</span> <span class="free">B</span> <span class="main">$$</span> <span class="main">(</span><span class="free">i</span><span class="main">,</span><span class="free">i</span><span class="main">)</span>  <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="skolem">v</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> v_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Linear_Algebra_Complements-mat_vec_mult_assoc"><span class="command">lemma</span></span> mat_vec_mult_assoc<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">∈</span> carrier_mat <span class="free">n</span> <span class="free">p</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">B</span><span class="main">∈</span> carrier_mat <span class="free">p</span> <span class="free">q</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"dim_vec <span class="free">v</span> <span class="main">=</span> <span class="free">q</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>v</sub></span> <span class="main">(</span><span class="free">B</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">v</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">A</span> <span class="main">*</span> <span class="free">B</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">v</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> cpx_sq_mat<span class="main">)</span> similar_eigenvectors<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span><span class="main">∈</span> <span class="free">fc_mats</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">B</span><span class="main">∈</span> <span class="free">fc_mats</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span><span class="main">∈</span> <span class="free">fc_mats</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"similar_mat_wit <span class="free">A</span> <span class="free">B</span> <span class="free">P</span> <span class="main">(</span>Complex_Matrix.adjoint <span class="free">P</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"diagonal_mat <span class="free">B</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>v</sub></span> <span class="main">(</span><span class="free">P</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>v</sub></span> <span class="main">(</span>unit_vec <span class="free">dimR</span> <span class="free">i</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">B</span> <span class="main">$$</span> <span class="main">(</span><span class="free">i</span><span class="main">,</span><span class="free">i</span><span class="main">)</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="main">(</span><span class="free">P</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>v</sub></span> <span class="main">(</span>unit_vec <span class="free">dimR</span> <span class="free">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>v</sub></span> <span class="main">(</span><span class="free">P</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>v</sub></span> <span class="main">(</span>unit_vec <span class="free">dimR</span> <span class="free">i</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
    <span class="main">(</span><span class="free">P</span> <span class="main">*</span> <span class="free">B</span> <span class="main">*</span> <span class="main">(</span>Complex_Matrix.adjoint <span class="free">P</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>v</sub></span> <span class="main">(</span><span class="free">P</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>v</sub></span> <span class="main">(</span>unit_vec <span class="free">dimR</span> <span class="free">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> similar_mat_wit_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="free">P</span> <span class="main">*</span> <span class="free">B</span> <span class="main">*</span> <span class="main">(</span>Complex_Matrix.adjoint <span class="free">P</span><span class="main">)</span> <span class="main">*</span> <span class="free">P</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>v</sub></span> <span class="main">(</span>unit_vec <span class="free">dimR</span> <span class="free">i</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> mat_vec_mult_assoc<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">dimR</span></span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">dimR</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms fc_mats_carrier<span class="main">)</span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">∈</span> carrier_mat <span class="free">dimR</span> <span class="free">dimR</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms fc_mats_carrier dim_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">*</span> <span class="free">B</span> <span class="main">*</span> Complex_Matrix.adjoint <span class="free">P</span> <span class="main">∈</span> carrier_mat <span class="free">dimR</span> <span class="free">dimR</span>"</span></span> 
        <span class="keyword1"><span class="command">using</span></span> assms fc_mats_carrier <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="free">P</span> <span class="main">*</span> <span class="free">B</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span>Complex_Matrix.adjoint <span class="free">P</span><span class="main">)</span> <span class="main">*</span> <span class="free">P</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>v</sub></span> <span class="main">(</span>unit_vec <span class="free">dimR</span> <span class="free">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms dim_eq
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> fc_mats_carrier mat_assoc_test<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> similar_mat_witD2<span class="main"><span class="main">(</span></span>6<span class="main"><span class="main">)</span></span> similar_mat_wit_sym<span class="main">)</span>  
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="free">P</span> <span class="main">*</span> <span class="free">B</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>v</sub></span> <span class="main">(</span>unit_vec <span class="free">dimR</span> <span class="free">i</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Complex_Matrix.adjoint <span class="free">P</span><span class="main">)</span> <span class="main">*</span> <span class="free">P</span> <span class="main">=</span> <span class="keyword1">1<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">dimR</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms dim_eq <span class="keyword1"><span class="command">unfolding</span></span> similar_mat_wit_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fc_mats_carrier<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> local.fc_mats_carrier dim_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="free">P</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>v</sub></span> <span class="main">(</span><span class="free">B</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>v</sub></span> <span class="main">(</span>unit_vec <span class="free">dimR</span> <span class="free">i</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> mat_vec_mult_assoc assms fc_mats_carrier 
      dim_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="free">P</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>v</sub></span> <span class="main">(</span><span class="free">B</span> <span class="main">$$</span> <span class="main">(</span><span class="free">i</span><span class="main">,</span><span class="free">i</span><span class="main">)</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="main">(</span>unit_vec <span class="free">dimR</span> <span class="free">i</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms diagonal_unit_vec 
      fc_mats_carrier dim_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="free">B</span> <span class="main">$$</span> <span class="main">(</span><span class="free">i</span><span class="main">,</span><span class="free">i</span><span class="main">)</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="main">(</span><span class="free">P</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>v</sub></span> <span class="main">(</span>unit_vec <span class="free">dimR</span> <span class="free">i</span><span class="main">)</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> mult_mat_vec<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">∈</span> carrier_mat <span class="free">dimR</span> <span class="free">dimC</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms fc_mats_carrier <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"unit_vec <span class="free">dimR</span> <span class="free">i</span> <span class="main">∈</span> carrier_vec <span class="free">dimC</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> dim_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Projectors›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">projector</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">projector</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="main">⟷</span> <span class="main">(</span>hermitian <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="main">*</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Linear_Algebra_Complements-projector_hermitian"><span class="command">lemma</span></span> projector_hermitian<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"projector <span class="free">M</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"hermitian <span class="free">M</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> projector_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Linear_Algebra_Complements-zero_projector"><span class="command">lemma</span></span> zero_projector<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"projector <span class="main">(</span><span class="keyword1">0<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">n</span> <span class="free">n</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> projector_def
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"hermitian <span class="main">(</span><span class="keyword1">0<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">n</span> <span class="free">n</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> zero_hermitian<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">n</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">0<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">n</span> <span class="free">n</span> <span class="main">*</span> <span class="keyword1">0<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">n</span> <span class="free">n</span> <span class="main">=</span> <span class="keyword1">0<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">n</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Linear_Algebra_Complements-projector_square_eq"><span class="command">lemma</span></span> projector_square_eq<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"projector <span class="free">M</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">*</span> <span class="free">M</span> <span class="main">=</span> <span class="free">M</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> projector_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Linear_Algebra_Complements-projector_positive"><span class="command">lemma</span></span> projector_positive<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"projector <span class="free">M</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Complex_Matrix.positive <span class="free">M</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> positive_if_decomp<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">∈</span> carrier_mat <span class="main">(</span>dim_row <span class="free">M</span><span class="main">)</span> <span class="main">(</span>dim_row <span class="free">M</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms projector_hermitian hermitian_square 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">=</span> Complex_Matrix.adjoint <span class="free">M</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms projector_hermitian<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">M</span></span><span class="main">]</span> 
    <span class="keyword1"><span class="command">unfolding</span></span> hermitian_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">*</span> Complex_Matrix.adjoint <span class="free">M</span> <span class="main">=</span> <span class="free">M</span> <span class="main">*</span> <span class="free">M</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="free">M</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms projector_square_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">*</span> Complex_Matrix.adjoint <span class="free">M</span> <span class="main">=</span> <span class="free">M</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">Ma</span><span class="main">.</span> <span class="bound">Ma</span> <span class="main">*</span> Complex_Matrix.adjoint <span class="bound">Ma</span> <span class="main">=</span> <span class="free">M</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Linear_Algebra_Complements-projector_collapse_trace"><span class="command">lemma</span></span> projector_collapse_trace<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"projector <span class="main">(</span><span class="free">P</span><span class="main">::</span>complex Matrix.mat<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">∈</span> carrier_mat <span class="free">n</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">R</span><span class="main">∈</span> carrier_mat <span class="free">n</span> <span class="free">n</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Complex_Matrix.trace <span class="main">(</span><span class="free">P</span> <span class="main">*</span> <span class="free">R</span> <span class="main">*</span> <span class="free">P</span><span class="main">)</span> <span class="main">=</span> Complex_Matrix.trace <span class="main">(</span><span class="free">R</span> <span class="main">*</span> <span class="free">P</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Complex_Matrix.trace <span class="main">(</span><span class="free">R</span> <span class="main">*</span> <span class="free">P</span><span class="main">)</span> <span class="main">=</span> Complex_Matrix.trace <span class="main">(</span><span class="free">P</span> <span class="main">*</span> <span class="free">R</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> trace_comm assms  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> Complex_Matrix.trace <span class="main">(</span><span class="main">(</span><span class="free">P</span> <span class="main">*</span> <span class="free">P</span><span class="main">)</span> <span class="main">*</span> <span class="free">R</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms projector_square_eq<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">P</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> Complex_Matrix.trace <span class="main">(</span><span class="free">P</span> <span class="main">*</span> <span class="main">(</span><span class="free">P</span> <span class="main">*</span> <span class="free">R</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> Complex_Matrix.trace <span class="main">(</span><span class="free">P</span> <span class="main">*</span> <span class="free">R</span> <span class="main">*</span> <span class="free">P</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> trace_comm<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">P</span></span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">*</span> <span class="free">R</span>"</span></span><span class="main">]</span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Complex_Matrix.trace <span class="main">(</span><span class="free">R</span> <span class="main">*</span> <span class="free">P</span><span class="main">)</span> <span class="main">=</span> Complex_Matrix.trace <span class="main">(</span><span class="free">P</span> <span class="main">*</span> <span class="free">R</span> <span class="main">*</span> <span class="free">P</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Linear_Algebra_Complements-positive_proj_trace"><span class="command">lemma</span></span> positive_proj_trace<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"projector <span class="main">(</span><span class="free">P</span><span class="main">::</span>complex Matrix.mat<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"Complex_Matrix.positive <span class="free">R</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">∈</span> carrier_mat <span class="free">n</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">R</span><span class="main">∈</span> carrier_mat <span class="free">n</span> <span class="free">n</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Complex_Matrix.trace <span class="main">(</span><span class="free">R</span> <span class="main">*</span> <span class="free">P</span><span class="main">)</span> <span class="main">≥</span> <span class="main">0</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Complex_Matrix.trace <span class="main">(</span><span class="free">R</span> <span class="main">*</span> <span class="free">P</span><span class="main">)</span> <span class="main">=</span> Complex_Matrix.trace <span class="main">(</span><span class="main">(</span><span class="free">P</span> <span class="main">*</span> <span class="free">R</span><span class="main">)</span> <span class="main">*</span> <span class="free">P</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span>  assms projector_collapse_trace <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> Complex_Matrix.trace <span class="main">(</span><span class="main">(</span><span class="free">P</span> <span class="main">*</span> <span class="free">R</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span>Complex_Matrix.adjoint <span class="free">P</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> assms projector_hermitian<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">P</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">unfolding</span></span> hermitian_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">≥</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> positive_trace<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">" <span class="free">P</span> <span class="main">*</span> <span class="free">R</span> <span class="main">*</span> Complex_Matrix.adjoint <span class="free">P</span> <span class="main">∈</span> carrier_mat <span class="free">n</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Complex_Matrix.positive <span class="main">(</span><span class="free">P</span> <span class="main">*</span> <span class="free">R</span> <span class="main">*</span> Complex_Matrix.adjoint <span class="free">P</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> positive_close_under_left_right_mult_adjoint<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">n</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main">)</span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Linear_Algebra_Complements-trace_proj_pos_real"><span class="command">lemma</span></span> trace_proj_pos_real<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"projector <span class="main">(</span><span class="free">P</span><span class="main">::</span>complex Matrix.mat<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"Complex_Matrix.positive <span class="free">R</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">∈</span> carrier_mat <span class="free">n</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">R</span><span class="main">∈</span> carrier_mat <span class="free">n</span> <span class="free">n</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Re <span class="main">(</span>Complex_Matrix.trace <span class="main">(</span><span class="free">R</span> <span class="main">*</span> <span class="free">P</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Complex_Matrix.trace <span class="main">(</span><span class="free">R</span> <span class="main">*</span> <span class="free">P</span><span class="main">)</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Complex_Matrix.trace <span class="main">(</span><span class="free">R</span> <span class="main">*</span> <span class="free">P</span><span class="main">)</span> <span class="main">≥</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms  positive_proj_trace <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> complex_eqI<span class="main">)</span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> cpx_sq_mat<span class="main">)</span> trace_sum_mat_proj_pos_real<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> real"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">I</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">i</span><span class="main">∈</span> <span class="free">I</span><span class="main">.</span> projector <span class="main">(</span><span class="free">P</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"Complex_Matrix.positive <span class="free">R</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">∈</span> <span class="free">I</span><span class="main">.</span> <span class="free">P</span> <span class="bound">i</span> <span class="main">∈</span> <span class="free">fc_mats</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="main">∈</span> <span class="free">fc_mats</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Complex_Matrix.trace <span class="main">(</span><span class="free">R</span> <span class="main">*</span> <span class="main">(</span>sum_mat <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="free">f</span> <span class="bound">i</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>m</sub></span> <span class="main">(</span><span class="free">P</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="free">I</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
  Re <span class="main">(</span>Complex_Matrix.trace <span class="main">(</span><span class="free">R</span> <span class="main">*</span> <span class="main">(</span>sum_mat <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="free">f</span> <span class="bound">i</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>m</sub></span> <span class="main">(</span><span class="free">P</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="free">I</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> sm<span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">I</span> <span class="main">⟹</span> Complex_Matrix.trace <span class="main">(</span><span class="free">f</span> <span class="bound">x</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>m</sub></span> <span class="main">(</span><span class="free">R</span> <span class="main">*</span> <span class="free">P</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
    <span class="free">f</span> <span class="bound">x</span> <span class="main">*</span> Complex_Matrix.trace <span class="main">(</span><span class="free">R</span> <span class="main">*</span> <span class="free">P</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span><span class="main">∈</span> <span class="free">I</span>"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Complex_Matrix.trace <span class="main">(</span><span class="free">f</span> <span class="skolem">i</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>m</sub></span> <span class="main">(</span><span class="free">R</span> <span class="main">*</span> <span class="free">P</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">f</span> <span class="skolem">i</span> <span class="main">*</span> Complex_Matrix.trace <span class="main">(</span><span class="free">R</span> <span class="main">*</span> <span class="free">P</span> <span class="skolem">i</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> trace_smult<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="main">*</span> <span class="free">P</span> <span class="skolem">i</span> <span class="main">∈</span> carrier_mat <span class="free">dimR</span> <span class="free">dimR</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms cpx_sq_mat_mult fc_mats_carrier <span class="quoted"><span class="quoted">‹<span class="skolem">i</span><span class="main">∈</span> <span class="free">I</span>›</span></span> 
          dim_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">have</span></span> sw<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">I</span> <span class="main">⟹</span> <span class="free">R</span> <span class="main">*</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">P</span> <span class="bound">x</span><span class="main">)</span> <span class="main">=</span> <span class="free">f</span> <span class="bound">x</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>m</sub></span> <span class="main">(</span><span class="free">R</span> <span class="main">*</span> <span class="free">P</span> <span class="bound">x</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> <span class="free">I</span>"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="main">*</span> <span class="main">(</span><span class="free">f</span> <span class="skolem">i</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">P</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">=</span> <span class="free">f</span> <span class="skolem">i</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>m</sub></span> <span class="main">(</span><span class="free">R</span> <span class="main">*</span> <span class="free">P</span> <span class="skolem">i</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> mult_smult_distrib<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">R</span><span class="main">∈</span> carrier_mat <span class="free">dimR</span> <span class="free">dimR</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms fc_mats_carrier dim_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="skolem">i</span> <span class="main">∈</span> carrier_mat <span class="free">dimR</span> <span class="free">dimR</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="quoted"><span class="quoted">‹<span class="skolem">i</span><span class="main">∈</span> <span class="free">I</span>›</span></span> fc_mats_carrier dim_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">have</span></span> dr<span class="main">:</span> <span class="quoted"><span class="quoted">"Complex_Matrix.trace <span class="main">(</span><span class="free">R</span> <span class="main">*</span> <span class="main">(</span>sum_mat <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="free">f</span> <span class="bound">i</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>m</sub></span> <span class="main">(</span><span class="free">P</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="free">I</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
    Complex_Matrix.trace <span class="main">(</span>sum_mat <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="main">(</span><span class="free">R</span> <span class="main">*</span> <span class="main">(</span><span class="free">f</span> <span class="bound">i</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>m</sub></span> <span class="main">(</span><span class="free">P</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">I</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> sum_mat_distrib_left<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">I</span></span><span class="main">]</span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cpx_sq_mat_smult<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> trs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span> <span class="bound">i</span><span class="main">∈</span> <span class="free">I</span><span class="main">.</span> Complex_Matrix.trace <span class="main">(</span><span class="free">R</span> <span class="main">*</span> <span class="main">(</span><span class="free">f</span> <span class="bound">i</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>m</sub></span> <span class="main">(</span><span class="free">P</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> trace_sum_mat<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main">)</span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∈</span> <span class="free">I</span> <span class="main">⟹</span> <span class="free">R</span> <span class="main">*</span> <span class="main">(</span><span class="free">f</span> <span class="bound">i</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">P</span> <span class="bound">i</span><span class="main">)</span> <span class="main">∈</span> <span class="free">fc_mats</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cpx_sq_mat_smult cpx_sq_mat_mult<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span> <span class="bound">i</span><span class="main">∈</span> <span class="free">I</span><span class="main">.</span> Complex_Matrix.trace <span class="main">(</span><span class="free">f</span> <span class="bound">i</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>m</sub></span> <span class="main">(</span><span class="free">R</span> <span class="main">*</span> <span class="main">(</span><span class="free">P</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sum.cong<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sw<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>    
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span> <span class="bound">i</span><span class="main">∈</span> <span class="free">I</span><span class="main">.</span> <span class="free">f</span> <span class="bound">i</span> <span class="main">*</span> Complex_Matrix.trace <span class="main">(</span><span class="free">R</span> <span class="main">*</span> <span class="main">(</span><span class="free">P</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sum.cong<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sm<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span> <span class="bound">i</span><span class="main">∈</span> <span class="free">I</span><span class="main">.</span> complex_of_real <span class="main">(</span><span class="free">f</span> <span class="bound">i</span> <span class="main">*</span> Re <span class="main">(</span>Complex_Matrix.trace <span class="main">(</span><span class="free">R</span> <span class="main">*</span> <span class="main">(</span><span class="free">P</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> sum.cong<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">I</span> <span class="main">⟹</span>
         complex_of_real <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">*</span> Complex_Matrix.trace <span class="main">(</span><span class="free">R</span> <span class="main">*</span> <span class="free">P</span> <span class="bound">x</span><span class="main">)</span> <span class="main">=</span>
         complex_of_real <span class="main">(</span><span class="free">f</span> <span class="bound">x</span> <span class="main">*</span> Re <span class="main">(</span>Complex_Matrix.trace <span class="main">(</span><span class="free">R</span> <span class="main">*</span> <span class="free">P</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span><span class="main">∈</span> <span class="free">I</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"complex_of_real <span class="main">(</span><span class="free">f</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">*</span> Complex_Matrix.trace <span class="main">(</span><span class="free">R</span> <span class="main">*</span> <span class="free">P</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">=</span> 
        complex_of_real <span class="main">(</span><span class="free">f</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">*</span> complex_of_real <span class="main">(</span>Re <span class="main">(</span>Complex_Matrix.trace <span class="main">(</span><span class="free">R</span> <span class="main">*</span> <span class="free">P</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> assms sum.cong<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">I</span></span> <span class="quoted"><span class="free">I</span></span><span class="main">]</span> fc_mats_carrier trace_proj_pos_real <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> <span class="free">I</span>›</span></span> dim_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> complex_of_real <span class="main">(</span><span class="free">f</span> <span class="skolem">x</span> <span class="main">*</span> Re <span class="main">(</span>Complex_Matrix.trace <span class="main">(</span><span class="free">R</span> <span class="main">*</span> <span class="free">P</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"complex_of_real <span class="main">(</span><span class="free">f</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">*</span> Complex_Matrix.trace <span class="main">(</span><span class="free">R</span> <span class="main">*</span> <span class="free">P</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">=</span>
         complex_of_real <span class="main">(</span><span class="free">f</span> <span class="skolem">x</span> <span class="main">*</span> Re <span class="main">(</span>Complex_Matrix.trace <span class="main">(</span><span class="free">R</span> <span class="main">*</span> <span class="free">P</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span> <span class="bound">i</span><span class="main">∈</span> <span class="free">I</span><span class="main">.</span> <span class="free">f</span> <span class="bound">i</span> <span class="main">*</span> Re <span class="main">(</span>Complex_Matrix.trace <span class="main">(</span><span class="free">R</span> <span class="main">*</span> <span class="main">(</span><span class="free">P</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span> <span class="bound">i</span><span class="main">∈</span> <span class="free">I</span><span class="main">.</span> Re <span class="main">(</span>Complex_Matrix.trace <span class="main">(</span><span class="free">f</span> <span class="bound">i</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>m</sub></span> <span class="main">(</span><span class="free">R</span> <span class="main">*</span> <span class="main">(</span><span class="free">P</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span> <span class="bound">i</span><span class="main">∈</span> <span class="free">I</span><span class="main">.</span> <span class="free">f</span> <span class="bound">i</span> <span class="main">*</span> Re <span class="main">(</span>Complex_Matrix.trace <span class="main">(</span><span class="free">R</span> <span class="main">*</span> <span class="main">(</span><span class="free">P</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
      <span class="main">(</span><span class="main">∑</span> <span class="bound">i</span><span class="main">∈</span> <span class="free">I</span><span class="main">.</span> Re <span class="main">(</span>Complex_Matrix.trace <span class="main">(</span><span class="free">f</span> <span class="bound">i</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>m</sub></span> <span class="main">(</span><span class="free">R</span> <span class="main">*</span> <span class="main">(</span><span class="free">P</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sum.cong<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sm<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span> <span class="bound">i</span><span class="main">∈</span> <span class="free">I</span><span class="main">.</span> Re <span class="main">(</span>Complex_Matrix.trace <span class="main">(</span><span class="free">R</span> <span class="main">*</span> <span class="main">(</span><span class="free">f</span> <span class="bound">i</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>m</sub></span> <span class="main">(</span><span class="free">P</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∈</span> <span class="free">I</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">i</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>m</sub></span> <span class="main">(</span><span class="free">R</span> <span class="main">*</span> <span class="main">(</span><span class="free">P</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">R</span> <span class="main">*</span> <span class="main">(</span><span class="free">f</span> <span class="bound">i</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>m</sub></span> <span class="main">(</span><span class="free">P</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> sw <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> Re <span class="main">(</span><span class="main">∑</span> <span class="bound">i</span><span class="main">∈</span> <span class="free">I</span><span class="main">.</span> <span class="main">(</span>Complex_Matrix.trace <span class="main">(</span><span class="free">R</span> <span class="main">*</span> <span class="main">(</span><span class="free">f</span> <span class="bound">i</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>m</sub></span> <span class="main">(</span><span class="free">P</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> Re <span class="main">(</span>Complex_Matrix.trace <span class="main">(</span>sum_mat <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="free">R</span> <span class="main">*</span> <span class="main">(</span><span class="free">f</span> <span class="bound">i</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>m</sub></span> <span class="main">(</span><span class="free">P</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">I</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> trs <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> Re <span class="main">(</span>Complex_Matrix.trace <span class="main">(</span><span class="free">R</span> <span class="main">*</span> <span class="main">(</span>sum_mat <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="free">f</span> <span class="bound">i</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>m</sub></span> <span class="main">(</span><span class="free">P</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">I</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> dr <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Rank 1 projection›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">rank_1_proj</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">rank_1_proj</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">=</span> outer_prod <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span>"</span></span>

<span class="keyword1" id="Linear_Algebra_Complements-rank_1_proj_square_mat"><span class="command">lemma</span></span> rank_1_proj_square_mat<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"square_mat <span class="main">(</span>rank_1_proj <span class="free">v</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> outer_prod_dim <span class="keyword1"><span class="command">unfolding</span></span> rank_1_proj_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> carrier_matD<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> carrier_matD<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> carrier_vec_dim_vec  square_mat.simps<span class="main">)</span>

<span class="keyword1" id="Linear_Algebra_Complements-rank_1_proj_dim"><span class="command">lemma</span></span> rank_1_proj_dim<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"dim_row <span class="main">(</span>rank_1_proj <span class="free">v</span><span class="main">)</span> <span class="main">=</span> dim_vec <span class="free">v</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> outer_prod_dim <span class="keyword1"><span class="command">unfolding</span></span> rank_1_proj_def
  <span class="keyword1"><span class="command">using</span></span> carrier_vecI <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="Linear_Algebra_Complements-rank_1_proj_carrier"><span class="command">lemma</span></span> rank_1_proj_carrier<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"rank_1_proj <span class="free">v</span> <span class="main">∈</span> carrier_mat <span class="main">(</span>dim_vec <span class="free">v</span><span class="main">)</span> <span class="main">(</span>dim_vec <span class="free">v</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> outer_prod_dim 
  <span class="keyword1"><span class="command">unfolding</span></span> rank_1_proj_def <span class="keyword1"><span class="command">using</span></span> carrier_vecI <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="Linear_Algebra_Complements-rank_1_proj_coord"><span class="command">lemma</span></span> rank_1_proj_coord<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> dim_vec <span class="free">v</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">&lt;</span> dim_vec <span class="free">v</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>rank_1_proj <span class="free">v</span><span class="main">)</span> <span class="main">$$</span> <span class="main">(</span><span class="free">i</span><span class="main">,</span> <span class="free">j</span><span class="main">)</span> <span class="main">=</span> Matrix.vec_index <span class="free">v</span> <span class="free">i</span> <span class="main">*</span> <span class="main">(</span>cnj <span class="main">(</span>Matrix.vec_index <span class="free">v</span> <span class="free">j</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms 
  <span class="keyword1"><span class="command">unfolding</span></span> rank_1_proj_def outer_prod_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Linear_Algebra_Complements-rank_1_proj_adjoint"><span class="command">lemma</span></span> rank_1_proj_adjoint<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Complex_Matrix.adjoint <span class="main">(</span>rank_1_proj <span class="main">(</span><span class="free">v</span><span class="main">::</span>complex Matrix.vec<span class="main">)</span><span class="main">)</span> <span class="main">=</span> rank_1_proj <span class="free">v</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"dim_row <span class="main">(</span>Complex_Matrix.adjoint <span class="main">(</span>rank_1_proj <span class="free">v</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> dim_row <span class="main">(</span>rank_1_proj <span class="free">v</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> rank_1_proj_square_mat <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"dim_col <span class="main">(</span>Complex_Matrix.adjoint <span class="main">(</span>rank_1_proj <span class="free">v</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> dim_col <span class="main">(</span>rank_1_proj <span class="free">v</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="skolem">j</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> dim_row <span class="main">(</span>rank_1_proj <span class="free">v</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> dim_col <span class="main">(</span>rank_1_proj <span class="free">v</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">note</span></span> ij <span class="main">=</span> this
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Complex_Matrix.adjoint <span class="main">(</span>rank_1_proj <span class="free">v</span><span class="main">)</span> <span class="main">$$</span> <span class="main">(</span><span class="skolem">i</span><span class="main">,</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">=</span> conjugate <span class="main">(</span><span class="main">(</span>rank_1_proj <span class="free">v</span><span class="main">)</span> <span class="main">$$</span> <span class="main">(</span><span class="skolem">j</span><span class="main">,</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> ij <span class="quoted"><span class="quoted">‹dim_col <span class="main">(</span>Complex_Matrix.adjoint <span class="main">(</span>rank_1_proj <span class="free">v</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> dim_col <span class="main">(</span>rank_1_proj <span class="free">v</span><span class="main">)</span>›</span></span> 
      adjoint_eval <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> conjugate <span class="main">(</span>Matrix.vec_index <span class="free">v</span> <span class="skolem">j</span> <span class="main">*</span> <span class="main">(</span>cnj <span class="main">(</span>Matrix.vec_index <span class="free">v</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> rank_1_proj_coord ij
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹dim_col <span class="main">(</span>Complex_Matrix.adjoint <span class="main">(</span>rank_1_proj <span class="free">v</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> dim_col <span class="main">(</span>rank_1_proj <span class="free">v</span><span class="main">)</span>›</span></span> 
        adjoint_dim_col rank_1_proj_dim<span class="main">)</span> 
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> Matrix.vec_index <span class="free">v</span> <span class="skolem">i</span> <span class="main">*</span> <span class="main">(</span>cnj <span class="main">(</span>Matrix.vec_index <span class="free">v</span> <span class="skolem">j</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> rank_1_proj <span class="free">v</span> <span class="main">$$</span> <span class="main">(</span><span class="skolem">i</span><span class="main">,</span> <span class="skolem">j</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ij rank_1_proj_coord
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹dim_col <span class="main">(</span>Complex_Matrix.adjoint <span class="main">(</span>rank_1_proj <span class="free">v</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> dim_col <span class="main">(</span>rank_1_proj <span class="free">v</span><span class="main">)</span>›</span></span> 
        adjoint_dim_col rank_1_proj_dim<span class="main">)</span> 
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Complex_Matrix.adjoint <span class="main">(</span>rank_1_proj <span class="free">v</span><span class="main">)</span> <span class="main">$$</span> <span class="main">(</span><span class="skolem">i</span><span class="main">,</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">=</span> rank_1_proj <span class="free">v</span> <span class="main">$$</span> <span class="main">(</span><span class="skolem">i</span><span class="main">,</span> <span class="skolem">j</span><span class="main">)</span>"</span></span><span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Linear_Algebra_Complements-rank_1_proj_hermitian"><span class="command">lemma</span></span> rank_1_proj_hermitian<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"hermitian <span class="main">(</span>rank_1_proj <span class="main">(</span><span class="free">v</span><span class="main">::</span>complex Matrix.vec<span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> rank_1_proj_adjoint 
  <span class="keyword1"><span class="command">unfolding</span></span> hermitian_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Linear_Algebra_Complements-rank_1_proj_trace"><span class="command">lemma</span></span> rank_1_proj_trace<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∥</span><span class="free">v</span><span class="main">∥</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Complex_Matrix.trace <span class="main">(</span>rank_1_proj <span class="free">v</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Complex_Matrix.trace <span class="main">(</span>rank_1_proj <span class="free">v</span><span class="main">)</span> <span class="main">=</span> inner_prod <span class="free">v</span> <span class="free">v</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> trace_outer_prod 
    <span class="keyword1"><span class="command">unfolding</span></span> rank_1_proj_def <span class="keyword1"><span class="command">using</span></span> carrier_vecI <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span>vec_norm <span class="free">v</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> vec_norm_def <span class="keyword1"><span class="command">using</span></span> power2_csqrt <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">∥</span><span class="free">v</span><span class="main">∥</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span>"</span></span> <span class="keyword1"><span class="command">using</span></span> vec_norm_sq_cpx_vec_length_sq <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Linear_Algebra_Complements-rank_1_proj_mat_col"><span class="command">lemma</span></span> rank_1_proj_mat_col<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">∈</span> carrier_mat <span class="free">n</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>rank_1_proj <span class="main">(</span>Matrix.col <span class="free">A</span> <span class="free">i</span><span class="main">)</span><span class="main">)</span> <span class="main">$$</span> <span class="main">(</span><span class="free">j</span><span class="main">,</span> <span class="free">k</span><span class="main">)</span> <span class="main">=</span> <span class="free">A</span> <span class="main">$$</span> <span class="main">(</span><span class="free">j</span><span class="main">,</span> <span class="free">i</span><span class="main">)</span> <span class="main">*</span> conjugate <span class="main">(</span><span class="free">A</span> <span class="main">$$</span> <span class="main">(</span><span class="free">k</span><span class="main">,</span><span class="free">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>rank_1_proj <span class="main">(</span>Matrix.col <span class="free">A</span> <span class="free">i</span><span class="main">)</span><span class="main">)</span> <span class="main">$$</span> <span class="main">(</span><span class="free">j</span><span class="main">,</span> <span class="free">k</span><span class="main">)</span> <span class="main">=</span> Matrix.vec_index <span class="main">(</span>Matrix.col <span class="free">A</span> <span class="free">i</span><span class="main">)</span> <span class="free">j</span> <span class="main">*</span> 
    conjugate <span class="main">(</span>Matrix.vec_index <span class="main">(</span>Matrix.col <span class="free">A</span> <span class="free">i</span><span class="main">)</span> <span class="free">k</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> index_outer_prod<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"Matrix.col <span class="free">A</span> <span class="free">i</span>"</span></span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="quoted">"Matrix.col <span class="free">A</span> <span class="free">i</span>"</span></span> <span class="quoted"><span class="free">n</span></span><span class="main">]</span> 
      assms <span class="keyword1"><span class="command">unfolding</span></span> rank_1_proj_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="free">A</span> <span class="main">$$</span> <span class="main">(</span><span class="free">j</span><span class="main">,</span> <span class="free">i</span><span class="main">)</span> <span class="main">*</span> conjugate <span class="main">(</span><span class="free">A</span> <span class="main">$$</span> <span class="main">(</span><span class="free">k</span><span class="main">,</span><span class="free">i</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> cpx_sq_mat<span class="main">)</span> weighted_sum_rank_1_proj_unitary_index<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">∈</span> <span class="free">fc_mats</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">B</span> <span class="main">∈</span> <span class="free">fc_mats</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"diagonal_mat <span class="free">B</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"Complex_Matrix.unitary <span class="free">A</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">&lt;</span> <span class="free">dimR</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">&lt;</span> <span class="free">dimR</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>sum_mat <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="main">(</span>diag_mat <span class="free">B</span><span class="main">)</span><span class="main">!</span><span class="bound">i</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>m</sub></span> rank_1_proj <span class="main">(</span>Matrix.col <span class="free">A</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">{..&lt;</span> <span class="free">dimR</span><span class="main">}</span><span class="main">)</span> <span class="main">$$</span> <span class="main">(</span><span class="free">j</span><span class="main">,</span><span class="free">k</span><span class="main">)</span> <span class="main">=</span> 
  <span class="main">(</span><span class="free">A</span> <span class="main">*</span> <span class="free">B</span> <span class="main">*</span> <span class="main">(</span>Complex_Matrix.adjoint <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">$$</span> <span class="main">(</span><span class="free">j</span><span class="main">,</span><span class="free">k</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>sum_mat <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="main">(</span>diag_mat <span class="free">B</span><span class="main">)</span><span class="main">!</span><span class="bound">i</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>m</sub></span> rank_1_proj <span class="main">(</span>Matrix.col <span class="free">A</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">{..&lt;</span> <span class="free">dimR</span><span class="main">}</span><span class="main">)</span> <span class="main">$$</span> <span class="main">(</span><span class="free">j</span><span class="main">,</span><span class="free">k</span><span class="main">)</span> <span class="main">=</span> 
    <span class="main">(</span><span class="main">∑</span> <span class="bound">i</span><span class="main">∈</span> <span class="main">{..&lt;</span> <span class="free">dimR</span><span class="main">}</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span>diag_mat <span class="free">B</span><span class="main">)</span><span class="main">!</span><span class="bound">i</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>m</sub></span> rank_1_proj <span class="main">(</span>Matrix.col <span class="free">A</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">$$</span> <span class="main">(</span><span class="free">j</span><span class="main">,</span><span class="free">k</span><span class="main">)</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> sum_mat_index<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fc_mats_carrier assms<span class="main">)</span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="free">dimR</span> <span class="main">⟹</span> <span class="main">(</span>diag_mat <span class="free">B</span><span class="main">)</span><span class="main">!</span><span class="bound">i</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>m</sub></span> rank_1_proj <span class="main">(</span>Matrix.col <span class="free">A</span> <span class="bound">i</span><span class="main">)</span> <span class="main">∈</span> carrier_mat <span class="free">dimR</span> <span class="free">dimC</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> rank_1_proj_carrier assms fc_mats_carrier dim_eq 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> smult_carrier_mat zero_col_col zero_col_dim<span class="main">)</span> 
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">&lt;</span> <span class="free">dimC</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms dim_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span> <span class="bound">i</span><span class="main">∈</span> <span class="main">{..&lt;</span> <span class="free">dimR</span><span class="main">}</span><span class="main">.</span> <span class="main">(</span>diag_mat <span class="free">B</span><span class="main">)</span><span class="main">!</span><span class="bound">i</span><span class="main">*</span> <span class="free">A</span> <span class="main">$$</span> <span class="main">(</span><span class="free">j</span><span class="main">,</span> <span class="bound">i</span><span class="main">)</span> <span class="main">*</span> conjugate <span class="main">(</span><span class="free">A</span> <span class="main">$$</span> <span class="main">(</span><span class="free">k</span><span class="main">,</span><span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> sum.cong<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> idx<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="main">{..&lt;</span><span class="free">dimR</span><span class="main">}</span> <span class="main">⟹</span> <span class="main">(</span>rank_1_proj <span class="main">(</span>Matrix.col <span class="free">A</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">$$</span> <span class="main">(</span><span class="free">j</span><span class="main">,</span> <span class="free">k</span><span class="main">)</span> <span class="main">=</span> 
      <span class="free">A</span> <span class="main">$$</span> <span class="main">(</span><span class="free">j</span><span class="main">,</span> <span class="bound">x</span><span class="main">)</span> <span class="main">*</span> conjugate <span class="main">(</span><span class="free">A</span> <span class="main">$$</span> <span class="main">(</span><span class="free">k</span><span class="main">,</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> rank_1_proj_mat_col assms fc_mats_carrier dim_eq 
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="main">{..&lt;</span><span class="free">dimR</span><span class="main">}</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">(</span>diag_mat <span class="free">B</span><span class="main">)</span><span class="main">!</span><span class="bound">x</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>m</sub></span> rank_1_proj <span class="main">(</span>Matrix.col <span class="free">A</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">$$</span> <span class="main">(</span><span class="free">j</span><span class="main">,</span> <span class="free">k</span><span class="main">)</span> <span class="main">=</span> 
      <span class="main">(</span>diag_mat <span class="free">B</span><span class="main">)</span><span class="main">!</span><span class="bound">x</span> <span class="main">*</span> <span class="free">A</span> <span class="main">$$</span> <span class="main">(</span><span class="free">j</span><span class="main">,</span> <span class="bound">x</span><span class="main">)</span> <span class="main">*</span> conjugate <span class="main">(</span><span class="free">A</span> <span class="main">$$</span> <span class="main">(</span><span class="free">k</span><span class="main">,</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span><span class="main">∈</span> <span class="main">{..&lt;</span> <span class="free">dimR</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span>diag_mat <span class="free">B</span><span class="main">)</span><span class="main">!</span><span class="skolem">x</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>m</sub></span> rank_1_proj <span class="main">(</span>Matrix.col <span class="free">A</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span> <span class="main">$$</span> <span class="main">(</span><span class="free">j</span><span class="main">,</span> <span class="free">k</span><span class="main">)</span> <span class="main">=</span> 
        <span class="main">(</span>diag_mat <span class="free">B</span><span class="main">)</span><span class="main">!</span><span class="skolem">x</span> <span class="main">*</span> <span class="main">(</span>rank_1_proj <span class="main">(</span>Matrix.col <span class="free">A</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span> <span class="main">$$</span> <span class="main">(</span><span class="free">j</span><span class="main">,</span> <span class="free">k</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> index_smult_mat<span class="main">)</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">&lt;</span> dim_row <span class="main">(</span>rank_1_proj <span class="main">(</span>Matrix.col <span class="free">A</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span><span class="main">∈</span> <span class="main">{..&lt;</span> <span class="free">dimR</span><span class="main">}</span>›</span></span> assms fc_mats_carrier <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">&lt;</span> dim_col <span class="main">(</span>rank_1_proj <span class="main">(</span>Matrix.col <span class="free">A</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span><span class="main">∈</span> <span class="main">{..&lt;</span> <span class="free">dimR</span><span class="main">}</span>›</span></span> assms fc_mats_carrier 
            rank_1_proj_carrier<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"Matrix.col <span class="free">A</span> <span class="skolem">x</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span>diag_mat <span class="free">B</span><span class="main">)</span><span class="main">!</span><span class="skolem">x</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>m</sub></span> rank_1_proj <span class="main">(</span>Matrix.col <span class="free">A</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span> <span class="main">$$</span> <span class="main">(</span><span class="free">j</span><span class="main">,</span> <span class="free">k</span><span class="main">)</span> <span class="main">=</span> 
        <span class="main">(</span>diag_mat <span class="free">B</span><span class="main">)</span><span class="main">!</span><span class="skolem">x</span> <span class="main">*</span> <span class="free">A</span> <span class="main">$$</span> <span class="main">(</span><span class="free">j</span><span class="main">,</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">*</span> conjugate <span class="main">(</span><span class="free">A</span> <span class="main">$$</span> <span class="main">(</span><span class="free">k</span><span class="main">,</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> idx <span class="quoted"><span class="quoted">‹<span class="skolem">x</span><span class="main">∈</span> <span class="main">{..&lt;</span> <span class="free">dimR</span><span class="main">}</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> Matrix.scalar_prod <span class="main">(</span>Matrix.col <span class="main">(</span>Complex_Matrix.adjoint <span class="free">A</span><span class="main">)</span> <span class="free">k</span><span class="main">)</span> <span class="main">(</span>Matrix.row <span class="main">(</span><span class="free">A</span><span class="main">*</span><span class="free">B</span><span class="main">)</span> <span class="free">j</span><span class="main">)</span> "</span></span> 
    <span class="keyword1"><span class="command">unfolding</span></span> Matrix.scalar_prod_def
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> sum.cong<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">{..&lt;</span><span class="free">dimR</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span>dim_vec <span class="main">(</span>Matrix.row <span class="main">(</span><span class="free">A</span><span class="main">*</span><span class="free">B</span><span class="main">)</span> <span class="free">j</span><span class="main">)</span><span class="main">}</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> assms fc_mats_carrier dim_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span>dim_vec <span class="main">(</span>Matrix.row <span class="main">(</span><span class="free">A</span><span class="main">*</span><span class="free">B</span><span class="main">)</span> <span class="free">j</span><span class="main">)</span><span class="main">}</span> <span class="main">⟹</span>
      diag_mat <span class="free">B</span> <span class="main">!</span> <span class="bound">x</span> <span class="main">*</span> <span class="free">A</span> <span class="main">$$</span> <span class="main">(</span><span class="free">j</span><span class="main">,</span> <span class="bound">x</span><span class="main">)</span> <span class="main">*</span> conjugate <span class="main">(</span><span class="free">A</span> <span class="main">$$</span> <span class="main">(</span><span class="free">k</span><span class="main">,</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
      Matrix.vec_index <span class="main">(</span><span class="main">(</span>Matrix.col <span class="main">(</span>Complex_Matrix.adjoint <span class="free">A</span><span class="main">)</span> <span class="free">k</span><span class="main">)</span><span class="main">)</span> <span class="bound">x</span> <span class="main">*</span> 
      Matrix.vec_index <span class="main">(</span>Matrix.row <span class="main">(</span><span class="free">A</span><span class="main">*</span><span class="free">B</span><span class="main">)</span> <span class="free">j</span><span class="main">)</span> <span class="bound">x</span>"</span></span> 
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span><span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span>dim_vec <span class="main">(</span>Matrix.row <span class="main">(</span><span class="free">A</span><span class="main">*</span><span class="free">B</span><span class="main">)</span> <span class="free">j</span><span class="main">)</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span><span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">dimR</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms fc_mats_carrier dim_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"diag_mat <span class="free">B</span> <span class="main">!</span> <span class="skolem">x</span> <span class="main">*</span><span class="free">A</span> <span class="main">$$</span> <span class="main">(</span><span class="free">j</span><span class="main">,</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">=</span> Matrix.vec_index <span class="main">(</span>Matrix.row <span class="main">(</span><span class="free">A</span><span class="main">*</span><span class="free">B</span><span class="main">)</span> <span class="free">j</span><span class="main">)</span> <span class="skolem">x</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> times_diag_index<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">dimR</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main">)</span><span class="main">)</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">∈</span> carrier_mat <span class="free">dimR</span> <span class="free">dimR</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms fc_mats_carrier dim_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">B</span> <span class="main">∈</span> carrier_mat <span class="free">dimR</span> <span class="free">dimR</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms fc_mats_carrier dim_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">&lt;</span> <span class="free">dimR</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span><span class="main">∈</span><span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span> <span class="free">dimR</span><span class="main">}</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"conjugate <span class="main">(</span><span class="free">A</span> <span class="main">$$</span> <span class="main">(</span><span class="free">k</span><span class="main">,</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
        Matrix.vec_index <span class="main">(</span><span class="main">(</span>Matrix.col <span class="main">(</span>Complex_Matrix.adjoint <span class="free">A</span><span class="main">)</span> <span class="free">k</span><span class="main">)</span><span class="main">)</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span><span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">dimR</span><span class="main">}</span>›</span></span> assms 
        fc_mats_carrier dim_eq <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> adjoint_col<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"diag_mat <span class="free">B</span> <span class="main">!</span> <span class="skolem">x</span> <span class="main">*</span> <span class="free">A</span> <span class="main">$$</span> <span class="main">(</span><span class="free">j</span><span class="main">,</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">*</span> conjugate <span class="main">(</span><span class="free">A</span> <span class="main">$$</span> <span class="main">(</span><span class="free">k</span><span class="main">,</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
        Matrix.vec_index <span class="main">(</span><span class="main">(</span>Matrix.col <span class="main">(</span>Complex_Matrix.adjoint <span class="free">A</span><span class="main">)</span> <span class="free">k</span><span class="main">)</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">*</span> 
        Matrix.vec_index <span class="main">(</span>Matrix.row <span class="main">(</span><span class="free">A</span><span class="main">*</span><span class="free">B</span><span class="main">)</span> <span class="free">j</span><span class="main">)</span> <span class="skolem">x</span>"</span></span>  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="free">A</span><span class="main">*</span><span class="free">B</span> <span class="main">*</span> <span class="main">(</span>Complex_Matrix.adjoint <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">$$</span> <span class="main">(</span><span class="free">j</span><span class="main">,</span><span class="free">k</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Matrix.mat <span class="main">(</span>dim_row <span class="main">(</span><span class="free">A</span><span class="main">*</span><span class="free">B</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>dim_col <span class="main">(</span>Complex_Matrix.adjoint <span class="free">A</span><span class="main">)</span><span class="main">)</span>
     <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">i</span><span class="main">,</span> <span class="bound">j</span><span class="main">)</span><span class="main">.</span> Matrix.scalar_prod <span class="main">(</span>Matrix.row <span class="main">(</span><span class="free">A</span><span class="main">*</span><span class="free">B</span><span class="main">)</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span>Matrix.col <span class="main">(</span>Complex_Matrix.adjoint <span class="free">A</span><span class="main">)</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span> <span class="main">$$</span>
    <span class="main">(</span><span class="free">j</span><span class="main">,</span> <span class="free">k</span><span class="main">)</span> <span class="main">=</span>  Matrix.scalar_prod <span class="main">(</span>Matrix.row <span class="main">(</span><span class="free">A</span><span class="main">*</span><span class="free">B</span><span class="main">)</span> <span class="free">j</span><span class="main">)</span> <span class="main">(</span>Matrix.col <span class="main">(</span>Complex_Matrix.adjoint <span class="free">A</span><span class="main">)</span> <span class="free">k</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms fc_mats_carrier <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> Matrix.scalar_prod <span class="main">(</span>Matrix.col <span class="main">(</span>Complex_Matrix.adjoint <span class="free">A</span><span class="main">)</span> <span class="free">k</span><span class="main">)</span> <span class="main">(</span>Matrix.row <span class="main">(</span><span class="free">A</span><span class="main">*</span><span class="free">B</span><span class="main">)</span> <span class="free">j</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> assms comm_scalar_prod<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"Matrix.row <span class="main">(</span><span class="free">A</span><span class="main">*</span><span class="free">B</span><span class="main">)</span> <span class="free">j</span>"</span></span> <span class="quoted"><span class="free">dimR</span></span><span class="main">]</span> fc_mats_carrier dim_eq
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> adjoint_dim Matrix.col_carrier_vec row_carrier_vec cpx_sq_mat_mult<span class="main">)</span> 
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms fc_mats_carrier <span class="keyword1"><span class="command">unfolding</span></span> times_mat_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>  
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> cpx_sq_mat<span class="main">)</span> weighted_sum_rank_1_proj_unitary<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">∈</span> <span class="free">fc_mats</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">B</span> <span class="main">∈</span> <span class="free">fc_mats</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"diagonal_mat <span class="free">B</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"Complex_Matrix.unitary <span class="free">A</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>sum_mat <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="main">(</span>diag_mat <span class="free">B</span><span class="main">)</span><span class="main">!</span><span class="bound">i</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>m</sub></span> rank_1_proj <span class="main">(</span>Matrix.col <span class="free">A</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">{..&lt;</span> <span class="free">dimR</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> 
  <span class="main">(</span><span class="free">A</span> <span class="main">*</span> <span class="free">B</span> <span class="main">*</span> <span class="main">(</span>Complex_Matrix.adjoint <span class="free">A</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"dim_row <span class="main">(</span>sum_mat <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> diag_mat <span class="free">B</span> <span class="main">!</span> <span class="bound">i</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>m</sub></span> rank_1_proj <span class="main">(</span>Matrix.col <span class="free">A</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">{..&lt;</span><span class="free">dimR</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span>
    dim_row <span class="main">(</span><span class="free">A</span> <span class="main">*</span> <span class="free">B</span> <span class="main">*</span> Complex_Matrix.adjoint <span class="free">A</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms fc_mats_carrier dim_eq
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> carrier_matD<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> cpx_sq_mat_smult dim_col index_mult_mat<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> 
        rank_1_proj_carrier sum_mat_carrier<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"dim_col <span class="main">(</span>local.sum_mat <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> diag_mat <span class="free">B</span> <span class="main">!</span> <span class="bound">i</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>m</sub></span> rank_1_proj <span class="main">(</span>Matrix.col <span class="free">A</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">{..&lt;</span><span class="free">dimR</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span>
    dim_col <span class="main">(</span><span class="free">A</span> <span class="main">*</span> <span class="free">B</span> <span class="main">*</span> Complex_Matrix.adjoint <span class="free">A</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms fc_mats_carrier dim_eq
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> adjoint_dim_col carrier_matD<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> carrier_matI dim_col 
        index_mult_mat<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> index_smult_mat<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> index_smult_mat<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> rank_1_proj_dim 
        rank_1_proj_square_mat square_mat.elims<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> square_mats sum_mat_carrier<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> dim_row <span class="main">(</span><span class="free">A</span> <span class="main">*</span> <span class="free">B</span> <span class="main">*</span> Complex_Matrix.adjoint <span class="free">A</span><span class="main">)</span> <span class="main">⟹</span>
           <span class="bound">j</span> <span class="main">&lt;</span> dim_col <span class="main">(</span><span class="free">A</span> <span class="main">*</span> <span class="free">B</span> <span class="main">*</span> Complex_Matrix.adjoint <span class="free">A</span><span class="main">)</span> <span class="main">⟹</span>
           local.sum_mat <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> diag_mat <span class="free">B</span> <span class="main">!</span> <span class="bound">i</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>m</sub></span> rank_1_proj <span class="main">(</span>Matrix.col <span class="free">A</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">{..&lt;</span><span class="free">dimR</span><span class="main">}</span> <span class="main">$$</span> <span class="main">(</span><span class="bound">i</span><span class="main">,</span> <span class="bound">j</span><span class="main">)</span> <span class="main">=</span>
           <span class="main">(</span><span class="free">A</span> <span class="main">*</span> <span class="free">B</span> <span class="main">*</span> Complex_Matrix.adjoint <span class="free">A</span><span class="main">)</span> <span class="main">$$</span> <span class="main">(</span><span class="bound">i</span><span class="main">,</span> <span class="bound">j</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> weighted_sum_rank_1_proj_unitary_index<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">A</span></span> <span class="quoted"><span class="free">B</span></span><span class="main">]</span> dim_eq fc_mats_carrier <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Linear_Algebra_Complements-rank_1_proj_projector"><span class="command">lemma</span></span> rank_1_proj_projector<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∥</span><span class="free">v</span><span class="main">∥</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"projector <span class="main">(</span>rank_1_proj <span class="free">v</span><span class="main">)</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span>  <span class="quoted"><span class="quoted">"Complex_Matrix.adjoint <span class="main">(</span>rank_1_proj <span class="free">v</span><span class="main">)</span> <span class="main">=</span> rank_1_proj <span class="free">v</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> rank_1_proj_adjoint <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">hence</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"hermitian <span class="main">(</span>rank_1_proj <span class="free">v</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> hermitian_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"rank_1_proj <span class="free">v</span> <span class="main">*</span> rank_1_proj <span class="free">v</span> <span class="main">=</span> inner_prod <span class="free">v</span> <span class="free">v</span>  <span class="keyword1">⋅<span class="hidden">⇩</span><sub>m</sub></span> outer_prod <span class="free">v</span> <span class="free">v</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> rank_1_proj_def 
    <span class="keyword1"><span class="command">using</span></span> outer_prod_mult_outer_prod assms <span class="keyword1"><span class="command">using</span></span> carrier_vec_dim_vec <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span>vec_norm <span class="free">v</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span>  <span class="keyword1">⋅<span class="hidden">⇩</span><sub>m</sub></span> outer_prod <span class="free">v</span> <span class="free">v</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> vec_norm_def <span class="keyword1"><span class="command">using</span></span> power2_csqrt 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span>  <span class="main">(</span>cpx_vec_length <span class="free">v</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>m</sub></span> outer_prod <span class="free">v</span> <span class="free">v</span> "</span></span> <span class="keyword1"><span class="command">using</span></span> vec_norm_sq_cpx_vec_length_sq
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> outer_prod <span class="free">v</span> <span class="free">v</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms state_qbit_norm_sq smult_one<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"outer_prod <span class="free">v</span> <span class="free">v</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> rank_1_proj <span class="free">v</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> rank_1_proj_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> a <span class="keyword1"><span class="command">unfolding</span></span> projector_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Linear_Algebra_Complements-rank_1_proj_positive"><span class="command">lemma</span></span> rank_1_proj_positive<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∥</span><span class="free">v</span><span class="main">∥</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Complex_Matrix.positive <span class="main">(</span>rank_1_proj <span class="free">v</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"projector <span class="main">(</span>rank_1_proj <span class="free">v</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms rank_1_proj_projector <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> projector_positive <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Linear_Algebra_Complements-rank_1_proj_density"><span class="command">lemma</span></span> rank_1_proj_density<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∥</span><span class="free">v</span><span class="main">∥</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"density_operator <span class="main">(</span>rank_1_proj <span class="free">v</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> density_operator_def <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rank_1_proj_positive rank_1_proj_trace<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> cpx_sq_mat<span class="main">)</span> sum_rank_1_proj_unitary_index<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">∈</span> <span class="free">fc_mats</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"Complex_Matrix.unitary <span class="free">A</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">&lt;</span> <span class="free">dimR</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">&lt;</span> <span class="free">dimR</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>sum_mat <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> rank_1_proj <span class="main">(</span>Matrix.col <span class="free">A</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">{..&lt;</span> <span class="free">dimR</span><span class="main">}</span><span class="main">)</span> <span class="main">$$</span> <span class="main">(</span><span class="free">j</span><span class="main">,</span><span class="free">k</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">1<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">dimR</span><span class="main">)</span> <span class="main">$$</span> <span class="main">(</span><span class="free">j</span><span class="main">,</span><span class="free">k</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>sum_mat <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> rank_1_proj <span class="main">(</span>Matrix.col <span class="free">A</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">{..&lt;</span> <span class="free">dimR</span><span class="main">}</span><span class="main">)</span> <span class="main">$$</span> <span class="main">(</span><span class="free">j</span><span class="main">,</span><span class="free">k</span><span class="main">)</span> <span class="main">=</span> 
    <span class="main">(</span><span class="main">∑</span> <span class="bound">i</span><span class="main">∈</span> <span class="main">{..&lt;</span> <span class="free">dimR</span><span class="main">}</span><span class="main">.</span> <span class="main">(</span>rank_1_proj <span class="main">(</span>Matrix.col <span class="free">A</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">$$</span> <span class="main">(</span><span class="free">j</span><span class="main">,</span><span class="free">k</span><span class="main">)</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> sum_mat_index<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fc_mats_carrier assms<span class="main">)</span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="free">dimR</span> <span class="main">⟹</span> rank_1_proj <span class="main">(</span>Matrix.col <span class="free">A</span> <span class="bound">i</span><span class="main">)</span> <span class="main">∈</span> carrier_mat <span class="free">dimR</span> <span class="free">dimC</span>"</span></span> 
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> <span class="free">dimR</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"dim_vec <span class="main">(</span>Matrix.col <span class="free">A</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">=</span> <span class="free">dimR</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms fc_mats_carrier <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"rank_1_proj <span class="main">(</span>Matrix.col <span class="free">A</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">∈</span> carrier_mat <span class="free">dimR</span> <span class="free">dimC</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> rank_1_proj_carrier assms
        fc_mats_carrier dim_eq fc_mats_carrier <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> dim_col fc_mats_carrier<span class="main">)</span> 
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">&lt;</span> <span class="free">dimC</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms dim_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span> <span class="bound">i</span><span class="main">∈</span> <span class="main">{..&lt;</span> <span class="free">dimR</span><span class="main">}</span><span class="main">.</span> <span class="free">A</span> <span class="main">$$</span> <span class="main">(</span><span class="free">j</span><span class="main">,</span> <span class="bound">i</span><span class="main">)</span> <span class="main">*</span> conjugate <span class="main">(</span><span class="free">A</span> <span class="main">$$</span> <span class="main">(</span><span class="free">k</span><span class="main">,</span><span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> sum.cong<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="main">{..&lt;</span><span class="free">dimR</span><span class="main">}</span> <span class="main">⟹</span> rank_1_proj <span class="main">(</span>Matrix.col <span class="free">A</span> <span class="bound">x</span><span class="main">)</span> <span class="main">$$</span> <span class="main">(</span><span class="free">j</span><span class="main">,</span> <span class="free">k</span><span class="main">)</span> <span class="main">=</span> 
      <span class="free">A</span> <span class="main">$$</span> <span class="main">(</span><span class="free">j</span><span class="main">,</span> <span class="bound">x</span><span class="main">)</span> <span class="main">*</span> conjugate <span class="main">(</span><span class="free">A</span> <span class="main">$$</span> <span class="main">(</span><span class="free">k</span><span class="main">,</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> rank_1_proj_mat_col assms <span class="keyword1"><span class="command">using</span></span> local.fc_mats_carrier dim_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> Matrix.scalar_prod <span class="main">(</span>Matrix.col <span class="main">(</span>Complex_Matrix.adjoint <span class="free">A</span><span class="main">)</span> <span class="free">k</span><span class="main">)</span> <span class="main">(</span>Matrix.row <span class="free">A</span> <span class="free">j</span><span class="main">)</span> "</span></span> 
    <span class="keyword1"><span class="command">unfolding</span></span> Matrix.scalar_prod_def
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> sum.cong<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">{..&lt;</span><span class="free">dimR</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span>dim_vec <span class="main">(</span>Matrix.row <span class="free">A</span> <span class="free">j</span><span class="main">)</span><span class="main">}</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> assms fc_mats_carrier dim_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span>dim_vec <span class="main">(</span>Matrix.row <span class="free">A</span> <span class="free">j</span><span class="main">)</span><span class="main">}</span> <span class="main">⟹</span>
      <span class="free">A</span> <span class="main">$$</span> <span class="main">(</span><span class="free">j</span><span class="main">,</span> <span class="bound">x</span><span class="main">)</span> <span class="main">*</span> conjugate <span class="main">(</span><span class="free">A</span> <span class="main">$$</span> <span class="main">(</span><span class="free">k</span><span class="main">,</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
      Matrix.vec_index <span class="main">(</span><span class="main">(</span>Matrix.col <span class="main">(</span>Complex_Matrix.adjoint <span class="free">A</span><span class="main">)</span> <span class="free">k</span><span class="main">)</span><span class="main">)</span> <span class="bound">x</span> <span class="main">*</span> Matrix.vec_index <span class="main">(</span>Matrix.row <span class="free">A</span> <span class="free">j</span><span class="main">)</span> <span class="bound">x</span>"</span></span> 
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span><span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span>dim_vec <span class="main">(</span>Matrix.row <span class="free">A</span> <span class="free">j</span><span class="main">)</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span><span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">dimR</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms fc_mats_carrier dim_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">$$</span> <span class="main">(</span><span class="free">j</span><span class="main">,</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">=</span> Matrix.vec_index <span class="main">(</span>Matrix.row <span class="free">A</span> <span class="free">j</span><span class="main">)</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span><span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">dimR</span><span class="main">}</span>›</span></span> 
          assms fc_mats_carrier dim_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"conjugate <span class="main">(</span><span class="free">A</span> <span class="main">$$</span> <span class="main">(</span><span class="free">k</span><span class="main">,</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
        Matrix.vec_index <span class="main">(</span><span class="main">(</span>Matrix.col <span class="main">(</span>Complex_Matrix.adjoint <span class="free">A</span><span class="main">)</span> <span class="free">k</span><span class="main">)</span><span class="main">)</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span><span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">dimR</span><span class="main">}</span>›</span></span> 
        assms fc_mats_carrier dim_eq <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> adjoint_col<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">$$</span> <span class="main">(</span><span class="free">j</span><span class="main">,</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">*</span> conjugate <span class="main">(</span><span class="free">A</span> <span class="main">$$</span> <span class="main">(</span><span class="free">k</span><span class="main">,</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
        Matrix.vec_index <span class="main">(</span><span class="main">(</span>Matrix.col <span class="main">(</span>Complex_Matrix.adjoint <span class="free">A</span><span class="main">)</span> <span class="free">k</span><span class="main">)</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">*</span> 
        Matrix.vec_index <span class="main">(</span>Matrix.row <span class="free">A</span> <span class="free">j</span><span class="main">)</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="free">A</span> <span class="main">*</span> <span class="main">(</span>Complex_Matrix.adjoint <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">$$</span> <span class="main">(</span><span class="free">j</span><span class="main">,</span><span class="free">k</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Matrix.mat <span class="main">(</span>dim_row <span class="free">A</span><span class="main">)</span> <span class="main">(</span>dim_col <span class="main">(</span>Complex_Matrix.adjoint <span class="free">A</span><span class="main">)</span><span class="main">)</span>
     <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">i</span><span class="main">,</span> <span class="bound">j</span><span class="main">)</span><span class="main">.</span> Matrix.scalar_prod <span class="main">(</span>Matrix.row <span class="free">A</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span>Matrix.col <span class="main">(</span>Complex_Matrix.adjoint <span class="free">A</span><span class="main">)</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span> <span class="main">$$</span>
    <span class="main">(</span><span class="free">j</span><span class="main">,</span> <span class="free">k</span><span class="main">)</span> <span class="main">=</span>  Matrix.scalar_prod <span class="main">(</span>Matrix.row <span class="free">A</span> <span class="free">j</span><span class="main">)</span> <span class="main">(</span>Matrix.col <span class="main">(</span>Complex_Matrix.adjoint <span class="free">A</span><span class="main">)</span> <span class="free">k</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms fc_mats_carrier <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> Matrix.scalar_prod <span class="main">(</span>Matrix.col <span class="main">(</span>Complex_Matrix.adjoint <span class="free">A</span><span class="main">)</span> <span class="free">k</span><span class="main">)</span> <span class="main">(</span>Matrix.row <span class="free">A</span> <span class="free">j</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> assms comm_scalar_prod<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"Matrix.row <span class="free">A</span> <span class="free">j</span>"</span></span> <span class="quoted"><span class="free">dimR</span></span><span class="main">]</span> fc_mats_carrier
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> adjoint_dim dim_eq<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms fc_mats_carrier <span class="keyword1"><span class="command">unfolding</span></span> times_mat_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">1<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">dimR</span><span class="main">)</span> <span class="main">$$</span> <span class="main">(</span><span class="free">j</span><span class="main">,</span><span class="free">k</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms dim_eq <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fc_mats_carrier<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> cpx_sq_mat<span class="main">)</span> rank_1_proj_sum_density<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">I</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">∈</span> <span class="free">I</span><span class="main">.</span> <span class="main">∥</span><span class="free">u</span> <span class="bound">i</span><span class="main">∥</span> <span class="main">=</span> <span class="main">1</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">∈</span> <span class="free">I</span><span class="main">.</span> dim_vec <span class="main">(</span><span class="free">u</span> <span class="bound">i</span><span class="main">)</span> <span class="main">=</span> <span class="free">dimR</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">∈</span> <span class="free">I</span><span class="main">.</span> <span class="main">0</span> <span class="main">≤</span> <span class="free">p</span> <span class="bound">i</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">∈</span> <span class="free">I</span><span class="main">.</span> <span class="free">p</span> <span class="bound">i</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"density_operator <span class="main">(</span>sum_mat <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="free">p</span> <span class="bound">i</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>m</sub></span> <span class="main">(</span>rank_1_proj <span class="main">(</span><span class="free">u</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">I</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> density_operator_def
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Complex_Matrix.trace <span class="main">(</span>sum_mat <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="free">p</span> <span class="bound">i</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>m</sub></span> rank_1_proj <span class="main">(</span><span class="free">u</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="free">I</span><span class="main">)</span> <span class="main">=</span> 
    <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">∈</span> <span class="free">I</span><span class="main">.</span> Complex_Matrix.trace <span class="main">(</span><span class="free">p</span> <span class="bound">i</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>m</sub></span> rank_1_proj <span class="main">(</span><span class="free">u</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> trace_sum_mat<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main">)</span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∈</span> <span class="free">I</span> <span class="main">⟹</span> <span class="free">p</span> <span class="bound">i</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>m</sub></span> rank_1_proj <span class="main">(</span><span class="free">u</span> <span class="bound">i</span><span class="main">)</span> <span class="main">∈</span> <span class="free">fc_mats</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms smult_mem fc_mats_carrier 
        dim_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">∈</span> <span class="free">I</span><span class="main">.</span> <span class="free">p</span> <span class="bound">i</span> <span class="main">*</span> Complex_Matrix.trace <span class="main">(</span>rank_1_proj <span class="main">(</span><span class="free">u</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> <span class="free">I</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"Complex_Matrix.trace <span class="main">(</span><span class="free">p</span> <span class="skolem">i</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>m</sub></span> rank_1_proj <span class="main">(</span><span class="free">u</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
        <span class="free">p</span> <span class="skolem">i</span> <span class="main">*</span> Complex_Matrix.trace <span class="main">(</span>rank_1_proj <span class="main">(</span><span class="free">u</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> trace_smult<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"rank_1_proj <span class="main">(</span><span class="free">u</span> <span class="skolem">i</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="free">dimR</span></span><span class="main">]</span> assms fc_mats_carrier dim_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms rank_1_proj_trace assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Complex_Matrix.trace <span class="main">(</span>sum_mat <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="free">p</span> <span class="bound">i</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>m</sub></span> rank_1_proj <span class="main">(</span><span class="free">u</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="free">I</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Complex_Matrix.positive <span class="main">(</span>sum_mat <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="free">p</span> <span class="bound">i</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>m</sub></span> rank_1_proj <span class="main">(</span><span class="free">u</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="free">I</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> sum_mat_positive<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main">)</span><span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span><span class="main">∈</span> <span class="free">I</span>"</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="skolem">i</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>m</sub></span> rank_1_proj <span class="main">(</span><span class="free">u</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">∈</span> <span class="free">fc_mats</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms smult_mem fc_mats_carrier dim_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Complex_Matrix.positive <span class="main">(</span><span class="free">p</span> <span class="skolem">i</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>m</sub></span> rank_1_proj <span class="main">(</span><span class="free">u</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="quoted"><span class="quoted">‹<span class="skolem">i</span><span class="main">∈</span> <span class="free">I</span>›</span></span> 
        rank_1_proj_positive positive_smult<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"rank_1_proj <span class="main">(</span><span class="free">u</span> <span class="skolem">i</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="free">dimR</span></span><span class="main">]</span> dim_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>



<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> cpx_sq_mat<span class="main">)</span> sum_rank_1_proj_unitary<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">∈</span> <span class="free">fc_mats</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"Complex_Matrix.unitary <span class="free">A</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>sum_mat <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> rank_1_proj <span class="main">(</span>Matrix.col <span class="free">A</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">{..&lt;</span> <span class="free">dimR</span><span class="main">}</span><span class="main">)</span><span class="main">=</span> <span class="main">(</span><span class="keyword1">1<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">dimR</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"dim_row <span class="main">(</span>sum_mat <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> rank_1_proj <span class="main">(</span>Matrix.col <span class="free">A</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">{..&lt;</span><span class="free">dimR</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> dim_row <span class="main">(</span><span class="keyword1">1<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">dimR</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> assms fc_mats_carrier
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> carrier_matD<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> dim_col dim_eq index_one_mat<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> rank_1_proj_carrier sum_mat_carrier<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"dim_col <span class="main">(</span>sum_mat <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> rank_1_proj <span class="main">(</span>Matrix.col <span class="free">A</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">{..&lt;</span><span class="free">dimR</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> dim_col <span class="main">(</span><span class="keyword1">1<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">dimR</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> assms fc_mats_carrier rank_1_proj_carrier sum_mat_carrier
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> carrier_matD<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> dim_col dim_eq index_one_mat<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> square_mat.simps square_mats<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> dim_row <span class="main">(</span><span class="keyword1">1<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">dimR</span><span class="main">)</span> <span class="main">⟹</span>
     <span class="bound">j</span> <span class="main">&lt;</span> dim_col <span class="main">(</span><span class="keyword1">1<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">dimR</span><span class="main">)</span> <span class="main">⟹</span> sum_mat <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> rank_1_proj <span class="main">(</span>Matrix.col <span class="free">A</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">{..&lt;</span><span class="free">dimR</span><span class="main">}</span> <span class="main">$$</span> <span class="main">(</span><span class="bound">i</span><span class="main">,</span> <span class="bound">j</span><span class="main">)</span> <span class="main">=</span> 
      <span class="keyword1">1<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">dimR</span> <span class="main">$$</span> <span class="main">(</span><span class="bound">i</span><span class="main">,</span> <span class="bound">j</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms sum_rank_1_proj_unitary_index <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> cpx_sq_mat<span class="main">)</span> rank_1_proj_unitary<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">∈</span> <span class="free">fc_mats</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"Complex_Matrix.unitary <span class="free">A</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">&lt;</span> <span class="free">dimR</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">&lt;</span> <span class="free">dimR</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"rank_1_proj <span class="main">(</span>Matrix.col <span class="free">A</span> <span class="free">j</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span>rank_1_proj <span class="main">(</span>Matrix.col <span class="free">A</span> <span class="free">k</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
  <span class="main">(</span><span class="keyword1">1<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">dimR</span><span class="main">)</span> <span class="main">$$</span> <span class="main">(</span><span class="free">j</span><span class="main">,</span><span class="free">k</span><span class="main">)</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>m</sub></span> <span class="main">(</span>outer_prod <span class="main">(</span>Matrix.col <span class="free">A</span> <span class="free">j</span><span class="main">)</span> <span class="main">(</span>Matrix.col <span class="free">A</span> <span class="free">k</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"rank_1_proj <span class="main">(</span>Matrix.col <span class="free">A</span> <span class="free">j</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span>rank_1_proj <span class="main">(</span>Matrix.col <span class="free">A</span> <span class="free">k</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
    Complex_Matrix.inner_prod <span class="main">(</span>Matrix.col <span class="free">A</span> <span class="free">j</span><span class="main">)</span> <span class="main">(</span>Matrix.col <span class="free">A</span> <span class="free">k</span><span class="main">)</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>m</sub></span> outer_prod <span class="main">(</span>Matrix.col <span class="free">A</span> <span class="free">j</span><span class="main">)</span> <span class="main">(</span>Matrix.col <span class="free">A</span> <span class="free">k</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> outer_prod_mult_outer_prod assms Matrix.col_dim local.fc_mats_carrier <span class="keyword1"><span class="command">unfolding</span></span> rank_1_proj_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span>Complex_Matrix.adjoint <span class="free">A</span> <span class="main">*</span> <span class="free">A</span><span class="main">)</span> <span class="main">$$</span> <span class="main">(</span><span class="free">j</span><span class="main">,</span> <span class="free">k</span><span class="main">)</span><span class="keyword1">⋅<span class="hidden">⇩</span><sub>m</sub></span> <span class="main">(</span>outer_prod <span class="main">(</span>Matrix.col <span class="free">A</span> <span class="free">j</span><span class="main">)</span> <span class="main">(</span>Matrix.col <span class="free">A</span> <span class="free">k</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> inner_prod_adjoint_comp<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">A</span></span> <span class="quoted"><span class="free">dimR</span></span> <span class="quoted"><span class="free">A</span></span><span class="main">]</span> assms fc_mats_carrier dim_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">1<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">dimR</span><span class="main">)</span> <span class="main">$$</span> <span class="main">(</span><span class="free">j</span><span class="main">,</span><span class="free">k</span><span class="main">)</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>m</sub></span> <span class="main">(</span>outer_prod <span class="main">(</span>Matrix.col <span class="free">A</span> <span class="free">j</span><span class="main">)</span> <span class="main">(</span>Matrix.col <span class="free">A</span> <span class="free">k</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms 
    <span class="keyword1"><span class="command">unfolding</span></span> Complex_Matrix.unitary_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> add_commute assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> index_add_mat<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> index_one_mat<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> one_mem unitary_simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> cpx_sq_mat<span class="main">)</span> rank_1_proj_unitary_ne<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">∈</span> <span class="free">fc_mats</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"Complex_Matrix.unitary <span class="free">A</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">&lt;</span> <span class="free">dimR</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">&lt;</span> <span class="free">dimR</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span><span class="main">≠</span> <span class="free">k</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"rank_1_proj <span class="main">(</span>Matrix.col <span class="free">A</span> <span class="free">j</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span>rank_1_proj <span class="main">(</span>Matrix.col <span class="free">A</span> <span class="free">k</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>  <span class="main">(</span><span class="keyword1">0<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">dimR</span> <span class="free">dimR</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"dim_row <span class="main">(</span><span class="main">0</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>m</sub></span> outer_prod <span class="main">(</span>Matrix.col <span class="free">A</span> <span class="free">j</span><span class="main">)</span> <span class="main">(</span>Matrix.col <span class="free">A</span> <span class="free">k</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> dim_row <span class="main">(</span>outer_prod <span class="main">(</span>Matrix.col <span class="free">A</span> <span class="free">j</span><span class="main">)</span> <span class="main">(</span>Matrix.col <span class="free">A</span> <span class="free">k</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="free">dimR</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms fc_mats_carrier dim_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> rw<span class="main">:</span> <span class="quoted"><span class="quoted">"dim_row <span class="main">(</span><span class="main">0</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>m</sub></span> outer_prod <span class="main">(</span>Matrix.col <span class="free">A</span> <span class="free">j</span><span class="main">)</span> <span class="main">(</span>Matrix.col <span class="free">A</span> <span class="free">k</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">dimR</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"dim_col <span class="main">(</span><span class="main">0</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>m</sub></span> outer_prod <span class="main">(</span>Matrix.col <span class="free">A</span> <span class="free">j</span><span class="main">)</span> <span class="main">(</span>Matrix.col <span class="free">A</span> <span class="free">k</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> dim_col <span class="main">(</span>outer_prod <span class="main">(</span>Matrix.col <span class="free">A</span> <span class="free">j</span><span class="main">)</span> <span class="main">(</span>Matrix.col <span class="free">A</span> <span class="free">k</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="free">dimR</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms fc_mats_carrier dim_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> cl<span class="main">:</span> <span class="quoted"><span class="quoted">"dim_col <span class="main">(</span><span class="main">0</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>m</sub></span> outer_prod <span class="main">(</span>Matrix.col <span class="free">A</span> <span class="free">j</span><span class="main">)</span> <span class="main">(</span>Matrix.col <span class="free">A</span> <span class="free">k</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">dimR</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"rank_1_proj <span class="main">(</span>Matrix.col <span class="free">A</span> <span class="free">j</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span>rank_1_proj <span class="main">(</span>Matrix.col <span class="free">A</span> <span class="free">k</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
      <span class="main">(</span><span class="main">0</span><span class="main">::</span>complex<span class="main">)</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>m</sub></span> <span class="main">(</span>outer_prod <span class="main">(</span>Matrix.col <span class="free">A</span> <span class="free">j</span><span class="main">)</span> <span class="main">(</span>Matrix.col <span class="free">A</span> <span class="free">k</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms rank_1_proj_unitary <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">0<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">dimR</span> <span class="free">dimR</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"dim_row <span class="main">(</span><span class="main">0</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>m</sub></span> outer_prod <span class="main">(</span>Matrix.col <span class="free">A</span> <span class="free">j</span><span class="main">)</span> <span class="main">(</span>Matrix.col <span class="free">A</span> <span class="free">k</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> dim_row <span class="main">(</span><span class="keyword1">0<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">dimR</span> <span class="free">dimR</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> rw <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"dim_col <span class="main">(</span><span class="main">0</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>m</sub></span> outer_prod <span class="main">(</span>Matrix.col <span class="free">A</span> <span class="free">j</span><span class="main">)</span> <span class="main">(</span>Matrix.col <span class="free">A</span> <span class="free">k</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> dim_col <span class="main">(</span><span class="keyword1">0<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">dimR</span> <span class="free">dimR</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> cl <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span> <span class="bound">p</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> dim_row <span class="main">(</span><span class="keyword1">0<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">dimR</span> <span class="free">dimR</span><span class="main">)</span> <span class="main">⟹</span> <span class="bound">p</span> <span class="main">&lt;</span> dim_col <span class="main">(</span><span class="keyword1">0<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">dimR</span> <span class="free">dimR</span><span class="main">)</span> <span class="main">⟹</span> 
      <span class="main">(</span><span class="main">0</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>m</sub></span> outer_prod <span class="main">(</span>Matrix.col <span class="free">A</span> <span class="free">j</span><span class="main">)</span> <span class="main">(</span>Matrix.col <span class="free">A</span> <span class="free">k</span><span class="main">)</span><span class="main">)</span> <span class="main">$$</span> <span class="main">(</span><span class="bound">i</span><span class="main">,</span> <span class="bound">p</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">0<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">dimR</span> <span class="free">dimR</span> <span class="main">$$</span> <span class="main">(</span><span class="bound">i</span><span class="main">,</span> <span class="bound">p</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> rw cl <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> cpx_sq_mat<span class="main">)</span> rank_1_proj_unitary_eq<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">∈</span> <span class="free">fc_mats</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"Complex_Matrix.unitary <span class="free">A</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">&lt;</span> <span class="free">dimR</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"rank_1_proj <span class="main">(</span>Matrix.col <span class="free">A</span> <span class="free">j</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span>rank_1_proj <span class="main">(</span>Matrix.col <span class="free">A</span> <span class="free">j</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>  rank_1_proj <span class="main">(</span>Matrix.col <span class="free">A</span> <span class="free">j</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"rank_1_proj <span class="main">(</span>Matrix.col <span class="free">A</span> <span class="free">j</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span>rank_1_proj <span class="main">(</span>Matrix.col <span class="free">A</span> <span class="free">j</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">1</span><span class="main">::</span>complex<span class="main">)</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>m</sub></span> <span class="main">(</span>rank_1_proj <span class="main">(</span>Matrix.col <span class="free">A</span> <span class="free">j</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms rank_1_proj_unitary <span class="keyword1"><span class="command">unfolding</span></span> rank_1_proj_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span>rank_1_proj <span class="main">(</span>Matrix.col <span class="free">A</span> <span class="free">j</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> smult_one<span class="main">)</span>  
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>
  

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="Projective_Measurements">
<div class="head">
<h1>Theory Projective_Measurements</h1>
</div>
<pre class="source"><span class="comment1">(*
Author: 
  Mnacho Echenim, Université Grenoble Alpes
*)</span>

<span class="keyword1"><span class="command">theory</span></span> Projective_Measurements <span class="keyword2"><span class="keyword">imports</span></span> 
  <a href="#Linear_Algebra_Complements">Linear_Algebra_Complements</a>


<span class="keyword2"><span class="keyword">begin</span></span>
  

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Projective measurements›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹In this part we define projective measurements, also refered to as von Neumann measurements. 
  The latter are characterized by a set of orthogonal projectors, which are used to compute the 
probabilities of measure outcomes and to represent the state of the system after the measurement.›</span></span> 

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The state of the system (a density operator in this case) after a measurement is represented by 
the \verb+density_collapse+ function.›</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹First definitions›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We begin by defining a type synonym for couples of measurement values (reals) and the 
associated projectors (complex matrices).›</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> measure_outcome <span class="main">=</span> <span class="quoted"><span class="quoted">"real <span class="main">×</span> complex Matrix.mat"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The corresponding values and projectors are retrieved thanks to \verb+meas_outcome_val+ 
and \verb+meas_outcome_prj+.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">meas_outcome_val</span><span class="main">::</span><span class="quoted"><span class="quoted">"measure_outcome <span class="main">⇒</span> real"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">meas_outcome_val</span> <span class="free"><span class="bound"><span class="entity">Mi</span></span></span> <span class="main">=</span> fst <span class="free"><span class="bound"><span class="entity">Mi</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">meas_outcome_prj</span><span class="main">::</span><span class="quoted"><span class="quoted">"measure_outcome <span class="main">⇒</span> complex Matrix.mat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">meas_outcome_prj</span> <span class="free"><span class="bound"><span class="entity">Mi</span></span></span> <span class="main">=</span> snd <span class="free"><span class="bound"><span class="entity">Mi</span></span></span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We define a predicate for projective measurements. A projective measurement is characterized 
by the number $p$ of possible measure outcomes, and a function $M$ mapping outcome $i$ to the 
corresponding \verb+measure_outcome+.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> cpx_sq_mat<span class="main">)</span> <span class="entity">proj_measurement</span><span class="main">::</span><span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="main">(</span>nat <span class="main">⇒</span> measure_outcome<span class="main">)</span> <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">proj_measurement</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="main">⟷</span> 
    <span class="main">(</span>inj_on <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> meas_outcome_val <span class="main">(</span><span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">{..&lt;</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">}</span><span class="main">)</span> <span class="main">∧</span> 
    <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">j</span></span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">.</span> meas_outcome_prj <span class="main">(</span><span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="bound">j</span><span class="main">)</span> <span class="main">∈</span> <span class="free">fc_mats</span> <span class="main">∧</span> 
    projector <span class="main">(</span>meas_outcome_prj <span class="main">(</span><span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> 
    <span class="main">(</span><span class="main">∀</span> <span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">.</span> <span class="main">∀</span> <span class="bound"><span class="bound">j</span></span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">.</span> <span class="bound">i</span> <span class="main">≠</span> <span class="bound">j</span> <span class="main">⟶</span> 
      meas_outcome_prj <span class="main">(</span><span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="bound">i</span><span class="main">)</span> <span class="main">*</span> meas_outcome_prj <span class="main">(</span><span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="bound">j</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">0<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">dimR</span> <span class="free">dimR</span><span class="main">)</span> <span class="main">∧</span>
    sum_mat <span class="main">(</span><span class="main">λ</span><span class="bound">j</span><span class="main">.</span> meas_outcome_prj <span class="main">(</span><span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span> <span class="main">{..&lt;</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">}</span> <span class="main">=</span> <span class="keyword1">1<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">dimR</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> cpx_sq_mat<span class="main">)</span> proj_measurement_inj<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"proj_measurement <span class="free">p</span> <span class="free">M</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"inj_on <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> meas_outcome_val <span class="main">(</span><span class="free">M</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">{..&lt;</span> <span class="free">p</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms 
  <span class="keyword1"><span class="command">unfolding</span></span> proj_measurement_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> cpx_sq_mat<span class="main">)</span> proj_measurement_carrier<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"proj_measurement <span class="free">p</span> <span class="free">M</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"meas_outcome_prj <span class="main">(</span><span class="free">M</span> <span class="free">i</span><span class="main">)</span> <span class="main">∈</span> <span class="free">fc_mats</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms 
  <span class="keyword1"><span class="command">unfolding</span></span> proj_measurement_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> cpx_sq_mat<span class="main">)</span> proj_measurement_ortho<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"proj_measurement <span class="free">p</span> <span class="free">M</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> <span class="free">p</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">&lt;</span> <span class="free">p</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span><span class="main">≠</span> <span class="free">j</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"meas_outcome_prj <span class="main">(</span><span class="free">M</span> <span class="free">i</span><span class="main">)</span> <span class="main">*</span> meas_outcome_prj <span class="main">(</span><span class="free">M</span> <span class="free">j</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">0<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">dimR</span> <span class="free">dimR</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms 
  <span class="keyword1"><span class="command">unfolding</span></span> proj_measurement_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> cpx_sq_mat<span class="main">)</span> proj_measurement_id<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"proj_measurement <span class="free">p</span> <span class="free">M</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sum_mat <span class="main">(</span><span class="main">λ</span><span class="bound">j</span><span class="main">.</span> meas_outcome_prj <span class="main">(</span><span class="free">M</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span> <span class="main">{..&lt;</span> <span class="free">p</span><span class="main">}</span> <span class="main">=</span> <span class="keyword1">1<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">dimR</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">unfolding</span></span> proj_measurement_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> cpx_sq_mat<span class="main">)</span> proj_measurement_square<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"proj_measurement <span class="free">p</span> <span class="free">M</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> <span class="free">p</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"meas_outcome_prj <span class="main">(</span><span class="free">M</span> <span class="free">i</span><span class="main">)</span> <span class="main">∈</span> <span class="free">fc_mats</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> proj_measurement_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> cpx_sq_mat<span class="main">)</span> proj_measurement_proj<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"proj_measurement <span class="free">p</span> <span class="free">M</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> <span class="free">p</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"projector <span class="main">(</span>meas_outcome_prj <span class="main">(</span><span class="free">M</span> <span class="free">i</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> proj_measurement_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We define the probability of obtaining a measurement outcome: this is a positive number and
the sum over all the measurement outcomes is 1.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> cpx_sq_mat<span class="main">)</span> <span class="entity">meas_outcome_prob</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"complex Matrix.mat <span class="main">⇒</span> 
  <span class="main">(</span>nat <span class="main">⇒</span> real <span class="main">×</span> complex Matrix.mat<span class="main">)</span> <span class="main">⇒</span> nat <span class="main">⇒</span> complex"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">meas_outcome_prob</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> Complex_Matrix.trace <span class="main">(</span><span class="free"><span class="bound"><span class="entity">R</span></span></span><span class="main">*</span> <span class="main">(</span>meas_outcome_prj <span class="main">(</span><span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> cpx_sq_mat<span class="main">)</span> meas_outcome_prob_real<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">R</span><span class="main">∈</span> <span class="free">fc_mats</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"density_operator <span class="free">R</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"proj_measurement <span class="free">n</span> <span class="free">M</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"meas_outcome_prob <span class="free">R</span> <span class="free">M</span> <span class="free">i</span> <span class="main">∈</span> <span class="main">ℝ</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"complex_of_real <span class="main">(</span>Re <span class="main">(</span>Complex_Matrix.trace <span class="main">(</span><span class="free">R</span> <span class="main">*</span> meas_outcome_prj <span class="main">(</span><span class="free">M</span> <span class="free">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
    Complex_Matrix.trace <span class="main">(</span><span class="free">R</span> <span class="main">*</span> meas_outcome_prj <span class="main">(</span><span class="free">M</span> <span class="free">i</span><span class="main">)</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> trace_proj_pos_real<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="main">∈</span> carrier_mat <span class="free">dimR</span> <span class="free">dimR</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms fc_mats_carrier dim_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Complex_Matrix.positive <span class="free">R</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> density_operator_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"projector <span class="main">(</span>meas_outcome_prj <span class="main">(</span><span class="free">M</span> <span class="free">i</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms proj_measurement_proj <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"meas_outcome_prj <span class="main">(</span><span class="free">M</span> <span class="free">i</span><span class="main">)</span> <span class="main">∈</span> carrier_mat <span class="free">dimR</span> <span class="free">dimR</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms proj_measurement_carrier
        fc_mats_carrier dim_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> meas_outcome_prob_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Reals_of_real<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> cpx_sq_mat<span class="main">)</span> meas_outcome_prob_pos<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">R</span><span class="main">∈</span> <span class="free">fc_mats</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"density_operator <span class="free">R</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"proj_measurement <span class="free">n</span> <span class="free">M</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> meas_outcome_prob <span class="free">R</span> <span class="free">M</span> <span class="free">i</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> meas_outcome_prob_def
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> positive_proj_trace<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="main">∈</span> carrier_mat <span class="free">dimR</span> <span class="free">dimR</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms fc_mats_carrier dim_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Complex_Matrix.positive <span class="free">R</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> density_operator_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"projector <span class="main">(</span>meas_outcome_prj <span class="main">(</span><span class="free">M</span> <span class="free">i</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms proj_measurement_proj <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"meas_outcome_prj <span class="main">(</span><span class="free">M</span> <span class="free">i</span><span class="main">)</span> <span class="main">∈</span> carrier_mat <span class="free">dimR</span> <span class="free">dimR</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms proj_measurement_carrier
      fc_mats_carrier dim_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> cpx_sq_mat<span class="main">)</span> meas_outcome_prob_sum<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"density_operator <span class="free">R</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">R</span><span class="main">∈</span> <span class="free">fc_mats</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span><span class="quoted"><span class="quoted">" proj_measurement <span class="free">n</span> <span class="free">M</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span> <span class="bound">j</span> <span class="main">∈</span> <span class="main">{..&lt;</span> <span class="free">n</span><span class="main">}</span><span class="main">.</span> meas_outcome_prob <span class="free">R</span> <span class="free">M</span> <span class="bound">j</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span>  
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span> <span class="bound">j</span> <span class="main">∈</span> <span class="main">{..&lt;</span> <span class="free">n</span><span class="main">}</span><span class="main">.</span> Complex_Matrix.trace <span class="main">(</span><span class="free">R</span><span class="main">*</span> <span class="main">(</span>meas_outcome_prj <span class="main">(</span><span class="free">M</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
    Complex_Matrix.trace <span class="main">(</span>sum_mat <span class="main">(</span><span class="main">λ</span><span class="bound">j</span><span class="main">.</span> <span class="free">R</span><span class="main">*</span> <span class="main">(</span>meas_outcome_prj <span class="main">(</span><span class="free">M</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">{..&lt;</span> <span class="free">n</span><span class="main">}</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> trace_sum_mat<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">j</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="main">*</span> meas_outcome_prj <span class="main">(</span><span class="free">M</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">∈</span> <span class="free">fc_mats</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> cpx_sq_mat_mult assms 
      <span class="keyword1"><span class="command">unfolding</span></span> proj_measurement_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> Complex_Matrix.trace <span class="main">(</span><span class="free">R</span> <span class="main">*</span> <span class="main">(</span>sum_mat <span class="main">(</span><span class="main">λ</span><span class="bound">j</span><span class="main">.</span> <span class="main">(</span>meas_outcome_prj <span class="main">(</span><span class="free">M</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">{..&lt;</span> <span class="free">n</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sum_mat <span class="main">(</span><span class="main">λ</span><span class="bound">j</span><span class="main">.</span> <span class="free">R</span><span class="main">*</span> <span class="main">(</span>meas_outcome_prj <span class="main">(</span><span class="free">M</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">{..&lt;</span> <span class="free">n</span><span class="main">}</span> <span class="main">=</span> 
      <span class="free">R</span> <span class="main">*</span> <span class="main">(</span>sum_mat <span class="main">(</span><span class="main">λ</span><span class="bound">j</span><span class="main">.</span> <span class="main">(</span>meas_outcome_prj <span class="main">(</span><span class="free">M</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">{..&lt;</span> <span class="free">n</span><span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> mult_sum_mat_distrib_left<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main">)</span><span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">j</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"meas_outcome_prj <span class="main">(</span><span class="free">M</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">∈</span> <span class="free">fc_mats</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> proj_measurement_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> Complex_Matrix.trace <span class="main">(</span><span class="free">R</span> <span class="main">*</span> <span class="keyword1">1<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">dimR</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> proj_measurement_def 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> Complex_Matrix.trace <span class="free">R</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fc_mats_carrier dim_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> density_operator_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> meas_outcome_prob_def <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We introduce the maximally mixed density operator. Intuitively, this density operator 
corresponds to a uniform distribution of the states of an orthonormal basis.
This operator will be used to define the density operator after a measurement for the measure 
outcome probabilities equal to zero.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">max_mix_density</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> complex Matrix.mat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">max_mix_density</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="main">1</span><span class="main">::</span>real<span class="main">)</span><span class="main">/</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span>  <span class="keyword1">⋅<span class="hidden">⇩</span><sub>m</sub></span> <span class="main">(</span><span class="keyword1">1<span class="hidden">⇩</span><sub>m</sub></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Projective_Measurements-max_mix_density_carrier"><span class="command">lemma</span></span> max_mix_density_carrier<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"max_mix_density <span class="free">n</span> <span class="main">∈</span> carrier_mat <span class="free">n</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> max_mix_density_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Projective_Measurements-max_mix_is_density"><span class="command">lemma</span></span> max_mix_is_density<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"density_operator <span class="main">(</span>max_mix_density <span class="free">n</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> density_operator_def max_mix_density_def
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Complex_Matrix.trace <span class="main">(</span>complex_of_real <span class="main">(</span><span class="main">(</span><span class="main">1</span><span class="main">::</span>real<span class="main">)</span><span class="main">/</span><span class="free">n</span><span class="main">)</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>m</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">n</span><span class="main">)</span> <span class="main">=</span> 
    <span class="main">(</span>complex_of_real <span class="main">(</span><span class="main">(</span><span class="main">1</span><span class="main">::</span>real<span class="main">)</span><span class="main">/</span><span class="free">n</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span>  <span class="main">(</span>Complex_Matrix.trace <span class="main">(</span><span class="main">(</span><span class="keyword1">1<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">n</span><span class="main">)</span><span class="main">::</span>complex Matrix.mat<span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> one_carrier_mat trace_smult<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">1<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">n</span><span class="main">)</span><span class="main">::</span>complex Matrix.mat"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span>complex_of_real <span class="main">(</span><span class="main">(</span><span class="main">1</span><span class="main">::</span>real<span class="main">)</span><span class="main">/</span><span class="free">n</span><span class="main">)</span><span class="main">)</span>  <span class="main">*</span> <span class="main">(</span>real <span class="free">n</span><span class="main">)</span>"</span></span>  <span class="keyword1"><span class="command">using</span></span> trace_1<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">n</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Complex_Matrix.trace <span class="main">(</span>complex_of_real <span class="main">(</span><span class="main">(</span><span class="main">1</span><span class="main">::</span>real<span class="main">)</span><span class="main">/</span><span class="free">n</span><span class="main">)</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>m</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">n</span><span class="main">)</span> <span class="main">=</span>  <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Complex_Matrix.positive <span class="main">(</span>complex_of_real <span class="main">(</span><span class="main">1</span> <span class="main">/</span> real <span class="free">n</span><span class="main">)</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>m</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">n</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> positive_smult<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> positive_one<span class="main">)</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>
  
<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> cpx_sq_mat<span class="main">)</span> max_mix_density_square<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"max_mix_density <span class="free">dimR</span> <span class="main">∈</span> <span class="free">fc_mats</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> max_mix_density_def 
  <span class="keyword1"><span class="command">using</span></span> fc_mats_carrier dim_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Given a measurement outcome, \verb+density_collapse+ represents the resulting density 
operator. In practice only the measure outcomes with nonzero probabilities are of interest; we 
(arbitrarily) collapse the density operator for zero-probability outcomes to the maximally mixed 
density operator.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">density_collapse</span> <span class="main">::</span><span class="quoted"><span class="quoted">"complex Matrix.mat <span class="main">⇒</span> complex Matrix.mat <span class="main">⇒</span> complex Matrix.mat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">density_collapse</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="main">(</span><span class="main">(</span>Complex_Matrix.trace <span class="main">(</span><span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">*</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span> <span class="keyword1">then</span> <span class="main">(</span>max_mix_density <span class="main">(</span>dim_row <span class="free"><span class="bound"><span class="entity">R</span></span></span><span class="main">)</span><span class="main">)</span> 
    <span class="keyword1">else</span> <span class="main">(</span><span class="main">(</span><span class="main">1</span><span class="main">::</span>real<span class="main">)</span><span class="main">/</span> <span class="main">(</span><span class="main">(</span>Complex_Matrix.trace <span class="main">(</span><span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">*</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>m</sub></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">*</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">*</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Projective_Measurements-density_collapse_carrier"><span class="command">lemma</span></span>  density_collapse_carrier<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> dim_row <span class="free">R</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">∈</span> carrier_mat <span class="free">n</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="main">∈</span> carrier_mat <span class="free">n</span> <span class="free">n</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>density_collapse <span class="free">R</span> <span class="free">P</span><span class="main">)</span> <span class="main">∈</span> carrier_mat <span class="free">n</span> <span class="free">n</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Complex_Matrix.trace <span class="main">(</span><span class="free">R</span> <span class="main">*</span> <span class="free">P</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"density_collapse <span class="free">R</span> <span class="free">P</span> <span class="main">=</span> max_mix_density <span class="main">(</span>dim_row <span class="free">R</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> density_collapse_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> max_mix_is_density assms max_mix_density_carrier <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"density_collapse <span class="free">R</span> <span class="free">P</span> <span class="main">=</span> complex_of_real <span class="main">1</span> <span class="main">/</span> Complex_Matrix.trace <span class="main">(</span><span class="free">R</span> <span class="main">*</span> <span class="free">P</span><span class="main">)</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>m</sub></span> <span class="main">(</span><span class="free">P</span> <span class="main">*</span> <span class="free">R</span> <span class="main">*</span> <span class="free">P</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">unfolding</span></span> density_collapse_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Projective_Measurements-density_collapse_operator"><span class="command">lemma</span></span>  density_collapse_operator<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"projector <span class="free">P</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"density_operator <span class="free">R</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> dim_row <span class="free">R</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">∈</span> carrier_mat <span class="free">n</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="main">∈</span> carrier_mat <span class="free">n</span> <span class="free">n</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"density_operator <span class="main">(</span>density_collapse <span class="free">R</span> <span class="free">P</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Complex_Matrix.trace <span class="main">(</span><span class="free">R</span> <span class="main">*</span> <span class="free">P</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"density_collapse <span class="free">R</span> <span class="free">P</span> <span class="main">=</span> max_mix_density <span class="main">(</span>dim_row <span class="free">R</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> density_collapse_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> max_mix_is_density assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> density_operator_def
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> conjI<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Complex_Matrix.positive <span class="main">(</span><span class="main">(</span><span class="main">1</span> <span class="main">/</span> <span class="main">(</span>Complex_Matrix.trace <span class="main">(</span><span class="free">R</span> <span class="main">*</span> <span class="free">P</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>m</sub></span> <span class="main">(</span><span class="free">P</span> <span class="main">*</span> <span class="free">R</span> <span class="main">*</span> <span class="free">P</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> positive_smult<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">*</span> <span class="free">R</span> <span class="main">*</span> <span class="free">P</span> <span class="main">∈</span> carrier_mat <span class="free">n</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Complex_Matrix.positive <span class="free">R</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> density_operator_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="main">(</span>Complex_Matrix.trace <span class="main">(</span><span class="free">R</span> <span class="main">*</span> <span class="free">P</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span>  positive_proj_trace<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">P</span></span> <span class="quoted"><span class="free">R</span></span> <span class="quoted"><span class="free">n</span></span><span class="main">]</span> assms 
          False <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> Re <span class="main">(</span>Complex_Matrix.trace <span class="main">(</span><span class="free">R</span> <span class="main">*</span> <span class="free">P</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="main">1</span><span class="main">/</span><span class="main">(</span>Re <span class="main">(</span>Complex_Matrix.trace <span class="main">(</span><span class="free">R</span> <span class="main">*</span> <span class="free">P</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Re <span class="main">(</span>Complex_Matrix.trace <span class="main">(</span><span class="free">R</span> <span class="main">*</span> <span class="free">P</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Complex_Matrix.trace <span class="main">(</span><span class="free">R</span> <span class="main">*</span> <span class="free">P</span><span class="main">)</span>"</span></span> 
        <span class="keyword1"><span class="command">using</span></span> assms <span class="quoted"><span class="quoted">‹Complex_Matrix.positive <span class="free">R</span>›</span></span> trace_proj_pos_real <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">hence</span></span> inv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">1</span><span class="main">/</span> <span class="main">(</span>Complex_Matrix.trace <span class="main">(</span><span class="free">R</span> <span class="main">*</span> <span class="free">P</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span><span class="main">/</span><span class="main">(</span>Re <span class="main">(</span>Complex_Matrix.trace <span class="main">(</span><span class="free">R</span> <span class="main">*</span> <span class="free">P</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="main">1</span><span class="main">/</span> <span class="main">(</span>Complex_Matrix.trace <span class="main">(</span><span class="free">R</span> <span class="main">*</span> <span class="free">P</span><span class="main">)</span><span class="main">)</span>"</span></span> 
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">0</span> <span class="main">≤</span> <span class="main">1</span><span class="main">/</span><span class="main">(</span>Re <span class="main">(</span>Complex_Matrix.trace <span class="main">(</span><span class="free">R</span> <span class="main">*</span> <span class="free">P</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inv<span class="main">)</span> 
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Complex_Matrix.positive <span class="main">(</span><span class="free">P</span> <span class="main">*</span> <span class="free">R</span> <span class="main">*</span> <span class="free">P</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms 
          positive_close_under_left_right_mult_adjoint<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">P</span></span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="free">R</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹Complex_Matrix.positive <span class="free">R</span>›</span></span> hermitian_def projector_def<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"Complex_Matrix.positive <span class="main">(</span>density_collapse <span class="free">R</span> <span class="free">P</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> False 
      <span class="keyword1"><span class="command">unfolding</span></span> density_collapse_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Complex_Matrix.trace <span class="main">(</span>density_collapse <span class="free">R</span> <span class="free">P</span><span class="main">)</span> <span class="main">=</span> 
      Complex_Matrix.trace <span class="main">(</span><span class="main">(</span><span class="main">1</span><span class="main">/</span> <span class="main">(</span>Complex_Matrix.trace <span class="main">(</span><span class="free">R</span> <span class="main">*</span> <span class="free">P</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>m</sub></span> <span class="main">(</span><span class="free">P</span> <span class="main">*</span> <span class="free">R</span> <span class="main">*</span> <span class="free">P</span><span class="main">)</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> False <span class="keyword1"><span class="command">unfolding</span></span> density_collapse_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">1</span><span class="main">/</span> <span class="main">(</span>Complex_Matrix.trace <span class="main">(</span><span class="free">R</span> <span class="main">*</span> <span class="free">P</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> Complex_Matrix.trace <span class="main">(</span><span class="free">P</span> <span class="main">*</span> <span class="free">R</span> <span class="main">*</span> <span class="free">P</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> trace_smult<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">*</span> <span class="free">R</span> <span class="main">*</span> <span class="free">P</span>"</span></span> <span class="quoted"><span class="free">n</span></span><span class="main">]</span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">1</span><span class="main">/</span> <span class="main">(</span>Complex_Matrix.trace <span class="main">(</span><span class="free">R</span> <span class="main">*</span> <span class="free">P</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> Complex_Matrix.trace <span class="main">(</span><span class="free">R</span> <span class="main">*</span> <span class="free">P</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> projector_collapse_trace assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> False <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Complex_Matrix.trace <span class="main">(</span>density_collapse <span class="free">R</span> <span class="free">P</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Measurements with observables›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹It is standard in quantum mechanics to represent projective measurements with so-called 
\emph{observables}. These are Hermitian matrices which encode projective measurements as follows: 
the eigenvalues of an observable represent the possible projective measurement outcomes, and the 
associated projectors are the projectors onto the corresponding eigenspaces. The results in this 
part are based on the spectral theorem, which states that any Hermitian matrix admits an 
orthonormal basis consisting of eigenvectors of the matrix.›</span></span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹On the diagonal elements of a matrix›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We begin by introducing definitions that will be used on the diagonalized version of a 
Hermitian matrix.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">diag_elems</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">diag_elems</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">=</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">$$</span><span class="main">(</span><span class="bound">i</span><span class="main">,</span><span class="bound">i</span><span class="main">)</span> <span class="main">|</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> dim_row <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Relationship between \verb+diag_elems+ and the list \verb+diag_mat+›</span></span>

<span class="keyword1" id="Projective_Measurements-diag_elems_set_diag_mat"><span class="command">lemma</span></span> diag_elems_set_diag_mat<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"diag_elems <span class="free">B</span> <span class="main">=</span> set <span class="main">(</span>diag_mat <span class="free">B</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> diag_mat_def diag_elems_def 
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">B</span> <span class="main">$$</span> <span class="main">(</span><span class="bound">i</span><span class="main">,</span> <span class="bound">i</span><span class="main">)</span> <span class="main">|</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> dim_row <span class="free">B</span><span class="main">}</span> <span class="main">⊆</span> set <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="free">B</span> <span class="main">$$</span> <span class="main">(</span><span class="bound">i</span><span class="main">,</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>dim_row <span class="free">B</span><span class="main">]</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">{</span><span class="free">B</span> <span class="main">$$</span> <span class="main">(</span><span class="bound">i</span><span class="main">,</span> <span class="bound">i</span><span class="main">)</span> <span class="main">|</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> dim_row <span class="free">B</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> dim_row <span class="free">B</span><span class="main">.</span> <span class="skolem">x</span> <span class="main">=</span> <span class="free">B</span> <span class="main">$$</span><span class="main">(</span><span class="bound">i</span><span class="main">,</span><span class="bound">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> dim_row <span class="free">B</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="free">B</span> <span class="main">$$</span><span class="main">(</span><span class="skolem">i</span><span class="main">,</span><span class="skolem">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> set <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="free">B</span> <span class="main">$$</span> <span class="main">(</span><span class="bound">i</span><span class="main">,</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>dim_row <span class="free">B</span><span class="main">]</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="free">B</span> <span class="main">$$</span> <span class="main">(</span><span class="bound">i</span><span class="main">,</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>dim_row <span class="free">B</span><span class="main">]</span><span class="main">)</span> <span class="main">⊆</span> <span class="main">{</span><span class="free">B</span> <span class="main">$$</span> <span class="main">(</span><span class="bound">i</span><span class="main">,</span> <span class="bound">i</span><span class="main">)</span> <span class="main">|</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> dim_row <span class="free">B</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> set <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="free">B</span> <span class="main">$$</span> <span class="main">(</span><span class="bound">i</span><span class="main">,</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>dim_row <span class="free">B</span><span class="main">]</span><span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">{</span><span class="free">B</span> <span class="main">$$</span> <span class="main">(</span><span class="bound">i</span><span class="main">,</span> <span class="bound">i</span><span class="main">)</span> <span class="main">|</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> dim_row <span class="free">B</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Projective_Measurements-diag_elems_finite"><span class="command">lemma</span></span> diag_elems_finite<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>diag_elems <span class="free">B</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> diag_elems_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Projective_Measurements-diag_elems_mem"><span class="command">lemma</span></span> diag_elems_mem<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> dim_row <span class="free">B</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">B</span> <span class="main">$$</span><span class="main">(</span><span class="free">i</span><span class="main">,</span><span class="free">i</span><span class="main">)</span> <span class="main">∈</span> diag_elems <span class="free">B</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> diag_elems_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹When $x$ is a diagonal element of $B$,  \verb+diag_elem_indices+ returns the set of diagonal
indices of $B$ with value $x$.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">diag_elem_indices</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">diag_elem_indices</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">=</span> <span class="main">{</span><span class="bound">i</span><span class="main">|</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> dim_row <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">$$</span> <span class="main">(</span><span class="bound">i</span><span class="main">,</span><span class="bound">i</span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">}</span>"</span></span>

<span class="keyword1" id="Projective_Measurements-diag_elem_indices_elem"><span class="command">lemma</span></span> diag_elem_indices_elem<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> diag_elem_indices <span class="free">x</span> <span class="free">B</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">&lt;</span> dim_row <span class="free">B</span> <span class="main">∧</span> <span class="free">B</span><span class="main">$$</span><span class="main">(</span><span class="free">a</span><span class="main">,</span><span class="free">a</span><span class="main">)</span> <span class="main">=</span> <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> diag_elem_indices_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Projective_Measurements-diag_elem_indices_itself"><span class="command">lemma</span></span> diag_elem_indices_itself<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> dim_row <span class="free">B</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">∈</span> diag_elem_indices <span class="main">(</span><span class="free">B</span> <span class="main">$$</span><span class="main">(</span><span class="free">i</span><span class="main">,</span><span class="free">i</span><span class="main">)</span><span class="main">)</span> <span class="free">B</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> diag_elem_indices_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Projective_Measurements-diag_elem_indices_finite"><span class="command">lemma</span></span> diag_elem_indices_finite<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>diag_elem_indices <span class="free">x</span> <span class="free">B</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> diag_elem_indices_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We can therefore partition the diagonal indices of a matrix $B$ depending on the value
of the diagonal elements. If $B$ admits $p$ elements on its diagonal, then we define bijections 
between its set of diagonal elements and the initial segment $[0..p-1]$.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">dist_el_card</span> <span class="keyword2"><span class="keyword">where</span></span> 
<span class="quoted"><span class="quoted">"<span class="free">dist_el_card</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">=</span> card <span class="main">(</span>diag_elems <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">diag_idx_to_el</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">diag_idx_to_el</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">SOME</span> <span class="bound">h</span><span class="main">.</span> bij_betw <span class="bound">h</span> <span class="main">{..&lt;</span> dist_el_card <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">}</span> <span class="main">(</span>diag_elems <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">diag_el_to_idx</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">diag_el_to_idx</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">=</span> inv_into <span class="main">{..&lt;</span> dist_el_card <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">}</span> <span class="main">(</span>diag_idx_to_el <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Projective_Measurements-diag_idx_to_el_bij"><span class="command">lemma</span></span> diag_idx_to_el_bij<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"bij_betw <span class="main">(</span>diag_idx_to_el <span class="free">B</span><span class="main">)</span> <span class="main">{..&lt;</span> dist_el_card <span class="free">B</span><span class="main">}</span> <span class="main">(</span>diag_elems <span class="free">B</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?V</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="keyword1">SOME</span> <span class="bound">h</span><span class="main">.</span> bij_betw <span class="bound">h</span> <span class="main">{..&lt;</span> dist_el_card <span class="free">B</span><span class="main">}</span> <span class="main">(</span>diag_elems <span class="free">B</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> vprop<span class="main">:</span> <span class="quoted"><span class="quoted">"bij_betw <span class="var">?V</span> <span class="main">{..&lt;</span> dist_el_card <span class="free">B</span><span class="main">}</span> <span class="main">(</span>diag_elems <span class="free">B</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 
      someI_ex<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">h</span><span class="main">.</span> bij_betw <span class="bound">h</span> <span class="main">{..&lt;</span> dist_el_card <span class="free">B</span><span class="main">}</span> <span class="main">(</span>diag_elems <span class="free">B</span><span class="main">)</span>"</span></span><span class="main">]</span>
     diag_elems_finite  <span class="keyword1"><span class="command">unfolding</span></span> dist_el_card_def <span class="keyword1"><span class="command">using</span></span> bij_betw_from_nat_into_finite <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>diag_idx_to_el_def vprop<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Projective_Measurements-diag_el_to_idx_bij"><span class="command">lemma</span></span> diag_el_to_idx_bij<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"bij_betw <span class="main">(</span>diag_el_to_idx <span class="free">B</span><span class="main">)</span> <span class="main">(</span>diag_elems <span class="free">B</span><span class="main">)</span> <span class="main">{..&lt;</span> dist_el_card <span class="free">B</span><span class="main">}</span>"</span></span> 
  <span class="keyword1"><span class="command">unfolding</span></span> diag_el_to_idx_def 
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> bij_betw_inv_into_subset<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted">"diag_elems <span class="free"><span class="free">B</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> diag_idx_to_el_bij<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"diag_idx_to_el <span class="free">B</span> <span class="main">`</span> <span class="main">{..&lt;</span>dist_el_card <span class="free">B</span><span class="main">}</span> <span class="main">=</span> diag_elems <span class="free">B</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> diag_idx_to_el_bij bij_betw_imp_surj_on<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Projective_Measurements-diag_idx_to_el_less_inj"><span class="command">lemma</span></span> diag_idx_to_el_less_inj<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> dist_el_card <span class="free">B</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">&lt;</span> dist_el_card <span class="free">B</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"diag_idx_to_el <span class="free">B</span> <span class="free">i</span> <span class="main">=</span> diag_idx_to_el <span class="free">B</span> <span class="free">j</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">=</span> <span class="free">j</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">∈</span> <span class="main">{..&lt;</span> dist_el_card <span class="free">B</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span><span class="main">∈</span> <span class="main">{..&lt;</span> dist_el_card <span class="free">B</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"inj_on <span class="main">(</span>diag_idx_to_el <span class="free">B</span><span class="main">)</span> <span class="main">{..&lt;</span>dist_el_card <span class="free">B</span><span class="main">}</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> diag_idx_to_el_bij<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">B</span></span><span class="main">]</span> 
    <span class="keyword1"><span class="command">unfolding</span></span> bij_betw_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> inj_on_contraD<span class="main">)</span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Projective_Measurements-diag_idx_to_el_less_surj"><span class="command">lemma</span></span> diag_idx_to_el_less_surj<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main">∈</span> diag_elems <span class="free">B</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">k</span> <span class="main">∈</span> <span class="main">{..&lt;</span> dist_el_card <span class="free">B</span><span class="main">}</span><span class="main">.</span> <span class="free">x</span> <span class="main">=</span> diag_idx_to_el <span class="free">B</span> <span class="bound">k</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"diag_idx_to_el <span class="free">B</span> <span class="main">`</span> <span class="main">{..&lt;</span>dist_el_card <span class="free">B</span><span class="main">}</span> <span class="main">=</span> diag_elems <span class="free">B</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> diag_idx_to_el_bij<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">B</span></span><span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> bij_betw_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Projective_Measurements-diag_idx_to_el_img"><span class="command">lemma</span></span> diag_idx_to_el_img<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">&lt;</span> dist_el_card <span class="free">B</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"diag_idx_to_el <span class="free">B</span> <span class="free">k</span> <span class="main">∈</span> diag_elems <span class="free">B</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"diag_idx_to_el <span class="free">B</span> <span class="main">`</span> <span class="main">{..&lt;</span>dist_el_card <span class="free">B</span><span class="main">}</span> <span class="main">=</span> diag_elems <span class="free">B</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> diag_idx_to_el_bij<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">B</span></span><span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> bij_betw_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Projective_Measurements-diag_elems_real"><span class="command">lemma</span></span> diag_elems_real<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">B</span><span class="main">::</span><span class="quoted"><span class="quoted">"complex Matrix.mat"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> dim_row <span class="free">B</span><span class="main">.</span> <span class="free">B</span><span class="main">$$</span><span class="main">(</span><span class="bound">i</span><span class="main">,</span><span class="bound">i</span><span class="main">)</span> <span class="main">∈</span> Reals"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"diag_elems <span class="free">B</span> <span class="main">⊆</span> Reals"</span></span> 
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span><span class="main">∈</span> diag_elems <span class="free">B</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> dim_row <span class="free">B</span><span class="main">.</span> <span class="skolem">x</span> <span class="main">=</span> <span class="free">B</span> <span class="main">$$</span><span class="main">(</span><span class="bound">i</span><span class="main">,</span><span class="bound">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> diag_elems_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> dim_row <span class="free">B</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="free">B</span> <span class="main">$$</span> <span class="main">(</span><span class="skolem">i</span><span class="main">,</span><span class="skolem">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> Reals"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Projective_Measurements-diag_elems_Re"><span class="command">lemma</span></span> diag_elems_Re<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">B</span><span class="main">::</span><span class="quoted"><span class="quoted">"complex Matrix.mat"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> <span class="main">(</span>dim_row <span class="free">B</span><span class="main">)</span><span class="main">.</span> <span class="free">B</span><span class="main">$$</span><span class="main">(</span><span class="bound">i</span><span class="main">,</span><span class="bound">i</span><span class="main">)</span> <span class="main">∈</span> Reals"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span>Re <span class="bound">x</span><span class="main">|</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span><span class="main">∈</span> diag_elems <span class="free">B</span><span class="main">}</span> <span class="main">=</span> diag_elems <span class="free">B</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span>complex_of_real <span class="main">(</span>Re <span class="bound">x</span><span class="main">)</span> <span class="main">|</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> diag_elems <span class="free">B</span><span class="main">}</span> <span class="main">⊆</span> diag_elems <span class="free">B</span>"</span></span> 
  <span class="keyword1"><span class="command">proof</span></span> 
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">{</span>complex_of_real <span class="main">(</span>Re <span class="bound">x</span><span class="main">)</span> <span class="main">|</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> diag_elems <span class="free">B</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">y</span> <span class="main">∈</span> diag_elems <span class="free">B</span><span class="main">.</span> <span class="skolem">x</span> <span class="main">=</span> Re <span class="bound">y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span><span class="main">∈</span> diag_elems <span class="free">B</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> Re <span class="skolem">y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">=</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms diag_elems_real<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">B</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span><span class="main">∈</span> diag_elems <span class="free">B</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">y</span><span class="main">∈</span> diag_elems <span class="free">B</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"diag_elems <span class="free">B</span> <span class="main">⊆</span> <span class="main">{</span>complex_of_real <span class="main">(</span>Re <span class="bound">x</span><span class="main">)</span> <span class="main">|</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> diag_elems <span class="free">B</span><span class="main">}</span>"</span></span> 
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> diag_elems <span class="free">B</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"Re <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms diag_elems_real<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">B</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span><span class="main">∈</span> <span class="main">{</span>complex_of_real <span class="main">(</span>Re <span class="bound">x</span><span class="main">)</span> <span class="main">|</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> diag_elems <span class="free">B</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span><span class="main">∈</span> diag_elems <span class="free">B</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Projective_Measurements-diag_idx_to_el_real"><span class="command">lemma</span></span>  diag_idx_to_el_real<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">B</span><span class="main">::</span><span class="quoted"><span class="quoted">"complex Matrix.mat"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> dim_row <span class="free">B</span><span class="main">.</span> <span class="free">B</span><span class="main">$$</span><span class="main">(</span><span class="bound">i</span><span class="main">,</span><span class="bound">i</span><span class="main">)</span> <span class="main">∈</span> Reals"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> dist_el_card <span class="free">B</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Re <span class="main">(</span>diag_idx_to_el <span class="free">B</span> <span class="free">i</span><span class="main">)</span> <span class="main">=</span> diag_idx_to_el <span class="free">B</span> <span class="free">i</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"diag_idx_to_el <span class="free">B</span> <span class="free">i</span> <span class="main">∈</span> diag_elems <span class="free">B</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> diag_idx_to_el_img<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">B</span></span><span class="main">]</span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"diag_idx_to_el <span class="free">B</span> <span class="free">i</span> <span class="main">∈</span> Reals"</span></span> <span class="keyword1"><span class="command">using</span></span> diag_elems_real<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">B</span></span><span class="main">]</span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Projective_Measurements-diag_elem_indices_empty"><span class="command">lemma</span></span> diag_elem_indices_empty<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">B</span> <span class="main">∈</span> carrier_mat <span class="free">dimR</span> <span class="free">dimC</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> <span class="main">(</span>dist_el_card <span class="free">B</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">&lt;</span> <span class="main">(</span>dist_el_card <span class="free">B</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span><span class="main">≠</span> <span class="free">j</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"diag_elem_indices <span class="main">(</span>diag_idx_to_el <span class="free">B</span> <span class="free">i</span><span class="main">)</span> <span class="free">B</span> <span class="main">∩</span> 
  <span class="main">(</span>diag_elem_indices <span class="main">(</span>diag_idx_to_el <span class="free">B</span> <span class="free">j</span><span class="main">)</span> <span class="free">B</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"diag_elem_indices <span class="main">(</span>diag_idx_to_el <span class="free">B</span> <span class="free">i</span><span class="main">)</span> <span class="free">B</span> <span class="main">∩</span> 
    diag_elem_indices <span class="main">(</span>diag_idx_to_el <span class="free">B</span> <span class="free">j</span><span class="main">)</span> <span class="free">B</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span><span class="main">∈</span> diag_elem_indices <span class="main">(</span>diag_idx_to_el <span class="free">B</span> <span class="free">i</span><span class="main">)</span> <span class="free">B</span> <span class="main">∩</span> 
    diag_elem_indices <span class="main">(</span>diag_idx_to_el <span class="free">B</span> <span class="free">j</span><span class="main">)</span> <span class="free">B</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
    xprop<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span><span class="main">∈</span> diag_elem_indices <span class="main">(</span>diag_idx_to_el <span class="free">B</span> <span class="free">i</span><span class="main">)</span> <span class="free">B</span> <span class="main">∩</span> 
    diag_elem_indices <span class="main">(</span>diag_idx_to_el <span class="free">B</span> <span class="free">j</span><span class="main">)</span> <span class="free">B</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">B</span> <span class="main">$$</span> <span class="main">(</span><span class="skolem">x</span><span class="main">,</span><span class="skolem">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>diag_idx_to_el <span class="free">B</span> <span class="free">i</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> diag_elem_indices_elem<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">x</span></span> <span class="quoted"><span class="quoted">"diag_idx_to_el <span class="free">B</span> <span class="free">i</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">B</span> <span class="main">$$</span> <span class="main">(</span><span class="skolem">x</span><span class="main">,</span><span class="skolem">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>diag_idx_to_el <span class="free">B</span> <span class="free">j</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> diag_elem_indices_elem<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">x</span></span> <span class="quoted"><span class="quoted">"diag_idx_to_el <span class="free">B</span> <span class="free">j</span>"</span></span><span class="main">]</span> xprop <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"diag_idx_to_el <span class="free">B</span> <span class="free">i</span> <span class="main">=</span> diag_idx_to_el <span class="free">B</span> <span class="free">j</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">=</span> <span class="free">j</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> diag_idx_to_el_less_inj assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> cpx_sq_mat<span class="main">)</span> diag_elem_indices_disjoint<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">B</span><span class="main">∈</span> carrier_mat <span class="free">dimR</span> <span class="free">dimC</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"disjoint_family_on <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> diag_elem_indices <span class="main">(</span>diag_idx_to_el <span class="free">B</span> <span class="bound">n</span><span class="main">)</span> <span class="free">B</span><span class="main">)</span> 
    <span class="main">{..&lt;</span>dist_el_card <span class="free">B</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> disjoint_family_on_def 
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> ballI impI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">p</span> <span class="skolem">m</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span><span class="main">∈</span> <span class="main">{..&lt;</span> dist_el_card <span class="free">B</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span><span class="main">∈</span> <span class="main">{..&lt;</span> dist_el_card <span class="free">B</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span><span class="main">≠</span> <span class="skolem">p</span>"</span></span>      
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"diag_elem_indices <span class="main">(</span>diag_idx_to_el <span class="free">B</span> <span class="skolem">m</span><span class="main">)</span> <span class="free">B</span> <span class="main">∩</span> 
    diag_elem_indices <span class="main">(</span>diag_idx_to_el <span class="free">B</span> <span class="skolem">p</span><span class="main">)</span> <span class="free">B</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> diag_elem_indices_empty  assms fc_mats_carrier <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Projective_Measurements-diag_elem_indices_union"><span class="command">lemma</span></span> diag_elem_indices_union<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">B</span><span class="main">∈</span> carrier_mat <span class="free">dimR</span> <span class="free">dimC</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋃</span> <span class="bound">i</span> <span class="main">∈</span> <span class="main">{..&lt;</span> dist_el_card <span class="free">B</span><span class="main">}</span><span class="main">.</span> diag_elem_indices <span class="main">(</span>diag_idx_to_el <span class="free">B</span> <span class="bound">i</span><span class="main">)</span> <span class="free">B</span><span class="main">)</span> <span class="main">=</span> 
    <span class="main">{..&lt;</span> <span class="free">dimR</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋃</span><span class="bound">i</span><span class="main">&lt;</span>dist_el_card <span class="free">B</span><span class="main">.</span> diag_elem_indices <span class="main">(</span>diag_idx_to_el <span class="free">B</span> <span class="bound">i</span><span class="main">)</span> <span class="free">B</span><span class="main">)</span> <span class="main">⊆</span> <span class="main">{..&lt;</span><span class="free">dimR</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> 
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">i</span><span class="main">&lt;</span>dist_el_card <span class="free">B</span><span class="main">.</span> diag_elem_indices <span class="main">(</span>diag_idx_to_el <span class="free">B</span> <span class="bound">i</span><span class="main">)</span> <span class="free">B</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> dist_el_card <span class="free">B</span><span class="main">.</span> <span class="skolem">x</span><span class="main">∈</span> diag_elem_indices <span class="main">(</span>diag_idx_to_el <span class="free">B</span> <span class="bound">i</span><span class="main">)</span> <span class="free">B</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> dist_el_card <span class="free">B</span>"</span></span> 
      <span class="quoted"><span class="quoted">"<span class="skolem">x</span><span class="main">∈</span> diag_elem_indices <span class="main">(</span>diag_idx_to_el <span class="free">B</span> <span class="skolem">i</span><span class="main">)</span> <span class="free">B</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">&lt;</span> <span class="free">dimR</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> diag_elem_indices_elem<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">x</span></span> <span class="main">_</span> <span class="quoted"><span class="free">B</span></span><span class="main">]</span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">{..&lt;</span> <span class="free">dimR</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">{..&lt;</span><span class="free">dimR</span><span class="main">}</span> <span class="main">⊆</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">i</span><span class="main">&lt;</span>dist_el_card <span class="free">B</span><span class="main">.</span> diag_elem_indices <span class="main">(</span>diag_idx_to_el <span class="free">B</span> <span class="bound">i</span><span class="main">)</span> <span class="free">B</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">j</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span><span class="main">∈</span> <span class="main">{..&lt;</span> <span class="free">dimR</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> dim_row <span class="free">B</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">B</span><span class="main">$$</span><span class="main">(</span><span class="skolem">j</span><span class="main">,</span><span class="skolem">j</span><span class="main">)</span> <span class="main">∈</span> diag_elems <span class="free">B</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">k</span> <span class="main">∈</span> <span class="main">{..&lt;</span> dist_el_card <span class="free">B</span><span class="main">}</span><span class="main">.</span> <span class="free">B</span><span class="main">$$</span><span class="main">(</span><span class="skolem">j</span><span class="main">,</span><span class="skolem">j</span><span class="main">)</span> <span class="main">=</span> diag_idx_to_el <span class="free">B</span> <span class="bound">k</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> diag_idx_to_el_less_surj<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">B</span> <span class="main">$$</span><span class="main">(</span><span class="skolem">j</span><span class="main">,</span><span class="skolem">j</span><span class="main">)</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> kprop<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">∈</span> <span class="main">{..&lt;</span> dist_el_card <span class="free">B</span><span class="main">}</span>"</span></span> 
      <span class="quoted"><span class="quoted">"<span class="free">B</span><span class="main">$$</span><span class="main">(</span><span class="skolem">j</span><span class="main">,</span><span class="skolem">j</span><span class="main">)</span> <span class="main">=</span> diag_idx_to_el <span class="free">B</span> <span class="skolem">k</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">∈</span> diag_elem_indices <span class="main">(</span>diag_idx_to_el <span class="free">B</span> <span class="skolem">k</span><span class="main">)</span> <span class="free">B</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">j</span> <span class="main">&lt;</span> dim_row <span class="free">B</span>›</span></span> 
        diag_elem_indices_itself <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span> 
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">∈</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">i</span><span class="main">&lt;</span>dist_el_card <span class="free">B</span><span class="main">.</span> diag_elem_indices <span class="main">(</span>diag_idx_to_el <span class="free">B</span> <span class="bound">i</span><span class="main">)</span> <span class="free">B</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> kprop <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Construction of measurement outcomes›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The construction of a projective measurement for a hermitian matrix $A$ is based on the Schur
decomposition $A = U*B*U^\dagger$, where $B$ is diagonal and $U$ is unitary. The columns of $U$ are
normalized and pairwise orthogonal; they are used to construct the projectors associated with
a measurement value›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> cpx_sq_mat<span class="main">)</span> <span class="entity">project_vecs</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">project_vecs</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">::</span>nat <span class="main">⇒</span> complex Matrix.vec<span class="main">)</span> <span class="free"><span class="bound"><span class="entity">N</span></span></span> <span class="main">=</span> sum_mat <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> rank_1_proj <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">N</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> cpx_sq_mat<span class="main">)</span> project_vecs_dim<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span> <span class="main">∈</span> <span class="free">N</span><span class="main">.</span> dim_vec <span class="main">(</span><span class="free">f</span> <span class="bound">i</span><span class="main">)</span> <span class="main">=</span> <span class="free">dimR</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"project_vecs <span class="free">f</span> <span class="free">N</span> <span class="main">∈</span> <span class="free">fc_mats</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"project_vecs <span class="free">f</span> <span class="free">N</span> <span class="main">∈</span> carrier_mat <span class="free">dimR</span> <span class="free">dimC</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> project_vecs_def 
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> sum_mat_carrier<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∈</span> <span class="free">N</span> <span class="main">⟹</span> rank_1_proj <span class="main">(</span><span class="free">f</span> <span class="bound">i</span><span class="main">)</span> <span class="main">∈</span> <span class="free">fc_mats</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms fc_mats_carrier rank_1_proj_dim
      dim_eq rank_1_proj_carrier <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> fc_mats_carrier <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> cpx_sq_mat<span class="main">)</span> <span class="entity">mk_meas_outcome</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">mk_meas_outcome</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="free"><span class="bound"><span class="entity">U</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="main">(</span>Re <span class="main">(</span>diag_idx_to_el <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="bound">i</span><span class="main">)</span><span class="main">,</span> 
  project_vecs <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> zero_col <span class="free"><span class="bound"><span class="entity">U</span></span></span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span>diag_elem_indices <span class="main">(</span>diag_idx_to_el <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="bound">i</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> cpx_sq_mat<span class="main">)</span> mk_meas_outcome_carrier<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"Complex_Matrix.unitary <span class="free">U</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">U</span> <span class="main">∈</span> <span class="free">fc_mats</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">B</span><span class="main">∈</span> <span class="free">fc_mats</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"meas_outcome_prj <span class="main">(</span><span class="main">(</span>mk_meas_outcome <span class="free">B</span> <span class="free">U</span><span class="main">)</span> <span class="free">j</span><span class="main">)</span> <span class="main">∈</span> <span class="free">fc_mats</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"project_vecs <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> zero_col <span class="free">U</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span>diag_elem_indices <span class="main">(</span>diag_idx_to_el <span class="free">B</span> <span class="free">j</span><span class="main">)</span> <span class="free">B</span><span class="main">)</span> <span class="main">∈</span> <span class="free">fc_mats</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> project_vecs_dim <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> zero_col_dim<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> mk_meas_outcome_def meas_outcome_prj_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> cpx_sq_mat<span class="main">)</span> mk_meas_outcome_sum_id<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"Complex_Matrix.unitary <span class="free">U</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">U</span> <span class="main">∈</span> <span class="free">fc_mats</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">B</span><span class="main">∈</span> <span class="free">fc_mats</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sum_mat <span class="main">(</span><span class="main">λ</span><span class="bound">j</span><span class="main">.</span> meas_outcome_prj <span class="main">(</span><span class="main">(</span>mk_meas_outcome <span class="free">B</span> <span class="free">U</span><span class="main">)</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span> 
  <span class="main">{..&lt;</span><span class="main">(</span>dist_el_card <span class="free">B</span><span class="main">)</span><span class="main">}</span> <span class="main">=</span> <span class="keyword1">1<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">dimR</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sum_mat <span class="main">(</span><span class="main">λ</span><span class="bound">j</span><span class="main">.</span> meas_outcome_prj <span class="main">(</span><span class="main">(</span>mk_meas_outcome <span class="free">B</span> <span class="free">U</span><span class="main">)</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span> <span class="main">{..&lt;</span><span class="main">(</span>dist_el_card <span class="free">B</span><span class="main">)</span><span class="main">}</span> <span class="main">=</span>
    sum_mat <span class="main">(</span><span class="main">λ</span><span class="bound">j</span><span class="main">.</span> project_vecs <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> zero_col <span class="free">U</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span>diag_elem_indices <span class="main">(</span>diag_idx_to_el <span class="free">B</span> <span class="bound">j</span><span class="main">)</span> <span class="free">B</span><span class="main">)</span><span class="main">)</span> 
    <span class="main">{..&lt;</span><span class="main">(</span>dist_el_card <span class="free">B</span><span class="main">)</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> mk_meas_outcome_def meas_outcome_prj_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> sum_mat <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> rank_1_proj <span class="main">(</span>zero_col <span class="free">U</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> 
    <span class="main">(</span><span class="main">⋃</span><span class="bound">j</span><span class="main">&lt;</span>dist_el_card <span class="free">B</span><span class="main">.</span> diag_elem_indices <span class="main">(</span>diag_idx_to_el <span class="free">B</span> <span class="bound">j</span><span class="main">)</span> <span class="free">B</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">unfolding</span></span> project_vecs_def sum_mat_def
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> disj_family_sum_with<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">j</span><span class="main">.</span> rank_1_proj <span class="main">(</span>zero_col <span class="free">U</span> <span class="bound">j</span><span class="main">)</span> <span class="main">∈</span> <span class="free">fc_mats</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> zero_col_dim fc_mats_carrier dim_eq
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> rank_1_proj_carrier<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">{..&lt;</span>dist_el_card <span class="free">B</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> 
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∈</span> <span class="main">{..&lt;</span>dist_el_card <span class="free">B</span><span class="main">}</span> <span class="main">⟹</span> finite <span class="main">(</span>diag_elem_indices <span class="main">(</span>diag_idx_to_el <span class="free">B</span> <span class="bound">i</span><span class="main">)</span> <span class="free">B</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> diag_elem_indices_finite <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"disjoint_family_on <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> diag_elem_indices <span class="main">(</span>diag_idx_to_el <span class="free">B</span> <span class="bound">n</span><span class="main">)</span> <span class="free">B</span><span class="main">)</span> 
      <span class="main">{..&lt;</span>dist_el_card <span class="free">B</span><span class="main">}</span>"</span></span> 
      <span class="keyword1"><span class="command">unfolding</span></span> disjoint_family_on_def 
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> ballI impI<span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">p</span> <span class="skolem">m</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span><span class="main">∈</span> <span class="main">{..&lt;</span> dist_el_card <span class="free">B</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span><span class="main">∈</span> <span class="main">{..&lt;</span> dist_el_card <span class="free">B</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span><span class="main">≠</span> <span class="skolem">p</span>"</span></span>      
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"diag_elem_indices <span class="main">(</span>diag_idx_to_el <span class="free">B</span> <span class="skolem">m</span><span class="main">)</span> <span class="free">B</span> <span class="main">∩</span> 
        diag_elem_indices <span class="main">(</span>diag_idx_to_el <span class="free">B</span> <span class="skolem">p</span><span class="main">)</span> <span class="free">B</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> 
        <span class="keyword1"><span class="command">using</span></span> diag_elem_indices_empty  assms fc_mats_carrier <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> sum_mat <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> rank_1_proj <span class="main">(</span>zero_col <span class="free">U</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">{..&lt;</span> <span class="free">dimR</span><span class="main">}</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> diag_elem_indices_union<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">B</span></span><span class="main">]</span> assms fc_mats_carrier <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> sum_mat <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> rank_1_proj <span class="main">(</span>Matrix.col <span class="free">U</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">{..&lt;</span> <span class="free">dimR</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> sum_mat_cong<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∈</span> <span class="main">{..&lt;</span><span class="free">dimR</span><span class="main">}</span> <span class="main">⟹</span> rank_1_proj <span class="main">(</span>zero_col <span class="free">U</span> <span class="bound">i</span><span class="main">)</span> <span class="main">∈</span> <span class="free">fc_mats</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> dim_eq
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> local.fc_mats_carrier rank_1_proj_carrier zero_col_dim<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∈</span> <span class="main">{..&lt;</span><span class="free">dimR</span><span class="main">}</span> <span class="main">⟹</span> rank_1_proj <span class="main">(</span>Matrix.col <span class="free">U</span> <span class="bound">i</span><span class="main">)</span> <span class="main">∈</span> <span class="free">fc_mats</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> dim_eq
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> lessThan_iff zero_col_col<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∈</span> <span class="main">{..&lt;</span><span class="free">dimR</span><span class="main">}</span> <span class="main">⟹</span> rank_1_proj <span class="main">(</span>zero_col <span class="free">U</span> <span class="bound">i</span><span class="main">)</span> <span class="main">=</span> rank_1_proj <span class="main">(</span>Matrix.col <span class="free">U</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> zero_col_col<span class="main">)</span> 
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="keyword1">1<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">dimR</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> sum_rank_1_proj_unitary assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> cpx_sq_mat<span class="main">)</span> make_meas_outcome_prj_ortho<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"Complex_Matrix.unitary <span class="free">U</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">U</span> <span class="main">∈</span> <span class="free">fc_mats</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">B</span><span class="main">∈</span> <span class="free">fc_mats</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> dist_el_card <span class="free">B</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">&lt;</span> dist_el_card <span class="free">B</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≠</span> <span class="free">j</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"meas_outcome_prj <span class="main">(</span><span class="main">(</span>mk_meas_outcome <span class="free">B</span> <span class="free">U</span><span class="main">)</span> <span class="free">i</span><span class="main">)</span> <span class="main">*</span> 
  meas_outcome_prj <span class="main">(</span><span class="main">(</span>mk_meas_outcome <span class="free">B</span> <span class="free">U</span><span class="main">)</span> <span class="free">j</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">0<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">dimR</span> <span class="free">dimR</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">Pi</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Pi</span> <span class="main">=</span> sum_mat <span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> rank_1_proj <span class="main">(</span>zero_col <span class="free">U</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span> 
    <span class="main">(</span>diag_elem_indices <span class="main">(</span>diag_idx_to_el <span class="free">B</span> <span class="free">i</span><span class="main">)</span> <span class="free">B</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">have</span></span> sneqi<span class="main">:</span> <span class="quoted"><span class="quoted">"meas_outcome_prj <span class="main">(</span>mk_meas_outcome <span class="free">B</span> <span class="free">U</span> <span class="free">i</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">Pi</span>"</span></span> 
    <span class="keyword1"><span class="command">unfolding</span></span> mk_meas_outcome_def project_vecs_def Pi_def meas_outcome_prj_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">Pj</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Pj</span> <span class="main">=</span> sum_mat <span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> rank_1_proj <span class="main">(</span>zero_col <span class="free">U</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span> 
    <span class="main">(</span>diag_elem_indices <span class="main">(</span>diag_idx_to_el <span class="free">B</span> <span class="free">j</span><span class="main">)</span> <span class="free">B</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">have</span></span> sneqj<span class="main">:</span> <span class="quoted"><span class="quoted">"meas_outcome_prj <span class="main">(</span>mk_meas_outcome <span class="free">B</span> <span class="free">U</span> <span class="free">j</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">Pj</span>"</span></span>      
    <span class="keyword1"><span class="command">unfolding</span></span> mk_meas_outcome_def project_vecs_def Pj_def meas_outcome_prj_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Pi</span> <span class="main">*</span> <span class="skolem">Pj</span> <span class="main">=</span> <span class="keyword1">0<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">dimR</span> <span class="free">dimR</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> Pi_def
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> sum_mat_left_ortho_zero<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>diag_elem_indices <span class="main">(</span>diag_idx_to_el <span class="free">B</span> <span class="free">i</span><span class="main">)</span> <span class="free">B</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> diag_elem_indices_finite<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="free">B</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">show</span></span> km<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">k</span><span class="main">.</span> <span class="bound">k</span> <span class="main">∈</span> diag_elem_indices <span class="main">(</span>diag_idx_to_el <span class="free">B</span> <span class="free">i</span><span class="main">)</span> <span class="free">B</span> <span class="main">⟹</span> 
      rank_1_proj <span class="main">(</span>zero_col <span class="free">U</span> <span class="bound">k</span><span class="main">)</span> <span class="main">∈</span> <span class="free">fc_mats</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> zero_col_dim assms fc_mats_carrier dim_eq 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> rank_1_proj_carrier<span class="main">)</span> 
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Pj</span> <span class="main">∈</span> <span class="free">fc_mats</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> sneqj assms mk_meas_outcome_carrier <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">k</span><span class="main">.</span> <span class="bound">k</span> <span class="main">∈</span> diag_elem_indices <span class="main">(</span>diag_idx_to_el <span class="free">B</span> <span class="free">i</span><span class="main">)</span> <span class="free">B</span> <span class="main">⟹</span> 
      rank_1_proj <span class="main">(</span>zero_col <span class="free">U</span> <span class="bound">k</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">Pj</span> <span class="main">=</span> <span class="keyword1">0<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">dimR</span> <span class="free">dimR</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">k</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">∈</span> diag_elem_indices <span class="main">(</span>diag_idx_to_el <span class="free">B</span> <span class="free">i</span><span class="main">)</span> <span class="free">B</span>"</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"rank_1_proj <span class="main">(</span>zero_col <span class="free">U</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">Pj</span> <span class="main">=</span> <span class="keyword1">0<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">dimR</span> <span class="free">dimR</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> Pj_def
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> sum_mat_right_ortho_zero<span class="main">)</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>diag_elem_indices <span class="main">(</span>diag_idx_to_el <span class="free">B</span> <span class="free">j</span><span class="main">)</span> <span class="free">B</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> diag_elem_indices_finite<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="free">B</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∈</span> diag_elem_indices <span class="main">(</span>diag_idx_to_el <span class="free">B</span> <span class="free">j</span><span class="main">)</span> <span class="free">B</span> <span class="main">⟹</span> 
          rank_1_proj <span class="main">(</span>zero_col <span class="free">U</span> <span class="bound">i</span><span class="main">)</span> <span class="main">∈</span> <span class="free">fc_mats</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> zero_col_dim assms fc_mats_carrier dim_eq 
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> rank_1_proj_carrier<span class="main">)</span> 
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"rank_1_proj <span class="main">(</span>zero_col <span class="free">U</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">∈</span> <span class="free">fc_mats</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> km <span class="quoted"><span class="quoted">‹<span class="skolem">k</span> <span class="main">∈</span> diag_elem_indices <span class="main">(</span>diag_idx_to_el <span class="free">B</span> <span class="free">i</span><span class="main">)</span> <span class="free">B</span>›</span></span><span class="main">)</span> 
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∈</span> diag_elem_indices <span class="main">(</span>diag_idx_to_el <span class="free">B</span> <span class="free">j</span><span class="main">)</span> <span class="free">B</span> <span class="main">⟹</span>
         rank_1_proj <span class="main">(</span>zero_col <span class="free">U</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">*</span> rank_1_proj <span class="main">(</span>zero_col <span class="free">U</span> <span class="bound">i</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">0<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">dimR</span> <span class="free">dimR</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
          <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">m</span>
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">∈</span> diag_elem_indices <span class="main">(</span>diag_idx_to_el <span class="free">B</span> <span class="free">j</span><span class="main">)</span> <span class="free">B</span>"</span></span>
          <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">≠</span> <span class="skolem">k</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">k</span> <span class="main">∈</span> diag_elem_indices <span class="main">(</span>diag_idx_to_el <span class="free">B</span> <span class="free">i</span><span class="main">)</span> <span class="free">B</span>›</span></span> 
            diag_elem_indices_disjoint<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">B</span></span><span class="main">]</span> fc_mats_carrier assms <span class="keyword1"><span class="command">unfolding</span></span> disjoint_family_on_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∈</span> diag_elem_indices <span class="main">(</span>diag_idx_to_el <span class="free">B</span> <span class="free">j</span><span class="main">)</span> <span class="free">B</span> <span class="main">⟹</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="free">dimR</span>"</span></span> 
            <span class="keyword1"><span class="command">using</span></span> diag_elem_indices_elem fc_mats_carrier assms dim_eq <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> carrier_matD<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span> 
          <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">&lt;</span> <span class="free">dimR</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">m</span> <span class="main">∈</span> diag_elem_indices <span class="main">(</span>diag_idx_to_el <span class="free">B</span> <span class="free">j</span><span class="main">)</span> <span class="free">B</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">k</span><span class="main">.</span> <span class="bound">k</span> <span class="main">∈</span> diag_elem_indices <span class="main">(</span>diag_idx_to_el <span class="free">B</span> <span class="free">i</span><span class="main">)</span> <span class="free">B</span> <span class="main">⟹</span> <span class="bound">k</span> <span class="main">&lt;</span> <span class="free">dimR</span>"</span></span> 
            <span class="keyword1"><span class="command">using</span></span> diag_elem_indices_elem fc_mats_carrier assms dim_eq <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> carrier_matD<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span> 
          <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">&lt;</span> <span class="free">dimR</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">k</span> <span class="main">∈</span> diag_elem_indices <span class="main">(</span>diag_idx_to_el <span class="free">B</span> <span class="free">i</span><span class="main">)</span> <span class="free">B</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"rank_1_proj <span class="main">(</span>zero_col <span class="free">U</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">*</span> rank_1_proj <span class="main">(</span>zero_col <span class="free">U</span> <span class="skolem">m</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">0<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">dimR</span> <span class="free">dimR</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> rank_1_proj_unitary_ne<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">U</span></span> <span class="quoted"><span class="skolem">k</span></span> <span class="quoted"><span class="skolem">m</span></span><span class="main">]</span> assms <span class="quoted"><span class="quoted">‹<span class="skolem">m</span> <span class="main">&lt;</span> <span class="free">dimR</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">k</span> <span class="main">&lt;</span> <span class="free">dimR</span>›</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹<span class="skolem">m</span> <span class="main">≠</span> <span class="skolem">k</span>›</span></span> zero_col_col<span class="main">)</span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> sneqi sneqj <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> cpx_sq_mat<span class="main">)</span> make_meas_outcome_prjectors<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"Complex_Matrix.unitary <span class="free">U</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">U</span> <span class="main">∈</span> <span class="free">fc_mats</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">B</span><span class="main">∈</span> <span class="free">fc_mats</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">&lt;</span> dist_el_card <span class="free">B</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"projector <span class="main">(</span>meas_outcome_prj <span class="main">(</span><span class="main">(</span>mk_meas_outcome <span class="free">B</span> <span class="free">U</span><span class="main">)</span> <span class="free">j</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> projector_def
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">Pj</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Pj</span> <span class="main">=</span> sum_mat <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> rank_1_proj <span class="main">(</span>zero_col <span class="free">U</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> 
  <span class="main">(</span>diag_elem_indices <span class="main">(</span>diag_idx_to_el <span class="free">B</span> <span class="free">j</span><span class="main">)</span> <span class="free">B</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">have</span></span> sneq<span class="main">:</span> <span class="quoted"><span class="quoted">"meas_outcome_prj <span class="main">(</span>mk_meas_outcome <span class="free">B</span> <span class="free">U</span> <span class="free">j</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">Pj</span>"</span></span>      
    <span class="keyword1"><span class="command">unfolding</span></span> mk_meas_outcome_def project_vecs_def Pj_def meas_outcome_prj_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"hermitian <span class="skolem">Pj</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> Pj_def
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> sum_mat_hermitian<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>diag_elem_indices <span class="main">(</span>diag_idx_to_el <span class="free">B</span> <span class="free">j</span><span class="main">)</span> <span class="free">B</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> diag_elem_indices_finite<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="free">B</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">∈</span>diag_elem_indices <span class="main">(</span>diag_idx_to_el <span class="free">B</span> <span class="free">j</span><span class="main">)</span> <span class="free">B</span><span class="main">.</span> hermitian <span class="main">(</span>rank_1_proj <span class="main">(</span>zero_col <span class="free">U</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> rank_1_proj_hermitian <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">∈</span>diag_elem_indices <span class="main">(</span>diag_idx_to_el <span class="free">B</span> <span class="free">j</span><span class="main">)</span> <span class="free">B</span><span class="main">.</span> rank_1_proj <span class="main">(</span>zero_col <span class="free">U</span> <span class="bound">i</span><span class="main">)</span> <span class="main">∈</span> <span class="free">fc_mats</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> zero_col_dim fc_mats_carrier dim_eq <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> rank_1_proj_carrier<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"hermitian <span class="main">(</span>meas_outcome_prj <span class="main">(</span>mk_meas_outcome <span class="free">B</span> <span class="free">U</span> <span class="free">j</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Pj</span> <span class="main">*</span> <span class="skolem">Pj</span> <span class="main">=</span> <span class="skolem">Pj</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> Pj_def
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> sum_mat_ortho_square<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>diag_elem_indices <span class="main">(</span>diag_idx_to_el <span class="free">B</span> <span class="free">j</span><span class="main">)</span> <span class="free">B</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> diag_elem_indices_finite<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="free">B</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∈</span> diag_elem_indices <span class="main">(</span>diag_idx_to_el <span class="free">B</span> <span class="free">j</span><span class="main">)</span> <span class="free">B</span> <span class="main">⟹</span>
         rank_1_proj <span class="main">(</span>zero_col <span class="free">U</span> <span class="bound">i</span><span class="main">)</span> <span class="main">*</span> rank_1_proj <span class="main">(</span>zero_col <span class="free">U</span> <span class="bound">i</span><span class="main">)</span> <span class="main">=</span> rank_1_proj <span class="main">(</span>zero_col <span class="free">U</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span>
      <span class="keyword3"><span class="command">assume</span></span> imem<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span><span class="main">∈</span> diag_elem_indices <span class="main">(</span>diag_idx_to_el <span class="free">B</span> <span class="free">j</span><span class="main">)</span> <span class="free">B</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> <span class="free">dimR</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> diag_elem_indices_elem fc_mats_carrier assms dim_eq
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> carrier_matD<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span> 
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"zero_col <span class="free">U</span> <span class="skolem">i</span> <span class="main">=</span> Matrix.col <span class="free">U</span> <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> zero_col_col<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">i</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"rank_1_proj <span class="main">(</span>zero_col <span class="free">U</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">=</span> rank_1_proj <span class="main">(</span>Matrix.col <span class="free">U</span> <span class="skolem">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"rank_1_proj <span class="main">(</span>Matrix.col <span class="free">U</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">*</span> rank_1_proj <span class="main">(</span>Matrix.col <span class="free">U</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">=</span> 
        rank_1_proj <span class="main">(</span>Matrix.col <span class="free">U</span> <span class="skolem">i</span><span class="main">)</span>"</span></span>  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> rank_1_proj_unitary_eq<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">&lt;</span> <span class="free">dimR</span>›</span></span><span class="main">)</span><span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"rank_1_proj <span class="main">(</span>zero_col <span class="free">U</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">*</span> rank_1_proj <span class="main">(</span>zero_col <span class="free">U</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">=</span> 
        rank_1_proj <span class="main">(</span>zero_col <span class="free">U</span> <span class="skolem">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∈</span> diag_elem_indices <span class="main">(</span>diag_idx_to_el <span class="free">B</span> <span class="free">j</span><span class="main">)</span> <span class="free">B</span> <span class="main">⟹</span> 
      rank_1_proj <span class="main">(</span>zero_col <span class="free">U</span> <span class="bound">i</span><span class="main">)</span> <span class="main">∈</span> <span class="free">fc_mats</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> zero_col_dim assms fc_mats_carrier dim_eq <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> rank_1_proj_carrier<span class="main">)</span> 
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∈</span> diag_elem_indices <span class="main">(</span>diag_idx_to_el <span class="free">B</span> <span class="free">j</span><span class="main">)</span> <span class="free">B</span> <span class="main">⟹</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="free">dimR</span>"</span></span> 
        <span class="keyword1"><span class="command">using</span></span> diag_elem_indices_elem fc_mats_carrier assms dim_eq <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> carrier_matD<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span> 
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span> <span class="bound">ja</span><span class="main">.</span>
       <span class="bound">i</span> <span class="main">∈</span> diag_elem_indices <span class="main">(</span>diag_idx_to_el <span class="free">B</span> <span class="free">j</span><span class="main">)</span> <span class="free">B</span> <span class="main">⟹</span>
       <span class="bound">ja</span> <span class="main">∈</span> diag_elem_indices <span class="main">(</span>diag_idx_to_el <span class="free">B</span> <span class="free">j</span><span class="main">)</span> <span class="free">B</span> <span class="main">⟹</span>
       <span class="bound">i</span> <span class="main">≠</span> <span class="bound">ja</span> <span class="main">⟹</span> rank_1_proj <span class="main">(</span>zero_col <span class="free">U</span> <span class="bound">i</span><span class="main">)</span> <span class="main">*</span> rank_1_proj <span class="main">(</span>zero_col <span class="free">U</span> <span class="bound">ja</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">0<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">dimR</span> <span class="free">dimR</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> rank_1_proj_unitary_ne <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> zero_col_col<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"meas_outcome_prj <span class="main">(</span>mk_meas_outcome <span class="free">B</span> <span class="free">U</span> <span class="free">j</span><span class="main">)</span> <span class="main">*</span> 
    meas_outcome_prj <span class="main">(</span>mk_meas_outcome <span class="free">B</span> <span class="free">U</span> <span class="free">j</span><span class="main">)</span> <span class="main">=</span> 
    meas_outcome_prj <span class="main">(</span>mk_meas_outcome <span class="free">B</span> <span class="free">U</span> <span class="free">j</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> sneq <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> cpx_sq_mat<span class="main">)</span> mk_meas_outcome_fst_inj<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> <span class="main">(</span>dim_row <span class="free">B</span><span class="main">)</span><span class="main">.</span> <span class="free">B</span><span class="main">$$</span><span class="main">(</span><span class="bound">i</span><span class="main">,</span><span class="bound">i</span><span class="main">)</span> <span class="main">∈</span> Reals"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"inj_on <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> meas_outcome_val <span class="main">(</span><span class="main">(</span>mk_meas_outcome <span class="free">B</span> <span class="free">U</span><span class="main">)</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">{..&lt;</span>dist_el_card <span class="free">B</span><span class="main">}</span>"</span></span> 
    <span class="keyword1"><span class="command">unfolding</span></span> inj_on_def
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> ballI impI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">y</span>
  <span class="keyword3"><span class="command">assume</span></span>  <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">{..&lt;</span>dist_el_card <span class="free">B</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> <span class="main">{..&lt;</span>dist_el_card <span class="free">B</span><span class="main">}</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"meas_outcome_val <span class="main">(</span>mk_meas_outcome <span class="free">B</span> <span class="free">U</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">=</span> 
    meas_outcome_val <span class="main">(</span>mk_meas_outcome <span class="free">B</span> <span class="free">U</span> <span class="skolem">y</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">note</span></span> xy <span class="main">=</span> this
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"diag_idx_to_el <span class="free">B</span> <span class="skolem">x</span> <span class="main">=</span> Re <span class="main">(</span>diag_idx_to_el <span class="free">B</span> <span class="skolem">x</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> assms diag_idx_to_el_real <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> Re <span class="main">(</span>diag_idx_to_el <span class="free">B</span> <span class="skolem">y</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> xy 
    <span class="keyword1"><span class="command">unfolding</span></span> mk_meas_outcome_def meas_outcome_val_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> diag_idx_to_el <span class="free">B</span> <span class="skolem">y</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms diag_idx_to_el_real xy <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"diag_idx_to_el <span class="free">B</span> <span class="skolem">x</span> <span class="main">=</span> diag_idx_to_el <span class="free">B</span> <span class="skolem">y</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="skolem">y</span> "</span></span> <span class="keyword1"><span class="command">using</span></span> diag_idx_to_el_less_inj xy <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> cpx_sq_mat<span class="main">)</span> mk_meas_outcome_fst_bij<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> <span class="main">(</span>dim_row <span class="free">B</span><span class="main">)</span><span class="main">.</span> <span class="free">B</span><span class="main">$$</span><span class="main">(</span><span class="bound">i</span><span class="main">,</span><span class="bound">i</span><span class="main">)</span> <span class="main">∈</span> Reals"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"bij_betw <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> meas_outcome_val <span class="main">(</span><span class="main">(</span>mk_meas_outcome <span class="free">B</span> <span class="free">U</span><span class="main">)</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">{..&lt;</span> dist_el_card <span class="free">B</span><span class="main">}</span> 
    <span class="main">{</span>Re <span class="bound">x</span><span class="main">|</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span><span class="main">∈</span> diag_elems <span class="free">B</span><span class="main">}</span>"</span></span> 
  <span class="keyword1"><span class="command">unfolding</span></span> bij_betw_def
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"inj_on <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span>meas_outcome_val <span class="main">(</span>mk_meas_outcome <span class="free">B</span> <span class="free">U</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">{..&lt;</span>dist_el_card <span class="free">B</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms mk_meas_outcome_fst_inj <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span>  <span class="quoted"><span class="quoted">"<span class="main">{</span>Re <span class="bound">x</span><span class="main">|</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span><span class="main">∈</span> diag_elems <span class="free">B</span><span class="main">}</span> <span class="main">=</span> diag_elems <span class="free">B</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> diag_elems_Re<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">B</span></span><span class="main">]</span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"inj_on <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> meas_outcome_val <span class="main">(</span>mk_meas_outcome <span class="free">B</span> <span class="free">U</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> 
    <span class="main">{..&lt;</span>dist_el_card <span class="free">B</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> meas_outcome_val <span class="main">(</span>mk_meas_outcome <span class="free">B</span> <span class="free">U</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> <span class="main">{..&lt;</span>dist_el_card <span class="free">B</span><span class="main">}</span> <span class="main">=</span> 
    <span class="main">{</span>Re <span class="bound">x</span> <span class="main">|</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> diag_elems <span class="free">B</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> meas_outcome_val_def mk_meas_outcome_def
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> fst <span class="main">(</span>Re <span class="main">(</span>diag_idx_to_el <span class="free">B</span> <span class="bound">i</span><span class="main">)</span><span class="main">,</span> project_vecs <span class="main">(</span>zero_col <span class="free">U</span><span class="main">)</span> 
      <span class="main">(</span>diag_elem_indices <span class="main">(</span>diag_idx_to_el <span class="free">B</span> <span class="bound">i</span><span class="main">)</span> <span class="free">B</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> <span class="main">{..&lt;</span>dist_el_card <span class="free">B</span><span class="main">}</span> <span class="main">⊆</span> 
      <span class="main">{</span>Re <span class="bound">x</span> <span class="main">|</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> diag_elems <span class="free">B</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> diag_idx_to_el_bij<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">B</span></span><span class="main">]</span> bij_betw_apply <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span>Re <span class="bound">x</span> <span class="main">|</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> diag_elems <span class="free">B</span><span class="main">}</span>
    <span class="main">⊆</span> <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> fst <span class="main">(</span>Re <span class="main">(</span>diag_idx_to_el <span class="free">B</span> <span class="bound">i</span><span class="main">)</span><span class="main">,</span> 
      project_vecs <span class="main">(</span>zero_col <span class="free">U</span><span class="main">)</span> <span class="main">(</span>diag_elem_indices <span class="main">(</span>diag_idx_to_el <span class="free">B</span> <span class="bound">i</span><span class="main">)</span> <span class="free">B</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> 
      <span class="main">{..&lt;</span>dist_el_card <span class="free">B</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> diag_idx_to_el_less_surj <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Projective measurement associated with an observable›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">eigvals</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">eigvals</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">SOME</span> <span class="bound">as</span><span class="main">.</span> char_poly <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∏</span><span class="bound">a</span><span class="main">←</span><span class="bound">as</span><span class="main">.</span> <span class="main">[:</span><span class="main">-</span> <span class="bound">a</span><span class="main">,</span> <span class="main">1</span><span class="main">:]</span><span class="main">)</span> <span class="main">∧</span> length <span class="bound">as</span> <span class="main">=</span> dim_row <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Projective_Measurements-eigvals_poly_length"><span class="command">lemma</span></span> eigvals_poly_length<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">M</span><span class="main">::</span>complex Matrix.mat<span class="main">)</span> <span class="main">∈</span> carrier_mat <span class="free">n</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"char_poly <span class="free">M</span> <span class="main">=</span> <span class="main">(</span><span class="main">∏</span><span class="bound">a</span><span class="main">←</span><span class="main">(</span>eigvals <span class="free">M</span><span class="main">)</span><span class="main">.</span> <span class="main">[:</span><span class="main">-</span> <span class="bound">a</span><span class="main">,</span> <span class="main">1</span><span class="main">:]</span><span class="main">)</span> <span class="main">∧</span> length <span class="main">(</span>eigvals <span class="free">M</span><span class="main">)</span> <span class="main">=</span> dim_row <span class="free">M</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?V</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="keyword1">SOME</span> <span class="bound">as</span><span class="main">.</span> char_poly <span class="free">M</span> <span class="main">=</span> <span class="main">(</span><span class="main">∏</span><span class="bound">a</span><span class="main">←</span><span class="bound">as</span><span class="main">.</span> <span class="main">[:</span><span class="main">-</span> <span class="bound">a</span><span class="main">,</span> <span class="main">1</span><span class="main">:]</span><span class="main">)</span> <span class="main">∧</span> length <span class="bound">as</span> <span class="main">=</span> dim_row <span class="free">M</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> vprop<span class="main">:</span> <span class="quoted"><span class="quoted">"char_poly <span class="free">M</span> <span class="main">=</span> <span class="main">(</span><span class="main">∏</span><span class="bound">a</span><span class="main">←</span><span class="var">?V</span><span class="main">.</span> <span class="main">[:</span><span class="main">-</span> <span class="bound">a</span><span class="main">,</span> <span class="main">1</span><span class="main">:]</span><span class="main">)</span> <span class="main">∧</span> length <span class="var">?V</span> <span class="main">=</span> dim_row <span class="free">M</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 
      someI_ex<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">as</span><span class="main">.</span> char_poly <span class="free">M</span> <span class="main">=</span> <span class="main">(</span><span class="main">∏</span><span class="bound">a</span><span class="main">←</span><span class="bound">as</span><span class="main">.</span> <span class="main">[:</span><span class="main">-</span> <span class="bound">a</span><span class="main">,</span> <span class="main">1</span><span class="main">:]</span><span class="main">)</span> <span class="main">∧</span> length <span class="bound">as</span> <span class="main">=</span> dim_row <span class="free">M</span>"</span></span><span class="main">]</span>
     complex_mat_char_poly_factorizable assms  <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> eigvals_def vprop<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We define the spectrum of a matrix $A$: this is its set of eigenvalues; its elements are
roots of the characteristic polynomial of $A$.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">spectrum</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">spectrum</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="main">=</span> set <span class="main">(</span>eigvals <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Projective_Measurements-spectrum_finite"><span class="command">lemma</span></span> spectrum_finite<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>spectrum <span class="free">M</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> spectrum_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Projective_Measurements-spectrum_char_poly_root"><span class="command">lemma</span></span> spectrum_char_poly_root<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span><span class="main">::</span><span class="quoted"><span class="quoted">"complex Matrix.mat"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span><span class="main">∈</span> carrier_mat <span class="free">n</span> <span class="free">n</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">∈</span> spectrum <span class="free">A</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"poly <span class="main">(</span>char_poly <span class="free">A</span><span class="main">)</span> <span class="free">k</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> eigvals_poly_length<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">A</span></span> <span class="quoted"><span class="free">n</span></span><span class="main">]</span> assms
  <span class="keyword1"><span class="command">unfolding</span></span> spectrum_def  eigenvalue_root_char_poly
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> linear_poly_root<span class="main">)</span>

<span class="keyword1" id="Projective_Measurements-spectrum_eigenvalues"><span class="command">lemma</span></span> spectrum_eigenvalues<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span><span class="main">::</span><span class="quoted"><span class="quoted">"complex Matrix.mat"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span><span class="main">∈</span> carrier_mat <span class="free">n</span> <span class="free">n</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span><span class="main">∈</span> spectrum <span class="free">A</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"eigenvalue <span class="free">A</span> <span class="free">k</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> eigenvalue_root_char_poly<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">A</span></span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="free">k</span></span><span class="main">]</span> 
    spectrum_char_poly_root<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">A</span></span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="free">k</span></span><span class="main">]</span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The main result that is used to construct a projective measurement for a Hermitian matrix
is that it is always possible to decompose it as $A = U*B*U^\dagger$, where $B$ is diagonal and
only contains real elements, and $U$ is unitary.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">hermitian_decomp</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">hermitian_decomp</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="free"><span class="bound"><span class="entity">U</span></span></span> <span class="main">≡</span> similar_mat_wit <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="free"><span class="bound"><span class="entity">U</span></span></span> <span class="main">(</span>Complex_Matrix.adjoint <span class="free"><span class="bound"><span class="entity">U</span></span></span><span class="main">)</span> <span class="main">∧</span> diagonal_mat <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">∧</span> 
    diag_mat <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">=</span> <span class="main">(</span>eigvals <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span> <span class="main">∧</span> unitary <span class="free"><span class="bound"><span class="entity">U</span></span></span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> dim_row <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">$$</span><span class="main">(</span><span class="bound">i</span><span class="main">,</span> <span class="bound">i</span><span class="main">)</span> <span class="main">∈</span> Reals<span class="main">)</span>"</span></span>

<span class="keyword1" id="Projective_Measurements-hermitian_decomp_sim"><span class="command">lemma</span></span> hermitian_decomp_sim<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"hermitian_decomp <span class="free">A</span> <span class="free">B</span> <span class="free">U</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"similar_mat_wit <span class="free">A</span> <span class="free">B</span> <span class="free">U</span> <span class="main">(</span>Complex_Matrix.adjoint <span class="free">U</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms 
  <span class="keyword1"><span class="command">unfolding</span></span> hermitian_decomp_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Projective_Measurements-hermitian_decomp_diag_mat"><span class="command">lemma</span></span> hermitian_decomp_diag_mat<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"hermitian_decomp <span class="free">A</span> <span class="free">B</span> <span class="free">U</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"diagonal_mat <span class="free">B</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms 
  <span class="keyword1"><span class="command">unfolding</span></span> hermitian_decomp_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Projective_Measurements-hermitian_decomp_eigenvalues"><span class="command">lemma</span></span> hermitian_decomp_eigenvalues<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"hermitian_decomp <span class="free">A</span> <span class="free">B</span> <span class="free">U</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"diag_mat <span class="free">B</span> <span class="main">=</span> <span class="main">(</span>eigvals <span class="free">A</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms 
  <span class="keyword1"><span class="command">unfolding</span></span> hermitian_decomp_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Projective_Measurements-hermitian_decomp_unitary"><span class="command">lemma</span></span> hermitian_decomp_unitary<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"hermitian_decomp <span class="free">A</span> <span class="free">B</span> <span class="free">U</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"unitary <span class="free">U</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms 
  <span class="keyword1"><span class="command">unfolding</span></span> hermitian_decomp_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Projective_Measurements-hermitian_decomp_real_eigvals"><span class="command">lemma</span></span> hermitian_decomp_real_eigvals<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"hermitian_decomp <span class="free">A</span> <span class="free">B</span> <span class="free">U</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> dim_row <span class="free">B</span><span class="main">.</span> <span class="free">B</span><span class="main">$$</span><span class="main">(</span><span class="bound">i</span><span class="main">,</span> <span class="bound">i</span><span class="main">)</span> <span class="main">∈</span> Reals"</span></span> <span class="keyword1"><span class="command">using</span></span> assms 
  <span class="keyword1"><span class="command">unfolding</span></span> hermitian_decomp_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Projective_Measurements-hermitian_decomp_dim_carrier"><span class="command">lemma</span></span> hermitian_decomp_dim_carrier<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"hermitian_decomp <span class="free">A</span> <span class="free">B</span> <span class="free">U</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">B</span> <span class="main">∈</span> carrier_mat <span class="main">(</span>dim_row <span class="free">A</span><span class="main">)</span> <span class="main">(</span>dim_col <span class="free">A</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms 
  <span class="keyword1"><span class="command">unfolding</span></span> hermitian_decomp_def similar_mat_wit_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> index_mult_mat<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> index_one_mat<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> insert_subset<span class="main">)</span>

<span class="keyword1" id="Projective_Measurements-similar_mat_wit_dim_row"><span class="command">lemma</span></span> similar_mat_wit_dim_row<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"similar_mat_wit <span class="free">A</span> <span class="free">B</span> <span class="free">Q</span> <span class="free">R</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"dim_row <span class="free">B</span> <span class="main">=</span> dim_row <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms Let_def <span class="keyword1"><span class="command">unfolding</span></span>  similar_mat_wit_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> carrier_matD<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> insert_subset<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> cpx_sq_mat<span class="main">)</span> hermitian_schur_decomp<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"hermitian <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span><span class="main">∈</span> <span class="free">fc_mats</span>"</span></span>
<span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">B</span> <span class="free">U</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"hermitian_decomp <span class="free">A</span> <span class="free">B</span> <span class="free">U</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword1"><span class="command">have</span></span> es<span class="main">:</span> <span class="quoted"><span class="quoted">"char_poly <span class="free">A</span> <span class="main">=</span> <span class="main">(</span><span class="main">∏</span> <span class="main">(</span><span class="bound">e</span> <span class="main">::</span> complex<span class="main">)</span> <span class="main">←</span> <span class="main">(</span>eigvals <span class="free">A</span><span class="main">)</span><span class="main">.</span> <span class="main">[:</span><span class="main">-</span> <span class="bound">e</span><span class="main">,</span> <span class="main">1</span><span class="main">:]</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> assms fc_mats_carrier eigvals_poly_length dim_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">B</span></span> <span class="skolem"><span class="skolem">U</span></span> <span class="skolem"><span class="skolem">Q</span></span> <span class="keyword2"><span class="keyword">where</span></span> us<span class="main">:</span> <span class="quoted"><span class="quoted">"unitary_schur_decomposition <span class="free">A</span> <span class="main">(</span>eigvals <span class="free">A</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">B</span><span class="main">,</span><span class="skolem">U</span><span class="main">,</span><span class="skolem">Q</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"unitary_schur_decomposition <span class="free">A</span> <span class="main">(</span>eigvals <span class="free">A</span><span class="main">)</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> pr<span class="main">:</span> <span class="quoted"><span class="quoted">"similar_mat_wit <span class="free">A</span> <span class="skolem">B</span> <span class="skolem">U</span> <span class="main">(</span>Complex_Matrix.adjoint <span class="skolem">U</span><span class="main">)</span> <span class="main">∧</span> diagonal_mat <span class="skolem">B</span> <span class="main">∧</span> 
      diag_mat <span class="skolem">B</span> <span class="main">=</span> <span class="main">(</span>eigvals <span class="free">A</span><span class="main">)</span> <span class="main">∧</span> unitary <span class="skolem">U</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> <span class="free">dimR</span><span class="main">.</span> <span class="skolem">B</span><span class="main">$$</span><span class="main">(</span><span class="bound">i</span><span class="main">,</span> <span class="bound">i</span><span class="main">)</span> <span class="main">∈</span> Reals<span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> hermitian_eigenvalue_real assms fc_mats_carrier es dim_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"dim_row <span class="skolem">B</span> <span class="main">=</span> <span class="free">dimR</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms fc_mats_carrier dim_eq similar_mat_wit_dim_row<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">A</span></span><span class="main">]</span>  
        pr <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"hermitian_decomp <span class="free">A</span> <span class="skolem">B</span> <span class="skolem">U</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> hermitian_decomp_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">B</span> <span class="bound">U</span><span class="main">.</span> hermitian_decomp <span class="free">A</span> <span class="bound">B</span> <span class="bound">U</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> cpx_sq_mat<span class="main">)</span> hermitian_spectrum_real<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">∈</span> <span class="free">fc_mats</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"hermitian <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> spectrum <span class="free">A</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> Reals"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">B</span></span> <span class="skolem"><span class="skolem">U</span></span> <span class="keyword2"><span class="keyword">where</span></span> bu<span class="main">:</span> <span class="quoted"><span class="quoted">"hermitian_decomp <span class="free">A</span> <span class="skolem">B</span> <span class="skolem">U</span>"</span></span>  <span class="keyword1"><span class="command">using</span></span> assms hermitian_schur_decomp <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> dimB<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">B</span> <span class="main">∈</span> carrier_mat <span class="free">dimR</span> <span class="free">dimR</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms fc_mats_carrier 
      dim_eq hermitian_decomp_dim_carrier<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">A</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">hence</span></span>  Bii<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="free">dimR</span> <span class="main">⟹</span> <span class="skolem">B</span><span class="main">$$</span><span class="main">(</span><span class="bound">i</span><span class="main">,</span> <span class="bound">i</span><span class="main">)</span> <span class="main">∈</span> Reals"</span></span> <span class="keyword1"><span class="command">using</span></span> hermitian_decomp_real_eigvals<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">A</span></span> <span class="quoted"><span class="skolem">B</span></span> <span class="quoted"><span class="skolem">U</span></span><span class="main">]</span>
      bu assms fc_mats_carrier <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span>  <span class="quoted"><span class="quoted">"diag_mat <span class="skolem">B</span> <span class="main">=</span> <span class="main">(</span>eigvals <span class="free">A</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> bu hermitian_decomp_eigenvalues<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">A</span></span> <span class="quoted"><span class="skolem">B</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>    
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> set <span class="main">(</span>diag_mat <span class="skolem">B</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> spectrum_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> length <span class="main">(</span>diag_mat <span class="skolem">B</span><span class="main">)</span><span class="main">.</span> <span class="free">a</span> <span class="main">=</span> diag_mat <span class="skolem">B</span> <span class="main">!</span> <span class="bound">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> in_set_conv_nth<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="main">(</span>diag_mat <span class="skolem">B</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">=</span> diag_mat <span class="skolem">B</span> <span class="main">!</span> <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">=</span> <span class="skolem">B</span> <span class="main">$$</span> <span class="main">(</span><span class="skolem">i</span><span class="main">,</span><span class="skolem">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> diag_mat_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span>  <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> <span class="free">dimR</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> dimB <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="main">(</span>diag_mat <span class="skolem">B</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> diag_mat_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span>  Bii <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> cpx_sq_mat<span class="main">)</span> spectrum_ne<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span><span class="main">∈</span> <span class="free">fc_mats</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"hermitian <span class="free">A</span>"</span></span> 
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"spectrum <span class="free">A</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">B</span></span> <span class="skolem"><span class="skolem">U</span></span> <span class="keyword2"><span class="keyword">where</span></span> bu<span class="main">:</span> <span class="quoted"><span class="quoted">"hermitian_decomp <span class="free">A</span> <span class="skolem">B</span> <span class="skolem">U</span>"</span></span>  <span class="keyword1"><span class="command">using</span></span> assms hermitian_schur_decomp <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> dimB<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">B</span> <span class="main">∈</span> carrier_mat <span class="free">dimR</span> <span class="free">dimR</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms fc_mats_carrier 
      dim_eq hermitian_decomp_dim_carrier<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">A</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span>  <span class="quoted"><span class="quoted">"diag_mat <span class="skolem">B</span> <span class="main">=</span> <span class="main">(</span>eigvals <span class="free">A</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> bu hermitian_decomp_eigenvalues<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">A</span></span> <span class="quoted"><span class="skolem">B</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">B</span><span class="main">$$</span><span class="main">(</span><span class="main">0</span><span class="main">,</span><span class="main">0</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>diag_mat <span class="skolem">B</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> dimB npos <span class="keyword1"><span class="command">unfolding</span></span> diag_mat_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>diag_mat <span class="skolem">B</span><span class="main">)</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> spectrum_def <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹diag_mat <span class="skolem">B</span> <span class="main">=</span> eigvals <span class="free">A</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Projective_Measurements-unitary_hermitian_eigenvalues"><span class="command">lemma</span></span>  unitary_hermitian_eigenvalues<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">U</span><span class="main">::</span><span class="quoted"><span class="quoted">"complex Matrix.mat"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"unitary <span class="free">U</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"hermitian <span class="free">U</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">U</span> <span class="main">∈</span> carrier_mat <span class="free">n</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">∈</span> spectrum <span class="free">U</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">∈</span> <span class="main">{</span><span class="main">-</span><span class="main">1</span><span class="main">,</span> <span class="main">1</span><span class="main">}</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"cpx_sq_mat <span class="free">n</span> <span class="free">n</span> <span class="main">(</span>carrier_mat <span class="free">n</span> <span class="free">n</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eigenvalue <span class="free">U</span> <span class="free">k</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> spectrum_eigenvalues assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">∈</span> Reals"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="quoted"><span class="quoted">‹cpx_sq_mat <span class="free">n</span> <span class="free">n</span> <span class="main">(</span>carrier_mat <span class="free">n</span> <span class="free">n</span><span class="main">)</span>›</span></span> 
      cpx_sq_mat.hermitian_spectrum_real <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"conjugate <span class="free">k</span> <span class="main">=</span> <span class="free">k</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Reals_cnj_iff<span class="main">)</span> 
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> unitary_eigenvalues_norm_square<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">U</span></span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="free">k</span></span><span class="main">]</span> assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹eigenvalue <span class="free">U</span> <span class="free">k</span>›</span></span> power2_eq_square<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> power2_eq_1_iff <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Projective_Measurements-unitary_hermitian_Re_spectrum"><span class="command">lemma</span></span>  unitary_hermitian_Re_spectrum<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">U</span><span class="main">::</span><span class="quoted"><span class="quoted">"complex Matrix.mat"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"unitary <span class="free">U</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"hermitian <span class="free">U</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">U</span> <span class="main">∈</span> carrier_mat <span class="free">n</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span>Re <span class="bound">x</span><span class="main">|</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span><span class="main">∈</span> spectrum <span class="free">U</span><span class="main">}</span> <span class="main">⊆</span> <span class="main">{</span><span class="main">-</span><span class="main">1</span><span class="main">,</span><span class="main">1</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">y</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span><span class="main">∈</span> <span class="main">{</span>Re <span class="bound">x</span><span class="main">|</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span><span class="main">∈</span> spectrum <span class="free">U</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">x</span> <span class="main">∈</span> spectrum <span class="free">U</span><span class="main">.</span> <span class="skolem">y</span> <span class="main">=</span> Re <span class="bound">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span><span class="main">∈</span> spectrum <span class="free">U</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">=</span> Re <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span><span class="main">∈</span> <span class="main">{</span><span class="main">-</span><span class="main">1</span><span class="main">,</span><span class="main">1</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> unitary_hermitian_eigenvalues assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> <span class="main">{</span><span class="main">-</span><span class="main">1</span><span class="main">,</span> <span class="main">1</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">y</span> <span class="main">=</span> Re <span class="skolem">x</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The projective measurement associated with matrix $M$ is obtained from its Schur 
decomposition, by considering the number of distinct elements on the resulting diagonal matrix
and constructing the projectors associated with each of them.›</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> proj_meas_rep <span class="main">=</span> <span class="quoted"><span class="quoted">"nat <span class="main">×</span> <span class="main">(</span>nat <span class="main">⇒</span> measure_outcome<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">proj_meas_size</span><span class="main">::</span><span class="quoted"><span class="quoted">"proj_meas_rep <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">proj_meas_size</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">=</span> fst <span class="free"><span class="bound"><span class="entity">P</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">proj_meas_outcomes</span><span class="main">::</span><span class="quoted"><span class="quoted">"proj_meas_rep <span class="main">⇒</span> <span class="main">(</span>nat <span class="main">⇒</span> measure_outcome<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">proj_meas_outcomes</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">=</span> snd <span class="free"><span class="bound"><span class="entity">P</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> cpx_sq_mat<span class="main">)</span> <span class="entity">make_pm</span><span class="main">::</span><span class="quoted"><span class="quoted">"complex Matrix.mat <span class="main">⇒</span> proj_meas_rep"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">make_pm</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">let</span> <span class="main">(</span><span class="bound">B</span><span class="main">,</span><span class="bound">U</span><span class="main">,</span><span class="main"><span class="bound">_</span></span><span class="main">)</span> <span class="main">=</span> unitary_schur_decomposition <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">(</span>eigvals <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span> <span class="keyword1">in</span> 
  <span class="main">(</span>dist_el_card <span class="bound">B</span><span class="main">,</span> mk_meas_outcome <span class="bound">B</span> <span class="bound">U</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> cpx_sq_mat<span class="main">)</span> make_pm_decomp<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"make_pm <span class="free">A</span> <span class="main">=</span> <span class="main">(</span>proj_meas_size <span class="main">(</span>make_pm <span class="free">A</span><span class="main">)</span><span class="main">,</span> proj_meas_outcomes <span class="main">(</span>make_pm <span class="free">A</span><span class="main">)</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">unfolding</span></span> proj_meas_size_def proj_meas_outcomes_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> cpx_sq_mat<span class="main">)</span> make_pm_proj_measurement<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">∈</span> <span class="free">fc_mats</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"hermitian <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"make_pm <span class="free">A</span> <span class="main">=</span> <span class="main">(</span><span class="free">n</span><span class="main">,</span> <span class="free">M</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"proj_measurement <span class="free">n</span> <span class="free">M</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> es<span class="main">:</span> <span class="quoted"><span class="quoted">"char_poly <span class="free">A</span> <span class="main">=</span> <span class="main">(</span><span class="main">∏</span> <span class="main">(</span><span class="bound">e</span> <span class="main">::</span> complex<span class="main">)</span> <span class="main">←</span> <span class="main">(</span>eigvals <span class="free">A</span><span class="main">)</span><span class="main">.</span> <span class="main">[:</span><span class="main">-</span> <span class="bound">e</span><span class="main">,</span> <span class="main">1</span><span class="main">:]</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> assms fc_mats_carrier eigvals_poly_length dim_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">B</span></span> <span class="skolem"><span class="skolem">U</span></span> <span class="skolem"><span class="skolem">Q</span></span> <span class="keyword2"><span class="keyword">where</span></span> us<span class="main">:</span> <span class="quoted"><span class="quoted">"unitary_schur_decomposition <span class="free">A</span> <span class="main">(</span>eigvals <span class="free">A</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">B</span><span class="main">,</span><span class="skolem">U</span><span class="main">,</span><span class="skolem">Q</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"unitary_schur_decomposition <span class="free">A</span> <span class="main">(</span>eigvals <span class="free">A</span><span class="main">)</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"similar_mat_wit <span class="free">A</span> <span class="skolem">B</span> <span class="skolem">U</span> <span class="main">(</span>Complex_Matrix.adjoint <span class="skolem">U</span><span class="main">)</span> <span class="main">∧</span> diagonal_mat <span class="skolem">B</span> <span class="main">∧</span> 
    diag_mat <span class="skolem">B</span> <span class="main">=</span> <span class="main">(</span>eigvals <span class="free">A</span><span class="main">)</span> <span class="main">∧</span> unitary <span class="skolem">U</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> <span class="free">dimR</span><span class="main">.</span> <span class="skolem">B</span><span class="main">$$</span><span class="main">(</span><span class="bound">i</span><span class="main">,</span> <span class="bound">i</span><span class="main">)</span> <span class="main">∈</span> Reals<span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> hermitian_eigenvalue_real assms fc_mats_carrier es dim_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">=</span> <span class="skolem">U</span> <span class="main">*</span> <span class="skolem">B</span> <span class="main">*</span> <span class="main">(</span>Complex_Matrix.adjoint <span class="skolem">U</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> dB<span class="main">:</span> <span class="quoted"><span class="quoted">"diagonal_mat <span class="skolem">B</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> Bii<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="free">dimR</span> <span class="main">⟹</span> <span class="skolem">B</span><span class="main">$$</span><span class="main">(</span><span class="bound">i</span><span class="main">,</span> <span class="bound">i</span><span class="main">)</span> <span class="main">∈</span> Reals"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> dimB<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">B</span> <span class="main">∈</span> carrier_mat <span class="free">dimR</span> <span class="free">dimR</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> dimP<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">U</span> <span class="main">∈</span> carrier_mat <span class="free">dimR</span> <span class="free">dimR</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 
    dimaP<span class="main">:</span> <span class="quoted"><span class="quoted">"Complex_Matrix.adjoint <span class="skolem">U</span> <span class="main">∈</span> carrier_mat <span class="free">dimR</span> <span class="free">dimR</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> unit<span class="main">:</span> <span class="quoted"><span class="quoted">"unitary <span class="skolem">U</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> similar_mat_wit_def Let_def <span class="keyword1"><span class="command">using</span></span> assms fc_mats_carrier <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> mpeq<span class="main">:</span> <span class="quoted"><span class="quoted">"make_pm <span class="free">A</span> <span class="main">=</span> <span class="main">(</span>dist_el_card <span class="skolem">B</span><span class="main">,</span> mk_meas_outcome <span class="skolem">B</span> <span class="skolem">U</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> us Let_def 
    <span class="keyword1"><span class="command">unfolding</span></span> make_pm_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">=</span> dist_el_card <span class="skolem">B</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">=</span> mk_meas_outcome <span class="skolem">B</span> <span class="skolem">U</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms mpeq <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> proj_measurement_def
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> conjI<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"inj_on <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> meas_outcome_val <span class="main">(</span><span class="free">M</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">{..&lt;</span><span class="free">n</span><span class="main">}</span>"</span></span> 
        <span class="keyword1"><span class="command">using</span></span> mk_meas_outcome_fst_inj<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">B</span></span> <span class="quoted"><span class="skolem">U</span></span><span class="main">]</span> 
        <span class="quoted"><span class="quoted">‹<span class="free">n</span> <span class="main">=</span> dist_el_card <span class="skolem">B</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">M</span> <span class="main">=</span> mk_meas_outcome <span class="skolem">B</span> <span class="skolem">U</span>›</span></span> Bii fc_mats_carrier dimB <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">j</span></span><span class="main">&lt;</span><span class="free">n</span><span class="main">.</span> meas_outcome_prj <span class="main">(</span><span class="free">M</span> <span class="bound">j</span><span class="main">)</span> <span class="main">∈</span> <span class="free">fc_mats</span> <span class="main">∧</span> projector <span class="main">(</span>meas_outcome_prj <span class="main">(</span><span class="free">M</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> allI impI conjI<span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">j</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"meas_outcome_prj <span class="main">(</span><span class="free">M</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">∈</span> <span class="free">fc_mats</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">M</span> <span class="main">=</span> mk_meas_outcome <span class="skolem">B</span> <span class="skolem">U</span>›</span></span> assms 
          fc_mats_carrier <span class="quoted"><span class="quoted">‹<span class="skolem">j</span> <span class="main">&lt;</span> <span class="free">n</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">n</span> <span class="main">=</span> dist_el_card <span class="skolem">B</span>›</span></span> dim_eq mk_meas_outcome_carrier 
          dimB dimP unit <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"projector <span class="main">(</span>meas_outcome_prj <span class="main">(</span><span class="free">M</span> <span class="skolem">j</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> make_meas_outcome_prjectors 
          <span class="quoted"><span class="quoted">‹<span class="free">M</span> <span class="main">=</span> mk_meas_outcome <span class="skolem">B</span> <span class="skolem">U</span>›</span></span>  
          fc_mats_carrier <span class="quoted"><span class="quoted">‹<span class="free">n</span> <span class="main">=</span> dist_el_card <span class="skolem">B</span>›</span></span> unit <span class="quoted"><span class="quoted">‹<span class="skolem">j</span> <span class="main">&lt;</span> <span class="free">n</span>›</span></span> dimB dimP dim_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">i</span></span><span class="main">&lt;</span><span class="free">n</span><span class="main">.</span> <span class="main">∀</span><span class="bound"><span class="bound">j</span></span><span class="main">&lt;</span><span class="free">n</span><span class="main">.</span> <span class="bound">i</span> <span class="main">≠</span> <span class="bound">j</span> <span class="main">⟶</span> meas_outcome_prj <span class="main">(</span><span class="free">M</span> <span class="bound">i</span><span class="main">)</span> <span class="main">*</span> meas_outcome_prj <span class="main">(</span><span class="free">M</span> <span class="bound">j</span><span class="main">)</span> <span class="main">=</span> 
      <span class="keyword1">0<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">dimR</span> <span class="free">dimR</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> allI impI<span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">j</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span><span class="main">≠</span> <span class="skolem">j</span>"</span></span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"meas_outcome_prj <span class="main">(</span><span class="free">M</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">*</span> meas_outcome_prj <span class="main">(</span><span class="free">M</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">0<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">dimR</span> <span class="free">dimR</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> make_meas_outcome_prj_ortho<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">U</span></span> <span class="quoted"><span class="skolem">B</span></span> <span class="quoted"><span class="skolem">i</span></span> <span class="quoted"><span class="skolem">j</span></span><span class="main">]</span> assms dimB dimP fc_mats_carrier dim_eq
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹<span class="free">M</span> <span class="main">=</span> mk_meas_outcome <span class="skolem">B</span> <span class="skolem">U</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">n</span> <span class="main">=</span> dist_el_card <span class="skolem">B</span>›</span></span> unit<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"sum_mat <span class="main">(</span><span class="main">λ</span><span class="bound">j</span><span class="main">.</span> meas_outcome_prj <span class="main">(</span><span class="free">M</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span> <span class="main">{..&lt;</span><span class="free">n</span><span class="main">}</span> <span class="main">=</span> <span class="keyword1">1<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">dimR</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 
        mk_meas_outcome_sum_id 
        <span class="quoted"><span class="quoted">‹<span class="free">M</span> <span class="main">=</span> mk_meas_outcome <span class="skolem">B</span> <span class="skolem">U</span>›</span></span> fc_mats_carrier dim_eq <span class="quoted"><span class="quoted">‹<span class="free">n</span> <span class="main">=</span> dist_el_card <span class="skolem">B</span>›</span></span> unit  dimB dimP 
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> cpx_sq_mat<span class="main">)</span> make_pm_proj_measurement'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span><span class="main">∈</span> <span class="free">fc_mats</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"hermitian <span class="free">A</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"proj_measurement <span class="main">(</span>proj_meas_size <span class="main">(</span>make_pm <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>proj_meas_outcomes <span class="main">(</span>make_pm <span class="free">A</span><span class="main">)</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">unfolding</span></span> proj_meas_size_def proj_meas_outcomes_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> make_pm_proj_measurement<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">A</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> cpx_sq_mat<span class="main">)</span> make_pm_projectors<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span><span class="main">∈</span> <span class="free">fc_mats</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"hermitian <span class="free">A</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> proj_meas_size <span class="main">(</span>make_pm <span class="free">A</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"projector <span class="main">(</span>meas_outcome_prj <span class="main">(</span>proj_meas_outcomes <span class="main">(</span>make_pm <span class="free">A</span><span class="main">)</span> <span class="free">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"proj_measurement <span class="main">(</span>proj_meas_size <span class="main">(</span>make_pm <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>proj_meas_outcomes <span class="main">(</span>make_pm <span class="free">A</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> assms make_pm_proj_measurement' <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> proj_measurement_proj assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> cpx_sq_mat<span class="main">)</span> make_pm_square<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span><span class="main">∈</span> <span class="free">fc_mats</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"hermitian <span class="free">A</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> proj_meas_size <span class="main">(</span>make_pm <span class="free">A</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"meas_outcome_prj <span class="main">(</span>proj_meas_outcomes <span class="main">(</span>make_pm <span class="free">A</span><span class="main">)</span> <span class="free">i</span><span class="main">)</span> <span class="main">∈</span> <span class="free">fc_mats</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"proj_measurement <span class="main">(</span>proj_meas_size <span class="main">(</span>make_pm <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>proj_meas_outcomes <span class="main">(</span>make_pm <span class="free">A</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> assms make_pm_proj_measurement' <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> proj_measurement_square assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Properties on the spectrum of a  Hermitian matrix›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> cpx_sq_mat<span class="main">)</span> hermitian_schur_decomp'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"hermitian <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span><span class="main">∈</span> <span class="free">fc_mats</span>"</span></span>
<span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">B</span> <span class="free">U</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"hermitian_decomp <span class="free">A</span> <span class="free">B</span> <span class="free">U</span> <span class="main">∧</span> 
  make_pm <span class="free">A</span> <span class="main">=</span> <span class="main">(</span>dist_el_card <span class="free">B</span><span class="main">,</span> mk_meas_outcome <span class="free">B</span> <span class="free">U</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword1"><span class="command">have</span></span> es<span class="main">:</span> <span class="quoted"><span class="quoted">"char_poly <span class="free">A</span> <span class="main">=</span> <span class="main">(</span><span class="main">∏</span> <span class="main">(</span><span class="bound">e</span> <span class="main">::</span> complex<span class="main">)</span> <span class="main">←</span> <span class="main">(</span>eigvals <span class="free">A</span><span class="main">)</span><span class="main">.</span> <span class="main">[:</span><span class="main">-</span> <span class="bound">e</span><span class="main">,</span> <span class="main">1</span><span class="main">:]</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> assms fc_mats_carrier eigvals_poly_length dim_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">B</span></span> <span class="skolem"><span class="skolem">U</span></span> <span class="skolem"><span class="skolem">Q</span></span> <span class="keyword2"><span class="keyword">where</span></span> us<span class="main">:</span> <span class="quoted"><span class="quoted">"unitary_schur_decomposition <span class="free">A</span> <span class="main">(</span>eigvals <span class="free">A</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">B</span><span class="main">,</span><span class="skolem">U</span><span class="main">,</span><span class="skolem">Q</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"unitary_schur_decomposition <span class="free">A</span> <span class="main">(</span>eigvals <span class="free">A</span><span class="main">)</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> pr<span class="main">:</span> <span class="quoted"><span class="quoted">"similar_mat_wit <span class="free">A</span> <span class="skolem">B</span> <span class="skolem">U</span> <span class="main">(</span>Complex_Matrix.adjoint <span class="skolem">U</span><span class="main">)</span> <span class="main">∧</span> diagonal_mat <span class="skolem">B</span> <span class="main">∧</span> 
      diag_mat <span class="skolem">B</span> <span class="main">=</span> <span class="main">(</span>eigvals <span class="free">A</span><span class="main">)</span> <span class="main">∧</span> unitary <span class="skolem">U</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> <span class="free">dimR</span><span class="main">.</span> <span class="skolem">B</span><span class="main">$$</span><span class="main">(</span><span class="bound">i</span><span class="main">,</span> <span class="bound">i</span><span class="main">)</span> <span class="main">∈</span> Reals<span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> hermitian_eigenvalue_real assms fc_mats_carrier es dim_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"dim_row <span class="skolem">B</span> <span class="main">=</span> <span class="free">dimR</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms fc_mats_carrier dim_eq similar_mat_wit_dim_row<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">A</span></span><span class="main">]</span>  
        pr <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"hermitian_decomp <span class="free">A</span> <span class="skolem">B</span> <span class="skolem">U</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> hermitian_decomp_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span>  <span class="quoted"><span class="quoted">"make_pm <span class="free">A</span> <span class="main">=</span> <span class="main">(</span>dist_el_card <span class="skolem">B</span><span class="main">,</span> mk_meas_outcome <span class="skolem">B</span> <span class="skolem">U</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> us Let_def 
      <span class="keyword1"><span class="command">unfolding</span></span> make_pm_def hermitian_decomp_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">B</span> <span class="bound">U</span><span class="main">.</span> hermitian_decomp <span class="free">A</span> <span class="bound">B</span> <span class="bound">U</span> <span class="main">∧</span> 
      make_pm <span class="free">A</span> <span class="main">=</span> <span class="main">(</span>dist_el_card <span class="bound">B</span><span class="main">,</span> mk_meas_outcome <span class="bound">B</span> <span class="bound">U</span><span class="main">)</span>"</span></span>  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> that  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> cpx_sq_mat<span class="main">)</span> spectrum_meas_outcome_val_eq<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"hermitian <span class="free">A</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">∈</span> <span class="free">fc_mats</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"make_pm <span class="free">A</span> <span class="main">=</span> <span class="main">(</span><span class="free">p</span><span class="main">,</span> <span class="free">M</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"spectrum <span class="free">A</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> meas_outcome_val <span class="main">(</span><span class="free">M</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span><span class="main">{..&lt;</span> <span class="free">p</span><span class="main">}</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">B</span></span> <span class="skolem"><span class="skolem">U</span></span> <span class="keyword2"><span class="keyword">where</span></span> bu<span class="main">:</span> <span class="quoted"><span class="quoted">"hermitian_decomp <span class="free">A</span> <span class="skolem">B</span> <span class="skolem">U</span> <span class="main">∧</span> 
    make_pm <span class="free">A</span> <span class="main">=</span> <span class="main">(</span>dist_el_card <span class="skolem">B</span><span class="main">,</span> mk_meas_outcome <span class="skolem">B</span> <span class="skolem">U</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> assms hermitian_schur_decomp'<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">=</span> dist_el_card <span class="skolem">B</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> dimB<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">B</span> <span class="main">∈</span> carrier_mat <span class="free">dimR</span> <span class="free">dimR</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> hermitian_decomp_dim_carrier<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">A</span></span><span class="main">]</span> dim_eq bu assms 
      fc_mats_carrier  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> Bvals<span class="main">:</span> <span class="quoted"><span class="quoted">"diag_mat <span class="skolem">B</span> <span class="main">=</span> eigvals <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> bu hermitian_decomp_eigenvalues<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">A</span></span> <span class="quoted"><span class="skolem">B</span></span> <span class="quoted"><span class="skolem">U</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> Bii<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="free">dimR</span> <span class="main">⟹</span> <span class="skolem">B</span><span class="main">$$</span><span class="main">(</span><span class="bound">i</span><span class="main">,</span> <span class="bound">i</span><span class="main">)</span> <span class="main">∈</span> Reals"</span></span> <span class="keyword1"><span class="command">using</span></span> bu hermitian_decomp_real_eigvals<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">A</span></span> <span class="quoted"><span class="skolem">B</span></span> <span class="quoted"><span class="skolem">U</span></span><span class="main">]</span> 
      dimB <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"diag_elems <span class="skolem">B</span> <span class="main">=</span> set <span class="main">(</span>eigvals <span class="free">A</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> dimB Bvals diag_elems_set_diag_mat<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">B</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">=</span> mk_meas_outcome <span class="skolem">B</span> <span class="skolem">U</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms bu <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>  
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> <span class="free">p</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"meas_outcome_val <span class="main">(</span><span class="free">M</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">=</span> Re <span class="main">(</span>diag_idx_to_el <span class="skolem">B</span> <span class="skolem">i</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">M</span> <span class="main">=</span> mk_meas_outcome <span class="skolem">B</span> <span class="skolem">U</span>›</span></span> 
      <span class="keyword1"><span class="command">unfolding</span></span> meas_outcome_val_def mk_meas_outcome_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> diag_idx_to_el <span class="skolem">B</span> <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> diag_idx_to_el_real dimB <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">&lt;</span> <span class="free">p</span>›</span></span> 
        <span class="quoted"><span class="quoted">‹<span class="free">p</span> <span class="main">=</span> dist_el_card <span class="skolem">B</span>›</span></span> Bii <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"meas_outcome_val <span class="main">(</span><span class="free">M</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">=</span> diag_idx_to_el <span class="skolem">B</span> <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> eq <span class="main">=</span> this
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bij_betw <span class="main">(</span>diag_idx_to_el <span class="skolem">B</span><span class="main">)</span> <span class="main">{..&lt;</span>dist_el_card <span class="skolem">B</span><span class="main">}</span> <span class="main">(</span>diag_elems <span class="skolem">B</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> diag_idx_to_el_bij<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">B</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"diag_idx_to_el <span class="skolem">B</span> <span class="main">`</span> <span class="main">{..&lt;</span> <span class="free">p</span><span class="main">}</span> <span class="main">=</span> diag_elems <span class="skolem">B</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">p</span> <span class="main">=</span> dist_el_card <span class="skolem">B</span>›</span></span> 
    <span class="keyword1"><span class="command">unfolding</span></span> bij_betw_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> eq <span class="quoted"><span class="quoted">‹diag_elems <span class="skolem">B</span> <span class="main">=</span> set <span class="main">(</span>eigvals <span class="free">A</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> spectrum_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> cpx_sq_mat<span class="main">)</span> spectrum_meas_outcome_val_eq'<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"hermitian <span class="free">A</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">∈</span> <span class="free">fc_mats</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"make_pm <span class="free">A</span> <span class="main">=</span> <span class="main">(</span><span class="free">p</span><span class="main">,</span> <span class="free">M</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span>Re <span class="bound">x</span><span class="main">|</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span><span class="main">∈</span> spectrum <span class="free">A</span><span class="main">}</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> meas_outcome_val <span class="main">(</span><span class="free">M</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span><span class="main">{..&lt;</span> <span class="free">p</span><span class="main">}</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span>Re <span class="bound">x</span> <span class="main">|</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> spectrum <span class="free">A</span><span class="main">}</span> <span class="main">⊆</span> <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> meas_outcome_val <span class="main">(</span><span class="free">M</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> <span class="main">{..&lt;</span><span class="free">p</span><span class="main">}</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> spectrum_meas_outcome_val_eq assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> meas_outcome_val <span class="main">(</span><span class="free">M</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> <span class="main">{..&lt;</span><span class="free">p</span><span class="main">}</span> <span class="main">⊆</span> <span class="main">{</span>Re <span class="bound">x</span> <span class="main">|</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> spectrum <span class="free">A</span><span class="main">}</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> spectrum_meas_outcome_val_eq assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> cpx_sq_mat<span class="main">)</span> make_pm_eigenvalues<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span><span class="main">∈</span> <span class="free">fc_mats</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"hermitian <span class="free">A</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> proj_meas_size <span class="main">(</span>make_pm <span class="free">A</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"meas_outcome_val <span class="main">(</span>proj_meas_outcomes <span class="main">(</span>make_pm <span class="free">A</span><span class="main">)</span> <span class="free">i</span><span class="main">)</span> <span class="main">∈</span> spectrum <span class="free">A</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> spectrum_meas_outcome_val_eq<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">A</span></span><span class="main">]</span> assms make_pm_decomp <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> cpx_sq_mat<span class="main">)</span> make_pm_spectrum<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span><span class="main">∈</span> <span class="free">fc_mats</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"hermitian <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"make_pm <span class="free">A</span> <span class="main">=</span> <span class="main">(</span><span class="free">p</span><span class="main">,</span><span class="free">M</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> meas_outcome_val <span class="main">(</span>proj_meas_outcomes <span class="main">(</span>make_pm <span class="free">A</span><span class="main">)</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> <span class="main">{..&lt;</span> <span class="free">p</span><span class="main">}</span> <span class="main">=</span> spectrum <span class="free">A</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> complex_of_real <span class="main">(</span>meas_outcome_val <span class="main">(</span>proj_meas_outcomes <span class="main">(</span>make_pm <span class="free">A</span><span class="main">)</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> <span class="main">{..&lt;</span><span class="free">p</span><span class="main">}</span> <span class="main">⊆</span> 
    spectrum <span class="free">A</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms make_pm_eigenvalues make_pm_decomp
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> Pair_inject image_subsetI lessThan_iff<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"spectrum <span class="free">A</span> <span class="main">⊆</span> 
    <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> complex_of_real <span class="main">(</span>meas_outcome_val <span class="main">(</span>proj_meas_outcomes <span class="main">(</span>make_pm <span class="free">A</span><span class="main">)</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> <span class="main">{..&lt;</span><span class="free">p</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Pair_inject assms equalityE  make_pm_decomp spectrum_meas_outcome_val_eq<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> cpx_sq_mat<span class="main">)</span> spectrum_size<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"hermitian <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span><span class="main">∈</span> <span class="free">fc_mats</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"make_pm <span class="free">A</span> <span class="main">=</span> <span class="main">(</span><span class="free">p</span><span class="main">,</span> <span class="free">M</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">=</span> card <span class="main">(</span>spectrum <span class="free">A</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">B</span></span> <span class="skolem"><span class="skolem">U</span></span> <span class="keyword2"><span class="keyword">where</span></span> bu<span class="main">:</span> <span class="quoted"><span class="quoted">"hermitian_decomp <span class="free">A</span> <span class="skolem">B</span> <span class="skolem">U</span> <span class="main">∧</span> 
    make_pm <span class="free">A</span> <span class="main">=</span> <span class="main">(</span>dist_el_card <span class="skolem">B</span><span class="main">,</span> mk_meas_outcome <span class="skolem">B</span> <span class="skolem">U</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> assms hermitian_schur_decomp'<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">=</span> dist_el_card <span class="skolem">B</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"spectrum <span class="free">A</span> <span class="main">=</span> set <span class="main">(</span>diag_mat <span class="skolem">B</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> bu hermitian_decomp_eigenvalues<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">A</span></span> <span class="quoted"><span class="skolem">B</span></span> <span class="quoted"><span class="skolem">U</span></span><span class="main">]</span> 
    <span class="keyword1"><span class="command">unfolding</span></span> spectrum_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> diag_elems <span class="skolem">B</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> diag_elems_set_diag_mat<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">B</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"spectrum <span class="free">A</span> <span class="main">=</span> diag_elems <span class="skolem">B</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">p</span> <span class="main">=</span> dist_el_card <span class="skolem">B</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> dist_el_card_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> cpx_sq_mat<span class="main">)</span> spectrum_size'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"hermitian <span class="free">A</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span><span class="main">∈</span> <span class="free">fc_mats</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"proj_meas_size <span class="main">(</span>make_pm <span class="free">A</span><span class="main">)</span> <span class="main">=</span> card <span class="main">(</span>spectrum <span class="free">A</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> spectrum_size 
  <span class="keyword1"><span class="command">unfolding</span></span> proj_meas_size_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms fst_conv surj_pair<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> cpx_sq_mat<span class="main">)</span> make_pm_projectors'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"hermitian <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">∈</span> <span class="free">fc_mats</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span><span class="main">&lt;</span>card <span class="main">(</span>spectrum <span class="free">A</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"projector <span class="main">(</span>meas_outcome_prj <span class="main">(</span>proj_meas_outcomes <span class="main">(</span>make_pm <span class="free">A</span><span class="main">)</span> <span class="free">a</span><span class="main">)</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> make_pm_projectors<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms spectrum_size'<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> cpx_sq_mat<span class="main">)</span> meas_outcome_prj_carrier<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"hermitian <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">∈</span> <span class="free">fc_mats</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span><span class="main">&lt;</span>card <span class="main">(</span>spectrum <span class="free">A</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"meas_outcome_prj <span class="main">(</span>proj_meas_outcomes <span class="main">(</span>make_pm <span class="free">A</span><span class="main">)</span> <span class="free">a</span><span class="main">)</span> <span class="main">∈</span> <span class="free">fc_mats</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> proj_measurement_square<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"proj_measurement <span class="main">(</span>proj_meas_size <span class="main">(</span>make_pm <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>proj_meas_outcomes <span class="main">(</span>make_pm <span class="free">A</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> make_pm_proj_measurement' assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">&lt;</span> proj_meas_size <span class="main">(</span>make_pm <span class="free">A</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms 
      spectrum_size<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="quoted">"proj_meas_size <span class="main">(</span>make_pm <span class="free">A</span><span class="main">)</span>"</span></span><span class="main">]</span> make_pm_decomp<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">A</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> cpx_sq_mat<span class="main">)</span> meas_outcome_prj_trace_real<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"hermitian <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"density_operator <span class="free">R</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="main">∈</span> <span class="free">fc_mats</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span><span class="main">∈</span> <span class="free">fc_mats</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span><span class="main">&lt;</span>card <span class="main">(</span>spectrum <span class="free">A</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Re <span class="main">(</span>Complex_Matrix.trace <span class="main">(</span><span class="free">R</span> <span class="main">*</span> meas_outcome_prj <span class="main">(</span>proj_meas_outcomes <span class="main">(</span>make_pm <span class="free">A</span><span class="main">)</span> <span class="free">a</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
  Complex_Matrix.trace <span class="main">(</span><span class="free">R</span> <span class="main">*</span> meas_outcome_prj <span class="main">(</span>proj_meas_outcomes <span class="main">(</span>make_pm <span class="free">A</span><span class="main">)</span> <span class="free">a</span><span class="main">)</span><span class="main">)</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> trace_proj_pos_real<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="main">∈</span> carrier_mat <span class="free">dimR</span> <span class="free">dimR</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> fc_mats_carrier assms dim_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Complex_Matrix.positive <span class="free">R</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> density_operator_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"projector <span class="main">(</span>meas_outcome_prj <span class="main">(</span>proj_meas_outcomes <span class="main">(</span>make_pm <span class="free">A</span><span class="main">)</span> <span class="free">a</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms 
      make_pm_projectors' <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"meas_outcome_prj <span class="main">(</span>proj_meas_outcomes <span class="main">(</span>make_pm <span class="free">A</span><span class="main">)</span> <span class="free">a</span><span class="main">)</span> <span class="main">∈</span> carrier_mat <span class="free">dimR</span> <span class="free">dimR</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> meas_outcome_prj_carrier assms 
    dim_eq fc_mats_carrier <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> cpx_sq_mat<span class="main">)</span> sum_over_spectrum<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span><span class="main">∈</span> <span class="free">fc_mats</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"hermitian <span class="free">A</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"make_pm <span class="free">A</span> <span class="main">=</span> <span class="main">(</span><span class="free">p</span><span class="main">,</span> <span class="free">M</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span> <span class="bound">y</span> <span class="main">∈</span> spectrum <span class="free">A</span><span class="main">.</span> <span class="free">f</span> <span class="bound">y</span><span class="main">)</span> <span class="main">=</span>  <span class="main">(</span><span class="main">∑</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="free">p</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span>meas_outcome_val <span class="main">(</span><span class="free">M</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> sum.reindex_cong<span class="main">)</span>
<span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"spectrum <span class="free">A</span> <span class="main">=</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span>meas_outcome_val <span class="main">(</span><span class="free">M</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">`</span> <span class="main">{..&lt;</span> <span class="free">p</span><span class="main">}</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> spectrum_meas_outcome_val_eq assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"inj_on <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> complex_of_real <span class="main">(</span>meas_outcome_val <span class="main">(</span><span class="free">M</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">{..&lt;</span><span class="free">p</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"inj_on <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span>meas_outcome_val <span class="main">(</span><span class="free">M</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">{..&lt;</span><span class="free">p</span><span class="main">}</span>"</span></span> 
        <span class="keyword1"><span class="command">using</span></span> make_pm_proj_measurement<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">A</span></span> <span class="quoted"><span class="free">p</span></span> <span class="quoted"><span class="free">M</span></span><span class="main">]</span> assms proj_measurement_inj <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inj_on_def<span class="main">)</span> 
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> cpx_sq_mat<span class="main">)</span> sum_over_spectrum'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span><span class="main">∈</span> <span class="free">fc_mats</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"hermitian <span class="free">A</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"make_pm <span class="free">A</span> <span class="main">=</span> <span class="main">(</span><span class="free">p</span><span class="main">,</span> <span class="free">M</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span> <span class="bound">y</span> <span class="main">∈</span> <span class="main">{</span>Re <span class="bound">x</span><span class="main">|</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> spectrum <span class="free">A</span><span class="main">}</span><span class="main">.</span> <span class="free">f</span> <span class="bound">y</span><span class="main">)</span> <span class="main">=</span>  <span class="main">(</span><span class="main">∑</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="free">p</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span>meas_outcome_val <span class="main">(</span><span class="free">M</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> sum.reindex_cong<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span>Re <span class="bound">x</span><span class="main">|</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> spectrum <span class="free">A</span><span class="main">}</span> <span class="main">=</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span>meas_outcome_val <span class="main">(</span><span class="free">M</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">`</span> <span class="main">{..&lt;</span> <span class="free">p</span><span class="main">}</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> spectrum_meas_outcome_val_eq' assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"inj_on <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span>meas_outcome_val <span class="main">(</span><span class="free">M</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">{..&lt;</span><span class="free">p</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> make_pm_proj_measurement<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">A</span></span> <span class="quoted"><span class="free">p</span></span> <span class="quoted"><span class="free">M</span></span><span class="main">]</span>
        assms proj_measurement_inj <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹When a matrix $A$ is decomposed into a projective measurement $\{(\lambda_a, \pi_a)\}$, it 
can be recovered by the formula $A = \sum \lambda_a \pi_a$.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> cpx_sq_mat<span class="main">)</span> make_pm_sum<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">∈</span> <span class="free">fc_mats</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"hermitian <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"make_pm <span class="free">A</span> <span class="main">=</span> <span class="main">(</span><span class="free">p</span><span class="main">,</span> <span class="free">M</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sum_mat <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span>  <span class="main">(</span>meas_outcome_val <span class="main">(</span><span class="free">M</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>m</sub></span> meas_outcome_prj <span class="main">(</span><span class="free">M</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">{..&lt;</span> <span class="free">p</span><span class="main">}</span> <span class="main">=</span> <span class="free">A</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> es<span class="main">:</span> <span class="quoted"><span class="quoted">"char_poly <span class="free">A</span> <span class="main">=</span> <span class="main">(</span><span class="main">∏</span> <span class="main">(</span><span class="bound">e</span> <span class="main">::</span> complex<span class="main">)</span> <span class="main">←</span> <span class="main">(</span>eigvals <span class="free">A</span><span class="main">)</span><span class="main">.</span> <span class="main">[:</span><span class="main">-</span> <span class="bound">e</span><span class="main">,</span> <span class="main">1</span><span class="main">:]</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> assms fc_mats_carrier eigvals_poly_length dim_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">B</span></span> <span class="skolem"><span class="skolem">U</span></span> <span class="skolem"><span class="skolem">Q</span></span> <span class="keyword2"><span class="keyword">where</span></span> us<span class="main">:</span> <span class="quoted"><span class="quoted">"unitary_schur_decomposition <span class="free">A</span> <span class="main">(</span>eigvals <span class="free">A</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">B</span><span class="main">,</span><span class="skolem">U</span><span class="main">,</span><span class="skolem">Q</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"unitary_schur_decomposition <span class="free">A</span> <span class="main">(</span>eigvals <span class="free">A</span><span class="main">)</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"similar_mat_wit <span class="free">A</span> <span class="skolem">B</span> <span class="skolem">U</span> <span class="main">(</span>Complex_Matrix.adjoint <span class="skolem">U</span><span class="main">)</span> <span class="main">∧</span> diagonal_mat <span class="skolem">B</span> <span class="main">∧</span> 
    diag_mat <span class="skolem">B</span> <span class="main">=</span> <span class="main">(</span>eigvals <span class="free">A</span><span class="main">)</span> 
    <span class="main">∧</span> unitary <span class="skolem">U</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> <span class="free">dimR</span><span class="main">.</span> <span class="skolem">B</span><span class="main">$$</span><span class="main">(</span><span class="bound">i</span><span class="main">,</span> <span class="bound">i</span><span class="main">)</span> <span class="main">∈</span> Reals<span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> hermitian_eigenvalue_real assms fc_mats_carrier es dim_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">=</span> <span class="skolem">U</span> <span class="main">*</span> <span class="skolem">B</span> <span class="main">*</span> <span class="main">(</span>Complex_Matrix.adjoint <span class="skolem">U</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> dB<span class="main">:</span> <span class="quoted"><span class="quoted">"diagonal_mat <span class="skolem">B</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> Bii<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="free">dimR</span> <span class="main">⟹</span> <span class="skolem">B</span><span class="main">$$</span><span class="main">(</span><span class="bound">i</span><span class="main">,</span> <span class="bound">i</span><span class="main">)</span> <span class="main">∈</span> Reals"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> dimB<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">B</span> <span class="main">∈</span> carrier_mat <span class="free">dimR</span> <span class="free">dimR</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> dimP<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">U</span> <span class="main">∈</span> carrier_mat <span class="free">dimR</span> <span class="free">dimR</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 
    dimaP<span class="main">:</span> <span class="quoted"><span class="quoted">"Complex_Matrix.adjoint <span class="skolem">U</span> <span class="main">∈</span> carrier_mat <span class="free">dimR</span> <span class="free">dimR</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> unit<span class="main">:</span> <span class="quoted"><span class="quoted">"unitary <span class="skolem">U</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> similar_mat_wit_def Let_def <span class="keyword1"><span class="command">using</span></span> assms fc_mats_carrier <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> mpeq<span class="main">:</span> <span class="quoted"><span class="quoted">"make_pm <span class="free">A</span> <span class="main">=</span> <span class="main">(</span>dist_el_card <span class="skolem">B</span><span class="main">,</span> mk_meas_outcome <span class="skolem">B</span> <span class="skolem">U</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> us Let_def 
    <span class="keyword1"><span class="command">unfolding</span></span> make_pm_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">=</span> dist_el_card <span class="skolem">B</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">=</span> mk_meas_outcome <span class="skolem">B</span> <span class="skolem">U</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms mpeq <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sum_mat <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> meas_outcome_val <span class="main">(</span><span class="free">M</span> <span class="bound">i</span><span class="main">)</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>m</sub></span> meas_outcome_prj <span class="main">(</span><span class="free">M</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">{..&lt;</span> <span class="free">p</span><span class="main">}</span> <span class="main">=</span> 
    sum_mat <span class="main">(</span><span class="main">λ</span><span class="bound">j</span><span class="main">.</span> Re <span class="main">(</span>diag_idx_to_el <span class="skolem">B</span> <span class="bound">j</span><span class="main">)</span><span class="keyword1">⋅<span class="hidden">⇩</span><sub>m</sub></span> project_vecs <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> zero_col <span class="skolem">U</span> <span class="bound">i</span><span class="main">)</span> 
    <span class="main">(</span>diag_elem_indices <span class="main">(</span>diag_idx_to_el <span class="skolem">B</span> <span class="bound">j</span><span class="main">)</span> <span class="skolem">B</span><span class="main">)</span><span class="main">)</span> <span class="main">{..&lt;</span><span class="main">(</span>dist_el_card <span class="skolem">B</span><span class="main">)</span><span class="main">}</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">p</span> <span class="main">=</span> dist_el_card <span class="skolem">B</span>›</span></span> 
    <span class="quoted"><span class="quoted">‹<span class="free">M</span> <span class="main">=</span> mk_meas_outcome <span class="skolem">B</span> <span class="skolem">U</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> meas_outcome_val_def meas_outcome_prj_def 
      mk_meas_outcome_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> sum_mat
     <span class="main">(</span><span class="main">λ</span><span class="bound">j</span><span class="main">.</span> sum_mat <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="main">(</span>Re <span class="main">(</span>diag_idx_to_el <span class="skolem">B</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>m</sub></span> rank_1_proj <span class="main">(</span>zero_col <span class="skolem">U</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> 
    <span class="main">(</span>diag_elem_indices <span class="main">(</span>diag_idx_to_el <span class="skolem">B</span> <span class="bound">j</span><span class="main">)</span> <span class="skolem">B</span><span class="main">)</span><span class="main">)</span> <span class="main">{..&lt;</span>dist_el_card <span class="skolem">B</span><span class="main">}</span>"</span></span>  
    <span class="keyword1"><span class="command">unfolding</span></span> project_vecs_def
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> sum_mat_cong<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">{..&lt;</span>dist_el_card <span class="skolem">B</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∈</span> <span class="main">{..&lt;</span>dist_el_card <span class="skolem">B</span><span class="main">}</span> <span class="main">⟹</span>
         complex_of_real <span class="main">(</span>Re <span class="main">(</span>diag_idx_to_el <span class="skolem">B</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>m</sub></span>
         sum_mat <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> rank_1_proj <span class="main">(</span>zero_col <span class="skolem">U</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>diag_elem_indices <span class="main">(</span>diag_idx_to_el <span class="skolem">B</span> <span class="bound">i</span><span class="main">)</span> <span class="skolem">B</span><span class="main">)</span>
         <span class="main">∈</span> <span class="free">fc_mats</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms fc_mats_carrier dimP project_vecs_def project_vecs_dim zero_col_dim 
        dim_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∈</span> <span class="main">{..&lt;</span>dist_el_card <span class="skolem">B</span><span class="main">}</span> <span class="main">⟹</span>
         sum_mat <span class="main">(</span><span class="main">λ</span><span class="bound">ia</span><span class="main">.</span> complex_of_real <span class="main">(</span>Re <span class="main">(</span>diag_idx_to_el <span class="skolem">B</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>m</sub></span> rank_1_proj <span class="main">(</span>zero_col <span class="skolem">U</span> <span class="bound">ia</span><span class="main">)</span><span class="main">)</span>
          <span class="main">(</span>diag_elem_indices <span class="main">(</span>diag_idx_to_el <span class="skolem">B</span> <span class="bound">i</span><span class="main">)</span> <span class="skolem">B</span><span class="main">)</span> <span class="main">∈</span> <span class="free">fc_mats</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms fc_mats_carrier dimP 
      project_vecs_def project_vecs_dim zero_col_dim dim_eq
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> rank_1_proj_carrier cpx_sq_mat_smult sum_mat_carrier<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">j</span><span class="main">.</span> <span class="bound">j</span> <span class="main">∈</span> <span class="main">{..&lt;</span>dist_el_card <span class="skolem">B</span><span class="main">}</span> <span class="main">⟹</span>
          <span class="main">(</span>Re <span class="main">(</span>diag_idx_to_el <span class="skolem">B</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>m</sub></span>  sum_mat <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> rank_1_proj <span class="main">(</span>zero_col <span class="skolem">U</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> 
        <span class="main">(</span>diag_elem_indices <span class="main">(</span>diag_idx_to_el <span class="skolem">B</span> <span class="bound">j</span><span class="main">)</span> <span class="skolem">B</span><span class="main">)</span> <span class="main">=</span>
         sum_mat <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> complex_of_real <span class="main">(</span>Re <span class="main">(</span>diag_idx_to_el <span class="skolem">B</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>m</sub></span> rank_1_proj <span class="main">(</span>zero_col <span class="skolem">U</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>
          <span class="main">(</span>diag_elem_indices <span class="main">(</span>diag_idx_to_el <span class="skolem">B</span> <span class="bound">j</span><span class="main">)</span> <span class="skolem">B</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">j</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">∈</span> <span class="main">{..&lt;</span>dist_el_card <span class="skolem">B</span><span class="main">}</span>"</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">" <span class="main">(</span>Re <span class="main">(</span>diag_idx_to_el <span class="skolem">B</span> <span class="skolem">j</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>m</sub></span> sum_mat <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> rank_1_proj <span class="main">(</span>zero_col <span class="skolem">U</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> 
         <span class="main">(</span>diag_elem_indices <span class="main">(</span>diag_idx_to_el <span class="skolem">B</span> <span class="skolem">j</span><span class="main">)</span> <span class="skolem">B</span><span class="main">)</span> <span class="main">=</span>
        sum_mat <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="main">(</span>Re <span class="main">(</span>diag_idx_to_el <span class="skolem">B</span> <span class="skolem">j</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>m</sub></span> rank_1_proj <span class="main">(</span>zero_col <span class="skolem">U</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>
          <span class="main">(</span>diag_elem_indices <span class="main">(</span>diag_idx_to_el <span class="skolem">B</span> <span class="skolem">j</span><span class="main">)</span> <span class="skolem">B</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> smult_sum_mat<span class="main">)</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>diag_elem_indices <span class="main">(</span>diag_idx_to_el <span class="skolem">B</span> <span class="skolem">j</span><span class="main">)</span> <span class="skolem">B</span><span class="main">)</span>"</span></span> 
          <span class="keyword1"><span class="command">using</span></span> diag_elem_indices_finite<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="skolem">B</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∈</span> diag_elem_indices <span class="main">(</span>diag_idx_to_el <span class="skolem">B</span> <span class="skolem">j</span><span class="main">)</span> <span class="skolem">B</span> <span class="main">⟹</span> 
          rank_1_proj <span class="main">(</span>zero_col <span class="skolem">U</span> <span class="bound">i</span><span class="main">)</span> <span class="main">∈</span> <span class="free">fc_mats</span>"</span></span> 
          <span class="keyword1"><span class="command">using</span></span> dim_eq <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> dimP local.fc_mats_carrier rank_1_proj_carrier zero_col_dim<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> sum_mat
     <span class="main">(</span><span class="main">λ</span><span class="bound">j</span><span class="main">.</span> sum_mat <span class="main">(</span><span class="main">λ</span><span class="bound">ia</span><span class="main">.</span> <span class="main">(</span>diag_mat <span class="skolem">B</span> <span class="main">!</span> <span class="bound">ia</span><span class="main">)</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>m</sub></span> rank_1_proj <span class="main">(</span>zero_col <span class="skolem">U</span> <span class="bound">ia</span><span class="main">)</span><span class="main">)</span> 
    <span class="main">(</span>diag_elem_indices <span class="main">(</span>diag_idx_to_el <span class="skolem">B</span> <span class="bound">j</span><span class="main">)</span> <span class="skolem">B</span><span class="main">)</span><span class="main">)</span> <span class="main">{..&lt;</span>dist_el_card <span class="skolem">B</span><span class="main">}</span>"</span></span>    
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> sum_mat_cong<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">{..&lt;</span>dist_el_card <span class="skolem">B</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∈</span> <span class="main">{..&lt;</span>dist_el_card <span class="skolem">B</span><span class="main">}</span> <span class="main">⟹</span>
         sum_mat <span class="main">(</span><span class="main">λ</span><span class="bound">ia</span><span class="main">.</span> complex_of_real <span class="main">(</span>Re <span class="main">(</span>diag_idx_to_el <span class="skolem">B</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>m</sub></span> rank_1_proj <span class="main">(</span>zero_col <span class="skolem">U</span> <span class="bound">ia</span><span class="main">)</span><span class="main">)</span>
          <span class="main">(</span>diag_elem_indices <span class="main">(</span>diag_idx_to_el <span class="skolem">B</span> <span class="bound">i</span><span class="main">)</span> <span class="skolem">B</span><span class="main">)</span> <span class="main">∈</span> <span class="free">fc_mats</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms fc_mats_carrier dimP 
      project_vecs_def project_vecs_dim zero_col_dim dim_eq
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> rank_1_proj_carrier cpx_sq_mat_smult sum_mat_carrier<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∈</span> <span class="main">{..&lt;</span>dist_el_card <span class="skolem">B</span><span class="main">}</span> <span class="main">⟹</span>
         local.sum_mat <span class="main">(</span><span class="main">λ</span><span class="bound">ia</span><span class="main">.</span>  <span class="main">(</span>diag_mat <span class="skolem">B</span> <span class="main">!</span> <span class="bound">ia</span><span class="main">)</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>m</sub></span> rank_1_proj <span class="main">(</span>zero_col <span class="skolem">U</span> <span class="bound">ia</span><span class="main">)</span><span class="main">)</span>
          <span class="main">(</span>diag_elem_indices <span class="main">(</span>diag_idx_to_el <span class="skolem">B</span> <span class="bound">i</span><span class="main">)</span> <span class="skolem">B</span><span class="main">)</span> <span class="main">∈</span> <span class="free">fc_mats</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms fc_mats_carrier dimP 
      project_vecs_def project_vecs_dim zero_col_dim dim_eq
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> rank_1_proj_carrier cpx_sq_mat_smult sum_mat_carrier<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∈</span> <span class="main">{..&lt;</span>dist_el_card <span class="skolem">B</span><span class="main">}</span> <span class="main">⟹</span>
         sum_mat <span class="main">(</span><span class="main">λ</span><span class="bound">ia</span><span class="main">.</span> <span class="main">(</span>Re <span class="main">(</span>diag_idx_to_el <span class="skolem">B</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>m</sub></span> rank_1_proj <span class="main">(</span>zero_col <span class="skolem">U</span> <span class="bound">ia</span><span class="main">)</span><span class="main">)</span>
          <span class="main">(</span>diag_elem_indices <span class="main">(</span>diag_idx_to_el <span class="skolem">B</span> <span class="bound">i</span><span class="main">)</span> <span class="skolem">B</span><span class="main">)</span> <span class="main">=</span>
         sum_mat <span class="main">(</span><span class="main">λ</span><span class="bound">ia</span><span class="main">.</span> <span class="main">(</span>diag_mat <span class="skolem">B</span> <span class="main">!</span> <span class="bound">ia</span><span class="main">)</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>m</sub></span> rank_1_proj <span class="main">(</span>zero_col <span class="skolem">U</span> <span class="bound">ia</span><span class="main">)</span><span class="main">)</span>
          <span class="main">(</span>diag_elem_indices <span class="main">(</span>diag_idx_to_el <span class="skolem">B</span> <span class="bound">i</span><span class="main">)</span> <span class="skolem">B</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span><span class="main">∈</span> <span class="main">{..&lt;</span> dist_el_card <span class="skolem">B</span><span class="main">}</span>"</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"sum_mat <span class="main">(</span><span class="main">λ</span><span class="bound">ia</span><span class="main">.</span> <span class="main">(</span>Re <span class="main">(</span>diag_idx_to_el <span class="skolem">B</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>m</sub></span> rank_1_proj <span class="main">(</span>zero_col <span class="skolem">U</span> <span class="bound">ia</span><span class="main">)</span><span class="main">)</span>
          <span class="main">(</span>diag_elem_indices <span class="main">(</span>diag_idx_to_el <span class="skolem">B</span> <span class="skolem">i</span><span class="main">)</span> <span class="skolem">B</span><span class="main">)</span> <span class="main">=</span>
         sum_mat <span class="main">(</span><span class="main">λ</span><span class="bound">ia</span><span class="main">.</span> <span class="main">(</span>diag_mat <span class="skolem">B</span> <span class="main">!</span> <span class="bound">ia</span><span class="main">)</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>m</sub></span> rank_1_proj <span class="main">(</span>zero_col <span class="skolem">U</span> <span class="bound">ia</span><span class="main">)</span><span class="main">)</span>
          <span class="main">(</span>diag_elem_indices <span class="main">(</span>diag_idx_to_el <span class="skolem">B</span> <span class="skolem">i</span><span class="main">)</span> <span class="skolem">B</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> sum_mat_cong<span class="main">)</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>diag_elem_indices <span class="main">(</span>diag_idx_to_el <span class="skolem">B</span> <span class="skolem">i</span><span class="main">)</span> <span class="skolem">B</span><span class="main">)</span>"</span></span> 
          <span class="keyword1"><span class="command">using</span></span> diag_elem_indices_finite<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="skolem">B</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">ia</span><span class="main">.</span> <span class="bound">ia</span> <span class="main">∈</span> diag_elem_indices <span class="main">(</span>diag_idx_to_el <span class="skolem">B</span> <span class="skolem">i</span><span class="main">)</span> <span class="skolem">B</span> <span class="main">⟹</span> 
          <span class="main">(</span>Re <span class="main">(</span>diag_idx_to_el <span class="skolem">B</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>m</sub></span> rank_1_proj <span class="main">(</span>zero_col <span class="skolem">U</span> <span class="bound">ia</span><span class="main">)</span> <span class="main">∈</span> <span class="free">fc_mats</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> assms fc_mats_carrier dimP project_vecs_def project_vecs_dim zero_col_dim dim_eq 
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> rank_1_proj_carrier cpx_sq_mat_smult<span class="main">)</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">ia</span><span class="main">.</span> <span class="bound">ia</span> <span class="main">∈</span> diag_elem_indices <span class="main">(</span>diag_idx_to_el <span class="skolem">B</span> <span class="skolem">i</span><span class="main">)</span> <span class="skolem">B</span> <span class="main">⟹</span> 
          <span class="main">(</span>diag_mat <span class="skolem">B</span> <span class="main">!</span><span class="bound">ia</span><span class="main">)</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>m</sub></span> rank_1_proj <span class="main">(</span>zero_col <span class="skolem">U</span> <span class="bound">ia</span><span class="main">)</span> <span class="main">∈</span> <span class="free">fc_mats</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> assms fc_mats_carrier dimP project_vecs_def project_vecs_dim zero_col_dim dim_eq 
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> rank_1_proj_carrier cpx_sq_mat_smult<span class="main">)</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">ia</span><span class="main">.</span> <span class="bound">ia</span> <span class="main">∈</span> diag_elem_indices <span class="main">(</span>diag_idx_to_el <span class="skolem">B</span> <span class="skolem">i</span><span class="main">)</span> <span class="skolem">B</span> <span class="main">⟹</span>
          <span class="main">(</span>Re <span class="main">(</span>diag_idx_to_el <span class="skolem">B</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>m</sub></span> rank_1_proj <span class="main">(</span>zero_col <span class="skolem">U</span> <span class="bound">ia</span><span class="main">)</span> <span class="main">=</span>
          <span class="main">(</span>diag_mat <span class="skolem">B</span> <span class="main">!</span> <span class="bound">ia</span><span class="main">)</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>m</sub></span> rank_1_proj <span class="main">(</span>zero_col <span class="skolem">U</span> <span class="bound">ia</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
          <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">ia</span>
          <span class="keyword3"><span class="command">assume</span></span> ia<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ia</span> <span class="main">∈</span> diag_elem_indices <span class="main">(</span>diag_idx_to_el <span class="skolem">B</span> <span class="skolem">i</span><span class="main">)</span> <span class="skolem">B</span>"</span></span>
          <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ia</span> <span class="main">&lt;</span> dim_row <span class="skolem">B</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> diag_elem_indices_elem<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">ia</span></span> <span class="main">_</span> <span class="quoted"><span class="skolem">B</span></span><span class="main">]</span>  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Re <span class="main">(</span>diag_idx_to_el <span class="skolem">B</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">=</span> Re <span class="main">(</span><span class="skolem">B</span> <span class="main">$$</span> <span class="main">(</span><span class="skolem">ia</span><span class="main">,</span> <span class="skolem">ia</span><span class="main">)</span><span class="main">)</span>"</span></span> 
            <span class="keyword1"><span class="command">using</span></span> diag_elem_indices_elem<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">ia</span></span> <span class="main">_</span> <span class="quoted"><span class="skolem">B</span></span><span class="main">]</span> ia <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="skolem">B</span> <span class="main">$$</span> <span class="main">(</span><span class="skolem">ia</span><span class="main">,</span> <span class="skolem">ia</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Bii <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">ia</span> <span class="main">&lt;</span> dim_row <span class="skolem">B</span>›</span></span> dimB of_real_Re <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
          <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> diag_mat <span class="skolem">B</span> <span class="main">!</span> <span class="skolem">ia</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">ia</span> <span class="main">&lt;</span> dim_row <span class="skolem">B</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> diag_mat_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Re <span class="main">(</span>diag_idx_to_el <span class="skolem">B</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">=</span> diag_mat <span class="skolem">B</span> <span class="main">!</span> <span class="skolem">ia</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
          <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Re <span class="main">(</span>diag_idx_to_el <span class="skolem">B</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>m</sub></span> rank_1_proj <span class="main">(</span>zero_col <span class="skolem">U</span> <span class="skolem">ia</span><span class="main">)</span> <span class="main">=</span>
            <span class="main">(</span>diag_mat <span class="skolem">B</span> <span class="main">!</span> <span class="skolem">ia</span><span class="main">)</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>m</sub></span> rank_1_proj <span class="main">(</span>zero_col <span class="skolem">U</span> <span class="skolem">ia</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> sum_mat 
    <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="main">(</span>diag_mat <span class="skolem">B</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>m</sub></span> rank_1_proj <span class="main">(</span>zero_col <span class="skolem">U</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> 
    <span class="main">(</span><span class="main">⋃</span><span class="bound">j</span><span class="main">&lt;</span>dist_el_card <span class="skolem">B</span><span class="main">.</span> diag_elem_indices <span class="main">(</span>diag_idx_to_el <span class="skolem">B</span> <span class="bound">j</span><span class="main">)</span> <span class="skolem">B</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">unfolding</span></span> project_vecs_def sum_mat_def     
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> disj_family_sum_with<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">{..&lt;</span>dist_el_card <span class="skolem">B</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">j</span><span class="main">.</span> <span class="main">(</span>diag_mat <span class="skolem">B</span> <span class="main">!</span> <span class="bound">j</span><span class="main">)</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>m</sub></span> rank_1_proj <span class="main">(</span>zero_col <span class="skolem">U</span> <span class="bound">j</span><span class="main">)</span> <span class="main">∈</span> <span class="free">fc_mats</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms fc_mats_carrier dimP 
      project_vecs_def project_vecs_dim zero_col_dim dim_eq
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> rank_1_proj_carrier cpx_sq_mat_smult<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∈</span> <span class="main">{..&lt;</span>dist_el_card <span class="skolem">B</span><span class="main">}</span> <span class="main">⟹</span> finite <span class="main">(</span>diag_elem_indices <span class="main">(</span>diag_idx_to_el <span class="skolem">B</span> <span class="bound">i</span><span class="main">)</span> <span class="skolem">B</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> diag_elem_indices_finite<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"disjoint_family_on <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> diag_elem_indices <span class="main">(</span>diag_idx_to_el <span class="skolem">B</span> <span class="bound">n</span><span class="main">)</span> <span class="skolem">B</span><span class="main">)</span> 
      <span class="main">{..&lt;</span>dist_el_card <span class="skolem">B</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> diag_elem_indices_disjoint<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">B</span></span><span class="main">]</span> dimB dim_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> sum_mat <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="main">(</span>diag_mat <span class="skolem">B</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>m</sub></span> rank_1_proj <span class="main">(</span>zero_col <span class="skolem">U</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">{..&lt;</span> <span class="free">dimR</span><span class="main">}</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> diag_elem_indices_union<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">B</span></span><span class="main">]</span> dimB dim_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> sum_mat <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="main">(</span>diag_mat <span class="skolem">B</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>m</sub></span>rank_1_proj <span class="main">(</span>Matrix.col <span class="skolem">U</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">{..&lt;</span> <span class="free">dimR</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> sum_mat_cong<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> res<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∈</span> <span class="main">{..&lt;</span><span class="free">dimR</span><span class="main">}</span> <span class="main">⟹</span> <span class="main">(</span>diag_mat <span class="skolem">B</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>m</sub></span> rank_1_proj <span class="main">(</span>zero_col <span class="skolem">U</span> <span class="bound">i</span><span class="main">)</span> <span class="main">∈</span> <span class="free">fc_mats</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms fc_mats_carrier dimP project_vecs_def project_vecs_dim zero_col_dim dim_eq
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> rank_1_proj_carrier cpx_sq_mat_smult<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∈</span> <span class="main">{..&lt;</span><span class="free">dimR</span><span class="main">}</span> <span class="main">⟹</span> <span class="main">(</span>diag_mat <span class="skolem">B</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>m</sub></span> rank_1_proj <span class="main">(</span>Matrix.col <span class="skolem">U</span> <span class="bound">i</span><span class="main">)</span> <span class="main">∈</span> <span class="free">fc_mats</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms fc_mats_carrier dimP project_vecs_def  project_vecs_dim zero_col_dim
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> res lessThan_iff zero_col_col<span class="main">)</span>  
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∈</span> <span class="main">{..&lt;</span><span class="free">dimR</span><span class="main">}</span> <span class="main">⟹</span> <span class="main">(</span>diag_mat <span class="skolem">B</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>m</sub></span> rank_1_proj <span class="main">(</span>zero_col <span class="skolem">U</span> <span class="bound">i</span><span class="main">)</span> <span class="main">=</span> 
      <span class="main">(</span>diag_mat <span class="skolem">B</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>m</sub></span> rank_1_proj <span class="main">(</span>Matrix.col <span class="skolem">U</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> zero_col_col<span class="main">)</span> 
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="skolem">U</span> <span class="main">*</span> <span class="skolem">B</span> <span class="main">*</span> Complex_Matrix.adjoint <span class="skolem">U</span>"</span></span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> weighted_sum_rank_1_proj_unitary<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"diagonal_mat <span class="skolem">B</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> dB <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Complex_Matrix.unitary <span class="skolem">U</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> unit <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">U</span> <span class="main">∈</span> <span class="free">fc_mats</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> fc_mats_carrier dim_eq dimP <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">B</span><span class="main">∈</span> <span class="free">fc_mats</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> fc_mats_carrier dim_eq dimB <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> A <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> cpx_sq_mat<span class="main">)</span> trace_hermitian_pos_real<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> real"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"hermitian <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"Complex_Matrix.positive <span class="free">R</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">∈</span> <span class="free">fc_mats</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="main">∈</span> <span class="free">fc_mats</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Complex_Matrix.trace <span class="main">(</span><span class="free">R</span> <span class="main">*</span> <span class="free">A</span><span class="main">)</span> <span class="main">=</span> 
  Re <span class="main">(</span>Complex_Matrix.trace <span class="main">(</span><span class="free">R</span> <span class="main">*</span> <span class="free">A</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">prj_mems</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">prj_mems</span> <span class="main">=</span> make_pm <span class="free">A</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">=</span> proj_meas_size <span class="skolem">prj_mems</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">meas</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">meas</span> <span class="main">=</span> proj_meas_outcomes <span class="skolem">prj_mems</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> tre<span class="main">:</span> <span class="quoted"><span class="quoted">"Complex_Matrix.trace <span class="main">(</span><span class="free">R</span> <span class="main">*</span> <span class="free">A</span><span class="main">)</span> <span class="main">=</span> 
    Complex_Matrix.trace <span class="main">(</span><span class="free">R</span> <span class="main">*</span> 
    sum_mat <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="main">(</span>meas_outcome_val <span class="main">(</span><span class="skolem">meas</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>m</sub></span> meas_outcome_prj <span class="main">(</span><span class="skolem">meas</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">{..&lt;</span> <span class="skolem">p</span><span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> make_pm_sum assms meas_def p_def proj_meas_size_def proj_meas_outcomes_def prj_mems_def 
      meas_outcome_val_def meas_outcome_prj_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> Re <span class="main">(</span>Complex_Matrix.trace <span class="main">(</span><span class="free">R</span> <span class="main">*</span> 
    sum_mat <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="main">(</span>meas_outcome_val <span class="main">(</span><span class="skolem">meas</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>m</sub></span> meas_outcome_prj <span class="main">(</span><span class="skolem">meas</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">{..&lt;</span> <span class="skolem">p</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> trace_sum_mat_proj_pos_real<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main">)</span><span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> <span class="skolem">p</span>"</span></span> 
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"projector <span class="main">(</span>meas_outcome_prj <span class="main">(</span><span class="skolem">meas</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> make_pm_projectors assms 
      <span class="keyword1"><span class="command">unfolding</span></span> p_def meas_def prj_mems_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"meas_outcome_prj <span class="main">(</span><span class="skolem">meas</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">∈</span> <span class="free">fc_mats</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> make_pm_square assms <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">&lt;</span> <span class="skolem">p</span>›</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> p_def meas_def prj_mems_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> Re <span class="main">(</span>Complex_Matrix.trace <span class="main">(</span><span class="free">R</span> <span class="main">*</span> <span class="free">A</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> tre <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> cpx_sq_mat<span class="main">)</span> hermitian_Re_spectrum<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"hermitian <span class="free">A</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span><span class="main">∈</span> <span class="free">fc_mats</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span>Re <span class="bound">x</span> <span class="main">|</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> spectrum <span class="free">A</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="free">a</span><span class="main">,</span><span class="free">b</span><span class="main">}</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"spectrum <span class="free">A</span> <span class="main">=</span> <span class="main">{</span>complex_of_real <span class="free">a</span><span class="main">,</span> complex_of_real <span class="free">b</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword1"><span class="command">have</span></span> ar<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="main">(</span><span class="bound">a</span><span class="main">::</span>complex<span class="main">)</span><span class="main">.</span> <span class="bound">a</span> <span class="main">∈</span> spectrum <span class="free">A</span> <span class="main">⟹</span> Re <span class="bound">a</span> <span class="main">=</span> <span class="bound">a</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> hermitian_spectrum_real assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"spectrum <span class="free">A</span> <span class="main">⊆</span> <span class="main">{</span>complex_of_real <span class="free">a</span><span class="main">,</span> complex_of_real <span class="free">b</span><span class="main">}</span>"</span></span> 
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span><span class="main">∈</span> spectrum <span class="free">A</span>"</span></span> 
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"Re <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ar <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Re <span class="skolem">x</span> <span class="main">∈</span> <span class="main">{</span><span class="free">a</span><span class="main">,</span><span class="free">b</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span><span class="main">∈</span> spectrum <span class="free">A</span>›</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">{</span>complex_of_real <span class="free">a</span><span class="main">,</span> complex_of_real <span class="free">b</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹Re <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">x</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span>complex_of_real <span class="free">a</span><span class="main">,</span> complex_of_real <span class="free">b</span><span class="main">}</span> <span class="main">⊆</span> spectrum <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">{</span>complex_of_real <span class="free">a</span><span class="main">,</span> complex_of_real <span class="free">b</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">{</span>complex_of_real <span class="main">(</span>Re <span class="bound">x</span><span class="main">)</span> <span class="main">|</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> spectrum <span class="free">A</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">r</span><span class="main">.</span> <span class="bound">r</span> <span class="main">∉</span> <span class="main">{</span><span class="free">a</span><span class="main">,</span> <span class="free">b</span><span class="main">}</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound">c</span><span class="main">.</span> <span class="bound">r</span> <span class="main">=</span> Re <span class="bound">c</span> <span class="main">∧</span> <span class="bound">c</span> <span class="main">∈</span> spectrum <span class="free">A</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">{</span>Re <span class="bound">x</span> <span class="main">|</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> spectrum <span class="free">A</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="free">a</span><span class="main">,</span> <span class="free">b</span><span class="main">}</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> <span class="main">{</span>complex_of_real <span class="free">a</span><span class="main">,</span> complex_of_real <span class="free">b</span><span class="main">}</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span><span class="main">∈</span> spectrum <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ar <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Similar properties for eigenvalues rather than spectrum indices›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹In this part we go the other way round: given an eigenvalue of $A$, \verb+spectrum_to_pm_idx+ 
permits to retrieve its index in the associated projective measurement›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> cpx_sq_mat<span class="main">)</span> <span class="entity">spectrum_to_pm_idx</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">spectrum_to_pm_idx</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">let</span> <span class="main">(</span><span class="bound">B</span><span class="main">,</span><span class="bound">U</span><span class="main">,</span><span class="main"><span class="bound">_</span></span><span class="main">)</span> <span class="main">=</span> unitary_schur_decomposition <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">(</span>eigvals <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span> <span class="keyword1">in</span> 
    diag_el_to_idx <span class="bound">B</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> cpx_sq_mat<span class="main">)</span> spectrum_to_pm_idx_bij<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"hermitian <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span><span class="main">∈</span> <span class="free">fc_mats</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"bij_betw <span class="main">(</span>spectrum_to_pm_idx <span class="free">A</span><span class="main">)</span> <span class="main">(</span>spectrum <span class="free">A</span><span class="main">)</span> <span class="main">{..&lt;</span> card <span class="main">(</span>spectrum <span class="free">A</span><span class="main">)</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">=</span> proj_meas_size <span class="main">(</span>make_pm <span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">M</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">M</span> <span class="main">=</span> proj_meas_outcomes <span class="main">(</span>make_pm <span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> es<span class="main">:</span> <span class="quoted"><span class="quoted">"char_poly <span class="free">A</span> <span class="main">=</span> <span class="main">(</span><span class="main">∏</span> <span class="main">(</span><span class="bound">e</span> <span class="main">::</span> complex<span class="main">)</span> <span class="main">←</span> <span class="main">(</span>eigvals <span class="free">A</span><span class="main">)</span><span class="main">.</span> <span class="main">[:</span><span class="main">-</span> <span class="bound">e</span><span class="main">,</span> <span class="main">1</span><span class="main">:]</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> assms fc_mats_carrier eigvals_poly_length dim_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">B</span></span> <span class="skolem"><span class="skolem">U</span></span> <span class="skolem"><span class="skolem">Q</span></span> <span class="keyword2"><span class="keyword">where</span></span> us<span class="main">:</span> <span class="quoted"><span class="quoted">"unitary_schur_decomposition <span class="free">A</span> <span class="main">(</span>eigvals <span class="free">A</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">B</span><span class="main">,</span><span class="skolem">U</span><span class="main">,</span><span class="skolem">Q</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"unitary_schur_decomposition <span class="free">A</span> <span class="main">(</span>eigvals <span class="free">A</span><span class="main">)</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> pr<span class="main">:</span> <span class="quoted"><span class="quoted">"similar_mat_wit <span class="free">A</span> <span class="skolem">B</span> <span class="skolem">U</span> <span class="main">(</span>Complex_Matrix.adjoint <span class="skolem">U</span><span class="main">)</span> <span class="main">∧</span> 
      diag_mat <span class="skolem">B</span> <span class="main">=</span> <span class="main">(</span>eigvals <span class="free">A</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> hermitian_eigenvalue_real assms fc_mats_carrier es dim_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">p</span><span class="main">,</span><span class="skolem">M</span><span class="main">)</span> <span class="main">=</span> make_pm <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> p_def M_def <span class="keyword1"><span class="command">using</span></span> make_pm_decomp <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">=</span> dist_el_card <span class="skolem">B</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms us <span class="keyword1"><span class="command">unfolding</span></span> make_pm_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> dimB<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">B</span> <span class="main">∈</span> carrier_mat <span class="free">dimR</span> <span class="free">dimR</span>"</span></span> <span class="keyword1"><span class="command">using</span></span>  dim_eq pr assms 
      fc_mats_carrier <span class="keyword1"><span class="command">unfolding</span></span> similar_mat_wit_def  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> Bvals<span class="main">:</span> <span class="quoted"><span class="quoted">"diag_mat <span class="skolem">B</span> <span class="main">=</span> eigvals <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> pr hermitian_decomp_eigenvalues<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">A</span></span> <span class="quoted"><span class="skolem">B</span></span> <span class="quoted"><span class="skolem">U</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"diag_elems <span class="skolem">B</span> <span class="main">=</span> spectrum <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> spectrum_def <span class="keyword1"><span class="command">using</span></span> dimB Bvals 
      diag_elems_set_diag_mat<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">B</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"dist_el_card <span class="skolem">B</span> <span class="main">=</span> card <span class="main">(</span>spectrum <span class="free">A</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> spectrum_size<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">A</span></span> <span class="quoted"><span class="skolem">p</span></span> <span class="quoted"><span class="skolem">M</span></span><span class="main">]</span> assms 
      <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">p</span><span class="main">,</span><span class="skolem">M</span><span class="main">)</span> <span class="main">=</span> make_pm <span class="free">A</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="main">=</span> dist_el_card <span class="skolem">B</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> 
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"bij_betw <span class="main">(</span>spectrum_to_pm_idx <span class="free">A</span><span class="main">)</span> <span class="main">(</span>spectrum <span class="free">A</span><span class="main">)</span> <span class="main">{..&lt;</span> card <span class="main">(</span>spectrum <span class="free">A</span><span class="main">)</span><span class="main">}</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> diag_el_to_idx_bij us <span class="keyword1"><span class="command">unfolding</span></span> spectrum_to_pm_idx_def Let_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> bij_betw_cong case_prod_conv<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> cpx_sq_mat<span class="main">)</span> spectrum_to_pm_idx_lt_card<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span><span class="main">∈</span> <span class="free">fc_mats</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"hermitian <span class="free">A</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span><span class="main">∈</span> spectrum <span class="free">A</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"spectrum_to_pm_idx <span class="free">A</span> <span class="free">a</span> <span class="main">&lt;</span> card <span class="main">(</span>spectrum <span class="free">A</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> spectrum_to_pm_idx_bij<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">A</span></span><span class="main">]</span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> bij_betw_apply lessThan_iff<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> cpx_sq_mat<span class="main">)</span> spectrum_to_pm_idx_inj<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"hermitian <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span><span class="main">∈</span> <span class="free">fc_mats</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"inj_on <span class="main">(</span>spectrum_to_pm_idx <span class="free">A</span><span class="main">)</span> <span class="main">(</span>spectrum <span class="free">A</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms spectrum_to_pm_idx_bij
  <span class="keyword1"><span class="command">unfolding</span></span> bij_betw_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> cpx_sq_mat<span class="main">)</span> spectrum_meas_outcome_val_inv<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span><span class="main">∈</span> <span class="free">fc_mats</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"hermitian <span class="free">A</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"make_pm <span class="free">A</span> <span class="main">=</span> <span class="main">(</span><span class="free">p</span><span class="main">,</span><span class="free">M</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> <span class="free">p</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"spectrum_to_pm_idx <span class="free">A</span> <span class="main">(</span>meas_outcome_val <span class="main">(</span><span class="free">M</span> <span class="free">i</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">i</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> es<span class="main">:</span> <span class="quoted"><span class="quoted">"char_poly <span class="free">A</span> <span class="main">=</span> <span class="main">(</span><span class="main">∏</span> <span class="main">(</span><span class="bound">e</span> <span class="main">::</span> complex<span class="main">)</span> <span class="main">←</span> <span class="main">(</span>eigvals <span class="free">A</span><span class="main">)</span><span class="main">.</span> <span class="main">[:</span><span class="main">-</span> <span class="bound">e</span><span class="main">,</span> <span class="main">1</span><span class="main">:]</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> assms fc_mats_carrier eigvals_poly_length dim_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">B</span></span> <span class="skolem"><span class="skolem">U</span></span> <span class="skolem"><span class="skolem">Q</span></span> <span class="keyword2"><span class="keyword">where</span></span> us<span class="main">:</span> <span class="quoted"><span class="quoted">"unitary_schur_decomposition <span class="free">A</span> <span class="main">(</span>eigvals <span class="free">A</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">B</span><span class="main">,</span><span class="skolem">U</span><span class="main">,</span><span class="skolem">Q</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"unitary_schur_decomposition <span class="free">A</span> <span class="main">(</span>eigvals <span class="free">A</span><span class="main">)</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> pr<span class="main">:</span> <span class="quoted"><span class="quoted">"similar_mat_wit <span class="free">A</span> <span class="skolem">B</span> <span class="skolem">U</span> <span class="main">(</span>Complex_Matrix.adjoint <span class="skolem">U</span><span class="main">)</span> <span class="main">∧</span> 
    diag_mat <span class="skolem">B</span> <span class="main">=</span> <span class="main">(</span>eigvals <span class="free">A</span><span class="main">)</span> <span class="main">∧</span>  <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> <span class="free">dimR</span><span class="main">.</span> <span class="skolem">B</span><span class="main">$$</span><span class="main">(</span><span class="bound">i</span><span class="main">,</span> <span class="bound">i</span><span class="main">)</span> <span class="main">∈</span> Reals<span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> hermitian_eigenvalue_real assms fc_mats_carrier es dim_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"dim_row <span class="skolem">B</span> <span class="main">=</span> <span class="free">dimR</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms fc_mats_carrier dim_eq similar_mat_wit_dim_row<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">A</span></span><span class="main">]</span>  
      pr <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">p</span><span class="main">,</span><span class="free">M</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>dist_el_card <span class="skolem">B</span><span class="main">,</span> mk_meas_outcome <span class="skolem">B</span> <span class="skolem">U</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms us 
    <span class="keyword1"><span class="command">unfolding</span></span> make_pm_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">=</span> mk_meas_outcome <span class="skolem">B</span> <span class="skolem">U</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"meas_outcome_val <span class="main">(</span><span class="free">M</span> <span class="free">i</span><span class="main">)</span> <span class="main">=</span> Re <span class="main">(</span>diag_idx_to_el <span class="skolem">B</span> <span class="free">i</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">M</span> <span class="main">=</span> mk_meas_outcome <span class="skolem">B</span> <span class="skolem">U</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> mk_meas_outcome_def 
      meas_outcome_val_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> diag_idx_to_el <span class="skolem">B</span> <span class="free">i</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> pr
    <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="free">p</span><span class="main">,</span> <span class="free">M</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>dist_el_card <span class="skolem">B</span><span class="main">,</span> mk_meas_outcome <span class="skolem">B</span> <span class="skolem">U</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹dim_row <span class="skolem">B</span> <span class="main">=</span> <span class="free">dimR</span>›</span></span> assms 
    diag_idx_to_el_real <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"meas_outcome_val <span class="main">(</span><span class="free">M</span> <span class="free">i</span><span class="main">)</span> <span class="main">=</span> diag_idx_to_el <span class="skolem">B</span> <span class="free">i</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"spectrum_to_pm_idx <span class="free">A</span> <span class="main">(</span>meas_outcome_val <span class="main">(</span><span class="free">M</span> <span class="free">i</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
    spectrum_to_pm_idx <span class="free">A</span> <span class="main">(</span>diag_idx_to_el <span class="skolem">B</span> <span class="free">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> diag_el_to_idx <span class="skolem">B</span> <span class="main">(</span>diag_idx_to_el <span class="skolem">B</span> <span class="free">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> spectrum_to_pm_idx_def 
    <span class="keyword1"><span class="command">using</span></span> us <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="free">i</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> diag_el_to_idx_def
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="free">p</span><span class="main">,</span> <span class="free">M</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>dist_el_card <span class="skolem">B</span><span class="main">,</span> mk_meas_outcome <span class="skolem">B</span> <span class="skolem">U</span><span class="main">)</span>›</span></span> bij_betw_inv_into_left 
      diag_idx_to_el_bij <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> cpx_sq_mat<span class="main">)</span> meas_outcome_val_spectrum_inv<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span><span class="main">∈</span> <span class="free">fc_mats</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"hermitian <span class="free">A</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main">∈</span> spectrum <span class="free">A</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"make_pm <span class="free">A</span> <span class="main">=</span> <span class="main">(</span><span class="free">p</span><span class="main">,</span><span class="free">M</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"meas_outcome_val <span class="main">(</span><span class="free">M</span> <span class="main">(</span>spectrum_to_pm_idx <span class="free">A</span> <span class="free">x</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">x</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> es<span class="main">:</span> <span class="quoted"><span class="quoted">"char_poly <span class="free">A</span> <span class="main">=</span> <span class="main">(</span><span class="main">∏</span> <span class="main">(</span><span class="bound">e</span> <span class="main">::</span> complex<span class="main">)</span> <span class="main">←</span> <span class="main">(</span>eigvals <span class="free">A</span><span class="main">)</span><span class="main">.</span> <span class="main">[:</span><span class="main">-</span> <span class="bound">e</span><span class="main">,</span> <span class="main">1</span><span class="main">:]</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> assms fc_mats_carrier eigvals_poly_length dim_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">B</span></span> <span class="skolem"><span class="skolem">U</span></span> <span class="skolem"><span class="skolem">Q</span></span> <span class="keyword2"><span class="keyword">where</span></span> us<span class="main">:</span> <span class="quoted"><span class="quoted">"unitary_schur_decomposition <span class="free">A</span> <span class="main">(</span>eigvals <span class="free">A</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">B</span><span class="main">,</span><span class="skolem">U</span><span class="main">,</span><span class="skolem">Q</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"unitary_schur_decomposition <span class="free">A</span> <span class="main">(</span>eigvals <span class="free">A</span><span class="main">)</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> pr<span class="main">:</span> <span class="quoted"><span class="quoted">"similar_mat_wit <span class="free">A</span> <span class="skolem">B</span> <span class="skolem">U</span> <span class="main">(</span>Complex_Matrix.adjoint <span class="skolem">U</span><span class="main">)</span> <span class="main">∧</span> diagonal_mat <span class="skolem">B</span> <span class="main">∧</span> 
      diag_mat <span class="skolem">B</span> <span class="main">=</span> <span class="main">(</span>eigvals <span class="free">A</span><span class="main">)</span> <span class="main">∧</span> unitary <span class="skolem">U</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> <span class="free">dimR</span><span class="main">.</span> <span class="skolem">B</span><span class="main">$$</span><span class="main">(</span><span class="bound">i</span><span class="main">,</span> <span class="bound">i</span><span class="main">)</span> <span class="main">∈</span> Reals<span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> hermitian_eigenvalue_real assms fc_mats_carrier es dim_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"dim_row <span class="skolem">B</span> <span class="main">=</span> <span class="free">dimR</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms fc_mats_carrier dim_eq similar_mat_wit_dim_row<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">A</span></span><span class="main">]</span>  
        pr <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">p</span><span class="main">,</span><span class="free">M</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>dist_el_card <span class="skolem">B</span><span class="main">,</span> mk_meas_outcome <span class="skolem">B</span> <span class="skolem">U</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms us 
      <span class="keyword1"><span class="command">unfolding</span></span> make_pm_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">=</span> mk_meas_outcome <span class="skolem">B</span> <span class="skolem">U</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span>  <span class="quoted"><span class="quoted">"diag_mat <span class="skolem">B</span> <span class="main">=</span> <span class="main">(</span>eigvals <span class="free">A</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> pr <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> set <span class="main">(</span>diag_mat <span class="skolem">B</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹diag_mat <span class="skolem">B</span> <span class="main">=</span> eigvals <span class="free">A</span>›</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> spectrum_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> diag_elems <span class="skolem">B</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> diag_elems_set_diag_mat<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">B</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"diag_idx_to_el <span class="skolem">B</span> <span class="main">(</span>diag_el_to_idx <span class="skolem">B</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> diag_el_to_idx_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> bij_betw_inv_into_right diag_idx_to_el_bij<span class="main">)</span> 
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"spectrum_to_pm_idx <span class="free">A</span> <span class="free">x</span> <span class="main">=</span> diag_el_to_idx <span class="skolem">B</span> <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> spectrum_to_pm_idx_def 
    <span class="keyword1"><span class="command">using</span></span> us <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"meas_outcome_val <span class="main">(</span><span class="free">M</span> <span class="main">(</span>spectrum_to_pm_idx <span class="free">A</span> <span class="free">x</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
    Re <span class="main">(</span>diag_idx_to_el <span class="skolem">B</span> <span class="main">(</span>diag_el_to_idx <span class="skolem">B</span> <span class="free">x</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">M</span> <span class="main">=</span> mk_meas_outcome <span class="skolem">B</span> <span class="skolem">U</span>›</span></span> 
    <span class="keyword1"><span class="command">unfolding</span></span> mk_meas_outcome_def meas_outcome_val_def  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> calculation<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>
  
<span class="keyword1"><span class="command">definition</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> cpx_sq_mat<span class="main">)</span> <span class="entity">eigen_projector</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">eigen_projector</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">=</span> 
  meas_outcome_prj <span class="main">(</span><span class="main">(</span>proj_meas_outcomes <span class="main">(</span>make_pm <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>spectrum_to_pm_idx <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> cpx_sq_mat<span class="main">)</span> eigen_projector_carrier<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span><span class="main">∈</span> <span class="free">fc_mats</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span><span class="main">∈</span> spectrum <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"hermitian <span class="free">A</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"eigen_projector <span class="free">A</span> <span class="free">a</span> <span class="main">∈</span> <span class="free">fc_mats</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> eigen_projector_def 
  <span class="keyword1"><span class="command">using</span></span> meas_outcome_prj_carrier<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">A</span></span> <span class="quoted"><span class="quoted">"spectrum_to_pm_idx <span class="free">A</span> <span class="free">a</span>"</span></span><span class="main">]</span> 
    spectrum_to_pm_idx_lt_card<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">A</span></span> <span class="quoted"><span class="free">a</span></span><span class="main">]</span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We obtain the following result, which is similar to \verb+make_pm_sum+ but with a sum on 
the elements of the spectrum of Hermitian matrix $A$, which is a more standard statement of the 
spectral decomposition theorem.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> cpx_sq_mat<span class="main">)</span> make_pm_sum'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">∈</span> <span class="free">fc_mats</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"hermitian <span class="free">A</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sum_mat <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span>  <span class="bound">a</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>m</sub></span> <span class="main">(</span>eigen_projector <span class="free">A</span> <span class="bound">a</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>spectrum <span class="free">A</span><span class="main">)</span> <span class="main">=</span> <span class="free">A</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">=</span> proj_meas_size <span class="main">(</span>make_pm <span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">M</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">M</span> <span class="main">=</span> proj_meas_outcomes <span class="main">(</span>make_pm <span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">p</span><span class="main">,</span><span class="skolem">M</span><span class="main">)</span> <span class="main">=</span> make_pm <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> p_def M_def <span class="keyword1"><span class="command">using</span></span> make_pm_decomp <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">g</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
    <span class="quoted"><span class="quoted">"<span class="skolem">g</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="main">(</span><span class="keyword1">if</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="skolem">p</span> 
      <span class="keyword1">then</span> complex_of_real <span class="main">(</span>meas_outcome_val <span class="main">(</span><span class="skolem">M</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>m</sub></span> meas_outcome_prj <span class="main">(</span><span class="skolem">M</span> <span class="bound">i</span><span class="main">)</span> 
      <span class="keyword1">else</span> <span class="main">(</span><span class="keyword1">0<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">dimR</span> <span class="free">dimC</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> g<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="skolem">g</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">fc_mats</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">g</span> <span class="skolem">x</span> <span class="main">∈</span> <span class="free">fc_mats</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">&lt;</span> <span class="skolem">p</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>meas_outcome_val <span class="main">(</span><span class="skolem">M</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>m</sub></span> meas_outcome_prj <span class="main">(</span><span class="skolem">M</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">∈</span> <span class="free">fc_mats</span>"</span></span> 
        <span class="keyword1"><span class="command">using</span></span> meas_outcome_prj_carrier
        spectrum_size assms cpx_sq_mat_smult make_pm_proj_measurement proj_measurement_square 
        <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">p</span><span class="main">,</span><span class="skolem">M</span><span class="main">)</span> <span class="main">=</span> make_pm <span class="free">A</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> g_def <span class="keyword1"><span class="command">using</span></span> True <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> g_def <span class="keyword1"><span class="command">using</span></span> zero_mem <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">h</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">h</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> <span class="main">(</span><span class="keyword1">if</span> <span class="bound">a</span> <span class="main">∈</span> <span class="main">(</span>spectrum <span class="free">A</span><span class="main">)</span> <span class="keyword1">then</span> <span class="bound">a</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>m</sub></span> eigen_projector <span class="free">A</span> <span class="bound">a</span> <span class="keyword1">else</span> <span class="main">(</span><span class="keyword1">0<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">dimR</span> <span class="free">dimC</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> h<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="skolem">h</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">fc_mats</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">h</span> <span class="skolem">x</span> <span class="main">∈</span> <span class="free">fc_mats</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span><span class="main">∈</span> spectrum <span class="free">A</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> h_def <span class="keyword1"><span class="command">using</span></span> eigen_projector_carrier<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">A</span></span> <span class="quoted"><span class="skolem">x</span></span><span class="main">]</span> assms True
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cpx_sq_mat_smult<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> h_def <span class="keyword1"><span class="command">using</span></span> zero_mem <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"inj_on <span class="main">(</span>spectrum_to_pm_idx <span class="free">A</span><span class="main">)</span> <span class="main">(</span>spectrum <span class="free">A</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms spectrum_to_pm_idx_inj <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{..&lt;</span><span class="skolem">p</span><span class="main">}</span> <span class="main">=</span> spectrum_to_pm_idx <span class="free">A</span> <span class="main">`</span> spectrum <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">p</span><span class="main">,</span><span class="skolem">M</span><span class="main">)</span> <span class="main">=</span> make_pm <span class="free">A</span>›</span></span>
    spectrum_to_pm_idx_bij spectrum_size <span class="keyword1"><span class="command">unfolding</span></span> bij_betw_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span> 
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> spectrum <span class="free">A</span> <span class="main">⟹</span> <span class="skolem">g</span> <span class="main">(</span>spectrum_to_pm_idx <span class="free">A</span> <span class="bound">x</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">h</span> <span class="bound">x</span>"</span></span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∈</span> spectrum <span class="free">A</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"Re <span class="skolem">a</span> <span class="main">=</span> <span class="skolem">a</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> hermitian_spectrum_real assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> 
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"spectrum_to_pm_idx <span class="free">A</span> <span class="skolem">a</span> <span class="main">&lt;</span> <span class="skolem">p</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> spectrum_to_pm_idx_lt_card<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">A</span></span><span class="main">]</span> spectrum_size assms 
      <span class="quoted"><span class="quoted">‹<span class="skolem">a</span> <span class="main">∈</span> spectrum <span class="free">A</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">p</span><span class="main">,</span><span class="skolem">M</span><span class="main">)</span> <span class="main">=</span> make_pm <span class="free">A</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">g</span> <span class="main">(</span>spectrum_to_pm_idx <span class="free">A</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">=</span> 
      <span class="main">(</span>meas_outcome_val <span class="main">(</span><span class="skolem">M</span> <span class="main">(</span>spectrum_to_pm_idx <span class="free">A</span> <span class="skolem">a</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>m</sub></span> 
      meas_outcome_prj <span class="main">(</span><span class="skolem">M</span> <span class="main">(</span>spectrum_to_pm_idx <span class="free">A</span> <span class="skolem">a</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹spectrum_to_pm_idx <span class="free">A</span> <span class="skolem">a</span> <span class="main">&lt;</span> <span class="skolem">p</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> g_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="skolem">a</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>m</sub></span> meas_outcome_prj <span class="main">(</span><span class="skolem">M</span> <span class="main">(</span>spectrum_to_pm_idx <span class="free">A</span> <span class="skolem">a</span><span class="main">)</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> meas_outcome_val_spectrum_inv<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">A</span></span> <span class="quoted"><span class="quoted">"Re <span class="skolem">a</span>"</span></span><span class="main">]</span> <span class="quoted"><span class="quoted">‹Re <span class="skolem">a</span> <span class="main">=</span> <span class="skolem">a</span>›</span></span> assms <span class="quoted"><span class="quoted">‹<span class="skolem">a</span> <span class="main">∈</span> spectrum <span class="free">A</span>›</span></span> 
        <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">p</span><span class="main">,</span><span class="skolem">M</span><span class="main">)</span> <span class="main">=</span> make_pm <span class="free">A</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="skolem">h</span> <span class="skolem">a</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">a</span> <span class="main">∈</span> spectrum <span class="free">A</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> eigen_projector_def M_def h_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">g</span> <span class="main">(</span>spectrum_to_pm_idx <span class="free">A</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">h</span> <span class="skolem">a</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sum_mat <span class="skolem">h</span> <span class="main">(</span>spectrum <span class="free">A</span><span class="main">)</span> <span class="main">=</span> 
    sum_mat <span class="skolem">g</span> <span class="main">(</span>spectrum_to_pm_idx <span class="free">A</span> <span class="main">`</span> spectrum <span class="free">A</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> sum_mat_def
    <span class="keyword1"><span class="command">using</span></span>   sum_with_reindex_cong<span class="main">[</span><span class="operator">symmetric</span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">g</span></span> <span class="quoted"><span class="skolem">h</span></span> <span class="quoted"><span class="quoted">"spectrum_to_pm_idx <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"spectrum <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">{..&lt;</span> <span class="skolem">p</span><span class="main">}</span>"</span></span><span class="main">]</span> 
      g h <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> sum_mat <span class="skolem">g</span> <span class="main">{..&lt;</span> <span class="skolem">p</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">{..&lt;</span><span class="skolem">p</span><span class="main">}</span> <span class="main">=</span> spectrum_to_pm_idx <span class="free">A</span> <span class="main">`</span> spectrum <span class="free">A</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> sum_mat <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="main">(</span>meas_outcome_val <span class="main">(</span><span class="skolem">M</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>m</sub></span> meas_outcome_prj <span class="main">(</span><span class="skolem">M</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">{..&lt;</span><span class="skolem">p</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> sum_mat_cong<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> <span class="main">{..&lt;</span> <span class="skolem">p</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> <span class="skolem">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">g</span> <span class="skolem">i</span> <span class="main">∈</span> <span class="free">fc_mats</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> g <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">g</span> <span class="skolem">i</span> <span class="main">=</span> <span class="main">(</span>meas_outcome_val <span class="main">(</span><span class="skolem">M</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>m</sub></span> meas_outcome_prj <span class="main">(</span><span class="skolem">M</span> <span class="skolem">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> g_def 
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">&lt;</span> <span class="skolem">p</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>meas_outcome_val <span class="main">(</span><span class="skolem">M</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>m</sub></span> meas_outcome_prj <span class="main">(</span><span class="skolem">M</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">∈</span> <span class="free">fc_mats</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> meas_outcome_prj_carrier spectrum_size assms cpx_sq_mat_smult 
        make_pm_proj_measurement proj_measurement_square <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">&lt;</span> <span class="skolem">p</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">p</span><span class="main">,</span><span class="skolem">M</span><span class="main">)</span> <span class="main">=</span> make_pm <span class="free">A</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> make_pm_sum assms <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">p</span><span class="main">,</span><span class="skolem">M</span><span class="main">)</span> <span class="main">=</span> make_pm <span class="free">A</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> g_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sum_mat <span class="skolem">h</span> <span class="main">(</span>spectrum <span class="free">A</span><span class="main">)</span> <span class="main">=</span> <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sum_mat <span class="skolem">h</span> <span class="main">(</span>spectrum <span class="free">A</span><span class="main">)</span> <span class="main">=</span> sum_mat <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span>  <span class="bound">a</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>m</sub></span> <span class="main">(</span>eigen_projector <span class="free">A</span> <span class="bound">a</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>spectrum <span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> sum_mat_cong<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>spectrum <span class="free">A</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> spectrum_finite<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">A</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span><span class="main">∈</span> spectrum <span class="free">A</span>"</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">h</span> <span class="skolem">i</span> <span class="main">=</span> <span class="skolem">i</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>m</sub></span> eigen_projector <span class="free">A</span> <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> h_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">h</span> <span class="skolem">i</span> <span class="main">∈</span> <span class="free">fc_mats</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> h <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>m</sub></span> eigen_projector <span class="free">A</span> <span class="skolem">i</span> <span class="main">∈</span> <span class="free">fc_mats</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> eigen_projector_carrier<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">A</span></span> <span class="quoted"><span class="skolem">i</span></span><span class="main">]</span> assms 
        <span class="quoted"><span class="quoted">‹<span class="skolem">i</span><span class="main">∈</span> spectrum <span class="free">A</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹<span class="skolem">h</span> <span class="skolem">i</span> <span class="main">=</span> <span class="skolem">i</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>m</sub></span> eigen_projector <span class="free">A</span> <span class="skolem">i</span>›</span></span> h<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>



<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="CHSH_Inequality">
<div class="head">
<h1>Theory CHSH_Inequality</h1>
</div>
<pre class="source"><span class="comment1">(*
Author: 
  Mnacho Echenim, Université Grenoble Alpes
*)</span>

<span class="keyword1"><span class="command">theory</span></span> CHSH_Inequality <span class="keyword2"><span class="keyword">imports</span></span> 
  <a href="#Projective_Measurements">Projective_Measurements</a>


<span class="keyword2"><span class="keyword">begin</span></span>


<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹The CHSH inequality›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The local hidden variable assumption for quantum  mechanics was developed to make the case 
that quantum theory was incomplete. In this part we formalize the CHSH inequality, which provides 
an upper-bound of a quantity involving expectations in a probability space, and exploit this 
inequality to show that the local hidden variable assumption does not hold.›</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Inequality statement›</span></span>

<span class="keyword1" id="CHSH_Inequality-chsh_real"><span class="command">lemma</span></span> chsh_real<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A0</span><span class="main">::</span><span class="quoted">real</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">¦</span><span class="free">A0</span> <span class="main">*</span> <span class="free">B1</span><span class="main">¦</span> <span class="main">≤</span> <span class="main">1</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">¦</span><span class="free">A0</span> <span class="main">*</span> <span class="free">B0</span><span class="main">¦</span> <span class="main">≤</span> <span class="main">1</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">¦</span><span class="free">A1</span> <span class="main">*</span> <span class="free">B0</span><span class="main">¦</span> <span class="main">≤</span> <span class="main">1</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">¦</span><span class="free">A1</span> <span class="main">*</span> <span class="free">B1</span><span class="main">¦</span> <span class="main">≤</span> <span class="main">1</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">¦</span><span class="free">A0</span> <span class="main">*</span> <span class="free">B1</span> <span class="main">-</span> <span class="free">A0</span> <span class="main">*</span> <span class="free">B0</span> <span class="main">+</span> <span class="free">A1</span> <span class="main">*</span> <span class="free">B0</span> <span class="main">+</span> <span class="free">A1</span><span class="main">*</span><span class="free">B1</span><span class="main">¦</span> <span class="main">≤</span> <span class="numeral">2</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">A0</span> <span class="main">*</span> <span class="free">B1</span> <span class="main">-</span> <span class="free">A0</span> <span class="main">*</span> <span class="free">B0</span> <span class="main">=</span> <span class="free">A0</span> <span class="main">*</span> <span class="free">B1</span> <span class="main">-</span> <span class="free">A0</span> <span class="main">*</span> <span class="free">B0</span> <span class="main">+</span> <span class="free">A0</span> <span class="main">*</span> <span class="free">B1</span> <span class="main">*</span> <span class="free">A1</span> <span class="main">*</span> <span class="free">B0</span> <span class="main">-</span> <span class="free">A0</span> <span class="main">*</span> <span class="free">B1</span> <span class="main">*</span> <span class="free">A1</span> <span class="main">*</span> <span class="free">B0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="free">A0</span> <span class="main">*</span> <span class="free">B1</span> <span class="main">*</span> <span class="main">(</span><span class="main">1</span> <span class="main">+</span> <span class="free">A1</span><span class="main">*</span><span class="free">B0</span><span class="main">)</span> <span class="main">-</span> <span class="free">A0</span> <span class="main">*</span> <span class="free">B0</span> <span class="main">*</span> <span class="main">(</span><span class="main">1</span> <span class="main">+</span> <span class="free">A1</span><span class="main">*</span> <span class="free">B1</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> hide_lams<span class="main"><span class="main">)</span></span> add_diff_cancel_right calculation diff_add_eq 
        group_cancel.sub1 mult.commute mult.right_neutral 
        vector_space_over_itself.scale_left_commute 
        vector_space_over_itself.scale_right_diff_distrib 
        vector_space_over_itself.scale_right_distrib 
        vector_space_over_itself.scale_scale<span class="main">)</span> 
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">A0</span> <span class="main">*</span> <span class="free">B1</span> <span class="main">-</span> <span class="free">A0</span> <span class="main">*</span> <span class="free">B0</span> <span class="main">=</span> <span class="free">A0</span> <span class="main">*</span> <span class="free">B1</span> <span class="main">*</span> <span class="main">(</span><span class="main">1</span> <span class="main">+</span> <span class="free">A1</span><span class="main">*</span><span class="free">B0</span><span class="main">)</span> <span class="main">-</span> <span class="free">A0</span> <span class="main">*</span> <span class="free">B0</span> <span class="main">*</span> <span class="main">(</span><span class="main">1</span> <span class="main">+</span> <span class="free">A1</span><span class="main">*</span> <span class="free">B1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">¦</span><span class="free">A0</span> <span class="main">*</span> <span class="free">B1</span> <span class="main">-</span> <span class="free">A0</span> <span class="main">*</span> <span class="free">B0</span><span class="main">¦</span> <span class="main">≤</span> <span class="main">¦</span><span class="free">A0</span> <span class="main">*</span> <span class="free">B1</span> <span class="main">*</span> <span class="main">(</span><span class="main">1</span> <span class="main">+</span> <span class="free">A1</span><span class="main">*</span><span class="free">B0</span><span class="main">)</span><span class="main">¦</span> <span class="main">+</span> <span class="main">¦</span><span class="free">A0</span> <span class="main">*</span> <span class="free">B0</span> <span class="main">*</span> <span class="main">(</span><span class="main">1</span> <span class="main">+</span> <span class="free">A1</span><span class="main">*</span> <span class="free">B1</span><span class="main">)</span><span class="main">¦</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">¦</span><span class="free">A0</span> <span class="main">*</span> <span class="free">B1</span><span class="main">¦</span> <span class="main">*</span> <span class="main">¦</span><span class="main">(</span><span class="main">1</span> <span class="main">+</span> <span class="free">A1</span><span class="main">*</span><span class="free">B0</span><span class="main">)</span><span class="main">¦</span> <span class="main">+</span> <span class="main">¦</span><span class="free">A0</span> <span class="main">*</span> <span class="free">B0</span><span class="main">¦</span> <span class="main">*</span> <span class="main">¦</span><span class="main">(</span><span class="main">1</span> <span class="main">+</span> <span class="free">A1</span><span class="main">*</span> <span class="free">B1</span><span class="main">)</span><span class="main">¦</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> abs_mult<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">≤</span> <span class="main">¦</span><span class="main">(</span><span class="main">1</span> <span class="main">+</span> <span class="free">A1</span><span class="main">*</span><span class="free">B0</span><span class="main">)</span><span class="main">¦</span> <span class="main">+</span> <span class="main">¦</span><span class="main">(</span><span class="main">1</span> <span class="main">+</span> <span class="free">A1</span><span class="main">*</span> <span class="free">B1</span><span class="main">)</span><span class="main">¦</span>"</span></span> 
  <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¦</span><span class="free">A0</span> <span class="main">*</span> <span class="free">B1</span><span class="main">¦</span> <span class="main">*</span> <span class="main">¦</span><span class="main">(</span><span class="main">1</span> <span class="main">+</span> <span class="free">A1</span><span class="main">*</span><span class="free">B0</span><span class="main">)</span><span class="main">¦</span> <span class="main">≤</span> <span class="main">¦</span><span class="main">(</span><span class="main">1</span> <span class="main">+</span> <span class="free">A1</span><span class="main">*</span><span class="free">B0</span><span class="main">)</span><span class="main">¦</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> mult_left_le_one_le<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">¦</span><span class="main">(</span><span class="main">1</span> <span class="main">+</span> <span class="free">A1</span><span class="main">*</span><span class="free">B0</span><span class="main">)</span><span class="main">¦</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¦</span><span class="free">A0</span> <span class="main">*</span> <span class="free">B0</span><span class="main">¦</span> <span class="main">*</span><span class="main">¦</span><span class="main">(</span><span class="main">1</span> <span class="main">+</span> <span class="free">A1</span><span class="main">*</span> <span class="free">B1</span><span class="main">)</span><span class="main">¦</span> <span class="main">≤</span> <span class="main">¦</span><span class="main">(</span><span class="main">1</span> <span class="main">+</span> <span class="free">A1</span><span class="main">*</span> <span class="free">B1</span><span class="main">)</span><span class="main">¦</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms mult_left_le_one_le<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">¦</span><span class="main">(</span><span class="main">1</span> <span class="main">+</span> <span class="free">A1</span><span class="main">*</span><span class="free">B1</span><span class="main">)</span><span class="main">¦</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">1</span> <span class="main">+</span> <span class="free">A1</span><span class="main">*</span><span class="free">B0</span> <span class="main">+</span> <span class="main">1</span> <span class="main">+</span> <span class="free">A1</span><span class="main">*</span> <span class="free">B1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> abs_le_iff<span class="main">)</span> 
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">+</span> <span class="free">A1</span> <span class="main">*</span> <span class="free">B0</span> <span class="main">+</span> <span class="free">A1</span> <span class="main">*</span> <span class="free">B1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> pls<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¦</span><span class="free">A0</span> <span class="main">*</span> <span class="free">B1</span> <span class="main">-</span> <span class="free">A0</span> <span class="main">*</span> <span class="free">B0</span><span class="main">¦</span> <span class="main">≤</span> <span class="numeral">2</span> <span class="main">+</span> <span class="free">A1</span> <span class="main">*</span> <span class="free">B0</span> <span class="main">+</span> <span class="free">A1</span> <span class="main">*</span> <span class="free">B1</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">A0</span> <span class="main">*</span> <span class="free">B1</span> <span class="main">-</span> <span class="free">A0</span> <span class="main">*</span> <span class="free">B0</span> <span class="main">=</span> <span class="free">A0</span> <span class="main">*</span> <span class="free">B1</span> <span class="main">-</span> <span class="free">A0</span> <span class="main">*</span> <span class="free">B0</span> <span class="main">+</span> <span class="free">A0</span> <span class="main">*</span> <span class="free">B1</span> <span class="main">*</span> <span class="free">A1</span> <span class="main">*</span> <span class="free">B0</span> <span class="main">-</span> <span class="free">A0</span> <span class="main">*</span> <span class="free">B1</span> <span class="main">*</span> <span class="free">A1</span> <span class="main">*</span> <span class="free">B0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="free">A0</span> <span class="main">*</span> <span class="free">B1</span> <span class="main">*</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">A1</span><span class="main">*</span><span class="free">B0</span><span class="main">)</span> <span class="main">-</span> <span class="free">A0</span> <span class="main">*</span> <span class="free">B0</span> <span class="main">*</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">A1</span><span class="main">*</span> <span class="free">B1</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">A0</span> <span class="main">*</span> <span class="main">(</span><span class="free">B1</span> <span class="main">-</span> <span class="main">(</span><span class="free">B0</span> <span class="main">-</span> <span class="free">A1</span> <span class="main">*</span> <span class="main">(</span><span class="free">B1</span> <span class="main">*</span> <span class="free">B0</span><span class="main">)</span><span class="main">)</span> <span class="main">-</span> <span class="free">A1</span> <span class="main">*</span> <span class="main">(</span><span class="free">B1</span> <span class="main">*</span> <span class="free">B0</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">A0</span> <span class="main">*</span> <span class="main">(</span><span class="free">B1</span> <span class="main">-</span> <span class="free">B0</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> add.commute calculation diff_diff_add mult.right_neutral 
          vector_space_over_itself.scale_left_commute 
          vector_space_over_itself.scale_right_diff_distrib vector_space_over_itself.scale_scale<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">A0</span> <span class="main">*</span> <span class="free">B1</span> <span class="main">-</span> <span class="free">A0</span> <span class="main">*</span> <span class="free">B0</span> <span class="main">=</span> <span class="free">A0</span> <span class="main">*</span> <span class="free">B1</span> <span class="main">*</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">A1</span><span class="main">*</span><span class="free">B0</span><span class="main">)</span> <span class="main">-</span> <span class="free">A0</span> <span class="main">*</span> <span class="free">B0</span> <span class="main">*</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">A1</span><span class="main">*</span> <span class="free">B1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">¦</span><span class="free">A0</span> <span class="main">*</span> <span class="free">B1</span> <span class="main">-</span> <span class="free">A0</span> <span class="main">*</span> <span class="free">B0</span><span class="main">¦</span> <span class="main">≤</span> <span class="main">¦</span><span class="free">A0</span> <span class="main">*</span> <span class="free">B1</span> <span class="main">*</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">A1</span><span class="main">*</span><span class="free">B0</span><span class="main">)</span><span class="main">¦</span> <span class="main">+</span> <span class="main">¦</span><span class="free">A0</span> <span class="main">*</span> <span class="free">B0</span> <span class="main">*</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">A1</span><span class="main">*</span> <span class="free">B1</span><span class="main">)</span><span class="main">¦</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">¦</span><span class="free">A0</span> <span class="main">*</span> <span class="free">B1</span><span class="main">¦</span> <span class="main">*</span> <span class="main">¦</span><span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">A1</span><span class="main">*</span><span class="free">B0</span><span class="main">)</span><span class="main">¦</span> <span class="main">+</span> <span class="main">¦</span><span class="free">A0</span> <span class="main">*</span> <span class="free">B0</span><span class="main">¦</span> <span class="main">*</span> <span class="main">¦</span><span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">A1</span><span class="main">*</span> <span class="free">B1</span><span class="main">)</span><span class="main">¦</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> abs_mult<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">≤</span> <span class="main">¦</span><span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">A1</span><span class="main">*</span><span class="free">B0</span><span class="main">)</span><span class="main">¦</span> <span class="main">+</span> <span class="main">¦</span><span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">A1</span><span class="main">*</span> <span class="free">B1</span><span class="main">)</span><span class="main">¦</span>"</span></span> 
  <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¦</span><span class="free">A0</span> <span class="main">*</span> <span class="free">B1</span><span class="main">¦</span> <span class="main">*</span> <span class="main">¦</span><span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">A1</span><span class="main">*</span><span class="free">B0</span><span class="main">)</span><span class="main">¦</span> <span class="main">≤</span> <span class="main">¦</span><span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">A1</span><span class="main">*</span><span class="free">B0</span><span class="main">)</span><span class="main">¦</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> mult_left_le_one_le<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">¦</span><span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">A1</span><span class="main">*</span><span class="free">B0</span><span class="main">)</span><span class="main">¦</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¦</span><span class="free">A0</span> <span class="main">*</span> <span class="free">B0</span><span class="main">¦</span> <span class="main">*</span><span class="main">¦</span><span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">A1</span><span class="main">*</span> <span class="free">B1</span><span class="main">)</span><span class="main">¦</span> <span class="main">≤</span> <span class="main">¦</span><span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">A1</span><span class="main">*</span> <span class="free">B1</span><span class="main">)</span><span class="main">¦</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms mult_left_le_one_le<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">¦</span><span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">A1</span><span class="main">*</span><span class="free">B1</span><span class="main">)</span><span class="main">¦</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">1</span> <span class="main">-</span> <span class="free">A1</span><span class="main">*</span><span class="free">B0</span> <span class="main">+</span> <span class="main">1</span> <span class="main">-</span> <span class="free">A1</span><span class="main">*</span> <span class="free">B1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> abs_le_iff<span class="main">)</span> 
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">-</span> <span class="free">A1</span> <span class="main">*</span> <span class="free">B0</span> <span class="main">-</span> <span class="free">A1</span> <span class="main">*</span> <span class="free">B1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> mns<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¦</span><span class="free">A0</span> <span class="main">*</span> <span class="free">B1</span> <span class="main">-</span> <span class="free">A0</span> <span class="main">*</span> <span class="free">B0</span><span class="main">¦</span> <span class="main">≤</span> <span class="numeral">2</span> <span class="main">-</span> <span class="main">(</span><span class="free">A1</span> <span class="main">*</span> <span class="free">B0</span> <span class="main">+</span> <span class="free">A1</span> <span class="main">*</span> <span class="free">B1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> ls<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¦</span><span class="free">A0</span> <span class="main">*</span> <span class="free">B1</span> <span class="main">-</span> <span class="free">A0</span> <span class="main">*</span> <span class="free">B0</span><span class="main">¦</span> <span class="main">≤</span> <span class="numeral">2</span> <span class="main">-</span> <span class="main">¦</span><span class="free">A1</span> <span class="main">*</span> <span class="free">B0</span> <span class="main">+</span> <span class="free">A1</span> <span class="main">*</span> <span class="free">B1</span><span class="main">¦</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="free">A1</span> <span class="main">*</span> <span class="free">B0</span> <span class="main">+</span> <span class="free">A1</span> <span class="main">*</span> <span class="free">B1</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> mns <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> pls <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¦</span><span class="free">A0</span> <span class="main">*</span> <span class="free">B1</span> <span class="main">-</span> <span class="free">A0</span> <span class="main">*</span> <span class="free">B0</span> <span class="main">+</span> <span class="free">A1</span> <span class="main">*</span> <span class="free">B0</span> <span class="main">+</span> <span class="free">A1</span> <span class="main">*</span> <span class="free">B1</span><span class="main">¦</span> <span class="main">≤</span> <span class="main">¦</span><span class="free">A0</span> <span class="main">*</span> <span class="free">B1</span> <span class="main">-</span> <span class="free">A0</span> <span class="main">*</span> <span class="free">B0</span><span class="main">¦</span> <span class="main">+</span> <span class="main">¦</span><span class="free">A1</span> <span class="main">*</span> <span class="free">B0</span> <span class="main">+</span> <span class="free">A1</span> <span class="main">*</span> <span class="free">B1</span><span class="main">¦</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">≤</span> <span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ls <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> prob_space<span class="main">)</span> chsh_expect<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A0</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> real"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">AE</span> <span class="bound">w</span> <span class="keyword1">in</span> <span class="free">M</span><span class="main">.</span> <span class="main">¦</span><span class="free">A0</span> <span class="bound">w</span><span class="main">¦</span> <span class="main">≤</span> <span class="main">1</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">AE</span> <span class="bound">w</span> <span class="keyword1">in</span> <span class="free">M</span><span class="main">.</span> <span class="main">¦</span><span class="free">A1</span> <span class="bound">w</span><span class="main">¦</span> <span class="main">≤</span> <span class="main">1</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">AE</span> <span class="bound">w</span> <span class="keyword1">in</span> <span class="free">M</span><span class="main">.</span> <span class="main">¦</span><span class="free">B0</span> <span class="bound">w</span><span class="main">¦</span> <span class="main">≤</span> <span class="main">1</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">AE</span> <span class="bound">w</span> <span class="keyword1">in</span> <span class="free">M</span><span class="main">.</span> <span class="main">¦</span><span class="free">B1</span> <span class="bound">w</span><span class="main">¦</span> <span class="main">≤</span> <span class="main">1</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"integrable <span class="free">M</span> <span class="main">(</span><span class="main">λ</span><span class="bound">w</span><span class="main">.</span> <span class="free">A0</span> <span class="bound">w</span> <span class="main">*</span> <span class="free">B1</span> <span class="bound">w</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"integrable <span class="free">M</span> <span class="main">(</span><span class="main">λ</span><span class="bound">w</span><span class="main">.</span> <span class="free">A1</span> <span class="bound">w</span> <span class="main">*</span> <span class="free">B1</span> <span class="bound">w</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"integrable <span class="free">M</span> <span class="main">(</span><span class="main">λ</span><span class="bound">w</span><span class="main">.</span> <span class="free">A1</span> <span class="bound">w</span> <span class="main">*</span> <span class="free">B0</span> <span class="bound">w</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"integrable <span class="free">M</span> <span class="main">(</span><span class="main">λ</span><span class="bound">w</span><span class="main">.</span> <span class="free">A0</span> <span class="bound">w</span> <span class="main">*</span> <span class="free">B0</span> <span class="bound">w</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">¦</span>expectation <span class="main">(</span><span class="main">λ</span><span class="bound">w</span><span class="main">.</span> <span class="free">A1</span> <span class="bound">w</span> <span class="main">*</span> <span class="free">B0</span> <span class="bound">w</span><span class="main">)</span> <span class="main">+</span> expectation <span class="main">(</span><span class="main">λ</span><span class="bound">w</span><span class="main">.</span> <span class="free">A0</span> <span class="bound">w</span> <span class="main">*</span><span class="free">B1</span> <span class="bound">w</span><span class="main">)</span> <span class="main">+</span> 
  expectation <span class="main">(</span><span class="main">λ</span><span class="bound">w</span><span class="main">.</span> <span class="free">A1</span> <span class="bound">w</span> <span class="main">*</span> <span class="free">B1</span> <span class="bound">w</span><span class="main">)</span> <span class="main">-</span> expectation <span class="main">(</span><span class="main">λ</span><span class="bound">w</span><span class="main">.</span> <span class="free">A0</span> <span class="bound">w</span> <span class="main">*</span> <span class="free">B0</span> <span class="bound">w</span><span class="main">)</span><span class="main">¦</span> <span class="main">≤</span> <span class="numeral">2</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> exeq<span class="main">:</span> <span class="quoted"><span class="quoted">"expectation <span class="main">(</span><span class="main">λ</span><span class="bound">w</span><span class="main">.</span> <span class="free">A1</span> <span class="bound">w</span> <span class="main">*</span> <span class="free">B0</span> <span class="bound">w</span><span class="main">)</span> <span class="main">+</span> expectation <span class="main">(</span><span class="main">λ</span><span class="bound">w</span><span class="main">.</span> <span class="free">A0</span> <span class="bound">w</span> <span class="main">*</span> <span class="free">B1</span> <span class="bound">w</span><span class="main">)</span> <span class="main">+</span> 
    expectation <span class="main">(</span><span class="main">λ</span><span class="bound">w</span><span class="main">.</span> <span class="free">A1</span> <span class="bound">w</span> <span class="main">*</span> <span class="free">B1</span> <span class="bound">w</span><span class="main">)</span> <span class="main">-</span> expectation <span class="main">(</span><span class="main">λ</span><span class="bound">w</span><span class="main">.</span> <span class="free">A0</span> <span class="bound">w</span> <span class="main">*</span> <span class="free">B0</span> <span class="bound">w</span><span class="main">)</span> <span class="main">=</span> 
    expectation <span class="main">(</span><span class="main">λ</span><span class="bound">w</span><span class="main">.</span> <span class="free">A0</span> <span class="bound">w</span> <span class="main">*</span> <span class="free">B1</span> <span class="bound">w</span> <span class="main">-</span> <span class="free">A0</span> <span class="bound">w</span> <span class="main">*</span> <span class="free">B0</span> <span class="bound">w</span> <span class="main">+</span> <span class="free">A1</span> <span class="bound">w</span> <span class="main">*</span> <span class="free">B0</span> <span class="bound">w</span> <span class="main">+</span> <span class="free">A1</span> <span class="bound">w</span> <span class="main">*</span> <span class="free">B1</span> <span class="bound">w</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¦</span>expectation <span class="main">(</span><span class="main">λ</span><span class="bound">w</span><span class="main">.</span> <span class="free">A0</span> <span class="bound">w</span> <span class="main">*</span> <span class="free">B1</span> <span class="bound">w</span> <span class="main">-</span> <span class="free">A0</span> <span class="bound">w</span> <span class="main">*</span> <span class="free">B0</span> <span class="bound">w</span> <span class="main">+</span> <span class="free">A1</span> <span class="bound">w</span> <span class="main">*</span> <span class="free">B0</span> <span class="bound">w</span> <span class="main">+</span> <span class="free">A1</span> <span class="bound">w</span> <span class="main">*</span> <span class="free">B1</span> <span class="bound">w</span><span class="main">)</span><span class="main">¦</span> <span class="main">≤</span>
    expectation <span class="main">(</span><span class="main">λ</span><span class="bound">w</span><span class="main">.</span> <span class="main">¦</span><span class="free">A0</span> <span class="bound">w</span> <span class="main">*</span> <span class="free">B1</span> <span class="bound">w</span> <span class="main">-</span> <span class="free">A0</span> <span class="bound">w</span> <span class="main">*</span> <span class="free">B0</span> <span class="bound">w</span> <span class="main">+</span> <span class="free">A1</span> <span class="bound">w</span> <span class="main">*</span> <span class="free">B0</span> <span class="bound">w</span> <span class="main">+</span> <span class="free">A1</span> <span class="bound">w</span> <span class="main">*</span> <span class="free">B1</span> <span class="bound">w</span><span class="main">¦</span><span class="main">)</span>"</span></span>  
    <span class="keyword1"><span class="command">using</span></span> integral_abs_bound <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">≤</span> <span class="numeral">2</span>"</span></span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> integral_le_const<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">AE</span> <span class="bound">w</span> <span class="keyword1">in</span> <span class="free">M</span><span class="main">.</span> <span class="main">¦</span><span class="free">A0</span> <span class="bound">w</span> <span class="main">*</span> <span class="free">B1</span> <span class="bound">w</span> <span class="main">-</span> <span class="free">A0</span> <span class="bound">w</span> <span class="main">*</span> <span class="free">B0</span> <span class="bound">w</span> <span class="main">+</span> <span class="free">A1</span> <span class="bound">w</span> <span class="main">*</span> <span class="free">B0</span> <span class="bound">w</span> <span class="main">+</span> <span class="free">A1</span> <span class="bound">w</span> <span class="main">*</span> <span class="free">B1</span> <span class="bound">w</span><span class="main">¦</span> <span class="main">≤</span> <span class="main">(</span><span class="numeral">2</span><span class="main">::</span>real<span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> AE_mp<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">AE</span> <span class="bound">w</span> <span class="keyword1">in</span> <span class="free">M</span><span class="main">.</span> <span class="main">¦</span><span class="free">A0</span> <span class="bound">w</span><span class="main">¦</span> <span class="main">≤</span> <span class="main">1</span> <span class="main">∧</span> <span class="main">¦</span><span class="free">A1</span> <span class="bound">w</span><span class="main">¦</span> <span class="main">≤</span> <span class="main">1</span> <span class="main">∧</span> <span class="main">¦</span><span class="free">B0</span> <span class="bound">w</span><span class="main">¦</span> <span class="main">≤</span> <span class="main">1</span> <span class="main">∧</span> <span class="main">¦</span><span class="free">B1</span> <span class="bound">w</span><span class="main">¦</span> <span class="main">≤</span> <span class="main">1</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">AE</span> <span class="bound">w</span> <span class="keyword1">in</span> <span class="free">M</span><span class="main">.</span> <span class="main">¦</span><span class="free">A0</span> <span class="bound">w</span><span class="main">¦</span> <span class="main">≤</span> <span class="main">1</span> <span class="main">∧</span> <span class="main">¦</span><span class="free">A1</span> <span class="bound">w</span><span class="main">¦</span> <span class="main">≤</span> <span class="main">1</span> <span class="main">∧</span> <span class="main">¦</span><span class="free">B0</span> <span class="bound">w</span><span class="main">¦</span> <span class="main">≤</span> <span class="main">1</span> <span class="main">∧</span> <span class="main">¦</span><span class="free">B1</span> <span class="bound">w</span><span class="main">¦</span> <span class="main">≤</span> <span class="main">1</span> <span class="main">⟶</span>
               <span class="main">¦</span><span class="free">A0</span> <span class="bound">w</span> <span class="main">*</span> <span class="free">B1</span> <span class="bound">w</span> <span class="main">-</span> <span class="free">A0</span> <span class="bound">w</span> <span class="main">*</span> <span class="free">B0</span> <span class="bound">w</span> <span class="main">+</span> <span class="free">A1</span> <span class="bound">w</span> <span class="main">*</span> <span class="free">B0</span> <span class="bound">w</span> <span class="main">+</span> <span class="free">A1</span> <span class="bound">w</span> <span class="main">*</span> <span class="free">B1</span> <span class="bound">w</span><span class="main">¦</span> <span class="main">≤</span> <span class="numeral">2</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">w</span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span><span class="main">∈</span> space <span class="free">M</span>"</span></span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">¦</span><span class="free">A0</span> <span class="skolem">w</span><span class="main">¦</span> <span class="main">≤</span> <span class="main">1</span> <span class="main">∧</span> <span class="main">¦</span><span class="free">A1</span> <span class="skolem">w</span><span class="main">¦</span> <span class="main">≤</span> <span class="main">1</span> <span class="main">∧</span> <span class="main">¦</span><span class="free">B0</span> <span class="skolem">w</span><span class="main">¦</span> <span class="main">≤</span> <span class="main">1</span> <span class="main">∧</span> <span class="main">¦</span><span class="free">B1</span> <span class="skolem">w</span><span class="main">¦</span> <span class="main">≤</span> <span class="main">1</span> <span class="main">⟶</span>
         <span class="main">¦</span><span class="free">A0</span> <span class="skolem">w</span> <span class="main">*</span> <span class="free">B1</span> <span class="skolem">w</span> <span class="main">-</span> <span class="free">A0</span> <span class="skolem">w</span> <span class="main">*</span> <span class="free">B0</span> <span class="skolem">w</span> <span class="main">+</span> <span class="free">A1</span> <span class="skolem">w</span> <span class="main">*</span> <span class="free">B0</span> <span class="skolem">w</span> <span class="main">+</span> <span class="free">A1</span> <span class="skolem">w</span> <span class="main">*</span> <span class="free">B1</span> <span class="skolem">w</span><span class="main">¦</span> <span class="main">≤</span> <span class="numeral">2</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> 
          <span class="keyword3"><span class="command">assume</span></span> ineq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¦</span><span class="free">A0</span> <span class="skolem">w</span><span class="main">¦</span> <span class="main">≤</span> <span class="main">1</span> <span class="main">∧</span> <span class="main">¦</span><span class="free">A1</span> <span class="skolem">w</span><span class="main">¦</span> <span class="main">≤</span> <span class="main">1</span> <span class="main">∧</span> <span class="main">¦</span><span class="free">B0</span> <span class="skolem">w</span><span class="main">¦</span> <span class="main">≤</span> <span class="main">1</span> <span class="main">∧</span> <span class="main">¦</span><span class="free">B1</span> <span class="skolem">w</span><span class="main">¦</span> <span class="main">≤</span> <span class="main">1</span>"</span></span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">¦</span><span class="free">A0</span> <span class="skolem">w</span> <span class="main">*</span> <span class="free">B1</span> <span class="skolem">w</span> <span class="main">-</span> <span class="free">A0</span> <span class="skolem">w</span> <span class="main">*</span> <span class="free">B0</span> <span class="skolem">w</span> <span class="main">+</span> <span class="free">A1</span> <span class="skolem">w</span> <span class="main">*</span> <span class="free">B0</span> <span class="skolem">w</span> <span class="main">+</span> <span class="free">A1</span> <span class="skolem">w</span> <span class="main">*</span> <span class="free">B1</span> <span class="skolem">w</span><span class="main">¦</span> <span class="main">≤</span> <span class="numeral">2</span>"</span></span>
          <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> chsh_real<span class="main">)</span>
            <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">¦</span><span class="free">A0</span> <span class="skolem">w</span> <span class="main">*</span> <span class="free">B1</span> <span class="skolem">w</span><span class="main">¦</span> <span class="main">≤</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ineq <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> abs_mult mult_le_one<span class="main">)</span>
            <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">¦</span><span class="free">A0</span> <span class="skolem">w</span> <span class="main">*</span> <span class="free">B0</span> <span class="skolem">w</span><span class="main">¦</span> <span class="main">≤</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ineq <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> abs_mult mult_le_one<span class="main">)</span>
            <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">¦</span><span class="free">A1</span> <span class="skolem">w</span> <span class="main">*</span> <span class="free">B1</span> <span class="skolem">w</span><span class="main">¦</span> <span class="main">≤</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ineq <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> abs_mult mult_le_one<span class="main">)</span>
            <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">¦</span><span class="free">A1</span> <span class="skolem">w</span> <span class="main">*</span> <span class="free">B0</span> <span class="skolem">w</span><span class="main">¦</span> <span class="main">≤</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ineq <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> abs_mult mult_le_one<span class="main">)</span>
          <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"integrable <span class="free">M</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">¦</span><span class="free">A0</span> <span class="bound">x</span> <span class="main">*</span> <span class="free">B1</span> <span class="bound">x</span> <span class="main">-</span> <span class="free">A0</span> <span class="bound">x</span> <span class="main">*</span> <span class="free">B0</span> <span class="bound">x</span> <span class="main">+</span> <span class="free">A1</span> <span class="bound">x</span> <span class="main">*</span> <span class="free">B0</span> <span class="bound">x</span> <span class="main">+</span> <span class="free">A1</span> <span class="bound">x</span> <span class="main">*</span> <span class="free">B1</span> <span class="bound">x</span><span class="main">¦</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> Bochner_Integration.integrable_abs<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"integrable <span class="free">M</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">A0</span> <span class="bound">x</span> <span class="main">*</span> <span class="free">B1</span> <span class="bound">x</span> <span class="main">-</span> <span class="free">A0</span> <span class="bound">x</span> <span class="main">*</span> <span class="free">B0</span> <span class="bound">x</span> <span class="main">+</span> <span class="free">A1</span> <span class="bound">x</span> <span class="main">*</span> <span class="free">B0</span> <span class="bound">x</span> <span class="main">+</span> <span class="free">A1</span> <span class="bound">x</span> <span class="main">*</span> <span class="free">B1</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> exeq <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The local hidden variable assumption states that separated quantum measurements are 
independent. It is standard for this assumption to be stated in a context where the hidden 
variable admits a density; it is stated here in a more general contest involving expectations, 
with no assumption on the existence of a density.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">pos_rv</span><span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> measure <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> real<span class="main">)</span> <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">pos_rv</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="free"><span class="bound"><span class="entity">Xr</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">Xr</span></span></span> <span class="main">∈</span> borel_measurable <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="main">∧</span> <span class="main">(</span><span class="keyword1">AE</span> <span class="bound">w</span> <span class="keyword1">in</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">.</span> <span class="main">(</span><span class="main">0</span><span class="main">::</span>real<span class="main">)</span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">Xr</span></span></span> <span class="bound">w</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">prv_sum</span><span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> measure <span class="main">⇒</span> complex Matrix.mat <span class="main">⇒</span> <span class="main">(</span>complex <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> real<span class="main">)</span> <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">prv_sum</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">Xr</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="keyword1">AE</span> <span class="bound">w</span> <span class="keyword1">in</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">.</span> <span class="main">(</span><span class="main">∑</span> <span class="bound">a</span><span class="main">∈</span> spectrum <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">Xr</span></span></span> <span class="bound">a</span> <span class="bound">w</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> cpx_sq_mat<span class="main">)</span> <span class="entity">lhv</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">lhv</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="free"><span class="bound"><span class="entity">XA</span></span></span> <span class="free"><span class="bound"><span class="entity">XB</span></span></span> <span class="main">≡</span> 
  prob_space <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="main">∧</span>
  <span class="main">(</span><span class="main">∀</span><span class="bound">a</span> <span class="main">∈</span>spectrum <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">.</span> pos_rv <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">XA</span></span></span> <span class="bound">a</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> 
  <span class="main">(</span>prv_sum <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">XA</span></span></span><span class="main">)</span> <span class="main">∧</span> 
  <span class="main">(</span><span class="main">∀</span><span class="bound">b</span> <span class="main">∈</span>spectrum <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">.</span> pos_rv <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">XB</span></span></span> <span class="bound">b</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
  <span class="main">(</span>prv_sum <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="free"><span class="bound"><span class="entity">XB</span></span></span><span class="main">)</span> <span class="main">∧</span> 
  <span class="main">(</span><span class="main">∀</span><span class="bound">a</span> <span class="main">∈</span>spectrum <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">.</span> <span class="main">∀</span><span class="bound">b</span> <span class="main">∈</span> spectrum <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">.</span> 
    <span class="main">(</span>integrable <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="main">(</span><span class="main">λ</span><span class="bound">w</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">XA</span></span></span> <span class="bound">a</span> <span class="bound">w</span> <span class="main">*</span> <span class="free"><span class="bound"><span class="entity">XB</span></span></span> <span class="bound">b</span> <span class="bound">w</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> 
    <span class="keyword1">integral<span class="hidden">⇧</span><sup>L</sup></span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="main">(</span><span class="main">λ</span><span class="bound">w</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">XA</span></span></span> <span class="bound">a</span> <span class="bound">w</span> <span class="main">*</span> <span class="free"><span class="bound"><span class="entity">XB</span></span></span> <span class="bound">b</span> <span class="bound">w</span><span class="main">)</span> <span class="main">=</span> 
    Re <span class="main">(</span>Complex_Matrix.trace<span class="main">(</span>eigen_projector <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="bound">a</span> <span class="main">*</span> <span class="main">(</span>eigen_projector <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="bound">b</span><span class="main">)</span> <span class="main">*</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="comment1">(*definition (in cpx_sq_mat) lhv where
"lhv M A B R XA XB ≡ 
  prob_space M ∧
  (∀a ∈spectrum A. (XA a ∈ borel_measurable M) ∧ 
    (AE w in M. ((0::real) ≤ XA a w))) ∧ 
  (AE w in M. (∑ a∈ spectrum A. XA a w) = 1) ∧ 
  (∀b ∈spectrum B. (XB b ∈ borel_measurable M) ∧ 
    (AE w in M. (0 ≤ XB b w))) ∧
  (AE w in M. (∑ b∈ spectrum B. XB b w) = 1) ∧ 
  (∀a ∈spectrum A . ∀b ∈ spectrum B. 
    (integrable M (λw. XA a w * XB b w)) ∧ 
    integral<span class="hidden">⇧</span><sup>L</sup> M (λw. XA a w * XB b w) = 
    Re (Complex_Matrix.trace(eigen_projector A a * (eigen_projector B b) * R)))"*)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> cpx_sq_mat<span class="main">)</span> lhv_posl<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"lhv <span class="free">M</span> <span class="free">A</span> <span class="free">B</span> <span class="free">R</span> <span class="free">XA</span> <span class="free">XB</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">AE</span> <span class="bound">w</span> <span class="keyword1">in</span> <span class="free">M</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">a</span> <span class="main">∈</span> spectrum <span class="free">A</span><span class="main">.</span> <span class="main">0</span> <span class="main">≤</span> <span class="free">XA</span> <span class="bound">a</span> <span class="bound">w</span><span class="main">)</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> AE_ball_countable<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> iffD2<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"countable <span class="main">(</span>spectrum <span class="free">A</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> spectrum_finite<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">A</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> countable_finite<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">a</span><span class="main">∈</span>spectrum <span class="free">A</span><span class="main">.</span> <span class="keyword1">AE</span> <span class="bound">w</span> <span class="keyword1">in</span> <span class="free">M</span><span class="main">.</span> <span class="main">0</span> <span class="main">≤</span> <span class="free">XA</span> <span class="bound">a</span> <span class="bound">w</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> lhv_def pos_rv_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> cpx_sq_mat<span class="main">)</span> lhv_lt1_l<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"lhv <span class="free">M</span> <span class="free">A</span> <span class="free">B</span> <span class="free">R</span> <span class="free">XA</span> <span class="free">XB</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">AE</span> <span class="bound">w</span> <span class="keyword1">in</span> <span class="free">M</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">a</span> <span class="main">∈</span> spectrum <span class="free">A</span><span class="main">.</span> <span class="free">XA</span> <span class="bound">a</span> <span class="bound">w</span> <span class="main">≤</span> <span class="main">1</span><span class="main">)</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> AE_mp<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">AE</span> <span class="bound">w</span> <span class="keyword1">in</span> <span class="free">M</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">a</span> <span class="main">∈</span> spectrum <span class="free">A</span><span class="main">.</span> <span class="main">0</span> <span class="main">≤</span> <span class="free">XA</span> <span class="bound">a</span> <span class="bound">w</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∑</span> <span class="bound">a</span><span class="main">∈</span> spectrum <span class="free">A</span><span class="main">.</span> <span class="free">XA</span> <span class="bound">a</span> <span class="bound">w</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> lhv_posl assms <span class="keyword1"><span class="command">unfolding</span></span> lhv_def pos_rv_def prv_sum_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">AE</span> <span class="bound">w</span> <span class="keyword1">in</span> <span class="free">M</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound">a</span><span class="main">∈</span>spectrum <span class="free">A</span><span class="main">.</span> <span class="main">0</span> <span class="main">≤</span> <span class="free">XA</span> <span class="bound">a</span> <span class="bound">w</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∑</span><span class="bound">a</span><span class="main">∈</span>spectrum <span class="free">A</span><span class="main">.</span> <span class="free">XA</span> <span class="bound">a</span> <span class="bound">w</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span> <span class="main">⟶</span> 
    <span class="main">(</span><span class="main">∀</span><span class="bound">a</span><span class="main">∈</span>spectrum <span class="free">A</span><span class="main">.</span> <span class="free">XA</span> <span class="bound">a</span> <span class="bound">w</span> <span class="main">≤</span> <span class="main">1</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">w</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span><span class="main">∈</span> space <span class="free">M</span>"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">a</span><span class="main">∈</span>spectrum <span class="free">A</span><span class="main">.</span> <span class="main">0</span> <span class="main">≤</span> <span class="free">XA</span> <span class="bound">a</span> <span class="skolem">w</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∑</span><span class="bound">a</span><span class="main">∈</span>spectrum <span class="free">A</span><span class="main">.</span> <span class="free">XA</span> <span class="bound">a</span> <span class="skolem">w</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span> <span class="main">⟶</span> 
      <span class="main">(</span><span class="main">∀</span><span class="bound">a</span><span class="main">∈</span>spectrum <span class="free">A</span><span class="main">.</span> <span class="free">XA</span> <span class="bound">a</span> <span class="skolem">w</span> <span class="main">≤</span> <span class="main">1</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> impI<span class="main">)</span>
      <span class="keyword3"><span class="command">assume</span></span> pr<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">a</span><span class="main">∈</span>spectrum <span class="free">A</span><span class="main">.</span> <span class="main">0</span> <span class="main">≤</span> <span class="free">XA</span> <span class="bound">a</span> <span class="skolem">w</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∑</span><span class="bound">a</span><span class="main">∈</span>spectrum <span class="free">A</span><span class="main">.</span> <span class="free">XA</span> <span class="bound">a</span> <span class="skolem">w</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">a</span><span class="main">∈</span>spectrum <span class="free">A</span><span class="main">.</span> <span class="free">XA</span> <span class="bound">a</span> <span class="skolem">w</span> <span class="main">≤</span> <span class="main">1</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span><span class="main">∈</span> spectrum <span class="free">A</span>"</span></span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">XA</span> <span class="skolem">a</span> <span class="skolem">w</span> <span class="main">≤</span> <span class="main">1</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> pos_sum_1_le<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">"spectrum <span class="free"><span class="free">A</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>spectrum <span class="free">A</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> spectrum_finite<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">A</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∈</span> spectrum <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">a</span> <span class="main">∈</span> spectrum <span class="free">A</span>›</span></span> <span class="keyword1"><span class="command">.</span></span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">" <span class="main">∀</span><span class="bound">i</span><span class="main">∈</span>spectrum <span class="free">A</span><span class="main">.</span> <span class="main">0</span> <span class="main">≤</span> <span class="free">XA</span> <span class="bound">i</span> <span class="skolem">w</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> pr <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">∈</span>spectrum <span class="free">A</span><span class="main">.</span> <span class="free">XA</span> <span class="bound">i</span> <span class="skolem">w</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> pr <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> cpx_sq_mat<span class="main">)</span> lhv_posr<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"lhv <span class="free">M</span> <span class="free">A</span> <span class="free">B</span> <span class="free">R</span> <span class="free">XA</span> <span class="free">XB</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">AE</span> <span class="bound">w</span> <span class="keyword1">in</span> <span class="free">M</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">b</span> <span class="main">∈</span> spectrum <span class="free">B</span><span class="main">.</span> <span class="main">0</span> <span class="main">≤</span> <span class="free">XB</span> <span class="bound">b</span> <span class="bound">w</span><span class="main">)</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> AE_ball_countable<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> iffD2<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"countable <span class="main">(</span>spectrum <span class="free">B</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> spectrum_finite<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">B</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> countable_finite<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">b</span><span class="main">∈</span>spectrum <span class="free">B</span><span class="main">.</span> <span class="keyword1">AE</span> <span class="bound">w</span> <span class="keyword1">in</span> <span class="free">M</span><span class="main">.</span> <span class="main">0</span> <span class="main">≤</span> <span class="free">XB</span> <span class="bound">b</span> <span class="bound">w</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> lhv_def pos_rv_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> cpx_sq_mat<span class="main">)</span> lhv_lt1_r<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"lhv <span class="free">M</span> <span class="free">A</span> <span class="free">B</span> <span class="free">R</span> <span class="free">XA</span> <span class="free">XB</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">AE</span> <span class="bound">w</span> <span class="keyword1">in</span> <span class="free">M</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">a</span> <span class="main">∈</span> spectrum <span class="free">B</span><span class="main">.</span> <span class="free">XB</span> <span class="bound">a</span> <span class="bound">w</span> <span class="main">≤</span> <span class="main">1</span><span class="main">)</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> AE_mp<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">AE</span> <span class="bound">w</span> <span class="keyword1">in</span> <span class="free">M</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">a</span> <span class="main">∈</span> spectrum <span class="free">B</span><span class="main">.</span> <span class="main">0</span> <span class="main">≤</span> <span class="free">XB</span> <span class="bound">a</span> <span class="bound">w</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∑</span> <span class="bound">a</span><span class="main">∈</span> spectrum <span class="free">B</span><span class="main">.</span> <span class="free">XB</span> <span class="bound">a</span> <span class="bound">w</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> lhv_posr assms <span class="keyword1"><span class="command">unfolding</span></span> lhv_def prv_sum_def pos_rv_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">AE</span> <span class="bound">w</span> <span class="keyword1">in</span> <span class="free">M</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound">a</span><span class="main">∈</span>spectrum <span class="free">B</span><span class="main">.</span> <span class="main">0</span> <span class="main">≤</span> <span class="free">XB</span> <span class="bound">a</span> <span class="bound">w</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∑</span><span class="bound">a</span><span class="main">∈</span>spectrum <span class="free">B</span><span class="main">.</span> <span class="free">XB</span> <span class="bound">a</span> <span class="bound">w</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span> <span class="main">⟶</span> 
    <span class="main">(</span><span class="main">∀</span><span class="bound">a</span><span class="main">∈</span>spectrum <span class="free">B</span><span class="main">.</span> <span class="free">XB</span> <span class="bound">a</span> <span class="bound">w</span> <span class="main">≤</span> <span class="main">1</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">w</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span><span class="main">∈</span> space <span class="free">M</span>"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">a</span><span class="main">∈</span>spectrum <span class="free">B</span><span class="main">.</span> <span class="main">0</span> <span class="main">≤</span> <span class="free">XB</span> <span class="bound">a</span> <span class="skolem">w</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∑</span><span class="bound">a</span><span class="main">∈</span>spectrum <span class="free">B</span><span class="main">.</span> <span class="free">XB</span> <span class="bound">a</span> <span class="skolem">w</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span> <span class="main">⟶</span> 
      <span class="main">(</span><span class="main">∀</span><span class="bound">a</span><span class="main">∈</span>spectrum <span class="free">B</span><span class="main">.</span> <span class="free">XB</span> <span class="bound">a</span> <span class="skolem">w</span> <span class="main">≤</span> <span class="main">1</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> impI<span class="main">)</span>
      <span class="keyword3"><span class="command">assume</span></span> pr<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">a</span><span class="main">∈</span>spectrum <span class="free">B</span><span class="main">.</span> <span class="main">0</span> <span class="main">≤</span> <span class="free">XB</span> <span class="bound">a</span> <span class="skolem">w</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∑</span><span class="bound">a</span><span class="main">∈</span>spectrum <span class="free">B</span><span class="main">.</span> <span class="free">XB</span> <span class="bound">a</span> <span class="skolem">w</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">a</span><span class="main">∈</span>spectrum <span class="free">B</span><span class="main">.</span> <span class="free">XB</span> <span class="bound">a</span> <span class="skolem">w</span> <span class="main">≤</span> <span class="main">1</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span><span class="main">∈</span> spectrum <span class="free">B</span>"</span></span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">XB</span> <span class="skolem">a</span> <span class="skolem">w</span> <span class="main">≤</span> <span class="main">1</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> pos_sum_1_le<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">"spectrum <span class="free"><span class="free">B</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>spectrum <span class="free">B</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> spectrum_finite<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">B</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∈</span> spectrum <span class="free">B</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">a</span> <span class="main">∈</span> spectrum <span class="free">B</span>›</span></span> <span class="keyword1"><span class="command">.</span></span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">" <span class="main">∀</span><span class="bound">i</span><span class="main">∈</span>spectrum <span class="free">B</span><span class="main">.</span> <span class="main">0</span> <span class="main">≤</span> <span class="free">XB</span> <span class="bound">i</span> <span class="skolem">w</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> pr <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">∈</span>spectrum <span class="free">B</span><span class="main">.</span> <span class="free">XB</span> <span class="bound">i</span> <span class="skolem">w</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> pr <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> cpx_sq_mat<span class="main">)</span> lhv_AE_propl<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"lhv <span class="free">M</span> <span class="free">A</span> <span class="free">B</span> <span class="free">R</span> <span class="free">XA</span> <span class="free">XB</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">AE</span> <span class="bound">w</span> <span class="keyword1">in</span> <span class="free">M</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">a</span> <span class="main">∈</span> spectrum <span class="free">A</span><span class="main">.</span> <span class="main">0</span> <span class="main">≤</span> <span class="free">XA</span> <span class="bound">a</span> <span class="bound">w</span> <span class="main">∧</span> <span class="free">XA</span> <span class="bound">a</span> <span class="bound">w</span> <span class="main">≤</span> <span class="main">1</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∑</span> <span class="bound">a</span><span class="main">∈</span> spectrum <span class="free">A</span><span class="main">.</span> <span class="free">XA</span> <span class="bound">a</span> <span class="bound">w</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> AE_conjI<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">AE</span> <span class="bound">w</span> <span class="keyword1">in</span> <span class="free">M</span><span class="main">.</span> <span class="main">∀</span><span class="bound">a</span><span class="main">∈</span>spectrum <span class="free">A</span><span class="main">.</span> <span class="main">0</span> <span class="main">≤</span> <span class="free">XA</span> <span class="bound">a</span> <span class="bound">w</span> <span class="main">∧</span> <span class="free">XA</span> <span class="bound">a</span> <span class="bound">w</span> <span class="main">≤</span> <span class="main">1</span>"</span></span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> AE_mp<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">AE</span> <span class="bound">w</span> <span class="keyword1">in</span> <span class="free">M</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">a</span> <span class="main">∈</span> spectrum <span class="free">A</span><span class="main">.</span> <span class="main">0</span> <span class="main">≤</span> <span class="free">XA</span> <span class="bound">a</span> <span class="bound">w</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">a</span> <span class="main">∈</span> spectrum <span class="free">A</span><span class="main">.</span> <span class="free">XA</span> <span class="bound">a</span> <span class="bound">w</span> <span class="main">≤</span> <span class="main">1</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms lhv_posl<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">M</span></span> <span class="quoted"><span class="free">A</span></span><span class="main">]</span> lhv_lt1_l<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">M</span></span> <span class="quoted"><span class="free">A</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">AE</span> <span class="bound">w</span> <span class="keyword1">in</span> <span class="free">M</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound">a</span><span class="main">∈</span>spectrum <span class="free">A</span><span class="main">.</span> <span class="main">0</span> <span class="main">≤</span> <span class="free">XA</span> <span class="bound">a</span> <span class="bound">w</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">a</span><span class="main">∈</span>spectrum <span class="free">A</span><span class="main">.</span> <span class="free">XA</span> <span class="bound">a</span> <span class="bound">w</span> <span class="main">≤</span> <span class="main">1</span><span class="main">)</span> <span class="main">⟶</span>
               <span class="main">(</span><span class="main">∀</span><span class="bound">a</span><span class="main">∈</span>spectrum <span class="free">A</span><span class="main">.</span> <span class="main">0</span> <span class="main">≤</span> <span class="free">XA</span> <span class="bound">a</span> <span class="bound">w</span> <span class="main">∧</span> <span class="free">XA</span> <span class="bound">a</span> <span class="bound">w</span> <span class="main">≤</span> <span class="main">1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">AE</span> <span class="bound">w</span> <span class="keyword1">in</span> <span class="free">M</span><span class="main">.</span> <span class="main">(</span><span class="main">∑</span><span class="bound">a</span><span class="main">∈</span>spectrum <span class="free">A</span><span class="main">.</span> <span class="free">XA</span> <span class="bound">a</span> <span class="bound">w</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> lhv_def prv_sum_def 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> cpx_sq_mat<span class="main">)</span> lhv_AE_propr<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"lhv <span class="free">M</span> <span class="free">A</span> <span class="free">B</span> <span class="free">R</span> <span class="free">XA</span> <span class="free">XB</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">AE</span> <span class="bound">w</span> <span class="keyword1">in</span> <span class="free">M</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">a</span> <span class="main">∈</span> spectrum <span class="free">B</span><span class="main">.</span> <span class="main">0</span> <span class="main">≤</span> <span class="free">XB</span> <span class="bound">a</span> <span class="bound">w</span> <span class="main">∧</span> <span class="free">XB</span> <span class="bound">a</span> <span class="bound">w</span> <span class="main">≤</span> <span class="main">1</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∑</span> <span class="bound">a</span><span class="main">∈</span> spectrum <span class="free">B</span><span class="main">.</span> <span class="free">XB</span> <span class="bound">a</span> <span class="bound">w</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> AE_conjI<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">AE</span> <span class="bound">w</span> <span class="keyword1">in</span> <span class="free">M</span><span class="main">.</span> <span class="main">∀</span><span class="bound">a</span><span class="main">∈</span>spectrum <span class="free">B</span><span class="main">.</span> <span class="main">0</span> <span class="main">≤</span> <span class="free">XB</span> <span class="bound">a</span> <span class="bound">w</span> <span class="main">∧</span> <span class="free">XB</span> <span class="bound">a</span> <span class="bound">w</span> <span class="main">≤</span> <span class="main">1</span>"</span></span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> AE_mp<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">AE</span> <span class="bound">w</span> <span class="keyword1">in</span> <span class="free">M</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">a</span> <span class="main">∈</span> spectrum <span class="free">B</span><span class="main">.</span> <span class="main">0</span> <span class="main">≤</span> <span class="free">XB</span> <span class="bound">a</span> <span class="bound">w</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">a</span> <span class="main">∈</span> spectrum <span class="free">B</span><span class="main">.</span> <span class="free">XB</span> <span class="bound">a</span> <span class="bound">w</span> <span class="main">≤</span> <span class="main">1</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms lhv_posr<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">M</span></span> <span class="main">_</span> <span class="quoted"><span class="free">B</span></span><span class="main">]</span> lhv_lt1_r<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">M</span></span> <span class="main">_</span> <span class="quoted"><span class="free">B</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">AE</span> <span class="bound">w</span> <span class="keyword1">in</span> <span class="free">M</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound">a</span><span class="main">∈</span>spectrum <span class="free">B</span><span class="main">.</span> <span class="main">0</span> <span class="main">≤</span> <span class="free">XB</span> <span class="bound">a</span> <span class="bound">w</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">a</span><span class="main">∈</span>spectrum <span class="free">B</span><span class="main">.</span> <span class="free">XB</span> <span class="bound">a</span> <span class="bound">w</span> <span class="main">≤</span> <span class="main">1</span><span class="main">)</span> <span class="main">⟶</span>
               <span class="main">(</span><span class="main">∀</span><span class="bound">a</span><span class="main">∈</span>spectrum <span class="free">B</span><span class="main">.</span> <span class="main">0</span> <span class="main">≤</span> <span class="free">XB</span> <span class="bound">a</span> <span class="bound">w</span> <span class="main">∧</span> <span class="free">XB</span> <span class="bound">a</span> <span class="bound">w</span> <span class="main">≤</span> <span class="main">1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">AE</span> <span class="bound">w</span> <span class="keyword1">in</span> <span class="free">M</span><span class="main">.</span> <span class="main">(</span><span class="main">∑</span><span class="bound">a</span><span class="main">∈</span>spectrum <span class="free">B</span><span class="main">.</span> <span class="free">XB</span> <span class="bound">a</span> <span class="bound">w</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> lhv_def prv_sum_def 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> cpx_sq_mat<span class="main">)</span> lhv_integral_eq<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">c</span><span class="main">::</span><span class="quoted">real</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"lhv <span class="free">M</span> <span class="free">A</span> <span class="free">B</span> <span class="free">R</span> <span class="free">XA</span> <span class="free">XB</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span><span class="main">∈</span> spectrum <span class="free">A</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span><span class="main">∈</span> spectrum <span class="free">B</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">integral<span class="hidden">⇧</span><sup>L</sup></span> <span class="free">M</span> <span class="main">(</span><span class="main">λ</span><span class="bound">w</span><span class="main">.</span> <span class="free">XA</span> <span class="free">a</span> <span class="bound">w</span> <span class="main">*</span> <span class="free">XB</span> <span class="free">b</span> <span class="bound">w</span><span class="main">)</span> <span class="main">=</span> 
  Re <span class="main">(</span>Complex_Matrix.trace<span class="main">(</span>eigen_projector <span class="free">A</span> <span class="free">a</span> <span class="main">*</span> <span class="main">(</span>eigen_projector <span class="free">B</span> <span class="free">b</span><span class="main">)</span> <span class="main">*</span> <span class="free">R</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> lhv_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> cpx_sq_mat<span class="main">)</span> lhv_integrable<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">c</span><span class="main">::</span><span class="quoted">real</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"lhv <span class="free">M</span> <span class="free">A</span> <span class="free">B</span> <span class="free">R</span> <span class="free">XA</span> <span class="free">XB</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span><span class="main">∈</span> spectrum <span class="free">A</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span><span class="main">∈</span> spectrum <span class="free">B</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"integrable <span class="free">M</span> <span class="main">(</span><span class="main">λ</span><span class="bound">w</span><span class="main">.</span> <span class="free">XA</span> <span class="free">a</span> <span class="bound">w</span> <span class="main">*</span> <span class="free">XB</span> <span class="free">b</span> <span class="bound">w</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> lhv_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> cpx_sq_mat<span class="main">)</span> lhv_scal_integrable<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">c</span><span class="main">::</span><span class="quoted">real</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"lhv <span class="free">M</span> <span class="free">A</span> <span class="free">B</span> <span class="free">R</span> <span class="free">XA</span> <span class="free">XB</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span><span class="main">∈</span> spectrum <span class="free">A</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span><span class="main">∈</span> spectrum <span class="free">B</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"integrable <span class="free">M</span> <span class="main">(</span><span class="main">λ</span><span class="bound">w</span><span class="main">.</span> <span class="free">c</span> <span class="main">*</span><span class="free">XA</span> <span class="free">a</span> <span class="bound">w</span> <span class="main">*</span> <span class="free">d</span> <span class="main">*</span> <span class="free">XB</span> <span class="free">b</span> <span class="bound">w</span><span class="main">)</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span><span class="main">∈</span> space <span class="free">M</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">*</span> <span class="free">d</span> <span class="main">*</span> <span class="main">(</span><span class="free">XA</span> <span class="free">a</span> <span class="skolem">x</span> <span class="main">*</span> <span class="free">XB</span> <span class="free">b</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">=</span> <span class="free">c</span> <span class="main">*</span> <span class="free">XA</span> <span class="free">a</span> <span class="skolem">x</span> <span class="main">*</span> <span class="free">d</span> <span class="main">*</span> <span class="free">XB</span> <span class="free">b</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> 
  <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> eq <span class="main">=</span> this
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"integrable <span class="free">M</span> <span class="main">(</span><span class="main">λ</span><span class="bound">w</span><span class="main">.</span> <span class="free">XA</span> <span class="free">a</span> <span class="bound">w</span> <span class="main">*</span> <span class="free">XB</span> <span class="free">b</span> <span class="bound">w</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> lhv_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">hence</span></span> g<span class="main">:</span><span class="quoted"><span class="quoted">"integrable <span class="free">M</span> <span class="main">(</span><span class="main">λ</span><span class="bound">w</span><span class="main">.</span> <span class="free">c</span> <span class="main">*</span> <span class="free">d</span> <span class="main">*</span> <span class="main">(</span><span class="free">XA</span> <span class="free">a</span> <span class="bound">w</span> <span class="main">*</span> <span class="free">XB</span> <span class="free">b</span> <span class="bound">w</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> integrable_real_mult_right <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> Bochner_Integration.integrable_cong<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> iffD2<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"integrable <span class="free">M</span> <span class="main">(</span><span class="main">λ</span><span class="bound">w</span><span class="main">.</span> <span class="free">c</span> <span class="main">*</span> <span class="free">d</span> <span class="main">*</span> <span class="main">(</span><span class="free">XA</span> <span class="free">a</span> <span class="bound">w</span> <span class="main">*</span> <span class="free">XB</span> <span class="free">b</span> <span class="bound">w</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> g <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> space <span class="free">M</span> <span class="main">⟹</span> <span class="free">c</span> <span class="main">*</span> <span class="free">XA</span> <span class="free">a</span> <span class="bound">x</span> <span class="main">*</span> <span class="free">d</span> <span class="main">*</span> <span class="free">XB</span> <span class="free">b</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">c</span> <span class="main">*</span> <span class="free">d</span> <span class="main">*</span> <span class="main">(</span><span class="free">XA</span> <span class="free">a</span> <span class="bound">x</span> <span class="main">*</span> <span class="free">XB</span> <span class="free">b</span> <span class="bound">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> cpx_sq_mat<span class="main">)</span> lhv_lsum_scal_integrable<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"lhv <span class="free">M</span> <span class="free">A</span> <span class="free">B</span> <span class="free">R</span> <span class="free">XA</span> <span class="free">XB</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>  <span class="quoted"><span class="quoted">"<span class="free">a</span><span class="main">∈</span> spectrum <span class="free">A</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"integrable <span class="free">M</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">∑</span><span class="bound">b</span><span class="main">∈</span>spectrum <span class="free">B</span><span class="main">.</span> <span class="free">c</span> <span class="main">*</span> <span class="free">XA</span> <span class="free">a</span> <span class="bound">x</span> <span class="main">*</span> <span class="main">(</span><span class="free">f</span> <span class="bound">b</span><span class="main">)</span> <span class="main">*</span> <span class="free">XB</span> <span class="bound">b</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> Bochner_Integration.integrable_sum<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">b</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span><span class="main">∈</span> spectrum <span class="free">B</span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"integrable <span class="free">M</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">c</span> <span class="main">*</span> <span class="free">XA</span> <span class="free">a</span> <span class="bound">x</span> <span class="main">*</span> <span class="free">f</span> <span class="skolem">b</span> <span class="main">*</span><span class="free">XB</span> <span class="skolem">b</span> <span class="bound">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">a</span><span class="main">∈</span> spectrum <span class="free">A</span>›</span></span> assms 
    lhv_scal_integrable<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">M</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> cpx_sq_mat<span class="main">)</span> lhv_sum_integrable<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"lhv <span class="free">M</span> <span class="free">A</span> <span class="free">B</span> <span class="free">R</span> <span class="free">XA</span> <span class="free">XB</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"integrable <span class="free">M</span> <span class="main">(</span><span class="main">λ</span><span class="bound">w</span><span class="main">.</span>  <span class="main">(</span><span class="main">∑</span> <span class="bound">a</span> <span class="main">∈</span> spectrum <span class="free">A</span><span class="main">.</span> <span class="main">(</span><span class="main">∑</span> <span class="bound">b</span> <span class="main">∈</span> spectrum <span class="free">B</span><span class="main">.</span> <span class="free">f</span> <span class="bound">a</span> <span class="main">*</span> <span class="free">XA</span> <span class="bound">a</span> <span class="bound">w</span> <span class="main">*</span> <span class="free">g</span> <span class="bound">b</span> <span class="main">*</span> <span class="free">XB</span> <span class="bound">b</span> <span class="bound">w</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> Bochner_Integration.integrable_sum<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span><span class="main">∈</span> spectrum <span class="free">A</span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"integrable <span class="free">M</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">∑</span><span class="bound">b</span><span class="main">∈</span>spectrum <span class="free">B</span><span class="main">.</span> <span class="free">f</span> <span class="skolem">a</span> <span class="main">*</span> <span class="free">XA</span> <span class="skolem">a</span> <span class="bound">x</span> <span class="main">*</span> <span class="free">g</span> <span class="bound">b</span> <span class="main">*</span> <span class="free">XB</span> <span class="bound">b</span> <span class="bound">x</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> assms lhv_lsum_scal_integrable<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">M</span></span><span class="main">]</span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>  
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> cpx_sq_mat<span class="main">)</span> spectrum_abs_1_weighted_suml<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"lhv <span class="free">M</span> <span class="free">A</span> <span class="free">B</span> <span class="free">R</span> <span class="free">Va</span> <span class="free">Vb</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span>Re <span class="bound">x</span> <span class="main">|</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> spectrum <span class="free">A</span><span class="main">}</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span>Re <span class="bound">x</span> <span class="main">|</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> spectrum <span class="free">A</span><span class="main">}</span> <span class="main">⊆</span> <span class="main">{</span><span class="main">-</span> <span class="main">1</span><span class="main">,</span> <span class="main">1</span><span class="main">}</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"hermitian <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span><span class="main">∈</span> <span class="free">fc_mats</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">AE</span> <span class="bound">w</span> <span class="keyword1">in</span> <span class="free">M</span><span class="main">.</span> <span class="main">¦</span><span class="main">(</span><span class="main">∑</span><span class="bound">a</span><span class="main">∈</span>spectrum <span class="free">A</span><span class="main">.</span> Re <span class="bound">a</span> <span class="main">*</span> <span class="free">Va</span> <span class="bound">a</span> <span class="bound">w</span><span class="main">)</span><span class="main">¦</span> <span class="main">≤</span> <span class="main">1</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> AE_mp<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">AE</span> <span class="bound">w</span> <span class="keyword1">in</span> <span class="free">M</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound">a</span><span class="main">∈</span>spectrum <span class="free">A</span><span class="main">.</span> <span class="main">0</span> <span class="main">≤</span> <span class="free">Va</span> <span class="bound">a</span> <span class="bound">w</span> <span class="main">∧</span> <span class="free">Va</span> <span class="bound">a</span> <span class="bound">w</span> <span class="main">≤</span> <span class="main">1</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∑</span><span class="bound">a</span><span class="main">∈</span>spectrum <span class="free">A</span><span class="main">.</span> <span class="free">Va</span> <span class="bound">a</span> <span class="bound">w</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms lhv_AE_propl<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">M</span></span> <span class="quoted"><span class="free">A</span></span> <span class="quoted"><span class="free">B</span></span> <span class="main">_</span> <span class="quoted"><span class="free">Va</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">AE</span> <span class="bound">w</span> <span class="keyword1">in</span> <span class="free">M</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound">a</span><span class="main">∈</span>spectrum <span class="free">A</span><span class="main">.</span> <span class="main">0</span> <span class="main">≤</span> <span class="free">Va</span> <span class="bound">a</span> <span class="bound">w</span> <span class="main">∧</span> <span class="free">Va</span> <span class="bound">a</span> <span class="bound">w</span> <span class="main">≤</span> <span class="main">1</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∑</span><span class="bound">a</span><span class="main">∈</span>spectrum <span class="free">A</span><span class="main">.</span> <span class="free">Va</span> <span class="bound">a</span> <span class="bound">w</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span> <span class="main">⟶</span>
               <span class="main">¦</span><span class="main">∑</span><span class="bound">a</span><span class="main">∈</span>spectrum <span class="free">A</span><span class="main">.</span> Re <span class="bound">a</span> <span class="main">*</span> <span class="free">Va</span> <span class="bound">a</span> <span class="bound">w</span><span class="main">¦</span> <span class="main">≤</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">w</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span><span class="main">∈</span> space <span class="free">M</span>"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">a</span><span class="main">∈</span>spectrum <span class="free">A</span><span class="main">.</span> <span class="main">0</span> <span class="main">≤</span> <span class="free">Va</span> <span class="bound">a</span> <span class="skolem">w</span> <span class="main">∧</span> <span class="free">Va</span> <span class="bound">a</span> <span class="skolem">w</span> <span class="main">≤</span> <span class="main">1</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∑</span><span class="bound">a</span><span class="main">∈</span>spectrum <span class="free">A</span><span class="main">.</span> <span class="free">Va</span> <span class="bound">a</span> <span class="skolem">w</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span> <span class="main">⟶</span>
         <span class="main">¦</span><span class="main">∑</span><span class="bound">a</span><span class="main">∈</span>spectrum <span class="free">A</span><span class="main">.</span> Re <span class="bound">a</span> <span class="main">*</span> <span class="free">Va</span> <span class="bound">a</span> <span class="skolem">w</span><span class="main">¦</span> <span class="main">≤</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> impI<span class="main">)</span>
      <span class="keyword3"><span class="command">assume</span></span> pr<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">a</span><span class="main">∈</span>spectrum <span class="free">A</span><span class="main">.</span> <span class="main">0</span> <span class="main">≤</span> <span class="free">Va</span> <span class="bound">a</span> <span class="skolem">w</span> <span class="main">∧</span> <span class="free">Va</span> <span class="bound">a</span> <span class="skolem">w</span> <span class="main">≤</span> <span class="main">1</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∑</span><span class="bound">a</span><span class="main">∈</span>spectrum <span class="free">A</span><span class="main">.</span> <span class="free">Va</span> <span class="bound">a</span> <span class="skolem">w</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">¦</span><span class="main">(</span><span class="main">∑</span><span class="bound">a</span><span class="main">∈</span>spectrum <span class="free">A</span><span class="main">.</span> Re <span class="bound">a</span> <span class="main">*</span> <span class="free">Va</span> <span class="bound">a</span> <span class="skolem">w</span><span class="main">)</span><span class="main">¦</span> <span class="main">≤</span> <span class="main">1</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">{</span>Re <span class="bound">x</span> <span class="main">|</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> spectrum <span class="free">A</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="main">-</span> <span class="main">1</span><span class="main">,</span> <span class="main">1</span><span class="main">}</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> True
        <span class="keyword1"><span class="command">hence</span></span> sp<span class="main">:</span> <span class="quoted"><span class="quoted">"spectrum <span class="free">A</span> <span class="main">=</span> <span class="main">{</span><span class="main">-</span><span class="main">1</span><span class="main">,</span> <span class="main">1</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> hermitian_Re_spectrum<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">A</span></span><span class="main">]</span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">hence</span></span> scsum<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">a</span><span class="main">∈</span>spectrum <span class="free">A</span><span class="main">.</span> Re <span class="bound">a</span> <span class="main">*</span> <span class="free">Va</span> <span class="bound">a</span> <span class="skolem">w</span><span class="main">)</span> <span class="main">=</span> <span class="free">Va</span> <span class="main">1</span> <span class="skolem">w</span> <span class="main">-</span> <span class="free">Va</span> <span class="main">(</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="skolem">w</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> sum_2_elems <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">have</span></span> sum<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">a</span><span class="main">∈</span>spectrum <span class="free">A</span><span class="main">.</span> <span class="free">Va</span> <span class="bound">a</span> <span class="skolem">w</span><span class="main">)</span> <span class="main">=</span> <span class="free">Va</span> <span class="main">(</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="skolem">w</span> <span class="main">+</span> <span class="free">Va</span> <span class="main">1</span> <span class="skolem">w</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> sp sum_2_elems <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¦</span><span class="free">Va</span> <span class="main">1</span> <span class="skolem">w</span> <span class="main">-</span> <span class="free">Va</span> <span class="main">(</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="skolem">w</span><span class="main">¦</span> <span class="main">≤</span> <span class="main">1</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> fct_bound'<span class="main">)</span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">∈</span> spectrum <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> sp <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="free">Va</span> <span class="main">1</span> <span class="skolem">w</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> pr  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">-</span><span class="main">1</span> <span class="main">∈</span> spectrum <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> sp <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="free">Va</span> <span class="main">(</span><span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="skolem">w</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> pr <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">Va</span> <span class="main">(</span><span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="skolem">w</span> <span class="main">+</span> <span class="free">Va</span> <span class="main">1</span> <span class="skolem">w</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> pr sum <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> scsum <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">next</span></span>      
        <span class="keyword3"><span class="command">case</span></span> False
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">{</span>Re <span class="bound">x</span> <span class="main">|</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> spectrum <span class="free">A</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="main">-</span> <span class="main">1</span><span class="main">}</span>"</span></span><span class="main">)</span>
          <span class="keyword3"><span class="command">case</span></span> True
          <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"spectrum <span class="free">A</span> <span class="main">=</span> <span class="main">{</span><span class="main">-</span><span class="main">1</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> hermitian_Re_spectrum<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">A</span></span><span class="main">]</span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">a</span><span class="main">∈</span>spectrum <span class="free">A</span><span class="main">.</span> Re <span class="bound">a</span> <span class="main">*</span> <span class="free">Va</span> <span class="bound">a</span> <span class="skolem">w</span><span class="main">)</span> <span class="main">=</span> <span class="main">-</span> <span class="free">Va</span> <span class="main">(</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="skolem">w</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> 
          <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">-</span><span class="main">1</span> <span class="main">∈</span> spectrum <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹spectrum <span class="free">A</span> <span class="main">=</span> <span class="main">{</span><span class="main">-</span><span class="main">1</span><span class="main">}</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> pr <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> False
          <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span>Re <span class="bound">x</span> <span class="main">|</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> spectrum <span class="free">A</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="main">1</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="quoted"><span class="quoted">‹<span class="main">{</span>Re <span class="bound">x</span> <span class="main">|</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> spectrum <span class="free">A</span><span class="main">}</span> <span class="main">≠</span> <span class="main">{</span><span class="main">-</span><span class="main">1</span><span class="main">,</span> <span class="main">1</span><span class="main">}</span>›</span></span>
            last_subset<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">{</span>Re <span class="bound">x</span> <span class="main">|</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> spectrum <span class="free">A</span><span class="main">}</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"spectrum <span class="free">A</span> <span class="main">=</span> <span class="main">{</span><span class="main">1</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> hermitian_Re_spectrum<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">A</span></span><span class="main">]</span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">a</span><span class="main">∈</span>spectrum <span class="free">A</span><span class="main">.</span> Re <span class="bound">a</span> <span class="main">*</span> <span class="free">Va</span> <span class="bound">a</span> <span class="skolem">w</span><span class="main">)</span> <span class="main">=</span> <span class="free">Va</span> <span class="main">1</span> <span class="skolem">w</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> 
          <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">∈</span> spectrum <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹spectrum <span class="free">A</span> <span class="main">=</span> <span class="main">{</span><span class="main">1</span><span class="main">}</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> pr <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">qed</span></span>        
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> cpx_sq_mat<span class="main">)</span> spectrum_abs_1_weighted_sumr<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"lhv <span class="free">M</span> <span class="free">B</span> <span class="free">A</span> <span class="free">R</span> <span class="free">Vb</span> <span class="free">Va</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span>Re <span class="bound">x</span> <span class="main">|</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> spectrum <span class="free">A</span><span class="main">}</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span>Re <span class="bound">x</span> <span class="main">|</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> spectrum <span class="free">A</span><span class="main">}</span> <span class="main">⊆</span> <span class="main">{</span><span class="main">-</span> <span class="main">1</span><span class="main">,</span> <span class="main">1</span><span class="main">}</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"hermitian <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span><span class="main">∈</span> <span class="free">fc_mats</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">AE</span> <span class="bound">w</span> <span class="keyword1">in</span> <span class="free">M</span><span class="main">.</span> <span class="main">¦</span><span class="main">(</span><span class="main">∑</span><span class="bound">a</span><span class="main">∈</span>spectrum <span class="free">A</span><span class="main">.</span> Re <span class="bound">a</span> <span class="main">*</span> <span class="free">Va</span> <span class="bound">a</span> <span class="bound">w</span><span class="main">)</span><span class="main">¦</span> <span class="main">≤</span> <span class="main">1</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> AE_mp<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">AE</span> <span class="bound">w</span> <span class="keyword1">in</span> <span class="free">M</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound">a</span><span class="main">∈</span>spectrum <span class="free">A</span><span class="main">.</span> <span class="main">0</span> <span class="main">≤</span> <span class="free">Va</span> <span class="bound">a</span> <span class="bound">w</span> <span class="main">∧</span> <span class="free">Va</span> <span class="bound">a</span> <span class="bound">w</span> <span class="main">≤</span> <span class="main">1</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∑</span><span class="bound">a</span><span class="main">∈</span>spectrum <span class="free">A</span><span class="main">.</span> <span class="free">Va</span> <span class="bound">a</span> <span class="bound">w</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms lhv_AE_propr<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">M</span></span> <span class="quoted"><span class="free">B</span></span> <span class="quoted"><span class="free">A</span></span> <span class="main">_</span> <span class="quoted"><span class="free">Vb</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">AE</span> <span class="bound">w</span> <span class="keyword1">in</span> <span class="free">M</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound">a</span><span class="main">∈</span>spectrum <span class="free">A</span><span class="main">.</span> <span class="main">0</span> <span class="main">≤</span> <span class="free">Va</span> <span class="bound">a</span> <span class="bound">w</span> <span class="main">∧</span> <span class="free">Va</span> <span class="bound">a</span> <span class="bound">w</span> <span class="main">≤</span> <span class="main">1</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∑</span><span class="bound">a</span><span class="main">∈</span>spectrum <span class="free">A</span><span class="main">.</span> <span class="free">Va</span> <span class="bound">a</span> <span class="bound">w</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span> <span class="main">⟶</span>
               <span class="main">¦</span><span class="main">∑</span><span class="bound">a</span><span class="main">∈</span>spectrum <span class="free">A</span><span class="main">.</span> Re <span class="bound">a</span> <span class="main">*</span> <span class="free">Va</span> <span class="bound">a</span> <span class="bound">w</span><span class="main">¦</span> <span class="main">≤</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">w</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span><span class="main">∈</span> space <span class="free">M</span>"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">a</span><span class="main">∈</span>spectrum <span class="free">A</span><span class="main">.</span> <span class="main">0</span> <span class="main">≤</span> <span class="free">Va</span> <span class="bound">a</span> <span class="skolem">w</span> <span class="main">∧</span> <span class="free">Va</span> <span class="bound">a</span> <span class="skolem">w</span> <span class="main">≤</span> <span class="main">1</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∑</span><span class="bound">a</span><span class="main">∈</span>spectrum <span class="free">A</span><span class="main">.</span> <span class="free">Va</span> <span class="bound">a</span> <span class="skolem">w</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span> <span class="main">⟶</span>
         <span class="main">¦</span><span class="main">∑</span><span class="bound">a</span><span class="main">∈</span>spectrum <span class="free">A</span><span class="main">.</span> Re <span class="bound">a</span> <span class="main">*</span> <span class="free">Va</span> <span class="bound">a</span> <span class="skolem">w</span><span class="main">¦</span> <span class="main">≤</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> impI<span class="main">)</span>
      <span class="keyword3"><span class="command">assume</span></span> pr<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">a</span><span class="main">∈</span>spectrum <span class="free">A</span><span class="main">.</span> <span class="main">0</span> <span class="main">≤</span> <span class="free">Va</span> <span class="bound">a</span> <span class="skolem">w</span> <span class="main">∧</span> <span class="free">Va</span> <span class="bound">a</span> <span class="skolem">w</span> <span class="main">≤</span> <span class="main">1</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∑</span><span class="bound">a</span><span class="main">∈</span>spectrum <span class="free">A</span><span class="main">.</span> <span class="free">Va</span> <span class="bound">a</span> <span class="skolem">w</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">¦</span><span class="main">(</span><span class="main">∑</span><span class="bound">a</span><span class="main">∈</span>spectrum <span class="free">A</span><span class="main">.</span> Re <span class="bound">a</span> <span class="main">*</span> <span class="free">Va</span> <span class="bound">a</span> <span class="skolem">w</span><span class="main">)</span><span class="main">¦</span> <span class="main">≤</span> <span class="main">1</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">{</span>Re <span class="bound">x</span> <span class="main">|</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> spectrum <span class="free">A</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="main">-</span> <span class="main">1</span><span class="main">,</span> <span class="main">1</span><span class="main">}</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> True
        <span class="keyword1"><span class="command">hence</span></span> sp<span class="main">:</span> <span class="quoted"><span class="quoted">"spectrum <span class="free">A</span> <span class="main">=</span> <span class="main">{</span><span class="main">-</span><span class="main">1</span><span class="main">,</span> <span class="main">1</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> hermitian_Re_spectrum<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">A</span></span><span class="main">]</span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">hence</span></span> scsum<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">a</span><span class="main">∈</span>spectrum <span class="free">A</span><span class="main">.</span> Re <span class="bound">a</span> <span class="main">*</span> <span class="free">Va</span> <span class="bound">a</span> <span class="skolem">w</span><span class="main">)</span> <span class="main">=</span> <span class="free">Va</span> <span class="main">1</span> <span class="skolem">w</span> <span class="main">-</span> <span class="free">Va</span> <span class="main">(</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="skolem">w</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> sum_2_elems <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">have</span></span> sum<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">a</span><span class="main">∈</span>spectrum <span class="free">A</span><span class="main">.</span> <span class="free">Va</span> <span class="bound">a</span> <span class="skolem">w</span><span class="main">)</span> <span class="main">=</span> <span class="free">Va</span> <span class="main">(</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="skolem">w</span> <span class="main">+</span> <span class="free">Va</span> <span class="main">1</span> <span class="skolem">w</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> sp sum_2_elems <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¦</span><span class="free">Va</span> <span class="main">1</span> <span class="skolem">w</span> <span class="main">-</span> <span class="free">Va</span> <span class="main">(</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="skolem">w</span><span class="main">¦</span> <span class="main">≤</span> <span class="main">1</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> fct_bound'<span class="main">)</span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">∈</span> spectrum <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> sp <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="free">Va</span> <span class="main">1</span> <span class="skolem">w</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> pr  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">-</span><span class="main">1</span> <span class="main">∈</span> spectrum <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> sp <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="free">Va</span> <span class="main">(</span><span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="skolem">w</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> pr <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">Va</span> <span class="main">(</span><span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="skolem">w</span> <span class="main">+</span> <span class="free">Va</span> <span class="main">1</span> <span class="skolem">w</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> pr sum <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> scsum <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">next</span></span>      
        <span class="keyword3"><span class="command">case</span></span> False
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">{</span>Re <span class="bound">x</span> <span class="main">|</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> spectrum <span class="free">A</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="main">-</span> <span class="main">1</span><span class="main">}</span>"</span></span><span class="main">)</span>
          <span class="keyword3"><span class="command">case</span></span> True
          <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"spectrum <span class="free">A</span> <span class="main">=</span> <span class="main">{</span><span class="main">-</span><span class="main">1</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> hermitian_Re_spectrum<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">A</span></span><span class="main">]</span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">a</span><span class="main">∈</span>spectrum <span class="free">A</span><span class="main">.</span> Re <span class="bound">a</span> <span class="main">*</span> <span class="free">Va</span> <span class="bound">a</span> <span class="skolem">w</span><span class="main">)</span> <span class="main">=</span> <span class="main">-</span> <span class="free">Va</span> <span class="main">(</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="skolem">w</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> 
          <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">-</span><span class="main">1</span> <span class="main">∈</span> spectrum <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹spectrum <span class="free">A</span> <span class="main">=</span> <span class="main">{</span><span class="main">-</span><span class="main">1</span><span class="main">}</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> pr <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> False
          <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span>Re <span class="bound">x</span> <span class="main">|</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> spectrum <span class="free">A</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="main">1</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="quoted"><span class="quoted">‹<span class="main">{</span>Re <span class="bound">x</span> <span class="main">|</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> spectrum <span class="free">A</span><span class="main">}</span> <span class="main">≠</span> <span class="main">{</span><span class="main">-</span><span class="main">1</span><span class="main">,</span> <span class="main">1</span><span class="main">}</span>›</span></span>
            last_subset<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">{</span>Re <span class="bound">x</span> <span class="main">|</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> spectrum <span class="free">A</span><span class="main">}</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"spectrum <span class="free">A</span> <span class="main">=</span> <span class="main">{</span><span class="main">1</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> hermitian_Re_spectrum<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">A</span></span><span class="main">]</span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">a</span><span class="main">∈</span>spectrum <span class="free">A</span><span class="main">.</span> Re <span class="bound">a</span> <span class="main">*</span> <span class="free">Va</span> <span class="bound">a</span> <span class="skolem">w</span><span class="main">)</span> <span class="main">=</span> <span class="free">Va</span> <span class="main">1</span> <span class="skolem">w</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> 
          <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">∈</span> spectrum <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹spectrum <span class="free">A</span> <span class="main">=</span> <span class="main">{</span><span class="main">1</span><span class="main">}</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> pr <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">qed</span></span>        
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">qt_expect</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">qt_expect</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">Va</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">w</span><span class="main">.</span> <span class="main">(</span><span class="main">∑</span><span class="bound">a</span><span class="main">∈</span>spectrum <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">.</span> Re <span class="bound">a</span> <span class="main">*</span> <span class="free"><span class="bound"><span class="entity">Va</span></span></span> <span class="bound">a</span> <span class="bound">w</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> cpx_sq_mat<span class="main">)</span> spectr_sum_integrable<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"lhv <span class="free">M</span> <span class="free">A</span> <span class="free">B</span> <span class="free">R</span> <span class="free">Va</span> <span class="free">Vb</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"integrable <span class="free">M</span> <span class="main">(</span><span class="main">λ</span><span class="bound">w</span><span class="main">.</span> qt_expect <span class="free">A</span> <span class="free">Va</span> <span class="bound">w</span> <span class="main">*</span> qt_expect <span class="free">B</span> <span class="free">Vb</span> <span class="bound">w</span><span class="main">)</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> Bochner_Integration.integrable_cong<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> iffD2<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">=</span> <span class="free">M</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">w</span><span class="main">.</span> <span class="bound">w</span> <span class="main">∈</span> space <span class="free">M</span> <span class="main">⟹</span> qt_expect <span class="free">A</span> <span class="free">Va</span> <span class="bound">w</span> <span class="main">*</span> qt_expect <span class="free">B</span> <span class="free">Vb</span> <span class="bound">w</span> <span class="main">=</span> 
    <span class="main">(</span><span class="main">∑</span><span class="bound">a</span><span class="main">∈</span>spectrum <span class="free">A</span><span class="main">.</span> <span class="main">(</span><span class="main">∑</span><span class="bound">b</span><span class="main">∈</span>spectrum <span class="free">B</span><span class="main">.</span> Re <span class="bound">a</span> <span class="main">*</span> <span class="free">Va</span> <span class="bound">a</span> <span class="bound">w</span> <span class="main">*</span> Re <span class="bound">b</span> <span class="main">*</span> <span class="free">Vb</span> <span class="bound">b</span> <span class="bound">w</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">w</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span><span class="main">∈</span> space <span class="free">M</span>"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"qt_expect <span class="free">A</span> <span class="free">Va</span> <span class="skolem">w</span> <span class="main">*</span> qt_expect <span class="free">B</span> <span class="free">Vb</span> <span class="skolem">w</span> <span class="main">=</span> 
      <span class="main">(</span><span class="main">∑</span><span class="bound">a</span><span class="main">∈</span>spectrum <span class="free">A</span><span class="main">.</span> <span class="main">(</span><span class="main">∑</span><span class="bound">b</span><span class="main">∈</span>spectrum <span class="free">B</span><span class="main">.</span> Re <span class="bound">a</span> <span class="main">*</span> <span class="free">Va</span> <span class="bound">a</span> <span class="skolem">w</span> <span class="main">*</span> Re <span class="bound">b</span> <span class="main">*</span> <span class="free">Vb</span> <span class="bound">b</span> <span class="skolem">w</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> qt_expect_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> Finite_Cartesian_Product.sum_cong_aux sum_product 
          vector_space_over_itself.scale_scale<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"integrable <span class="free">M</span> <span class="main">(</span><span class="main">λ</span><span class="bound">w</span><span class="main">.</span> <span class="main">∑</span><span class="bound">a</span><span class="main">∈</span>spectrum <span class="free">A</span><span class="main">.</span> <span class="main">(</span><span class="main">∑</span><span class="bound">b</span><span class="main">∈</span>spectrum <span class="free">B</span><span class="main">.</span> Re <span class="bound">a</span> <span class="main">*</span> <span class="free">Va</span> <span class="bound">a</span> <span class="bound">w</span> <span class="main">*</span> Re <span class="bound">b</span> <span class="main">*</span> <span class="free">Vb</span> <span class="bound">b</span> <span class="bound">w</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> lhv_sum_integrable<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">M</span></span><span class="main">]</span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span> 

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> cpx_sq_mat<span class="main">)</span> lhv_sum_integral'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"lhv <span class="free">M</span> <span class="free">A</span> <span class="free">B</span> <span class="free">R</span> <span class="free">XA</span> <span class="free">XB</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">integral<span class="hidden">⇧</span><sup>L</sup></span> <span class="free">M</span> <span class="main">(</span><span class="main">λ</span><span class="bound">w</span><span class="main">.</span> <span class="main">(</span><span class="main">∑</span> <span class="bound">a</span> <span class="main">∈</span> spectrum <span class="free">A</span><span class="main">.</span> <span class="free">f</span> <span class="bound">a</span> <span class="main">*</span> <span class="free">XA</span> <span class="bound">a</span> <span class="bound">w</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">∑</span> <span class="bound">b</span> <span class="main">∈</span> spectrum <span class="free">B</span><span class="main">.</span> <span class="free">g</span> <span class="bound">b</span> <span class="main">*</span> <span class="free">XB</span> <span class="bound">b</span> <span class="bound">w</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
  <span class="main">(</span><span class="main">∑</span> <span class="bound">a</span> <span class="main">∈</span> spectrum <span class="free">A</span><span class="main">.</span> <span class="free">f</span> <span class="bound">a</span> <span class="main">*</span> <span class="main">(</span><span class="main">∑</span> <span class="bound">b</span> <span class="main">∈</span> spectrum <span class="free">B</span><span class="main">.</span> <span class="free">g</span> <span class="bound">b</span>  <span class="main">*</span> <span class="keyword1">integral<span class="hidden">⇧</span><sup>L</sup></span> <span class="free">M</span> <span class="main">(</span><span class="main">λ</span><span class="bound">w</span><span class="main">.</span> <span class="free">XA</span> <span class="bound">a</span> <span class="bound">w</span> <span class="main">*</span> <span class="free">XB</span> <span class="bound">b</span> <span class="bound">w</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">integral<span class="hidden">⇧</span><sup>L</sup></span> <span class="free">M</span> <span class="main">(</span><span class="main">λ</span><span class="bound">w</span><span class="main">.</span> <span class="main">(</span><span class="main">∑</span> <span class="bound">a</span> <span class="main">∈</span> spectrum <span class="free">A</span><span class="main">.</span> <span class="free">f</span> <span class="bound">a</span> <span class="main">*</span> <span class="free">XA</span> <span class="bound">a</span> <span class="bound">w</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">∑</span> <span class="bound">b</span> <span class="main">∈</span> spectrum <span class="free">B</span><span class="main">.</span> <span class="free">g</span> <span class="bound">b</span> <span class="main">*</span> <span class="free">XB</span> <span class="bound">b</span> <span class="bound">w</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
    <span class="keyword1">integral<span class="hidden">⇧</span><sup>L</sup></span> <span class="free">M</span> <span class="main">(</span><span class="main">λ</span><span class="bound">w</span><span class="main">.</span> <span class="main">(</span><span class="main">∑</span> <span class="bound">a</span> <span class="main">∈</span> spectrum <span class="free">A</span><span class="main">.</span> <span class="main">(</span><span class="main">∑</span> <span class="bound">b</span> <span class="main">∈</span> spectrum <span class="free">B</span><span class="main">.</span> <span class="free">f</span> <span class="bound">a</span> <span class="main">*</span> <span class="free">XA</span> <span class="bound">a</span> <span class="bound">w</span> <span class="main">*</span> <span class="free">g</span> <span class="bound">b</span> <span class="main">*</span> <span class="free">XB</span> <span class="bound">b</span> <span class="bound">w</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>  
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> Bochner_Integration.integral_cong<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">w</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span><span class="main">∈</span> space <span class="free">M</span>"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">a</span><span class="main">∈</span>spectrum <span class="free">A</span><span class="main">.</span> <span class="free">f</span> <span class="bound">a</span> <span class="main">*</span> <span class="free">XA</span> <span class="bound">a</span> <span class="skolem">w</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">∑</span><span class="bound">b</span><span class="main">∈</span>spectrum <span class="free">B</span><span class="main">.</span> <span class="free">g</span> <span class="bound">b</span> <span class="main">*</span> <span class="free">XB</span> <span class="bound">b</span> <span class="skolem">w</span><span class="main">)</span> <span class="main">=</span> 
      <span class="main">(</span><span class="main">∑</span><span class="bound">a</span><span class="main">∈</span>spectrum <span class="free">A</span><span class="main">.</span> <span class="main">(</span><span class="main">∑</span><span class="bound">b</span><span class="main">∈</span>spectrum <span class="free">B</span><span class="main">.</span> <span class="free">f</span> <span class="bound">a</span> <span class="main">*</span> <span class="free">XA</span> <span class="bound">a</span> <span class="skolem">w</span> <span class="main">*</span> <span class="main">(</span><span class="free">g</span> <span class="bound">b</span><span class="main">)</span> <span class="main">*</span> <span class="free">XB</span> <span class="bound">b</span> <span class="skolem">w</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sum_product vector_space_over_itself.scale_scale<span class="main">)</span> 
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span> <span class="bound">a</span> <span class="main">∈</span> spectrum <span class="free">A</span><span class="main">.</span> 
    <span class="keyword1">integral<span class="hidden">⇧</span><sup>L</sup></span> <span class="free">M</span> <span class="main">(</span><span class="main">λ</span><span class="bound">w</span><span class="main">.</span> <span class="main">(</span><span class="main">∑</span> <span class="bound">b</span> <span class="main">∈</span> spectrum <span class="free">B</span><span class="main">.</span> <span class="free">f</span> <span class="bound">a</span> <span class="main">*</span> <span class="free">XA</span> <span class="bound">a</span> <span class="bound">w</span> <span class="main">*</span> <span class="free">g</span> <span class="bound">b</span> <span class="main">*</span> <span class="free">XB</span> <span class="bound">b</span> <span class="bound">w</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> Bochner_Integration.integral_sum<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span><span class="main">∈</span> spectrum <span class="free">A</span>"</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"integrable <span class="free">M</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">∑</span><span class="bound">b</span><span class="main">∈</span>spectrum <span class="free">B</span><span class="main">.</span> <span class="free">f</span> <span class="skolem">a</span> <span class="main">*</span> <span class="free">XA</span> <span class="skolem">a</span> <span class="bound">x</span> <span class="main">*</span> <span class="free">g</span> <span class="bound">b</span> <span class="main">*</span> <span class="free">XB</span> <span class="bound">b</span> <span class="bound">x</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> lhv_lsum_scal_integrable<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">M</span></span><span class="main">]</span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span> <span class="bound">a</span> <span class="main">∈</span> spectrum <span class="free">A</span><span class="main">.</span> <span class="free">f</span> <span class="bound">a</span> <span class="main">*</span>
    <span class="keyword1">integral<span class="hidden">⇧</span><sup>L</sup></span> <span class="free">M</span> <span class="main">(</span><span class="main">λ</span><span class="bound">w</span><span class="main">.</span> <span class="main">(</span><span class="main">∑</span> <span class="bound">b</span> <span class="main">∈</span> spectrum <span class="free">B</span><span class="main">.</span> <span class="free">XA</span> <span class="bound">a</span> <span class="bound">w</span> <span class="main">*</span> <span class="free">g</span> <span class="bound">b</span> <span class="main">*</span> <span class="free">XB</span> <span class="bound">b</span> <span class="bound">w</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">a</span><span class="main">∈</span> spectrum <span class="free">A</span><span class="main">.</span> <span class="keyword1">integral<span class="hidden">⇧</span><sup>L</sup></span> <span class="free">M</span> <span class="main">(</span><span class="main">λ</span><span class="bound">w</span><span class="main">.</span> <span class="main">(</span><span class="main">∑</span> <span class="bound">b</span> <span class="main">∈</span> spectrum <span class="free">B</span><span class="main">.</span> <span class="free">f</span> <span class="bound">a</span> <span class="main">*</span> <span class="free">XA</span> <span class="bound">a</span> <span class="bound">w</span> <span class="main">*</span> <span class="free">g</span> <span class="bound">b</span> <span class="main">*</span> <span class="free">XB</span> <span class="bound">b</span> <span class="bound">w</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
      <span class="free">f</span> <span class="bound">a</span> <span class="main">*</span> <span class="keyword1">integral<span class="hidden">⇧</span><sup>L</sup></span> <span class="free">M</span> <span class="main">(</span><span class="main">λ</span><span class="bound">w</span><span class="main">.</span> <span class="main">(</span><span class="main">∑</span> <span class="bound">b</span> <span class="main">∈</span> spectrum <span class="free">B</span><span class="main">.</span> <span class="free">XA</span> <span class="bound">a</span> <span class="bound">w</span> <span class="main">*</span> <span class="free">g</span> <span class="bound">b</span> <span class="main">*</span> <span class="free">XB</span> <span class="bound">b</span> <span class="bound">w</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span><span class="main">∈</span> spectrum <span class="free">A</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">LINT</span> <span class="bound">w</span><span class="main">|</span><span class="free">M</span><span class="main">.</span> <span class="main">(</span><span class="main">∑</span><span class="bound">b</span><span class="main">∈</span>spectrum <span class="free">B</span><span class="main">.</span> <span class="free">f</span> <span class="skolem">a</span> <span class="main">*</span> <span class="free">XA</span> <span class="skolem">a</span> <span class="bound">w</span> <span class="main">*</span> <span class="free">g</span> <span class="bound">b</span> <span class="main">*</span> <span class="free">XB</span> <span class="bound">b</span> <span class="bound">w</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
        <span class="main">(</span><span class="keyword1">LINT</span> <span class="bound">w</span><span class="main">|</span><span class="free">M</span><span class="main">.</span> <span class="free">f</span> <span class="skolem">a</span><span class="main">*</span> <span class="main">(</span><span class="main">∑</span><span class="bound">b</span><span class="main">∈</span>spectrum <span class="free">B</span><span class="main">.</span> <span class="free">XA</span> <span class="skolem">a</span> <span class="bound">w</span> <span class="main">*</span> <span class="free">g</span> <span class="bound">b</span> <span class="main">*</span> <span class="free">XB</span> <span class="bound">b</span> <span class="bound">w</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> Bochner_Integration.integral_cong<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> space <span class="free">M</span>"</span></span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">b</span><span class="main">∈</span>spectrum <span class="free">B</span><span class="main">.</span> <span class="free">f</span> <span class="skolem">a</span> <span class="main">*</span> <span class="free">XA</span> <span class="skolem">a</span> <span class="skolem">x</span> <span class="main">*</span> <span class="free">g</span> <span class="bound">b</span> <span class="main">*</span> <span class="free">XB</span> <span class="bound">b</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">=</span> 
          <span class="free">f</span> <span class="skolem">a</span> <span class="main">*</span> <span class="main">(</span><span class="main">∑</span><span class="bound">b</span><span class="main">∈</span>spectrum <span class="free">B</span><span class="main">.</span> <span class="free">XA</span> <span class="skolem">a</span> <span class="skolem">x</span> <span class="main">*</span> <span class="free">g</span> <span class="bound">b</span> <span class="main">*</span> <span class="free">XB</span> <span class="bound">b</span> <span class="skolem">x</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> Finite_Cartesian_Product.sum_cong_aux 
              vector_space_over_itself.scale_scale vector_space_over_itself.scale_sum_right<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="free">f</span> <span class="skolem">a</span> <span class="main">*</span> <span class="main">(</span><span class="keyword1">LINT</span> <span class="bound">w</span><span class="main">|</span><span class="free">M</span><span class="main">.</span> <span class="main">(</span><span class="main">∑</span><span class="bound">b</span><span class="main">∈</span>spectrum <span class="free">B</span><span class="main">.</span> <span class="free">XA</span> <span class="skolem">a</span> <span class="bound">w</span> <span class="main">*</span> <span class="free">g</span> <span class="bound">b</span> <span class="main">*</span> <span class="free">XB</span> <span class="bound">b</span> <span class="bound">w</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">LINT</span> <span class="bound">w</span><span class="main">|</span><span class="free">M</span><span class="main">.</span> <span class="main">(</span><span class="main">∑</span><span class="bound">b</span><span class="main">∈</span>spectrum <span class="free">B</span><span class="main">.</span> <span class="free">f</span> <span class="skolem">a</span> <span class="main">*</span> <span class="free">XA</span> <span class="skolem">a</span> <span class="bound">w</span> <span class="main">*</span> <span class="free">g</span> <span class="bound">b</span> <span class="main">*</span> <span class="free">XB</span> <span class="bound">b</span> <span class="bound">w</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
        <span class="free">f</span> <span class="skolem">a</span> <span class="main">*</span> <span class="main">(</span><span class="keyword1">LINT</span> <span class="bound">w</span><span class="main">|</span><span class="free">M</span><span class="main">.</span> <span class="main">(</span><span class="main">∑</span><span class="bound">b</span><span class="main">∈</span>spectrum <span class="free">B</span><span class="main">.</span> <span class="free">XA</span> <span class="skolem">a</span> <span class="bound">w</span> <span class="main">*</span> <span class="free">g</span> <span class="bound">b</span> <span class="main">*</span> <span class="free">XB</span> <span class="bound">b</span> <span class="bound">w</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span> <span class="bound">a</span> <span class="main">∈</span> spectrum <span class="free">A</span><span class="main">.</span> <span class="free">f</span> <span class="bound">a</span> <span class="main">*</span> <span class="main">(</span><span class="main">∑</span> <span class="bound">b</span> <span class="main">∈</span> spectrum <span class="free">B</span><span class="main">.</span> <span class="free">g</span> <span class="bound">b</span> <span class="main">*</span>
    <span class="keyword1">integral<span class="hidden">⇧</span><sup>L</sup></span> <span class="free">M</span> <span class="main">(</span><span class="main">λ</span><span class="bound">w</span><span class="main">.</span> <span class="free">XA</span> <span class="bound">a</span> <span class="bound">w</span> <span class="main">*</span> <span class="free">XB</span> <span class="bound">b</span> <span class="bound">w</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> sum.cong<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span><span class="main">∈</span> spectrum <span class="free">A</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">integral<span class="hidden">⇧</span><sup>L</sup></span> <span class="free">M</span> <span class="main">(</span><span class="main">λ</span><span class="bound">w</span><span class="main">.</span> <span class="main">(</span><span class="main">∑</span> <span class="bound">b</span> <span class="main">∈</span> spectrum <span class="free">B</span><span class="main">.</span> <span class="free">XA</span> <span class="skolem">a</span> <span class="bound">w</span> <span class="main">*</span> <span class="free">g</span> <span class="bound">b</span> <span class="main">*</span> <span class="free">XB</span> <span class="bound">b</span> <span class="bound">w</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span> <span class="bound">b</span> <span class="main">∈</span> spectrum <span class="free">B</span><span class="main">.</span> 
      <span class="keyword1">integral<span class="hidden">⇧</span><sup>L</sup></span> <span class="free">M</span> <span class="main">(</span><span class="main">λ</span><span class="bound">w</span><span class="main">.</span> <span class="free">XA</span> <span class="skolem">a</span> <span class="bound">w</span> <span class="main">*</span> <span class="free">g</span> <span class="bound">b</span> <span class="main">*</span> <span class="free">XB</span> <span class="bound">b</span> <span class="bound">w</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> Bochner_Integration.integral_sum<span class="main">)</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">b</span><span class="main">.</span> <span class="bound">b</span> <span class="main">∈</span> spectrum <span class="free">B</span> <span class="main">⟹</span> integrable <span class="free">M</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">XA</span> <span class="skolem">a</span> <span class="bound">x</span> <span class="main">*</span> <span class="free">g</span> <span class="bound">b</span> <span class="main">*</span> <span class="free">XB</span> <span class="bound">b</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
          <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">b</span>
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span><span class="main">∈</span> spectrum <span class="free">B</span>"</span></span>
          <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"integrable <span class="free">M</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">XA</span> <span class="skolem">a</span> <span class="bound">x</span> <span class="main">*</span> <span class="free">g</span> <span class="skolem">b</span> <span class="main">*</span> <span class="free">XB</span> <span class="skolem">b</span> <span class="bound">x</span><span class="main">)</span>"</span></span> 
            <span class="keyword1"><span class="command">using</span></span> assms lhv_scal_integrable<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">M</span></span> <span class="main">_</span> <span class="main">_</span> <span class="main">_</span> <span class="main">_</span> <span class="main">_</span> <span class="quoted"><span class="skolem">a</span></span> <span class="quoted"><span class="skolem">b</span></span> <span class="quoted"><span class="main">1</span></span><span class="main">]</span> <span class="quoted"><span class="quoted">‹<span class="skolem">a</span><span class="main">∈</span> spectrum <span class="free">A</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span> <span class="bound">b</span> <span class="main">∈</span> spectrum <span class="free">B</span><span class="main">.</span> <span class="free">g</span> <span class="bound">b</span> <span class="main">*</span> <span class="keyword1">integral<span class="hidden">⇧</span><sup>L</sup></span> <span class="free">M</span> <span class="main">(</span><span class="main">λ</span><span class="bound">w</span><span class="main">.</span> <span class="free">XA</span> <span class="skolem">a</span> <span class="bound">w</span> <span class="main">*</span> <span class="free">XB</span> <span class="bound">b</span> <span class="bound">w</span><span class="main">)</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> sum.cong<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span><span class="main">∈</span> spectrum <span class="free">B</span>"</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">LINT</span> <span class="bound">w</span><span class="main">|</span><span class="free">M</span><span class="main">.</span> <span class="free">XA</span> <span class="skolem">a</span> <span class="bound">w</span> <span class="main">*</span> <span class="free">g</span> <span class="skolem">x</span> <span class="main">*</span> <span class="free">XB</span> <span class="skolem">x</span> <span class="bound">w</span> <span class="main">=</span> <span class="keyword1">LINT</span> <span class="bound">w</span><span class="main">|</span><span class="free">M</span><span class="main">.</span> <span class="free">g</span> <span class="skolem">x</span> <span class="main">*</span> <span class="main">(</span><span class="free">XA</span> <span class="skolem">a</span> <span class="bound">w</span> <span class="main">*</span> <span class="free">XB</span> <span class="skolem">x</span> <span class="bound">w</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Bochner_Integration.integral_cong<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="free">g</span> <span class="skolem">x</span> <span class="main">*</span> <span class="main">(</span><span class="keyword1">LINT</span> <span class="bound">w</span><span class="main">|</span><span class="free">M</span><span class="main">.</span> <span class="free">XA</span> <span class="skolem">a</span> <span class="bound">w</span> <span class="main">*</span> <span class="free">XB</span> <span class="skolem">x</span> <span class="bound">w</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> Bochner_Integration.integral_mult_right_zero<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">M</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="skolem">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">w</span><span class="main">.</span> <span class="free">XA</span> <span class="skolem">a</span> <span class="bound">w</span> <span class="main">*</span> <span class="free">XB</span> <span class="skolem">x</span> <span class="bound">w</span>"</span></span><span class="main">]</span> 
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">LINT</span> <span class="bound">w</span><span class="main">|</span><span class="free">M</span><span class="main">.</span> <span class="free">XA</span> <span class="skolem">a</span> <span class="bound">w</span> <span class="main">*</span> <span class="free">g</span> <span class="skolem">x</span> <span class="main">*</span> <span class="free">XB</span> <span class="skolem">x</span> <span class="bound">w</span> <span class="main">=</span> <span class="free">g</span> <span class="skolem">x</span> <span class="main">*</span> <span class="main">(</span><span class="keyword1">LINT</span> <span class="bound">w</span><span class="main">|</span><span class="free">M</span><span class="main">.</span> <span class="free">XA</span> <span class="skolem">a</span> <span class="bound">w</span> <span class="main">*</span> <span class="free">XB</span> <span class="skolem">x</span> <span class="bound">w</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">integral<span class="hidden">⇧</span><sup>L</sup></span> <span class="free">M</span> <span class="main">(</span><span class="main">λ</span><span class="bound">w</span><span class="main">.</span> <span class="main">(</span><span class="main">∑</span> <span class="bound">b</span> <span class="main">∈</span> spectrum <span class="free">B</span><span class="main">.</span> <span class="free">XA</span> <span class="skolem">a</span> <span class="bound">w</span> <span class="main">*</span> <span class="free">g</span> <span class="bound">b</span> <span class="main">*</span> <span class="free">XB</span> <span class="bound">b</span> <span class="bound">w</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
        <span class="main">(</span><span class="main">∑</span> <span class="bound">b</span> <span class="main">∈</span> spectrum <span class="free">B</span><span class="main">.</span> <span class="free">g</span> <span class="bound">b</span> <span class="main">*</span> <span class="keyword1">integral<span class="hidden">⇧</span><sup>L</sup></span> <span class="free">M</span> <span class="main">(</span><span class="main">λ</span><span class="bound">w</span><span class="main">.</span> <span class="free">XA</span> <span class="skolem">a</span> <span class="bound">w</span> <span class="main">*</span> <span class="free">XB</span> <span class="bound">b</span> <span class="bound">w</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="skolem">a</span> <span class="main">*</span> <span class="main">(</span><span class="keyword1">LINT</span> <span class="bound">w</span><span class="main">|</span><span class="free">M</span><span class="main">.</span> <span class="main">(</span><span class="main">∑</span><span class="bound">b</span><span class="main">∈</span>spectrum <span class="free">B</span><span class="main">.</span> <span class="free">XA</span> <span class="skolem">a</span> <span class="bound">w</span> <span class="main">*</span> <span class="free">g</span> <span class="bound">b</span> <span class="main">*</span> <span class="free">XB</span> <span class="bound">b</span> <span class="bound">w</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
        <span class="free">f</span> <span class="skolem">a</span> <span class="main">*</span> <span class="main">(</span><span class="main">∑</span> <span class="bound">b</span> <span class="main">∈</span> spectrum <span class="free">B</span><span class="main">.</span> <span class="free">g</span> <span class="bound">b</span> <span class="main">*</span> <span class="keyword1">integral<span class="hidden">⇧</span><sup>L</sup></span> <span class="free">M</span> <span class="main">(</span><span class="main">λ</span><span class="bound">w</span><span class="main">.</span> <span class="free">XA</span> <span class="skolem">a</span> <span class="bound">w</span> <span class="main">*</span> <span class="free">XB</span> <span class="bound">b</span> <span class="bound">w</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> 
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> cpx_sq_mat<span class="main">)</span> sum_qt_expect_trace<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"lhv <span class="free">M</span> <span class="free">A</span> <span class="free">B</span> <span class="free">R</span> <span class="free">XA</span> <span class="free">XB</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span> <span class="bound">a</span> <span class="main">∈</span> spectrum <span class="free">A</span><span class="main">.</span> <span class="free">f</span> <span class="bound">a</span> <span class="main">*</span> <span class="main">(</span><span class="main">∑</span> <span class="bound">b</span> <span class="main">∈</span> spectrum <span class="free">B</span><span class="main">.</span> <span class="free">g</span> <span class="bound">b</span> <span class="main">*</span> <span class="keyword1">integral<span class="hidden">⇧</span><sup>L</sup></span> <span class="free">M</span> <span class="main">(</span><span class="main">λ</span><span class="bound">w</span><span class="main">.</span> <span class="free">XA</span> <span class="bound">a</span> <span class="bound">w</span> <span class="main">*</span> <span class="free">XB</span> <span class="bound">b</span> <span class="bound">w</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
    <span class="main">(</span><span class="main">∑</span> <span class="bound">a</span> <span class="main">∈</span> spectrum <span class="free">A</span><span class="main">.</span> <span class="free">f</span> <span class="bound">a</span> <span class="main">*</span> <span class="main">(</span><span class="main">∑</span> <span class="bound">b</span> <span class="main">∈</span> spectrum <span class="free">B</span><span class="main">.</span> <span class="free">g</span> <span class="bound">b</span> <span class="main">*</span> 
    Re <span class="main">(</span>Complex_Matrix.trace<span class="main">(</span>eigen_projector <span class="free">A</span> <span class="bound">a</span> <span class="main">*</span> <span class="main">(</span>eigen_projector <span class="free">B</span> <span class="bound">b</span><span class="main">)</span> <span class="main">*</span> <span class="free">R</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> sum.cong<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span><span class="main">∈</span> spectrum <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">b</span><span class="main">∈</span>spectrum <span class="free">B</span><span class="main">.</span> <span class="free">g</span> <span class="bound">b</span> <span class="main">*</span> <span class="main">(</span><span class="keyword1">LINT</span> <span class="bound">w</span><span class="main">|</span><span class="free">M</span><span class="main">.</span> <span class="free">XA</span> <span class="skolem">a</span> <span class="bound">w</span> <span class="main">*</span> <span class="free">XB</span> <span class="bound">b</span> <span class="bound">w</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
       <span class="main">(</span><span class="main">∑</span><span class="bound">b</span><span class="main">∈</span>spectrum <span class="free">B</span><span class="main">.</span> <span class="free">g</span> <span class="bound">b</span> <span class="main">*</span> 
        Re <span class="main">(</span>Complex_Matrix.trace <span class="main">(</span>eigen_projector <span class="free">A</span> <span class="skolem">a</span> <span class="main">*</span> eigen_projector <span class="free">B</span> <span class="bound">b</span> <span class="main">*</span> <span class="free">R</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> sum.cong<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">b</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span><span class="main">∈</span> spectrum <span class="free">B</span>"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="skolem">b</span> <span class="main">*</span> <span class="main">(</span><span class="keyword1">LINT</span> <span class="bound">w</span><span class="main">|</span><span class="free">M</span><span class="main">.</span> <span class="free">XA</span> <span class="skolem">a</span> <span class="bound">w</span> <span class="main">*</span> <span class="free">XB</span> <span class="skolem">b</span> <span class="bound">w</span><span class="main">)</span> <span class="main">=</span> 
      <span class="free">g</span> <span class="skolem">b</span> <span class="main">*</span> Re <span class="main">(</span>Complex_Matrix.trace <span class="main">(</span>eigen_projector <span class="free">A</span> <span class="skolem">a</span> <span class="main">*</span> eigen_projector <span class="free">B</span> <span class="skolem">b</span> <span class="main">*</span> <span class="free">R</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> lhv_integral_eq<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">M</span></span><span class="main">]</span> assms <span class="quoted"><span class="quoted">‹<span class="skolem">a</span> <span class="main">∈</span> spectrum <span class="free">A</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">b</span> <span class="main">∈</span> spectrum <span class="free">B</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="skolem">a</span> <span class="main">*</span> <span class="main">(</span><span class="main">∑</span><span class="bound">b</span><span class="main">∈</span>spectrum <span class="free">B</span><span class="main">.</span> <span class="free">g</span> <span class="bound">b</span> <span class="main">*</span> <span class="main">(</span><span class="keyword1">LINT</span> <span class="bound">w</span><span class="main">|</span><span class="free">M</span><span class="main">.</span> <span class="free">XA</span> <span class="skolem">a</span> <span class="bound">w</span> <span class="main">*</span> <span class="free">XB</span> <span class="bound">b</span> <span class="bound">w</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
        <span class="free">f</span> <span class="skolem">a</span> <span class="main">*</span> <span class="main">(</span><span class="main">∑</span><span class="bound">b</span><span class="main">∈</span>spectrum <span class="free">B</span><span class="main">.</span> <span class="free">g</span> <span class="bound">b</span> <span class="main">*</span> 
        Re <span class="main">(</span>Complex_Matrix.trace <span class="main">(</span>eigen_projector <span class="free">A</span> <span class="skolem">a</span> <span class="main">*</span> eigen_projector <span class="free">B</span> <span class="bound">b</span> <span class="main">*</span> <span class="free">R</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> cpx_sq_mat<span class="main">)</span> sum_eigen_projector_trace_dist<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"hermitian <span class="free">B</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span><span class="main">∈</span> <span class="free">fc_mats</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">B</span><span class="main">∈</span> <span class="free">fc_mats</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">R</span><span class="main">∈</span> <span class="free">fc_mats</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span> <span class="bound">b</span> <span class="main">∈</span> spectrum <span class="free">B</span><span class="main">.</span> <span class="main">(</span><span class="bound">b</span> <span class="main">*</span> 
    Complex_Matrix.trace<span class="main">(</span><span class="free">A</span> <span class="main">*</span> <span class="main">(</span>eigen_projector <span class="free">B</span> <span class="bound">b</span><span class="main">)</span> <span class="main">*</span> <span class="free">R</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Complex_Matrix.trace<span class="main">(</span><span class="free">A</span> <span class="main">*</span> <span class="free">B</span> <span class="main">*</span> <span class="free">R</span><span class="main">)</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">b</span><span class="main">∈</span>spectrum <span class="free">B</span><span class="main">.</span> <span class="bound">b</span> <span class="main">*</span> Complex_Matrix.trace <span class="main">(</span><span class="free">A</span> <span class="main">*</span> eigen_projector <span class="free">B</span> <span class="bound">b</span> <span class="main">*</span> <span class="free">R</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
       <span class="main">(</span><span class="main">∑</span><span class="bound">b</span><span class="main">∈</span>spectrum <span class="free">B</span><span class="main">.</span> Complex_Matrix.trace <span class="main">(</span><span class="free">A</span> <span class="main">*</span> <span class="main">(</span><span class="bound">b</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>m</sub></span> <span class="main">(</span>eigen_projector <span class="free">B</span> <span class="bound">b</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="free">R</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> sum.cong<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">b</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span><span class="main">∈</span> spectrum <span class="free">B</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">*</span> Complex_Matrix.trace <span class="main">(</span><span class="free">A</span> <span class="main">*</span> eigen_projector <span class="free">B</span> <span class="skolem">b</span> <span class="main">*</span> <span class="free">R</span><span class="main">)</span> <span class="main">=</span> 
      Complex_Matrix.trace <span class="main">(</span><span class="skolem">b</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>m</sub></span> <span class="main">(</span><span class="free">A</span> <span class="main">*</span> eigen_projector <span class="free">B</span> <span class="skolem">b</span> <span class="main">*</span> <span class="free">R</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> trace_smult<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">*</span> eigen_projector <span class="free">B</span> <span class="skolem">b</span> <span class="main">*</span> <span class="free">R</span> <span class="main">∈</span> carrier_mat <span class="free">dimR</span> <span class="free">dimR</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> eigen_projector_carrier 
          assms fc_mats_carrier dim_eq  <span class="quoted"><span class="quoted">‹<span class="skolem">b</span> <span class="main">∈</span> spectrum <span class="free">B</span>›</span></span> cpx_sq_mat_mult <span class="keyword1"><span class="command">by</span></span> <span class="operator">meson</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> Complex_Matrix.trace <span class="main">(</span><span class="free">A</span> <span class="main">*</span> <span class="main">(</span><span class="skolem">b</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>m</sub></span> eigen_projector <span class="free">B</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">*</span> <span class="free">R</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>m</sub></span> <span class="main">(</span><span class="free">A</span> <span class="main">*</span> eigen_projector <span class="free">B</span> <span class="skolem">b</span> <span class="main">*</span> <span class="free">R</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">b</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>m</sub></span> <span class="main">(</span><span class="free">A</span> <span class="main">*</span> <span class="main">(</span>eigen_projector <span class="free">B</span> <span class="skolem">b</span> <span class="main">*</span> <span class="free">R</span><span class="main">)</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">*</span> eigen_projector <span class="free">B</span> <span class="skolem">b</span> <span class="main">*</span> <span class="free">R</span> <span class="main">=</span> <span class="free">A</span> <span class="main">*</span> <span class="main">(</span>eigen_projector <span class="free">B</span> <span class="skolem">b</span> <span class="main">*</span> <span class="free">R</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹<span class="skolem">b</span> <span class="main">∈</span> spectrum <span class="free">B</span>›</span></span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> assoc_mult_mat dim_eq 
              fc_mats_carrier eigen_projector_carrier<span class="main">)</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="free">A</span> <span class="main">*</span> <span class="main">(</span><span class="skolem">b</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>m</sub></span> <span class="main">(</span>eigen_projector <span class="free">B</span> <span class="skolem">b</span> <span class="main">*</span> <span class="free">R</span><span class="main">)</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> mult_smult_distrib<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">∈</span> carrier_mat <span class="free">dimR</span> <span class="free">dimR</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> eigen_projector_carrier  assms 
            fc_mats_carrier dim_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"eigen_projector <span class="free">B</span> <span class="skolem">b</span> <span class="main">*</span> <span class="free">R</span> <span class="main">∈</span> carrier_mat <span class="free">dimR</span> <span class="free">dimR</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> eigen_projector_carrier 
            <span class="quoted"><span class="quoted">‹<span class="skolem">b</span> <span class="main">∈</span> spectrum <span class="free">B</span>›</span></span> assms fc_mats_carrier dim_eq cpx_sq_mat_mult <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="free">A</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span><span class="skolem">b</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>m</sub></span> eigen_projector <span class="free">B</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">*</span> <span class="free">R</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>m</sub></span> <span class="main">(</span>eigen_projector <span class="free">B</span> <span class="skolem">b</span> <span class="main">*</span> <span class="free">R</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">b</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>m</sub></span> eigen_projector <span class="free">B</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">*</span> <span class="free">R</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> mult_smult_assoc_mat<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"eigen_projector <span class="free">B</span> <span class="skolem">b</span> <span class="main">∈</span> carrier_mat <span class="free">dimR</span> <span class="free">dimR</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> eigen_projector_carrier 
              <span class="quoted"><span class="quoted">‹<span class="skolem">b</span> <span class="main">∈</span> spectrum <span class="free">B</span>›</span></span> assms fc_mats_carrier dim_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="main">∈</span> carrier_mat <span class="free">dimR</span> <span class="free">dimR</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms fc_mats_carrier dim_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="free">A</span> <span class="main">*</span> <span class="main">(</span><span class="skolem">b</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>m</sub></span> eigen_projector <span class="free">B</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">*</span> <span class="free">R</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹<span class="skolem">b</span> <span class="main">∈</span> spectrum <span class="free">B</span>›</span></span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> assoc_mult_mat 
            cpx_sq_mat_smult dim_eq fc_mats_carrier eigen_projector_carrier<span class="main">)</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>m</sub></span> <span class="main">(</span><span class="free">A</span> <span class="main">*</span> eigen_projector <span class="free">B</span> <span class="skolem">b</span> <span class="main">*</span> <span class="free">R</span><span class="main">)</span> <span class="main">=</span> <span class="free">A</span> <span class="main">*</span> <span class="main">(</span><span class="skolem">b</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>m</sub></span> eigen_projector <span class="free">B</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">*</span> <span class="free">R</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">*</span> Complex_Matrix.trace <span class="main">(</span><span class="free">A</span> <span class="main">*</span> eigen_projector <span class="free">B</span> <span class="skolem">b</span> <span class="main">*</span> <span class="free">R</span><span class="main">)</span> <span class="main">=</span> 
      Complex_Matrix.trace <span class="main">(</span><span class="free">A</span> <span class="main">*</span> <span class="main">(</span><span class="skolem">b</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>m</sub></span> eigen_projector <span class="free">B</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">*</span> <span class="free">R</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> Complex_Matrix.trace <span class="main">(</span><span class="free">A</span> <span class="main">*</span> 
    <span class="main">(</span>sum_mat <span class="main">(</span><span class="main">λ</span><span class="bound">b</span><span class="main">.</span> <span class="bound">b</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>m</sub></span> eigen_projector <span class="free">B</span> <span class="bound">b</span><span class="main">)</span> <span class="main">(</span>spectrum <span class="free">B</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="free">R</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> trace_sum_mat_mat_distrib<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main">)</span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>spectrum <span class="free">B</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> spectrum_finite<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">B</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">b</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span><span class="main">∈</span> spectrum <span class="free">B</span>"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>m</sub></span> eigen_projector <span class="free">B</span> <span class="skolem">b</span> <span class="main">∈</span> <span class="free">fc_mats</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">b</span> <span class="main">∈</span> spectrum <span class="free">B</span>›</span></span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> cpx_sq_mat_smult eigen_projector_carrier<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> Complex_Matrix.trace <span class="main">(</span><span class="free">A</span> <span class="main">*</span> <span class="free">B</span> <span class="main">*</span> <span class="free">R</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sum_mat <span class="main">(</span><span class="main">λ</span><span class="bound">b</span><span class="main">.</span> <span class="bound">b</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>m</sub></span> eigen_projector <span class="free">B</span> <span class="bound">b</span><span class="main">)</span> <span class="main">(</span>spectrum <span class="free">B</span><span class="main">)</span> <span class="main">=</span> <span class="free">B</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> make_pm_sum' assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> cpx_sq_mat<span class="main">)</span> sum_eigen_projector_trace_right<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"hermitian <span class="free">A</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span><span class="main">∈</span> <span class="free">fc_mats</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">B</span><span class="main">∈</span> <span class="free">fc_mats</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span> <span class="bound">a</span> <span class="main">∈</span> spectrum <span class="free">A</span><span class="main">.</span> Complex_Matrix.trace <span class="main">(</span><span class="bound">a</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>m</sub></span> eigen_projector <span class="free">A</span> <span class="bound">a</span> <span class="main">*</span> <span class="free">B</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
  Complex_Matrix.trace <span class="main">(</span><span class="free">A</span> <span class="main">*</span> <span class="free">B</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sum_mat <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> <span class="bound">a</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>m</sub></span> eigen_projector <span class="free">A</span> <span class="bound">a</span> <span class="main">*</span> <span class="free">B</span><span class="main">)</span> <span class="main">(</span>spectrum <span class="free">A</span><span class="main">)</span> <span class="main">=</span> 
    sum_mat <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> <span class="bound">a</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>m</sub></span> eigen_projector <span class="free">A</span> <span class="bound">a</span><span class="main">)</span> <span class="main">(</span>spectrum <span class="free">A</span><span class="main">)</span> <span class="main">*</span> <span class="free">B</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> mult_sum_mat_distrib_right<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>spectrum <span class="free">A</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> spectrum_finite<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">A</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">a</span><span class="main">.</span> <span class="bound">a</span> <span class="main">∈</span> spectrum <span class="free">A</span> <span class="main">⟹</span> <span class="bound">a</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>m</sub></span> eigen_projector <span class="free">A</span> <span class="bound">a</span> <span class="main">∈</span> <span class="free">fc_mats</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>2<span class="main">)</span> cpx_sq_mat_smult eigen_projector_carrier <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">B</span><span class="main">∈</span> <span class="free">fc_mats</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="free">A</span> <span class="main">*</span> <span class="free">B</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> make_pm_sum' assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> seq<span class="main">:</span> <span class="quoted"><span class="quoted">"sum_mat <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> <span class="bound">a</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>m</sub></span> eigen_projector <span class="free">A</span> <span class="bound">a</span> <span class="main">*</span> <span class="free">B</span><span class="main">)</span> <span class="main">(</span>spectrum <span class="free">A</span><span class="main">)</span> <span class="main">=</span> <span class="free">A</span> <span class="main">*</span> <span class="free">B</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span> <span class="bound">a</span> <span class="main">∈</span> spectrum <span class="free">A</span><span class="main">.</span> Complex_Matrix.trace <span class="main">(</span><span class="bound">a</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>m</sub></span> eigen_projector <span class="free">A</span> <span class="bound">a</span> <span class="main">*</span> <span class="free">B</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
    Complex_Matrix.trace <span class="main">(</span>sum_mat <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> <span class="bound">a</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>m</sub></span> eigen_projector <span class="free">A</span> <span class="bound">a</span> <span class="main">*</span> <span class="free">B</span><span class="main">)</span> <span class="main">(</span>spectrum <span class="free">A</span><span class="main">)</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> trace_sum_mat<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>spectrum <span class="free">A</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> spectrum_finite<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">A</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">a</span><span class="main">.</span> <span class="bound">a</span> <span class="main">∈</span> spectrum <span class="free">A</span> <span class="main">⟹</span> <span class="bound">a</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>m</sub></span> eigen_projector <span class="free">A</span> <span class="bound">a</span> <span class="main">*</span> <span class="free">B</span> <span class="main">∈</span> <span class="free">fc_mats</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> cpx_sq_mat_mult cpx_sq_mat_smult 
          eigen_projector_carrier<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> Complex_Matrix.trace <span class="main">(</span><span class="free">A</span> <span class="main">*</span> <span class="free">B</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> seq <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> cpx_sq_mat<span class="main">)</span> sum_eigen_projector_trace<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"hermitian <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"hermitian <span class="free">B</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span><span class="main">∈</span> <span class="free">fc_mats</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">B</span><span class="main">∈</span> <span class="free">fc_mats</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">R</span><span class="main">∈</span> <span class="free">fc_mats</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span> <span class="bound">a</span> <span class="main">∈</span> spectrum <span class="free">A</span><span class="main">.</span>  <span class="bound">a</span> <span class="main">*</span>  <span class="main">(</span><span class="main">∑</span> <span class="bound">b</span> <span class="main">∈</span> spectrum <span class="free">B</span><span class="main">.</span> <span class="main">(</span><span class="bound">b</span> <span class="main">*</span> 
    Complex_Matrix.trace<span class="main">(</span>eigen_projector <span class="free">A</span> <span class="bound">a</span> <span class="main">*</span> <span class="main">(</span>eigen_projector <span class="free">B</span> <span class="bound">b</span><span class="main">)</span> <span class="main">*</span> <span class="free">R</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
    Complex_Matrix.trace<span class="main">(</span><span class="free">A</span> <span class="main">*</span> <span class="free">B</span> <span class="main">*</span> <span class="free">R</span><span class="main">)</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span> <span class="bound">a</span> <span class="main">∈</span> spectrum <span class="free">A</span><span class="main">.</span>  <span class="bound">a</span> <span class="main">*</span>  <span class="main">(</span><span class="main">∑</span> <span class="bound">b</span> <span class="main">∈</span> spectrum <span class="free">B</span><span class="main">.</span> <span class="main">(</span><span class="bound">b</span> <span class="main">*</span> 
    Complex_Matrix.trace<span class="main">(</span>eigen_projector <span class="free">A</span> <span class="bound">a</span> <span class="main">*</span> <span class="main">(</span>eigen_projector <span class="free">B</span> <span class="bound">b</span><span class="main">)</span> <span class="main">*</span> <span class="free">R</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span> <span class="bound">a</span> <span class="main">∈</span> spectrum <span class="free">A</span><span class="main">.</span>   
    Complex_Matrix.trace <span class="main">(</span><span class="bound">a</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>m</sub></span> eigen_projector <span class="free">A</span> <span class="bound">a</span> <span class="main">*</span> <span class="main">(</span><span class="free">B</span> <span class="main">*</span> <span class="free">R</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> sum.cong<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span><span class="main">∈</span> spectrum <span class="free">A</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">b</span><span class="main">∈</span>spectrum <span class="free">B</span><span class="main">.</span> <span class="bound">b</span> <span class="main">*</span> 
      Complex_Matrix.trace <span class="main">(</span>eigen_projector <span class="free">A</span> <span class="skolem">a</span> <span class="main">*</span> eigen_projector <span class="free">B</span> <span class="bound">b</span> <span class="main">*</span> <span class="free">R</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
      Complex_Matrix.trace <span class="main">(</span>eigen_projector <span class="free">A</span> <span class="skolem">a</span> <span class="main">*</span> <span class="free">B</span> <span class="main">*</span> <span class="free">R</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 
      sum_eigen_projector_trace_dist<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">B</span></span> <span class="quoted"><span class="quoted">"eigen_projector <span class="free">A</span> <span class="skolem">a</span>"</span></span> <span class="quoted"><span class="free">R</span></span><span class="main">]</span> assms eigen_projector_carrier 
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">*</span>  <span class="main">(</span><span class="main">∑</span> <span class="bound">b</span> <span class="main">∈</span> spectrum <span class="free">B</span><span class="main">.</span> <span class="main">(</span><span class="bound">b</span> <span class="main">*</span> 
      Complex_Matrix.trace<span class="main">(</span>eigen_projector <span class="free">A</span> <span class="skolem">a</span> <span class="main">*</span> <span class="main">(</span>eigen_projector <span class="free">B</span> <span class="bound">b</span><span class="main">)</span> <span class="main">*</span> <span class="free">R</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
      <span class="skolem">a</span> <span class="main">*</span> Complex_Matrix.trace <span class="main">(</span>eigen_projector <span class="free">A</span> <span class="skolem">a</span> <span class="main">*</span> <span class="free">B</span> <span class="main">*</span> <span class="free">R</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> Complex_Matrix.trace <span class="main">(</span><span class="skolem">a</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>m</sub></span> <span class="main">(</span>eigen_projector <span class="free">A</span> <span class="skolem">a</span> <span class="main">*</span> <span class="free">B</span> <span class="main">*</span> <span class="free">R</span><span class="main">)</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> trace_smult<span class="main">[</span><span class="operator">symmetric</span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"eigen_projector <span class="free">A</span> <span class="skolem">a</span> <span class="main">*</span> <span class="free">B</span> <span class="main">*</span> <span class="free">R</span>"</span></span> <span class="quoted"><span class="free">dimR</span></span> <span class="quoted"><span class="skolem">a</span></span><span class="main">]</span> assms
       <span class="quoted"><span class="quoted">‹<span class="skolem">a</span> <span class="main">∈</span> spectrum <span class="free">A</span>›</span></span> cpx_sq_mat_mult dim_eq fc_mats_carrier eigen_projector_carrier <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> Complex_Matrix.trace <span class="main">(</span><span class="skolem">a</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>m</sub></span> eigen_projector <span class="free">A</span> <span class="skolem">a</span> <span class="main">*</span> <span class="main">(</span><span class="free">B</span> <span class="main">*</span> <span class="free">R</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>m</sub></span> <span class="main">(</span>eigen_projector <span class="free">A</span> <span class="skolem">a</span> <span class="main">*</span> <span class="free">B</span> <span class="main">*</span> <span class="free">R</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">a</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>m</sub></span> <span class="main">(</span>eigen_projector <span class="free">A</span> <span class="skolem">a</span> <span class="main">*</span> <span class="free">B</span><span class="main">)</span> <span class="main">*</span> <span class="free">R</span>"</span></span> 
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span>  mult_smult_assoc_mat<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">R</span><span class="main">∈</span> carrier_mat <span class="free">dimR</span> <span class="free">dimR</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms fc_mats_carrier dim_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"eigen_projector <span class="free">A</span> <span class="skolem">a</span> <span class="main">*</span> <span class="free">B</span> <span class="main">∈</span> carrier_mat <span class="free">dimR</span> <span class="free">dimR</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms eigen_projector_carrier 
            cpx_sq_mat_mult fc_mats_carrier dim_eq <span class="quoted"><span class="quoted">‹<span class="skolem">a</span> <span class="main">∈</span> spectrum <span class="free">A</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="skolem">a</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>m</sub></span> eigen_projector <span class="free">A</span> <span class="skolem">a</span> <span class="main">*</span> <span class="free">B</span> <span class="main">*</span> <span class="free">R</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>m</sub></span> <span class="main">(</span>eigen_projector <span class="free">A</span> <span class="skolem">a</span> <span class="main">*</span> <span class="free">B</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">a</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>m</sub></span> eigen_projector <span class="free">A</span> <span class="skolem">a</span> <span class="main">*</span> <span class="free">B</span>"</span></span> 
          <span class="keyword1"><span class="command">using</span></span> mult_smult_assoc_mat<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
          <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹<span class="main">⋀</span><span class="bound">nr</span> <span class="bound">nc</span> <span class="bound">n</span> <span class="bound">k</span> <span class="bound">B</span> <span class="bound">A</span><span class="main">.</span> <span class="main">⟦</span><span class="bound">A</span> <span class="main">∈</span> carrier_mat <span class="bound">nr</span> <span class="bound">n</span><span class="main">;</span> <span class="bound">B</span> <span class="main">∈</span> carrier_mat <span class="bound">n</span> <span class="bound">nc</span><span class="main">⟧</span> <span class="main">⟹</span> 
              <span class="bound">k</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>m</sub></span> <span class="main">(</span><span class="bound">A</span> <span class="main">*</span> <span class="bound">B</span><span class="main">)</span> <span class="main">=</span> <span class="bound">k</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>m</sub></span> <span class="bound">A</span> <span class="main">*</span> <span class="bound">B</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">a</span> <span class="main">∈</span> spectrum <span class="free">A</span>›</span></span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> dim_eq 
                fc_mats_carrier eigen_projector_carrier<span class="main">)</span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="skolem">a</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>m</sub></span> eigen_projector <span class="free">A</span> <span class="skolem">a</span> <span class="main">*</span> <span class="main">(</span><span class="free">B</span> <span class="main">*</span> <span class="free">R</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹<span class="skolem">a</span> <span class="main">∈</span> spectrum <span class="free">A</span>›</span></span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> assoc_mult_mat 
            cpx_sq_mat_smult dim_eq fc_mats_carrier eigen_projector_carrier<span class="main">)</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">*</span>  <span class="main">(</span><span class="main">∑</span> <span class="bound">b</span> <span class="main">∈</span> spectrum <span class="free">B</span><span class="main">.</span> <span class="main">(</span><span class="bound">b</span> <span class="main">*</span> 
      Complex_Matrix.trace<span class="main">(</span>eigen_projector <span class="free">A</span> <span class="skolem">a</span> <span class="main">*</span> <span class="main">(</span>eigen_projector <span class="free">B</span> <span class="bound">b</span><span class="main">)</span> <span class="main">*</span> <span class="free">R</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
      Complex_Matrix.trace <span class="main">(</span><span class="skolem">a</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>m</sub></span> eigen_projector <span class="free">A</span> <span class="skolem">a</span> <span class="main">*</span> <span class="main">(</span><span class="free">B</span> <span class="main">*</span> <span class="free">R</span><span class="main">)</span><span class="main">)</span>"</span></span>  <span class="keyword1"><span class="command">.</span></span> 
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> Complex_Matrix.trace <span class="main">(</span><span class="free">A</span> <span class="main">*</span> <span class="main">(</span><span class="free">B</span> <span class="main">*</span> <span class="free">R</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> sum_eigen_projector_trace_right<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">A</span></span> <span class="quoted"><span class="quoted">"<span class="free">B</span> <span class="main">*</span> <span class="free">R</span>"</span></span><span class="main">]</span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cpx_sq_mat_mult<span class="main">)</span> 
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> Complex_Matrix.trace <span class="main">(</span><span class="free">A</span> <span class="main">*</span> <span class="free">B</span> <span class="main">*</span> <span class="free">R</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">*</span> <span class="main">(</span><span class="free">B</span> <span class="main">*</span> <span class="free">R</span><span class="main">)</span> <span class="main">=</span> <span class="free">A</span> <span class="main">*</span> <span class="free">B</span> <span class="main">*</span> <span class="free">R</span>"</span></span> 
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> assoc_mult_mat<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span><span class="main">∈</span>  carrier_mat <span class="free">dimR</span> <span class="free">dimR</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms fc_mats_carrier dim_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">B</span><span class="main">∈</span>  carrier_mat <span class="free">dimR</span> <span class="free">dimR</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms fc_mats_carrier dim_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">R</span><span class="main">∈</span>  carrier_mat <span class="free">dimR</span> <span class="free">dimR</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms fc_mats_carrier dim_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We obtain the main result of this part, which relates the quantum expectation value of a 
joint measurement with an expectation.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> cpx_sq_mat<span class="main">)</span> sum_qt_expect<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"lhv <span class="free">M</span> <span class="free">A</span> <span class="free">B</span> <span class="free">R</span> <span class="free">XA</span> <span class="free">XB</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span><span class="main">∈</span> <span class="free">fc_mats</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">B</span><span class="main">∈</span> <span class="free">fc_mats</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">R</span><span class="main">∈</span> <span class="free">fc_mats</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"hermitian <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"hermitian <span class="free">B</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">integral<span class="hidden">⇧</span><sup>L</sup></span> <span class="free">M</span> <span class="main">(</span><span class="main">λ</span><span class="bound">w</span><span class="main">.</span> <span class="main">(</span>qt_expect <span class="free">A</span> <span class="free">XA</span> <span class="bound">w</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span>qt_expect <span class="free">B</span> <span class="free">XB</span> <span class="bound">w</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
    Re <span class="main">(</span>Complex_Matrix.trace<span class="main">(</span><span class="free">A</span> <span class="main">*</span> <span class="free">B</span> <span class="main">*</span> <span class="free">R</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> br<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">b</span> <span class="main">∈</span> spectrum <span class="free">B</span><span class="main">.</span> <span class="bound">b</span><span class="main">∈</span> Reals"</span></span> <span class="keyword1"><span class="command">using</span></span> assms hermitian_spectrum_real<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">B</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> ar<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">a</span> <span class="main">∈</span> spectrum <span class="free">A</span><span class="main">.</span> <span class="bound">a</span><span class="main">∈</span> Reals"</span></span> <span class="keyword1"><span class="command">using</span></span> hermitian_spectrum_real<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">A</span></span><span class="main">]</span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">integral<span class="hidden">⇧</span><sup>L</sup></span> <span class="free">M</span> <span class="main">(</span><span class="main">λ</span><span class="bound">w</span><span class="main">.</span> <span class="main">(</span><span class="main">∑</span> <span class="bound">a</span> <span class="main">∈</span> spectrum <span class="free">A</span><span class="main">.</span> Re <span class="bound">a</span><span class="main">*</span> <span class="free">XA</span> <span class="bound">a</span> <span class="bound">w</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">∑</span> <span class="bound">b</span> <span class="main">∈</span> spectrum <span class="free">B</span><span class="main">.</span> Re <span class="bound">b</span> <span class="main">*</span><span class="free">XB</span> <span class="bound">b</span> <span class="bound">w</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
    <span class="main">(</span><span class="main">∑</span> <span class="bound">a</span> <span class="main">∈</span> spectrum <span class="free">A</span><span class="main">.</span> Re <span class="bound">a</span> <span class="main">*</span> <span class="main">(</span><span class="main">∑</span> <span class="bound">b</span> <span class="main">∈</span> spectrum <span class="free">B</span><span class="main">.</span> Re <span class="bound">b</span> <span class="main">*</span> <span class="keyword1">integral<span class="hidden">⇧</span><sup>L</sup></span> <span class="free">M</span> <span class="main">(</span><span class="main">λ</span><span class="bound">w</span><span class="main">.</span> <span class="free">XA</span> <span class="bound">a</span> <span class="bound">w</span> <span class="main">*</span> <span class="free">XB</span> <span class="bound">b</span> <span class="bound">w</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> lhv_sum_integral'<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">M</span></span><span class="main">]</span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span> <span class="bound">a</span> <span class="main">∈</span> spectrum <span class="free">A</span><span class="main">.</span> Re <span class="bound">a</span> <span class="main">*</span> <span class="main">(</span><span class="main">∑</span> <span class="bound">b</span> <span class="main">∈</span> spectrum <span class="free">B</span><span class="main">.</span> Re <span class="bound">b</span> <span class="main">*</span> 
    Re <span class="main">(</span>Complex_Matrix.trace<span class="main">(</span>eigen_projector <span class="free">A</span> <span class="bound">a</span> <span class="main">*</span> <span class="main">(</span>eigen_projector <span class="free">B</span> <span class="bound">b</span><span class="main">)</span> <span class="main">*</span> <span class="free">R</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms sum_qt_expect_trace<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">M</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span> <span class="bound">a</span> <span class="main">∈</span> spectrum <span class="free">A</span><span class="main">.</span> Re <span class="bound">a</span> <span class="main">*</span> Re <span class="main">(</span><span class="main">∑</span> <span class="bound">b</span> <span class="main">∈</span> spectrum <span class="free">B</span><span class="main">.</span> <span class="main">(</span><span class="bound">b</span> <span class="main">*</span> 
    Complex_Matrix.trace<span class="main">(</span>eigen_projector <span class="free">A</span> <span class="bound">a</span> <span class="main">*</span> <span class="main">(</span>eigen_projector <span class="free">B</span> <span class="bound">b</span><span class="main">)</span> <span class="main">*</span> <span class="free">R</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> sum.cong<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span> 
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span><span class="main">∈</span> spectrum <span class="free">A</span>"</span></span> 
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">b</span><span class="main">∈</span>spectrum <span class="free">B</span><span class="main">.</span> Re <span class="bound">b</span> <span class="main">*</span> 
      Re <span class="main">(</span>Complex_Matrix.trace <span class="main">(</span>eigen_projector <span class="free">A</span> <span class="skolem">a</span> <span class="main">*</span> eigen_projector <span class="free">B</span> <span class="bound">b</span> <span class="main">*</span> <span class="free">R</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
      <span class="main">(</span><span class="main">∑</span> <span class="bound">b</span> <span class="main">∈</span> spectrum <span class="free">B</span><span class="main">.</span> Re <span class="main">(</span><span class="bound">b</span> <span class="main">*</span> 
      Complex_Matrix.trace<span class="main">(</span>eigen_projector <span class="free">A</span> <span class="skolem">a</span> <span class="main">*</span> <span class="main">(</span>eigen_projector <span class="free">B</span> <span class="bound">b</span><span class="main">)</span> <span class="main">*</span> <span class="free">R</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> sum.cong<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">b</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span><span class="main">∈</span> spectrum <span class="free">B</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span><span class="main">∈</span> Reals"</span></span> <span class="keyword1"><span class="command">using</span></span> hermitian_spectrum_real<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">B</span></span><span class="main">]</span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"Re <span class="skolem">b</span> <span class="main">=</span> <span class="skolem">b</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"Re <span class="skolem">b</span> <span class="main">*</span> Re <span class="main">(</span>Complex_Matrix.trace <span class="main">(</span>eigen_projector <span class="free">A</span> <span class="skolem">a</span> <span class="main">*</span> eigen_projector <span class="free">B</span> <span class="skolem">b</span> <span class="main">*</span> <span class="free">R</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
         Re <span class="main">(</span><span class="skolem">b</span> <span class="main">*</span> Complex_Matrix.trace <span class="main">(</span>eigen_projector <span class="free">A</span> <span class="skolem">a</span> <span class="main">*</span> eigen_projector <span class="free">B</span> <span class="skolem">b</span> <span class="main">*</span> <span class="free">R</span><span class="main">)</span><span class="main">)</span>"</span></span> 
        <span class="keyword1"><span class="command">using</span></span> hermitian_spectrum_real <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">b</span> <span class="main">∈</span> <span class="main">ℝ</span>›</span></span> mult_real_cpx <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> 
      Re <span class="main">(</span><span class="main">∑</span> <span class="bound">b</span> <span class="main">∈</span> spectrum <span class="free">B</span><span class="main">.</span> <span class="bound">b</span> <span class="main">*</span> 
        Complex_Matrix.trace<span class="main">(</span>eigen_projector <span class="free">A</span> <span class="skolem">a</span> <span class="main">*</span> <span class="main">(</span>eigen_projector <span class="free">B</span> <span class="bound">b</span><span class="main">)</span> <span class="main">*</span> <span class="free">R</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">b</span><span class="main">∈</span>spectrum <span class="free">B</span><span class="main">.</span> Re <span class="bound">b</span> <span class="main">*</span> 
      Re <span class="main">(</span>Complex_Matrix.trace <span class="main">(</span>eigen_projector <span class="free">A</span> <span class="skolem">a</span> <span class="main">*</span> eigen_projector <span class="free">B</span> <span class="bound">b</span> <span class="main">*</span> <span class="free">R</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
      Re <span class="main">(</span><span class="main">∑</span> <span class="bound">b</span> <span class="main">∈</span> spectrum <span class="free">B</span><span class="main">.</span> <span class="bound">b</span> <span class="main">*</span> 
        Complex_Matrix.trace<span class="main">(</span>eigen_projector <span class="free">A</span> <span class="skolem">a</span> <span class="main">*</span> <span class="main">(</span>eigen_projector <span class="free">B</span> <span class="bound">b</span><span class="main">)</span> <span class="main">*</span> <span class="free">R</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"Re <span class="skolem">a</span> <span class="main">*</span> <span class="main">(</span><span class="main">∑</span><span class="bound">b</span><span class="main">∈</span>spectrum <span class="free">B</span><span class="main">.</span> Re <span class="bound">b</span> <span class="main">*</span> 
      Re <span class="main">(</span>Complex_Matrix.trace <span class="main">(</span>eigen_projector <span class="free">A</span> <span class="skolem">a</span> <span class="main">*</span> eigen_projector <span class="free">B</span> <span class="bound">b</span> <span class="main">*</span> <span class="free">R</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
         Re <span class="skolem">a</span> <span class="main">*</span> Re <span class="main">(</span><span class="main">∑</span><span class="bound">b</span><span class="main">∈</span>spectrum <span class="free">B</span><span class="main">.</span>  
          <span class="main">(</span><span class="bound">b</span> <span class="main">*</span> Complex_Matrix.trace <span class="main">(</span>eigen_projector <span class="free">A</span> <span class="skolem">a</span> <span class="main">*</span> eigen_projector <span class="free">B</span> <span class="bound">b</span> <span class="main">*</span> <span class="free">R</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span>  <span class="main">(</span><span class="main">∑</span> <span class="bound">a</span> <span class="main">∈</span> spectrum <span class="free">A</span><span class="main">.</span> Re <span class="main">(</span><span class="bound">a</span> <span class="main">*</span> <span class="main">(</span><span class="main">∑</span> <span class="bound">b</span> <span class="main">∈</span> spectrum <span class="free">B</span><span class="main">.</span> <span class="main">(</span><span class="bound">b</span> <span class="main">*</span> 
    Complex_Matrix.trace<span class="main">(</span>eigen_projector <span class="free">A</span> <span class="bound">a</span> <span class="main">*</span> <span class="main">(</span>eigen_projector <span class="free">B</span> <span class="bound">b</span><span class="main">)</span> <span class="main">*</span> <span class="free">R</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> sum.cong<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span><span class="main">∈</span> spectrum <span class="free">A</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"Re <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ar <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"Re <span class="skolem">x</span> <span class="main">*</span> Re <span class="main">(</span><span class="main">∑</span><span class="bound">b</span><span class="main">∈</span>spectrum <span class="free">B</span><span class="main">.</span> <span class="bound">b</span> <span class="main">*</span> 
      Complex_Matrix.trace <span class="main">(</span>eigen_projector <span class="free">A</span> <span class="skolem">x</span> <span class="main">*</span> eigen_projector <span class="free">B</span> <span class="bound">b</span> <span class="main">*</span> <span class="free">R</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
         Re <span class="main">(</span><span class="skolem">x</span> <span class="main">*</span> <span class="main">(</span><span class="main">∑</span><span class="bound">b</span><span class="main">∈</span>spectrum <span class="free">B</span><span class="main">.</span> <span class="bound">b</span> <span class="main">*</span> 
        Complex_Matrix.trace <span class="main">(</span>eigen_projector <span class="free">A</span> <span class="skolem">x</span> <span class="main">*</span> eigen_projector <span class="free">B</span> <span class="bound">b</span> <span class="main">*</span> <span class="free">R</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> spectrum <span class="free">A</span>›</span></span> ar mult_real_cpx <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> Re <span class="main">(</span><span class="main">∑</span> <span class="bound">a</span> <span class="main">∈</span> spectrum <span class="free">A</span><span class="main">.</span>  <span class="bound">a</span> <span class="main">*</span>  <span class="main">(</span><span class="main">∑</span> <span class="bound">b</span> <span class="main">∈</span> spectrum <span class="free">B</span><span class="main">.</span> <span class="main">(</span><span class="bound">b</span> <span class="main">*</span> 
    Complex_Matrix.trace<span class="main">(</span>eigen_projector <span class="free">A</span> <span class="bound">a</span> <span class="main">*</span> <span class="main">(</span>eigen_projector <span class="free">B</span> <span class="bound">b</span><span class="main">)</span> <span class="main">*</span> <span class="free">R</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> Re <span class="main">(</span>Complex_Matrix.trace<span class="main">(</span><span class="free">A</span> <span class="main">*</span><span class="free">B</span> <span class="main">*</span> <span class="free">R</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms 
    sum_eigen_projector_trace<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">A</span></span> <span class="quoted"><span class="free">B</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> qt_expect_def <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Properties of specific observables›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹In this part we consider a specific density operator and specific observables corresponding 
to joint bipartite measurements. We will compute the quantum expectation value of this system and 
prove that it violates the CHSH inequality, thus proving that the local hidden variable assumption 
cannot hold.›</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Ket 0, Ket 1 and the corresponding projectors›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">ket_0</span><span class="main">::</span><span class="quoted"><span class="quoted">"complex Matrix.vec"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">ket_0</span> <span class="main">=</span> unit_vec <span class="numeral">2</span> <span class="main">0</span>"</span></span>

<span class="keyword1" id="CHSH_Inequality-ket_0_dim"><span class="command">lemma</span></span> ket_0_dim<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"dim_vec ket_0 <span class="main">=</span> <span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> ket_0_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="CHSH_Inequality-ket_0_norm"><span class="command">lemma</span></span> ket_0_norm<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∥</span>ket_0<span class="main">∥</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> unit_cpx_vec_length <span class="keyword1"><span class="command">unfolding</span></span> ket_0_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="CHSH_Inequality-ket_0_mat"><span class="command">lemma</span></span> ket_0_mat<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"ket_vec ket_0 <span class="main">=</span>  Matrix.mat_of_cols_list <span class="numeral">2</span> <span class="main">[</span><span class="main">[</span><span class="main">1</span><span class="main">,</span> <span class="main">0</span><span class="main">]</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ket_vec_def Matrix.mat_of_cols_list_def ket_0_def<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">ket_1</span><span class="main">::</span><span class="quoted"><span class="quoted">"complex Matrix.vec"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">ket_1</span> <span class="main">=</span> unit_vec <span class="numeral">2</span> <span class="main">1</span>"</span></span>

<span class="keyword1" id="CHSH_Inequality-ket_1_dim"><span class="command">lemma</span></span> ket_1_dim<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"dim_vec ket_1 <span class="main">=</span> <span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> ket_1_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="CHSH_Inequality-ket_1_norm"><span class="command">lemma</span></span> ket_1_norm<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∥</span>ket_1<span class="main">∥</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> unit_cpx_vec_length <span class="keyword1"><span class="command">unfolding</span></span> ket_1_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">ket_01</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">ket_01</span> <span class="main">=</span> tensor_vec ket_0 ket_1"</span></span>

<span class="keyword1" id="CHSH_Inequality-ket_01_dim"><span class="command">lemma</span></span> ket_01_dim<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"dim_vec ket_01 <span class="main">=</span> <span class="numeral">4</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> ket_01_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ket_0_dim ket_1_dim<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span>  <span class="entity">ket_10</span> 
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">ket_10</span> <span class="main">=</span> tensor_vec ket_1 ket_0"</span></span>

<span class="keyword1" id="CHSH_Inequality-ket_10_dim"><span class="command">lemma</span></span> ket_10_dim<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"dim_vec ket_10 <span class="main">=</span> <span class="numeral">4</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> ket_10_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ket_0_dim ket_1_dim<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We define \verb+ket_psim+, one of the Bell states (or EPR pair).›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">ket_psim</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">ket_psim</span> <span class="main">=</span> <span class="main">1</span><span class="main">/</span><span class="main">(</span>sqrt <span class="numeral">2</span><span class="main">)</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="main">(</span>ket_01 <span class="main">-</span> ket_10<span class="main">)</span>"</span></span>

<span class="keyword1" id="CHSH_Inequality-ket_psim_dim"><span class="command">lemma</span></span>  ket_psim_dim<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"dim_vec ket_psim <span class="main">=</span> <span class="numeral">4</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ket_01_dim ket_10_dim <span class="keyword1"><span class="command">unfolding</span></span> ket_psim_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="CHSH_Inequality-ket_psim_norm"><span class="command">lemma</span></span> ket_psim_norm<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∥</span>ket_psim<span class="main">∥</span> <span class="main">=</span> <span class="main">1</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"dim_vec ket_psim <span class="main">=</span> <span class="numeral">2</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> ket_psim_def ket_01_def ket_10_def ket_0_def ket_1_def 
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">&lt;</span><span class="numeral">4</span><span class="main">.</span> <span class="main">(</span>cmod <span class="main">(</span>vec_index ket_psim <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ket_psim_def ket_01_def ket_10_def ket_0_def ket_1_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sum_4_elems<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cpx_vec_length_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹\verb+rho_psim+ represents the density operator associated with the quantum 
state \verb+ket_psim+.›</span></span>

<span class="keyword1"><span class="command">definition</span></span>  <span class="entity">rho_psim</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">rho_psim</span> <span class="main">=</span> rank_1_proj ket_psim"</span></span>

<span class="keyword1" id="CHSH_Inequality-rho_psim_carrier"><span class="command">lemma</span></span> rho_psim_carrier<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"rho_psim <span class="main">∈</span> carrier_mat <span class="numeral">4</span> <span class="numeral">4</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> rank_1_proj_carrier<span class="main">[</span><span class="operator">of</span> <span class="quoted">ket_psim</span><span class="main">]</span> ket_psim_dim  
    rho_psim_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="CHSH_Inequality-rho_psim_dim_row"><span class="command">lemma</span></span>  rho_psim_dim_row<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"dim_row rho_psim <span class="main">=</span> <span class="numeral">4</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> rho_psim_carrier <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="CHSH_Inequality-rho_psim_density"><span class="command">lemma</span></span> rho_psim_density<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"density_operator rho_psim"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> density_operator_def
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Complex_Matrix.positive rho_psim"</span></span> <span class="keyword1"><span class="command">using</span></span> rank_1_proj_positive<span class="main">[</span><span class="operator">of</span> <span class="quoted">ket_psim</span><span class="main">]</span> ket_psim_norm 
      rho_psim_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Complex_Matrix.trace rho_psim <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> rank_1_proj_trace<span class="main">[</span><span class="operator">of</span> <span class="quoted">ket_psim</span><span class="main">]</span> ket_psim_norm 
      rho_psim_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹The X and Z matrices and two of their combinations›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹In this part we prove properties of two standard matrices in quantum theory, $X$ and $Z$, 
as well as two of their combinations: $\frac{X+Z}{\sqrt{2}}$ and $\frac{Z - X}{\sqrt{2}}$. 
Note that all of these matrices are observables, they will be used to violate the CHSH inequality.›</span></span>

<span class="keyword1" id="CHSH_Inequality-Z_carrier"><span class="command">lemma</span></span> Z_carrier<span class="main">:</span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Z <span class="main">∈</span> carrier_mat <span class="numeral">2</span> <span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> Z_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="CHSH_Inequality-Z_hermitian"><span class="command">lemma</span></span> Z_hermitian<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"hermitian Z"</span></span> <span class="keyword1"><span class="command">using</span></span> dagger_adjoint dagger_of_Z <span class="keyword1"><span class="command">unfolding</span></span>  hermitian_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="CHSH_Inequality-unitary_Z"><span class="command">lemma</span></span> unitary_Z<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Complex_Matrix.unitary Z"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Complex_Matrix.adjoint Z <span class="main">*</span> Z <span class="main">=</span> <span class="main">(</span><span class="keyword1">1<span class="hidden">⇩</span><sub>m</sub></span> <span class="numeral">2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> dagger_adjoint<span class="main">[</span><span class="operator">of</span> <span class="quoted">Z</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> unitary_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Complex_Matrix.adjoint_adjoint Complex_Matrix.unitary_def Z_carrier adjoint_dim 
        carrier_matD<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> inverts_mat_def unitary_adjoint<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="CHSH_Inequality-X_carrier"><span class="command">lemma</span></span> X_carrier<span class="main">:</span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"X <span class="main">∈</span> carrier_mat <span class="numeral">2</span> <span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> X_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="CHSH_Inequality-X_hermitian"><span class="command">lemma</span></span> X_hermitian<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"hermitian X"</span></span> <span class="keyword1"><span class="command">using</span></span> dagger_adjoint dagger_of_X <span class="keyword1"><span class="command">unfolding</span></span>  hermitian_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="CHSH_Inequality-unitary_X"><span class="command">lemma</span></span> unitary_X<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Complex_Matrix.unitary X"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Complex_Matrix.adjoint X <span class="main">*</span> X <span class="main">=</span> <span class="main">(</span><span class="keyword1">1<span class="hidden">⇩</span><sub>m</sub></span> <span class="numeral">2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> dagger_adjoint<span class="main">[</span><span class="operator">of</span> <span class="quoted">X</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> unitary_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Complex_Matrix.adjoint_adjoint Complex_Matrix.unitary_def X_carrier adjoint_dim 
        carrier_matD<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> inverts_mat_def unitary_adjoint<span class="main">)</span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">XpZ</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">XpZ</span> <span class="main">=</span> <span class="main">-</span><span class="main">1</span><span class="main">/</span>sqrt<span class="main">(</span><span class="numeral">2</span><span class="main">)</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>m</sub></span> <span class="main">(</span>X <span class="main">+</span> Z<span class="main">)</span>"</span></span>

<span class="keyword1" id="CHSH_Inequality-XpZ_carrier"><span class="command">lemma</span></span> XpZ_carrier<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"XpZ <span class="main">∈</span> carrier_mat <span class="numeral">2</span> <span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> XpZ_def X_def Z_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="CHSH_Inequality-XpZ_hermitian"><span class="command">lemma</span></span> XpZ_hermitian<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"hermitian XpZ"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"X <span class="main">+</span> Z <span class="main">∈</span> carrier_mat <span class="numeral">2</span> <span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Z_carrier X_carrier <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"hermitian <span class="main">(</span>X <span class="main">+</span> Z<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> X_hermitian Z_hermitian hermitian_add Matrix.mat_carrier
    <span class="keyword1"><span class="command">unfolding</span></span> X_def Z_def  <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> hermitian_smult<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"X <span class="main">+</span> Z"</span></span> <span class="quoted"><span class="numeral">2</span></span> <span class="quoted"><span class="quoted">"<span class="main">-</span> <span class="main">1</span> <span class="main">/</span> sqrt <span class="numeral">2</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> XpZ_def  
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="CHSH_Inequality-XpZ_inv"><span class="command">lemma</span></span> XpZ_inv<span class="main">:</span>
  <span class="quoted"><span class="quoted">"XpZ <span class="main">*</span> XpZ <span class="main">=</span> <span class="keyword1">1<span class="hidden">⇩</span><sub>m</sub></span> <span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> XpZ_def X_def Z_def times_mat_def one_mat_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> cong_mat<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Matrix.scalar_prod_def<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Gates.csqrt_2_sq<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="CHSH_Inequality-unitary_XpZ"><span class="command">lemma</span></span> unitary_XpZ<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Complex_Matrix.unitary XpZ"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Complex_Matrix.adjoint XpZ <span class="main">*</span> XpZ <span class="main">=</span> <span class="main">(</span><span class="keyword1">1<span class="hidden">⇩</span><sub>m</sub></span> <span class="numeral">2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> XpZ_inv XpZ_hermitian 
    <span class="keyword1"><span class="command">unfolding</span></span> hermitian_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> unitary_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Complex_Matrix.adjoint_adjoint Complex_Matrix.unitary_def XpZ_carrier adjoint_dim 
        carrier_matD<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> inverts_mat_def unitary_adjoint<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">ZmX</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">ZmX</span> <span class="main">=</span> <span class="main">1</span><span class="main">/</span>sqrt<span class="main">(</span><span class="numeral">2</span><span class="main">)</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>m</sub></span> <span class="main">(</span>Z <span class="main">-</span> X<span class="main">)</span>"</span></span>

<span class="keyword1" id="CHSH_Inequality-ZmX_carrier"><span class="command">lemma</span></span> ZmX_carrier<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"ZmX <span class="main">∈</span> carrier_mat <span class="numeral">2</span> <span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> ZmX_def X_def Z_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> minus_carrier_mat'<span class="main">)</span>

<span class="keyword1" id="CHSH_Inequality-ZmX_hermitian"><span class="command">lemma</span></span> ZmX_hermitian<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"hermitian ZmX"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Z <span class="main">-</span> X <span class="main">∈</span> carrier_mat <span class="numeral">2</span> <span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> X_def Z_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> minus_carrier_mat<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"hermitian <span class="main">(</span>Z <span class="main">-</span> X<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> X_hermitian Z_hermitian hermitian_minus Matrix.mat_carrier
    <span class="keyword1"><span class="command">unfolding</span></span> X_def Z_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> hermitian_smult<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"Z <span class="main">-</span> X"</span></span> <span class="quoted"><span class="numeral">2</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">/</span> sqrt <span class="numeral">2</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> ZmX_def  
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="CHSH_Inequality-ZmX_inv"><span class="command">lemma</span></span> ZmX_inv<span class="main">:</span>
  <span class="quoted"><span class="quoted">"ZmX <span class="main">*</span> ZmX <span class="main">=</span> <span class="keyword1">1<span class="hidden">⇩</span><sub>m</sub></span> <span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> ZmX_def X_def Z_def times_mat_def one_mat_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> cong_mat<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Matrix.scalar_prod_def<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Gates.csqrt_2_sq<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="CHSH_Inequality-unitary_ZmX"><span class="command">lemma</span></span> unitary_ZmX<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Complex_Matrix.unitary ZmX"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Complex_Matrix.adjoint ZmX <span class="main">*</span> ZmX <span class="main">=</span> <span class="main">(</span><span class="keyword1">1<span class="hidden">⇩</span><sub>m</sub></span> <span class="numeral">2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ZmX_inv ZmX_hermitian 
    <span class="keyword1"><span class="command">unfolding</span></span> hermitian_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> unitary_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Complex_Matrix.adjoint_adjoint Complex_Matrix.unitary_def ZmX_carrier adjoint_dim 
        carrier_matD<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> inverts_mat_def unitary_adjoint<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">definition</span></span>  <span class="entity">Z_XpZ</span> 
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">Z_XpZ</span> <span class="main">=</span> tensor_mat Z XpZ"</span></span>

<span class="keyword1" id="CHSH_Inequality-Z_XpZ_carrier"><span class="command">lemma</span></span> Z_XpZ_carrier<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Z_XpZ <span class="main">∈</span> carrier_mat <span class="numeral">4</span> <span class="numeral">4</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> Z_XpZ_def <span class="keyword1"><span class="command">using</span></span> tensor_mat_carrier XpZ_carrier 
    Z_carrier <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">X_XpZ</span> 
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">X_XpZ</span> <span class="main">=</span> tensor_mat X XpZ"</span></span>

<span class="keyword1" id="CHSH_Inequality-X_XpZ_carrier"><span class="command">lemma</span></span> X_XpZ_carrier<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"X_XpZ <span class="main">∈</span> carrier_mat <span class="numeral">4</span> <span class="numeral">4</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> tensor_mat_carrier XpZ_carrier X_carrier 
  <span class="keyword1"><span class="command">unfolding</span></span> X_XpZ_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">Z_ZmX</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">Z_ZmX</span> <span class="main">=</span> tensor_mat Z ZmX"</span></span>

<span class="keyword1" id="CHSH_Inequality-Z_ZmX_carrier"><span class="command">lemma</span></span> Z_ZmX_carrier<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Z_ZmX <span class="main">∈</span> carrier_mat <span class="numeral">4</span> <span class="numeral">4</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> tensor_mat_carrier ZmX_carrier Z_carrier 
  <span class="keyword1"><span class="command">unfolding</span></span> Z_ZmX_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">X_ZmX</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">X_ZmX</span> <span class="main">=</span> tensor_mat X ZmX"</span></span>

<span class="keyword1" id="CHSH_Inequality-X_ZmX_carrier"><span class="command">lemma</span></span> X_ZmX_carrier<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"X_ZmX <span class="main">∈</span> carrier_mat <span class="numeral">4</span> <span class="numeral">4</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> tensor_mat_carrier X_carrier ZmX_carrier
  <span class="keyword1"><span class="command">unfolding</span></span> X_ZmX_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="CHSH_Inequality-X_ZmX_rho_psim"><span class="command">lemma</span></span>  X_ZmX_rho_psim<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Complex_Matrix.trace <span class="main">(</span>rho_psim <span class="main">*</span> X_ZmX<span class="main">)</span> <span class="main">=</span> <span class="main">1</span><span class="main">/</span> <span class="main">(</span>sqrt <span class="numeral">2</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ket_10_def ket_1_def X_ZmX_def ZmX_def X_def ket_01_def
      Z_def rho_psim_def ket_psim_def rank_1_proj_def outer_prod_def ket_0_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Complex_Matrix.trace_def<span class="main">)</span>  
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sum_4_elems<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> csqrt_2_sq<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="CHSH_Inequality-Z_ZmX_rho_psim"><span class="command">lemma</span></span>  Z_ZmX_rho_psim<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Complex_Matrix.trace <span class="main">(</span>rho_psim <span class="main">*</span> Z_ZmX<span class="main">)</span> <span class="main">=</span> <span class="main">-</span><span class="main">1</span><span class="main">/</span> <span class="main">(</span>sqrt <span class="numeral">2</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rho_psim_def ket_psim_def ket_10_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Z_ZmX_def Z_def ZmX_def X_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rank_1_proj_def outer_prod_def ket_01_def ket_1_def ket_0_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Complex_Matrix.trace_def sum_4_elems<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> csqrt_2_sq<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="CHSH_Inequality-X_XpZ_rho_psim"><span class="command">lemma</span></span> X_XpZ_rho_psim<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Complex_Matrix.trace <span class="main">(</span>rho_psim <span class="main">*</span> X_XpZ<span class="main">)</span> <span class="main">=</span><span class="main">1</span><span class="main">/</span> <span class="main">(</span>sqrt <span class="numeral">2</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rho_psim_def ket_psim_def ket_10_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> X_XpZ_def Z_def XpZ_def X_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rank_1_proj_def outer_prod_def ket_01_def ket_1_def ket_0_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Complex_Matrix.trace_def sum_4_elems<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> csqrt_2_sq<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="CHSH_Inequality-Z_XpZ_rho_psim"><span class="command">lemma</span></span> Z_XpZ_rho_psim<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Complex_Matrix.trace <span class="main">(</span>rho_psim <span class="main">*</span> Z_XpZ<span class="main">)</span> <span class="main">=</span><span class="main">1</span><span class="main">/</span> <span class="main">(</span>sqrt <span class="numeral">2</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rho_psim_def ket_psim_def ket_10_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Z_XpZ_def  XpZ_def X_def Z_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rank_1_proj_def outer_prod_def ket_01_def ket_1_def ket_0_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Complex_Matrix.trace_def sum_4_elems<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> csqrt_2_sq<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">Z_I</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">Z_I</span> <span class="main">=</span> tensor_mat Z <span class="main">(</span><span class="keyword1">1<span class="hidden">⇩</span><sub>m</sub></span> <span class="numeral">2</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="CHSH_Inequality-Z_I_carrier"><span class="command">lemma</span></span> Z_I_carrier<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Z_I <span class="main">∈</span> carrier_mat <span class="numeral">4</span> <span class="numeral">4</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> tensor_mat_carrier Z_carrier <span class="keyword1"><span class="command">unfolding</span></span> Z_I_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="CHSH_Inequality-Z_I_hermitian"><span class="command">lemma</span></span> Z_I_hermitian<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"hermitian Z_I"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> Z_I_def <span class="keyword1"><span class="command">using</span></span> tensor_mat_hermitian<span class="main">[</span><span class="operator">of</span> <span class="quoted">Z</span> <span class="quoted"><span class="numeral">2</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">1<span class="hidden">⇩</span><sub>m</sub></span> <span class="numeral">2</span>"</span></span> <span class="quoted"><span class="numeral">2</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Z_carrier Z_hermitian hermitian_one<span class="main">)</span>

<span class="keyword1" id="CHSH_Inequality-Z_I_unitary"><span class="command">lemma</span></span>  Z_I_unitary<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"unitary Z_I"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> Z_I_def <span class="keyword1"><span class="command">using</span></span> tensor_mat_unitary<span class="main">[</span><span class="operator">of</span> <span class="quoted">Z</span> <span class="quoted"><span class="quoted">"<span class="keyword1">1<span class="hidden">⇩</span><sub>m</sub></span> <span class="numeral">2</span>"</span></span><span class="main">]</span> Z_carrier unitary_Z
  <span class="keyword1"><span class="command">using</span></span> unitary_one <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="CHSH_Inequality-Z_I_spectrum"><span class="command">lemma</span></span> Z_I_spectrum<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span>Re <span class="bound">x</span> <span class="main">|</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> spectrum Z_I<span class="main">}</span> <span class="main">⊆</span> <span class="main">{</span><span class="main">-</span> <span class="main">1</span><span class="main">,</span> <span class="main">1</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> unitary_hermitian_Re_spectrum Z_I_hermitian
    Z_I_unitary Z_I_carrier <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">X_I</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">X_I</span> <span class="main">=</span> tensor_mat X <span class="main">(</span><span class="keyword1">1<span class="hidden">⇩</span><sub>m</sub></span> <span class="numeral">2</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="CHSH_Inequality-X_I_carrier"><span class="command">lemma</span></span>  X_I_carrier<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"X_I <span class="main">∈</span> carrier_mat <span class="numeral">4</span> <span class="numeral">4</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> tensor_mat_carrier X_carrier <span class="keyword1"><span class="command">unfolding</span></span> X_I_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="CHSH_Inequality-X_I_hermitian"><span class="command">lemma</span></span> X_I_hermitian<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"hermitian X_I"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> X_I_def <span class="keyword1"><span class="command">using</span></span> tensor_mat_hermitian<span class="main">[</span><span class="operator">of</span> <span class="quoted">X</span> <span class="quoted"><span class="numeral">2</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">1<span class="hidden">⇩</span><sub>m</sub></span> <span class="numeral">2</span>"</span></span> <span class="quoted"><span class="numeral">2</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> X_carrier X_hermitian hermitian_one<span class="main">)</span>

<span class="keyword1" id="CHSH_Inequality-X_I_unitary"><span class="command">lemma</span></span> X_I_unitary<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"unitary X_I"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> X_I_def <span class="keyword1"><span class="command">using</span></span> tensor_mat_unitary<span class="main">[</span><span class="operator">of</span> <span class="quoted">X</span> <span class="quoted"><span class="quoted">"<span class="keyword1">1<span class="hidden">⇩</span><sub>m</sub></span> <span class="numeral">2</span>"</span></span><span class="main">]</span> X_carrier unitary_X
  <span class="keyword1"><span class="command">using</span></span> unitary_one <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="CHSH_Inequality-X_I_spectrum"><span class="command">lemma</span></span>  X_I_spectrum<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span>Re <span class="bound">x</span> <span class="main">|</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> spectrum X_I<span class="main">}</span> <span class="main">⊆</span> <span class="main">{</span><span class="main">-</span> <span class="main">1</span><span class="main">,</span> <span class="main">1</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> unitary_hermitian_Re_spectrum X_I_hermitian
    X_I_unitary X_I_carrier <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">definition</span></span>  <span class="entity">I_XpZ</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">I_XpZ</span> <span class="main">=</span> tensor_mat <span class="main">(</span><span class="keyword1">1<span class="hidden">⇩</span><sub>m</sub></span> <span class="numeral">2</span><span class="main">)</span> XpZ"</span></span>

<span class="keyword1" id="CHSH_Inequality-I_XpZ_carrier"><span class="command">lemma</span></span>  I_XpZ_carrier<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"I_XpZ <span class="main">∈</span> carrier_mat <span class="numeral">4</span> <span class="numeral">4</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> tensor_mat_carrier XpZ_carrier <span class="keyword1"><span class="command">unfolding</span></span> I_XpZ_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="CHSH_Inequality-I_XpZ_hermitian"><span class="command">lemma</span></span>  I_XpZ_hermitian<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"hermitian I_XpZ"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> I_XpZ_def <span class="keyword1"><span class="command">using</span></span> tensor_mat_hermitian<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="keyword1">1<span class="hidden">⇩</span><sub>m</sub></span> <span class="numeral">2</span>"</span></span> <span class="quoted"><span class="numeral">2</span></span> <span class="quoted">XpZ</span> <span class="quoted"><span class="numeral">2</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> XpZ_carrier XpZ_hermitian hermitian_one<span class="main">)</span>

<span class="keyword1" id="CHSH_Inequality-I_XpZ_unitary"><span class="command">lemma</span></span> I_XpZ_unitary<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"unitary I_XpZ"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> I_XpZ_def <span class="keyword1"><span class="command">using</span></span> tensor_mat_unitary<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="keyword1">1<span class="hidden">⇩</span><sub>m</sub></span> <span class="numeral">2</span>"</span></span> <span class="quoted">XpZ</span><span class="main">]</span> XpZ_carrier 
    unitary_XpZ <span class="keyword1"><span class="command">using</span></span> unitary_one <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="CHSH_Inequality-I_XpZ_spectrum"><span class="command">lemma</span></span> I_XpZ_spectrum<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span>Re <span class="bound">x</span> <span class="main">|</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> spectrum I_XpZ<span class="main">}</span> <span class="main">⊆</span> <span class="main">{</span><span class="main">-</span> <span class="main">1</span><span class="main">,</span> <span class="main">1</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> unitary_hermitian_Re_spectrum 
    I_XpZ_hermitian I_XpZ_unitary I_XpZ_carrier <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">I_ZmX</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">I_ZmX</span> <span class="main">=</span> tensor_mat <span class="main">(</span><span class="keyword1">1<span class="hidden">⇩</span><sub>m</sub></span> <span class="numeral">2</span><span class="main">)</span> ZmX"</span></span>

<span class="keyword1" id="CHSH_Inequality-I_ZmX_carrier"><span class="command">lemma</span></span>  I_ZmX_carrier<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"I_ZmX <span class="main">∈</span> carrier_mat <span class="numeral">4</span> <span class="numeral">4</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> tensor_mat_carrier ZmX_carrier <span class="keyword1"><span class="command">unfolding</span></span> I_ZmX_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="CHSH_Inequality-I_ZmX_hermitian"><span class="command">lemma</span></span> I_ZmX_hermitian<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"hermitian I_ZmX"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> I_ZmX_def <span class="keyword1"><span class="command">using</span></span> tensor_mat_hermitian<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="keyword1">1<span class="hidden">⇩</span><sub>m</sub></span> <span class="numeral">2</span>"</span></span> <span class="quoted"><span class="numeral">2</span></span> <span class="quoted">ZmX</span> <span class="quoted"><span class="numeral">2</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ZmX_carrier ZmX_hermitian hermitian_one<span class="main">)</span>

<span class="keyword1" id="CHSH_Inequality-I_ZmX_unitary"><span class="command">lemma</span></span> I_ZmX_unitary<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"unitary I_ZmX"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> I_ZmX_def <span class="keyword1"><span class="command">using</span></span> tensor_mat_unitary<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="keyword1">1<span class="hidden">⇩</span><sub>m</sub></span> <span class="numeral">2</span>"</span></span> <span class="quoted">ZmX</span><span class="main">]</span> ZmX_carrier 
    unitary_ZmX <span class="keyword1"><span class="command">using</span></span> unitary_one <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="CHSH_Inequality-I_ZmX_spectrum"><span class="command">lemma</span></span> I_ZmX_spectrum<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span>Re <span class="bound">x</span> <span class="main">|</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> spectrum I_ZmX<span class="main">}</span> <span class="main">⊆</span> <span class="main">{</span><span class="main">-</span> <span class="main">1</span><span class="main">,</span> <span class="main">1</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> unitary_hermitian_Re_spectrum I_ZmX_hermitian
    I_ZmX_unitary I_ZmX_carrier <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="CHSH_Inequality-X_I_ZmX_eq"><span class="command">lemma</span></span> X_I_ZmX_eq<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"X_I <span class="main">*</span> I_ZmX <span class="main">=</span> X_ZmX"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> X_I_def I_ZmX_def X_ZmX_def <span class="keyword1"><span class="command">using</span></span> mult_distr_tensor
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> X_inv ZmX_inv index_mult_mat<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> index_mult_mat<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> index_one_mat<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> 
      index_one_mat<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> left_mult_one_mat' pos2 right_mult_one_mat'<span class="main">)</span>

<span class="keyword1" id="CHSH_Inequality-X_I_XpZ_eq"><span class="command">lemma</span></span> X_I_XpZ_eq<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"X_I <span class="main">*</span> I_XpZ <span class="main">=</span> X_XpZ"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> X_I_def I_XpZ_def X_XpZ_def <span class="keyword1"><span class="command">using</span></span> mult_distr_tensor
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> X_inv XpZ_inv index_mult_mat<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> index_mult_mat<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> index_one_mat<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> 
      index_one_mat<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> left_mult_one_mat' pos2 right_mult_one_mat'<span class="main">)</span>

<span class="keyword1" id="CHSH_Inequality-Z_I_XpZ_eq"><span class="command">lemma</span></span> Z_I_XpZ_eq<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Z_I <span class="main">*</span> I_XpZ <span class="main">=</span> Z_XpZ"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> Z_I_def I_XpZ_def Z_XpZ_def <span class="keyword1"><span class="command">using</span></span> mult_distr_tensor
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> Z_inv XpZ_inv index_mult_mat<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> index_mult_mat<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> index_one_mat<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> 
      index_one_mat<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> left_mult_one_mat' pos2 right_mult_one_mat'<span class="main">)</span>

<span class="keyword1" id="CHSH_Inequality-Z_I_ZmX_eq"><span class="command">lemma</span></span> Z_I_ZmX_eq<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Z_I <span class="main">*</span> I_ZmX <span class="main">=</span> Z_ZmX"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> Z_I_def I_ZmX_def Z_ZmX_def <span class="keyword1"><span class="command">using</span></span> mult_distr_tensor
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> Z_inv ZmX_inv index_mult_mat<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> index_mult_mat<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> index_one_mat<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> 
      index_one_mat<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> left_mult_one_mat' pos2 right_mult_one_mat'<span class="main">)</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹No local hidden variable›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We show that the local hidden variable hypothesis cannot hold by exhibiting a quantum 
expectation value that is greater than the upper-bound givven by the CHSH inequality.›</span></span>

<span class="keyword1"><span class="command">locale</span></span> bin_cpx <span class="main">=</span> cpx_sq_mat <span class="main">+</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> dim4<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">dimR</span> <span class="main">=</span> <span class="numeral">4</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> bin_cpx<span class="main">)</span> X_I_XpZ_trace<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"lhv <span class="free">M</span> X_I I_XpZ <span class="free">R</span> <span class="free">Vx</span> <span class="free">Vp</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">R</span><span class="main">∈</span> <span class="free">fc_mats</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">LINT</span> <span class="bound">w</span><span class="main">|</span><span class="free">M</span><span class="main">.</span> <span class="main">(</span>qt_expect X_I <span class="free">Vx</span> <span class="bound">w</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span>qt_expect I_XpZ  <span class="free">Vp</span> <span class="bound">w</span><span class="main">)</span> <span class="main">=</span>
  Re <span class="main">(</span>Complex_Matrix.trace <span class="main">(</span><span class="free">R</span> <span class="main">*</span> X_XpZ<span class="main">)</span><span class="main">)</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">LINT</span> <span class="bound">w</span><span class="main">|</span><span class="free">M</span><span class="main">.</span> <span class="main">(</span>qt_expect X_I <span class="free">Vx</span> <span class="bound">w</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span>qt_expect I_XpZ  <span class="free">Vp</span> <span class="bound">w</span><span class="main">)</span> <span class="main">=</span>
  Re <span class="main">(</span>Complex_Matrix.trace <span class="main">(</span>X_I <span class="main">*</span> I_XpZ <span class="main">*</span> <span class="free">R</span><span class="main">)</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> sum_qt_expect<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main">)</span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"X_I <span class="main">∈</span> <span class="free">fc_mats</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> X_I_carrier dim4  fc_mats_carrier dim_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">R</span><span class="main">∈</span> <span class="free">fc_mats</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"I_XpZ <span class="main">∈</span> <span class="free">fc_mats</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> I_XpZ_carrier dim4 fc_mats_carrier dim_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"hermitian X_I"</span></span> <span class="keyword1"><span class="command">using</span></span> X_I_hermitian <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"hermitian I_XpZ"</span></span> <span class="keyword1"><span class="command">using</span></span> I_XpZ_hermitian <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> Re <span class="main">(</span>Complex_Matrix.trace <span class="main">(</span>X_XpZ <span class="main">*</span> <span class="free">R</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> X_I_XpZ_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> Re <span class="main">(</span>Complex_Matrix.trace <span class="main">(</span><span class="free">R</span> <span class="main">*</span> X_XpZ<span class="main">)</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Complex_Matrix.trace <span class="main">(</span>X_XpZ <span class="main">*</span> <span class="free">R</span><span class="main">)</span> <span class="main">=</span> Complex_Matrix.trace <span class="main">(</span><span class="free">R</span> <span class="main">*</span> X_XpZ<span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> trace_comm<span class="main">[</span><span class="operator">of</span> <span class="quoted">X_XpZ</span> <span class="quoted"><span class="numeral">4</span></span> <span class="quoted"><span class="free">R</span></span><span class="main">]</span> X_XpZ_carrier assms dim4 fc_mats_carrier dim_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> bin_cpx<span class="main">)</span> X_I_XpZ_chsh<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"lhv <span class="free">M</span> X_I I_XpZ rho_psim <span class="free">Vx</span> <span class="free">Vp</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">LINT</span> <span class="bound">w</span><span class="main">|</span><span class="free">M</span><span class="main">.</span> <span class="main">(</span>qt_expect X_I <span class="free">Vx</span> <span class="bound">w</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span>qt_expect I_XpZ <span class="free">Vp</span> <span class="bound">w</span><span class="main">)</span> <span class="main">=</span>
  <span class="main">1</span><span class="main">/</span>sqrt <span class="numeral">2</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">LINT</span> <span class="bound">w</span><span class="main">|</span><span class="free">M</span><span class="main">.</span> <span class="main">(</span>qt_expect X_I <span class="free">Vx</span> <span class="bound">w</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span>qt_expect I_XpZ <span class="free">Vp</span> <span class="bound">w</span><span class="main">)</span> <span class="main">=</span>
  Re <span class="main">(</span>Complex_Matrix.trace <span class="main">(</span>rho_psim <span class="main">*</span> X_XpZ<span class="main">)</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> X_I_XpZ_trace<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main">)</span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"rho_psim <span class="main">∈</span> <span class="free">fc_mats</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> rho_psim_carrier fc_mats_carrier dim_eq dim4 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">1</span><span class="main">/</span>sqrt <span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> X_XpZ_rho_psim <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> bin_cpx<span class="main">)</span> Z_I_XpZ_trace<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"lhv <span class="free">M</span> Z_I I_XpZ <span class="free">R</span> <span class="free">Vz</span> <span class="free">Vp</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">R</span><span class="main">∈</span> <span class="free">fc_mats</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">LINT</span> <span class="bound">w</span><span class="main">|</span><span class="free">M</span><span class="main">.</span> <span class="main">(</span>qt_expect Z_I <span class="free">Vz</span> <span class="bound">w</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span>qt_expect I_XpZ <span class="free">Vp</span> <span class="bound">w</span><span class="main">)</span> <span class="main">=</span>
  Re <span class="main">(</span>Complex_Matrix.trace <span class="main">(</span><span class="free">R</span> <span class="main">*</span> Z_XpZ<span class="main">)</span><span class="main">)</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">LINT</span> <span class="bound">w</span><span class="main">|</span><span class="free">M</span><span class="main">.</span> <span class="main">(</span>qt_expect Z_I <span class="free">Vz</span> <span class="bound">w</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span>qt_expect I_XpZ <span class="free">Vp</span> <span class="bound">w</span><span class="main">)</span> <span class="main">=</span>
  Re <span class="main">(</span>Complex_Matrix.trace <span class="main">(</span>Z_I <span class="main">*</span> I_XpZ <span class="main">*</span> <span class="free">R</span><span class="main">)</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> sum_qt_expect<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main">)</span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Z_I <span class="main">∈</span> <span class="free">fc_mats</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Z_I_carrier dim4 fc_mats_carrier dim_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">R</span><span class="main">∈</span> <span class="free">fc_mats</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"I_XpZ <span class="main">∈</span> <span class="free">fc_mats</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> I_XpZ_carrier dim4 fc_mats_carrier dim_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"hermitian Z_I"</span></span> <span class="keyword1"><span class="command">using</span></span> Z_I_hermitian <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"hermitian I_XpZ"</span></span> <span class="keyword1"><span class="command">using</span></span> I_XpZ_hermitian <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> Re <span class="main">(</span>Complex_Matrix.trace <span class="main">(</span>Z_XpZ <span class="main">*</span> <span class="free">R</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Z_I_XpZ_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> Re <span class="main">(</span>Complex_Matrix.trace <span class="main">(</span><span class="free">R</span> <span class="main">*</span> Z_XpZ<span class="main">)</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Complex_Matrix.trace <span class="main">(</span>Z_XpZ <span class="main">*</span> <span class="free">R</span><span class="main">)</span> <span class="main">=</span> Complex_Matrix.trace <span class="main">(</span><span class="free">R</span> <span class="main">*</span> Z_XpZ<span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> trace_comm<span class="main">[</span><span class="operator">of</span> <span class="quoted">Z_XpZ</span> <span class="quoted"><span class="numeral">4</span></span> <span class="quoted"><span class="free">R</span></span><span class="main">]</span> Z_XpZ_carrier assms dim4 fc_mats_carrier dim_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> bin_cpx<span class="main">)</span> Z_I_XpZ_chsh<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"lhv <span class="free">M</span> Z_I I_XpZ rho_psim <span class="free">Vz</span> <span class="free">Vp</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">LINT</span> <span class="bound">w</span><span class="main">|</span><span class="free">M</span><span class="main">.</span> <span class="main">(</span>qt_expect Z_I <span class="free">Vz</span> <span class="bound">w</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span>qt_expect I_XpZ <span class="free">Vp</span> <span class="bound">w</span><span class="main">)</span> <span class="main">=</span>
  <span class="main">1</span><span class="main">/</span>sqrt <span class="numeral">2</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">LINT</span> <span class="bound">w</span><span class="main">|</span><span class="free">M</span><span class="main">.</span> <span class="main">(</span>qt_expect Z_I <span class="free">Vz</span> <span class="bound">w</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span>qt_expect I_XpZ <span class="free">Vp</span> <span class="bound">w</span><span class="main">)</span> <span class="main">=</span>
  Re <span class="main">(</span>Complex_Matrix.trace <span class="main">(</span>rho_psim <span class="main">*</span> Z_XpZ<span class="main">)</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> Z_I_XpZ_trace<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main">)</span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"rho_psim <span class="main">∈</span> <span class="free">fc_mats</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> rho_psim_carrier fc_mats_carrier dim_eq dim4 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">1</span><span class="main">/</span>sqrt <span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Z_XpZ_rho_psim <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> qt_expect_def <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> bin_cpx<span class="main">)</span> X_I_ZmX_trace<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"lhv <span class="free">M</span> X_I I_ZmX <span class="free">R</span> <span class="free">Vx</span> <span class="free">Vp</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">R</span><span class="main">∈</span> <span class="free">fc_mats</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">LINT</span> <span class="bound">w</span><span class="main">|</span><span class="free">M</span><span class="main">.</span> <span class="main">(</span>qt_expect X_I <span class="free">Vx</span> <span class="bound">w</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span>qt_expect I_ZmX <span class="free">Vp</span> <span class="bound">w</span><span class="main">)</span> <span class="main">=</span>
  Re <span class="main">(</span>Complex_Matrix.trace <span class="main">(</span><span class="free">R</span> <span class="main">*</span> X_ZmX<span class="main">)</span><span class="main">)</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">LINT</span> <span class="bound">w</span><span class="main">|</span><span class="free">M</span><span class="main">.</span> <span class="main">(</span>qt_expect X_I <span class="free">Vx</span> <span class="bound">w</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span>qt_expect I_ZmX <span class="free">Vp</span> <span class="bound">w</span><span class="main">)</span> <span class="main">=</span>
  Re <span class="main">(</span>Complex_Matrix.trace <span class="main">(</span>X_I <span class="main">*</span> I_ZmX <span class="main">*</span> <span class="free">R</span><span class="main">)</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> sum_qt_expect<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main">)</span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"X_I <span class="main">∈</span> <span class="free">fc_mats</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> X_I_carrier dim4 fc_mats_carrier dim_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">R</span><span class="main">∈</span> <span class="free">fc_mats</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"I_ZmX <span class="main">∈</span> <span class="free">fc_mats</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> I_ZmX_carrier dim4 fc_mats_carrier dim_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"hermitian X_I"</span></span> <span class="keyword1"><span class="command">using</span></span> X_I_hermitian <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"hermitian I_ZmX"</span></span> <span class="keyword1"><span class="command">using</span></span> I_ZmX_hermitian <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> Re <span class="main">(</span>Complex_Matrix.trace <span class="main">(</span>X_ZmX <span class="main">*</span> <span class="free">R</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> X_I_ZmX_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> Re <span class="main">(</span>Complex_Matrix.trace <span class="main">(</span><span class="free">R</span> <span class="main">*</span> X_ZmX<span class="main">)</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Complex_Matrix.trace <span class="main">(</span>X_ZmX <span class="main">*</span> <span class="free">R</span><span class="main">)</span> <span class="main">=</span> Complex_Matrix.trace <span class="main">(</span><span class="free">R</span> <span class="main">*</span> X_ZmX<span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> trace_comm<span class="main">[</span><span class="operator">of</span> <span class="quoted">X_ZmX</span> <span class="quoted"><span class="numeral">4</span></span> <span class="quoted"><span class="free">R</span></span><span class="main">]</span> X_ZmX_carrier assms dim4 fc_mats_carrier dim_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> bin_cpx<span class="main">)</span> X_I_ZmX_chsh<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"lhv <span class="free">M</span> X_I I_ZmX rho_psim <span class="free">Vx</span> <span class="free">Vp</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">LINT</span> <span class="bound">w</span><span class="main">|</span><span class="free">M</span><span class="main">.</span> <span class="main">(</span>qt_expect X_I <span class="free">Vx</span> <span class="bound">w</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span>qt_expect I_ZmX <span class="free">Vp</span> <span class="bound">w</span><span class="main">)</span> <span class="main">=</span>
  <span class="main">1</span><span class="main">/</span>sqrt <span class="numeral">2</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">LINT</span> <span class="bound">w</span><span class="main">|</span><span class="free">M</span><span class="main">.</span> <span class="main">(</span>qt_expect X_I <span class="free">Vx</span> <span class="bound">w</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span>qt_expect I_ZmX <span class="free">Vp</span> <span class="bound">w</span><span class="main">)</span> <span class="main">=</span>
  Re <span class="main">(</span>Complex_Matrix.trace <span class="main">(</span>rho_psim <span class="main">*</span> X_ZmX<span class="main">)</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> X_I_ZmX_trace<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main">)</span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"rho_psim <span class="main">∈</span> <span class="free">fc_mats</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> rho_psim_carrier fc_mats_carrier dim_eq dim4 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">1</span><span class="main">/</span>sqrt <span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> X_ZmX_rho_psim <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> qt_expect_def <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> bin_cpx<span class="main">)</span> Z_I_ZmX_trace<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"lhv <span class="free">M</span> Z_I I_ZmX <span class="free">R</span> <span class="free">Vz</span> <span class="free">Vp</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">R</span><span class="main">∈</span> <span class="free">fc_mats</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">LINT</span> <span class="bound">w</span><span class="main">|</span><span class="free">M</span><span class="main">.</span> <span class="main">(</span>qt_expect Z_I <span class="free">Vz</span> <span class="bound">w</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span>qt_expect I_ZmX <span class="free">Vp</span> <span class="bound">w</span><span class="main">)</span> <span class="main">=</span>
  Re <span class="main">(</span>Complex_Matrix.trace <span class="main">(</span><span class="free">R</span> <span class="main">*</span> Z_ZmX<span class="main">)</span><span class="main">)</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">LINT</span> <span class="bound">w</span><span class="main">|</span><span class="free">M</span><span class="main">.</span> <span class="main">(</span>qt_expect Z_I <span class="free">Vz</span> <span class="bound">w</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span>qt_expect I_ZmX <span class="free">Vp</span> <span class="bound">w</span><span class="main">)</span> <span class="main">=</span>
  Re <span class="main">(</span>Complex_Matrix.trace <span class="main">(</span>Z_I <span class="main">*</span> I_ZmX <span class="main">*</span> <span class="free">R</span><span class="main">)</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> sum_qt_expect<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main">)</span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Z_I <span class="main">∈</span> <span class="free">fc_mats</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Z_I_carrier dim4 fc_mats_carrier dim_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">R</span><span class="main">∈</span> <span class="free">fc_mats</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"I_ZmX <span class="main">∈</span> <span class="free">fc_mats</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> I_ZmX_carrier dim4 fc_mats_carrier dim_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"hermitian Z_I"</span></span> <span class="keyword1"><span class="command">using</span></span> Z_I_hermitian <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"hermitian I_ZmX"</span></span> <span class="keyword1"><span class="command">using</span></span> I_ZmX_hermitian <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> Re <span class="main">(</span>Complex_Matrix.trace <span class="main">(</span>Z_ZmX <span class="main">*</span> <span class="free">R</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Z_I_ZmX_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> Re <span class="main">(</span>Complex_Matrix.trace <span class="main">(</span><span class="free">R</span> <span class="main">*</span> Z_ZmX<span class="main">)</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Complex_Matrix.trace <span class="main">(</span>Z_ZmX <span class="main">*</span> <span class="free">R</span><span class="main">)</span> <span class="main">=</span> Complex_Matrix.trace <span class="main">(</span><span class="free">R</span> <span class="main">*</span> Z_ZmX<span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> trace_comm<span class="main">[</span><span class="operator">of</span> <span class="quoted">Z_ZmX</span> <span class="quoted"><span class="numeral">4</span></span> <span class="quoted"><span class="free">R</span></span><span class="main">]</span> Z_ZmX_carrier assms dim4 fc_mats_carrier dim_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> bin_cpx<span class="main">)</span> Z_I_ZmX_chsh<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"lhv <span class="free">M</span> Z_I I_ZmX rho_psim <span class="free">Vz</span> <span class="free">Vp</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">LINT</span> <span class="bound">w</span><span class="main">|</span><span class="free">M</span><span class="main">.</span> <span class="main">(</span>qt_expect Z_I <span class="free">Vz</span> <span class="bound">w</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span>qt_expect I_ZmX <span class="free">Vp</span> <span class="bound">w</span><span class="main">)</span> <span class="main">=</span>
  <span class="main">-</span><span class="main">1</span><span class="main">/</span>sqrt <span class="numeral">2</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">LINT</span> <span class="bound">w</span><span class="main">|</span><span class="free">M</span><span class="main">.</span> <span class="main">(</span>qt_expect Z_I <span class="free">Vz</span> <span class="bound">w</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span>qt_expect I_ZmX <span class="free">Vp</span> <span class="bound">w</span><span class="main">)</span> <span class="main">=</span>
  Re <span class="main">(</span>Complex_Matrix.trace <span class="main">(</span>rho_psim <span class="main">*</span> Z_ZmX<span class="main">)</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> Z_I_ZmX_trace<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main">)</span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"rho_psim <span class="main">∈</span> <span class="free">fc_mats</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> rho_psim_carrier fc_mats_carrier dim_eq dim4 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">-</span><span class="main">1</span><span class="main">/</span>sqrt <span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Z_ZmX_rho_psim <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> qt_expect_def <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> bin_cpx<span class="main">)</span> chsh_upper_bound<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"prob_space <span class="free">M</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"lhv <span class="free">M</span> X_I I_XpZ rho_psim <span class="free">Vx</span> <span class="free">Vp</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"lhv <span class="free">M</span> Z_I I_XpZ rho_psim <span class="free">Vz</span> <span class="free">Vp</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"lhv <span class="free">M</span> X_I I_ZmX rho_psim <span class="free">Vx</span> <span class="free">Vm</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"lhv <span class="free">M</span> Z_I I_ZmX rho_psim <span class="free">Vz</span> <span class="free">Vm</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">¦</span><span class="main">(</span><span class="keyword1">LINT</span> <span class="bound">w</span><span class="main">|</span><span class="free">M</span><span class="main">.</span> qt_expect X_I <span class="free">Vx</span> <span class="bound">w</span> <span class="main">*</span> qt_expect I_ZmX <span class="free">Vm</span> <span class="bound">w</span><span class="main">)</span> <span class="main">+</span> 
        <span class="main">(</span><span class="keyword1">LINT</span> <span class="bound">w</span><span class="main">|</span><span class="free">M</span><span class="main">.</span> qt_expect Z_I <span class="free">Vz</span> <span class="bound">w</span> <span class="main">*</span> qt_expect I_XpZ <span class="free">Vp</span> <span class="bound">w</span><span class="main">)</span> <span class="main">+</span> 
        <span class="main">(</span><span class="keyword1">LINT</span> <span class="bound">w</span><span class="main">|</span><span class="free">M</span><span class="main">.</span> qt_expect X_I <span class="free">Vx</span> <span class="bound">w</span> <span class="main">*</span> qt_expect I_XpZ <span class="free">Vp</span> <span class="bound">w</span><span class="main">)</span> <span class="main">-</span>
        <span class="main">(</span><span class="keyword1">LINT</span> <span class="bound">w</span><span class="main">|</span><span class="free">M</span><span class="main">.</span> qt_expect Z_I <span class="free">Vz</span> <span class="bound">w</span> <span class="main">*</span> qt_expect I_ZmX <span class="free">Vm</span> <span class="bound">w</span><span class="main">)</span><span class="main">¦</span>
  <span class="main">≤</span> <span class="numeral">2</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> prob_space.chsh_expect<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">AE</span> <span class="bound">w</span> <span class="keyword1">in</span> <span class="free">M</span><span class="main">.</span> <span class="main">¦</span>qt_expect X_I <span class="free">Vx</span> <span class="bound">w</span><span class="main">¦</span> <span class="main">≤</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> qt_expect_def
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> spectrum_abs_1_weighted_suml<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"X_I <span class="main">∈</span> <span class="free">fc_mats</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> X_I_carrier fc_mats_carrier dim_eq dim4 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"hermitian X_I"</span></span> <span class="keyword1"><span class="command">using</span></span> X_I_hermitian <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"lhv <span class="free">M</span> X_I I_XpZ rho_psim <span class="free">Vx</span> <span class="free">Vp</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span>Re <span class="bound">x</span> <span class="main">|</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> spectrum X_I<span class="main">}</span> <span class="main">⊆</span> <span class="main">{</span><span class="main">-</span> <span class="main">1</span><span class="main">,</span> <span class="main">1</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> X_I_spectrum <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span>Re <span class="bound">x</span> <span class="main">|</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> spectrum X_I<span class="main">}</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> spectrum_ne X_I_hermitian <span class="quoted"><span class="quoted">‹X_I <span class="main">∈</span> <span class="free">fc_mats</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">AE</span> <span class="bound">w</span> <span class="keyword1">in</span> <span class="free">M</span><span class="main">.</span> <span class="main">¦</span>qt_expect Z_I <span class="free">Vz</span> <span class="bound">w</span><span class="main">¦</span> <span class="main">≤</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> qt_expect_def
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> spectrum_abs_1_weighted_suml<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Z_I <span class="main">∈</span> <span class="free">fc_mats</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Z_I_carrier fc_mats_carrier dim_eq dim4 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"hermitian Z_I"</span></span> <span class="keyword1"><span class="command">using</span></span> Z_I_hermitian <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"lhv <span class="free">M</span> Z_I I_XpZ rho_psim <span class="free">Vz</span> <span class="free">Vp</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span>Re <span class="bound">x</span> <span class="main">|</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> spectrum Z_I<span class="main">}</span> <span class="main">⊆</span> <span class="main">{</span><span class="main">-</span> <span class="main">1</span><span class="main">,</span> <span class="main">1</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Z_I_spectrum <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span>Re <span class="bound">x</span> <span class="main">|</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> spectrum Z_I<span class="main">}</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> spectrum_ne Z_I_hermitian <span class="quoted"><span class="quoted">‹Z_I <span class="main">∈</span> <span class="free">fc_mats</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">AE</span> <span class="bound">w</span> <span class="keyword1">in</span> <span class="free">M</span><span class="main">.</span> <span class="main">¦</span>qt_expect I_XpZ <span class="free">Vp</span> <span class="bound">w</span><span class="main">¦</span> <span class="main">≤</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> qt_expect_def
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> spectrum_abs_1_weighted_sumr<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"I_XpZ <span class="main">∈</span> <span class="free">fc_mats</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> I_XpZ_carrier fc_mats_carrier dim_eq dim4 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"hermitian I_XpZ"</span></span> <span class="keyword1"><span class="command">using</span></span> I_XpZ_hermitian <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"lhv <span class="free">M</span> Z_I I_XpZ rho_psim <span class="free">Vz</span> <span class="free">Vp</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span>Re <span class="bound">x</span> <span class="main">|</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> spectrum I_XpZ<span class="main">}</span> <span class="main">⊆</span> <span class="main">{</span><span class="main">-</span> <span class="main">1</span><span class="main">,</span> <span class="main">1</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> I_XpZ_spectrum <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span>Re <span class="bound">x</span> <span class="main">|</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> spectrum I_XpZ<span class="main">}</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> spectrum_ne I_XpZ_hermitian <span class="quoted"><span class="quoted">‹I_XpZ <span class="main">∈</span> <span class="free">fc_mats</span>›</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">AE</span> <span class="bound">w</span> <span class="keyword1">in</span> <span class="free">M</span><span class="main">.</span> <span class="main">¦</span>qt_expect I_ZmX <span class="free">Vm</span> <span class="bound">w</span><span class="main">¦</span> <span class="main">≤</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> qt_expect_def
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> spectrum_abs_1_weighted_sumr<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"I_ZmX <span class="main">∈</span> <span class="free">fc_mats</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> I_ZmX_carrier fc_mats_carrier dim_eq dim4 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"hermitian I_ZmX"</span></span> <span class="keyword1"><span class="command">using</span></span> I_ZmX_hermitian <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"lhv <span class="free">M</span> Z_I I_ZmX rho_psim <span class="free">Vz</span> <span class="free">Vm</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span>Re <span class="bound">x</span> <span class="main">|</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> spectrum I_ZmX<span class="main">}</span> <span class="main">⊆</span> <span class="main">{</span><span class="main">-</span> <span class="main">1</span><span class="main">,</span> <span class="main">1</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> I_ZmX_spectrum <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span>Re <span class="bound">x</span> <span class="main">|</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> spectrum I_ZmX<span class="main">}</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> spectrum_ne I_ZmX_hermitian <span class="quoted"><span class="quoted">‹I_ZmX <span class="main">∈</span> <span class="free">fc_mats</span>›</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"prob_space <span class="free">M</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"integrable <span class="free">M</span> <span class="main">(</span><span class="main">λ</span><span class="bound">w</span><span class="main">.</span> qt_expect X_I <span class="free">Vx</span> <span class="bound">w</span> <span class="main">*</span> qt_expect I_ZmX <span class="free">Vm</span> <span class="bound">w</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> spectr_sum_integrable<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">M</span></span><span class="main">]</span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"integrable <span class="free">M</span> <span class="main">(</span><span class="main">λ</span><span class="bound">w</span><span class="main">.</span> qt_expect Z_I <span class="free">Vz</span> <span class="bound">w</span> <span class="main">*</span> qt_expect I_ZmX <span class="free">Vm</span> <span class="bound">w</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> spectr_sum_integrable<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">M</span></span><span class="main">]</span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"integrable <span class="free">M</span> <span class="main">(</span><span class="main">λ</span><span class="bound">w</span><span class="main">.</span> qt_expect X_I <span class="free">Vx</span> <span class="bound">w</span> <span class="main">*</span> qt_expect I_XpZ <span class="free">Vp</span> <span class="bound">w</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> spectr_sum_integrable<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">M</span></span><span class="main">]</span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"integrable <span class="free">M</span> <span class="main">(</span><span class="main">λ</span><span class="bound">w</span><span class="main">.</span> qt_expect Z_I <span class="free">Vz</span> <span class="bound">w</span> <span class="main">*</span> qt_expect I_XpZ <span class="free">Vp</span> <span class="bound">w</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> spectr_sum_integrable<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">M</span></span><span class="main">]</span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> bin_cpx<span class="main">)</span> quantum_value<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"lhv <span class="free">M</span> X_I I_XpZ rho_psim <span class="free">Vx</span> <span class="free">Vp</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"lhv <span class="free">M</span> Z_I I_XpZ rho_psim <span class="free">Vz</span> <span class="free">Vp</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"lhv <span class="free">M</span> X_I I_ZmX rho_psim <span class="free">Vx</span> <span class="free">Vm</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"lhv <span class="free">M</span> Z_I I_ZmX rho_psim <span class="free">Vz</span> <span class="free">Vm</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">¦</span><span class="main">(</span><span class="keyword1">LINT</span> <span class="bound">w</span><span class="main">|</span><span class="free">M</span><span class="main">.</span> qt_expect X_I <span class="free">Vx</span> <span class="bound">w</span> <span class="main">*</span> qt_expect I_ZmX <span class="free">Vm</span> <span class="bound">w</span><span class="main">)</span> <span class="main">+</span> 
        <span class="main">(</span><span class="keyword1">LINT</span> <span class="bound">w</span><span class="main">|</span><span class="free">M</span><span class="main">.</span> qt_expect Z_I <span class="free">Vz</span> <span class="bound">w</span> <span class="main">*</span> qt_expect I_XpZ <span class="free">Vp</span> <span class="bound">w</span><span class="main">)</span> <span class="main">+</span> 
        <span class="main">(</span><span class="keyword1">LINT</span> <span class="bound">w</span><span class="main">|</span><span class="free">M</span><span class="main">.</span> qt_expect X_I <span class="free">Vx</span> <span class="bound">w</span> <span class="main">*</span> qt_expect I_XpZ <span class="free">Vp</span> <span class="bound">w</span><span class="main">)</span> <span class="main">-</span>
        <span class="main">(</span><span class="keyword1">LINT</span> <span class="bound">w</span><span class="main">|</span><span class="free">M</span><span class="main">.</span> qt_expect Z_I <span class="free">Vz</span> <span class="bound">w</span> <span class="main">*</span> qt_expect I_ZmX <span class="free">Vm</span> <span class="bound">w</span><span class="main">)</span><span class="main">¦</span>
  <span class="main">=</span> <span class="numeral">2</span><span class="main">*</span> sqrt <span class="numeral">2</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">LINT</span> <span class="bound">w</span><span class="main">|</span><span class="free">M</span><span class="main">.</span> qt_expect X_I <span class="free">Vx</span> <span class="bound">w</span> <span class="main">*</span> qt_expect I_ZmX <span class="free">Vm</span> <span class="bound">w</span> <span class="main">=</span> <span class="main">1</span><span class="main">/</span>sqrt <span class="numeral">2</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> X_I_ZmX_chsh<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">M</span></span><span class="main">]</span> assms <span class="keyword1"><span class="command">unfolding</span></span> qt_expect_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> b<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">LINT</span> <span class="bound">w</span><span class="main">|</span><span class="free">M</span><span class="main">.</span> qt_expect X_I <span class="free">Vx</span> <span class="bound">w</span> <span class="main">*</span> qt_expect I_XpZ <span class="free">Vp</span> <span class="bound">w</span> <span class="main">=</span> <span class="main">1</span><span class="main">/</span>sqrt <span class="numeral">2</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> X_I_XpZ_chsh<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">M</span></span><span class="main">]</span> assms <span class="keyword1"><span class="command">unfolding</span></span> qt_expect_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> c<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">LINT</span> <span class="bound">w</span><span class="main">|</span><span class="free">M</span><span class="main">.</span> qt_expect Z_I <span class="free">Vz</span> <span class="bound">w</span> <span class="main">*</span> qt_expect I_XpZ <span class="free">Vp</span> <span class="bound">w</span> <span class="main">=</span> <span class="main">1</span><span class="main">/</span>sqrt <span class="numeral">2</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Z_I_XpZ_chsh<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">M</span></span><span class="main">]</span> assms <span class="keyword1"><span class="command">unfolding</span></span> qt_expect_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">LINT</span> <span class="bound">w</span><span class="main">|</span><span class="free">M</span><span class="main">.</span> qt_expect Z_I <span class="free">Vz</span> <span class="bound">w</span> <span class="main">*</span> qt_expect I_ZmX <span class="free">Vm</span> <span class="bound">w</span> <span class="main">=</span> <span class="main">-</span><span class="main">1</span><span class="main">/</span>sqrt <span class="numeral">2</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Z_I_ZmX_chsh<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">M</span></span><span class="main">]</span> assms <span class="keyword1"><span class="command">unfolding</span></span> qt_expect_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">LINT</span> <span class="bound">w</span><span class="main">|</span><span class="free">M</span><span class="main">.</span> qt_expect X_I <span class="free">Vx</span> <span class="bound">w</span> <span class="main">*</span> qt_expect I_ZmX <span class="free">Vm</span> <span class="bound">w</span><span class="main">)</span> <span class="main">+</span> 
        <span class="main">(</span><span class="keyword1">LINT</span> <span class="bound">w</span><span class="main">|</span><span class="free">M</span><span class="main">.</span> qt_expect X_I <span class="free">Vx</span> <span class="bound">w</span> <span class="main">*</span> qt_expect I_XpZ <span class="free">Vp</span> <span class="bound">w</span><span class="main">)</span> <span class="main">+</span> 
        <span class="main">(</span><span class="keyword1">LINT</span> <span class="bound">w</span><span class="main">|</span><span class="free">M</span><span class="main">.</span> qt_expect Z_I <span class="free">Vz</span> <span class="bound">w</span> <span class="main">*</span> qt_expect I_XpZ <span class="free">Vp</span> <span class="bound">w</span><span class="main">)</span> <span class="main">-</span>
        <span class="main">(</span><span class="keyword1">LINT</span> <span class="bound">w</span><span class="main">|</span><span class="free">M</span><span class="main">.</span> qt_expect Z_I <span class="free">Vz</span> <span class="bound">w</span> <span class="main">*</span> qt_expect I_ZmX <span class="free">Vm</span> <span class="bound">w</span><span class="main">)</span> <span class="main">=</span> <span class="numeral">4</span><span class="main">/</span><span class="main">(</span>sqrt <span class="numeral">2</span><span class="main">)</span>"</span></span>  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="numeral">4</span> <span class="main">*</span> <span class="main">(</span>sqrt <span class="numeral">2</span><span class="main">)</span><span class="main">)</span><span class="main">/</span><span class="main">(</span>sqrt <span class="numeral">2</span> <span class="main">*</span> <span class="main">(</span>sqrt <span class="numeral">2</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> mult_numeral_1_right real_divide_square_eq times_divide_eq_right<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="numeral">4</span> <span class="main">*</span> <span class="main">(</span>sqrt <span class="numeral">2</span><span class="main">)</span><span class="main">)</span> <span class="main">/</span> <span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">*</span> <span class="main">(</span>sqrt <span class="numeral">2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">LINT</span> <span class="bound">w</span><span class="main">|</span><span class="free">M</span><span class="main">.</span> qt_expect X_I <span class="free">Vx</span> <span class="bound">w</span> <span class="main">*</span> qt_expect I_ZmX <span class="free">Vm</span> <span class="bound">w</span><span class="main">)</span> <span class="main">+</span> 
        <span class="main">(</span><span class="keyword1">LINT</span> <span class="bound">w</span><span class="main">|</span><span class="free">M</span><span class="main">.</span> qt_expect X_I <span class="free">Vx</span> <span class="bound">w</span> <span class="main">*</span> qt_expect I_XpZ <span class="free">Vp</span> <span class="bound">w</span><span class="main">)</span> <span class="main">+</span> 
        <span class="main">(</span><span class="keyword1">LINT</span> <span class="bound">w</span><span class="main">|</span><span class="free">M</span><span class="main">.</span> qt_expect Z_I <span class="free">Vz</span> <span class="bound">w</span> <span class="main">*</span> qt_expect I_XpZ <span class="free">Vp</span> <span class="bound">w</span><span class="main">)</span> <span class="main">-</span>
        <span class="main">(</span><span class="keyword1">LINT</span> <span class="bound">w</span><span class="main">|</span><span class="free">M</span><span class="main">.</span> qt_expect Z_I <span class="free">Vz</span> <span class="bound">w</span> <span class="main">*</span> qt_expect I_ZmX <span class="free">Vm</span> <span class="bound">w</span><span class="main">)</span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">*</span> sqrt <span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> b c<span class="main">)</span>  
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> bin_cpx<span class="main">)</span> no_lhv<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"lhv <span class="free">M</span> X_I I_XpZ rho_psim <span class="free">Vx</span> <span class="free">Vp</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"lhv <span class="free">M</span> Z_I I_XpZ rho_psim <span class="free">Vz</span> <span class="free">Vp</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"lhv <span class="free">M</span> X_I I_ZmX rho_psim <span class="free">Vx</span> <span class="free">Vm</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"lhv <span class="free">M</span> Z_I I_ZmX rho_psim <span class="free">Vz</span> <span class="free">Vm</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted">False</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"prob_space <span class="free">M</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> lhv_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">*</span> sqrt <span class="numeral">2</span> <span class="main">=</span> <span class="main">¦</span><span class="main">(</span><span class="keyword1">LINT</span> <span class="bound">w</span><span class="main">|</span><span class="free">M</span><span class="main">.</span> qt_expect X_I <span class="free">Vx</span> <span class="bound">w</span> <span class="main">*</span> qt_expect I_ZmX <span class="free">Vm</span> <span class="bound">w</span><span class="main">)</span> <span class="main">+</span> 
        <span class="main">(</span><span class="keyword1">LINT</span> <span class="bound">w</span><span class="main">|</span><span class="free">M</span><span class="main">.</span> qt_expect Z_I <span class="free">Vz</span> <span class="bound">w</span> <span class="main">*</span> qt_expect I_XpZ <span class="free">Vp</span> <span class="bound">w</span><span class="main">)</span> <span class="main">+</span> 
        <span class="main">(</span><span class="keyword1">LINT</span> <span class="bound">w</span><span class="main">|</span><span class="free">M</span><span class="main">.</span> qt_expect X_I <span class="free">Vx</span> <span class="bound">w</span> <span class="main">*</span> qt_expect I_XpZ <span class="free">Vp</span> <span class="bound">w</span><span class="main">)</span> <span class="main">-</span>
        <span class="main">(</span><span class="keyword1">LINT</span> <span class="bound">w</span><span class="main">|</span><span class="free">M</span><span class="main">.</span> qt_expect Z_I <span class="free">Vz</span> <span class="bound">w</span> <span class="main">*</span> qt_expect I_ZmX <span class="free">Vm</span> <span class="bound">w</span><span class="main">)</span><span class="main">¦</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms quantum_value<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">M</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">≤</span> <span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> chsh_upper_bound<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">M</span></span><span class="main">]</span> assms <span class="quoted"><span class="quoted">‹prob_space <span class="free">M</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">*</span> sqrt <span class="numeral">2</span> <span class="main">≤</span> <span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword2"><span class="keyword">end</span></span></pre>
</div>