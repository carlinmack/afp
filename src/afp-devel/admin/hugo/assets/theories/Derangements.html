<div id="Derangements">
<div class="head">
<h1>Theory Derangements</h1>
</div>
<pre class="source"><span class="comment1">(* Author: Lukas Bulwahn &lt;lukas.bulwahn-at-gmail.com&gt; *)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Derangements›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Derangements
<span class="keyword2"><span class="keyword">imports</span></span>
  <a href="https://www.cl.cam.ac.uk/research/hvg/Isabelle/dist/library/HOL/HOL/Complex_Main.html">Complex_Main</a>
  <span class="quoted">"<a href="https://www.cl.cam.ac.uk/research/hvg/Isabelle/dist/library/HOL/HOL-Combinatorics/Permutations.html">HOL-Combinatorics.Permutations</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Preliminaries›</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Additions to <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">theory</span></span> <a href="../../HOL/HOL/Finite_Set.html"></a><a href="../../HOL/HOL/Finite_Set.html">HOL.Finite_Set</a><span class="antiquote"><span class="antiquote">}</span></span></span></span> Theory›</span></span>

<span class="keyword1" id="Derangements-card_product_dependent"><span class="command">lemma</span></span> card_product_dependent<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">S</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> <span class="free">S</span><span class="main">.</span> finite <span class="main">(</span><span class="free">T</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"card <span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">∧</span> <span class="bound">y</span> <span class="main">∈</span> <span class="free">T</span> <span class="bound">x</span><span class="main">}</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">x</span> <span class="main">∈</span> <span class="free">S</span><span class="main">.</span> card <span class="main">(</span><span class="free">T</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> card_SigmaI<span class="main">[</span><span class="operator">OF</span> assms<span class="main">,</span> <span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> arg_cong<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted">card</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Sigma_def<span class="main">)</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Additions to <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">theory</span></span> "<a href="../../HOL/HOL-Combinatorics/Permutations.html"></a><a href="../../HOL/HOL-Combinatorics/Permutations.html">HOL-Combinatorics.Permutations</a>"<span class="antiquote"><span class="antiquote">}</span></span></span></span> Theory›</span></span>

<span class="keyword1" id="Derangements-permutes_imp_bij'"><span class="command">lemma</span></span> permutes_imp_bij'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="keyword1">permutes</span> <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"bij <span class="free">p</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> bij_def permutes_inj permutes_surj<span class="main">)</span>

<span class="keyword1" id="Derangements-permutesE"><span class="command">lemma</span></span> permutesE<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="keyword1">permutes</span> <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="quoted"><span class="quoted">"bij <span class="free">p</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∉</span> <span class="free">S</span> <span class="main">⟶</span> <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">x</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> permutes_def permutes_imp_bij'<span class="main">)</span>

<span class="keyword1" id="Derangements-bij_imp_permutes'"><span class="command">lemma</span></span> bij_imp_permutes'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"bij <span class="free">p</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∉</span> <span class="free">A</span> <span class="main">⟶</span> <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>  <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="keyword1">permutes</span> <span class="free">A</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms bij_imp_permutes permutes_superset <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

<span class="keyword1" id="Derangements-permutes_swap"><span class="command">lemma</span></span> permutes_swap<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="keyword1">permutes</span> <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Fun.swap <span class="free">x</span> <span class="free">y</span> <span class="free">p</span> <span class="keyword1">permutes</span> <span class="main">(</span>insert <span class="free">x</span> <span class="main">(</span>insert <span class="free">y</span> <span class="free">S</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="keyword1">permutes</span> <span class="main">(</span>insert <span class="free">x</span> <span class="main">(</span>insert <span class="free">y</span> <span class="free">S</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> permutes_subset subset_insertI<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Fun.swap <span class="free">x</span> <span class="free">y</span> id <span class="keyword1">permutes</span> <span class="main">(</span>insert <span class="free">x</span> <span class="main">(</span>insert <span class="free">y</span> <span class="free">S</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> permutes_swap_id<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Fun.swap <span class="free">x</span> <span class="free">y</span> <span class="free">p</span> <span class="keyword1">permutes</span> <span class="main">(</span>insert <span class="free">x</span> <span class="main">(</span>insert <span class="free">y</span> <span class="free">S</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> comp_id comp_swap permutes_compose<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Derangements-bij_extends"><span class="command">lemma</span></span> bij_extends<span class="main">:</span>
  <span class="quoted"><span class="quoted">"bij <span class="free">p</span> <span class="main">⟹</span> <span class="free">p</span> <span class="free">x</span> <span class="main">=</span> <span class="free">x</span> <span class="main">⟹</span> bij <span class="main">(</span><span class="free">p</span><span class="main">(</span><span class="free">x</span> <span class="main">:=</span> <span class="free">y</span><span class="main">,</span> inv <span class="free">p</span> <span class="free">y</span> <span class="main">:=</span> <span class="free">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> bij_def
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> conjI<span class="main"><span class="keyword3">;</span></span> <span class="operator">erule</span> conjE<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"inj <span class="free">p</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="free">x</span> <span class="main">=</span> <span class="free">x</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"inj <span class="main">(</span><span class="free">p</span><span class="main">(</span><span class="free">x</span> <span class="main">:=</span> <span class="free">y</span><span class="main">,</span> inv <span class="free">p</span> <span class="free">y</span> <span class="main">:=</span> <span class="free">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> injI<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">z</span> <span class="skolem">z'</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">p</span><span class="main">(</span><span class="free">x</span> <span class="main">:=</span> <span class="free">y</span><span class="main">,</span> inv <span class="free">p</span> <span class="free">y</span> <span class="main">:=</span> <span class="free">x</span><span class="main">)</span><span class="main">)</span> <span class="skolem">z</span> <span class="main">=</span> <span class="main">(</span><span class="free">p</span><span class="main">(</span><span class="free">x</span> <span class="main">:=</span> <span class="free">y</span><span class="main">,</span> inv <span class="free">p</span> <span class="free">y</span> <span class="main">:=</span> <span class="free">x</span><span class="main">)</span><span class="main">)</span> <span class="skolem">z'</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> this a <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">=</span> <span class="skolem">z'</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inv_f_eq inj_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"inj <span class="free">p</span>"</span></span> <span class="quoted"><span class="quoted">"surj <span class="free">p</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="free">x</span> <span class="main">=</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x'</span>
    <span class="keyword1"><span class="command">from</span></span> a <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">p</span><span class="main">(</span><span class="free">x</span> <span class="main">:=</span> <span class="free">y</span><span class="main">,</span> inv <span class="free">p</span> <span class="free">y</span> <span class="main">:=</span> <span class="free">x</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="main">(</span>inv <span class="free">p</span><span class="main">)</span><span class="main">(</span><span class="free">y</span> <span class="main">:=</span> <span class="free">x</span><span class="main">,</span> <span class="free">x</span> <span class="main">:=</span> inv <span class="free">p</span> <span class="free">y</span><span class="main">)</span><span class="main">)</span> <span class="skolem">x'</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">x'</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm<span class="main">)</span> <span class="main">(</span><span class="operator">metis</span> surj_f_inv_f<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"surj <span class="main">(</span><span class="free">p</span><span class="main">(</span><span class="free">x</span> <span class="main">:=</span> <span class="free">y</span><span class="main">,</span> inv <span class="free">p</span> <span class="free">y</span> <span class="main">:=</span> <span class="free">x</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> surjI<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Derangements-permutes_add_one"><span class="command">lemma</span></span> permutes_add_one<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="keyword1">permutes</span> <span class="free">S</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> <span class="free">S</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∈</span> <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span><span class="main">(</span><span class="free">x</span> <span class="main">:=</span> <span class="free">y</span><span class="main">,</span> inv <span class="free">p</span> <span class="free">y</span> <span class="main">:=</span> <span class="free">x</span><span class="main">)</span> <span class="keyword1">permutes</span> <span class="main">(</span>insert <span class="free">x</span> <span class="free">S</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> bij_imp_permutes'<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"bij <span class="main">(</span><span class="free">p</span><span class="main">(</span><span class="free">x</span> <span class="main">:=</span> <span class="free">y</span><span class="main">,</span> inv <span class="free">p</span> <span class="free">y</span> <span class="main">:=</span> <span class="free">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> bij_extends permutes_def permutes_imp_bij'<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">z</span><span class="main">.</span> <span class="bound">z</span> <span class="main">∉</span> insert <span class="free">x</span> <span class="free">S</span> <span class="main">⟶</span> <span class="main">(</span><span class="free">p</span><span class="main">(</span><span class="free">x</span> <span class="main">:=</span> <span class="free">y</span><span class="main">,</span> inv <span class="free">p</span> <span class="free">y</span> <span class="main">:=</span> <span class="free">x</span><span class="main">)</span><span class="main">)</span> <span class="bound">z</span> <span class="main">=</span> <span class="bound">z</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> fun_upd_apply insertCI permutes_def permutes_inverses<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Derangements-permutations_skip_one"><span class="command">lemma</span></span> permutations_skip_one<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="keyword1">permutes</span> <span class="free">S</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">:</span> <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span><span class="main">(</span><span class="free">x</span> <span class="main">:=</span> <span class="free">x</span><span class="main">,</span> inv <span class="free">p</span> <span class="free">x</span> <span class="main">:=</span> <span class="free">p</span> <span class="free">x</span><span class="main">)</span> <span class="keyword1">permutes</span> <span class="main">(</span><span class="free">S</span> <span class="main">-</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> bij_imp_permutes'<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">z</span><span class="main">.</span> <span class="bound">z</span> <span class="main">∉</span> <span class="free">S</span> <span class="main">-</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">⟶</span> <span class="main">(</span><span class="free">p</span><span class="main">(</span><span class="free">x</span> <span class="main">:=</span> <span class="free">x</span><span class="main">,</span> inv <span class="free">p</span> <span class="free">x</span> <span class="main">:=</span> <span class="free">p</span> <span class="free">x</span><span class="main">)</span><span class="main">)</span> <span class="bound">z</span> <span class="main">=</span> <span class="bound">z</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> permutesE <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bij_inv_eq_iff<span class="main">)</span>
      <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> permutes_in_image permutes_inv<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"inj <span class="main">(</span><span class="free">p</span><span class="main">(</span><span class="free">x</span> <span class="main">:=</span> <span class="free">x</span><span class="main">,</span> inv <span class="free">p</span> <span class="free">x</span> <span class="main">:=</span> <span class="free">p</span> <span class="free">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> injI<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm<span class="main"><span class="keyword3">;</span></span> <span class="operator">metis</span> permutes_inverses<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"surj <span class="main">(</span><span class="free">p</span><span class="main">(</span><span class="free">x</span> <span class="main">:=</span> <span class="free">x</span><span class="main">,</span> inv <span class="free">p</span> <span class="free">x</span> <span class="main">:=</span> <span class="free">p</span> <span class="free">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms UNIV_I bij_betw_swap_iff permutes_inj permutes_surj surj_f_inv_f
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> hide_lams<span class="main"><span class="main">)</span></span> Fun.swap_def bij_betw_def<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"bij <span class="main">(</span><span class="free">p</span><span class="main">(</span><span class="free">x</span> <span class="main">:=</span> <span class="free">x</span><span class="main">,</span> inv <span class="free">p</span> <span class="free">x</span> <span class="main">:=</span> <span class="free">p</span> <span class="free">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> bijI<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Derangements-permutes_drop_cycle_size_two"><span class="command">lemma</span></span> permutes_drop_cycle_size_two<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="keyword1">permutes</span> <span class="free">S</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">(</span><span class="free">p</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> <span class="free">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Fun.swap <span class="free">x</span> <span class="main">(</span><span class="free">p</span> <span class="free">x</span><span class="main">)</span> <span class="free">p</span> <span class="keyword1">permutes</span> <span class="main">(</span><span class="free">S</span> <span class="main">-</span> <span class="main">{</span><span class="free">x</span><span class="main">,</span> <span class="free">p</span> <span class="free">x</span><span class="main">}</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> bij_imp_permutes' <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> permutesE<span class="main">)</span> <span class="main">(</span><span class="operator">metis</span> swap_apply<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Fixpoint-Free Permutations›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">derangements</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat set <span class="main">⇒</span> <span class="main">(</span>nat <span class="main">⇒</span> nat<span class="main">)</span> set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">derangements</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">=</span> <span class="main">{</span><span class="bound">p</span><span class="main">.</span> <span class="bound">p</span> <span class="keyword1">permutes</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">.</span> <span class="bound">p</span> <span class="bound">x</span> <span class="main">≠</span> <span class="bound">x</span><span class="main">)</span><span class="main">}</span>"</span></span>

<span class="keyword1" id="Derangements-derangementsI"><span class="command">lemma</span></span> derangementsI<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="keyword1">permutes</span> <span class="free">S</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">⟹</span> <span class="free">p</span> <span class="bound">x</span> <span class="main">≠</span> <span class="bound">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> derangements <span class="free">S</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> derangements_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Derangements-derangementsE"><span class="command">lemma</span></span> derangementsE<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">:</span> derangements <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="keyword1">permutes</span> <span class="free">S</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span><span class="free">S</span><span class="main">.</span> <span class="free">d</span> <span class="bound">x</span> <span class="main">≠</span> <span class="bound">x</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> derangements_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Properties of Derangements›</span></span>

<span class="keyword1" id="Derangements-derangements_inv"><span class="command">lemma</span></span> derangements_inv<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> d<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">∈</span> derangements <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"inv <span class="free">d</span> <span class="main">∈</span> derangements <span class="free">S</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> derangementsI <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> derangementsE <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> permutes_inv permutes_inv_eq<span class="main">)</span>

<span class="keyword1" id="Derangements-derangements_in_image"><span class="command">lemma</span></span> derangements_in_image<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">∈</span> derangements <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="free">x</span> <span class="main">∈</span> <span class="free">A</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> derangementsE <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> permutes_in_image<span class="main">)</span>

<span class="keyword1" id="Derangements-derangements_in_image_strong"><span class="command">lemma</span></span> derangements_in_image_strong<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">∈</span> derangements <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="free">x</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">-</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> derangementsE <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> permutes_in_image<span class="main">)</span>

<span class="keyword1" id="Derangements-derangements_inverse_in_image"><span class="command">lemma</span></span> derangements_inverse_in_image<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">∈</span> derangements <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"inv <span class="free">d</span> <span class="free">x</span> <span class="main">∈</span> <span class="free">A</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> derangements_in_image derangements_inv<span class="main">)</span>

<span class="keyword1" id="Derangements-derangements_fixpoint"><span class="command">lemma</span></span> derangements_fixpoint<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">∈</span> derangements <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="free">x</span> <span class="main">=</span> <span class="free">x</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> derangementsE <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> permutes_def<span class="main">)</span>

<span class="keyword1" id="Derangements-derangements_no_fixpoint"><span class="command">lemma</span></span> derangements_no_fixpoint<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">∈</span> derangements <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="free">x</span> <span class="main">≠</span> <span class="free">x</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> derangementsE<span class="main">)</span>

<span class="keyword1" id="Derangements-finite_derangements"><span class="command">lemma</span></span> finite_derangements<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>derangements <span class="free">A</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> derangements_def
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> finite_permutations<span class="main">)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Construction of Derangements›</span></span>

<span class="keyword1" id="Derangements-derangements_empty"><span class="command">lemma</span></span> derangements_empty<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"derangements <span class="main">{}</span> <span class="main">=</span> <span class="main">{</span>id<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> derangements_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Derangements-derangements_singleton"><span class="command">lemma</span></span> derangements_singleton<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"derangements <span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> derangements_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Derangements-derangements_swap"><span class="command">lemma</span></span> derangements_swap<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">∈</span> derangements <span class="free">S</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> <span class="free">S</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∉</span> <span class="free">S</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≠</span> <span class="free">y</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Fun.swap <span class="free">x</span> <span class="free">y</span> <span class="free">d</span> <span class="main">∈</span> derangements <span class="main">(</span>insert <span class="free">x</span> <span class="main">(</span>insert <span class="free">y</span> <span class="free">S</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> derangementsI<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Fun.swap <span class="free">x</span> <span class="free">y</span> <span class="free">d</span> <span class="keyword1">permutes</span> <span class="main">(</span>insert <span class="free">x</span> <span class="main">(</span>insert <span class="free">y</span> <span class="free">S</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> permutes_swap <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> derangementsE<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="free">x</span> <span class="main">=</span> <span class="free">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="free">y</span> <span class="main">=</span> <span class="free">y</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> derangements_fixpoint<span class="main">)</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x'</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x'</span> <span class="main">:</span> insert <span class="free">x</span> <span class="main">(</span>insert <span class="free">y</span> <span class="free">S</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> s assms <span class="quoted"><span class="quoted">‹<span class="free">x</span> <span class="main">≠</span> <span class="free">y</span>›</span></span> this <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Fun.swap <span class="free">x</span> <span class="free">y</span> <span class="free">d</span> <span class="skolem">x'</span> <span class="main">≠</span> <span class="skolem">x'</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">x'</span> <span class="main">=</span> <span class="free">x</span>"</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">x'</span> <span class="main">=</span> <span class="free">y</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> derangements_no_fixpoint<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Derangements-derangements_skip_one"><span class="command">lemma</span></span> derangements_skip_one<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> d<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">∈</span> derangements <span class="free">S</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="free">S</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">(</span><span class="free">d</span> <span class="free">x</span><span class="main">)</span> <span class="main">≠</span> <span class="free">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">d</span><span class="main">(</span><span class="free">x</span> <span class="main">:=</span> <span class="free">x</span><span class="main">,</span> inv <span class="free">d</span> <span class="free">x</span> <span class="main">:=</span> <span class="free">d</span> <span class="free">x</span><span class="main">)</span> <span class="main">∈</span> derangements <span class="main">(</span><span class="free">S</span> <span class="main">-</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> d <span class="keyword1"><span class="command">have</span></span> bij<span class="main">:</span> <span class="quoted"><span class="quoted">"bij <span class="free">d</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> derangementsE <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> permutes_imp_bij'<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> d <span class="quoted"><span class="quoted">‹<span class="free">x</span> <span class="main">:</span> <span class="free">S</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> that<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="free">x</span> <span class="main">:</span> <span class="free">S</span> <span class="main">-</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> derangements_in_image derangements_no_fixpoint<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> d <span class="quoted"><span class="quoted">‹<span class="free">d</span> <span class="main">(</span><span class="free">d</span> <span class="free">x</span><span class="main">)</span> <span class="main">≠</span> <span class="free">x</span>›</span></span> bij <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x'</span><span class="main">∈</span><span class="free">S</span> <span class="main">-</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span><span class="main">.</span> <span class="main">(</span><span class="free">d</span><span class="main">(</span><span class="free">x</span> <span class="main">:=</span> <span class="free">x</span><span class="main">,</span> inv <span class="free">d</span> <span class="free">x</span> <span class="main">:=</span> <span class="free">d</span> <span class="free">x</span><span class="main">)</span><span class="main">)</span> <span class="bound">x'</span> <span class="main">≠</span> <span class="bound">x'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> derangementsE <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bij_inv_eq_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> d <span class="quoted"><span class="quoted">‹<span class="free">x</span> <span class="main">:</span> <span class="free">S</span>›</span></span> this <span class="keyword3"><span class="command">show</span></span> derangements<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">d</span><span class="main">(</span><span class="free">x</span><span class="main">:=</span><span class="free">x</span><span class="main">,</span> inv <span class="free">d</span> <span class="free">x</span><span class="main">:=</span> <span class="free">d</span> <span class="free">x</span><span class="main">)</span> <span class="main">:</span> derangements <span class="main">(</span><span class="free">S</span> <span class="main">-</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> derangementsE derangementsI permutations_skip_one<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Derangements-derangements_add_one"><span class="command">lemma</span></span> derangements_add_one<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">∈</span> derangements <span class="free">S</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> <span class="free">S</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∈</span> <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">d</span><span class="main">(</span><span class="free">x</span> <span class="main">:=</span> <span class="free">y</span><span class="main">,</span> inv <span class="free">d</span> <span class="free">y</span> <span class="main">:=</span> <span class="free">x</span><span class="main">)</span> <span class="main">∈</span> derangements <span class="main">(</span>insert <span class="free">x</span> <span class="free">S</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> derangementsI<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">d</span><span class="main">(</span><span class="free">x</span> <span class="main">:=</span> <span class="free">y</span><span class="main">,</span> inv <span class="free">d</span> <span class="free">y</span> <span class="main">:=</span> <span class="free">x</span><span class="main">)</span> <span class="keyword1">permutes</span> <span class="main">(</span>insert <span class="free">x</span> <span class="free">S</span><span class="main">)</span>"</span></span>
   <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> permutes_add_one <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> derangementsE<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">z</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">:</span> insert <span class="free">x</span> <span class="free">S</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> assms this derangements_inverse_in_image<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">y</span></span><span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">d</span><span class="main">(</span><span class="free">x</span> <span class="main">:=</span> <span class="free">y</span><span class="main">,</span> inv <span class="free">d</span> <span class="free">y</span> <span class="main">:=</span> <span class="free">x</span><span class="main">)</span><span class="main">)</span> <span class="skolem">z</span> <span class="main">≠</span> <span class="skolem">z</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> derangementsE<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Derangements-derangements_drop_minimal_cycle"><span class="command">lemma</span></span> derangements_drop_minimal_cycle<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">∈</span> derangements <span class="free">S</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">(</span><span class="free">d</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> <span class="free">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Fun.swap <span class="free">x</span> <span class="main">(</span><span class="free">d</span> <span class="free">x</span><span class="main">)</span> <span class="free">d</span> <span class="main">∈</span> derangements <span class="main">(</span><span class="free">S</span> <span class="main">-</span> <span class="main">{</span><span class="free">x</span><span class="main">,</span> <span class="free">d</span> <span class="free">x</span><span class="main">}</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> derangementsI<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Fun.swap <span class="free">x</span> <span class="main">(</span><span class="free">d</span> <span class="free">x</span><span class="main">)</span> <span class="free">d</span> <span class="keyword1">permutes</span> <span class="main">(</span><span class="free">S</span> <span class="main">-</span> <span class="main">{</span><span class="free">x</span><span class="main">,</span> <span class="free">d</span> <span class="free">x</span><span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> derangementsE permutes_drop_cycle_size_two<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">y</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">-</span> <span class="main">{</span><span class="free">x</span><span class="main">,</span> <span class="free">d</span> <span class="free">x</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> assms this <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Fun.swap <span class="free">x</span> <span class="main">(</span><span class="free">d</span> <span class="free">x</span><span class="main">)</span> <span class="free">d</span> <span class="skolem">y</span> <span class="main">≠</span> <span class="skolem">y</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> derangementsE<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Cardinality of Derangements›</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Recursive Characterization›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">count_derangements</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">count_derangements</span> <span class="main">0</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">count_derangements</span> <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">count_derangements</span> <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="free">count_derangements</span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">+</span> <span class="free">count_derangements</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Derangements-card_derangements"><span class="command">lemma</span></span> card_derangements<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">S</span>"</span></span> <span class="quoted"><span class="quoted">"card <span class="free">S</span> <span class="main">=</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>derangements <span class="free">S</span><span class="main">)</span> <span class="main">=</span> count_derangements <span class="free">n</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">S</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> count_derangements.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 1
  <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> 2
  <span class="keyword1"><span class="command">from</span></span> this derangements_singleton finite_derangements <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> Finite_Set.card_0_eq card_eq_SucD count_derangements.simps<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">n</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> 3<span class="main">(</span>4<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">S</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> card_eq_SucD insertI1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?D1</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">y</span><span class="main">,</span> <span class="bound">d</span><span class="main">)</span><span class="main">.</span> Fun.swap <span class="skolem">x</span> <span class="bound">y</span> <span class="bound">d</span><span class="main">)</span> <span class="main">`</span> <span class="main">{</span><span class="main">(</span><span class="bound">y</span><span class="main">,</span> <span class="bound">d</span><span class="main">)</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> <span class="skolem">S</span> <span class="main">&amp;</span> <span class="bound">y</span> <span class="main">≠</span> <span class="skolem">x</span> <span class="main">&amp;</span> <span class="bound">d</span> <span class="main">:</span> derangements <span class="main">(</span><span class="skolem">S</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">}</span><span class="main">)</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?D2</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">y</span><span class="main">,</span> <span class="bound">f</span><span class="main">)</span><span class="main">.</span> <span class="bound">f</span><span class="main">(</span><span class="skolem">x</span><span class="main">:=</span><span class="bound">y</span><span class="main">,</span> inv <span class="bound">f</span> <span class="bound">y</span> <span class="main">:=</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> <span class="main">(</span><span class="main">(</span><span class="skolem">S</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">x</span><span class="main">}</span><span class="main">)</span> <span class="main">×</span> derangements <span class="main">(</span><span class="skolem">S</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">x</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">S</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> subset1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?D1</span> <span class="main">⊆</span> derangements <span class="skolem">S</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">y</span> <span class="skolem">d</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> <span class="skolem">S</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">≠</span> <span class="skolem">x</span>"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> d<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">d</span> <span class="main">∈</span> derangements <span class="main">(</span><span class="skolem">S</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">y</span><span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">:</span> <span class="skolem">S</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">y</span> <span class="main">:</span> <span class="skolem">S</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> S<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">S</span> <span class="main">=</span> insert <span class="skolem">x</span> <span class="main">(</span>insert <span class="skolem">y</span> <span class="main">(</span><span class="skolem">S</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">y</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> d <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">:</span> <span class="skolem">S</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">y</span> <span class="main">:</span> <span class="skolem">S</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">y</span> <span class="main">≠</span> <span class="skolem">x</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Fun.swap <span class="skolem">x</span> <span class="skolem">y</span> <span class="skolem">d</span> <span class="main">∈</span> derangements <span class="skolem">S</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> S<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> derangements_swap<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">have</span></span> subset2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?D2</span> <span class="main">⊆</span> derangements <span class="skolem">S</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> subsetI<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> imageE<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.split_asm<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">erule</span> conjE<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">d</span> <span class="skolem">y</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">d</span> <span class="main">:</span> derangements <span class="main">(</span><span class="skolem">S</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">x</span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">:</span> <span class="skolem">S</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">≠</span> <span class="skolem">x</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> this <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">d</span><span class="main">(</span><span class="skolem">x</span> <span class="main">:=</span> <span class="skolem">y</span><span class="main">,</span> inv <span class="skolem">d</span> <span class="skolem">y</span> <span class="main">:=</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">∈</span> derangements <span class="main">(</span>insert <span class="skolem">x</span> <span class="main">(</span><span class="skolem">S</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">x</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> derangements_add_one<span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> this <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">:</span> <span class="skolem">S</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">d</span><span class="main">(</span><span class="skolem">x</span> <span class="main">:=</span> <span class="skolem">y</span><span class="main">,</span> inv <span class="skolem">d</span> <span class="skolem">y</span> <span class="main">:=</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">∈</span> derangements <span class="skolem">S</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> insert_Diff <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">have</span></span> split<span class="main">:</span> <span class="quoted"><span class="quoted">"derangements <span class="skolem">S</span> <span class="main">=</span> <span class="var">?D1</span> <span class="main">∪</span> <span class="var">?D2</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword1"><span class="command">from</span></span> subset1 subset2 <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?D1</span> <span class="main">∪</span> <span class="var">?D2</span> <span class="main">⊆</span> derangements <span class="skolem">S</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"derangements <span class="skolem">S</span> <span class="main">⊆</span> <span class="var">?D1</span> <span class="main">∪</span> <span class="var">?D2</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">d</span>
      <span class="keyword3"><span class="command">assume</span></span> d<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">d</span> <span class="main">:</span> derangements <span class="skolem">S</span>"</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">d</span> <span class="main">:</span> <span class="var">?D1</span> <span class="main">∪</span> <span class="var">?D2</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">d</span> <span class="main">(</span><span class="skolem">d</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">x</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> True
        <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">:</span> <span class="skolem">S</span>›</span></span> d <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">d</span> <span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">S</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">d</span> <span class="skolem">x</span> <span class="main">≠</span> <span class="skolem">x</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> derangements_in_image derangements_no_fixpoint<span class="main">)</span>
        <span class="keyword1"><span class="command">from</span></span> d True <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Fun.swap <span class="skolem">x</span> <span class="main">(</span><span class="skolem">d</span> <span class="skolem">x</span><span class="main">)</span> <span class="skolem">d</span> <span class="main">∈</span> derangements <span class="main">(</span><span class="skolem">S</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">d</span> <span class="skolem">x</span><span class="main">}</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> derangements_drop_minimal_cycle<span class="main">)</span>
        <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">d</span> <span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">S</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">d</span> <span class="skolem">x</span> <span class="main">≠</span> <span class="skolem">x</span>›</span></span> this <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">d</span> <span class="main">:</span> <span class="var">?D1</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> image_eqI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">d</span> <span class="skolem">x</span><span class="main">,</span> Fun.swap <span class="skolem">x</span> <span class="main">(</span><span class="skolem">d</span> <span class="skolem">x</span><span class="main">)</span> <span class="skolem">d</span><span class="main">)</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> False
        <span class="keyword1"><span class="command">from</span></span> d <span class="keyword1"><span class="command">have</span></span> bij<span class="main">:</span> <span class="quoted"><span class="quoted">"bij <span class="skolem">d</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> derangementsE <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> permutes_imp_bij'<span class="main">)</span>
        <span class="keyword1"><span class="command">from</span></span> d <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">:</span> <span class="skolem">S</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> that<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">d</span> <span class="skolem">x</span> <span class="main">:</span> <span class="skolem">S</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">x</span><span class="main">}</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> derangements_in_image_strong<span class="main">)</span>
        <span class="keyword1"><span class="command">from</span></span> d <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">:</span> <span class="skolem">S</span>›</span></span> False <span class="keyword1"><span class="command">have</span></span> derangements<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">d</span><span class="main">(</span><span class="skolem">x</span><span class="main">:=</span><span class="skolem">x</span><span class="main">,</span> inv <span class="skolem">d</span> <span class="skolem">x</span><span class="main">:=</span> <span class="skolem">d</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">:</span> derangements <span class="main">(</span><span class="skolem">S</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">x</span><span class="main">}</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> derangements_skip_one<span class="main">)</span>
        <span class="keyword1"><span class="command">from</span></span> this <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bij <span class="main">(</span><span class="skolem">d</span><span class="main">(</span><span class="skolem">x</span> <span class="main">:=</span> <span class="skolem">x</span><span class="main">,</span> inv <span class="skolem">d</span> <span class="skolem">x</span><span class="main">:=</span> <span class="skolem">d</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> derangementsE permutes_imp_bij'<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
        <span class="keyword1"><span class="command">from</span></span> this <span class="keyword1"><span class="command">have</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"inv <span class="main">(</span><span class="skolem">d</span><span class="main">(</span><span class="skolem">x</span> <span class="main">:=</span> <span class="skolem">x</span><span class="main">,</span> inv <span class="skolem">d</span> <span class="skolem">x</span> <span class="main">:=</span> <span class="skolem">d</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">d</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">=</span> inv <span class="skolem">d</span> <span class="skolem">x</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> bij_inv_eq_iff fun_upd_same<span class="main">)</span>
        <span class="keyword1"><span class="command">from</span></span> bij <span class="keyword1"><span class="command">have</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">d</span> <span class="main">(</span>inv <span class="skolem">d</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> bij_inv_eq_iff<span class="main">)</span>
        <span class="keyword1"><span class="command">from</span></span> d derangements_inv<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">d</span></span><span class="main">]</span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">:</span> <span class="skolem">S</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"inv <span class="skolem">d</span> <span class="skolem">x</span> <span class="main">≠</span> <span class="skolem">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">d</span> <span class="skolem">x</span> <span class="main">≠</span> <span class="skolem">x</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> derangements_no_fixpoint<span class="main">)</span>
        <span class="keyword1"><span class="command">from</span></span> this a x <span class="keyword1"><span class="command">have</span></span> d_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">d</span> <span class="main">=</span> <span class="skolem">d</span><span class="main">(</span>inv <span class="skolem">d</span> <span class="skolem">x</span> <span class="main">:=</span> <span class="skolem">d</span> <span class="skolem">x</span><span class="main">,</span> <span class="skolem">x</span> <span class="main">:=</span> <span class="skolem">d</span> <span class="skolem">x</span><span class="main">,</span> inv <span class="main">(</span><span class="skolem">d</span><span class="main">(</span><span class="skolem">x</span> <span class="main">:=</span> <span class="skolem">x</span><span class="main">,</span> inv <span class="skolem">d</span> <span class="skolem">x</span> <span class="main">:=</span> <span class="skolem">d</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">d</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">:=</span> <span class="skolem">x</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">from</span></span> derangements that <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">d</span> <span class="skolem">x</span><span class="main">,</span> <span class="skolem">d</span><span class="main">(</span><span class="skolem">x</span><span class="main">:=</span><span class="skolem">x</span><span class="main">,</span> inv <span class="skolem">d</span> <span class="skolem">x</span><span class="main">:=</span><span class="skolem">d</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span> <span class="main">:</span> <span class="main">(</span><span class="main">(</span><span class="skolem">S</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">x</span><span class="main">}</span><span class="main">)</span> <span class="main">×</span> derangements <span class="main">(</span><span class="skolem">S</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">x</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">from</span></span> d_eq this <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">d</span> <span class="main">:</span> <span class="var">?D2</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> image_eqI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">d</span> <span class="skolem">x</span><span class="main">,</span> <span class="skolem">d</span><span class="main">(</span><span class="skolem">x</span><span class="main">:=</span><span class="skolem">x</span><span class="main">,</span> inv <span class="skolem">d</span> <span class="skolem">x</span><span class="main">:=</span><span class="skolem">d</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">have</span></span> no_intersect<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?D1</span> <span class="main">∩</span> <span class="var">?D2</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> that<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">d</span><span class="main">.</span> <span class="bound">d</span> <span class="main">∈</span> <span class="var">?D1</span> <span class="main">⟹</span> <span class="bound">d</span> <span class="main">(</span><span class="bound">d</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">x</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Diff_iff Diff_insert2 derangements_fixpoint insertI1 swap_apply<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">d</span><span class="main">.</span> <span class="bound">d</span> <span class="main">∈</span> <span class="var">?D2</span> <span class="main">⟹</span> <span class="bound">d</span> <span class="main">(</span><span class="bound">d</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">≠</span> <span class="skolem">x</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">d</span>
      <span class="keyword3"><span class="command">assume</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">d</span> <span class="main">∈</span> <span class="var">?D2</span>"</span></span>
      <span class="keyword1"><span class="command">from</span></span> a <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="skolem"><span class="skolem">d'</span></span> <span class="keyword2"><span class="keyword">where</span></span> d<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">d</span> <span class="main">=</span> <span class="skolem">d'</span><span class="main">(</span><span class="skolem">x</span> <span class="main">:=</span> <span class="skolem">y</span><span class="main">,</span> inv <span class="skolem">d'</span> <span class="skolem">y</span> <span class="main">:=</span> <span class="skolem">x</span><span class="main">)</span>"</span></span>
        <span class="quoted"><span class="quoted">"<span class="skolem">d'</span> <span class="main">∈</span> derangements <span class="main">(</span><span class="skolem">S</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">x</span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> <span class="skolem">S</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">x</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">from</span></span> d<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> inv<span class="main">:</span> <span class="quoted"><span class="quoted">"inv <span class="skolem">d'</span> <span class="main">∈</span> derangements <span class="main">(</span><span class="skolem">S</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">x</span><span class="main">}</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> derangements_inv<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> d <span class="keyword1"><span class="command">have</span></span> inv_x<span class="main">:</span> <span class="quoted"><span class="quoted">"inv <span class="skolem">d'</span> <span class="skolem">y</span> <span class="main">≠</span> <span class="skolem">x</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> derangements_inverse_in_image<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> inv <span class="keyword1"><span class="command">have</span></span> inv_y<span class="main">:</span> <span class="quoted"><span class="quoted">"inv <span class="skolem">d'</span> <span class="skolem">y</span> <span class="main">≠</span> <span class="skolem">y</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> d<span class="main">(</span>3<span class="main">)</span> derangements_no_fixpoint <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">from</span></span> d inv_x <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">d</span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">from</span></span> d inv_y <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">d</span> <span class="skolem">y</span> <span class="main">=</span> <span class="skolem">d'</span> <span class="skolem">y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">from</span></span> d<span class="main">(</span>2<span class="main">,</span> 3<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">d'</span> <span class="skolem">y</span> <span class="main">∈</span> <span class="skolem">S</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">x</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> derangements_in_image<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> 1 2 3 <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">d</span> <span class="main">(</span><span class="skolem">d</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">≠</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">from</span></span> this that <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">have</span></span> inj<span class="main">:</span> <span class="quoted"><span class="quoted">"inj_on <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">y</span><span class="main">,</span> <span class="bound">f</span><span class="main">)</span><span class="main">.</span> Fun.swap <span class="skolem">x</span> <span class="bound">y</span> <span class="bound">f</span><span class="main">)</span> <span class="main">{</span><span class="main">(</span><span class="bound">y</span><span class="main">,</span> <span class="bound">f</span><span class="main">)</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> <span class="skolem">S</span> <span class="main">&amp;</span> <span class="bound">y</span> <span class="main">≠</span> <span class="skolem">x</span> <span class="main">&amp;</span> <span class="bound">f</span> <span class="main">:</span> derangements <span class="main">(</span><span class="skolem">S</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">}</span><span class="main">)</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> inj_on_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">clarify</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">metis</span> DiffD2 derangements_fixpoint insertI1 insert_commute swap_apply<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> swap_nilpotent<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">(</span><span class="bound">y</span><span class="main">,</span> <span class="bound">f</span><span class="main">)</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> <span class="skolem">S</span> <span class="main">&amp;</span> <span class="bound">y</span> <span class="main">≠</span> <span class="skolem">x</span> <span class="main">&amp;</span> <span class="bound">f</span> <span class="main">:</span> derangements <span class="main">(</span><span class="skolem">S</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">}</span><span class="main">)</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="main">(</span><span class="bound">y</span><span class="main">,</span> <span class="bound">f</span><span class="main">)</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> <span class="skolem">S</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">x</span><span class="main">}</span> <span class="main">&amp;</span> <span class="bound">f</span> <span class="main">:</span> derangements <span class="main">(</span><span class="skolem">S</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">}</span><span class="main">)</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> eq'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">(</span><span class="bound">y</span><span class="main">,</span> <span class="bound">f</span><span class="main">)</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> <span class="skolem">S</span> <span class="main">&amp;</span> <span class="bound">y</span> <span class="main">≠</span> <span class="skolem">x</span> <span class="main">&amp;</span> <span class="bound">f</span> <span class="main">:</span> derangements <span class="main">(</span><span class="skolem">S</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">}</span><span class="main">)</span><span class="main">}</span> <span class="main">=</span> Sigma <span class="main">(</span><span class="skolem">S</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">x</span><span class="main">}</span><span class="main">)</span> <span class="main">(</span><span class="main">%</span><span class="bound">y</span><span class="main">.</span> derangements <span class="main">(</span><span class="skolem">S</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> Sigma_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> card<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> <span class="skolem">S</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">x</span><span class="main">}</span> <span class="main">⟹</span> card <span class="main">(</span>derangements <span class="main">(</span><span class="skolem">S</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">}</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> count_derangements <span class="skolem">n</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">y</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> <span class="skolem">S</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">x</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> 3<span class="main">(</span>3<span class="main">,</span> 4<span class="main">)</span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">S</span>›</span></span> this <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span><span class="skolem">S</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">y</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">n</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Diff_insert2 card_Diff_singleton diff_Suc_1 finite_Diff<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> 3<span class="main">(</span>3<span class="main">)</span> 3<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> _ this<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>derangements <span class="main">(</span><span class="skolem">S</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">y</span><span class="main">}</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> count_derangements <span class="skolem">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">from</span></span> 3<span class="main">(</span>3<span class="main">,</span> 4<span class="main">)</span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">:</span> <span class="skolem">S</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> card2<span class="main">:</span> <span class="quoted"><span class="quoted">"card <span class="main">(</span><span class="skolem">S</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">x</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> Suc <span class="skolem">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> card.insert_remove insert_absorb<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> inj <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="var">?D1</span> <span class="main">=</span> card <span class="main">{</span><span class="main">(</span><span class="bound">y</span><span class="main">,</span> <span class="bound">f</span><span class="main">)</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> <span class="skolem">S</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">x</span><span class="main">}</span> <span class="main">∧</span> <span class="bound">f</span> <span class="main">∈</span> derangements <span class="main">(</span><span class="skolem">S</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">}</span><span class="main">)</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> card_image<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> 3<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">y</span><span class="main">∈</span><span class="skolem">S</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">x</span><span class="main">}</span><span class="main">.</span> card <span class="main">(</span>derangements <span class="main">(</span><span class="skolem">S</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">}</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> card_product_dependent<span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> finite_derangements<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> card_1<span class="main">:</span> <span class="quoted"><span class="quoted">"card <span class="var">?D1</span> <span class="main">=</span><span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="main">*</span> count_derangements <span class="skolem">n</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> card card2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> inj_2<span class="main">:</span> <span class="quoted"><span class="quoted">"inj_on <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">y</span><span class="main">,</span> <span class="bound">f</span><span class="main">)</span><span class="main">.</span> <span class="bound">f</span><span class="main">(</span><span class="skolem">x</span> <span class="main">:=</span> <span class="bound">y</span><span class="main">,</span> inv <span class="bound">f</span> <span class="bound">y</span> <span class="main">:=</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="skolem">S</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">x</span><span class="main">}</span><span class="main">)</span> <span class="main">×</span> derangements <span class="main">(</span><span class="skolem">S</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">x</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">d</span> <span class="skolem">d'</span> <span class="skolem">y</span> <span class="skolem">y'</span>
      <span class="keyword3"><span class="command">assume</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">d</span> <span class="main">∈</span> derangements <span class="main">(</span><span class="skolem">S</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">x</span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">d'</span> <span class="main">∈</span> derangements <span class="main">(</span><span class="skolem">S</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">x</span><span class="main">}</span><span class="main">)</span>"</span></span>
      <span class="keyword3"><span class="command">assume</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> <span class="skolem">S</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">≠</span> <span class="skolem">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y'</span> <span class="main">∈</span> <span class="skolem">S</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y'</span> <span class="main">≠</span> <span class="skolem">x</span>"</span></span>
      <span class="keyword3"><span class="command">assume</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">d</span><span class="main">(</span><span class="skolem">x</span> <span class="main">:=</span> <span class="skolem">y</span><span class="main">,</span> inv <span class="skolem">d</span> <span class="skolem">y</span> <span class="main">:=</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">d'</span><span class="main">(</span><span class="skolem">x</span> <span class="main">:=</span> <span class="skolem">y'</span><span class="main">,</span> inv <span class="skolem">d'</span> <span class="skolem">y'</span> <span class="main">:=</span> <span class="skolem">x</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">from</span></span> 1 2 eq <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">S</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> y<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">=</span> <span class="skolem">y'</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Diff_insert_absorb derangements_in_image derangements_inv
          fun_upd_same fun_upd_twist insert_iff mk_disjoint_insert<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">d</span> <span class="main">=</span> <span class="skolem">d'</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">z</span>
        <span class="keyword1"><span class="command">from</span></span> 1 <span class="keyword1"><span class="command">have</span></span> d_x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">d</span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">d'</span> <span class="skolem">x</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> derangements_fixpoint<span class="main">)</span>
        <span class="keyword1"><span class="command">from</span></span> 1 <span class="keyword1"><span class="command">have</span></span> bij<span class="main">:</span> <span class="quoted"><span class="quoted">"bij <span class="skolem">d</span>"</span></span> <span class="quoted"><span class="quoted">"bij <span class="skolem">d'</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> derangementsE permutes_imp_bij'<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
        <span class="keyword1"><span class="command">from</span></span> this <span class="keyword1"><span class="command">have</span></span> d_d<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">d</span> <span class="main">(</span>inv <span class="skolem">d</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">y</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">d'</span> <span class="main">(</span>inv <span class="skolem">d'</span> <span class="skolem">y'</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">y'</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bij_is_surj surj_f_inv_f<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
        <span class="keyword1"><span class="command">from</span></span> 1 2 bij <span class="keyword1"><span class="command">have</span></span> neq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">d</span> <span class="main">(</span>inv <span class="skolem">d'</span> <span class="skolem">y'</span><span class="main">)</span> <span class="main">≠</span> <span class="skolem">x</span> <span class="main">∧</span> <span class="skolem">d'</span> <span class="main">(</span>inv <span class="skolem">d</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">≠</span> <span class="skolem">x</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Diff_iff bij_inv_eq_iff derangements_fixpoint singletonI<span class="main">)</span>
        <span class="keyword1"><span class="command">from</span></span> eq <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">d</span><span class="main">(</span><span class="skolem">x</span> <span class="main">:=</span> <span class="skolem">y</span><span class="main">,</span> inv <span class="skolem">d</span> <span class="skolem">y</span> <span class="main">:=</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span> <span class="skolem">z</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">d'</span><span class="main">(</span><span class="skolem">x</span> <span class="main">:=</span> <span class="skolem">y'</span><span class="main">,</span> inv <span class="skolem">d'</span> <span class="skolem">y'</span> <span class="main">:=</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span> <span class="skolem">z</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">from</span></span> y d_x d_d neq this <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">d</span> <span class="skolem">z</span> <span class="main">=</span> <span class="skolem">d'</span> <span class="skolem">z</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">from</span></span> y this <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">=</span> <span class="skolem">y'</span> <span class="main">&amp;</span> <span class="skolem">d</span> <span class="main">=</span> <span class="skolem">d'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> inj_on_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">from</span></span> 3<span class="main">(</span>3<span class="main">)</span> 3<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> _ card2<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> card3<span class="main">:</span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>derangements <span class="main">(</span><span class="skolem">S</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">x</span><span class="main">}</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> count_derangements <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> 3<span class="main">(</span>3<span class="main">)</span> inj_2 <span class="keyword1"><span class="command">have</span></span> card_2<span class="main">:</span> <span class="quoted"><span class="quoted">"card <span class="var">?D2</span> <span class="main">=</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="main">*</span> count_derangements <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> card_image<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> card_cartesian_product card3 card2<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹finite <span class="skolem">S</span>›</span></span><span class="keyword1"><span class="command">have</span></span> finite1<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="var">?D1</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> eq' <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> finite_derangements<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹finite <span class="skolem">S</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> finite2<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="var">?D2</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> finite_cartesian_product finite_derangements<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> split card_Un_disjoint finite1 finite2 no_intersect card_1 card_2 <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Closed-Form Characterization›</span></span>

<span class="keyword1" id="Derangements-count_derangements"><span class="command">lemma</span></span> count_derangements<span class="main">:</span>
  <span class="quoted"><span class="quoted">"real <span class="main">(</span>count_derangements <span class="free">n</span><span class="main">)</span> <span class="main">=</span> fact <span class="free">n</span> <span class="main">*</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="free">n</span><span class="main">}</span><span class="main">.</span> <span class="main">(</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">^</span> <span class="bound">k</span> <span class="main">/</span> fact <span class="bound">k</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> count_derangements.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">n</span><span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?f</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">n</span><span class="main">.</span> fact <span class="bound">n</span> <span class="main">*</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span> <span class="main">=</span> <span class="main">0</span><span class="main">..</span><span class="bound">n</span><span class="main">.</span> <span class="main">(</span><span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">^</span> <span class="bound">k</span> <span class="main">/</span> fact <span class="bound">k</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"real <span class="main">(</span>count_derangements <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span>count_derangements <span class="main">(</span><span class="skolem">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">+</span> count_derangements <span class="skolem">n</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> count_derangements.simps <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> real <span class="main">(</span><span class="skolem">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span>real <span class="main">(</span>count_derangements <span class="main">(</span><span class="skolem">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> real <span class="main">(</span>count_derangements <span class="skolem">n</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> of_nat_mult of_nat_add<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="var">?f</span> <span class="main">(</span><span class="skolem">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">+</span> <span class="var">?f</span> <span class="skolem">n</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> 3<span class="main">(</span>2<span class="main">)</span> 3<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> Suc_eq_plus1<span class="main">]</span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="var">?f</span> <span class="main">(</span><span class="skolem">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">+</span> <span class="var">?f</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">=</span> <span class="var">?f</span> <span class="main">(</span><span class="skolem">n</span> <span class="main">+</span> <span class="numeral">2</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">f</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="skolem">n</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span>fact <span class="skolem">n</span><span class="main">)</span> <span class="main">::</span> real<span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span> <span class="main">=</span> <span class="main">0</span><span class="main">..</span><span class="skolem">n</span><span class="main">.</span> <span class="main">(</span><span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">^</span> <span class="bound">k</span> <span class="main">/</span> fact <span class="bound">k</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">n</span>
    <span class="keyword1"><span class="command">have</span></span> f_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">n</span><span class="main">.</span> <span class="skolem">f</span> <span class="main">(</span><span class="bound">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="bound">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">f</span> <span class="bound">n</span> <span class="main">+</span> <span class="main">(</span><span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">^</span> <span class="main">(</span><span class="bound">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">n</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?f</span> <span class="main">(</span><span class="skolem">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> fact <span class="skolem">n</span> <span class="main">*</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span> <span class="main">=</span> <span class="main">0</span><span class="main">..</span><span class="skolem">n</span><span class="main">.</span> <span class="main">(</span><span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">^</span> <span class="bound">k</span> <span class="main">/</span> fact <span class="bound">k</span><span class="main">)</span> <span class="main">+</span> fact <span class="main">(</span><span class="skolem">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span><span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">^</span> <span class="main">(</span><span class="skolem">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">/</span> fact <span class="main">(</span><span class="skolem">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="var">?f</span> <span class="skolem">n</span> <span class="main">+</span> <span class="main">(</span><span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">^</span> <span class="main">(</span><span class="skolem">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> One_nat_def<span class="main">)</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?thesis</span> <span class="skolem">n</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> f_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">from</span></span> this <span class="keyword1"><span class="command">have</span></span> f_eq'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">n</span><span class="main">.</span> <span class="main">(</span><span class="bound">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">f</span> <span class="bound">n</span> <span class="main">=</span> <span class="skolem">f</span> <span class="main">(</span><span class="bound">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">^</span> <span class="bound">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> f_eq'<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">n</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="skolem">f</span> <span class="main">(</span><span class="skolem">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">+</span> <span class="skolem">f</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="skolem">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">f</span> <span class="main">(</span><span class="skolem">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="skolem">f</span> <span class="main">(</span><span class="skolem">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">^</span> <span class="skolem">n</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> distrib_left of_nat_add of_nat_1<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">n</span> <span class="main">+</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">f</span> <span class="main">(</span><span class="skolem">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">^</span> <span class="main">(</span><span class="skolem">n</span> <span class="main">+</span> <span class="numeral">2</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> One_nat_def add_2_eq_Suc' <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> f_eq<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">+</span> <span class="main">1</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="skolem">f</span> <span class="main">(</span><span class="skolem">n</span> <span class="main">+</span> <span class="numeral">2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> f_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Approximation of Cardinality›</span></span>

<span class="keyword1" id="Derangements-two_power_fact_le_fact"><span class="command">lemma</span></span> two_power_fact_le_fact<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">≥</span> <span class="main">1</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="numeral">2</span><span class="main">^</span><span class="free">k</span> <span class="main">*</span> fact <span class="free">n</span> <span class="main">≤</span> <span class="main">(</span>fact <span class="main">(</span><span class="free">n</span> <span class="main">+</span> <span class="free">k</span><span class="main">)</span> <span class="main">::</span> <span class="tfree">'a</span> <span class="main">::</span> <span class="main">{</span>semiring_char_0<span class="main">,</span>linordered_semidom<span class="main">}</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">k</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">^</span> Suc <span class="skolem">k</span> <span class="main">*</span> fact <span class="free">n</span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">*</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="skolem">k</span> <span class="main">*</span> fact <span class="free">n</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">note</span></span> Suc.IH
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"of_nat <span class="main">1</span> <span class="main">+</span> of_nat <span class="main">1</span> <span class="main">≤</span> of_nat <span class="free">n</span> <span class="main">+</span> <span class="main">(</span>of_nat <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span> <span class="main">::</span> <span class="tfree">'a</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> add_mono<span class="main">)</span> <span class="main">(</span><span class="operator">unfold</span> of_nat_le_iff<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">*</span> <span class="main">(</span>fact <span class="main">(</span><span class="free">n</span> <span class="main">+</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">::</span> <span class="tfree">'a</span><span class="main">)</span> <span class="main">≤</span> of_nat <span class="main">(</span><span class="free">n</span> <span class="main">+</span> Suc <span class="skolem">k</span><span class="main">)</span> <span class="main">*</span> fact <span class="main">(</span><span class="free">n</span> <span class="main">+</span> <span class="skolem">k</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> mult_right_mono<span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> add_ac<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> fact <span class="main">(</span><span class="free">n</span> <span class="main">+</span> Suc <span class="skolem">k</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">-</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mult_left_mono<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp_all</span>

<span class="keyword1" id="Derangements-exp1_approx"><span class="command">lemma</span></span> exp1_approx<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"exp <span class="main">(</span><span class="main">1</span><span class="main">::</span>real<span class="main">)</span> <span class="main">-</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span><span class="main">&lt;</span><span class="free">n</span><span class="main">.</span> <span class="main">1</span> <span class="main">/</span> fact <span class="bound">k</span><span class="main">)</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="numeral">2</span> <span class="main">/</span> fact <span class="free">n</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">unfold</span> atLeastAtMost_iff<span class="main"><span class="keyword3">,</span></span> <span class="operator">safe</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> <span class="main">1</span><span class="main">^</span><span class="bound">k</span> <span class="main">/</span> fact <span class="bound">k</span><span class="main">)</span> <span class="keyword1">sums</span> exp <span class="main">(</span><span class="main">1</span><span class="main">::</span>real<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> exp_converges<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">1</span><span class="main">::</span>real"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> sums_split_initial_segment<span class="main">[</span><span class="operator">OF</span> this<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">n</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> sums<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> <span class="main">1</span> <span class="main">/</span> fact <span class="main">(</span><span class="free">n</span><span class="main">+</span><span class="bound">k</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">sums</span> <span class="main">(</span>exp <span class="main">1</span> <span class="main">-</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span><span class="main">&lt;</span><span class="free">n</span><span class="main">.</span> <span class="main">1</span> <span class="main">/</span> fact <span class="bound">k</span> <span class="main">::</span> real<span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>  <span class="dynamic"><span class="dynamic">algebra_simps</span></span> power_add<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>exp <span class="main">1</span> <span class="main">-</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span><span class="main">&lt;</span><span class="free">n</span><span class="main">.</span> <span class="main">1</span> <span class="main">/</span> fact <span class="bound">k</span> <span class="main">::</span> real<span class="main">)</span><span class="main">)</span> <span class="main">≥</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> sums_le<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ sums_zero sums<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>exp <span class="main">1</span> <span class="main">-</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span><span class="main">&lt;</span><span class="free">n</span><span class="main">.</span> <span class="main">1</span> <span class="main">/</span> fact <span class="bound">k</span> <span class="main">::</span> real<span class="main">)</span><span class="main">)</span> <span class="main">≤</span> <span class="numeral">2</span> <span class="main">/</span> fact <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> sums_le<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> <span class="main">(</span><span class="main">1</span> <span class="main">/</span> fact <span class="free">n</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">1</span> <span class="main">/</span> <span class="numeral">2</span><span class="main">)</span><span class="main">^</span><span class="bound">k</span> <span class="main">::</span> real<span class="main">)</span> <span class="keyword1">sums</span> <span class="main">(</span><span class="main">(</span><span class="main">1</span> <span class="main">/</span> fact <span class="free">n</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">1</span> <span class="main">/</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="main">1</span> <span class="main">/</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> sums_mult geometric_sums<span class="main">)</span> <span class="operator">simp_all</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">/</span> fact <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> <span class="main">1</span> <span class="main">/</span> fact <span class="free">n</span> <span class="main">*</span> <span class="main">(</span><span class="main">1</span> <span class="main">/</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">^</span> <span class="bound">k</span><span class="main">)</span> <span class="keyword1">sums</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">/</span> fact <span class="free">n</span> <span class="main">::</span> real<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">k</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">1</span> <span class="main">/</span> fact <span class="main">(</span><span class="free">n</span><span class="main">+</span><span class="skolem">k</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> <span class="main">(</span><span class="main">1</span> <span class="main">/</span> fact <span class="free">n</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">1</span> <span class="main">/</span> <span class="numeral">2</span> <span class="main">::</span> real<span class="main">)</span><span class="main">^</span><span class="skolem">k</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">k</span>
      <span class="keyword1"><span class="command">using</span></span> two_power_fact_le_fact<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="skolem">k</span></span><span class="main">]</span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">fact</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Derangements-exp1_bounds"><span class="command">lemma</span></span> exp1_bounds<span class="main">:</span> <span class="quoted"><span class="quoted">"exp <span class="main">1</span> <span class="main">∈</span> <span class="main">{</span><span class="numeral">8</span> <span class="main">/</span> <span class="numeral">3</span><span class="main">..</span><span class="numeral">11</span> <span class="main">/</span> <span class="numeral">4</span> <span class="main">::</span> real<span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> exp1_approx<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="numeral">4</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eval_nat_numeral<span class="main">)</span>

<span class="keyword1" id="Derangements-count_derangements_approximation"><span class="command">lemma</span></span> count_derangements_approximation<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"abs<span class="main">(</span>real <span class="main">(</span>count_derangements <span class="free">n</span><span class="main">)</span> <span class="main">-</span> fact <span class="free">n</span> <span class="main">/</span> exp <span class="main">1</span><span class="main">)</span> <span class="main">&lt;</span> <span class="main">1</span> <span class="main">/</span> <span class="numeral">2</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">≥</span> <span class="numeral">5</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">from</span></span> assms this <span class="keyword1"><span class="command">have</span></span> n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">=</span> <span class="main">1</span> <span class="main">∨</span> <span class="free">n</span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">∨</span> <span class="free">n</span> <span class="main">=</span> <span class="numeral">3</span> <span class="main">∨</span> <span class="free">n</span> <span class="main">=</span> <span class="numeral">4</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> exp1_bounds <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"abs<span class="main">(</span>real <span class="main">(</span>count_derangements <span class="main">1</span><span class="main">)</span> <span class="main">-</span> fact <span class="main">1</span> <span class="main">/</span> exp <span class="main">1</span><span class="main">)</span> <span class="main">&lt;</span> <span class="main">1</span> <span class="main">/</span> <span class="numeral">2</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> exp1_bounds <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"abs<span class="main">(</span>real <span class="main">(</span>count_derangements <span class="numeral">2</span><span class="main">)</span> <span class="main">-</span> fact <span class="numeral">2</span> <span class="main">/</span> exp <span class="main">1</span><span class="main">)</span> <span class="main">&lt;</span> <span class="main">1</span> <span class="main">/</span> <span class="numeral">2</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eval_nat_numeral abs_real_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> exp1_bounds <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"abs<span class="main">(</span>real <span class="main">(</span>count_derangements <span class="numeral">3</span><span class="main">)</span> <span class="main">-</span> fact <span class="numeral">3</span> <span class="main">/</span> exp <span class="main">1</span><span class="main">)</span> <span class="main">&lt;</span> <span class="main">1</span> <span class="main">/</span> <span class="numeral">2</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eval_nat_numeral abs_if <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> exp1_bounds <span class="keyword1"><span class="command">have</span></span> 4<span class="main">:</span> <span class="quoted"><span class="quoted">"abs<span class="main">(</span>real <span class="main">(</span>count_derangements <span class="numeral">4</span><span class="main">)</span> <span class="main">-</span> fact <span class="numeral">4</span> <span class="main">/</span> exp <span class="main">1</span><span class="main">)</span> <span class="main">&lt;</span> <span class="main">1</span> <span class="main">/</span> <span class="numeral">2</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> abs_if <span class="dynamic"><span class="dynamic">field_simps</span></span> eval_nat_numeral<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> 1 2 3 4 n <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword1"><span class="command">from</span></span> Maclaurin_exp_le<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">-</span> <span class="main">1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">+</span> <span class="main">1</span>"</span></span><span class="main">]</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t</span></span> <span class="keyword2"><span class="keyword">where</span></span> t<span class="main">:</span> <span class="quoted"><span class="quoted">"abs <span class="main">(</span><span class="skolem">t</span> <span class="main">::</span> real<span class="main">)</span> <span class="main">≤</span> abs <span class="main">(</span><span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> exp<span class="main">:</span> <span class="quoted"><span class="quoted">"exp <span class="main">(</span><span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">m</span><span class="main">&lt;</span><span class="free">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">.</span> <span class="main">(</span><span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">^</span> <span class="bound">m</span> <span class="main">/</span> fact <span class="bound">m</span><span class="main">)</span> <span class="main">+</span> exp <span class="skolem">t</span> <span class="main">/</span> fact <span class="main">(</span><span class="free">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">^</span> <span class="main">(</span><span class="free">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> exp <span class="keyword1"><span class="command">have</span></span> sum_eq_exp<span class="main">:</span> 
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">k</span> <span class="main">=</span> <span class="main">0</span><span class="main">..</span><span class="free">n</span><span class="main">.</span> <span class="main">(</span><span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">^</span> <span class="bound">k</span> <span class="main">/</span> fact <span class="bound">k</span><span class="main">)</span> <span class="main">=</span> exp <span class="main">(</span><span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">-</span> exp <span class="skolem">t</span> <span class="main">/</span> fact <span class="main">(</span><span class="free">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">^</span> <span class="main">(</span><span class="free">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> atLeast0AtMost ivl_disj_un<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> fact_plus1<span class="main">:</span> <span class="quoted"><span class="quoted">"fact <span class="main">(</span><span class="free">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> fact <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¦</span>real <span class="main">(</span>count_derangements <span class="free">n</span><span class="main">)</span> <span class="main">-</span> fact <span class="free">n</span> <span class="main">/</span> exp <span class="main">1</span><span class="main">¦</span> <span class="main">=</span> exp <span class="skolem">t</span> <span class="main">/</span> <span class="main">(</span><span class="free">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> One_nat_def 
             <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> count_derangements sum_eq_exp exp_minus inverse_eq_divide <span class="dynamic"><span class="dynamic">algebra_simps</span></span> abs_mult<span class="main">)</span>
       <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fact_plus1<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> t <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"exp <span class="skolem">t</span> <span class="main">≤</span> exp <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> exp1_bounds <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">&lt;</span> <span class="numeral">3</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">n</span> <span class="main">≥</span> <span class="numeral">5</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eq<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">theorem</span></span> derangements_formula<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">S</span>"</span></span> <span class="quoted"><span class="quoted">"card <span class="free">S</span> <span class="main">=</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"int <span class="main">(</span>card <span class="main">(</span>derangements <span class="free">S</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> round <span class="main">(</span>fact <span class="free">n</span> <span class="main">/</span> exp <span class="main">1</span> <span class="main">::</span> real<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> count_derangements_approximation<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">n</span></span><span class="main">]</span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> round_unique' <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> card_derangements abs_minus_commute<span class="main">)</span>

<span class="keyword1"><span class="command">theorem</span></span> derangements_formula'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">S</span>"</span></span> <span class="quoted"><span class="quoted">"card <span class="free">S</span> <span class="main">=</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>derangements <span class="free">S</span><span class="main">)</span> <span class="main">=</span> nat <span class="main">(</span>round <span class="main">(</span>fact <span class="free">n</span> <span class="main">/</span> exp <span class="main">1</span> <span class="main">::</span> real<span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> derangements_formula<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div>