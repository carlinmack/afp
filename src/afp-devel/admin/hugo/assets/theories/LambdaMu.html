<div id="Syntax">
<div class="head">
<h1>Theory Syntax</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹The $\lambda\mu$-calculus›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹More examples, as well as a call-by-value programming language built on
top of our formalisation, can be found in an associated Bitbucket repository~\cite{bitbucket}.›</span></span>
  
<span class="keyword1"><span class="command">theory</span></span> Syntax
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="https://www.cl.cam.ac.uk/research/hvg/Isabelle/dist/library/HOL/HOL/Main.html">Main</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Syntax›</span></span>

<span class="keyword1"><span class="command">datatype</span></span> type <span class="main">=</span> 
     Iota
    <span class="main">|</span> Fun <span class="quoted">type</span> <span class="quoted">type</span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixr</span></span> <span class="quoted">"<span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1">→</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span>"</span> 200<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹To deal with $\alpha$-equivalence, we use De Bruijn's nameless representation wherein each bound
     variable is represented by a natural number, its index, that denotes the number of binders
     that must be traversed to arrive at the one that binds the given variable.
     Each free variable has an index that points into the top-level context, not enclosed in
     any abstractions.›</span></span>
  
<span class="keyword1"><span class="command">datatype</span></span> trm <span class="main">=</span>
      LVar <span class="quoted">nat</span>    <span class="main">(</span><span class="quoted">"<span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1">`</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span>_"</span> <span class="main">[</span>100<span class="main">]</span> 100<span class="main">)</span>
    <span class="main">|</span> Lbd <span class="quoted">type</span> <span class="quoted">trm</span> <span class="main">(</span><span class="quoted">"<span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1">λ</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span>_<span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1">:</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span>_"</span> <span class="main">[</span>0<span class="main">,</span> 60<span class="main">]</span> 60<span class="main">)</span>
    <span class="main">|</span> App <span class="quoted">trm</span> <span class="quoted">trm</span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1">°</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span>"</span> 60<span class="main">)</span>
    <span class="main">|</span> Mu <span class="quoted">type</span> <span class="quoted">cmd</span> <span class="main">(</span><span class="quoted">"<span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1">μ</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span>_<span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1">:</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span>_"</span> <span class="main">[</span>0<span class="main">,</span> 60<span class="main">]</span> 60<span class="main">)</span>
<span class="keyword2"><span class="keyword">and</span></span> cmd <span class="main">=</span> 
      MVar <span class="quoted">nat</span> <span class="quoted">trm</span> <span class="main">(</span><span class="quoted">"<span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1">&lt;</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span>_<span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1">&gt;</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span>_"</span> <span class="main">[</span>0<span class="main">,</span> 60<span class="main">]</span> 60<span class="main">)</span>
      
<span class="keyword1"><span class="command">datatype</span></span> ctxt <span class="main">=</span> 
  ContextEmpty <span class="main">(</span><span class="quoted">"<span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1">◇</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span>"</span><span class="main">)</span> <span class="main">|</span>
  ContextApp <span class="quoted">ctxt</span> <span class="quoted">trm</span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="hidden">⇧</span><sup>∙</sup></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span>"</span> 75<span class="main">)</span>
  
<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">ctxt_app</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"ctxt <span class="main">⇒</span> ctxt <span class="main">⇒</span> ctxt"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">.</span>"</span> 60<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">◇</span> <span class="main"><span class="free">.</span></span> <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">F</span></span></span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free"><span class="bound"><span class="entity">E</span></span></span> <span class="main"><span class="hidden">⇧</span><sup>∙</sup></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main"><span class="free">.</span></span> <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">E</span></span></span> <span class="main"><span class="free">.</span></span> <span class="free"><span class="bound"><span class="entity">F</span></span></span><span class="main">)</span> <span class="main"><span class="hidden">⇧</span><sup>∙</sup></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span>"</span></span>
  
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">is_val</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"trm <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">is_val</span> <span class="main">(</span><span class="main">λ</span> <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="main">:</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span> <span class="main">=</span> True"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">is_val</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> False"</span></span>

  
<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Types">
<div class="head">
<h1>Theory Types</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Types›</span></span>
  
<span class="keyword1"><span class="command">theory</span></span> Types
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="#Syntax">Syntax</a>
<span class="keyword2"><span class="keyword">begin</span></span>
  
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹We implement typing environments as (total) functions from natural numbers to types,
     following the approach of Stefan Berghofer in his formalisation of the simply typed
     $\lambda$-calculus in the Isabelle/HOL library.
     An empty typing environment may be represented by an arbitrary function of the correct type
     as it will never be queried when a typing judgement is valid. We split typing environments,
     dedicating one environment to $\lambda$-variables and another to $\mu$-variables, and
     use $\Gamma$ and $\Delta$ to range over the former and latter, respectively.›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹From src/HOL/Proofs/LambdaType.thy›</span></span>
  
<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">shift</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>nat <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">)</span> <span class="main">⇒</span> nat <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> nat <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span>  <span class="main">(</span><span class="quoted">"_<span class="keyword1">⟨</span>_<span class="keyword1">:</span>_<span class="keyword1">⟩</span>"</span> <span class="main">[</span>90<span class="main">,</span> 0<span class="main">,</span> 0<span class="main">]</span> 91<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main"><span class="free">⟨</span></span><span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main"><span class="free">:</span></span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main"><span class="free">⟩</span></span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">j</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">j</span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="bound">j</span> <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="bound">j</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="keyword1">else</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">(</span><span class="bound">j</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Types-shift_eq"><span class="command">lemma</span></span> shift_eq <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">=</span> <span class="free">j</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">e</span><span class="main">⟨</span><span class="free">i</span><span class="main">:</span><span class="free">T</span><span class="main">⟩</span><span class="main">)</span> <span class="free">j</span> <span class="main">=</span> <span class="free">T</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> shift_def<span class="main">)</span>

<span class="keyword1" id="Types-shift_gt"><span class="command">lemma</span></span> shift_gt <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">&lt;</span> <span class="free">i</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">e</span><span class="main">⟨</span><span class="free">i</span><span class="main">:</span><span class="free">T</span><span class="main">⟩</span><span class="main">)</span> <span class="free">j</span> <span class="main">=</span> <span class="free">e</span> <span class="free">j</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> shift_def<span class="main">)</span>

<span class="keyword1" id="Types-shift_lt"><span class="command">lemma</span></span> shift_lt <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> <span class="free">j</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">e</span><span class="main">⟨</span><span class="free">i</span><span class="main">:</span><span class="free">T</span><span class="main">⟩</span><span class="main">)</span> <span class="free">j</span> <span class="main">=</span> <span class="free">e</span> <span class="main">(</span><span class="free">j</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> shift_def<span class="main">)</span>

<span class="keyword1" id="Types-shift_commute"><span class="command">lemma</span></span> shift_commute <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">e</span><span class="main">⟨</span><span class="free">i</span><span class="main">:</span><span class="free">U</span><span class="main">⟩</span><span class="main">⟨</span><span class="main">0</span><span class="main">:</span><span class="free">T</span><span class="main">⟩</span> <span class="main">=</span> <span class="free">e</span><span class="main">⟨</span><span class="main">0</span><span class="main">:</span><span class="free">T</span><span class="main">⟩</span><span class="main">⟨</span>Suc <span class="free">i</span><span class="main">:</span><span class="free">U</span><span class="main">⟩</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> shift_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> nat.split<span class="main"><span class="keyword3">,</span></span> <span class="operator">force</span><span class="main">)</span>
   
<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">typing_trm</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>nat <span class="main">⇒</span> type<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span>nat <span class="main">⇒</span> type<span class="main">)</span> <span class="main">⇒</span> trm <span class="main">⇒</span> type <span class="main">⇒</span> bool"</span></span>  
     <span class="main">(</span><span class="quoted">"_ <span class="keyword1">,</span> _ <span class="keyword1">⊢<span class="hidden">⇩</span><sub>T</sub></span> _ <span class="keyword1">:</span> _"</span> <span class="main">[</span>50<span class="main">,</span> 50<span class="main">,</span> 50<span class="main">,</span> 50<span class="main">]</span> 50<span class="main">)</span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="entity">typing_cmd</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>nat <span class="main">⇒</span> type<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span>nat <span class="main">⇒</span> type<span class="main">)</span> <span class="main">⇒</span> cmd <span class="main">⇒</span> bool"</span></span>
     <span class="main">(</span><span class="quoted">"_ <span class="keyword1">,</span> _ <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span> _"</span> <span class="main">[</span>50<span class="main">,</span> 50<span class="main">,</span> 50<span class="main">]</span> 50<span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span> 
  var <span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main"><span class="free">,</span></span> <span class="free"><span class="bound"><span class="entity">Δ</span></span></span> <span class="keyword1"><span class="free">⊢<span class="hidden">⇩</span><sub>T</sub></span></span> <span class="main">`</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main"><span class="free">:</span></span> <span class="free"><span class="bound"><span class="entity">T</span></span></span>"</span></span> <span class="main">|</span>
  app <span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main"><span class="free">,</span></span> <span class="free"><span class="bound"><span class="entity">Δ</span></span></span> <span class="keyword1"><span class="free">⊢<span class="hidden">⇩</span><sub>T</sub></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main"><span class="free">:</span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">T1</span></span></span><span class="main">→</span><span class="free"><span class="bound"><span class="entity">T2</span></span></span><span class="main">)</span><span class="main">;</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main"><span class="free">,</span></span> <span class="free"><span class="bound"><span class="entity">Δ</span></span></span> <span class="keyword1"><span class="free">⊢<span class="hidden">⇩</span><sub>T</sub></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main"><span class="free">:</span></span> <span class="free"><span class="bound"><span class="entity">T1</span></span></span> <span class="main">⟧</span>
                    <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main"><span class="free">,</span></span> <span class="free"><span class="bound"><span class="entity">Δ</span></span></span> <span class="keyword1"><span class="free">⊢<span class="hidden">⇩</span><sub>T</sub></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">°</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main"><span class="free">:</span></span> <span class="free"><span class="bound"><span class="entity">T2</span></span></span>"</span></span> <span class="main">|</span>
  lambda <span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">⟨</span><span class="main">0</span><span class="main">:</span><span class="free"><span class="bound"><span class="entity">T1</span></span></span><span class="main">⟩</span><span class="main"><span class="free">,</span></span> <span class="free"><span class="bound"><span class="entity">Δ</span></span></span> <span class="keyword1"><span class="free">⊢<span class="hidden">⇩</span><sub>T</sub></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main"><span class="free">:</span></span> <span class="free"><span class="bound"><span class="entity">T2</span></span></span> <span class="main">⟧</span>
                    <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main"><span class="free">,</span></span> <span class="free"><span class="bound"><span class="entity">Δ</span></span></span> <span class="keyword1"><span class="free">⊢<span class="hidden">⇩</span><sub>T</sub></span></span> <span class="main">(</span><span class="main">λ</span> <span class="free"><span class="bound"><span class="entity">T1</span></span></span> <span class="main">:</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main"><span class="free">:</span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">T1</span></span></span><span class="main">→</span><span class="free"><span class="bound"><span class="entity">T2</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  activate <span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main"><span class="free">,</span></span> <span class="free"><span class="bound"><span class="entity">Δ</span></span></span><span class="main">⟨</span><span class="main">0</span><span class="main">:</span><span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main">⟩</span> <span class="keyword1"><span class="free">⊢<span class="hidden">⇩</span><sub>C</sub></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main"><span class="free">,</span></span> <span class="free"><span class="bound"><span class="entity">Δ</span></span></span> <span class="keyword1"><span class="free">⊢<span class="hidden">⇩</span><sub>T</sub></span></span> <span class="main">(</span><span class="keyword1">μ</span> <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="main">:</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span> <span class="main"><span class="free">:</span></span> <span class="free"><span class="bound"><span class="entity">T</span></span></span>"</span></span> <span class="main">|</span>
  passivate <span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main"><span class="free">,</span></span> <span class="free"><span class="bound"><span class="entity">Δ</span></span></span> <span class="keyword1"><span class="free">⊢<span class="hidden">⇩</span><sub>T</sub></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main"><span class="free">:</span></span> <span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main">;</span> <span class="free"><span class="bound"><span class="entity">Δ</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main"><span class="free">,</span></span> <span class="free"><span class="bound"><span class="entity">Δ</span></span></span> <span class="keyword1"><span class="free">⊢<span class="hidden">⇩</span><sub>C</sub></span></span> <span class="main">(</span><span class="main">&lt;</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">&gt;</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">inductive_cases</span></span> typing_elims <span class="main">[</span><span class="operator">elim</span><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">Γ</span><span class="main">,</span> <span class="free">Δ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>T</sub></span> <span class="main">`</span><span class="free">x</span> <span class="main">:</span> <span class="free">T</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">Γ</span><span class="main">,</span> <span class="free">Δ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>T</sub></span> <span class="free">t</span><span class="main">°</span><span class="free">s</span> <span class="main">:</span> <span class="free">T</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">Γ</span><span class="main">,</span> <span class="free">Δ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>T</sub></span> <span class="main">λ</span> <span class="free">T1</span> <span class="main">:</span> <span class="free">t</span> <span class="main">:</span> <span class="free">T</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">Γ</span><span class="main">,</span> <span class="free">Δ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>T</sub></span> <span class="keyword1">μ</span> <span class="free">T1</span> <span class="main">:</span> <span class="free">t</span> <span class="main">:</span> <span class="free">T</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">Γ</span><span class="main">,</span> <span class="free">Δ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">&lt;</span><span class="free">x</span><span class="main">&gt;</span> <span class="free">t</span>"</span></span>

<span class="keyword1"><span class="command">inductive_cases</span></span> type_arrow_elim<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">,</span> <span class="free">Δ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>T</sub></span> <span class="free">t</span> <span class="main">:</span> <span class="free">T1</span> <span class="main">→</span> <span class="free">T2</span>"</span></span>

<span class="keyword1" id="Types-uniqueness"><span class="command">lemma</span></span> uniqueness<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">Γ</span><span class="main">,</span> <span class="free">Δ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>T</sub></span> <span class="free">t</span> <span class="main">:</span> <span class="free">T1</span> <span class="main">⟹</span> <span class="free">Γ</span><span class="main">,</span> <span class="free">Δ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>T</sub></span> <span class="free">t</span> <span class="main">:</span> <span class="free">T2</span> <span class="main">⟹</span> <span class="free">T1</span> <span class="main">=</span> <span class="free">T2</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">Γ</span><span class="main">,</span> <span class="free">Δ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span> <span class="free">c</span> <span class="main">⟹</span> <span class="free">Γ</span><span class="main">,</span> <span class="free">Δ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span> <span class="free">c</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">T2</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> typing_trm_typing_cmd.inducts<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> typing_cmd.cases <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="DeBruijn">
<div class="head">
<h1>Theory DeBruijn</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> DeBruijn
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="#Syntax">Syntax</a>
<span class="keyword2"><span class="keyword">begin</span></span>
  
<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹De Bruijn indices›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Functions to find the free $\lambda$ and $\mu$ variables in an expression.›</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">flv_trm</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"trm <span class="main">⇒</span> nat <span class="main">⇒</span> nat set"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="entity">flv_cmd</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"cmd <span class="main">⇒</span> nat <span class="main">⇒</span> nat set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">flv_trm</span> <span class="main">(</span><span class="main">`</span><span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">≥</span><span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="keyword1">then</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">-</span><span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">}</span> <span class="keyword1">else</span> <span class="main">{}</span><span class="main">)</span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">flv_trm</span> <span class="main">(</span><span class="main">λ</span> <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="main">:</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">=</span> <span class="free">flv_trm</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">+</span><span class="main">1</span><span class="main">)</span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">flv_trm</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">°</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="free">flv_trm</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">)</span> <span class="main">∪</span> <span class="main">(</span><span class="free">flv_trm</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">)</span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">flv_trm</span> <span class="main">(</span><span class="keyword1">μ</span> <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="main">:</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">=</span> <span class="free">flv_cmd</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">flv_cmd</span> <span class="main">(</span><span class="main">&lt;</span><span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">&gt;</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">=</span> <span class="free">flv_trm</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span>"</span></span>
    
<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">fmv_trm</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"trm <span class="main">⇒</span> nat <span class="main">⇒</span> nat set"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="entity">fmv_cmd</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"cmd <span class="main">⇒</span> nat <span class="main">⇒</span> nat set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">fmv_trm</span> <span class="main">(</span><span class="main">`</span><span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">fmv_trm</span> <span class="main">(</span><span class="main">λ</span> <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="main">:</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">=</span> <span class="free">fmv_trm</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">fmv_trm</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">°</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="free">fmv_trm</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">)</span> <span class="main">∪</span> <span class="main">(</span><span class="free">fmv_trm</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">)</span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">fmv_trm</span> <span class="main">(</span><span class="keyword1">μ</span> <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="main">:</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">=</span> <span class="free">fmv_cmd</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">+</span><span class="main">1</span><span class="main">)</span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">fmv_cmd</span> <span class="main">(</span><span class="main">&lt;</span><span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">&gt;</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">≥</span><span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="keyword1">then</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">-</span><span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">}</span> <span class="main">∪</span> <span class="main">(</span><span class="free">fmv_trm</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">)</span> <span class="keyword1">else</span> <span class="main">(</span><span class="free">fmv_trm</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
    
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">lambda_closed</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">_</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">lambda_closed</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">≡</span> flv_trm <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">0</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">lambda_closedC</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">_</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">lambda_closedC</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">≡</span> flv_cmd <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">0</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
    
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Free variables in a context.›</span></span>
  
<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">fmv_ctxt</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"ctxt <span class="main">⇒</span> nat <span class="main">⇒</span> nat set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">fmv_ctxt</span> <span class="main">◇</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">fmv_ctxt</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">E</span></span></span> <span class="main"><span class="hidden">⇧</span><sup>∙</sup></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="free">fmv_ctxt</span> <span class="free"><span class="bound"><span class="entity">E</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">)</span> <span class="main">∪</span> <span class="main">(</span>fmv_trm <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">)</span>"</span></span>     

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Shift free $\lambda$ and $\mu$ variables in terms and commands to make substitution capture avoiding.›</span></span>    
    
<span class="keyword1"><span class="command">primrec</span></span>
  <span class="entity">liftL_trm</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>trm<span class="main">,</span> nat<span class="main">]</span> <span class="main">⇒</span> trm"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  <span class="entity">liftL_cmd</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>cmd<span class="main">,</span> nat<span class="main">]</span> <span class="main">⇒</span> cmd"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">liftL_trm</span> <span class="main">(</span><span class="main">`</span><span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">&lt;</span><span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="keyword1">then</span> <span class="main">`</span><span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="keyword1">else</span> <span class="main">`</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">liftL_trm</span> <span class="main">(</span><span class="main">λ</span> <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="main">:</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">=</span> <span class="main">λ</span> <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="main">:</span> <span class="main">(</span><span class="free">liftL_trm</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">|</span> 
  <span class="quoted"><span class="quoted">"<span class="free">liftL_trm</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">°</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">=</span> <span class="free">liftL_trm</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">°</span> <span class="free">liftL_trm</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">liftL_trm</span> <span class="main">(</span><span class="keyword1">μ</span> <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="main">:</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">=</span> <span class="keyword1">μ</span> <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="main">:</span> <span class="main">(</span><span class="free">liftL_cmd</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">liftL_cmd</span> <span class="main">(</span><span class="main">&lt;</span><span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">&gt;</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">=</span> <span class="main">&lt;</span><span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">&gt;</span> <span class="main">(</span><span class="free">liftL_trm</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">primrec</span></span>
  <span class="entity">liftM_trm</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>trm<span class="main">,</span> nat<span class="main">]</span> <span class="main">⇒</span> trm"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  <span class="entity">liftM_cmd</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>cmd<span class="main">,</span> nat<span class="main">]</span> <span class="main">⇒</span> cmd"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">liftM_trm</span> <span class="main">(</span><span class="main">`</span><span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">=</span> <span class="main">`</span><span class="free"><span class="bound"><span class="entity">i</span></span></span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">liftM_trm</span> <span class="main">(</span><span class="main">λ</span> <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="main">:</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">=</span> <span class="main">λ</span> <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="main">:</span> <span class="main">(</span><span class="free">liftM_trm</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">liftM_trm</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">°</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">=</span> <span class="free">liftM_trm</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">°</span> <span class="free">liftM_trm</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">liftM_trm</span> <span class="main">(</span><span class="keyword1">μ</span> <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="main">:</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">=</span> <span class="keyword1">μ</span> <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="main">:</span> <span class="main">(</span><span class="free">liftM_cmd</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">liftM_cmd</span> <span class="main">(</span><span class="main">&lt;</span><span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">&gt;</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">=</span>
      <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">&lt;</span><span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="keyword1">then</span> <span class="main">(</span><span class="main">&lt;</span><span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">&gt;</span> <span class="main">(</span><span class="free">liftM_trm</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">)</span><span class="main">)</span> <span class="keyword1">else</span> <span class="main">(</span><span class="main">&lt;</span><span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">+</span><span class="main">1</span><span class="main">&gt;</span> <span class="main">(</span><span class="free">liftM_trm</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Shift free $\lambda$ and $\mu$ variables in contexts to make structural substitution capture avoiding.›</span></span>
  
<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">liftL_ctxt</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"ctxt <span class="main">⇒</span> nat <span class="main">⇒</span> ctxt"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">liftL_ctxt</span> <span class="main">◇</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> <span class="main">◇</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">liftL_ctxt</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">E</span></span></span> <span class="main"><span class="hidden">⇧</span><sup>∙</sup></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="free">liftL_ctxt</span> <span class="free"><span class="bound"><span class="entity">E</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main"><span class="hidden">⇧</span><sup>∙</sup></span> <span class="main">(</span>liftL_trm <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">liftM_ctxt</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"ctxt <span class="main">⇒</span> nat <span class="main">⇒</span> ctxt"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">liftM_ctxt</span> <span class="main">◇</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> <span class="main">◇</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">liftM_ctxt</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">E</span></span></span> <span class="main"><span class="hidden">⇧</span><sup>∙</sup></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="free">liftM_ctxt</span> <span class="free"><span class="bound"><span class="entity">E</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main"><span class="hidden">⇧</span><sup>∙</sup></span> <span class="main">(</span>liftM_trm <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span>"</span></span>  
  
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹A function to decrement the indices of free $\mu$-variables when a $\mu$ surrounding the
     expression disappears as a result of a reduction›</span></span>

<span class="keyword1"><span class="command">primrec</span></span>
  <span class="entity">dropM_trm</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>trm<span class="main">,</span> nat<span class="main">]</span> <span class="main">⇒</span> trm"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  <span class="entity">dropM_cmd</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>cmd<span class="main">,</span> nat<span class="main">]</span> <span class="main">⇒</span> cmd"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">dropM_trm</span> <span class="main">(</span><span class="main">`</span><span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">=</span> <span class="main">`</span><span class="free"><span class="bound"><span class="entity">i</span></span></span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">dropM_trm</span> <span class="main">(</span><span class="main">λ</span> <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="main">:</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">=</span> <span class="main">λ</span> <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="main">:</span> <span class="main">(</span><span class="free">dropM_trm</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">)</span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">dropM_trm</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">°</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="free">dropM_trm</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">)</span> <span class="main">°</span> <span class="main">(</span><span class="free">dropM_trm</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">)</span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">dropM_trm</span> <span class="main">(</span><span class="keyword1">μ</span> <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="main">:</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">=</span> <span class="keyword1">μ</span> <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="main">:</span> <span class="main">(</span><span class="free">dropM_cmd</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">dropM_cmd</span> <span class="main">(</span><span class="main">&lt;</span><span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">&gt;</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">=</span> 
      <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">&gt;</span><span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="keyword1">then</span> <span class="main">(</span><span class="main">&lt;</span><span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">-</span><span class="main">1</span><span class="main">&gt;</span> <span class="main">(</span><span class="free">dropM_trm</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">)</span><span class="main">)</span> <span class="keyword1">else</span> <span class="main">(</span><span class="main">&lt;</span><span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">&gt;</span> <span class="main">(</span><span class="free">dropM_trm</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    
<span class="keyword1" id="DeBruijn-fmv_liftL"><span class="command">lemma</span></span> fmv_liftL<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="free">β</span> <span class="main">∉</span> fmv_trm <span class="free">t</span> <span class="free">n</span> <span class="main">⟹</span> <span class="free">β</span> <span class="main">∉</span> fmv_trm <span class="main">(</span>liftL_trm <span class="free">t</span> <span class="free">m</span><span class="main">)</span> <span class="free">n</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">β</span> <span class="main">∉</span> fmv_cmd <span class="free">c</span> <span class="free">n</span> <span class="main">⟹</span> <span class="free">β</span> <span class="main">∉</span> fmv_cmd <span class="main">(</span>liftL_cmd <span class="free">c</span> <span class="free">m</span><span class="main">)</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">t</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="quoted"><span class="free">c</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">m</span></span> <span class="quoted"><span class="free">n</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="quoted"><span class="free">m</span></span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="DeBruijn-fmv_liftL_ctxt"><span class="command">lemma</span></span> fmv_liftL_ctxt<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">β</span> <span class="main">∉</span> fmv_ctxt <span class="free">E</span> <span class="free">m</span> <span class="main">⟹</span> <span class="free">β</span> <span class="main">∉</span> fmv_ctxt <span class="main">(</span>liftL_ctxt <span class="free">E</span> <span class="free">n</span><span class="main">)</span> <span class="free">m</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">E</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fmv_liftL<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    
<span class="keyword1" id="DeBruijn-fmv_suc"><span class="command">lemma</span></span> fmv_suc<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">β</span> <span class="main">∉</span> fmv_cmd <span class="free">c</span> <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">(</span>Suc <span class="free">β</span><span class="main">)</span> <span class="main">∉</span> fmv_cmd <span class="free">c</span> <span class="free">n</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">β</span> <span class="main">∉</span> fmv_trm <span class="free">t</span> <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">(</span>Suc <span class="free">β</span><span class="main">)</span> <span class="main">∉</span> fmv_trm <span class="free">t</span> <span class="free">n</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">c</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">n</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>MVar <span class="skolem">x1</span> <span class="skolem">x2</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">clarsimp</span> <span class="main">(</span><span class="operator">metis</span> UnI1 UnI2 diff_Suc_1 diff_Suc_eq_diff_pred diff_commute diff_is_0_eq nat.simps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> not_less_eq_eq singletonI<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">force</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1" id="DeBruijn-flv_drop"><span class="command">lemma</span></span> flv_drop<span class="main">:</span>
  <span class="quoted"><span class="quoted">"flv_trm <span class="free">t</span> <span class="free">k</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">⟶</span> flv_trm <span class="main">(</span>dropM_trm <span class="free">t</span> <span class="free">j</span><span class="main">)</span> <span class="free">k</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="quoted"><span class="quoted">"flv_cmd <span class="free">c</span> <span class="free">k</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">⟶</span> flv_cmd <span class="main">(</span>dropM_cmd <span class="free">c</span> <span class="free">j</span><span class="main">)</span> <span class="free">k</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">t</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="quoted"><span class="free">c</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">j</span></span> <span class="quoted"><span class="free">k</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="quoted"><span class="free">j</span></span> <span class="quoted"><span class="free">k</span></span><span class="main">)</span> <span class="operator">clarsimp</span><span class="main"><span class="keyword3">+</span></span>
    
<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Substitution">
<div class="head">
<h1>Theory Substitution</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Logical and structural substitution›</span></span>
  
<span class="keyword1"><span class="command">theory</span></span> Substitution
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="#DeBruijn">DeBruijn</a>
<span class="keyword2"><span class="keyword">begin</span></span> 

<span class="keyword1"><span class="command">primrec</span></span>
  <span class="entity">subst_trm</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>trm<span class="main">,</span> trm<span class="main">,</span> nat<span class="main">]</span> <span class="main">⇒</span> trm"</span></span>  <span class="main">(</span><span class="quoted">"_<span class="keyword1">[</span>_<span class="keyword1">'/</span>_<span class="keyword1">]<span class="hidden">⇧</span><sup>T</sup></span>"</span> <span class="main">[</span>300<span class="main">,</span> 0<span class="main">,</span> 0<span class="main">]</span> 300<span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span>
  <span class="entity">subst_cmd</span> <span class="main">::</span>  <span class="quoted"><span class="quoted">"<span class="main">[</span>cmd<span class="main">,</span> trm<span class="main">,</span> nat<span class="main">]</span> <span class="main">⇒</span> cmd"</span></span> <span class="main">(</span><span class="quoted">"_<span class="keyword1">[</span>_<span class="keyword1">'/</span>_<span class="keyword1">]<span class="hidden">⇧</span><sup>C</sup></span>"</span> <span class="main">[</span>300<span class="main">,</span> 0<span class="main">,</span> 0<span class="main">]</span> 300<span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span>
    subst_LVar<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">`</span><span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span><span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main"><span class="free">/</span></span><span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="keyword1"><span class="free">]<span class="hidden">⇧</span><sup>T</sup></span></span> <span class="main">=</span> 
          <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="keyword1">then</span> <span class="main">`</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="keyword1">else</span> <span class="main">(</span><span class="main">`</span><span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="main">|</span> subst_Lbd<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span> <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="main">:</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span><span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main"><span class="free">/</span></span><span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="keyword1"><span class="free">]<span class="hidden">⇧</span><sup>T</sup></span></span> <span class="main">=</span> <span class="main">λ</span> <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="main">:</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main"><span class="free">[</span></span><span class="main">(</span>liftL_trm <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">0</span><span class="main">)</span> <span class="main"><span class="free">/</span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">+</span><span class="main">1</span><span class="keyword1"><span class="free">]<span class="hidden">⇧</span><sup>T</sup></span></span><span class="main">)</span>"</span></span>
    <span class="main">|</span> subst_App<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">°</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">)</span><span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main"><span class="free">/</span></span><span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="keyword1"><span class="free">]<span class="hidden">⇧</span><sup>T</sup></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main"><span class="free">/</span></span><span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="keyword1"><span class="free">]<span class="hidden">⇧</span><sup>T</sup></span></span> <span class="main">°</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main"><span class="free">/</span></span><span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="keyword1"><span class="free">]<span class="hidden">⇧</span><sup>T</sup></span></span>"</span></span>
    <span class="main">|</span> subst_Mu<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">μ</span> <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="main">:</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span><span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main"><span class="free">/</span></span><span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="keyword1"><span class="free">]<span class="hidden">⇧</span><sup>T</sup></span></span>  <span class="main">=</span> <span class="keyword1">μ</span> <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="main">:</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main"><span class="free">[</span></span><span class="main">(</span>liftM_trm <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">0</span><span class="main">)</span> <span class="main"><span class="free">/</span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="keyword1"><span class="free">]<span class="hidden">⇧</span><sup>C</sup></span></span><span class="main">)</span>"</span></span>
    <span class="main">|</span> subst_MVar<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">&lt;</span><span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">&gt;</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span><span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main"><span class="free">/</span></span><span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="keyword1"><span class="free">]<span class="hidden">⇧</span><sup>C</sup></span></span> <span class="main">=</span> <span class="main">&lt;</span><span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">&gt;</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main"><span class="free">/</span></span><span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="keyword1"><span class="free">]<span class="hidden">⇧</span><sup>T</sup></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Substituting a term for the hole in a context.›</span></span>
  
<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">ctxt_subst</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"ctxt <span class="main">⇒</span> trm <span class="main">⇒</span> trm"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">ctxt_subst</span> <span class="main">◇</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">ctxt_subst</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">E</span></span></span> <span class="main"><span class="hidden">⇧</span><sup>∙</sup></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="free">ctxt_subst</span> <span class="free"><span class="bound"><span class="entity">E</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span><span class="main">°</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span>"</span></span>

<span class="keyword1" id="Substitution-ctxt_app_subst"><span class="command">lemma</span></span> ctxt_app_subst<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"ctxt_subst <span class="free">E</span> <span class="main">(</span>ctxt_subst <span class="free">F</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> ctxt_subst <span class="main">(</span><span class="free">E</span> <span class="main">.</span> <span class="free">F</span><span class="main">)</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">E</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹The structural substitution is based on Geuvers and al.~\cite{DBLP:journals/apal/GeuversKM13}.›</span></span>

<span class="keyword1"><span class="command">primrec</span></span>
  <span class="entity">struct_subst_trm</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>trm<span class="main">,</span> nat<span class="main">,</span> nat<span class="main">,</span> ctxt<span class="main">]</span> <span class="main">⇒</span> trm"</span></span>  <span class="main">(</span><span class="quoted">"_<span class="keyword1">[</span>_<span class="keyword1">=</span>_ _<span class="keyword1">]<span class="hidden">⇧</span><sup>T</sup></span>"</span> <span class="main">[</span>300<span class="main">,</span> 0<span class="main">,</span> 0<span class="main">,</span> 0<span class="main">]</span> 300<span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span>
  <span class="entity">struct_subst_cmd</span> <span class="main">::</span>  <span class="quoted"><span class="quoted">"<span class="main">[</span>cmd<span class="main">,</span> nat<span class="main">,</span> nat<span class="main">,</span> ctxt<span class="main">]</span> <span class="main">⇒</span> cmd"</span></span> <span class="main">(</span><span class="quoted">"_<span class="keyword1">[</span>_<span class="keyword1">=</span>_ _<span class="keyword1">]<span class="hidden">⇧</span><sup>C</sup></span>"</span> <span class="main">[</span>300<span class="main">,</span> 0<span class="main">,</span> 0<span class="main">,</span> 0<span class="main">]</span> 300<span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span>
  struct_LVar<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">`</span><span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span><span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">j</span></span></span><span class="main"><span class="free">=</span></span><span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">E</span></span></span><span class="keyword1"><span class="free">]<span class="hidden">⇧</span><sup>T</sup></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">`</span><span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  struct_Lbd<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span> <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="main">:</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span><span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">j</span></span></span><span class="main"><span class="free">=</span></span><span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">E</span></span></span><span class="keyword1"><span class="free">]<span class="hidden">⇧</span><sup>T</sup></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span> <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="main">:</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">j</span></span></span><span class="main"><span class="free">=</span></span><span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">(</span>liftL_ctxt <span class="free"><span class="bound"><span class="entity">E</span></span></span> <span class="main">0</span><span class="main">)</span><span class="keyword1"><span class="free">]<span class="hidden">⇧</span><sup>T</sup></span></span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">|</span>
  struct_App<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">°</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span><span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">j</span></span></span><span class="main"><span class="free">=</span></span><span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">E</span></span></span><span class="keyword1"><span class="free">]<span class="hidden">⇧</span><sup>T</sup></span></span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">j</span></span></span><span class="main"><span class="free">=</span></span><span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">E</span></span></span><span class="keyword1"><span class="free">]<span class="hidden">⇧</span><sup>T</sup></span></span><span class="main">)</span><span class="main">°</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">j</span></span></span><span class="main"><span class="free">=</span></span><span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">E</span></span></span><span class="keyword1"><span class="free">]<span class="hidden">⇧</span><sup>T</sup></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  struct_Mu<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">μ</span> <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="main">:</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span><span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">j</span></span></span><span class="main"><span class="free">=</span></span><span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">E</span></span></span><span class="keyword1"><span class="free">]<span class="hidden">⇧</span><sup>T</sup></span></span> <span class="main">=</span> <span class="keyword1">μ</span> <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="main">:</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main"><span class="free">[</span></span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">j</span></span></span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main"><span class="free">=</span></span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">(</span>liftM_ctxt <span class="free"><span class="bound"><span class="entity">E</span></span></span> <span class="main">0</span><span class="main">)</span><span class="keyword1"><span class="free">]<span class="hidden">⇧</span><sup>C</sup></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  struct_MVar<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">&lt;</span><span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">&gt;</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span><span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">j</span></span></span><span class="main"><span class="free">=</span></span><span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">E</span></span></span><span class="keyword1"><span class="free">]<span class="hidden">⇧</span><sup>C</sup></span></span> <span class="main">=</span> 
      <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">=</span><span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="keyword1">then</span> <span class="main">(</span><span class="main">&lt;</span><span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">&gt;</span> <span class="main">(</span>ctxt_subst <span class="free"><span class="bound"><span class="entity">E</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">j</span></span></span><span class="main"><span class="free">=</span></span><span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">E</span></span></span><span class="keyword1"><span class="free">]<span class="hidden">⇧</span><sup>T</sup></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span> 
       <span class="keyword1">else</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">j</span></span></span><span class="main">&lt;</span><span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">≤</span><span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="keyword1">then</span> <span class="main">(</span><span class="main">&lt;</span><span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">-</span><span class="main">1</span><span class="main">&gt;</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">j</span></span></span><span class="main"><span class="free">=</span></span><span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">E</span></span></span><span class="keyword1"><span class="free">]<span class="hidden">⇧</span><sup>T</sup></span></span><span class="main">)</span><span class="main">)</span>
             <span class="keyword1">else</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">≤</span><span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">&lt;</span><span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="keyword1">then</span> <span class="main">(</span><span class="main">&lt;</span><span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">+</span><span class="main">1</span><span class="main">&gt;</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">j</span></span></span><span class="main"><span class="free">=</span></span><span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">E</span></span></span><span class="keyword1"><span class="free">]<span class="hidden">⇧</span><sup>T</sup></span></span><span class="main">)</span><span class="main">)</span>
                   <span class="keyword1">else</span> <span class="main">(</span><span class="main">&lt;</span><span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">&gt;</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">j</span></span></span><span class="main"><span class="free">=</span></span><span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">E</span></span></span><span class="keyword1"><span class="free">]<span class="hidden">⇧</span><sup>T</sup></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Lifting of lambda and mu variables commute with each other›</span></span>

<span class="keyword1" id="Substitution-liftLM_comm"><span class="command">lemma</span></span> liftLM_comm<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"liftL_trm <span class="main">(</span>liftM_trm <span class="free">t</span> <span class="free">n</span><span class="main">)</span> <span class="free">m</span> <span class="main">=</span> liftM_trm <span class="main">(</span>liftL_trm <span class="free">t</span> <span class="free">m</span><span class="main">)</span> <span class="free">n</span>"</span></span>
  <span class="quoted"><span class="quoted">"liftL_cmd <span class="main">(</span>liftM_cmd <span class="free">c</span> <span class="free">n</span><span class="main">)</span> <span class="free">m</span> <span class="main">=</span> liftM_cmd <span class="main">(</span>liftL_cmd <span class="free">c</span> <span class="free">m</span><span class="main">)</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">t</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="quoted"><span class="free">c</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="free">m</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="free">m</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Substitution-liftLM_comm_ctxt"><span class="command">lemma</span></span> liftLM_comm_ctxt<span class="main">:</span>
  <span class="quoted"><span class="quoted">"liftL_ctxt <span class="main">(</span>liftM_ctxt <span class="free">E</span> <span class="free">n</span><span class="main">)</span> <span class="free">m</span> <span class="main">=</span> liftM_ctxt <span class="main">(</span>liftL_ctxt <span class="free">E</span> <span class="free">m</span><span class="main">)</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">E</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="free">m</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> liftLM_comm<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Lifting of $\mu$-variables (almost) commutes.›</span></span>

<span class="keyword1" id="Substitution-liftMM_comm"><span class="command">lemma</span></span> liftMM_comm<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">n</span><span class="main">≥</span><span class="free">m</span> <span class="main">⟹</span> liftM_trm <span class="main">(</span>liftM_trm <span class="free">t</span> <span class="free">n</span><span class="main">)</span> <span class="free">m</span> <span class="main">=</span> liftM_trm <span class="main">(</span>liftM_trm <span class="free">t</span> <span class="free">m</span><span class="main">)</span> <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">n</span><span class="main">≥</span><span class="free">m</span> <span class="main">⟹</span> liftM_cmd <span class="main">(</span>liftM_cmd <span class="free">c</span> <span class="free">n</span><span class="main">)</span> <span class="free">m</span> <span class="main">=</span> liftM_cmd <span class="main">(</span>liftM_cmd <span class="free">c</span> <span class="free">m</span><span class="main">)</span> <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">t</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="quoted"><span class="free">c</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="free">m</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="free">m</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Substitution-liftMM_comm_ctxt"><span class="command">lemma</span></span> liftMM_comm_ctxt<span class="main">:</span>
  <span class="quoted"><span class="quoted">"liftM_ctxt <span class="main">(</span>liftM_ctxt <span class="free">E</span> <span class="free">n</span><span class="main">)</span> <span class="main">0</span> <span class="main">=</span> liftM_ctxt <span class="main">(</span>liftM_ctxt <span class="free">E</span> <span class="main">0</span><span class="main">)</span> <span class="main">(</span><span class="free">n</span><span class="main">+</span><span class="main">1</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">E</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">n</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> liftMM_comm<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹If a $\mu$ variable $i$ doesn't occur in a term or a context, 
then these remain the same after structural substitution of variable $i$.›</span></span>

<span class="keyword1" id="Substitution-liftM_struct_subst"><span class="command">lemma</span></span> liftM_struct_subst<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"liftM_trm <span class="free">t</span> <span class="free">i</span><span class="main">[</span><span class="free">i</span><span class="main">=</span><span class="free">i</span> <span class="free">F</span><span class="keyword1">]<span class="hidden">⇧</span><sup>T</sup></span> <span class="main">=</span> liftM_trm <span class="free">t</span> <span class="free">i</span>"</span></span>
  <span class="quoted"><span class="quoted">"liftM_cmd <span class="free">c</span> <span class="free">i</span><span class="main">[</span><span class="free">i</span><span class="main">=</span><span class="free">i</span> <span class="free">F</span><span class="keyword1">]<span class="hidden">⇧</span><sup>C</sup></span> <span class="main">=</span> liftM_cmd <span class="free">c</span> <span class="free">i</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">t</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="quoted"><span class="free">c</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">F</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">F</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Substitution-liftM_ctxt_struct_subst"><span class="command">lemma</span></span> liftM_ctxt_struct_subst<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>ctxt_subst <span class="main">(</span>liftM_ctxt <span class="free">E</span> <span class="free">i</span><span class="main">)</span> <span class="free">t</span><span class="main">)</span><span class="main">[</span><span class="free">i</span><span class="main">=</span><span class="free">i</span> <span class="free">F</span><span class="keyword1">]<span class="hidden">⇧</span><sup>T</sup></span> <span class="main">=</span> ctxt_subst <span class="main">(</span>liftM_ctxt <span class="free">E</span> <span class="free">i</span><span class="main">)</span> <span class="main">(</span><span class="free">t</span><span class="main">[</span><span class="free">i</span><span class="main">=</span><span class="free">i</span> <span class="free">F</span><span class="keyword1">]<span class="hidden">⇧</span><sup>T</sup></span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">E</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quoted"><span class="free">F</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">force</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> liftM_struct_subst<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Reduction">
<div class="head">
<h1>Theory Reduction</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Reduction relation›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Reduction
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="#Substitution">Substitution</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">red_term</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>trm<span class="main">,</span> trm<span class="main">]</span> <span class="main">⇒</span> bool"</span></span>  <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">⇢</span>"</span> 50<span class="main">)</span> 
      <span class="keyword2"><span class="keyword">and</span></span> <span class="entity">red_cmd</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>cmd<span class="main">,</span> cmd<span class="main">]</span> <span class="main">⇒</span> bool"</span></span>  <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1"><span class="hidden">⇩</span><sub>C</sub>⇢</span>"</span> 50<span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span>
  beta   <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span> <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="main">:</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span><span class="main">°</span><span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main"><span class="free">⇢</span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">[</span><span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">/</span><span class="main">0</span><span class="keyword1">]<span class="hidden">⇧</span><sup>T</sup></span>"</span></span> <span class="main">|</span>
  struct <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">μ</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">T1</span></span></span><span class="main">→</span><span class="free"><span class="bound"><span class="entity">T2</span></span></span><span class="main">)</span> <span class="main">:</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span><span class="main">°</span><span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main"><span class="free">⇢</span></span> <span class="keyword1">μ</span> <span class="free"><span class="bound"><span class="entity">T2</span></span></span> <span class="main">:</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">[</span><span class="main">0</span> <span class="main">=</span> <span class="main">0</span> <span class="main">(</span><span class="main">◇</span> <span class="main"><span class="hidden">⇧</span><sup>∙</sup></span> <span class="main">(</span>liftM_trm <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">0</span><span class="main">)</span><span class="main">)</span><span class="keyword1">]<span class="hidden">⇧</span><sup>C</sup></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  rename <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">0</span> <span class="main">∉</span> <span class="main">(</span>fmv_trm <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">0</span><span class="main">)</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span><span class="keyword1">μ</span> <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="main">:</span> <span class="main">(</span><span class="main">&lt;</span><span class="main">0</span><span class="main">&gt;</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main"><span class="free">⇢</span></span> dropM_trm <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">0</span>"</span></span> <span class="main">|</span>
  mueta  <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">&lt;</span><span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">&gt;</span> <span class="main">(</span><span class="keyword1">μ</span> <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="main">:</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span> <span class="keyword1"><span class="free"><span class="hidden">⇩</span><sub>C</sub>⇢</span></span> <span class="main">(</span>dropM_cmd <span class="main">(</span><span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">[</span><span class="main">0</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">◇</span><span class="keyword1">]<span class="hidden">⇧</span><sup>C</sup></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>

  lambda <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main"><span class="free">⇢</span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">λ</span> <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="main">:</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main"><span class="free">⇢</span></span> <span class="main">(</span><span class="main">λ</span> <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="main">:</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  appL   <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main"><span class="free">⇢</span></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">°</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main"><span class="free">⇢</span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">°</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  appR   <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main"><span class="free">⇢</span></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">°</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main"><span class="free">⇢</span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">°</span><span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  mu     <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="keyword1"><span class="free"><span class="hidden">⇩</span><sub>C</sub>⇢</span></span> <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span><span class="keyword1">μ</span> <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="main">:</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span> <span class="main"><span class="free">⇢</span></span> <span class="main">(</span><span class="keyword1">μ</span> <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="main">:</span> <span class="free"><span class="bound"><span class="entity">d</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  cmd    <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main"><span class="free">⇢</span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">&lt;</span><span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">&gt;</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="keyword1"><span class="free"><span class="hidden">⇩</span><sub>C</sub>⇢</span></span> <span class="main">(</span><span class="main">&lt;</span><span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">&gt;</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">inductive_cases</span></span> redE <span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">`</span><span class="free">i</span> <span class="main">⇢</span> <span class="free">s</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span> <span class="free">T</span> <span class="main">:</span> <span class="free">t</span><span class="main">)</span> <span class="main">⇢</span> <span class="free">s</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">s</span><span class="main">°</span><span class="free">t</span> <span class="main">⇢</span> <span class="free">u</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">μ</span> <span class="free">T</span> <span class="main">:</span> <span class="free">c</span><span class="main">)</span> <span class="main">⇢</span> <span class="free">t</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">&lt;</span><span class="free">i</span><span class="main">&gt;</span> <span class="free">t</span> <span class="keyword1"><span class="hidden">⇩</span><sub>C</sub>⇢</span> <span class="free">c</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Reflexive transitive closure›</span></span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">beta_rtc_term</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>trm<span class="main">,</span> trm<span class="main">]</span> <span class="main">⇒</span> bool"</span></span>  <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">⇢<span class="hidden">⇧</span><sup>*</sup></span>"</span> 50<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  refl_term <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main"><span class="free">⇢<span class="hidden">⇧</span><sup>*</sup></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span>"</span></span> <span class="main">|</span>
  step_term<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">⇢</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">;</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main"><span class="free">⇢<span class="hidden">⇧</span><sup>*</sup></span></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main"><span class="free">⇢<span class="hidden">⇧</span><sup>*</sup></span></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span>"</span></span>

<span class="keyword1" id="Reduction-step_term2"><span class="command">lemma</span></span> step_term2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">s</span> <span class="main">⇢<span class="hidden">⇧</span><sup>*</sup></span> <span class="free">t</span><span class="main">;</span> <span class="free">t</span> <span class="main">⇢</span> <span class="free">u</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">s</span> <span class="main">⇢<span class="hidden">⇧</span><sup>*</sup></span> <span class="free">u</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> beta_rtc_term.induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> step_term<span class="main">)</span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">beta_rtc_command</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>cmd<span class="main">,</span> cmd<span class="main">]</span> <span class="main">⇒</span> bool"</span></span>  <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1"><span class="hidden">⇩</span><sub>C</sub>⇢<span class="hidden">⇧</span><sup>*</sup></span>"</span> 50<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  refl_command <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="keyword1"><span class="free"><span class="hidden">⇩</span><sub>C</sub>⇢<span class="hidden">⇧</span><sup>*</sup></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span>"</span></span> <span class="main">|</span>
  step_command<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="keyword1"><span class="hidden">⇩</span><sub>C</sub>⇢</span> <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="keyword1"><span class="free"><span class="hidden">⇩</span><sub>C</sub>⇢<span class="hidden">⇧</span><sup>*</sup></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="keyword1"><span class="free"><span class="hidden">⇩</span><sub>C</sub>⇢<span class="hidden">⇧</span><sup>*</sup></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span>"</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹The beta reduction relation is included in the reflexive transitive closure.›</span></span>
<span class="keyword1" id="Reduction-rtc_term_incl"><span class="command">lemma</span></span> rtc_term_incl <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">⇢</span> <span class="free">t</span> <span class="main">⟹</span> <span class="free">s</span> <span class="main">⇢<span class="hidden">⇧</span><sup>*</sup></span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> beta_rtc_term.simps<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="keyword1"><span class="hidden">⇩</span><sub>C</sub>⇢</span> <span class="free">d</span> <span class="main">⟹</span> <span class="free">c</span> <span class="keyword1"><span class="hidden">⇩</span><sub>C</sub>⇢<span class="hidden">⇧</span><sup>*</sup></span> <span class="free">d</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> step_command<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Proof that the reflexive transitive closure as defined above is transitive.›</span></span>
  
<span class="keyword1" id="Reduction-rtc_term_trans"><span class="command">lemma</span></span> rtc_term_trans <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">⇢<span class="hidden">⇧</span><sup>*</sup></span> <span class="free">t</span> <span class="main">⟹</span> <span class="free">t</span> <span class="main">⇢<span class="hidden">⇧</span><sup>*</sup></span> <span class="free">u</span> <span class="main">⟹</span> <span class="free">s</span> <span class="main">⇢<span class="hidden">⇧</span><sup>*</sup></span> <span class="free">u</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> beta_rtc_term.induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> step_term<span class="main">)</span>

<span class="keyword1" id="Reduction-rtc_command_trans"><span class="command">lemma</span></span> rtc_command_trans<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="keyword1"><span class="hidden">⇩</span><sub>C</sub>⇢<span class="hidden">⇧</span><sup>*</sup></span> <span class="free">d</span> <span class="main">⟹</span> <span class="free">d</span> <span class="keyword1"><span class="hidden">⇩</span><sub>C</sub>⇢<span class="hidden">⇧</span><sup>*</sup></span> <span class="free">e</span> <span class="main">⟹</span> <span class="free">c</span> <span class="keyword1"><span class="hidden">⇩</span><sub>C</sub>⇢<span class="hidden">⇧</span><sup>*</sup></span> <span class="free">e</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> beta_rtc_command.induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> step_command<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Congruence rules for the reflexive transitive closure.›</span></span>

<span class="keyword1" id="Reduction-rtc_lambda"><span class="command">lemma</span></span> rtc_lambda<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">⇢<span class="hidden">⇧</span><sup>*</sup></span> <span class="free">t</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">λ</span> <span class="free">T</span> <span class="main">:</span> <span class="free">s</span><span class="main">)</span> <span class="main">⇢<span class="hidden">⇧</span><sup>*</sup></span> <span class="main">(</span><span class="main">λ</span> <span class="free">T</span> <span class="main">:</span> <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> beta_rtc_term.induct<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span> <span class="main">(</span><span class="operator">meson</span> red_term_red_cmd.lambda step_term<span class="main">)</span>

<span class="keyword1" id="Reduction-rtc_appL"><span class="command">lemma</span></span> rtc_appL<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">⇢<span class="hidden">⇧</span><sup>*</sup></span> <span class="free">u</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">s</span><span class="main">°</span><span class="free">t</span><span class="main">)</span> <span class="main">⇢<span class="hidden">⇧</span><sup>*</sup></span> <span class="main">(</span><span class="free">u</span><span class="main">°</span><span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> beta_rtc_term.induct<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span> <span class="main">(</span><span class="operator">meson</span> appL step_term<span class="main">)</span>
    
<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="ContextFacts">
<div class="head">
<h1>Theory ContextFacts</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Contextual typing›</span></span>

<span class="keyword1"><span class="command">theory</span></span> ContextFacts
<span class="keyword2"><span class="keyword">imports</span></span>
    <a href="#Reduction">Reduction</a>
    <a href="#Types">Types</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Naturally, we may wonder when instantiating the hole in a context is type-preserving.
    To assess this, we define a typing judgement for contexts.›</span></span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">typing_ctxt</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>nat <span class="main">⇒</span> type<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span>nat <span class="main">⇒</span> type<span class="main">)</span> <span class="main">⇒</span> ctxt <span class="main">⇒</span> type <span class="main">⇒</span> type <span class="main">⇒</span> bool"</span></span>
                         <span class="main">(</span><span class="quoted">"_ <span class="keyword1">,</span> _ <span class="keyword1">⊢<span class="hidden">⇩</span><sub>c</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>x</sub><span class="hidden">⇩</span><sub>t</sub></span> _ <span class="keyword1">:</span> _ <span class="keyword1">⇐</span> _"</span> <span class="main">[</span>50<span class="main">,</span> 50<span class="main">,</span> 50<span class="main">,</span> 50<span class="main">,</span> 50<span class="main">]</span> 50<span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span>
  type_ctxtEmpty <span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main"><span class="free">,</span></span> <span class="free"><span class="bound"><span class="entity">Δ</span></span></span> <span class="keyword1"><span class="free">⊢<span class="hidden">⇩</span><sub>c</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>x</sub><span class="hidden">⇩</span><sub>t</sub></span></span> <span class="main">◇</span> <span class="main"><span class="free">:</span></span> <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="main"><span class="free">⇐</span></span> <span class="free"><span class="bound"><span class="entity">T</span></span></span>"</span></span> <span class="main">|</span>
  type_ctxtApp   <span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main"><span class="free">,</span></span> <span class="free"><span class="bound"><span class="entity">Δ</span></span></span> <span class="keyword1"><span class="free">⊢<span class="hidden">⇩</span><sub>c</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>x</sub><span class="hidden">⇩</span><sub>t</sub></span></span> <span class="free"><span class="bound"><span class="entity">E</span></span></span> <span class="main"><span class="free">:</span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">T1</span></span></span><span class="main">→</span><span class="free"><span class="bound"><span class="entity">T2</span></span></span><span class="main">)</span> <span class="main"><span class="free">⇐</span></span> <span class="free"><span class="bound"><span class="entity">U</span></span></span><span class="main">;</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">Δ</span></span></span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>T</sub></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">:</span> <span class="free"><span class="bound"><span class="entity">T1</span></span></span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main"><span class="free">,</span></span> <span class="free"><span class="bound"><span class="entity">Δ</span></span></span> <span class="keyword1"><span class="free">⊢<span class="hidden">⇩</span><sub>c</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>x</sub><span class="hidden">⇩</span><sub>t</sub></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">E</span></span></span> <span class="main"><span class="hidden">⇧</span><sup>∙</sup></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main"><span class="free">:</span></span> <span class="free"><span class="bound"><span class="entity">T2</span></span></span> <span class="main"><span class="free">⇐</span></span> <span class="free"><span class="bound"><span class="entity">U</span></span></span>"</span></span>

<span class="keyword1"><span class="command">inductive_cases</span></span> typing_ctxt_elims <span class="main">[</span><span class="operator">elim</span><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span></span></span></span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">Γ</span><span class="main">,</span> <span class="free">Δ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>c</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>x</sub><span class="hidden">⇩</span><sub>t</sub></span> <span class="main">◇</span> <span class="main">:</span> <span class="free">T</span> <span class="main">⇐</span> <span class="free">T</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">Γ</span><span class="main">,</span> <span class="free">Δ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>c</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>x</sub><span class="hidden">⇩</span><sub>t</sub></span> <span class="main">(</span><span class="free">E</span> <span class="main"><span class="hidden">⇧</span><sup>∙</sup></span> <span class="free">t</span><span class="main">)</span> <span class="main">:</span> <span class="free">T</span> <span class="main">⇐</span> <span class="free">U</span>"</span></span>

<span class="keyword1" id="ContextFacts-typing_ctxt_correct1"><span class="command">lemma</span></span> typing_ctxt_correct1<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span><span class="main">,</span> <span class="free">Δ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>T</sub></span> <span class="main">(</span>ctxt_subst <span class="free">E</span> <span class="free">r</span><span class="main">)</span> <span class="main">:</span> <span class="free">T</span>  <span class="main">⟹</span> <span class="main">∃</span><span class="bound">U</span><span class="main">.</span> <span class="main">(</span><span class="free">Γ</span><span class="main">,</span> <span class="free">Δ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>T</sub></span> <span class="free">r</span> <span class="main">:</span> <span class="bound">U</span> <span class="main">∧</span> <span class="free">Γ</span><span class="main">,</span> <span class="free">Δ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>c</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>x</sub><span class="hidden">⇩</span><sub>t</sub></span> <span class="free">E</span> <span class="main">:</span> <span class="free">T</span> <span class="main">⇐</span> <span class="bound">U</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">E</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">Γ</span></span> <span class="quoted"><span class="free">Δ</span></span> <span class="quoted"><span class="free">T</span></span> <span class="quoted"><span class="free">r</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">force</span><span class="main">)</span>

<span class="keyword1" id="ContextFacts-typing_ctxt_correct2"><span class="command">lemma</span></span> typing_ctxt_correct2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span><span class="main">,</span> <span class="free">Δ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>c</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>x</sub><span class="hidden">⇩</span><sub>t</sub></span> <span class="free">E</span> <span class="main">:</span> <span class="free">T</span> <span class="main">⇐</span> <span class="free">U</span> <span class="main">⟹</span> <span class="free">Γ</span><span class="main">,</span> <span class="free">Δ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>T</sub></span> <span class="free">r</span> <span class="main">:</span> <span class="free">U</span>  <span class="main">⟹</span> <span class="free">Γ</span><span class="main">,</span> <span class="free">Δ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>T</sub></span> <span class="main">(</span>ctxt_subst <span class="free">E</span> <span class="free">r</span><span class="main">)</span> <span class="main">:</span> <span class="free">T</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">r</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> typing_ctxt.induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="ContextFacts-ctxt_subst_basecase"><span class="command">lemma</span></span> ctxt_subst_basecase<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">n</span><span class="main">.</span> <span class="free">c</span><span class="main">[</span><span class="bound">n</span> <span class="main">=</span> <span class="bound">n</span> <span class="main">◇</span><span class="keyword1">]<span class="hidden">⇧</span><sup>C</sup></span> <span class="main">=</span>  <span class="free">c</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">n</span><span class="main">.</span> <span class="free">t</span><span class="main">[</span><span class="bound">n</span> <span class="main">=</span> <span class="bound">n</span> <span class="main">◇</span><span class="keyword1">]<span class="hidden">⇧</span><sup>T</sup></span> <span class="main">=</span>  <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">c</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span> 

<span class="keyword1" id="ContextFacts-ctxt_subst_caseApp"><span class="command">lemma</span></span> ctxt_subst_caseApp<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">n</span> <span class="bound">E</span> <span class="bound">s</span><span class="main">.</span> <span class="main">(</span><span class="free">c</span><span class="main">[</span><span class="bound">n</span><span class="main">=</span><span class="bound">n</span> <span class="main">(</span>liftM_ctxt <span class="bound">E</span> <span class="bound">n</span><span class="main">)</span><span class="keyword1">]<span class="hidden">⇧</span><sup>C</sup></span><span class="main">)</span><span class="main">[</span><span class="bound">n</span><span class="main">=</span><span class="bound">n</span> <span class="main">(</span><span class="main">◇</span> <span class="main"><span class="hidden">⇧</span><sup>∙</sup></span> <span class="main">(</span>liftM_trm <span class="bound">s</span> <span class="bound">n</span><span class="main">)</span><span class="main">)</span><span class="keyword1">]<span class="hidden">⇧</span><sup>C</sup></span> <span class="main">=</span> <span class="free">c</span><span class="main">[</span><span class="bound">n</span><span class="main">=</span><span class="bound">n</span> <span class="main">(</span><span class="main">(</span>liftM_ctxt <span class="bound">E</span> <span class="bound">n</span><span class="main">)</span> <span class="main"><span class="hidden">⇧</span><sup>∙</sup></span> <span class="main">(</span>liftM_trm <span class="bound">s</span> <span class="bound">n</span><span class="main">)</span><span class="main">)</span><span class="keyword1">]<span class="hidden">⇧</span><sup>C</sup></span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">n</span> <span class="bound">E</span> <span class="bound">s</span><span class="main">.</span> <span class="main">(</span><span class="free">t</span><span class="main">[</span><span class="bound">n</span><span class="main">=</span><span class="bound">n</span> <span class="main">(</span>liftM_ctxt <span class="bound">E</span> <span class="bound">n</span><span class="main">)</span><span class="keyword1">]<span class="hidden">⇧</span><sup>T</sup></span><span class="main">)</span><span class="main">[</span><span class="bound">n</span><span class="main">=</span><span class="bound">n</span> <span class="main">(</span><span class="main">◇</span> <span class="main"><span class="hidden">⇧</span><sup>∙</sup></span> <span class="main">(</span>liftM_trm <span class="bound">s</span> <span class="bound">n</span><span class="main">)</span><span class="main">)</span><span class="keyword1">]<span class="hidden">⇧</span><sup>T</sup></span> <span class="main">=</span> <span class="free">t</span><span class="main">[</span><span class="bound">n</span><span class="main">=</span><span class="bound">n</span> <span class="main">(</span><span class="main">(</span>liftM_ctxt <span class="bound">E</span> <span class="bound">n</span><span class="main">)</span> <span class="main"><span class="hidden">⇧</span><sup>∙</sup></span> <span class="main">(</span>liftM_trm <span class="bound">s</span> <span class="bound">n</span><span class="main">)</span><span class="main">)</span><span class="keyword1">]<span class="hidden">⇧</span><sup>T</sup></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">c</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> liftLM_comm_ctxt liftLM_comm liftMM_comm_ctxt  liftMM_comm liftM_ctxt_struct_subst<span class="main">)</span>

<span class="keyword1" id="ContextFacts-ctxt_subst"><span class="command">lemma</span></span> ctxt_subst<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span><span class="main">,</span> <span class="free">Δ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>c</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>x</sub><span class="hidden">⇩</span><sub>t</sub></span> <span class="free">E</span> <span class="main">:</span> <span class="free">U</span> <span class="main">⇐</span> <span class="free">T</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">(</span>ctxt_subst <span class="free">E</span> <span class="main">(</span><span class="keyword1">μ</span> <span class="free">T</span> <span class="main">:</span> <span class="free">c</span><span class="main">)</span><span class="main">)</span> <span class="main">⇢<span class="hidden">⇧</span><sup>*</sup></span> <span class="keyword1">μ</span> <span class="free">U</span> <span class="main">:</span> <span class="main">(</span><span class="free">c</span><span class="main">[</span><span class="main">0</span> <span class="main">=</span> <span class="main">0</span> <span class="main">(</span>liftM_ctxt <span class="free">E</span> <span class="main">0</span><span class="main">)</span><span class="keyword1">]<span class="hidden">⇧</span><sup>C</sup></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">E</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">U</span></span> <span class="quoted"><span class="free">T</span></span> <span class="quoted"><span class="free">Γ</span></span> <span class="quoted"><span class="free">Δ</span></span> <span class="quoted"><span class="free">c</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> ContextEmpty
  <span class="keyword1"><span class="command">have</span></span> ctxtEmpty_inv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Γ</span><span class="main">,</span> <span class="skolem">Δ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>c</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>x</sub><span class="hidden">⇩</span><sub>t</sub></span> <span class="main">◇</span> <span class="main">:</span> <span class="skolem">U</span> <span class="main">⇐</span> <span class="skolem">T</span> <span class="main">⟹</span> <span class="skolem">U</span> <span class="main">=</span> <span class="skolem">T</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">Γ</span></span> <span class="quoted"><span class="skolem">Δ</span></span> <span class="quoted"><span class="quoted">"<span class="main">◇</span>"</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> typing_ctxt.cases<span class="main"><span class="keyword3">,</span></span> <span class="operator">fastforce</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> ContextEmpty <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> ctxtEmpty_inv <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ctxt_subst_basecase<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>ContextApp <span class="skolem">E</span> <span class="skolem">x</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">clarsimp</span> <span class="main">(</span><span class="operator">rule</span> rtc_term_trans<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> rtc_appL<span class="main"><span class="keyword3">,</span></span> <span class="operator">assumption</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> step_term<span class="main"><span class="keyword3">,</span></span> <span class="operator">force</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ctxt_subst_caseApp<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>
  
<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="TypePreservation">
<div class="head">
<h1>Theory TypePreservation</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Type preservation›</span></span>

<span class="keyword1"><span class="command">theory</span></span> TypePreservation
<span class="keyword2"><span class="keyword">imports</span></span>
    <a href="#ContextFacts">ContextFacts</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Shifting lambda variables preserves well-typedness.›</span></span>
  
<span class="keyword1" id="TypePreservation-liftL_type"><span class="command">lemma</span></span> liftL_type<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="free">Γ</span><span class="main">,</span> <span class="free">Δ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>T</sub></span> <span class="free">t</span> <span class="main">:</span> <span class="free">T</span> <span class="main">⟹</span> <span class="main">∀</span><span class="bound">k</span><span class="main">.</span> <span class="free">Γ</span><span class="main">⟨</span><span class="bound">k</span><span class="main">:</span><span class="free">U</span><span class="main">⟩</span><span class="main">,</span> <span class="free">Δ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>T</sub></span> <span class="main">(</span>liftL_trm <span class="free">t</span> <span class="bound">k</span><span class="main">)</span> <span class="main">:</span> <span class="free">T</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">Γ</span><span class="main">,</span> <span class="free">Δ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span> <span class="free">c</span> <span class="main">⟹</span> <span class="main">∀</span><span class="bound">k</span><span class="main">.</span> <span class="free">Γ</span><span class="main">⟨</span><span class="bound">k</span><span class="main">:</span><span class="free">U</span><span class="main">⟩</span><span class="main">,</span> <span class="free">Δ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">(</span>liftL_cmd <span class="free">c</span> <span class="bound">k</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> typing_trm_typing_cmd.inducts<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Shifting mu variables preserves well-typedness.›</span></span>
  
<span class="keyword1" id="TypePreservation-liftM_type"><span class="command">lemma</span></span> liftM_type<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="free">Γ</span><span class="main">,</span> <span class="free">Δ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>T</sub></span> <span class="free">t</span> <span class="main">:</span> <span class="free">T</span> <span class="main">⟹</span> <span class="main">∀</span><span class="bound">k</span><span class="main">.</span> <span class="free">Γ</span><span class="main">,</span> <span class="free">Δ</span><span class="main">⟨</span><span class="bound">k</span><span class="main">:</span><span class="free">U</span><span class="main">⟩</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>T</sub></span> <span class="main">(</span>liftM_trm <span class="free">t</span> <span class="bound">k</span><span class="main">)</span> <span class="main">:</span> <span class="free">T</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">Γ</span><span class="main">,</span> <span class="free">Δ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span> <span class="free">c</span> <span class="main">⟹</span> <span class="main">∀</span><span class="bound">k</span><span class="main">.</span> <span class="free">Γ</span><span class="main">,</span> <span class="free">Δ</span><span class="main">⟨</span><span class="bound">k</span><span class="main">:</span><span class="free">U</span><span class="main">⟩</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">(</span>liftM_cmd <span class="free">c</span> <span class="bound">k</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> typing_trm_typing_cmd.inducts<span class="main">)</span> <span class="operator">auto</span>
    
<span class="keyword1" id="TypePreservation-dropM_type"><span class="command">lemma</span></span> dropM_type<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">,</span> <span class="free">Δ1</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>T</sub></span> <span class="free">t</span> <span class="main">:</span> <span class="free">T</span> <span class="main">⟹</span> <span class="free">k</span> <span class="main">∉</span> fmv_trm <span class="free">t</span> <span class="main">0</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span><span class="main">&lt;</span><span class="free">k</span> <span class="main">⟶</span> <span class="free">Δ1</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">Δ</span> <span class="bound">x</span><span class="main">)</span> 
    <span class="main">⟹</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span><span class="main">&gt;</span><span class="free">k</span> <span class="main">⟶</span> <span class="free">Δ1</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">Δ</span> <span class="main">(</span><span class="bound">x</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">Γ</span> <span class="main">,</span> <span class="free">Δ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>T</sub></span> dropM_trm <span class="free">t</span> <span class="free">k</span> <span class="main">:</span> <span class="free">T</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">,</span> <span class="free">Δ1</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span> <span class="free">c</span> <span class="main">⟹</span> <span class="free">k</span> <span class="main">∉</span> fmv_cmd <span class="free">c</span> <span class="main">0</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span><span class="main">&lt;</span><span class="free">k</span> <span class="main">⟶</span> <span class="free">Δ1</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">Δ</span> <span class="bound">x</span><span class="main">)</span> 
    <span class="main">⟹</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span><span class="main">&gt;</span><span class="free">k</span> <span class="main">⟶</span> <span class="free">Δ1</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">Δ</span> <span class="main">(</span><span class="bound">x</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">Γ</span> <span class="main">,</span> <span class="free">Δ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span> dropM_cmd <span class="free">c</span> <span class="free">k</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">k</span></span> <span class="quoted"><span class="free">Δ</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="quoted"><span class="free">k</span></span> <span class="quoted"><span class="free">Δ</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> typing_trm_typing_cmd.inducts<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>activate <span class="skolem">Γ</span> <span class="skolem">Δ</span> <span class="skolem">T</span> <span class="skolem">c</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">erule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">k</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> meta_allE<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">insert</span> fmv_suc<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> shift_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">fastforce</span><span class="main"><span class="keyword3">+</span></span>

  
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Lifting $\lambda$ and $\mu$-variables in contexts preserves contextual typing judgements.›</span></span>
  
<span class="keyword1" id="TypePreservation-liftL_ctxt_type"><span class="command">lemma</span></span> liftL_ctxt_type<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span><span class="main">,</span> <span class="free">Δ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>c</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>x</sub><span class="hidden">⇩</span><sub>t</sub></span> <span class="free">E</span> <span class="main">:</span> <span class="free">T</span> <span class="main">⇐</span> <span class="free">U</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">k</span><span class="main">.</span> <span class="free">Γ</span><span class="main">⟨</span><span class="bound">k</span><span class="main">:</span><span class="free">T1</span><span class="main">⟩</span><span class="main">,</span> <span class="free">Δ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>c</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>x</sub><span class="hidden">⇩</span><sub>t</sub></span> <span class="main">(</span>liftL_ctxt <span class="free">E</span> <span class="bound">k</span><span class="main">)</span> <span class="main">:</span> <span class="free">T</span> <span class="main">⇐</span> <span class="free">U</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> typing_ctxt.induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> liftL_type<span class="main">)</span>

<span class="keyword1" id="TypePreservation-liftM_ctxt_type"><span class="command">lemma</span></span> liftM_ctxt_type<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span><span class="main">,</span> <span class="free">Δ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>c</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>x</sub><span class="hidden">⇩</span><sub>t</sub></span> <span class="free">E</span> <span class="main">:</span> <span class="free">T</span> <span class="main">⇐</span> <span class="free">U</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="free">Γ</span><span class="main">,</span> <span class="free">Δ</span><span class="main">⟨</span><span class="free">k</span><span class="main">:</span><span class="free">T1</span><span class="main">⟩</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>c</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>x</sub><span class="hidden">⇩</span><sub>t</sub></span> <span class="main">(</span>liftM_ctxt <span class="free">E</span> <span class="free">k</span><span class="main">)</span> <span class="main">:</span> <span class="free">T</span> <span class="main">⇐</span> <span class="free">U</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> typing_ctxt.induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> liftM_type<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Substitution lemma for logical substitution.›</span></span>
  
<span class="keyword1"><span class="command">theorem</span></span> subst_type<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">Γ1</span><span class="main">,</span> <span class="free">Δ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>T</sub></span> <span class="free">t</span> <span class="main">:</span> <span class="free">T</span> <span class="main">⟹</span> <span class="free">Γ</span><span class="main">,</span> <span class="free">Δ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>T</sub></span> <span class="free">r</span> <span class="main">:</span> <span class="free">T1</span> <span class="main">⟹</span> <span class="free">Γ1</span> <span class="main">=</span> <span class="free">Γ</span><span class="main">⟨</span><span class="free">k</span><span class="main">:</span><span class="free">T1</span><span class="main">⟩</span> <span class="main">⟹</span> <span class="free">Γ</span><span class="main">,</span> <span class="free">Δ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>T</sub></span> <span class="free">t</span><span class="main">[</span><span class="free">r</span><span class="main">/</span><span class="free">k</span><span class="keyword1">]<span class="hidden">⇧</span><sup>T</sup></span> <span class="main">:</span> <span class="free">T</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">Γ1</span><span class="main">,</span> <span class="free">Δ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span> <span class="free">c</span> <span class="main">⟹</span> <span class="free">Γ</span><span class="main">,</span> <span class="free">Δ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>T</sub></span> <span class="free">r</span> <span class="main">:</span> <span class="free">T1</span> <span class="main">⟹</span> <span class="free">Γ1</span> <span class="main">=</span> <span class="free">Γ</span><span class="main">⟨</span><span class="free">k</span><span class="main">:</span><span class="free">T1</span><span class="main">⟩</span> <span class="main">⟹</span> <span class="free">Γ</span><span class="main">,</span> <span class="free">Δ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span> <span class="free">c</span><span class="main">[</span><span class="free">r</span><span class="main">/</span><span class="free">k</span><span class="keyword1">]<span class="hidden">⇧</span><sup>C</sup></span> "</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">Γ</span></span> <span class="quoted"><span class="free">k</span></span> <span class="quoted"><span class="free">T1</span></span> <span class="quoted"><span class="free">r</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="quoted"><span class="free">Γ</span></span> <span class="quoted"><span class="free">k</span></span> <span class="quoted"><span class="free">r</span></span> <span class="quoted"><span class="free">T1</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> typing_trm_typing_cmd.inducts<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>lambda <span class="skolem">Γ</span> <span class="skolem">T1</span> <span class="skolem">Δ</span> <span class="skolem">t</span> <span class="skolem">T2</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">-</span><span class="main">(</span><span class="operator">rotate_tac</span> 2<span class="main"><span class="keyword3">,</span></span> <span class="operator">drule</span> liftL_type<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">fastforce</span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>activate <span class="skolem">Γ</span> <span class="skolem">Δ</span> <span class="skolem">T</span> <span class="skolem">c</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">-</span><span class="main">(</span><span class="operator">rotate_tac</span> 2<span class="main"><span class="keyword3">,</span></span> <span class="operator">drule</span> liftM_type<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">fastforce</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">force</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Substitution lemma for structural substitution. The proof is by induction on the first typing judgement.›</span></span>
  
<span class="keyword1" id="TypePreservation-struct_subst_command"><span class="command">lemma</span></span> struct_subst_command<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span><span class="main">,</span> <span class="free">Δ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>T</sub></span> <span class="free">t</span> <span class="main">:</span> <span class="free">T</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">Δ</span> <span class="free">x</span> <span class="main">=</span> <span class="free">T</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">,</span> <span class="free">Δ'</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>c</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>x</sub><span class="hidden">⇩</span><sub>t</sub></span> <span class="free">E</span> <span class="main">:</span> <span class="free">U</span> <span class="main">⇐</span> <span class="free">T1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">Δ</span> <span class="main">=</span> <span class="free">Δ'</span><span class="main">⟨</span><span class="free">α</span><span class="main">:</span><span class="free">T1</span><span class="main">⟩</span>"</span></span>
          <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">Γ</span> <span class="main">,</span> <span class="free">Δ'</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>c</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>x</sub><span class="hidden">⇩</span><sub>t</sub></span> <span class="free">E</span> <span class="main">:</span> <span class="free">U</span> <span class="main">⇐</span> <span class="free">T1</span> <span class="main">⟹</span> <span class="free">Δ</span> <span class="main">=</span> <span class="free">Δ'</span><span class="main">⟨</span><span class="free">α</span><span class="main">:</span><span class="free">T1</span><span class="main">⟩</span> <span class="main">⟹</span> <span class="free">Γ</span> <span class="main">,</span> <span class="free">Δ'</span><span class="main">⟨</span><span class="free">β</span><span class="main">:</span><span class="free">U</span><span class="main">⟩</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>T</sub></span> <span class="free">t</span><span class="main">[</span><span class="free">α</span><span class="main">=</span><span class="free">β</span> <span class="main">(</span>liftM_ctxt <span class="free">E</span> <span class="free">β</span><span class="main">)</span><span class="keyword1">]<span class="hidden">⇧</span><sup>T</sup></span> <span class="main">:</span> <span class="free">T</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="free">Γ</span><span class="main">,</span><span class="main">(</span> <span class="free">Δ'</span><span class="main">⟨</span><span class="free">β</span><span class="main">:</span><span class="free">U</span><span class="main">⟩</span><span class="main">)</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">(</span><span class="main">&lt;</span><span class="free">x</span><span class="main">&gt;</span> <span class="free">t</span><span class="main">)</span><span class="main">[</span><span class="free">α</span><span class="main">=</span><span class="free">β</span> <span class="main">(</span>liftM_ctxt <span class="free">E</span> <span class="free">β</span><span class="main">)</span><span class="keyword1">]<span class="hidden">⇧</span><sup>C</sup></span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> conjI<span class="main"><span class="keyword3">,</span></span> <span class="operator">force</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">clarsimp</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> conjI<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> liftM_ctxt_type passivate shift_eq typing_ctxt_correct2<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">theorem</span></span> struct_subst_type<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">Γ</span><span class="main">,</span> <span class="free">Δ1</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>T</sub></span> <span class="free">t</span> <span class="main">:</span> <span class="free">T</span> <span class="main">⟹</span> <span class="free">Γ</span><span class="main">,</span> <span class="free">Δ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>c</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>x</sub><span class="hidden">⇩</span><sub>t</sub></span> <span class="free">E</span> <span class="main">:</span> <span class="free">U</span> <span class="main">⇐</span> <span class="free">T1</span> <span class="main">⟹</span> <span class="free">Δ1</span> <span class="main">=</span> <span class="free">Δ</span><span class="main">⟨</span><span class="free">α</span><span class="main">:</span><span class="free">T1</span><span class="main">⟩</span> <span class="main">⟹</span> <span class="free">Γ</span><span class="main">,</span> <span class="free">Δ</span><span class="main">⟨</span><span class="free">β</span><span class="main">:</span><span class="free">U</span><span class="main">⟩</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>T</sub></span> <span class="free">t</span><span class="main">[</span><span class="free">α</span><span class="main">=</span><span class="free">β</span> <span class="main">(</span>liftM_ctxt <span class="free">E</span> <span class="free">β</span><span class="main">)</span><span class="keyword1">]<span class="hidden">⇧</span><sup>T</sup></span> <span class="main">:</span> <span class="free">T</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">Γ</span><span class="main">,</span> <span class="free">Δ1</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span> <span class="free">c</span> <span class="main">⟹</span> <span class="free">Γ</span><span class="main">,</span> <span class="free">Δ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>c</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>x</sub><span class="hidden">⇩</span><sub>t</sub></span> <span class="free">E</span> <span class="main">:</span> <span class="free">U</span> <span class="main">⇐</span> <span class="free">T1</span>  <span class="main">⟹</span> <span class="free">Δ1</span> <span class="main">=</span> <span class="free">Δ</span><span class="main">⟨</span><span class="free">α</span><span class="main">:</span><span class="free">T1</span><span class="main">⟩</span> <span class="main">⟹</span> <span class="free">Γ</span><span class="main">,</span> <span class="free">Δ</span><span class="main">⟨</span><span class="free">β</span><span class="main">:</span><span class="free">U</span><span class="main">⟩</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span> <span class="free">c</span><span class="main">[</span><span class="free">α</span><span class="main">=</span><span class="free">β</span> <span class="main">(</span>liftM_ctxt <span class="free">E</span> <span class="free">β</span><span class="main">)</span><span class="keyword1">]<span class="hidden">⇧</span><sup>C</sup></span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">Δ</span></span> <span class="quoted"><span class="free">T1</span></span> <span class="quoted"><span class="free">E</span></span> <span class="quoted"><span class="free">U</span></span> <span class="quoted"><span class="free">β</span></span> <span class="quoted"><span class="free">α</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="quoted"><span class="free">Δ</span></span> <span class="quoted"><span class="free">T1</span></span> <span class="quoted"><span class="free">E</span></span> <span class="quoted"><span class="free">U</span></span> <span class="quoted"><span class="free">β</span></span> <span class="quoted"><span class="free">α</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> typing_trm_typing_cmd.inducts<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>lambda <span class="skolem">Γ</span> <span class="skolem">T1</span> <span class="skolem">Δ</span> <span class="skolem">t</span> <span class="skolem">T2</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">-</span><span class="main">(</span><span class="operator">drule</span> liftL_ctxt_type<span class="main"><span class="keyword3">,</span></span> <span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> liftLM_comm_ctxt<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>activate <span class="skolem">Γ</span> <span class="skolem">Δ</span> <span class="skolem">T</span> <span class="skolem">c</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">-</span><span class="main">(</span><span class="operator">drule</span> liftM_ctxt_type<span class="main"><span class="keyword3">,</span></span> <span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> liftMM_comm_ctxt<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>passivate <span class="skolem">Γ</span> <span class="skolem">Δ</span> <span class="skolem">t</span> <span class="skolem">T</span> <span class="skolem">x</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> struct_subst_command <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">fastforce</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1" id="TypePreservation-struct_subst_type_command"><span class="command">lemma</span></span> struct_subst_type_command<span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="free">Γ</span><span class="main">,</span> <span class="free">Δ1</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span> <span class="free">c</span> <span class="main">⟹</span> <span class="free">Γ</span><span class="main">,</span> <span class="free">Δ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>c</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>x</sub><span class="hidden">⇩</span><sub>t</sub></span> <span class="free">E</span> <span class="main">:</span> <span class="free">U</span> <span class="main">⇐</span> <span class="free">T1</span> 
    <span class="main">⟹</span> <span class="free">Δ1</span> <span class="main">=</span> <span class="free">Δ</span><span class="main">⟨</span><span class="free">α</span><span class="main">:</span><span class="free">T1</span><span class="main">⟩</span>
    <span class="main">⟹</span> <span class="free">Γ</span><span class="main">,</span> <span class="free">Δ</span><span class="main">⟨</span><span class="free">β</span><span class="main">:</span><span class="free">U</span><span class="main">⟩</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span> <span class="free">c</span><span class="main">[</span><span class="free">α</span><span class="main">=</span><span class="free">β</span> <span class="main">(</span>liftM_ctxt <span class="free">E</span> <span class="free">β</span><span class="main">)</span><span class="keyword1">]<span class="hidden">⇧</span><sup>C</sup></span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> struct_subst_type <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  

<span class="keyword1" id="TypePreservation-dropM_env"><span class="command">lemma</span></span> dropM_env<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">Γ</span><span class="main">,</span> <span class="free">Δ1</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>T</sub></span> <span class="free">t</span><span class="main">[</span><span class="free">k</span><span class="main">=</span><span class="free">x</span> <span class="main">◇</span><span class="keyword1">]<span class="hidden">⇧</span><sup>T</sup></span> <span class="main">:</span> <span class="free">T</span> <span class="main">⟹</span> <span class="free">Δ1</span> <span class="main">=</span> <span class="free">Δ</span><span class="main">⟨</span><span class="free">x</span><span class="main">:</span><span class="main">(</span><span class="free">Δ</span> <span class="free">x</span><span class="main">)</span><span class="main">⟩</span> <span class="main">⟹</span> <span class="free">Γ</span> <span class="main">,</span> <span class="free">Δ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>T</sub></span> dropM_trm <span class="main">(</span><span class="free">t</span><span class="main">[</span><span class="free">k</span><span class="main">=</span><span class="free">x</span> <span class="main">◇</span><span class="keyword1">]<span class="hidden">⇧</span><sup>T</sup></span><span class="main">)</span> <span class="free">x</span> <span class="main">:</span> <span class="free">T</span>"</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">Γ</span><span class="main">,</span> <span class="free">Δ1</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span> <span class="free">c</span><span class="main">[</span><span class="free">k</span><span class="main">=</span><span class="free">x</span> <span class="main">◇</span><span class="keyword1">]<span class="hidden">⇧</span><sup>C</sup></span> <span class="main">⟹</span> <span class="free">Δ1</span> <span class="main">=</span> <span class="free">Δ</span><span class="main">⟨</span><span class="free">x</span><span class="main">:</span><span class="main">(</span><span class="free">Δ</span> <span class="free">x</span><span class="main">)</span><span class="main">⟩</span> <span class="main">⟹</span> <span class="free">Γ</span> <span class="main">,</span> <span class="free">Δ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span> dropM_cmd <span class="main">(</span><span class="free">c</span><span class="main">[</span><span class="free">k</span><span class="main">=</span><span class="free">x</span> <span class="main">◇</span><span class="keyword1">]<span class="hidden">⇧</span><sup>C</sup></span><span class="main">)</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">t</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="quoted"><span class="free">c</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">Γ</span></span> <span class="quoted"><span class="free">T</span></span> <span class="quoted"><span class="free">Δ1</span></span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">k</span></span> <span class="quoted"><span class="free">Δ</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="quoted"><span class="free">Γ</span></span> <span class="quoted"><span class="free">T</span></span> <span class="quoted"><span class="free">Δ1</span></span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">k</span></span> <span class="quoted"><span class="free">Δ</span></span><span class="main">)</span> <span class="operator">fastforce</span><span class="main"><span class="keyword3">+</span></span>
    
<span class="keyword1"><span class="command">theorem</span></span> type_preservation<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">Γ</span><span class="main">,</span> <span class="free">Δ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>T</sub></span> <span class="free">t</span> <span class="main">:</span> <span class="free">T</span> <span class="main">⟹</span> <span class="free">t</span> <span class="main">⇢</span> <span class="free">s</span> <span class="main">⟹</span> <span class="free">Γ</span><span class="main">,</span> <span class="free">Δ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>T</sub></span> <span class="free">s</span> <span class="main">:</span> <span class="free">T</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">Γ</span><span class="main">,</span> <span class="free">Δ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span> <span class="free">c</span> <span class="main">⟹</span> <span class="free">c</span> <span class="keyword1"><span class="hidden">⇩</span><sub>C</sub>⇢</span> <span class="free">d</span> <span class="main">⟹</span> <span class="free">Γ</span><span class="main">,</span> <span class="free">Δ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span> <span class="free">d</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">s</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="quoted"><span class="free">d</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> typing_trm_typing_cmd.inducts<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>app <span class="skolem">Γ</span> <span class="skolem">Δ</span> <span class="skolem">t</span> <span class="skolem">T1</span> <span class="skolem">T2</span> <span class="skolem">s</span> <span class="skolem">s'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> redE<span class="main"><span class="keyword3">;</span></span> <span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> subst_type<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="skolem">Γ</span> <span class="main">,</span> <span class="skolem">Δ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>T</sub></span> ctxt_subst <span class="main">(</span><span class="main">◇</span> <span class="main"><span class="hidden">⇧</span><sup>∙</sup></span> <span class="skolem">s</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">μ</span><span class="main">(</span><span class="skolem">T1</span><span class="main">→</span><span class="skolem">T2</span><span class="main">)</span> <span class="main">:</span> <span class="improper">c</span><span class="main">)</span> <span class="main">:</span> <span class="skolem">T2</span>"</span></span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> typing_ctxt_correct1<span class="main"><span class="keyword3">,</span></span> <span class="operator">clarsimp</span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="skolem">Γ</span> <span class="main">,</span> <span class="skolem">Δ</span><span class="main">⟨</span><span class="main">0</span><span class="main">:</span><span class="skolem">T2</span><span class="main">⟩</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span> <span class="improper">c</span><span class="main">[</span><span class="main">0</span><span class="main">=</span><span class="main">0</span> <span class="main">(</span>liftM_ctxt <span class="main">(</span><span class="main">◇</span> <span class="main"><span class="hidden">⇧</span><sup>∙</sup></span> <span class="skolem">s</span><span class="main">)</span> <span class="main">0</span><span class="main">)</span><span class="keyword1">]<span class="hidden">⇧</span><sup>C</sup></span>"</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> struct_subst_type_command<span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">force</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>passivate <span class="skolem">Γ</span> <span class="skolem">Δ</span> <span class="skolem">t</span> <span class="skolem">T</span> <span class="skolem">x</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> redE<span class="main"><span class="keyword3">,</span></span> <span class="operator">clarsimp</span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> struct_subst_type_command <span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> β <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">x</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> dropM_env<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>                  
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> dropM_type<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Progress">
<div class="head">
<h1>Theory Progress</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Progress›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Progress
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="#TypePreservation">TypePreservation</a>
<span class="keyword2"><span class="keyword">begin</span></span>
  
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹We say that a term $t$ is in \emph{weak-head-normal} form when one of the following conditions are met:
  \begin{enumerate}
    \item $t$ is a value,
    \item there exists $\alpha$ and $v$ such that $t = \mu:\tau.[\alpha]\ v$ with $\alpha \in fcv(v)$
          whenever $\alpha = 0$.
  \end{enumerate}›</span></span>
  
<span class="keyword1"><span class="command">fun</span></span> <span class="main">(</span>sequential<span class="main">)</span> <span class="entity">is_nf</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"trm <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">is_nf</span> <span class="main">(</span><span class="keyword1">μ</span> <span class="free"><span class="bound"><span class="entity">U</span></span></span><span class="main">:</span> <span class="main">(</span><span class="main">&lt;</span><span class="free"><span class="bound"><span class="entity">β</span></span></span><span class="main">&gt;</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>is_val <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">∧</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">β</span></span></span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟶</span> <span class="main">0</span> <span class="main">∈</span> fmv_trm <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">0</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">is_nf</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">=</span> is_val <span class="free"><span class="bound"><span class="entity">v</span></span></span>"</span></span>
  
<span class="keyword1" id="Progress-progress'"><span class="command">lemma</span></span> progress'<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">Γ</span><span class="main">,</span> <span class="free">Δ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>T</sub></span> <span class="free">t</span> <span class="main">:</span> <span class="free">T</span> <span class="main">⟹</span> lambda_closed <span class="free">t</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">s</span><span class="main">.</span> <span class="main">¬</span><span class="main">(</span><span class="free">t</span> <span class="main">⇢</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> is_nf <span class="free">t</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">Γ</span><span class="main">,</span> <span class="free">Δ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span> <span class="free">c</span> <span class="main">⟹</span> lambda_closedC <span class="free">c</span>  <span class="main">⟹</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">β</span> <span class="bound">t</span><span class="main">.</span> <span class="free">c</span> <span class="main">=</span> <span class="main">(</span><span class="main">&lt;</span><span class="bound">β</span><span class="main">&gt;</span> <span class="bound">t</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">d</span><span class="main">.</span> <span class="main">¬</span><span class="main">(</span><span class="bound">t</span> <span class="main">⇢</span> <span class="bound">d</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span> is_nf <span class="bound">t</span><span class="main">)</span>"</span></span>                            
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> typing_trm_typing_cmd.inducts<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>app <span class="skolem">Γ</span> <span class="skolem">Δ</span> <span class="skolem">t</span> <span class="skolem">T1</span> <span class="skolem">T2</span> <span class="skolem">s</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">-</span><span class="main">(</span><span class="operator">erule</span> type_arrow_elim<span class="main"><span class="keyword3">;</span></span> <span class="operator">force</span><span class="main">)</span>  
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>activate <span class="skolem">Γ</span> <span class="skolem">Δ</span> <span class="skolem">T</span> <span class="skolem">c</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">c</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>MVar <span class="skolem">α</span> <span class="skolem">t</span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> activate <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="skolem">t</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">force</span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">force</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">theorem</span></span> progress<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span><span class="main">,</span> <span class="free">Δ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>T</sub></span> <span class="free">t</span> <span class="main">:</span> <span class="free">T</span>"</span></span> <span class="quoted"><span class="quoted">"lambda_closed <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"is_nf <span class="free">t</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">s</span><span class="main">.</span> <span class="free">t</span> <span class="main">⇢</span> <span class="bound">s</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> progress'<span class="main">)</span>
    
<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Peirce">
<div class="head">
<h1>Theory Peirce</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Peirce›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Peirce
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="#Types">Types</a>
<span class="keyword2"><span class="keyword">begin</span></span>
  
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹As an example of our $\lambda\mu$ formalisation, we show show a
     $\lambda\mu$-term inhabiting Peirce's Law. The example is due to
     Parigot~\cite{DBLP:conf/lpar/Parigot92}.›</span></span>  
    
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Peirce's law: $((A \rightarrow B) \rightarrow A) \rightarrow A$.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span><span class="main">,</span> <span class="free">Δ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>T</sub></span> <span class="main">λ</span> <span class="main">(</span><span class="free">A</span><span class="main">→</span><span class="free">B</span><span class="main">)</span><span class="main">→</span><span class="free">A</span><span class="main">:</span> <span class="main">(</span><span class="keyword1">μ</span> <span class="free">A</span><span class="main">:</span><span class="main">(</span><span class="main">&lt;</span><span class="main">0</span><span class="main">&gt;</span><span class="main">(</span><span class="main">(</span><span class="main">`</span><span class="main">0</span><span class="main">)</span> <span class="main">°</span> <span class="main">(</span><span class="main">λ</span> <span class="free">A</span><span class="main">:</span> <span class="main">(</span><span class="keyword1">μ</span> <span class="free">B</span><span class="main">:</span><span class="main">(</span><span class="main">&lt;</span><span class="main">1</span><span class="main">&gt;</span> <span class="main">(</span><span class="main">`</span><span class="main">0</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> 
    <span class="main">:</span> <span class="main">(</span><span class="main">(</span><span class="free">A</span><span class="main">→</span><span class="free">B</span><span class="main">)</span><span class="main">→</span><span class="free">A</span><span class="main">)</span><span class="main">→</span><span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>    
    
<span class="keyword2"><span class="keyword">end</span></span>
  
</pre>
</div>